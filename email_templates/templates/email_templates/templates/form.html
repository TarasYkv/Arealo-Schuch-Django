{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- GrapesJS Core -->
<link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet">
<script src="https://unpkg.com/grapesjs"></script>

<!-- GrapesJS Newsletter Plugin -->
<link href="https://unpkg.com/grapesjs-preset-newsletter/dist/grapesjs-preset-newsletter.css" rel="stylesheet">
<script src="https://unpkg.com/grapesjs-preset-newsletter"></script>

<style>
    .code-editor {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        min-height: 400px;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    
    .preview-frame {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        min-height: 400px;
        background: #fff;
        overflow-x: auto;
        padding: 20px !important;
    }
    
    /* Override email template max-width in preview */
    .preview-frame > #preview-area {
        width: 100% !important;
        max-width: 100% !important;
    }
    
    .preview-frame > #preview-area > div {
        margin: 0 auto !important;
        width: 100% !important;
        max-width: 100% !important;
    }
    
    /* Target email templates with inline max-width */
    .preview-frame div[style*="max-width: 600px"],
    .preview-frame div[style*="max-width:600px"],
    .preview-frame div[style*="max-width"] {
        max-width: 100% !important;
        width: 100% !important;
    }
    
    /* Ensure tab content uses full width */
    #preview-content {
        width: 100%;
    }
    
    /* Override any email template container styles */
    #preview-area > div > div {
        max-width: 100% !important;
        width: 100% !important;
    }
    
    /* Aggressive width overrides for AI-generated content */
    .preview-frame * {
        max-width: 100% !important;
    }
    
    .preview-frame div[style*="max-width: 600px"] {
        max-width: 100% !important;
        width: 100% !important;
    }
    
    .preview-frame div[style*="max-width:600px"] {
        max-width: 100% !important;
        width: 100% !important;
    }
    
    .preview-frame div[style*="max-width: 500px"] {
        max-width: 100% !important;
        width: 100% !important;
    }
    
    /* Force full width for any table-based layouts */
    .preview-frame table {
        width: 100% !important;
        max-width: 100% !important;
    }
    
    .variable-tag {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem;
        background-color: #e9ecef;
        border-radius: 0.25rem;
        font-family: monospace;
        font-size: 0.875rem;
        cursor: pointer;
    }
    
    .variable-tag:hover {
        background-color: #dee2e6;
    }

    /* GrapesJS Editor Styling */
    #gjs {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        overflow: hidden;
    }

    .gjs-one-bg {
        background-color: #f8f9fa;
    }

    .gjs-two-color {
        color: #667eea;
    }

    .gjs-four-color {
        color: #667eea;
    }

    .gjs-four-color-h:hover {
        color: #764ba2;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- ABSOLUTE DEBUG BANNER - ALWAYS VISIBLE -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">
                    <i class="fas fa-file-alt me-2"></i>
                    {{ title }}
                </h1>
                <a href="{% url 'email_templates:template_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Zurück zur Liste
                </a>
            </div>
        </div>
    </div>

    <form method="post" id="template-form" novalidate>
        {% csrf_token %}
        
        <div class="row">
            <!-- Left Column: Form Fields -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Grundinformationen
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">
                                        {{ form.name.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.name.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.slug.id_for_label }}" class="form-label">
                                        {{ form.slug.label }}
                                    </label>
                                    {{ form.slug }}
                                    {% if form.slug.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.slug.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Wird automatisch generiert, wenn leer gelassen
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.template_type.id_for_label }}" class="form-label">
                                        {{ form.template_type.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.template_type }}
                                    {% if form.template_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.template_type.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.category.id_for_label }}" class="form-label">
                                        {{ form.category.label }}
                                    </label>
                                    {{ form.category }}
                                    {% if form.category.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.category.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.trigger.id_for_label }}" class="form-label">
                                        <i class="fas fa-bell me-1"></i>{{ form.trigger.label }}
                                    </label>
                                    {{ form.trigger }}
                                    {% if form.trigger.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.trigger.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Wählen Sie einen Trigger für automatischen Versand
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    {{ form.is_active }}
                                    <label for="{{ form.is_active.id_for_label }}" class="form-check-label">
                                        {{ form.is_active.label }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    {{ form.is_default }}
                                    <label for="{{ form.is_default.id_for_label }}" class="form-check-label">
                                        {{ form.is_default.label }}
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Diese Vorlage wird automatisch verwendet, wenn für diesen Vorlagentyp keine spezifische Vorlage ausgewählt wurde. Pro Vorlagentyp kann nur eine Standard-Vorlage existieren.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            {{ form.use_base_template }}
                            <label for="{{ form.use_base_template.id_for_label }}" class="form-check-label">
                                {{ form.use_base_template.label }}
                            </label>
                            <small class="form-text text-muted d-block">
                                Wenn aktiviert, wird die E-Mail in ein Standard-Layout eingebettet
                            </small>
                        </div>
                    </div>
                </div>

                <!-- AI Content Generation -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-robot me-2"></i>
                            KI-gestützte E-Mail-Generierung
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-magic me-2"></i>
                            <strong>Beschreiben Sie Ihre E-Mail</strong> und lassen Sie die KI den Inhalt generieren!
                        </div>
                        
                        <form id="ai-generation-form">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="ai-description" class="form-label">E-Mail-Beschreibung</label>
                                    <textarea id="ai-description" class="form-control" rows="3" 
                                              placeholder="Beschreiben Sie, was die E-Mail enthalten soll. Z.B.: 'Eine Willkommens-E-Mail für neue Kunden mit Informationen über unser Unternehmen und einen Gutscheincode für den ersten Einkauf.'"></textarea>
                                    <small class="form-text text-muted">
                                        Je detaillierter die Beschreibung, desto besser das Ergebnis.
                                    </small>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="ai-email-type" class="form-label">E-Mail-Typ</label>
                                    <select id="ai-email-type" class="form-select">
                                        <option value="welcome">Willkommens-E-Mail</option>
                                        <option value="notification">Benachrichtigung</option>
                                        <option value="marketing">Marketing</option>
                                        <option value="transactional">Transaktions-E-Mail</option>
                                        <option value="reminder">Erinnerung</option>
                                        <option value="newsletter">Newsletter</option>
                                        <option value="confirmation">Bestätigung</option>
                                        <option value="invitation">Einladung</option>
                                        <option value="feedback">Feedback</option>
                                        <option value="support">Support</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="ai-tone" class="form-label">Tonfall</label>
                                    <select id="ai-tone" class="form-select">
                                        <option value="professional">Professionell</option>
                                        <option value="friendly">Freundlich</option>
                                        <option value="formal">Formal</option>
                                        <option value="casual">Locker</option>
                                        <option value="enthusiastic">Begeistert</option>
                                        <option value="empathetic">Einfühlsam</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="ai-model" class="form-label">KI-Modell</label>
                                    <select id="ai-model" class="form-select">
                                        {% for model_key, model_info in available_ai_models.items %}
                                            <option value="{{ model_key }}" 
                                                    {% if model_key == default_ai_model %}selected{% endif %}
                                                    data-cost="{{ model_info.cost }}" 
                                                    data-speed="{{ model_info.speed }}"
                                                    data-provider="{{ model_info.provider }}">
                                                {{ model_info.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="mt-2 p-2 bg-light rounded" id="model-info">
                                        <small class="text-muted d-flex align-items-center">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <span id="model-cost"></span> • <span id="model-speed"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="ai-include-variables" checked>
                                        <label class="form-check-label" for="ai-include-variables">
                                            Template-Variablen einschließen
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="button" id="generate-ai-content" class="btn btn-success">
                                    <i class="fas fa-magic me-2"></i>
                                    <span id="generate-btn-text">E-Mail generieren</span>
                                    <span id="generate-spinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                                </button>
                                
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Die Generierung kann 10-30 Sekunden dauern
                                </small>
                            </div>
                        </form>
                        
                        <!-- AI Generation Result -->
                        <div id="ai-result" class="mt-4 d-none">
                            <div class="alert alert-success">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-check-circle me-2 text-success"></i>
                                    <strong>E-Mail erfolgreich generiert!</strong>
                                </div>
                                <p class="mb-2">Die Inhalte wurden automatisch in die Formularfelder übernommen.</p>
                                <div class="d-flex align-items-center mt-3 p-2 bg-light rounded">
                                    <i class="fas fa-robot me-2 text-primary"></i>
                                    <div>
                                        <small class="text-muted d-block">Generiert mit:</small>
                                        <strong id="used-ai-model" class="text-primary"></strong>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" id="apply-ai-content" class="btn btn-primary btn-sm">
                                    <i class="fas fa-download me-1"></i>Inhalte übernehmen
                                </button>
                                <button type="button" id="regenerate-content" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-redo me-1"></i>Neu generieren
                                </button>
                            </div>
                        </div>
                        
                        <!-- AI Error -->
                        <div id="ai-error" class="mt-4 d-none">
                            <div class="alert alert-warning">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                                    <strong>KI-Generierung fehlgeschlagen</strong>
                                </div>
                                <p class="mb-2" id="ai-error-message"></p>
                                <div class="d-flex align-items-center mt-3 p-2 bg-light rounded">
                                    <i class="fas fa-info-circle me-2 text-info"></i>
                                    <small class="text-muted">
                                        Tipp: Überprüfen Sie Ihre API-Schlüssel unter 
                                        <a href="/accounts/neue-api-einstellungen/" target="_blank">Account-Einstellungen</a>
                                        oder verwenden Sie das Template-System.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-envelope me-2"></i>
                            E-Mail-Inhalt
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.subject.id_for_label }}" class="form-label">
                                {{ form.subject.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.subject }}
                            {% if form.subject.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.subject.errors.0 }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">
                                Sie können Template-Variablen verwenden, z.B. {% verbatim %}{{ kunde_name }}{% endverbatim %}
                            </small>
                        </div>
                        
                        <ul class="nav nav-tabs mb-3" id="contentTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="wysiwyg-tab" data-bs-toggle="tab"
                                        data-bs-target="#wysiwyg-content" type="button" role="tab">
                                    <i class="fas fa-magic me-2"></i>E-Mail Builder
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="html-tab" data-bs-toggle="tab"
                                        data-bs-target="#html-content" type="button" role="tab">
                                    <i class="fas fa-code me-2"></i>HTML-Code
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="text-tab" data-bs-toggle="tab"
                                        data-bs-target="#text-content" type="button" role="tab">
                                    <i class="fas fa-align-left me-2"></i>Text-Inhalt
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="css-tab" data-bs-toggle="tab"
                                        data-bs-target="#css-content" type="button" role="tab">
                                    <i class="fas fa-paint-brush me-2"></i>Custom CSS
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="preview-tab" data-bs-toggle="tab"
                                        data-bs-target="#preview-content" type="button" role="tab">
                                    <i class="fas fa-eye me-2"></i>Vorschau
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="contentTabsContent">
                            <!-- GrapesJS E-Mail Builder Tab -->
                            <div class="tab-pane fade show active" id="wysiwyg-content" role="tabpanel">
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Professioneller E-Mail Builder</strong><br>
                                    Nutzen Sie Drag & Drop, um professionelle E-Mail-Templates zu erstellen.
                                    Ihre Änderungen werden automatisch im HTML-Code Tab gespeichert.
                                </div>
                                <div id="gjs" style="height: 600px; overflow: hidden;"></div>
                                <div class="mt-3 d-flex gap-2">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="syncFromGrapesJS()">
                                        <i class="fas fa-save me-1"></i>In HTML-Code übernehmen
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="syncToGrapesJS()">
                                        <i class="fas fa-download me-1"></i>Aus HTML-Code laden
                                    </button>
                                </div>
                            </div>

                            <!-- HTML Code Tab -->
                            <div class="tab-pane fade" id="html-content" role="tabpanel">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">HTML-Code</label>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatHTML()">
                                            <i class="fas fa-code me-1"></i>Code formatieren
                                        </button>
                                    </div>
                                    {{ form.html_content }}
                                    {% if form.html_content.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.html_content.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>Hinweis:</strong> Änderungen hier werden <strong>NICHT automatisch</strong> in den Text-Inhalt übernommen.
                                        Nach HTML-Änderungen zum Tab "Text-Inhalt" wechseln und "Aus HTML generieren" klicken.
                                    </small>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="text-content" role="tabpanel">
                                <div class="alert alert-warning mb-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Wichtig:</strong> Der Text-Inhalt wird <strong>NICHT automatisch</strong> mit dem HTML synchronisiert!
                                    Änderungen im HTML-Tab werden <strong>nicht automatisch</strong> hier übernommen.
                                    Nutze den Button "Aus HTML generieren" um den Text neu zu erstellen.
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">Text-Inhalt</label>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="syncTextFromHTML()">
                                            <i class="fas fa-sync-alt me-1"></i>Aus HTML generieren
                                        </button>
                                    </div>
                                    {{ form.text_content }}
                                    {% if form.text_content.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.text_content.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        <strong>Hinweis:</strong> Dies ist eine separate Nur-Text-Version für E-Mail-Clients ohne HTML-Unterstützung.
                                        Sie wird NICHT automatisch aktualisiert, wenn du den HTML-Inhalt änderst!
                                        Klicke "Aus HTML generieren" um den Text aus dem HTML neu zu erstellen.
                                    </small>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="css-content" role="tabpanel">
                                <div class="mb-3">
                                    {{ form.custom_css }}
                                    {% if form.custom_css.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.custom_css.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Optional: Zusätzliche CSS-Stile für diese Vorlage
                                    </small>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="preview-content" role="tabpanel">
                                <div class="preview-frame p-3">
                                    <div id="preview-area">
                                        <p class="text-muted text-center">
                                            <i class="fas fa-eye-slash fa-3x mb-3"></i><br>
                                            Klicken Sie auf "Vorschau aktualisieren" um eine Vorschau zu sehen
                                        </p>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="updatePreview()">
                                        <i class="fas fa-sync me-2"></i>Vorschau aktualisieren
                                    </button>
                                    <div id="generation-info" class="text-muted small d-none">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span id="generation-source-text"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Variables and Help -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-code me-2"></i>
                            Template-Variablen
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-3">
                            Klicken Sie auf eine Variable, um sie zu kopieren:
                        </p>
                        
                        <div id="common-variables">
                            <h6 class="small text-muted">Häufig verwendet:</h6>
                            <div class="mb-3">
                                <span class="variable-tag" onclick="insertVariable('kunde_name')">{% verbatim %}{{ kunde_name }}{% endverbatim %}</span>
                                <span class="variable-tag" onclick="insertVariable('kunde_email')">{% verbatim %}{{ kunde_email }}{% endverbatim %}</span>
                                <span class="variable-tag" onclick="insertVariable('bestellnummer')">{% verbatim %}{{ bestellnummer }}{% endverbatim %}</span>
                                <span class="variable-tag" onclick="insertVariable('datum')">{% verbatim %}{{ datum }}{% endverbatim %}</span>
                                <span class="variable-tag" onclick="insertVariable('betrag')">{% verbatim %}{{ betrag }}{% endverbatim %}</span>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertCustomVariable()">
                                    <i class="fas fa-plus me-1"></i>Eigene Variable
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.available_variables.id_for_label }}" class="form-label small">
                                Verfügbare Variablen (JSON):
                            </label>
                            {{ form.available_variables }}
                            {% if form.available_variables.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.available_variables.errors.0 }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">
                                Definieren Sie verfügbare Variablen als JSON-Objekt
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-question-circle me-2"></i>
                            Hilfe
                        </h6>
                    </div>
                    <div class="card-body">
                        <h6 class="small">Template-Syntax:</h6>
                        <ul class="small">
                            <li>Variablen: <code>{% verbatim %}{{ variable }}{% endverbatim %}</code></li>
                            <li>Bedingungen: <code>{% verbatim %}{% if condition %}...{% endif %}{% endverbatim %}</code></li>
                            <li>Schleifen: <code>{% verbatim %}{% for item in list %}...{% endfor %}{% endverbatim %}</code></li>
                        </ul>
                        
                        <h6 class="small mt-3">Best Practices:</h6>
                        <ul class="small">
                            <li>Verwenden Sie Inline-CSS für bessere E-Mail-Client-Kompatibilität</li>
                            <li>Testen Sie Vorlagen in verschiedenen E-Mail-Clients</li>
                            <li>Fügen Sie immer eine Text-Version hinzu</li>
                            <li>Halten Sie die Breite unter 600px</li>
                        </ul>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-save me-2"></i>
                            {% if template %}Änderungen speichern{% else %}Vorlage erstellen{% endif %}
                        </button>
                        <a href="{% url 'email_templates:template_list' %}" class="btn btn-secondary w-100">
                            <i class="fas fa-times me-2"></i>Abbrechen
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// AI Content Generation
let generatedContent = null;
let generationInfo = null;

document.getElementById('generate-ai-content').addEventListener('click', function() {
    generateAIContent();
});

document.getElementById('regenerate-content').addEventListener('click', function() {
    generateAIContent();
});

document.getElementById('apply-ai-content').addEventListener('click', function() {
    if (generatedContent) {
        applyGeneratedContent(generatedContent);
    }
});

function generateAIContent() {
    const description = document.getElementById('ai-description').value.trim();
    if (!description) {
        alert('Bitte geben Sie eine E-Mail-Beschreibung ein.');
        return;
    }
    
    const generateBtn = document.getElementById('generate-ai-content');
    const generateText = document.getElementById('generate-btn-text');
    const generateSpinner = document.getElementById('generate-spinner');
    const resultDiv = document.getElementById('ai-result');
    const errorDiv = document.getElementById('ai-error');
    
    // Show loading state
    generateBtn.disabled = true;
    generateText.textContent = 'Generiere...';
    generateSpinner.classList.remove('d-none');
    resultDiv.classList.add('d-none');
    errorDiv.classList.add('d-none');
    
    // Collect form data
    const data = {
        description: description,
        email_type: document.getElementById('ai-email-type').value,
        tone: document.getElementById('ai-tone').value,
        include_variables: document.getElementById('ai-include-variables').checked,
        model: document.getElementById('ai-model').value
    };
    
    // Make API call
    fetch('{% url "email_templates:generate_ai_content" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        // Reset button state
        generateBtn.disabled = false;
        generateText.textContent = 'E-Mail generieren';
        generateSpinner.classList.add('d-none');
        
        if (result.success) {
            generatedContent = result.content;
            
            // Store generation info for display next to preview button
            generationInfo = {
                model_info: result.model_info,
                model_used: result.model_used,
                is_fallback: result.is_fallback,
                fallback_reason: result.fallback_reason
            };
            
            resultDiv.classList.remove('d-none');
            
            // Display which model was used
            const usedModelSpan = document.getElementById('used-ai-model');
            if (usedModelSpan) {
                let modelText = '';
                let modelClass = 'text-primary';
                
                if (result.model_info && result.model_info.name) {
                    modelText = result.model_info.name;
                    
                    // Add provider badge
                    const provider = result.model_info.provider;
                    let providerBadge = '';
                    if (provider === 'openai') {
                        providerBadge = ' <span class="badge bg-success ms-1">OpenAI</span>';
                    } else if (provider === 'anthropic') {
                        providerBadge = ' <span class="badge bg-primary ms-1">Anthropic</span>';
                    } else if (provider === 'google') {
                        providerBadge = ' <span class="badge bg-warning ms-1">Google</span>';
                    } else if (provider === 'fallback') {
                        providerBadge = ' <span class="badge bg-secondary ms-1">Template</span>';
                        modelClass = 'text-secondary';
                    }
                    
                    modelText += providerBadge;
                } else {
                    modelText = result.model_used || 'Unbekannt';
                }
                
                // Add fallback information if applicable
                if (result.is_fallback || result.fallback_reason) {
                    modelClass = 'text-warning';
                    if (result.fallback_reason) {
                        modelText += '<br><small class="text-muted">Grund: ' + result.fallback_reason + '</small>';
                    } else {
                        modelText += '<br><small class="text-muted">Template-basierte Generierung</small>';
                    }
                }
                
                usedModelSpan.className = modelClass;
                usedModelSpan.innerHTML = modelText;
            }
            
            // Auto-apply content
            applyGeneratedContent(generatedContent);
        } else {
            document.getElementById('ai-error-message').textContent = result.error || 'Unbekannter Fehler bei der Generierung.';
            errorDiv.classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('AI Generation Error:', error);
        
        // Reset button state
        generateBtn.disabled = false;
        generateText.textContent = 'E-Mail generieren';
        generateSpinner.classList.add('d-none');
        
        document.getElementById('ai-error-message').textContent = 'Netzwerkfehler: ' + error.message;
        errorDiv.classList.remove('d-none');
    });
}

function findField(selectors) {
    for (const selector of selectors) {
        let element = null;
        try {
            if (selector.startsWith('[') || selector.startsWith('#') || selector.startsWith('.')) {
                element = document.querySelector(selector);
            } else {
                element = document.getElementById(selector);
            }
            if (element) {
                return element;
            }
        } catch (e) {
            console.log('Selector failed:', selector, e);
        }
    }
    return null;
}

function applyGeneratedContent(content) {
    console.log('Applying generated content:', content);
    
    // Debug: List all form fields
    console.log('Available form fields:');
    const allInputs = document.querySelectorAll('input, textarea, select');
    allInputs.forEach(input => {
        console.log(`- ${input.tagName} id="${input.id}" name="${input.name}" type="${input.type}"`);
    });
    
    // Try multiple methods to find and set form fields
    const fieldSelectors = {
        subject: ['id_subject', '[name="subject"]', 'input[name="subject"]'],
        html_content: ['id_html_content', '[name="html_content"]', 'textarea[name="html_content"]'],
        text_content: ['id_text_content', '[name="text_content"]', 'textarea[name="text_content"]'],
        available_variables: ['id_available_variables', '[name="available_variables"]', 'textarea[name="available_variables"]']
    };
    
    // Apply subject
    if (content.subject) {
        const subjectField = findField(fieldSelectors.subject);
        console.log('Subject field found:', subjectField);
        if (subjectField) {
            subjectField.value = content.subject;
            console.log('Subject applied:', content.subject);
        }
    }
    
    // Apply HTML content
    if (content.html_content) {
        const htmlField = findField(fieldSelectors.html_content);
        console.log('HTML field found:', htmlField);
        if (htmlField) {
            htmlField.value = content.html_content;
            console.log('HTML content applied (first 100 chars):', content.html_content.substring(0, 100));

            // Also sync to GrapesJS editor if available
            if (editor) {
                try {
                    const htmlContent = content.html_content;
                    // Extract body content if full HTML document
                    if (htmlContent.includes('<!DOCTYPE') || htmlContent.includes('<html')) {
                        const bodyMatch = htmlContent.match(/<body[^>]*>([\s\S]*)<\/body>/i);
                        if (bodyMatch && bodyMatch[1]) {
                            editor.setComponents(bodyMatch[1]);
                            console.log('Content synced to GrapesJS editor');
                        }
                    } else {
                        editor.setComponents(htmlContent);
                        console.log('Content synced to GrapesJS editor');
                    }
                } catch (e) {
                    console.error('Error syncing to GrapesJS:', e);
                }
            }
        }
    }
    
    // Apply text content
    if (content.text_content) {
        const textField = findField(fieldSelectors.text_content);
        console.log('Text field found:', textField);
        if (textField) {
            textField.value = content.text_content;
            console.log('Text content applied (first 100 chars):', content.text_content.substring(0, 100));
        }
    }
    
    // Apply suggested variables
    if (content.suggested_variables && Object.keys(content.suggested_variables).length > 0) {
        const variablesField = findField(fieldSelectors.available_variables);
        console.log('Variables field found:', variablesField);
        if (variablesField) {
            try {
                const currentVariables = variablesField.value ? JSON.parse(variablesField.value || '{}') : {};
                const mergedVariables = { ...currentVariables, ...content.suggested_variables };
                variablesField.value = JSON.stringify(mergedVariables, null, 2);
                console.log('Variables applied:', mergedVariables);
            } catch (e) {
                console.error('Error applying variables:', e);
                variablesField.value = JSON.stringify(content.suggested_variables, null, 2);
            }
        }
    }
    
    // Show success message
    const successAlert = document.createElement('div');
    successAlert.className = 'alert alert-success alert-dismissible fade show mt-3';
    successAlert.innerHTML = `
        <i class="fas fa-check me-2"></i>
        KI-generierte Inhalte wurden erfolgreich übernommen!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const emailContentCard = document.querySelector('.card:has(#id_subject)');
    if (emailContentCard) {
        emailContentCard.insertBefore(successAlert, emailContentCard.firstChild);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (successAlert.parentNode) {
                successAlert.remove();
            }
        }, 5000);
    }
    
    // Update generation info display
    updateGenerationInfoDisplay();
    
    // Force immediate width fix after AI generation
    forceFullWidthPreview();
    
    // Update preview if available and if preview tab is active
    if (typeof updatePreview === 'function') {
        // Check if preview tab is currently active
        const previewTab = document.querySelector('#preview-tab');
        if (previewTab && previewTab.classList.contains('active')) {
            updatePreview();
        }
    }
    
    // Additional width fix after a delay to catch any dynamic content
    setTimeout(() => {
        forceFullWidthPreview();
    }, 100);
}

function forceFullWidthPreview() {
    console.log('Forcing full width preview after AI generation...');
    
    // Target all potential containers that might have width restrictions
    const selectors = [
        '.preview-frame',
        '.preview-frame *',
        '#preview-area',
        '#preview-area *',
        '.preview-frame div[style*="max-width"]',
        '.preview-frame div[style*="width"]',
        '.tab-pane#preview-content *'
    ];
    
    selectors.forEach(selector => {
        try {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
                // Remove any inline max-width restrictions
                if (element.style.maxWidth) {
                    element.style.maxWidth = '100%';
                    console.log('Fixed max-width for:', element);
                }
                
                // Ensure width is full
                if (element.style.width && element.style.width !== '100%') {
                    element.style.width = '100%';
                    console.log('Fixed width for:', element);
                }
                
                // Special handling for elements with specific max-width values
                if (element.style.maxWidth === '600px' || element.style.maxWidth === '500px') {
                    element.style.maxWidth = '100%';
                    element.style.width = '100%';
                    console.log('Fixed specific max-width restriction for:', element);
                }
            });
        } catch (e) {
            console.log('Selector failed:', selector, e);
        }
    });
    
    // Also fix any Bootstrap column restrictions
    const previewContent = document.getElementById('preview-content');
    if (previewContent) {
        previewContent.style.width = '100%';
        previewContent.style.maxWidth = '100%';
    }
    
    // Force layout recalculation
    const previewFrame = document.querySelector('.preview-frame');
    if (previewFrame) {
        previewFrame.style.display = 'none';
        previewFrame.offsetHeight; // Trigger reflow
        previewFrame.style.display = '';
    }
}

function updateGenerationInfoDisplay() {
    const generationInfoDiv = document.getElementById('generation-info');
    const generationSourceText = document.getElementById('generation-source-text');
    
    if (!generationInfoDiv || !generationSourceText) return;
    
    if (generationInfo) {
        let sourceText = 'Inhalt generiert mit: ';
        
        if (generationInfo.model_info && generationInfo.model_info.name) {
            sourceText += generationInfo.model_info.name;
            
            // Add provider info
            const provider = generationInfo.model_info.provider;
            if (provider === 'openai') {
                sourceText += ' (OpenAI)';
            } else if (provider === 'anthropic') {
                sourceText += ' (Anthropic)';
            } else if (provider === 'google') {
                sourceText += ' (Google)';
            } else if (provider === 'fallback') {
                sourceText = 'Inhalt generiert mit: Template-System';
            }
        } else if (generationInfo.model_used) {
            sourceText += generationInfo.model_used;
        } else {
            sourceText += 'Unbekannt';
        }
        
        // Add fallback information if applicable
        if (generationInfo.is_fallback && generationInfo.fallback_reason) {
            sourceText += ' (Fallback: ' + generationInfo.fallback_reason + ')';
        } else if (generationInfo.is_fallback) {
            sourceText += ' (Fallback verwendet)';
        }
        
        generationSourceText.textContent = sourceText;
        generationInfoDiv.classList.remove('d-none');
    } else {
        generationInfoDiv.classList.add('d-none');
    }
}

function insertVariable(varName) {
    const variable = '{% verbatim %}{{ {% endverbatim %}' + varName + '{% verbatim %} }}{% endverbatim %}';

    // Check if E-Mail Builder tab is active
    const wysiwygTab = document.getElementById('wysiwyg-content');
    if (wysiwygTab && wysiwygTab.classList.contains('active') && editor) {
        try {
            // Insert into GrapesJS editor
            const selected = editor.getSelected();
            if (selected) {
                // Add text component with the variable
                selected.append({
                    type: 'text',
                    content: variable,
                    style: {
                        'display': 'inline',
                        'padding': '2px 6px',
                        'background-color': '#e7f3ff',
                        'color': '#0066cc',
                        'border-radius': '3px',
                        'font-weight': 'bold'
                    }
                });
            } else {
                // Add to canvas if nothing selected
                editor.addComponents({
                    type: 'text',
                    content: variable,
                    style: {
                        'padding': '2px 6px',
                        'background-color': '#e7f3ff',
                        'color': '#0066cc',
                        'border-radius': '3px',
                        'font-weight': 'bold'
                    }
                });
            }

            // Show success message
            const tag = event.target;
            const originalText = tag.textContent;
            tag.textContent = '✓ Eingefügt!';
            tag.style.backgroundColor = '#28a745';
            tag.style.color = '#fff';

            setTimeout(function() {
                tag.textContent = originalText;
                tag.style.backgroundColor = '';
                tag.style.color = '';
            }, 1000);

            return;
        } catch (err) {
            console.error('Fehler beim Einfügen:', err);
        }
    }

    // Fallback: Copy to clipboard
    navigator.clipboard.writeText(variable).then(function() {
        const tag = event.target;
        const originalText = tag.textContent;
        tag.textContent = '✓ Kopiert!';
        tag.style.backgroundColor = '#28a745';
        tag.style.color = '#fff';

        setTimeout(function() {
            tag.textContent = originalText;
            tag.style.backgroundColor = '';
            tag.style.color = '';
        }, 1000);
    }).catch(function(err) {
        console.error('Fehler beim Kopieren:', err);
        alert('Variable konnte nicht kopiert werden: ' + variable);
    });
}

function insertCustomVariable() {
    const varName = prompt('Variablen-Name eingeben (ohne {% verbatim %}{{}}{% endverbatim %}):');
    if (varName) {
        insertVariable(varName.trim());
    }
}

function updatePreview() {
    console.log('=== Starting updatePreview ===');
    const subject = document.getElementById('id_subject').value;

    // Get HTML content directly from HTML field
    let htmlContent = document.getElementById('id_html_content').value;
    
    const customCSS = document.getElementById('id_custom_css').value;
    
    const previewArea = document.getElementById('preview-area');
    
    // Pre-process HTML content to remove width restrictions
    let processedHtmlContent = htmlContent;
    if (processedHtmlContent) {
        // Remove or modify inline max-width styles in the HTML content itself
        processedHtmlContent = processedHtmlContent.replace(/max-width:\s*600px/gi, 'max-width: 100%');
        processedHtmlContent = processedHtmlContent.replace(/max-width:\s*500px/gi, 'max-width: 100%');
        processedHtmlContent = processedHtmlContent.replace(/max-width:\s*580px/gi, 'max-width: 100%');
        processedHtmlContent = processedHtmlContent.replace(/max-width:\s*550px/gi, 'max-width: 100%');
        processedHtmlContent = processedHtmlContent.replace(/width:\s*600px/gi, 'width: 100%');
        processedHtmlContent = processedHtmlContent.replace(/width:\s*500px/gi, 'width: 100%');
        console.log('HTML content processed for width restrictions');
    }
    
    // Create preview HTML
    let previewHTML = '<div style="border: 1px solid #ddd; padding: 20px; background: #f8f9fa; width: 100%; max-width: 100%;">';
    previewHTML += '<h4 style="margin-bottom: 20px;">Betreff: ' + (subject || '[Kein Betreff]') + '</h4>';
    previewHTML += '</div>';
    previewHTML += '<div style="padding: 20px; width: 100%; max-width: 100%;">';
    
    if (customCSS) {
        previewHTML += '<style>' + customCSS + '</style>';
    }
    
    // Add multiple aggressive style overrides
    previewHTML += '<style>';
    previewHTML += '.preview-frame * { max-width: 100% !important; }';
    previewHTML += '.preview-frame div[style*="max-width"] { max-width: 100% !important; width: 100% !important; }';
    previewHTML += '.preview-frame table[style*="max-width"] { max-width: 100% !important; width: 100% !important; }';
    previewHTML += '.preview-frame td[style*="max-width"] { max-width: 100% !important; width: 100% !important; }';
    previewHTML += '.preview-frame [style*="600px"] { max-width: 100% !important; width: 100% !important; }';
    previewHTML += '.preview-frame [style*="500px"] { max-width: 100% !important; width: 100% !important; }';
    previewHTML += '</style>';
    
    previewHTML += processedHtmlContent || '<p class="text-muted">Kein HTML-Inhalt vorhanden</p>';
    previewHTML += '</div>';
    
    previewArea.innerHTML = previewHTML;
    console.log('Preview HTML inserted');
    
    // Multiple waves of width fixing with increasing delays
    const fixWidthsAggressively = () => {
        console.log('=== Aggressive width fixing ===');
        
        // Fix all elements with inline styles
        const allElements = previewArea.querySelectorAll('*[style]');
        allElements.forEach((element, index) => {
            const style = element.getAttribute('style');
            if (style) {
                // Remove any max-width restrictions
                let newStyle = style.replace(/max-width:\s*\d+px/gi, 'max-width: 100%');
                newStyle = newStyle.replace(/width:\s*[5-6]\d\dpx/gi, 'width: 100%'); // 500-699px
                
                if (newStyle !== style) {
                    element.setAttribute('style', newStyle);
                    console.log(`Fixed element ${index}:`, element.tagName, 'old:', style, 'new:', newStyle);
                }
            }
            
            // Also set via JavaScript style property
            if (element.style.maxWidth && element.style.maxWidth !== '100%') {
                console.log(`JS style fix for ${element.tagName}:`, element.style.maxWidth, '-> 100%');
                element.style.maxWidth = '100%';
                element.style.width = '100%';
            }
        });
        
        // Additional force for specific selectors
        const specificSelectors = [
            'div[style*="max-width"]',
            'table[style*="max-width"]', 
            'td[style*="max-width"]',
            '[style*="600px"]',
            '[style*="500px"]'
        ];
        
        specificSelectors.forEach(selector => {
            const elements = previewArea.querySelectorAll(selector);
            elements.forEach(el => {
                el.style.maxWidth = '100%';
                el.style.width = '100%';
                console.log(`Forced width for ${selector}:`, el);
            });
        });
    };
    
    // Execute width fixes multiple times with different delays
    setTimeout(fixWidthsAggressively, 10);
    setTimeout(fixWidthsAggressively, 50);
    setTimeout(fixWidthsAggressively, 100);
    setTimeout(fixWidthsAggressively, 200);
    
    // Final force with layout recalculation
    setTimeout(() => {
        fixWidthsAggressively();
        
        // Force layout recalculation
        const previewFrame = document.querySelector('.preview-frame');
        if (previewFrame) {
            previewFrame.style.display = 'none';
            previewFrame.offsetHeight; // Trigger reflow
            previewFrame.style.display = '';
            console.log('Forced layout recalculation');
        }
        
        console.log('=== Preview update complete ===');
    }, 300);
}

// Handle form submission to check required fields in hidden tabs
document.getElementById('template-form').addEventListener('submit', function(e) {
    let isValid = true;
    let firstInvalidTab = null;
    
    // Check only Django form required fields (exclude AI generation fields)
    const requiredFields = this.querySelectorAll('[required]:not(#ai-description):not(#ai-generation-form [required])');
    requiredFields.forEach(function(field) {
        // Skip AI generation fields
        if (field.closest('#ai-generation-form')) {
            return;
        }
        
        if (!field.value.trim()) {
            isValid = false;
            
            // Find which tab contains this field
            const tabPane = field.closest('.tab-pane');
            if (tabPane && !tabPane.classList.contains('active')) {
                if (!firstInvalidTab) {
                    firstInvalidTab = tabPane.id;
                }
            }
            
            // Add Bootstrap validation classes
            field.classList.add('is-invalid');
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        e.preventDefault();
        
        // Switch to the tab with the first invalid field
        if (firstInvalidTab) {
            const tabTrigger = document.querySelector(`[data-bs-target="#${firstInvalidTab}"]`);
            if (tabTrigger) {
                const tab = new bootstrap.Tab(tabTrigger);
                tab.show();
            }
        }
        
        // Show error message
        alert('Bitte füllen Sie alle Pflichtfelder aus.');
        return false;
    }
});

// Update model info when selection changes
document.getElementById('ai-model').addEventListener('change', function() {
    updateModelInfo();
});

function updateModelInfo() {
    const select = document.getElementById('ai-model');
    if (!select) return;
    
    const selectedOption = select.options[select.selectedIndex];
    const modelInfoDiv = document.getElementById('model-info');
    
    if (selectedOption && modelInfoDiv) {
        const cost = selectedOption.getAttribute('data-cost');
        const speed = selectedOption.getAttribute('data-speed');
        const provider = selectedOption.getAttribute('data-provider');
        
        // Add provider badge
        const providerBadge = provider === 'openai' ? 
            '<span class="badge bg-success ms-1">OpenAI</span>' :
            provider === 'anthropic' ?
            '<span class="badge bg-primary ms-1">Anthropic</span>' :
            provider === 'google' ?
            '<span class="badge bg-warning ms-1">Google</span>' :
            provider === 'fallback' ?
            '<span class="badge bg-secondary ms-1">Template</span>' : '';
        
        modelInfoDiv.innerHTML = `
            <small class="text-muted d-flex align-items-center">
                <i class="fas fa-info-circle me-2"></i>
                <span id="model-cost">Kosten: ${cost}</span> • <span id="model-speed">Geschwindigkeit: ${speed}</span>
                ${providerBadge}
            </small>
        `;
    }
}

function formatHTML() {
    const htmlField = document.getElementById('id_html_content');
    if (htmlField && htmlField.value) {
        // Simple HTML formatting
        let formatted = htmlField.value;
        // Add basic indentation
        formatted = formatted.replace(/></g, '>\n<');
        htmlField.value = formatted;
    }
}

// GrapesJS E-Mail Builder
let editor = null;

// Initialize GrapesJS
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎨 Initializing GrapesJS...');

    try {
        editor = grapesjs.init({
            container: '#gjs',
            height: '600px',
            width: 'auto',
            plugins: ['gjs-preset-newsletter'],
            pluginsOpts: {
                'gjs-preset-newsletter': {
                    modalTitleImport: 'HTML Code importieren',
                    modalLabelImport: 'Fügen Sie Ihren HTML-Code ein',
                    modalLabelExport: 'HTML-Code kopieren',
                    codeViewerTheme: 'material',
                    importPlaceholder: '<div>HTML hier einfügen...</div>',
                    cellStyle: {
                        'font-size': '14px',
                        'font-weight': '300',
                        'vertical-align': 'top',
                        color: '#333333',
                        margin: 0,
                        padding: 0,
                    }
                }
            },
            storageManager: false, // Disable default storage
            deviceManager: {
                devices: [{
                    name: 'Desktop',
                    width: '600px',
                }, {
                    name: 'Mobile',
                    width: '320px',
                    widthMedia: '480px',
                }]
            },
            panels: {
                defaults: [
                    {
                        id: 'basic-actions',
                        el: '.panel__basic-actions',
                        buttons: [
                            {
                                id: 'visibility',
                                active: true,
                                className: 'btn-toggle-borders',
                                label: '<i class="fa fa-clone"></i>',
                                command: 'sw-visibility',
                            }, {
                                id: 'export',
                                className: 'btn-open-export',
                                label: '<i class="fa fa-code"></i>',
                                command: 'export-template',
                                context: 'export-template',
                            }, {
                                id: 'show-json',
                                className: 'btn-show-json',
                                label: '<i class="fa fa-download"></i>',
                                context: 'show-json',
                                command(editor) {
                                    editor.Modal.setTitle('Komponenten JSON')
                                        .setContent(`<textarea style="width:100%; height: 250px;">
                                            ${JSON.stringify(editor.getComponents())}
                                        </textarea>`)
                                        .open();
                                },
                            }
                        ],
                    },
                    {
                        id: 'panel-devices',
                        el: '.panel__devices',
                        buttons: [{
                            id: 'device-desktop',
                            label: '<i class="fa fa-desktop"></i>',
                            command: 'set-device-desktop',
                            active: true,
                            togglable: false,
                        }, {
                            id: 'device-mobile',
                            label: '<i class="fa fa-mobile"></i>',
                            command: 'set-device-mobile',
                            togglable: false,
                        }],
                    }
                ]
            },
            // Canvas settings
            canvas: {
                styles: [],
                scripts: [],
            },
            // Style Manager
            styleManager: {
                sectors: [{
                    name: 'Allgemein',
                    open: false,
                    buildProps: ['float', 'display', 'position', 'top', 'right', 'left', 'bottom']
                }, {
                    name: 'Dimension',
                    open: false,
                    buildProps: ['width', 'height', 'max-width', 'min-height', 'margin', 'padding'],
                }, {
                    name: 'Typografie',
                    open: false,
                    buildProps: ['font-family', 'font-size', 'font-weight', 'letter-spacing', 'color', 'line-height', 'text-align', 'text-decoration', 'text-shadow'],
                }, {
                    name: 'Dekorationen',
                    open: false,
                    buildProps: ['background-color', 'border-radius', 'border', 'box-shadow', 'background'],
                }],
            },
        });

        console.log('✅ GrapesJS initialized successfully');

        // Load initial content from HTML field
        const htmlField = document.getElementById('id_html_content');
        if (htmlField && htmlField.value.trim()) {
            console.log('📝 Loading initial content into GrapesJS...');
            const htmlContent = htmlField.value;

            // Check if it's a full HTML document
            if (htmlContent.includes('<!DOCTYPE') || htmlContent.includes('<html')) {
                console.warn('⚠️ Full HTML document detected - extracting body content');
                const bodyMatch = htmlContent.match(/<body[^>]*>([\s\S]*)<\/body>/i);
                if (bodyMatch && bodyMatch[1]) {
                    editor.setComponents(bodyMatch[1]);
                    console.log('✅ Body content loaded into GrapesJS');
                }
            } else {
                editor.setComponents(htmlContent);
                console.log('✅ Content loaded into GrapesJS');
            }
        }

        // Commands
        editor.Commands.add('set-device-desktop', {
            run: (editor) => editor.setDevice('Desktop')
        });
        editor.Commands.add('set-device-mobile', {
            run: (editor) => editor.setDevice('Mobile')
        });

        console.log('✅ GrapesJS setup complete');

    } catch (error) {
        console.error('❌ Error initializing GrapesJS:', error);
        alert('Fehler beim Laden des E-Mail Builders. Bitte verwenden Sie den HTML-Code Tab.');
    }
});

// Sync from GrapesJS to HTML field
function syncFromGrapesJS() {
    if (!editor) {
        console.error('❌ GrapesJS editor not initialized');
        alert('Editor ist noch nicht bereit. Bitte warten Sie einen Moment.');
        return;
    }

    try {
        console.log('🔄 Syncing from GrapesJS to HTML...');

        // Get HTML from GrapesJS
        const html = editor.getHtml();
        const css = editor.getCss();

        const htmlField = document.getElementById('id_html_content');
        if (htmlField) {
            // Combine HTML with inline CSS
            const fullHtml = `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        ${css}
    </style>
</head>
<body>
    ${html}
</body>
</html>`;

            htmlField.value = fullHtml;
            console.log('✅ Content synced to HTML field');

            // Show success message
            alert('✅ E-Mail wurde erfolgreich in den HTML-Code übernommen!');
        }
    } catch (error) {
        console.error('❌ Error syncing from GrapesJS:', error);
        alert('Fehler beim Übernehmen des Inhalts.');
    }
}

// Sync from HTML field to GrapesJS
function syncToGrapesJS() {
    if (!editor) {
        console.error('❌ GrapesJS editor not initialized');
        alert('Editor ist noch nicht bereit. Bitte warten Sie einen Moment.');
        return;
    }

    try {
        console.log('🔄 Syncing from HTML to GrapesJS...');

        const htmlField = document.getElementById('id_html_content');
        if (htmlField && htmlField.value.trim()) {
            const htmlContent = htmlField.value;

            // Check if it's a full HTML document
            if (htmlContent.includes('<!DOCTYPE') || htmlContent.includes('<html')) {
                console.warn('⚠️ Full HTML document detected - extracting body content');
                const bodyMatch = htmlContent.match(/<body[^>]*>([\s\S]*)<\/body>/i);
                if (bodyMatch && bodyMatch[1]) {
                    editor.setComponents(bodyMatch[1]);
                    console.log('✅ Body content loaded into GrapesJS');
                } else {
                    console.error('❌ Could not extract body content');
                    alert('Fehler: Konnte Body-Content nicht extrahieren.');
                    return;
                }
            } else {
                editor.setComponents(htmlContent);
                console.log('✅ Content loaded into GrapesJS');
            }

            alert('✅ HTML-Code wurde erfolgreich in den E-Mail Builder geladen!');
        } else {
            alert('⚠️ Kein HTML-Code zum Laden vorhanden.');
        }
    } catch (error) {
        console.error('❌ Error syncing to GrapesJS:', error);
        alert('Fehler beim Laden des HTML-Codes.');
    }
}

// Initialize form enhancements
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM Content Loaded ===');

    // Initialize model info display
    if (typeof updateModelInfo === 'function') {
        updateModelInfo();
    }

    // Auto-format JSON in available variables field
    const variablesField = document.getElementById('id_available_variables');
    if (variablesField) {
        variablesField.addEventListener('blur', function() {
            const value = this.value;
            if (value) {
                try {
                    const json = JSON.parse(value);
                    this.value = JSON.stringify(json, null, 2);
                } catch (e) {
                    // Invalid JSON, leave as is
                }
            }
        });
    }
});

// Function to sync text content from HTML content
function syncTextFromHTML() {
    const htmlContent = document.getElementById('id_html_content').value;

    if (!htmlContent || htmlContent.trim() === '') {
        alert('Bitte geben Sie zuerst HTML-Inhalt ein.');
        return;
    }

    // Show loading state
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generiere...';

    // Call backend to convert HTML to text
    fetch('{% url "email_templates:html_to_text" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            html_content: htmlContent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('id_text_content').value = data.text_content;

            // Show success message
            btn.innerHTML = '<i class="fas fa-check me-1"></i>Generiert!';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-success');

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-primary');
                btn.disabled = false;
            }, 2000);
        } else {
            alert('Fehler beim Generieren des Text-Inhalts: ' + (data.error || 'Unbekannter Fehler'));
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Generieren des Text-Inhalts.');
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}


</script>
{% endblock %}