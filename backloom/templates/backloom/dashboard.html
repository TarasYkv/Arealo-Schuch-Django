{% extends "base.html" %}
{% load static %}
{% load loomads_tags %}

{% block title %}BackLoom - Backlink Discovery{% endblock %}

{% block extra_css %}
<style>
/* Explizite Modal-Styles für Dark Mode Kompatibilität */
#searchProgressModal .modal-content {
    background-color: #ffffff !important;
    color: #212529 !important;
}
#searchProgressModal .modal-header,
#searchProgressModal .modal-footer {
    background-color: #f8f9fa !important;
    border-color: #dee2e6 !important;
}
#searchProgressModal .modal-title {
    color: #212529 !important;
}
#searchProgressModal .text-muted {
    color: #6c757d !important;
}
#searchProgressModal .text-primary {
    color: #0d6efd !important;
}
#searchProgressModal .text-success {
    color: #198754 !important;
}
#searchProgressModal .text-info {
    color: #0dcaf0 !important;
}
/* Progress Log bleibt dunkel */
#progress-log-container {
    background-color: #1a1a2e !important;
    color: #e0e0e0 !important;
}
#progress-log .text-muted {
    color: #888 !important;
}
#progress-log .text-success {
    color: #4ade80 !important;
}
#progress-log .text-warning {
    color: #fbbf24 !important;
}
#progress-log .text-danger {
    color: #f87171 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="fas fa-link text-primary me-2"></i>BackLoom
                    </h1>
                    <p class="text-muted mb-0">Automatische Backlink-Recherche</p>
                </div>

                {% if is_superuser %}
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Quellen-Auswahl (nur funktionierende Quellen) -->
                    <div class="btn-group me-2" role="group" aria-label="Quellen auswählen">
                        <input type="checkbox" class="btn-check" id="source-duckduckgo" checked>
                        <label class="btn btn-outline-success btn-sm" for="source-duckduckgo" title="DuckDuckGo (HTML)">
                            <i class="fas fa-search"></i> DuckDuckGo
                        </label>

                        <input type="checkbox" class="btn-check" id="source-youtube" checked>
                        <label class="btn btn-outline-danger btn-sm" for="source-youtube" title="YouTube (API)">
                            <i class="fab fa-youtube"></i> YouTube
                        </label>

                        <input type="checkbox" class="btn-check" id="source-tiktok">
                        <label class="btn btn-outline-dark btn-sm" for="source-tiktok" title="TikTok (Supadata API)">
                            <i class="fab fa-tiktok"></i> TikTok
                        </label>

                        <input type="checkbox" class="btn-check" id="source-reddit">
                        <label class="btn btn-outline-warning btn-sm" for="source-reddit" title="Reddit (via Brave)">
                            <i class="fab fa-reddit"></i> Reddit
                        </label>

                        <input type="checkbox" class="btn-check" id="source-pinterest">
                        <label class="btn btn-outline-danger btn-sm" for="source-pinterest" title="Pinterest (via Brave)">
                            <i class="fab fa-pinterest"></i> Pinterest
                        </label>

                        <input type="checkbox" class="btn-check" id="source-quora">
                        <label class="btn btn-outline-secondary btn-sm" for="source-quora" title="Quora (via Brave)">
                            <i class="fab fa-quora"></i> Quora
                        </label>

                        <input type="checkbox" class="btn-check" id="source-medium">
                        <label class="btn btn-outline-dark btn-sm" for="source-medium" title="Medium (via Brave)">
                            <i class="fab fa-medium"></i> Medium
                        </label>
                    </div>

                    <button type="button"
                            id="btn-start-search"
                            class="btn btn-primary"
                            {% if running_search %}disabled{% endif %}>
                        <i class="fas fa-search me-1"></i>
                        {% if running_search %}
                            Suche läuft...
                        {% else %}
                            Suche starten
                        {% endif %}
                    </button>
                    <button type="button" id="btn-health-check" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-heartbeat me-1"></i>Prüfen
                    </button>
                    <button type="button" id="btn-init-queries" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-database me-1"></i>Suchbegriffe
                    </button>
                    <button type="button" id="btn-cleanup" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-broom me-1"></i>Bereinigen
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Ad Banner -->
    {% show_ad_zone 'backloom_header' css_class='mb-4' %}

    <!-- Ampelsystem - Quellen-Status -->
    <div class="row mb-4" id="health-check-section" style="display: none;">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-traffic-light text-muted me-2"></i>Quellen-Status (Ampelsystem)
                    </h5>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-refresh-health">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="row" id="health-check-results">
                        <!-- Wird per JavaScript gefüllt -->
                        <div class="col-12 text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Prüfe Quellen...</span>
                            </div>
                            <p class="mt-2 mb-0 text-muted">Prüfe Quellen...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistik-Karten -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-link text-primary fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0" id="stat-total">{{ total_sources }}</h3>
                            <small class="text-muted">Gesamt</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-star text-info fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0" id="stat-new">{{ new_sources }}</h3>
                            <small class="text-muted">Neu</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-check text-warning fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0" id="stat-processed">{{ processed_sources }}</h3>
                            <small class="text-muted">Bearbeitet</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-trophy text-success fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0" id="stat-successful">{{ successful_sources }}</h3>
                            <small class="text-muted">Erfolgreich</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Letzte Suche -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-muted me-2"></i>Letzte Suche
                    </h5>
                </div>
                <div class="card-body">
                    {% if last_search %}
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <span class="badge bg-{{ last_search.status }} fs-6" id="last-search-status">
                                {{ last_search.get_status_display }}
                            </span>
                        </div>
                        <small class="text-muted">
                            {{ last_search.created_at|date:"d.m.Y H:i" }}
                        </small>
                    </div>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h4 mb-0" id="last-search-found">{{ last_search.sources_found }}</div>
                            <small class="text-muted">Gefunden</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 mb-0 text-success" id="last-search-new">{{ last_search.new_sources }}</div>
                            <small class="text-muted">Neu</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 mb-0 text-info" id="last-search-updated">{{ last_search.updated_sources }}</div>
                            <small class="text-muted">Aktualisiert</small>
                        </div>
                    </div>
                    {% if last_search.duration_formatted %}
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>Dauer: {{ last_search.duration_formatted }}
                        </small>
                    </div>
                    {% endif %}
                    {% else %}
                    <p class="text-muted mb-0">Noch keine Suche durchgeführt.</p>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="{% url 'backloom:search_history' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-list me-1"></i>Alle Suchen
                    </a>
                </div>
            </div>
        </div>

        <!-- Kategorien-Verteilung -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie text-muted me-2"></i>Kategorien
                    </h5>
                </div>
                <div class="card-body">
                    {% if category_stats %}
                    <div class="list-group list-group-flush">
                        {% for stat in category_stats %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span>
                                {% for key, label in categories %}
                                    {% if key == stat.category %}{{ label }}{% endif %}
                                {% endfor %}
                            </span>
                            <span class="badge bg-primary rounded-pill">{{ stat.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Keine Daten vorhanden.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Neueste Quellen -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clock text-muted me-2"></i>Neueste Quellen
                    </h5>
                    <a href="{% url 'backloom:feed' %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-list me-1"></i>Alle anzeigen
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Domain</th>
                                    <th>Titel</th>
                                    <th>Kategorie</th>
                                    <th>Qualität</th>
                                    <th>Gefunden</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for source in recent_sources %}
                                <tr>
                                    <td>
                                        <img src="{{ source.favicon_url }}" width="16" height="16" class="me-2" onerror="this.style.display='none'">
                                        <a href="{{ source.url }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                                            {{ source.domain }}
                                        </a>
                                    </td>
                                    <td>
                                        <span title="{{ source.title }}">
                                            {{ source.title|truncatewords:8|default:"-" }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ source.get_category_display }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ source.quality_color }}">{{ source.quality_score }}</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ source.last_found|date:"d.m.Y" }}</small>
                                    </td>
                                    <td>
                                        <a href="{% url 'backloom:source_detail' source.pk %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        Keine Quellen vorhanden. Starten Sie eine Suche!
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bereinigen Modal -->
<div class="modal fade" id="cleanupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-broom text-danger me-2"></i>Daten bereinigen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Welche Einträge sollen gelöscht werden?</p>

                <div class="list-group">
                    <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-months="1">
                        <span><i class="fas fa-calendar-day me-2"></i>Älter als 1 Monat</span>
                        <span class="badge bg-secondary" id="cleanup-count-1">-</span>
                    </button>
                    <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-months="3">
                        <span><i class="fas fa-calendar-week me-2"></i>Älter als 3 Monate</span>
                        <span class="badge bg-secondary" id="cleanup-count-3">-</span>
                    </button>
                    <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-months="6">
                        <span><i class="fas fa-calendar-alt me-2"></i>Älter als 6 Monate</span>
                        <span class="badge bg-secondary" id="cleanup-count-6">-</span>
                    </button>
                    <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-months="12">
                        <span><i class="fas fa-calendar me-2"></i>Älter als 12 Monate</span>
                        <span class="badge bg-secondary" id="cleanup-count-12">-</span>
                    </button>
                    <button type="button" class="list-group-item list-group-item-action list-group-item-danger d-flex justify-content-between align-items-center" data-months="all">
                        <span><i class="fas fa-trash-alt me-2"></i>Alle Einträge löschen</span>
                        <span class="badge bg-danger" id="cleanup-count-all">-</span>
                    </button>
                </div>

                <div class="alert alert-warning mt-3 mb-0 small">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    <strong>Achtung:</strong> Gelöschte Einträge können nicht wiederhergestellt werden!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
            </div>
        </div>
    </div>
</div>

<!-- Suchbegriffe Modal -->
<div class="modal fade" id="queriesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-database text-primary me-2"></i>Suchbegriffe verwalten
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Neuen Suchbegriff hinzufügen -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <i class="fas fa-plus me-1"></i>Neuen Suchbegriff hinzufügen
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm" id="new-query-text" placeholder="Suchbegriff...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="new-query-category">
                                    <option value="other">Sonstiges</option>
                                    <option value="guest_post">Gastbeitrag</option>
                                    <option value="directory">Verzeichnis</option>
                                    <option value="forum">Forum</option>
                                    <option value="comment">Kommentar</option>
                                    <option value="profile">Profil</option>
                                    <option value="qa">Q&A</option>
                                    <option value="news">News</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control form-control-sm" id="new-query-priority" value="5" min="1" max="10" title="Priorität (1-10)">
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-primary btn-sm w-100" id="btn-add-query">
                                    <i class="fas fa-plus"></i> Hinzufügen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vorhandene Suchbegriffe -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small">
                        <span id="queries-count">0</span> Suchbegriffe
                    </span>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-load-defaults">
                        <i class="fas fa-download me-1"></i>Vordefinierte laden
                    </button>
                </div>

                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 40px;">Aktiv</th>
                                <th>Suchbegriff</th>
                                <th style="width: 120px;">Kategorie</th>
                                <th style="width: 60px;">Prio</th>
                                <th style="width: 80px;"></th>
                            </tr>
                        </thead>
                        <tbody id="queries-table-body">
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                    Lade Suchbegriffe...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<!-- Live Search Progress Modal -->
<div class="modal fade" id="searchProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>Backlink-Suche
                    <span id="search-status-badge" class="badge bg-primary ms-2">Läuft</span>
                </h5>
            </div>
            <div class="modal-body">
                <!-- Statistiken -->
                <div class="row text-center mb-4">
                    <div class="col-4">
                        <div class="h3 mb-0 text-primary" id="modal-found">0</div>
                        <small class="text-muted">Gefunden</small>
                    </div>
                    <div class="col-4">
                        <div class="h3 mb-0 text-success" id="modal-new">0</div>
                        <small class="text-muted">Neu</small>
                    </div>
                    <div class="col-4">
                        <div class="h3 mb-0 text-info" id="modal-updated">0</div>
                        <small class="text-muted">Aktualisiert</small>
                    </div>
                </div>

                <!-- Progress-Log -->
                <div class="bg-dark text-light p-3 rounded" id="progress-log-container"
                     style="height: 300px; overflow-y: auto; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;">
                    <div id="progress-log">
                        Warte auf Suchstart...
                    </div>
                </div>

                <!-- Quellen-Status (nur ausgewählte Quellen) -->
                <div class="row mt-3" id="source-status-row">
                    <div class="col-12">
                        <small class="text-muted">Aktive Quellen:</small>
                        <div class="d-flex flex-wrap gap-2 mt-1" id="source-indicators">
                            <span class="badge bg-secondary" data-source="duckduckgo" style="display:none;">
                                <i class="fas fa-search me-1"></i>DuckDuckGo: -
                            </span>
                            <span class="badge bg-secondary" data-source="youtube" style="display:none;">
                                <i class="fab fa-youtube me-1"></i>YouTube: -
                            </span>
                            <span class="badge bg-secondary" data-source="tiktok" style="display:none;">
                                <i class="fab fa-tiktok me-1"></i>TikTok: -
                            </span>
                            <span class="badge bg-secondary" data-source="reddit" style="display:none;">
                                <i class="fab fa-reddit me-1"></i>Reddit: -
                            </span>
                            <span class="badge bg-secondary" data-source="pinterest" style="display:none;">
                                <i class="fab fa-pinterest me-1"></i>Pinterest: -
                            </span>
                            <span class="badge bg-secondary" data-source="quora" style="display:none;">
                                <i class="fab fa-quora me-1"></i>Quora: -
                            </span>
                            <span class="badge bg-secondary" data-source="medium" style="display:none;">
                                <i class="fab fa-medium me-1"></i>Medium: -
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btn-close-modal" disabled>
                    Schließen
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                      document.querySelector('meta[name="csrf-token"]')?.content;

    let progressInterval = null;
    let isSearchRunning = false;

    // ========== HEALTH CHECK (Ampelsystem) ==========
    const healthCheckSection = document.getElementById('health-check-section');
    const healthCheckResults = document.getElementById('health-check-results');
    const btnHealthCheck = document.getElementById('btn-health-check');
    const btnRefreshHealth = document.getElementById('btn-refresh-health');

    function runHealthCheck() {
        healthCheckSection.style.display = 'block';
        healthCheckResults.innerHTML = `
            <div class="col-12 text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Prüfe Quellen...</span>
                </div>
                <p class="mt-2 mb-0 text-muted">Prüfe Quellen...</p>
            </div>
        `;

        fetch('{% url "backloom:api_health_check" %}')
            .then(response => response.json())
            .then(data => {
                let html = '';
                data.sources.forEach(source => {
                    let statusClass = 'secondary';
                    let statusIcon = 'fas fa-question-circle';
                    let borderClass = 'border';

                    if (source.status === 'ok') {
                        statusClass = 'success';
                        statusIcon = 'fas fa-check-circle';
                        borderClass = 'border border-success';
                    } else if (source.status === 'warning') {
                        statusClass = 'warning';
                        statusIcon = 'fas fa-exclamation-triangle';
                        borderClass = 'border border-warning';
                    } else if (source.status === 'error') {
                        statusClass = 'danger';
                        statusIcon = 'fas fa-times-circle';
                        borderClass = 'border border-danger';
                    } else if (source.status === 'disabled') {
                        statusClass = 'secondary';
                        statusIcon = 'fas fa-ban';
                        borderClass = 'border opacity-50';
                    }

                    const enabledLabel = source.enabled === false ? '<span class="badge bg-secondary ms-2">Deaktiviert</span>' : '';

                    html += `
                        <div class="col-md-4 col-sm-6 mb-3">
                            <div class="d-flex align-items-center p-3 ${borderClass} rounded">
                                <i class="${statusIcon} text-${statusClass} fa-2x me-3"></i>
                                <div>
                                    <strong>${source.name}</strong>${enabledLabel}<br>
                                    <small class="text-${statusClass}">${source.message}</small>
                                    ${source.response_time ? `<br><small class="text-muted">${source.response_time}ms</small>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                healthCheckResults.innerHTML = html;
            })
            .catch(error => {
                healthCheckResults.innerHTML = `
                    <div class="col-12 text-center py-3 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>Fehler beim Prüfen der Quellen: ${error}</p>
                    </div>
                `;
            });
    }

    if (btnHealthCheck) {
        btnHealthCheck.addEventListener('click', runHealthCheck);
    }
    if (btnRefreshHealth) {
        btnRefreshHealth.addEventListener('click', runHealthCheck);
    }

    // ========== LIVE PROGRESS ==========
    const progressModal = new bootstrap.Modal(document.getElementById('searchProgressModal'));
    const progressLog = document.getElementById('progress-log');
    const progressLogContainer = document.getElementById('progress-log-container');
    const btnCloseModal = document.getElementById('btn-close-modal');

    function updateProgress() {
        fetch('{% url "backloom:api_search_progress" %}')
            .then(response => response.json())
            .then(data => {
                if (!data.has_search) return;

                // Statistiken aktualisieren
                document.getElementById('modal-found').textContent = data.sources_found || 0;
                document.getElementById('modal-new').textContent = data.new_sources || 0;
                document.getElementById('modal-updated').textContent = data.updated_sources || 0;

                // Progress-Log aktualisieren
                if (data.progress_lines && data.progress_lines.length > 0) {
                    let logHtml = '';
                    data.progress_lines.forEach(line => {
                        // Farbcodierung für verschiedene Log-Typen
                        let lineClass = '';
                        if (line.includes('Fehler') || line.includes('Error')) {
                            lineClass = 'text-danger';
                        } else if (line.includes('gefunden')) {
                            lineClass = 'text-success';
                        } else if (line.includes('---')) {
                            lineClass = 'text-info';
                        } else if (line.includes('Suche:')) {
                            lineClass = 'text-warning';
                        }
                        logHtml += `<div class="${lineClass}">${line}</div>`;
                    });
                    progressLog.innerHTML = logHtml;
                    // Auto-scroll nach unten
                    progressLogContainer.scrollTop = progressLogContainer.scrollHeight;
                }

                // Status-Badge aktualisieren
                const statusBadge = document.getElementById('search-status-badge');
                if (data.is_running) {
                    statusBadge.className = 'badge bg-primary ms-2';
                    statusBadge.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Läuft';
                    btnCloseModal.disabled = true;
                } else if (data.status === 'completed') {
                    statusBadge.className = 'badge bg-success ms-2';
                    statusBadge.textContent = 'Abgeschlossen';
                    btnCloseModal.disabled = false;
                    stopProgressPolling();
                    // Seite nach kurzer Verzögerung neu laden
                    setTimeout(() => location.reload(), 2000);
                } else if (data.status === 'failed') {
                    statusBadge.className = 'badge bg-danger ms-2';
                    statusBadge.textContent = 'Fehlgeschlagen';
                    btnCloseModal.disabled = false;
                    stopProgressPolling();
                    if (data.error_log) {
                        progressLog.innerHTML += `<div class="text-danger mt-2">FEHLER: ${data.error_log}</div>`;
                    }
                }

                // Quellen-Indikatoren aus Log parsen
                updateSourceIndicators(data.progress_lines);
            })
            .catch(error => console.error('Progress update error:', error));
    }

    function updateSourceIndicators(lines) {
        // Aktive Quellen (Google/Bing/Ecosia sind deaktiviert)
        const sources = ['duckduckgo', 'youtube', 'tiktok', 'reddit', 'pinterest', 'quora', 'medium'];
        const counts = {};

        sources.forEach(s => counts[s] = 0);

        if (lines) {
            lines.forEach(line => {
                const lower = line.toLowerCase();
                sources.forEach(source => {
                    // Match patterns like "DuckDuckGo: 10 Ergebnisse" or "YouTube: 5 Videos" or "TikTok: 3 URLs" or "Reddit: 5 Ergebnisse"
                    const match = lower.match(new RegExp(`${source}[:\\s]+([0-9]+)\\s+(ergebnisse|videos|urls)`));
                    if (match) {
                        counts[source] = Math.max(counts[source], parseInt(match[1]));
                    }
                });
            });
        }

        sources.forEach(source => {
            const indicator = document.querySelector(`[data-source="${source}"]`);
            if (indicator) {
                const count = counts[source];
                if (count > 0) {
                    indicator.className = 'badge bg-success';
                } else {
                    indicator.className = 'badge bg-secondary';
                }
                const iconHtml = indicator.innerHTML.split(':')[0] + ': ';
                indicator.innerHTML = iconHtml + count;
            }
        });
    }

    function startProgressPolling() {
        if (progressInterval) return;
        updateProgress();
        progressInterval = setInterval(updateProgress, 2000);
    }

    function stopProgressPolling() {
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
    }

    // ========== SUCHE STARTEN ==========
    const btnStartSearch = document.getElementById('btn-start-search');
    if (btnStartSearch) {
        btnStartSearch.addEventListener('click', function() {
            // Ausgewählte Quellen sammeln
            const selectedSources = [];
            if (document.getElementById('source-duckduckgo')?.checked) selectedSources.push('duckduckgo');
            if (document.getElementById('source-youtube')?.checked) selectedSources.push('youtube');
            if (document.getElementById('source-tiktok')?.checked) selectedSources.push('tiktok');
            if (document.getElementById('source-reddit')?.checked) selectedSources.push('reddit');
            if (document.getElementById('source-pinterest')?.checked) selectedSources.push('pinterest');
            if (document.getElementById('source-quora')?.checked) selectedSources.push('quora');
            if (document.getElementById('source-medium')?.checked) selectedSources.push('medium');

            if (selectedSources.length === 0) {
                alert('Bitte wählen Sie mindestens eine Quelle aus!');
                return;
            }

            const sourceNames = selectedSources.map(s => {
                if (s === 'duckduckgo') return 'DuckDuckGo';
                if (s === 'youtube') return 'YouTube';
                if (s === 'tiktok') return 'TikTok';
                if (s === 'reddit') return 'Reddit';
                if (s === 'pinterest') return 'Pinterest';
                if (s === 'quora') return 'Quora';
                if (s === 'medium') return 'Medium';
                return s;
            }).join(', ');

            if (!confirm(`Backlink-Suche starten mit: ${sourceNames}?\n\nDies kann einige Minuten dauern.`)) return;

            btnStartSearch.disabled = true;
            btnStartSearch.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Startet...';

            // Modal öffnen
            progressLog.innerHTML = '<div class="text-muted">Starte Suche mit: ' + sourceNames + '</div>';
            document.getElementById('modal-found').textContent = '0';
            document.getElementById('modal-new').textContent = '0';
            document.getElementById('modal-updated').textContent = '0';
            document.getElementById('search-status-badge').className = 'badge bg-primary ms-2';
            document.getElementById('search-status-badge').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Startet';
            btnCloseModal.disabled = true;
            
            // Nur ausgewählte Quellen als Badges anzeigen
            const allSources = ['duckduckgo', 'youtube', 'tiktok', 'reddit', 'pinterest', 'quora', 'medium'];
            allSources.forEach(s => {
                const badge = document.querySelector(`[data-source="${s}"]`);
                if (badge) {
                    badge.style.display = selectedSources.includes(s) ? 'inline-block' : 'none';
                    // Reset Badge
                    badge.className = 'badge bg-secondary';
                    const iconHtml = badge.innerHTML.split(':')[0] + ': ';
                    badge.innerHTML = iconHtml + '0';
                }
            });
            
            progressModal.show();

            // Suche starten mit ausgewählten Quellen
            const formData = new URLSearchParams();
            formData.append('sources', selectedSources.join(','));

            fetch('{% url "backloom:api_start_search" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Progress-Polling starten
                    startProgressPolling();
                } else {
                    alert('Fehler: ' + data.error);
                    progressModal.hide();
                    btnStartSearch.disabled = false;
                    btnStartSearch.innerHTML = '<i class="fas fa-search me-1"></i>Suche starten';
                }
            })
            .catch(error => {
                alert('Fehler: ' + error);
                progressModal.hide();
                btnStartSearch.disabled = false;
                btnStartSearch.innerHTML = '<i class="fas fa-search me-1"></i>Suche starten';
            });
        });
    }

    // Modal schließen -> Polling stoppen
    document.getElementById('searchProgressModal').addEventListener('hidden.bs.modal', function() {
        stopProgressPolling();
    });

    // ========== SUCHBEGRIFFE MODAL ==========
    const queriesModal = new bootstrap.Modal(document.getElementById('queriesModal'));
    const queriesTableBody = document.getElementById('queries-table-body');
    const queriesCount = document.getElementById('queries-count');

    const categoryLabels = {
        'other': 'Sonstiges',
        'guest_post': 'Gastbeitrag',
        'directory': 'Verzeichnis',
        'forum': 'Forum',
        'comment': 'Kommentar',
        'profile': 'Profil',
        'qa': 'Q&A',
        'news': 'News'
    };

    function loadQueries() {
        queriesTableBody.innerHTML = `
            <tr><td colspan="5" class="text-center text-muted py-4">
                <div class="spinner-border spinner-border-sm" role="status"></div> Lade...
            </td></tr>
        `;

        fetch('{% url "backloom:api_get_queries" %}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    queriesCount.textContent = data.queries.length;
                    if (data.queries.length === 0) {
                        queriesTableBody.innerHTML = `
                            <tr><td colspan="5" class="text-center text-muted py-4">
                                Keine Suchbegriffe vorhanden. Fügen Sie welche hinzu oder laden Sie die vordefinierten.
                            </td></tr>
                        `;
                        return;
                    }

                    let html = '';
                    data.queries.forEach(q => {
                        html += `
                            <tr data-id="${q.id}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input query-toggle" ${q.is_active ? 'checked' : ''}>
                                </td>
                                <td>
                                    <span class="query-text">${q.query}</span>
                                    <input type="text" class="form-control form-control-sm query-edit-input d-none" value="${q.query}">
                                </td>
                                <td>
                                    <span class="query-category-text">${categoryLabels[q.category] || q.category}</span>
                                    <select class="form-select form-select-sm query-edit-category d-none">
                                        ${Object.entries(categoryLabels).map(([k, v]) =>
                                            `<option value="${k}" ${q.category === k ? 'selected' : ''}>${v}</option>`
                                        ).join('')}
                                    </select>
                                </td>
                                <td>
                                    <span class="query-priority-text">${q.priority}</span>
                                    <input type="number" class="form-control form-control-sm query-edit-priority d-none" value="${q.priority}" min="1" max="10" style="width: 60px;">
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm query-actions">
                                        <button type="button" class="btn btn-outline-primary btn-edit" title="Bearbeiten">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-delete" title="Löschen">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="btn-group btn-group-sm query-edit-actions d-none">
                                        <button type="button" class="btn btn-success btn-save" title="Speichern">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-cancel" title="Abbrechen">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    queriesTableBody.innerHTML = html;
                    attachQueryEventListeners();
                }
            })
            .catch(error => {
                queriesTableBody.innerHTML = `
                    <tr><td colspan="5" class="text-center text-danger py-4">
                        Fehler beim Laden: ${error}
                    </td></tr>
                `;
            });
    }

    function attachQueryEventListeners() {
        // Toggle aktiv/inaktiv
        queriesTableBody.querySelectorAll('.query-toggle').forEach(cb => {
            cb.addEventListener('change', function() {
                const row = this.closest('tr');
                const id = row.dataset.id;
                fetch('{% url "backloom:api_toggle_query" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `id=${id}`
                });
            });
        });

        // Bearbeiten-Modus starten
        queriesTableBody.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', function() {
                const row = this.closest('tr');
                row.querySelector('.query-text').classList.add('d-none');
                row.querySelector('.query-edit-input').classList.remove('d-none');
                row.querySelector('.query-category-text').classList.add('d-none');
                row.querySelector('.query-edit-category').classList.remove('d-none');
                row.querySelector('.query-priority-text').classList.add('d-none');
                row.querySelector('.query-edit-priority').classList.remove('d-none');
                row.querySelector('.query-actions').classList.add('d-none');
                row.querySelector('.query-edit-actions').classList.remove('d-none');
                row.querySelector('.query-edit-input').focus();
            });
        });

        // Bearbeiten abbrechen
        queriesTableBody.querySelectorAll('.btn-cancel').forEach(btn => {
            btn.addEventListener('click', function() {
                const row = this.closest('tr');
                row.querySelector('.query-text').classList.remove('d-none');
                row.querySelector('.query-edit-input').classList.add('d-none');
                row.querySelector('.query-category-text').classList.remove('d-none');
                row.querySelector('.query-edit-category').classList.add('d-none');
                row.querySelector('.query-priority-text').classList.remove('d-none');
                row.querySelector('.query-edit-priority').classList.add('d-none');
                row.querySelector('.query-actions').classList.remove('d-none');
                row.querySelector('.query-edit-actions').classList.add('d-none');
            });
        });

        // Speichern
        queriesTableBody.querySelectorAll('.btn-save').forEach(btn => {
            btn.addEventListener('click', function() {
                const row = this.closest('tr');
                const id = row.dataset.id;
                const query = row.querySelector('.query-edit-input').value.trim();
                const category = row.querySelector('.query-edit-category').value;
                const priority = row.querySelector('.query-edit-priority').value;

                if (!query) {
                    alert('Suchbegriff darf nicht leer sein!');
                    return;
                }

                fetch('{% url "backloom:api_update_query" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `id=${id}&query=${encodeURIComponent(query)}&category=${category}&priority=${priority}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadQueries();
                    } else {
                        alert('Fehler: ' + data.error);
                    }
                });
            });
        });

        // Löschen
        queriesTableBody.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!confirm('Suchbegriff wirklich löschen?')) return;
                const row = this.closest('tr');
                const id = row.dataset.id;

                fetch('{% url "backloom:api_delete_query" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `id=${id}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        row.remove();
                        queriesCount.textContent = parseInt(queriesCount.textContent) - 1;
                    } else {
                        alert('Fehler: ' + data.error);
                    }
                });
            });
        });
    }

    // Neuen Suchbegriff hinzufügen
    document.getElementById('btn-add-query')?.addEventListener('click', function() {
        const query = document.getElementById('new-query-text').value.trim();
        const category = document.getElementById('new-query-category').value;
        const priority = document.getElementById('new-query-priority').value;

        if (!query) {
            alert('Bitte einen Suchbegriff eingeben!');
            return;
        }

        fetch('{% url "backloom:api_add_query" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `query=${encodeURIComponent(query)}&category=${category}&priority=${priority}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('new-query-text').value = '';
                loadQueries();
            } else {
                alert('Fehler: ' + data.error);
            }
        });
    });

    // Vordefinierte Suchbegriffe laden
    document.getElementById('btn-load-defaults')?.addEventListener('click', function() {
        if (!confirm('Vordefinierte Suchbegriffe laden? Vorhandene bleiben erhalten.')) return;

        fetch('{% url "backloom:api_init_queries" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                loadQueries();
            } else {
                alert('Fehler: ' + data.error);
            }
        });
    });

    // Suchbegriffe-Button öffnet Modal
    const btnInitQueries = document.getElementById('btn-init-queries');
    if (btnInitQueries) {
        btnInitQueries.addEventListener('click', function() {
            queriesModal.show();
            loadQueries();
        });
    }

    // ========== BEREINIGEN MODAL ==========
    const cleanupModal = new bootstrap.Modal(document.getElementById('cleanupModal'));

    function loadCleanupStats() {
        fetch('{% url "backloom:api_cleanup_stats" %}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('cleanup-count-1').textContent = data.counts['1'] || 0;
                    document.getElementById('cleanup-count-3').textContent = data.counts['3'] || 0;
                    document.getElementById('cleanup-count-6').textContent = data.counts['6'] || 0;
                    document.getElementById('cleanup-count-12').textContent = data.counts['12'] || 0;
                    document.getElementById('cleanup-count-all').textContent = data.counts['all'] || 0;
                }
            });
    }

    // Cleanup-Button Event-Listeners
    document.querySelectorAll('#cleanupModal [data-months]').forEach(btn => {
        btn.addEventListener('click', function() {
            const months = this.dataset.months;
            const label = months === 'all' ? 'ALLE Einträge' : `Einträge älter als ${months} Monat(e)`;

            if (!confirm(`${label} wirklich löschen?\n\nDies kann nicht rückgängig gemacht werden!`)) return;

            fetch('{% url "backloom:api_cleanup" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `months=${months}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    cleanupModal.hide();
                    location.reload();
                } else {
                    alert('Fehler: ' + data.error);
                }
            });
        });
    });

    // Bereinigen-Button öffnet Modal
    const btnCleanup = document.getElementById('btn-cleanup');
    if (btnCleanup) {
        btnCleanup.addEventListener('click', function() {
            cleanupModal.show();
            loadCleanupStats();
        });
    }

    // ========== AUTO-CHECK bei laufender Suche ==========
    {% if running_search %}
    // Es läuft bereits eine Suche -> Modal öffnen und Polling starten
    progressModal.show();
    startProgressPolling();
    {% endif %}
});
</script>
{% endblock %}
