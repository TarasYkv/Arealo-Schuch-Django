{% extends "base.html" %}
{% load static %}

{% block title %}BackLoom - Backlink Discovery{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="fas fa-link text-primary me-2"></i>BackLoom
                    </h1>
                    <p class="text-muted mb-0">Automatische Backlink-Recherche</p>
                </div>

                {% if is_superuser %}
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Quellen-Auswahl (nur funktionierende Quellen) -->
                    <div class="btn-group me-2" role="group" aria-label="Quellen auswählen">
                        <input type="checkbox" class="btn-check" id="source-duckduckgo" checked>
                        <label class="btn btn-outline-success btn-sm" for="source-duckduckgo" title="DuckDuckGo (HTML)">
                            <i class="fas fa-search"></i> DuckDuckGo
                        </label>

                        <input type="checkbox" class="btn-check" id="source-youtube" checked>
                        <label class="btn btn-outline-danger btn-sm" for="source-youtube" title="YouTube (API)">
                            <i class="fab fa-youtube"></i> YouTube
                        </label>

                        <input type="checkbox" class="btn-check" id="source-tiktok">
                        <label class="btn btn-outline-dark btn-sm" for="source-tiktok" title="TikTok (Supadata API)">
                            <i class="fab fa-tiktok"></i> TikTok
                        </label>
                    </div>

                    <button type="button"
                            id="btn-start-search"
                            class="btn btn-primary"
                            {% if running_search %}disabled{% endif %}>
                        <i class="fas fa-search me-1"></i>
                        {% if running_search %}
                            Suche läuft...
                        {% else %}
                            Suche starten
                        {% endif %}
                    </button>
                    <button type="button" id="btn-health-check" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-heartbeat me-1"></i>Prüfen
                    </button>
                    <button type="button" id="btn-init-queries" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-database me-1"></i>Suchbegriffe
                    </button>
                    <button type="button" id="btn-cleanup" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-broom me-1"></i>Bereinigen
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Ampelsystem - Quellen-Status -->
    <div class="row mb-4" id="health-check-section" style="display: none;">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-traffic-light text-muted me-2"></i>Quellen-Status (Ampelsystem)
                    </h5>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-refresh-health">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="row" id="health-check-results">
                        <!-- Wird per JavaScript gefüllt -->
                        <div class="col-12 text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Prüfe Quellen...</span>
                            </div>
                            <p class="mt-2 mb-0 text-muted">Prüfe Quellen...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistik-Karten -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-link text-primary fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0" id="stat-total">{{ total_sources }}</h3>
                            <small class="text-muted">Gesamt</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-star text-info fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0" id="stat-new">{{ new_sources }}</h3>
                            <small class="text-muted">Neu</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-check text-warning fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0" id="stat-processed">{{ processed_sources }}</h3>
                            <small class="text-muted">Bearbeitet</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-trophy text-success fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0" id="stat-successful">{{ successful_sources }}</h3>
                            <small class="text-muted">Erfolgreich</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Letzte Suche -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-muted me-2"></i>Letzte Suche
                    </h5>
                </div>
                <div class="card-body">
                    {% if last_search %}
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <span class="badge bg-{{ last_search.status }} fs-6" id="last-search-status">
                                {{ last_search.get_status_display }}
                            </span>
                        </div>
                        <small class="text-muted">
                            {{ last_search.created_at|date:"d.m.Y H:i" }}
                        </small>
                    </div>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h4 mb-0" id="last-search-found">{{ last_search.sources_found }}</div>
                            <small class="text-muted">Gefunden</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 mb-0 text-success" id="last-search-new">{{ last_search.new_sources }}</div>
                            <small class="text-muted">Neu</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 mb-0 text-info" id="last-search-updated">{{ last_search.updated_sources }}</div>
                            <small class="text-muted">Aktualisiert</small>
                        </div>
                    </div>
                    {% if last_search.duration_formatted %}
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>Dauer: {{ last_search.duration_formatted }}
                        </small>
                    </div>
                    {% endif %}
                    {% else %}
                    <p class="text-muted mb-0">Noch keine Suche durchgeführt.</p>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="{% url 'backloom:search_history' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-list me-1"></i>Alle Suchen
                    </a>
                </div>
            </div>
        </div>

        <!-- Kategorien-Verteilung -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie text-muted me-2"></i>Kategorien
                    </h5>
                </div>
                <div class="card-body">
                    {% if category_stats %}
                    <div class="list-group list-group-flush">
                        {% for stat in category_stats %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span>
                                {% for key, label in categories %}
                                    {% if key == stat.category %}{{ label }}{% endif %}
                                {% endfor %}
                            </span>
                            <span class="badge bg-primary rounded-pill">{{ stat.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Keine Daten vorhanden.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Neueste Quellen -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clock text-muted me-2"></i>Neueste Quellen
                    </h5>
                    <a href="{% url 'backloom:feed' %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-list me-1"></i>Alle anzeigen
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Domain</th>
                                    <th>Titel</th>
                                    <th>Kategorie</th>
                                    <th>Qualität</th>
                                    <th>Gefunden</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for source in recent_sources %}
                                <tr>
                                    <td>
                                        <img src="{{ source.favicon_url }}" width="16" height="16" class="me-2" onerror="this.style.display='none'">
                                        <a href="{{ source.url }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                                            {{ source.domain }}
                                        </a>
                                    </td>
                                    <td>
                                        <span title="{{ source.title }}">
                                            {{ source.title|truncatewords:8|default:"-" }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ source.get_category_display }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ source.quality_color }}">{{ source.quality_score }}</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ source.last_found|date:"d.m.Y" }}</small>
                                    </td>
                                    <td>
                                        <a href="{% url 'backloom:source_detail' source.pk %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        Keine Quellen vorhanden. Starten Sie eine Suche!
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Search Progress Modal -->
<div class="modal fade" id="searchProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>Backlink-Suche
                    <span id="search-status-badge" class="badge bg-primary ms-2">Läuft</span>
                </h5>
            </div>
            <div class="modal-body">
                <!-- Statistiken -->
                <div class="row text-center mb-4">
                    <div class="col-4">
                        <div class="h3 mb-0 text-primary" id="modal-found">0</div>
                        <small class="text-muted">Gefunden</small>
                    </div>
                    <div class="col-4">
                        <div class="h3 mb-0 text-success" id="modal-new">0</div>
                        <small class="text-muted">Neu</small>
                    </div>
                    <div class="col-4">
                        <div class="h3 mb-0 text-info" id="modal-updated">0</div>
                        <small class="text-muted">Aktualisiert</small>
                    </div>
                </div>

                <!-- Progress-Log -->
                <div class="bg-dark text-light p-3 rounded" id="progress-log-container"
                     style="height: 300px; overflow-y: auto; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;">
                    <div id="progress-log">
                        Warte auf Suchstart...
                    </div>
                </div>

                <!-- Quellen-Status (nur aktive Quellen) -->
                <div class="row mt-3" id="source-status-row">
                    <div class="col-12">
                        <small class="text-muted">Aktive Quellen:</small>
                        <div class="d-flex flex-wrap gap-2 mt-1" id="source-indicators">
                            <span class="badge bg-secondary" data-source="duckduckgo">
                                <i class="fas fa-search me-1"></i>DuckDuckGo: -
                            </span>
                            <span class="badge bg-secondary" data-source="youtube">
                                <i class="fab fa-youtube me-1"></i>YouTube: -
                            </span>
                            <span class="badge bg-secondary" data-source="tiktok">
                                <i class="fab fa-tiktok me-1"></i>TikTok: -
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btn-close-modal" disabled>
                    Schließen
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                      document.querySelector('meta[name="csrf-token"]')?.content;

    let progressInterval = null;
    let isSearchRunning = false;

    // ========== HEALTH CHECK (Ampelsystem) ==========
    const healthCheckSection = document.getElementById('health-check-section');
    const healthCheckResults = document.getElementById('health-check-results');
    const btnHealthCheck = document.getElementById('btn-health-check');
    const btnRefreshHealth = document.getElementById('btn-refresh-health');

    function runHealthCheck() {
        healthCheckSection.style.display = 'block';
        healthCheckResults.innerHTML = `
            <div class="col-12 text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Prüfe Quellen...</span>
                </div>
                <p class="mt-2 mb-0 text-muted">Prüfe Quellen...</p>
            </div>
        `;

        fetch('{% url "backloom:api_health_check" %}')
            .then(response => response.json())
            .then(data => {
                let html = '';
                data.sources.forEach(source => {
                    let statusClass = 'secondary';
                    let statusIcon = 'fas fa-question-circle';
                    let borderClass = 'border';

                    if (source.status === 'ok') {
                        statusClass = 'success';
                        statusIcon = 'fas fa-check-circle';
                        borderClass = 'border border-success';
                    } else if (source.status === 'warning') {
                        statusClass = 'warning';
                        statusIcon = 'fas fa-exclamation-triangle';
                        borderClass = 'border border-warning';
                    } else if (source.status === 'error') {
                        statusClass = 'danger';
                        statusIcon = 'fas fa-times-circle';
                        borderClass = 'border border-danger';
                    } else if (source.status === 'disabled') {
                        statusClass = 'secondary';
                        statusIcon = 'fas fa-ban';
                        borderClass = 'border opacity-50';
                    }

                    const enabledLabel = source.enabled === false ? '<span class="badge bg-secondary ms-2">Deaktiviert</span>' : '';

                    html += `
                        <div class="col-md-4 col-sm-6 mb-3">
                            <div class="d-flex align-items-center p-3 ${borderClass} rounded">
                                <i class="${statusIcon} text-${statusClass} fa-2x me-3"></i>
                                <div>
                                    <strong>${source.name}</strong>${enabledLabel}<br>
                                    <small class="text-${statusClass}">${source.message}</small>
                                    ${source.response_time ? `<br><small class="text-muted">${source.response_time}ms</small>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                healthCheckResults.innerHTML = html;
            })
            .catch(error => {
                healthCheckResults.innerHTML = `
                    <div class="col-12 text-center py-3 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>Fehler beim Prüfen der Quellen: ${error}</p>
                    </div>
                `;
            });
    }

    if (btnHealthCheck) {
        btnHealthCheck.addEventListener('click', runHealthCheck);
    }
    if (btnRefreshHealth) {
        btnRefreshHealth.addEventListener('click', runHealthCheck);
    }

    // ========== LIVE PROGRESS ==========
    const progressModal = new bootstrap.Modal(document.getElementById('searchProgressModal'));
    const progressLog = document.getElementById('progress-log');
    const progressLogContainer = document.getElementById('progress-log-container');
    const btnCloseModal = document.getElementById('btn-close-modal');

    function updateProgress() {
        fetch('{% url "backloom:api_search_progress" %}')
            .then(response => response.json())
            .then(data => {
                if (!data.has_search) return;

                // Statistiken aktualisieren
                document.getElementById('modal-found').textContent = data.sources_found || 0;
                document.getElementById('modal-new').textContent = data.new_sources || 0;
                document.getElementById('modal-updated').textContent = data.updated_sources || 0;

                // Progress-Log aktualisieren
                if (data.progress_lines && data.progress_lines.length > 0) {
                    let logHtml = '';
                    data.progress_lines.forEach(line => {
                        // Farbcodierung für verschiedene Log-Typen
                        let lineClass = '';
                        if (line.includes('Fehler') || line.includes('Error')) {
                            lineClass = 'text-danger';
                        } else if (line.includes('gefunden')) {
                            lineClass = 'text-success';
                        } else if (line.includes('---')) {
                            lineClass = 'text-info';
                        } else if (line.includes('Suche:')) {
                            lineClass = 'text-warning';
                        }
                        logHtml += `<div class="${lineClass}">${line}</div>`;
                    });
                    progressLog.innerHTML = logHtml;
                    // Auto-scroll nach unten
                    progressLogContainer.scrollTop = progressLogContainer.scrollHeight;
                }

                // Status-Badge aktualisieren
                const statusBadge = document.getElementById('search-status-badge');
                if (data.is_running) {
                    statusBadge.className = 'badge bg-primary ms-2';
                    statusBadge.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Läuft';
                    btnCloseModal.disabled = true;
                } else if (data.status === 'completed') {
                    statusBadge.className = 'badge bg-success ms-2';
                    statusBadge.textContent = 'Abgeschlossen';
                    btnCloseModal.disabled = false;
                    stopProgressPolling();
                    // Seite nach kurzer Verzögerung neu laden
                    setTimeout(() => location.reload(), 2000);
                } else if (data.status === 'failed') {
                    statusBadge.className = 'badge bg-danger ms-2';
                    statusBadge.textContent = 'Fehlgeschlagen';
                    btnCloseModal.disabled = false;
                    stopProgressPolling();
                    if (data.error_log) {
                        progressLog.innerHTML += `<div class="text-danger mt-2">FEHLER: ${data.error_log}</div>`;
                    }
                }

                // Quellen-Indikatoren aus Log parsen
                updateSourceIndicators(data.progress_lines);
            })
            .catch(error => console.error('Progress update error:', error));
    }

    function updateSourceIndicators(lines) {
        // Nur aktive Quellen (Google/Bing/Ecosia/Reddit sind deaktiviert)
        const sources = ['duckduckgo', 'youtube', 'tiktok'];
        const counts = {};

        sources.forEach(s => counts[s] = 0);

        if (lines) {
            lines.forEach(line => {
                const lower = line.toLowerCase();
                sources.forEach(source => {
                    // Match patterns like "DuckDuckGo: 10 Ergebnisse" or "YouTube: 5 Videos" or "TikTok: 3 URLs"
                    const match = lower.match(new RegExp(`${source}[:\\s]+([0-9]+)\\s+(ergebnisse|videos|urls)`));
                    if (match) {
                        counts[source] = Math.max(counts[source], parseInt(match[1]));
                    }
                });
            });
        }

        sources.forEach(source => {
            const indicator = document.querySelector(`[data-source="${source}"]`);
            if (indicator) {
                const count = counts[source];
                if (count > 0) {
                    indicator.className = 'badge bg-success';
                } else {
                    indicator.className = 'badge bg-secondary';
                }
                const iconHtml = indicator.innerHTML.split(':')[0] + ': ';
                indicator.innerHTML = iconHtml + count;
            }
        });
    }

    function startProgressPolling() {
        if (progressInterval) return;
        updateProgress();
        progressInterval = setInterval(updateProgress, 2000);
    }

    function stopProgressPolling() {
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
    }

    // ========== SUCHE STARTEN ==========
    const btnStartSearch = document.getElementById('btn-start-search');
    if (btnStartSearch) {
        btnStartSearch.addEventListener('click', function() {
            // Ausgewählte Quellen sammeln (nur funktionierende)
            const selectedSources = [];
            if (document.getElementById('source-duckduckgo')?.checked) selectedSources.push('duckduckgo');
            if (document.getElementById('source-youtube')?.checked) selectedSources.push('youtube');
            if (document.getElementById('source-tiktok')?.checked) selectedSources.push('tiktok');

            if (selectedSources.length === 0) {
                alert('Bitte wählen Sie mindestens eine Quelle aus!');
                return;
            }

            const sourceNames = selectedSources.map(s => {
                if (s === 'duckduckgo') return 'DuckDuckGo';
                if (s === 'youtube') return 'YouTube';
                if (s === 'tiktok') return 'TikTok';
                return s;
            }).join(', ');

            if (!confirm(`Backlink-Suche starten mit: ${sourceNames}?\n\nDies kann einige Minuten dauern.`)) return;

            btnStartSearch.disabled = true;
            btnStartSearch.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Startet...';

            // Modal öffnen
            progressLog.innerHTML = '<div class="text-muted">Starte Suche mit: ' + sourceNames + '</div>';
            document.getElementById('modal-found').textContent = '0';
            document.getElementById('modal-new').textContent = '0';
            document.getElementById('modal-updated').textContent = '0';
            document.getElementById('search-status-badge').className = 'badge bg-primary ms-2';
            document.getElementById('search-status-badge').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Startet';
            btnCloseModal.disabled = true;
            progressModal.show();

            // Suche starten mit ausgewählten Quellen
            const formData = new URLSearchParams();
            formData.append('sources', selectedSources.join(','));

            fetch('{% url "backloom:api_start_search" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Progress-Polling starten
                    startProgressPolling();
                } else {
                    alert('Fehler: ' + data.error);
                    progressModal.hide();
                    btnStartSearch.disabled = false;
                    btnStartSearch.innerHTML = '<i class="fas fa-search me-1"></i>Suche starten';
                }
            })
            .catch(error => {
                alert('Fehler: ' + error);
                progressModal.hide();
                btnStartSearch.disabled = false;
                btnStartSearch.innerHTML = '<i class="fas fa-search me-1"></i>Suche starten';
            });
        });
    }

    // Modal schließen -> Polling stoppen
    document.getElementById('searchProgressModal').addEventListener('hidden.bs.modal', function() {
        stopProgressPolling();
    });

    // ========== SUCHBEGRIFFE LADEN ==========
    const btnInitQueries = document.getElementById('btn-init-queries');
    if (btnInitQueries) {
        btnInitQueries.addEventListener('click', function() {
            if (confirm('Vordefinierte Suchbegriffe laden?')) {
                fetch('{% url "backloom:api_init_queries" %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                })
                .then(response => response.json())
                .then(data => alert(data.success ? data.message : 'Fehler: ' + data.error));
            }
        });
    }

    // ========== BEREINIGEN ==========
    const btnCleanup = document.getElementById('btn-cleanup');
    if (btnCleanup) {
        btnCleanup.addEventListener('click', function() {
            if (confirm('Alle Einträge älter als 12 Monate löschen?')) {
                fetch('{% url "backloom:api_cleanup" %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.success ? data.message : 'Fehler: ' + data.error);
                    if (data.success) location.reload();
                });
            }
        });
    }

    // ========== AUTO-CHECK bei laufender Suche ==========
    {% if running_search %}
    // Es läuft bereits eine Suche -> Modal öffnen und Polling starten
    progressModal.show();
    startProgressPolling();
    {% endif %}
});
</script>
{% endblock %}
