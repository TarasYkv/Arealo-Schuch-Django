{% extends 'base.html' %}
{% load static %}

{% block title %}LearnLoom - PDF-Bibliothek{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'learnloom/css/learnloom.css' %}?v={% now 'U' %}">
<style>
    /* Modern Confirmation Modal */
    .confirm-modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
    }
    .confirm-modal-backdrop.show {
        opacity: 1;
        visibility: visible;
    }
    .confirm-modal {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 380px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        transform: scale(0.9) translateY(20px);
        transition: all 0.2s ease;
    }
    .confirm-modal-backdrop.show .confirm-modal {
        transform: scale(1) translateY(0);
    }
    .confirm-modal-icon {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        font-size: 28px;
    }
    .confirm-modal-icon.danger { background: #fee2e2; color: #dc2626; }
    .confirm-modal-icon.warning { background: #fef3c7; color: #d97706; }
    .confirm-modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        text-align: center;
        margin-bottom: 8px;
        color: #1f2937;
    }
    .confirm-modal-message {
        text-align: center;
        color: #6b7280;
        margin-bottom: 24px;
        line-height: 1.5;
    }
    .confirm-modal-buttons {
        display: flex;
        gap: 12px;
    }
    .confirm-modal-buttons button {
        flex: 1;
        padding: 12px 20px;
        border-radius: 10px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
    }
    .confirm-modal-buttons .btn-cancel {
        background: #f3f4f6;
        color: #4b5563;
    }
    .confirm-modal-buttons .btn-cancel:hover { background: #e5e7eb; }
    .confirm-modal-buttons .btn-confirm {
        background: #dc2626;
        color: white;
    }
    .confirm-modal-buttons .btn-confirm:hover { background: #b91c1c; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-4">
        <div class="mb-2 mb-md-0">
            <h1 class="h2 mb-1">
                <i class="bi bi-book me-2"></i>LearnLoom
            </h1>
            <p class="text-muted mb-0 d-none d-sm-block">Deine PDF-Bibliothek für Bücher & Paper</p>
        </div>
        <div class="d-flex flex-wrap gap-1 gap-md-2">
            <a href="{% url 'learnloom:all_vocabulary' %}" class="btn btn-sm btn-outline-success" title="Alle Vokabeln">
                <i class="bi bi-translate"></i><span class="d-none d-lg-inline ms-1">Vokabeln</span>
            </a>
            <a href="{% url 'learnloom:all_notes' %}" class="btn btn-sm btn-outline-info" title="Alle Notizen">
                <i class="bi bi-sticky"></i><span class="d-none d-lg-inline ms-1">Notizen</span>
            </a>
            <button class="btn btn-sm btn-outline-warning" onclick="toggleReadingList()" title="Leseliste">
                <i class="bi bi-list-check"></i><span class="d-none d-lg-inline ms-1">Leseliste</span>
            </button>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="bi bi-plus-lg"></i><span class="d-none d-sm-inline ms-1">PDF</span>
            </button>
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#batchUploadModal" title="Mehrere PDFs hochladen">
                <i class="bi bi-files"></i><span class="d-none d-lg-inline ms-1">Mehrere</span>
            </button>
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#onlineArticleModal" title="Online-Artikel hinzufügen">
                <i class="bi bi-link-45deg"></i><span class="d-none d-lg-inline ms-1">Online</span>
            </button>
        </div>
    </div>

    <!-- Statistiken -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 p-3 rounded me-3">
                            <i class="bi bi-file-earmark-pdf text-primary fs-4"></i>
                        </div>
                        <div>
                            <p class="text-muted mb-0 small">PDFs</p>
                            <h4 class="mb-0">{{ total_books }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 p-3 rounded me-3">
                            <i class="bi bi-translate text-success fs-4"></i>
                        </div>
                        <div>
                            <p class="text-muted mb-0 small">Vokabeln</p>
                            <h4 class="mb-0">{{ total_vocabulary }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning bg-opacity-10 p-3 rounded me-3">
                            <i class="bi bi-check2-circle text-warning fs-4"></i>
                        </div>
                        <div>
                            <p class="text-muted mb-0 small">Gelernt</p>
                            <h4 class="mb-0">{{ learned_vocabulary }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter -->
    <div class="d-flex gap-2 mb-4 flex-wrap align-items-center">
        <span class="text-muted me-2"><i class="bi bi-funnel me-1"></i>Filter:</span>
        <button class="btn btn-sm btn-primary filter-btn active" data-filter="active">
            <i class="bi bi-eye me-1"></i>Aktiv
        </button>
        <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="all">
            Alle <span class="badge bg-light text-dark ms-1">{{ books|length }}</span>
        </button>
        <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="unread">
            <i class="bi bi-circle me-1"></i>Ungelesen
        </button>
        <button class="btn btn-sm btn-outline-warning filter-btn" data-filter="reading">
            <i class="bi bi-book-half me-1"></i>Dabei
        </button>
        <button class="btn btn-sm btn-outline-success filter-btn" data-filter="completed">
            <i class="bi bi-check-circle-fill me-1"></i>Gelesen
        </button>
        
        <!-- Tag Filter -->
        <div class="dropdown ms-3">
            <button class="btn btn-sm btn-outline-info dropdown-toggle" type="button" id="tagFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-tags me-1"></i>Tags
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="tagFilterDropdown" style="max-height: 300px; overflow-y: auto;">
                <li><a class="dropdown-item tag-filter-item active" href="#" data-tag="all"><i class="bi bi-grid me-2"></i>Alle Tags</a></li>
                <li><hr class="dropdown-divider"></li>
                {% for tag in all_tags %}
                <li><a class="dropdown-item tag-filter-item" href="#" data-tag="{{ tag }}"><i class="bi bi-tag me-2"></i>{{ tag }}</a></li>
                {% empty %}
                <li><span class="dropdown-item text-muted">Keine Tags vorhanden</span></li>
                {% endfor %}
            </ul>
        </div>
        
        <!-- Active Tag Badge -->
        <span id="activeTagBadge" class="badge bg-info d-none">
            <i class="bi bi-tag me-1"></i><span id="activeTagName"></span>
            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.6rem;" onclick="clearTagFilter()"></button>
        </span>

        <!-- Audio Settings -->
        <div class="d-flex gap-2 ms-auto align-items-center">
            <i class="bi bi-mic text-muted" title="TTS-Stimme"></i>
            <select id="audioVoice" class="form-select form-select-sm" style="width: auto;" title="TTS-Stimme">
                <option value="alloy">Alloy</option>
                <option value="echo">Echo</option>
                <option value="fable">Fable</option>
                <option value="onyx">Onyx</option>
                <option value="nova">Nova</option>
                <option value="shimmer">Shimmer</option>
            </select>
            <i class="bi bi-globe text-muted" title="Audio-Sprache"></i>
            <select id="audioLanguage" class="form-select form-select-sm" style="width: auto;" title="Audio-Sprache">
                <option value="de">DE</option>
                <option value="en">EN</option>
            </select>
        </div>
    </div>

    <!-- PDF Kacheln -->
    {% if books %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4" id="booksGrid">
        {% for book in books %}
        <div class="col book-col" data-status="{{ book.reading_status }}" data-tags="{{ book.tags|default:'' }}">
            <div class="card h-100 book-card border-0 shadow-sm" data-book-id="{{ book.id }}">
                <!-- Thumbnail -->
                <div class="book-thumbnail position-relative">
                    {% if book.category == 'online' %}
                    <div class="card-img-top bg-info bg-opacity-10 d-flex align-items-center justify-content-center" style="height: 200px;">
                        <i class="bi bi-link-45deg text-info" style="font-size: 4rem;"></i>
                    </div>
                    {% elif book.thumbnail %}
                    <img src="{{ book.thumbnail.url }}" class="card-img-top" alt="{{ book.title }}">
                    {% else %}
                    <div class="card-img-top bg-secondary bg-opacity-10 d-flex align-items-center justify-content-center" style="height: 200px;">
                        <i class="bi bi-file-earmark-pdf text-secondary" style="font-size: 4rem;"></i>
                    </div>
                    {% endif %}
                    <!-- Kategorie Badge -->
                    <span class="badge bg-{{ book.category|default:'book' }} position-absolute top-0 end-0 m-2">
                        {{ book.get_category_display }}
                    </span>
                    <!-- Audio Controls (nur Paper/Artikel) -->
                    {% if book.category != 'book' and book.category != 'online' %}
                    <div class="audio-controls position-absolute{% if book.summary %} has-summary{% endif %}"
                         data-book-id="{{ book.id }}">
                        <button class="audio-nav-btn audio-prev-btn"
                                onclick="event.stopPropagation(); prevSection('{{ book.id }}')"
                                title="Vorheriger Abschnitt">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="audio-play-btn"
                                data-book-id="{{ book.id }}"
                                onclick="event.stopPropagation(); playBookAudio('{{ book.id }}')"
                                title="Zusammenfassung anhören">
                            <i class="bi bi-play-fill"></i>
                        </button>
                        <button class="audio-nav-btn audio-next-btn"
                                onclick="event.stopPropagation(); nextSection('{{ book.id }}')"
                                title="Nächster Abschnitt">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                        <button class="audio-nav-btn audio-question-btn"
                                onclick="event.stopPropagation(); toggleVoiceQuestion()"
                                title="Frage stellen">
                            <i class="bi bi-mic-fill"></i>
                        </button>
                    </div>
                    {% endif %}
                    <!-- Relevance Badge -->
                    <div class="relevance-badge position-absolute {% if book.relevance == 0 %}relevance-none{% elif book.relevance <= 3 %}relevance-low{% elif book.relevance <= 6 %}relevance-mid{% else %}relevance-high{% endif %}"
                         data-book-id="{{ book.id }}"
                         data-relevance="{{ book.relevance }}"
                         onclick="event.stopPropagation(); toggleRelevanceDropdown('{{ book.id }}')"
                         title="Relevanz: {% if book.relevance == 0 %}nicht bewertet{% else %}{{ book.relevance }}/10{% endif %}">
                        {% if book.relevance == 0 %}&mdash;{% else %}{{ book.relevance }}{% endif %}
                    </div>
                    <div class="relevance-dropdown" data-book-id="{{ book.id }}">
                        <div class="relevance-option opt-clear" onclick="event.stopPropagation(); setRelevance('{{ book.id }}', 0)" title="Bewertung entfernen">&times;</div>
                        <div class="relevance-option opt-low{% if book.relevance == 1 %} active{% endif %}" onclick="event.stopPropagation(); setRelevance('{{ book.id }}', 1)" title="1/10">1</div>
                        <div class="relevance-option opt-low{% if book.relevance == 2 %} active{% endif %}" onclick="event.stopPropagation(); setRelevance('{{ book.id }}', 2)" title="2/10">2</div>
                        <div class="relevance-option opt-low{% if book.relevance == 3 %} active{% endif %}" onclick="event.stopPropagation(); setRelevance('{{ book.id }}', 3)" title="3/10">3</div>
                        <div class="relevance-option opt-mid{% if book.relevance == 4 %} active{% endif %}" onclick="event.stopPropagation(); setRelevance('{{ book.id }}', 4)" title="4/10">4</div>
                        <div class="relevance-option opt-mid{% if book.relevance == 5 %} active{% endif %}" onclick="event.stopPropagation(); setRelevance('{{ book.id }}', 5)" title="5/10">5</div>
                        <div class="relevance-option opt-mid{% if book.relevance == 6 %} active{% endif %}" onclick="event.stopPropagation(); setRelevance('{{ book.id }}', 6)" title="6/10">6</div>
                        <div class="relevance-option opt-high{% if book.relevance == 7 %} active{% endif %}" onclick="event.stopPropagation(); setRelevance('{{ book.id }}', 7)" title="7/10">7</div>
                        <div class="relevance-option opt-high{% if book.relevance == 8 %} active{% endif %}" onclick="event.stopPropagation(); setRelevance('{{ book.id }}', 8)" title="8/10">8</div>
                        <div class="relevance-option opt-high{% if book.relevance == 9 %} active{% endif %}" onclick="event.stopPropagation(); setRelevance('{{ book.id }}', 9)" title="9/10">9</div>
                        <div class="relevance-option opt-high{% if book.relevance == 10 %} active{% endif %}" onclick="event.stopPropagation(); setRelevance('{{ book.id }}', 10)" title="10/10">10</div>
                    </div>
                    <!-- Reading Status Badge -->
                    <span class="badge reading-status-badge position-absolute top-0 start-0 m-2
                        {% if book.reading_status == 'completed' %}bg-success
                        {% elif book.reading_status == 'reading' %}bg-warning text-dark
                        {% else %}bg-secondary{% endif %}"
                        data-book-id="{{ book.id }}"
                        data-status="{{ book.reading_status }}">
                        {% if book.reading_status == 'completed' %}
                        <i class="bi bi-check-circle-fill me-1"></i>Gelesen
                        {% elif book.reading_status == 'reading' %}
                        <i class="bi bi-book-half me-1"></i>Dabei
                        {% else %}
                        <i class="bi bi-circle me-1"></i>Neu
                        {% endif %}
                    </span>
                </div>

                <div class="card-body">
                    <h6 class="card-title text-truncate" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ book.title }}">{{ book.title }}</h6>
                    <p class="card-text small text-muted mb-2">
                        {% if book.category == 'online' %}
                        <i class="bi bi-link-45deg me-1"></i>Online-Artikel
                        {% else %}
                        <i class="bi bi-file-earmark me-1"></i>{{ book.page_count }} Seiten
                        {% endif %}
                        {% if book.last_opened_at %}
                        <br><i class="bi bi-clock me-1"></i>{{ book.last_opened_at|timesince }} ago
                        {% endif %}
                    </p>
                    {% if book.tags %}
                    <div class="book-tags mb-2 text-truncate" style="max-height: 52px; overflow: hidden;" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" title="{% for tag in book.tags_list %}{{ tag }}{% if not forloop.last %}, {% endif %}{% endfor %}">
                        {% for tag in book.tags_list %}
                        <span class="badge bg-light text-dark border me-1 mb-1 tag-badge" data-tag="{{ tag }}" style="cursor: pointer;"><i class="bi bi-tag me-1"></i>{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="card-footer bg-transparent border-0 pt-0">
                    <div class="d-flex gap-1 mb-2">
                        {% if book.category == 'online' %}
                        <a href="{{ book.url }}" target="_blank" class="btn btn-primary btn-sm flex-grow-1">
                            <i class="bi bi-box-arrow-up-right me-1"></i>Öffnen
                        </a>
                        {% else %}
                        <a href="{% url 'learnloom:pdf_viewer' book.id %}" class="btn btn-primary btn-sm flex-grow-1">
                            <i class="bi bi-eye me-1"></i>Lesen
                        </a>
                        {% endif %}
                        <a href="{% url 'learnloom:notes' book.id %}" class="btn btn-outline-secondary btn-sm" title="Notizen">
                            <i class="bi bi-sticky"></i>
                        </a>
                        <a href="{% url 'learnloom:vocabulary' book.id %}" class="btn btn-outline-secondary btn-sm" title="Vokabeln">
                            <i class="bi bi-translate"></i>
                        </a>
                        {% if book.category != 'book' %}
                        <a href="{% url 'learnloom:summary' book.id %}" class="btn btn-outline-info btn-sm" title="Zusammenfassung">
                            <i class="bi bi-file-text"></i>
                        </a>
                        {% endif %}
                    </div>
                    <div class="d-flex gap-1 align-items-center">
                        <div class="dropdown flex-grow-1">
                            <button class="btn btn-outline-secondary w-100 dropdown-toggle status-dropdown" style="font-size:0.95rem;padding:6px 10px;" type="button" data-bs-toggle="dropdown" data-book-id="{{ book.id }}">
                                <i class="bi bi-bookmark me-1"></i>Status
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end w-100">
                                <li><a class="dropdown-item {% if book.reading_status == 'unread' %}active{% endif %}" href="#" onclick="setReadingStatus('{{ book.id }}', 'unread'); return false;">
                                    <i class="bi bi-circle me-2"></i>Noch nicht gelesen
                                </a></li>
                                <li><a class="dropdown-item {% if book.reading_status == 'reading' %}active{% endif %}" href="#" onclick="setReadingStatus('{{ book.id }}', 'reading'); return false;">
                                    <i class="bi bi-book-half me-2"></i>Gerade dabei
                                </a></li>
                                <li><a class="dropdown-item {% if book.reading_status == 'completed' %}active{% endif %}" href="#" onclick="setReadingStatus('{{ book.id }}', 'completed'); return false;">
                                    <i class="bi bi-check-circle-fill me-2"></i>Bereits gelesen
                                </a></li>
                            </ul>
                        </div>
                        <button class="btn btn-outline-primary" style="width:22px;height:22px;padding:0;font-size:0.6rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;" onclick="editBook('{{ book.id }}', '{{ book.title|escapejs }}', '{{ book.tags|escapejs }}', '{{ book.category }}')" title="Bearbeiten">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="bi bi-book text-muted" style="font-size: 5rem;"></i>
        </div>
        <h4 class="text-muted">Noch keine PDFs</h4>
        <p class="text-muted">Lade dein erstes PDF hoch, um mit dem Lernen zu beginnen.</p>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
            <i class="bi bi-plus-lg me-2"></i>PDF hochladen
        </button>
    </div>
    {% endif %}
</div>

<!-- Global Audio Player -->
<audio id="globalAudioPlayer" style="display:none;"></audio>
<audio id="answerAudioPlayer" style="display:none;"></audio>

<!-- Floating Frage-Button (nur sichtbar wenn Audio läuft) -->
<div id="voiceQuestionBtn" class="voice-question-fab" style="display:none;" onclick="toggleVoiceQuestion()">
    <i class="bi bi-mic-fill voice-question-icon"></i>
    <span class="voice-question-label">Frage</span>
</div>

<!-- Voice Question Status Overlay -->
<div id="voiceQuestionOverlay" class="voice-question-overlay" style="display:none;">
    <div class="voice-question-card">
        <div class="voice-question-status">
            <div id="vqListening" style="display:none;">
                <div class="vq-mic-pulse"><i class="bi bi-mic-fill"></i></div>
                <p class="mb-1">Ich h&ouml;re zu...</p>
                <small class="text-muted">Stelle deine Frage oder sage &quot;Weiter&quot; zum Fortsetzen</small>
            </div>
            <div id="vqProcessing" style="display:none;">
                <div class="spinner-border text-primary mb-2" role="status"></div>
                <p class="mb-1" id="vqTranscript"></p>
                <small class="text-muted">Antwort wird generiert...</small>
            </div>
            <div id="vqAnswering" style="display:none;">
                <div class="vq-speaker-pulse"><i class="bi bi-volume-up-fill"></i></div>
                <p class="mb-1" id="vqAnswerText"></p>
            </div>
        </div>
        <button class="btn btn-sm btn-outline-secondary mt-2" onclick="stopVoiceQuestion()">
            <i class="bi bi-x-lg me-1"></i>Schlie&szlig;en
        </button>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">PDF hochladen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <!-- Drag & Drop Zone -->
                    <div class="upload-zone border border-2 border-dashed rounded p-5 text-center mb-3" id="dropZone">
                        <i class="bi bi-cloud-arrow-up text-muted mb-3" style="font-size: 3rem;"></i>
                        <p class="mb-2">PDF hierher ziehen oder klicken zum Auswählen</p>
                        <input type="file" id="pdfFile" name="file" accept=".pdf" class="d-none">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('pdfFile').click()">
                            Datei auswählen
                        </button>
                    </div>
                    <div id="selectedFile" class="alert alert-info d-none">
                        <i class="bi bi-file-earmark-pdf me-2"></i>
                        <span id="fileName"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Titel</label>
                        <input type="text" class="form-control" name="title" id="pdfTitle" placeholder="Wird aus Dateinamen übernommen">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Kategorie</label>
                        <select class="form-select" name="category">
                            <option value="book">Buch</option>
                            <option value="paper">Paper</option>
                            <option value="article">Artikel</option>
                            <option value="other">Sonstiges</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tags (optional)</label>
                        <input type="text" class="form-control" name="tags" placeholder="z.B. Python, Programmierung">
                    </div>

                    <!-- Progress -->
                    <div class="progress d-none" id="uploadProgress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="uploadBtn" disabled>
                    <i class="bi bi-upload me-2"></i>Hochladen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit PDF Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>PDF bearbeiten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editBookId">
                <div class="mb-3">
                    <label for="editTitle" class="form-label">Titel</label>
                    <input type="text" class="form-control" id="editTitle" placeholder="Titel des PDFs">
                </div>
                <div class="mb-3">
                    <label for="editCategory" class="form-label">Kategorie</label>
                    <select class="form-select" id="editCategory">
                        <option value="book">Buch</option>
                        <option value="paper">Paper</option>
                        <option value="article">Artikel</option>
                        <option value="other">Sonstiges</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="editTags" class="form-label">Tags (kommagetrennt)</label>
                    <input type="text" class="form-control" id="editTags" placeholder="tag1, tag2, tag3">
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-danger" onclick="deleteBookFromModal()">
                        <i class="bi bi-trash me-1"></i>Löschen
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="editPrintBtn" onclick="printPdf()">
                        <i class="bi bi-printer me-1"></i>PDF Drucken
                    </button>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" onclick="saveBookEdit()">
                        <i class="bi bi-check-lg me-2"></i>Speichern
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Batch Upload Modal -->
<div class="modal fade" id="batchUploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-files me-2"></i>Mehrere PDFs hochladen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Drop Zone für mehrere Dateien -->
                <div class="border border-2 border-dashed rounded p-4 text-center mb-3" id="batchDropZone" style="cursor: pointer;">
                    <i class="bi bi-cloud-upload text-muted" style="font-size: 3rem;"></i>
                    <p class="mb-0 mt-2">PDFs hierher ziehen oder klicken zum Auswählen</p>
                    <input type="file" id="batchFileInput" accept=".pdf" multiple class="d-none">
                </div>
                
                <!-- Liste der ausgewählten PDFs -->
                <div id="batchFilesList" class="d-none">
                    <h6 class="mb-3"><i class="bi bi-list-ul me-2"></i>Ausgewählte PDFs (<span id="batchFilesCount">0</span>)</h6>
                    <div id="batchFilesContainer"></div>
                </div>
                
                <!-- Upload Progress -->
                <div class="progress d-none mt-3" id="batchUploadProgress" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="batchUploadBtn" disabled onclick="startBatchUpload()">
                    <i class="bi bi-upload me-2"></i>Alle hochladen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Online-Artikel Modal -->
<div class="modal fade" id="onlineArticleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-link-45deg me-2"></i>Online-Artikel hinzufügen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="onlineUrl" class="form-label">URL</label>
                    <input type="url" class="form-control" id="onlineUrl" placeholder="https://..." required>
                </div>
                <div class="mb-3">
                    <label for="onlineTitle" class="form-label">Titel</label>
                    <input type="text" class="form-control" id="onlineTitle" placeholder="Titel des Artikels">
                </div>
                <div class="mb-3">
                    <label for="onlineTags" class="form-label">Tags (kommagetrennt)</label>
                    <input type="text" class="form-control" id="onlineTags" placeholder="tag1, tag2, tag3">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="addOnlineArticle()">
                    <i class="bi bi-plus-lg me-2"></i>Hinzufügen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modern Confirmation Modal -->
<div class="confirm-modal-backdrop" id="confirmModal">
    <div class="confirm-modal">
        <div class="confirm-modal-icon danger" id="confirmModalIcon">
            <i class="bi bi-trash"></i>
        </div>
        <h3 class="confirm-modal-title" id="confirmModalTitle">Löschen bestätigen</h3>
        <p class="confirm-modal-message" id="confirmModalMessage">Möchtest du dieses Element wirklich löschen?</p>
        <div class="confirm-modal-buttons">
            <button class="btn-cancel" id="confirmModalCancel">Abbrechen</button>
            <button class="btn-confirm" id="confirmModalConfirm">Löschen</button>
        </div>
    </div>
</div>

<!-- Reading List Slide-Out Panel -->
<div class="reading-list-panel" id="readingListPanel">
    <div class="reading-list-header">
        <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Leseliste</h5>
        <button class="btn btn-sm btn-light" onclick="toggleReadingList()">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>

    <!-- Add New Item -->
    <div class="reading-list-add p-3 border-bottom">
        <div class="input-group mb-2">
            <input type="text" class="form-control form-control-sm" id="newItemTitle" placeholder="Neue Quelle/ToDo...">
            <button class="btn btn-warning btn-sm" onclick="addReadingListItem()">
                <i class="bi bi-plus"></i>
            </button>
        </div>
        <input type="text" class="form-control form-control-sm mb-2" id="newItemUrl" placeholder="URL (optional)">
        <textarea class="form-control form-control-sm" id="newItemNotes" rows="2" placeholder="Notizen (optional)"></textarea>
    </div>

    <!-- Filter -->
    <div class="reading-list-filter p-2 border-bottom bg-light">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="showCompletedItems" onchange="loadReadingList()">
            <label class="form-check-label small" for="showCompletedItems">Erledigte anzeigen</label>
        </div>
        <small class="text-muted" id="readingListStats"></small>
    </div>

    <!-- Items List -->
    <div class="reading-list-items" id="readingListItems">
        <!-- Items loaded via JS -->
    </div>
</div>

<!-- Reading List Panel Styles -->
<style>
.reading-list-panel {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 20px rgba(0,0,0,0.15);
    z-index: 2000;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
}
.reading-list-panel.open {
    right: 0;
}
.reading-list-header {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.reading-list-items {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}
.reading-list-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    border-left: 4px solid #f59e0b;
    transition: all 0.2s;
}
.reading-list-item.done {
    opacity: 0.6;
    border-left-color: #22c55e;
    background: #f0fdf4;
}
.reading-list-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.reading-list-item .item-title {
    font-weight: 500;
    margin-bottom: 4px;
    word-break: break-word;
}
.reading-list-item.done .item-title {
    text-decoration: line-through;
}
.reading-list-item .item-url {
    font-size: 0.8rem;
    color: #3b82f6;
    word-break: break-all;
}
.reading-list-item .item-notes {
    font-size: 0.85rem;
    color: #6b7280;
    margin-top: 4px;
}
.reading-list-item .item-actions {
    display: flex;
    gap: 5px;
    margin-top: 8px;
}
.reading-list-item .item-date {
    font-size: 0.75rem;
    color: #9ca3af;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
const csrfToken = '{{ csrf_token }}';

// ============================================================================
// Audio Settings (localStorage)
// ============================================================================

function getAudioVoice() {
    return document.getElementById('audioVoice')?.value || localStorage.getItem('ll_voice') || 'alloy';
}

function getAudioLanguage() {
    return document.getElementById('audioLanguage')?.value || localStorage.getItem('ll_lang') || 'de';
}

// Beim Laden: gespeicherte Werte setzen
(function initAudioSettings() {
    const voiceSelect = document.getElementById('audioVoice');
    const langSelect = document.getElementById('audioLanguage');
    const savedVoice = localStorage.getItem('ll_voice');
    const savedLang = localStorage.getItem('ll_lang');

    if (voiceSelect && savedVoice) voiceSelect.value = savedVoice;
    if (langSelect && savedLang) langSelect.value = savedLang;

    voiceSelect?.addEventListener('change', function() {
        localStorage.setItem('ll_voice', this.value);
        audioCache = {}; // Andere Stimme = neue Audios nötig
    });
    langSelect?.addEventListener('change', function() {
        localStorage.setItem('ll_lang', this.value);
        audioCache = {}; // Andere Sprache = neue Audios nötig
    });
})();

// Initialize Bootstrap tooltips for full title on hover
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Modern Confirmation Modal
function showConfirmModal(options = {}) {
    return new Promise((resolve) => {
        const modal = document.getElementById('confirmModal');
        const icon = document.getElementById('confirmModalIcon');
        const title = document.getElementById('confirmModalTitle');
        const message = document.getElementById('confirmModalMessage');
        const cancelBtn = document.getElementById('confirmModalCancel');
        const confirmBtn = document.getElementById('confirmModalConfirm');

        title.textContent = options.title || 'Bestätigen';
        message.textContent = options.message || 'Möchtest du fortfahren?';
        cancelBtn.textContent = options.cancelText || 'Abbrechen';
        confirmBtn.textContent = options.confirmText || 'Bestätigen';

        const type = options.type || 'danger';
        icon.className = `confirm-modal-icon ${type}`;
        const icons = { danger: 'bi-trash', warning: 'bi-exclamation-triangle' };
        icon.innerHTML = `<i class="bi ${icons[type] || icons.danger}"></i>`;

        modal.classList.add('show');

        const cleanup = () => {
            modal.classList.remove('show');
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            modal.onclick = null;
        };

        confirmBtn.onclick = () => { cleanup(); resolve(true); };
        cancelBtn.onclick = () => { cleanup(); resolve(false); };
        modal.onclick = (e) => { if (e.target === modal) { cleanup(); resolve(false); } };
    });
}

// Drag & Drop
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('pdfFile');
const uploadBtn = document.getElementById('uploadBtn');
const selectedFile = document.getElementById('selectedFile');
const fileName = document.getElementById('fileName');
const pdfTitle = document.getElementById('pdfTitle');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
    });
});

['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => dropZone.classList.add('border-primary'));
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => dropZone.classList.remove('border-primary'));
});

dropZone.addEventListener('drop', (e) => {
    const files = e.dataTransfer.files;
    if (files.length && files[0].name.toLowerCase().endsWith('.pdf')) {
        fileInput.files = files;
        handleFileSelect(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length) {
        handleFileSelect(e.target.files[0]);
    }
});

async function handleFileSelect(file) {
    fileName.textContent = file.name;
    selectedFile.classList.remove('d-none');
    uploadBtn.disabled = false;

    // Titel aus PDF-Metadaten extrahieren
    pdfTitle.value = 'Titel wird extrahiert...';
    pdfTitle.disabled = true;
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('{% url "learnloom:api_extract_title" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        });
        
        const data = await response.json();
        if (data.success && data.title) {
            pdfTitle.value = data.title;
        } else {
            // Fallback auf Dateinamen
            pdfTitle.value = file.name.replace('.pdf', '').replace(/_/g, ' ');
        }
    } catch (error) {
        console.error('Fehler beim Extrahieren des Titels:', error);
        // Fallback auf Dateinamen
        pdfTitle.value = file.name.replace('.pdf', '').replace(/_/g, ' ');
    } finally {
        pdfTitle.disabled = false;
    }
}

// Upload
uploadBtn.addEventListener('click', async () => {
    const formData = new FormData(document.getElementById('uploadForm'));
    const progressBar = document.getElementById('uploadProgress');
    const progressBarInner = progressBar.querySelector('.progress-bar');

    uploadBtn.disabled = true;
    progressBar.classList.remove('d-none');

    try {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '{% url "learnloom:api_upload" %}');
        xhr.setRequestHeader('X-CSRFToken', csrfToken);

        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const percent = (e.loaded / e.total) * 100;
                progressBarInner.style.width = percent + '%';
            }
        };

        xhr.onload = () => {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    window.location.reload();
                } else {
                    alert('Fehler: ' + response.error);
                    uploadBtn.disabled = false;
                    progressBar.classList.add('d-none');
                }
            } else {
                alert('Upload fehlgeschlagen');
                uploadBtn.disabled = false;
                progressBar.classList.add('d-none');
            }
        };

        xhr.send(formData);
    } catch (error) {
        alert('Fehler beim Upload: ' + error.message);
        uploadBtn.disabled = false;
        progressBar.classList.add('d-none');
    }
});

// Edit Book
function editBook(bookId, title, tags, category) {
    document.getElementById('editBookId').value = bookId;
    document.getElementById('editTitle').value = title;
    document.getElementById('editTags').value = tags;
    document.getElementById('editCategory').value = category;

    // PDF Drucken nur für nicht-online Artikel anzeigen
    const printBtn = document.getElementById('editPrintBtn');
    if (printBtn) {
        printBtn.style.display = (category === 'online') ? 'none' : '';
    }

    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
}

async function deleteBookFromModal() {
    const bookId = document.getElementById('editBookId').value;
    // Modal schließen
    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    // Bestätigung + Löschen über bestehende Funktion
    deleteBook(bookId);
}

function printPdf() {
    const bookId = document.getElementById('editBookId').value;
    // PDF in neuem Tab öffnen → Browser-Druckdialog
    const printWindow = window.open(`/learnloom/api/pdf/${bookId}/`, '_blank');
    if (printWindow) {
        printWindow.addEventListener('load', () => {
            printWindow.print();
        });
    }
}

async function saveBookEdit() {
    const bookId = document.getElementById('editBookId').value;
    const title = document.getElementById('editTitle').value.trim();
    const tags = document.getElementById('editTags').value.trim();
    const category = document.getElementById('editCategory').value;
    
    if (!title) {
        alert('Bitte gib einen Titel ein.');
        return;
    }
    
    try {
        const response = await fetch(`/learnloom/api/pdf/${bookId}/metadata/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ title, tags, category })
        });
        
        const data = await response.json();
        if (data.success) {
            // Modal schließen
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            // Seite neu laden um Änderungen zu zeigen
            location.reload();
        } else {
            alert('Fehler beim Speichern: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (error) {
        console.error('Fehler:', error);
        alert('Fehler beim Speichern');
    }
}

// ============================================================================
// Batch Upload Functions
// ============================================================================

const batchDropZone = document.getElementById('batchDropZone');
const batchFileInput = document.getElementById('batchFileInput');
const batchFilesList = document.getElementById('batchFilesList');
const batchFilesContainer = document.getElementById('batchFilesContainer');
const batchFilesCount = document.getElementById('batchFilesCount');
const batchUploadBtn = document.getElementById('batchUploadBtn');

let batchFiles = [];

// Drop Zone Events
batchDropZone.addEventListener('click', () => batchFileInput.click());

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    batchDropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
    });
});

['dragenter', 'dragover'].forEach(eventName => {
    batchDropZone.addEventListener(eventName, () => batchDropZone.classList.add('border-primary', 'bg-light'));
});

['dragleave', 'drop'].forEach(eventName => {
    batchDropZone.addEventListener(eventName, () => batchDropZone.classList.remove('border-primary', 'bg-light'));
});

batchDropZone.addEventListener('drop', (e) => {
    const files = Array.from(e.dataTransfer.files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
    addBatchFiles(files);
});

batchFileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
    addBatchFiles(files);
});

async function addBatchFiles(files) {
    for (const file of files) {
        // Titel extrahieren
        const formData = new FormData();
        formData.append('file', file);
        
        let title = file.name.replace('.pdf', '').replace(/_/g, ' ');
        
        try {
            const response = await fetch('{% url "learnloom:api_extract_title" %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            });
            const data = await response.json();
            if (data.success && data.title) {
                title = data.title;
            }
        } catch (e) {
            console.error('Titel-Extraktion fehlgeschlagen:', e);
        }
        
        batchFiles.push({
            file: file,
            title: title,
            category: 'paper',
            tags: ''
        });
    }
    
    renderBatchFiles();
}

function renderBatchFiles() {
    if (batchFiles.length === 0) {
        batchFilesList.classList.add('d-none');
        batchUploadBtn.disabled = true;
        return;
    }
    
    batchFilesList.classList.remove('d-none');
    batchFilesCount.textContent = batchFiles.length;
    batchUploadBtn.disabled = false;
    
    batchFilesContainer.innerHTML = batchFiles.map((item, index) => `
        <div class="card mb-2">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <small class="text-muted"><i class="bi bi-file-pdf me-1"></i>${item.file.name}</small>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeBatchFile(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="row g-2">
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" 
                               value="${item.title}" 
                               onchange="updateBatchFile(${index}, 'title', this.value)"
                               placeholder="Titel">
                    </div>
                    <div class="col-6">
                        <select class="form-select form-select-sm" onchange="updateBatchFile(${index}, 'category', this.value)">
                            <option value="book" ${item.category === 'book' ? 'selected' : ''}>Buch</option>
                            <option value="paper" ${item.category === 'paper' ? 'selected' : ''}>Paper</option>
                            <option value="article" ${item.category === 'article' ? 'selected' : ''}>Artikel</option>
                            <option value="other" ${item.category === 'other' ? 'selected' : ''}>Sonstiges</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <input type="text" class="form-control form-control-sm" 
                               value="${item.tags}" 
                               onchange="updateBatchFile(${index}, 'tags', this.value)"
                               placeholder="Tags (kommagetrennt)">
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function updateBatchFile(index, field, value) {
    batchFiles[index][field] = value;
}

function removeBatchFile(index) {
    batchFiles.splice(index, 1);
    renderBatchFiles();
}

async function startBatchUpload() {
    const progressBar = document.getElementById('batchUploadProgress');
    const progressBarInner = progressBar.querySelector('.progress-bar');
    
    progressBar.classList.remove('d-none');
    batchUploadBtn.disabled = true;
    
    let uploaded = 0;
    const total = batchFiles.length;
    
    for (const item of batchFiles) {
        const formData = new FormData();
        formData.append('file', item.file);
        formData.append('title', item.title);
        formData.append('category', item.category);
        formData.append('tags', item.tags);
        
        try {
            await fetch('{% url "learnloom:api_upload" %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            });
        } catch (e) {
            console.error('Upload fehlgeschlagen:', item.file.name, e);
        }
        
        uploaded++;
        const percent = Math.round((uploaded / total) * 100);
        progressBarInner.style.width = percent + '%';
        progressBarInner.textContent = `${uploaded}/${total} (${percent}%)`;
    }
    
    // Fertig
    setTimeout(() => {
        bootstrap.Modal.getInstance(document.getElementById('batchUploadModal')).hide();
        location.reload();
    }, 500);
}

// Reset batch files when modal closes
document.getElementById('batchUploadModal').addEventListener('hidden.bs.modal', () => {
    batchFiles = [];
    batchFilesContainer.innerHTML = '';
    batchFilesList.classList.add('d-none');
    batchUploadBtn.disabled = true;
    document.getElementById('batchUploadProgress').classList.add('d-none');
});

// ============================================================================
// Online Article Functions
// ============================================================================

async function addOnlineArticle() {
    const url = document.getElementById('onlineUrl').value.trim();
    const title = document.getElementById('onlineTitle').value.trim();
    const tags = document.getElementById('onlineTags').value.trim();
    
    if (!url) {
        alert('Bitte gib eine URL ein.');
        return;
    }
    
    if (!title) {
        alert('Bitte gib einen Titel ein.');
        return;
    }
    
    try {
        const response = await fetch('{% url "learnloom:api_add_online" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ url, title, tags })
        });
        
        const data = await response.json();
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('onlineArticleModal')).hide();
            location.reload();
        } else {
            alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (error) {
        console.error('Fehler:', error);
        alert('Fehler beim Hinzufügen');
    }
}

// Reset online article form when modal closes
document.getElementById('onlineArticleModal').addEventListener('hidden.bs.modal', () => {
    document.getElementById('onlineUrl').value = '';
    document.getElementById('onlineTitle').value = '';
    document.getElementById('onlineTags').value = '';
});

// Delete Book
async function deleteBook(bookId) {
    const confirmed = await showConfirmModal({
        type: 'danger',
        title: 'PDF löschen',
        message: 'Möchtest du dieses PDF wirklich löschen? Alle Notizen und Vokabeln werden ebenfalls gelöscht.',
        confirmText: 'Löschen',
        cancelText: 'Abbrechen'
    });

    if (!confirmed) return;

    try {
        const response = await fetch(`/learnloom/api/pdf/${bookId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            }
        });

        const data = await response.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (error) {
        alert('Fehler beim Löschen: ' + error.message);
    }
}

// Filter Books
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const filter = this.dataset.filter;
        
        // Update current status filter BEFORE applying
        currentStatusFilter = filter;

        // Update active button
        document.querySelectorAll('.filter-btn').forEach(b => {
            b.classList.remove('active', 'btn-primary', 'btn-secondary', 'btn-warning', 'btn-success');
            b.classList.add('btn-outline-secondary');
            if (b.dataset.filter === 'reading') b.classList.replace('btn-outline-secondary', 'btn-outline-warning');
            if (b.dataset.filter === 'completed') b.classList.replace('btn-outline-secondary', 'btn-outline-success');
        });
        this.classList.add('active');
        this.classList.remove('btn-outline-secondary', 'btn-outline-warning', 'btn-outline-success');
        if (filter === 'all' || filter === 'active') this.classList.add('btn-primary');
        else if (filter === 'reading') this.classList.add('btn-warning');
        else if (filter === 'completed') this.classList.add('btn-success');
        else this.classList.add('btn-secondary');

        // Filter books (respecting both status and tag filters)
        applyFilters();
    });
});

// Current filters state
let currentStatusFilter = 'active';
let currentTagFilter = 'all';

function applyFilters() {
    document.querySelectorAll('.book-col').forEach(col => {
        let statusMatch;
        if (currentStatusFilter === 'all') {
            statusMatch = true;
        } else if (currentStatusFilter === 'active') {
            statusMatch = col.dataset.status !== 'completed';
        } else {
            statusMatch = col.dataset.status === currentStatusFilter;
        }
        const tags = col.dataset.tags.toLowerCase();
        const tagMatch = currentTagFilter === 'all' || tags.includes(currentTagFilter.toLowerCase());

        if (statusMatch && tagMatch) {
            col.style.display = '';
        } else {
            col.style.display = 'none';
        }
    });
}

// Apply default filter on page load (hide completed)
applyFilters();

// Tag Filter
document.querySelectorAll('.tag-filter-item').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        const tag = this.dataset.tag;
        currentTagFilter = tag;
        
        // Update active state
        document.querySelectorAll('.tag-filter-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        
        // Show/hide active tag badge
        const badge = document.getElementById('activeTagBadge');
        const tagName = document.getElementById('activeTagName');
        if (tag === 'all') {
            badge.classList.add('d-none');
        } else {
            badge.classList.remove('d-none');
            tagName.textContent = tag;
        }
        
        applyFilters();
    });
});

// Click on tag badge in card to filter
document.querySelectorAll('.tag-badge').forEach(badge => {
    badge.addEventListener('click', function(e) {
        e.stopPropagation();
        const tag = this.dataset.tag;
        currentTagFilter = tag;
        
        // Update dropdown active state
        document.querySelectorAll('.tag-filter-item').forEach(i => {
            i.classList.remove('active');
            if (i.dataset.tag === tag) i.classList.add('active');
        });
        
        // Show active tag badge
        const activeBadge = document.getElementById('activeTagBadge');
        const tagName = document.getElementById('activeTagName');
        activeBadge.classList.remove('d-none');
        tagName.textContent = tag;
        
        applyFilters();
    });
});

function clearTagFilter() {
    currentTagFilter = 'all';
    document.getElementById('activeTagBadge').classList.add('d-none');
    document.querySelectorAll('.tag-filter-item').forEach(i => {
        i.classList.remove('active');
        if (i.dataset.tag === 'all') i.classList.add('active');
    });
    applyFilters();
}

// ============================================================================
// Reading List Functions
// ============================================================================

function toggleReadingList() {
    const panel = document.getElementById('readingListPanel');
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) {
        loadReadingList();
    }
}

async function loadReadingList() {
    const showCompleted = document.getElementById('showCompletedItems').checked;
    try {
        const response = await fetch(`/learnloom/api/reading-list/?show_completed=${showCompleted}`);
        const data = await response.json();

        if (data.success) {
            renderReadingList(data.items);
            document.getElementById('readingListStats').textContent =
                `${data.stats.todo} offen, ${data.stats.done} erledigt`;
        }
    } catch (error) {
        console.error('Error loading reading list:', error);
    }
}

function renderReadingList(items) {
    const container = document.getElementById('readingListItems');

    if (items.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                <p class="mt-2 mb-0">Keine Einträge</p>
            </div>
        `;
        return;
    }

    container.innerHTML = items.map(item => `
        <div class="reading-list-item ${item.status === 'done' ? 'done' : ''}" data-id="${item.id}">
            <div class="item-title">${escapeHtml(item.title)}</div>
            ${item.url ? `<a href="${escapeHtml(item.url)}" target="_blank" class="item-url"><i class="bi bi-link-45deg"></i>${escapeHtml(item.url)}</a>` : ''}
            ${item.notes ? `<div class="item-notes">${escapeHtml(item.notes)}</div>` : ''}
            <div class="item-date">${new Date(item.created_at).toLocaleDateString('de-DE')}</div>
            <div class="item-actions">
                ${item.status === 'todo'
                    ? `<button class="btn btn-success btn-sm" onclick="toggleItemStatus('${item.id}', 'done')" title="Als erledigt markieren">
                         <i class="bi bi-check-lg"></i>
                       </button>`
                    : `<button class="btn btn-warning btn-sm" onclick="toggleItemStatus('${item.id}', 'todo')" title="Wieder öffnen">
                         <i class="bi bi-arrow-counterclockwise"></i>
                       </button>`
                }
                <button class="btn btn-outline-danger btn-sm" onclick="deleteReadingListItem('${item.id}')" title="Löschen">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function addReadingListItem() {
    const title = document.getElementById('newItemTitle').value.trim();
    const url = document.getElementById('newItemUrl').value.trim();
    const notes = document.getElementById('newItemNotes').value.trim();

    if (!title) {
        alert('Bitte einen Titel eingeben');
        return;
    }

    try {
        const response = await fetch('/learnloom/api/reading-list/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ title, url, notes })
        });

        const data = await response.json();
        if (data.success) {
            document.getElementById('newItemTitle').value = '';
            document.getElementById('newItemUrl').value = '';
            document.getElementById('newItemNotes').value = '';
            loadReadingList();
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (error) {
        alert('Fehler beim Hinzufügen: ' + error.message);
    }
}

async function toggleItemStatus(itemId, newStatus) {
    try {
        const response = await fetch(`/learnloom/api/reading-list/${itemId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ status: newStatus })
        });

        const data = await response.json();
        if (data.success) {
            loadReadingList();
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (error) {
        alert('Fehler beim Aktualisieren: ' + error.message);
    }
}

async function deleteReadingListItem(itemId) {
    const confirmed = await showConfirmModal({
        type: 'danger',
        title: 'Eintrag löschen',
        message: 'Möchtest du diesen Eintrag wirklich löschen?',
        confirmText: 'Löschen',
        cancelText: 'Abbrechen'
    });

    if (!confirmed) return;

    try {
        const response = await fetch(`/learnloom/api/reading-list/${itemId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            }
        });

        const data = await response.json();
        if (data.success) {
            loadReadingList();
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (error) {
        alert('Fehler beim Löschen: ' + error.message);
    }
}

// ============================================================================
// Audio Player Functions
// ============================================================================

const audioPlayer = document.getElementById('globalAudioPlayer');
let currentAudioBookId = null;
let currentSectionIndex = 0;
let totalSections = 0;
let isAudioPlaying = false;
// Cache: bookId -> { total: N, sections: { 0: {url, ...}, 1: {url, ...}, ... } }
let audioCache = {};
// Track background generation: bookId -> AbortController
let bgGenerationControllers = {};

function getAudioBtn(bookId) {
    return document.querySelector(`.audio-play-btn[data-book-id="${bookId}"]`);
}

function getAudioControls(bookId) {
    return document.querySelector(`.audio-controls[data-book-id="${bookId}"]`);
}

function setAudioBtnState(bookId, state) {
    const btn = getAudioBtn(bookId);
    if (!btn) return;

    const icon = btn.querySelector('i');
    btn.classList.remove('playing', 'loading');

    if (state === 'playing') {
        icon.className = 'bi bi-pause-fill';
        btn.classList.add('playing');
    } else if (state === 'loading') {
        icon.className = 'bi bi-hourglass-split';
        btn.classList.add('loading');
    } else {
        icon.className = 'bi bi-play-fill';
    }
}

function showNavButtons(bookId, show) {
    const controls = getAudioControls(bookId);
    if (!controls) return;
    controls.classList.toggle('active', show);
}

function resetAllAudioBtns() {
    document.querySelectorAll('.audio-play-btn').forEach(btn => {
        btn.querySelector('i').className = 'bi bi-play-fill';
        btn.classList.remove('playing', 'loading');
    });
    document.querySelectorAll('.audio-controls').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.audio-progress-bar').forEach(p => p.remove());
}

// Einzelnen Abschnitt generieren (oder aus Cache holen)
async function generateSingleSection(bookId, sectionIndex, voice) {
    voice = voice || getAudioVoice();
    const response = await fetch(`/learnloom/api/audio/${bookId}/generate/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ audio_type: 'section', section_index: sectionIndex, voice })
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error);
    return data.audio;
}

// Restliche Abschnitte im Hintergrund generieren
async function generateRemainingInBackground(bookId, startIndex, voice) {
    voice = voice || getAudioVoice();
    const cache = audioCache[bookId];
    if (!cache) return;

    // AbortController für Abbruch bei Buchwechsel
    const controller = new AbortController();
    bgGenerationControllers[bookId] = controller;

    for (let i = startIndex; i < cache.total; i++) {
        // Abbruch prüfen
        if (controller.signal.aborted) return;
        // Schon im Cache? Überspringen
        if (cache.sections[i]) continue;

        try {
            const audio = await generateSingleSection(bookId, i, voice);
            if (controller.signal.aborted) return;
            cache.sections[i] = audio;
        } catch (e) {
            console.error(`Hintergrund-Audio Abschnitt ${i} fehlgeschlagen:`, e);
        }
    }

    delete bgGenerationControllers[bookId];
}

async function playBookAudio(bookId) {
    // Wenn gerade dieses Buch spielt: Pause/Resume
    if (currentAudioBookId === bookId && isAudioPlaying) {
        audioPlayer.pause();
        isAudioPlaying = false;
        setAudioBtnState(bookId, 'idle');
        return;
    }

    if (currentAudioBookId === bookId && !isAudioPlaying && audioPlayer.src) {
        audioPlayer.play();
        isAudioPlaying = true;
        setAudioBtnState(bookId, 'playing');
        return;
    }

    // Neues Buch: Altes stoppen + Hintergrund-Generierung abbrechen
    if (currentAudioBookId && currentAudioBookId !== bookId) {
        audioPlayer.pause();
        audioPlayer.src = '';
        if (bgGenerationControllers[currentAudioBookId]) {
            bgGenerationControllers[currentAudioBookId].abort();
        }
        showNavButtons(currentAudioBookId, false);
        resetAllAudioBtns();
    }

    currentAudioBookId = bookId;
    currentSectionIndex = 0;
    setAudioBtnState(bookId, 'loading');

    const voice = getAudioVoice();

    try {
        // Im JS-Cache mit richtiger Stimme? Sofort abspielen
        if (audioCache[bookId] && audioCache[bookId].sections[0] && audioCache[bookId].voice === voice) {
            totalSections = audioCache[bookId].total;
            showNavButtons(bookId, true);
            setupProgressBar(bookId);
            playSection(bookId, 0);
            generateRemainingInBackground(bookId, 1, voice);
            return;
        }

        // Status + Abschnitt 0 PARALLEL starten
        const [statusData, firstAudioGenerated] = await Promise.allSettled([
            fetch(`/learnloom/api/audio/${bookId}/status/`).then(r => r.json()),
            generateSingleSection(bookId, 0, voice),
        ]);

        // Cache initialisieren
        const statusOk = statusData.status === 'fulfilled' && statusData.value.success;
        const total = statusOk ? statusData.value.total_sections : 1;
        audioCache[bookId] = { total, sections: {}, voice };
        totalSections = total;

        // Server-gecachte Audio-Dateien übernehmen (gleiche Stimme)
        if (statusOk) {
            for (const af of statusData.value.audio_files) {
                if (af.audio_type === 'section' && af.section_index !== null && af.voice === voice) {
                    audioCache[bookId].sections[af.section_index] = af;
                }
            }
        }

        // Abschnitt 0: generiertes Audio übernehmen (überschreibt ggf. Server-Cache)
        if (firstAudioGenerated.status === 'fulfilled') {
            audioCache[bookId].sections[0] = firstAudioGenerated.value;
        }

        // Haben wir Abschnitt 0?
        if (!audioCache[bookId].sections[0]) {
            throw new Error('Abschnitt 0 konnte nicht geladen werden');
        }

        // Sofort abspielen!
        showNavButtons(bookId, true);
        setupProgressBar(bookId);
        playSection(bookId, 0);

        // Sofort Abschnitt 1 im Hintergrund starten (ohne Verzögerung)
        generateRemainingInBackground(bookId, 1, voice);

    } catch (error) {
        console.error('Audio-Fehler:', error);
        alert('Audio-Fehler: ' + error.message);
        setAudioBtnState(bookId, 'idle');
        currentAudioBookId = null;
    }
}

function setupProgressBar(bookId) {
    const thumb = getAudioBtn(bookId)?.closest('.book-thumbnail');
    if (thumb && !thumb.querySelector('.audio-progress-bar')) {
        const bar = document.createElement('div');
        bar.className = 'audio-progress-bar';
        bar.innerHTML = '<div class="audio-progress-fill"></div>';
        thumb.appendChild(bar);
    }
}

async function playSection(bookId, sectionIndex) {
    const cache = audioCache[bookId];
    if (!cache || sectionIndex < 0 || sectionIndex >= cache.total) {
        // Fertig oder ungültiger Index
        isAudioPlaying = false;
        setAudioBtnState(bookId, 'idle');
        showNavButtons(bookId, false);
        currentAudioBookId = null;
        currentSectionIndex = 0;
        return;
    }

    currentSectionIndex = sectionIndex;
    updateProgressBar(bookId, sectionIndex, cache.total);

    // Falls Abschnitt noch nicht im Cache: generieren und warten
    if (!cache.sections[sectionIndex]) {
        setAudioBtnState(bookId, 'loading');
        try {
            const audio = await generateSingleSection(bookId, sectionIndex);
            cache.sections[sectionIndex] = audio;
        } catch (e) {
            console.error(`Audio-Fehler Abschnitt ${sectionIndex}:`, e);
            // Nächsten Abschnitt versuchen
            if (sectionIndex + 1 < cache.total) {
                playSection(bookId, sectionIndex + 1);
            } else {
                isAudioPlaying = false;
                setAudioBtnState(bookId, 'idle');
                showNavButtons(bookId, false);
                currentAudioBookId = null;
            }
            return;
        }
    }

    audioPlayer.src = cache.sections[sectionIndex].url;
    audioPlayer.play();
    isAudioPlaying = true;
    setAudioBtnState(bookId, 'playing');

    // Media Session API - Lockscreen/Notification Controls
    updateMediaSession(bookId, sectionIndex, cache.total);

    audioPlayer.onended = () => {
        if (sectionIndex + 1 < cache.total) {
            playSection(bookId, sectionIndex + 1);
        } else {
            isAudioPlaying = false;
            setAudioBtnState(bookId, 'idle');
            showNavButtons(bookId, false);
            currentAudioBookId = null;
            currentSectionIndex = 0;
        }
    };
}

function updateMediaSession(bookId, sectionIndex, total) {
    if (!('mediaSession' in navigator)) return;

    // Buchtitel aus der Card holen
    const card = document.querySelector(`.book-card[data-book-id="${bookId}"]`);
    const title = card?.querySelector('.card-title')?.textContent?.trim() || 'LearnLoom Audio';

    navigator.mediaSession.metadata = new MediaMetadata({
        title: `${title} - Abschnitt ${sectionIndex + 1}/${total}`,
        artist: 'LearnLoom',
        album: title,
    });

    // Vorheriger Abschnitt
    navigator.mediaSession.setActionHandler('previoustrack', () => {
        if (currentAudioBookId && currentSectionIndex > 0) {
            playSection(currentAudioBookId, currentSectionIndex - 1);
        }
    });

    // Nächster Abschnitt
    navigator.mediaSession.setActionHandler('nexttrack', () => {
        if (currentAudioBookId && audioCache[currentAudioBookId] &&
            currentSectionIndex + 1 < audioCache[currentAudioBookId].total) {
            playSection(currentAudioBookId, currentSectionIndex + 1);
        }
    });

    // Play/Pause
    navigator.mediaSession.setActionHandler('play', () => {
        audioPlayer.play();
        isAudioPlaying = true;
        if (currentAudioBookId) setAudioBtnState(currentAudioBookId, 'playing');
    });

    navigator.mediaSession.setActionHandler('pause', () => {
        audioPlayer.pause();
        isAudioPlaying = false;
        if (currentAudioBookId) setAudioBtnState(currentAudioBookId, 'idle');
    });
}

function prevSection(bookId) {
    if (currentAudioBookId !== bookId || !audioCache[bookId]) return;
    const newIndex = Math.max(0, currentSectionIndex - 1);
    playSection(bookId, newIndex);
}

function nextSection(bookId) {
    if (currentAudioBookId !== bookId || !audioCache[bookId]) return;
    const newIndex = currentSectionIndex + 1;
    if (newIndex < audioCache[bookId].total) {
        playSection(bookId, newIndex);
    }
}

function updateProgressBar(bookId, current, total) {
    const thumb = getAudioBtn(bookId)?.closest('.book-thumbnail');
    const fill = thumb?.querySelector('.audio-progress-fill');
    if (fill) {
        const percent = total > 0 ? ((current + 1) / total) * 100 : 0;
        fill.style.width = percent + '%';
    }
}

// ============================================================================
// Relevance Functions
// ============================================================================

function toggleRelevanceDropdown(bookId) {
    // Alle anderen Dropdowns schließen
    document.querySelectorAll('.relevance-dropdown.show').forEach(dd => {
        if (dd.dataset.bookId !== bookId) dd.classList.remove('show');
    });
    const dropdown = document.querySelector(`.relevance-dropdown[data-book-id="${bookId}"]`);
    if (dropdown) dropdown.classList.toggle('show');
}

// Klick außerhalb schließt Dropdown
document.addEventListener('click', function(e) {
    if (!e.target.closest('.relevance-badge') && !e.target.closest('.relevance-dropdown')) {
        document.querySelectorAll('.relevance-dropdown.show').forEach(dd => dd.classList.remove('show'));
    }
});

async function setRelevance(bookId, value) {
    // Dropdown schließen
    document.querySelectorAll('.relevance-dropdown.show').forEach(dd => dd.classList.remove('show'));

    try {
        const response = await fetch(`/learnloom/api/pdf/${bookId}/metadata/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ relevance: value })
        });

        const data = await response.json();
        if (data.success) {
            // Badge aktualisieren
            const badge = document.querySelector(`.relevance-badge[data-book-id="${bookId}"]`);
            if (badge) {
                badge.dataset.relevance = value;
                badge.textContent = value === 0 ? '\u2014' : value;
                badge.className = 'relevance-badge position-absolute';
                if (value === 0) badge.classList.add('relevance-none');
                else if (value <= 3) badge.classList.add('relevance-low');
                else if (value <= 6) badge.classList.add('relevance-mid');
                else badge.classList.add('relevance-high');
                badge.title = value === 0 ? 'Relevanz: nicht bewertet' : `Relevanz: ${value}/10`;
            }

            // Dropdown active-State aktualisieren
            const dropdown = document.querySelector(`.relevance-dropdown[data-book-id="${bookId}"]`);
            if (dropdown) {
                dropdown.querySelectorAll('.relevance-option').forEach(opt => opt.classList.remove('active'));
                if (value > 0) {
                    const activeOpt = dropdown.querySelectorAll('.relevance-option')[value]; // Index 0 = clear, 1-10 = values
                    if (activeOpt) activeOpt.classList.add('active');
                }
            }
        }
    } catch (error) {
        console.error('Fehler beim Setzen der Relevanz:', error);
    }
}

// ============================================================================
// Reading Status Functions
// ============================================================================

// Set Reading Status
async function setReadingStatus(bookId, status) {
    try {
        const response = await fetch(`/learnloom/api/pdf/${bookId}/reading-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ status: status })
        });

        const data = await response.json();
        if (data.success) {
            // Update badge
            const badge = document.querySelector(`.reading-status-badge[data-book-id="${bookId}"]`);
            if (badge) {
                badge.dataset.status = status;
                badge.className = 'badge reading-status-badge position-absolute top-0 start-0 m-2';

                if (status === 'completed') {
                    badge.classList.add('bg-success');
                    badge.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Gelesen';
                } else if (status === 'reading') {
                    badge.classList.add('bg-warning', 'text-dark');
                    badge.innerHTML = '<i class="bi bi-book-half me-1"></i>Dabei';
                } else {
                    badge.classList.add('bg-secondary');
                    badge.innerHTML = '<i class="bi bi-circle me-1"></i>Neu';
                }
            }

            // Update dropdown active state
            const card = document.querySelector(`.book-card[data-book-id="${bookId}"]`);
            if (card) {
                card.querySelectorAll('.dropdown-item').forEach(item => {
                    item.classList.remove('active');
                });
                const activeItem = card.querySelector(`.dropdown-item[onclick*="'${status}'"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }

                // Update data-status on parent col for filtering
                const col = card.closest('.book-col');
                if (col) {
                    col.dataset.status = status;
                }

                // Bei "completed": Relevanz-Bewertung automatisch einblenden
                if (status === 'completed') {
                    setTimeout(() => toggleRelevanceDropdown(bookId), 300);
                }
            }
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (error) {
        alert('Fehler beim Aktualisieren: ' + error.message);
    }
}

// ============================================================================
// Voice Question Mode (Sprach-Fragen während Audio-Wiedergabe)
// ============================================================================

const answerPlayer = document.getElementById('answerAudioPlayer');
let voiceQuestionActive = false;
let speechRecognition = null;
let vqState = 'IDLE'; // IDLE, ASKING, PROCESSING, ANSWERING

// Floating-Button ein-/ausblenden wenn Audio läuft
function updateVoiceQuestionButton() {
    const fab = document.getElementById('voiceQuestionBtn');
    if (!fab) return;
    // Nur anzeigen wenn Audio läuft UND SpeechRecognition verfügbar
    const hasSpeech = ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window);
    fab.style.display = (isAudioPlaying && currentAudioBookId && hasSpeech) ? 'flex' : 'none';
    // Im Frage-Modus: andere Darstellung
    if (voiceQuestionActive) {
        fab.classList.add('active');
    } else {
        fab.classList.remove('active');
    }
}

// SpeechRecognition initialisieren
function initSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return null;

    const recognition = new SpeechRecognition();
    const lang = getAudioLanguage();
    recognition.lang = lang === 'en' ? 'en-US' : 'de-DE';
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        handleVoiceResult(transcript);
    };

    recognition.onerror = (event) => {
        console.warn('SpeechRecognition Fehler:', event.error);
        if (event.error === 'no-speech' && voiceQuestionActive) {
            // Kein Spracheingabe erkannt - erneut zuhören
            startListening();
        } else if (event.error !== 'aborted') {
            showVqState('listening');
            startListening();
        }
    };

    recognition.onend = () => {
        // Nur neu starten wenn wir im ASKING-Status sind
        if (vqState === 'ASKING' && voiceQuestionActive) {
            startListening();
        }
    };

    return recognition;
}

function toggleVoiceQuestion() {
    if (voiceQuestionActive) {
        stopVoiceQuestion();
    } else {
        startVoiceQuestion();
    }
}

function startVoiceQuestion() {
    if (!currentAudioBookId) return;

    voiceQuestionActive = true;
    vqState = 'ASKING';

    // Audio pausieren
    audioPlayer.pause();
    isAudioPlaying = false;
    setAudioBtnState(currentAudioBookId, 'idle');

    // UI zeigen
    document.getElementById('voiceQuestionOverlay').style.display = 'flex';
    showVqState('listening');
    updateVoiceQuestionButton();

    // SpeechRecognition starten
    speechRecognition = initSpeechRecognition();
    if (speechRecognition) {
        startListening();
    }
}

function startListening() {
    if (!speechRecognition || !voiceQuestionActive) return;
    try {
        speechRecognition.start();
    } catch (e) {
        // Bereits gestartet - ignorieren
    }
}

function stopVoiceQuestion() {
    voiceQuestionActive = false;
    vqState = 'IDLE';

    // SpeechRecognition stoppen
    if (speechRecognition) {
        try { speechRecognition.abort(); } catch (e) {}
        speechRecognition = null;
    }

    // Antwort-Audio stoppen
    answerPlayer.pause();
    answerPlayer.src = '';

    // Overlay ausblenden
    document.getElementById('voiceQuestionOverlay').style.display = 'none';
    updateVoiceQuestionButton();

    // Haupt-Audio fortsetzen
    if (currentAudioBookId && audioPlayer.src) {
        audioPlayer.play();
        isAudioPlaying = true;
        setAudioBtnState(currentAudioBookId, 'playing');
        updateVoiceQuestionButton();
    }
}

function handleVoiceResult(transcript) {
    if (!transcript) {
        startListening();
        return;
    }

    const lower = transcript.toLowerCase();
    // Befehle zum Fortsetzen erkennen
    const resumeCommands = ['play', 'abspielen', 'weiter', 'fortsetzen', 'continue', 'resume', 'stopp', 'stop', 'schließen'];
    if (resumeCommands.some(cmd => lower.includes(cmd))) {
        stopVoiceQuestion();
        return;
    }

    // Frage an API senden
    sendVoiceQuestion(transcript);
}

async function sendVoiceQuestion(question) {
    vqState = 'PROCESSING';
    showVqState('processing', question);

    // SpeechRecognition während der Verarbeitung stoppen
    if (speechRecognition) {
        try { speechRecognition.abort(); } catch (e) {}
    }

    try {
        const voice = getAudioVoice();
        const response = await fetch(`/learnloom/api/pdf/${currentAudioBookId}/chat-audio/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ question, voice })
        });

        const data = await response.json();
        if (!data.success) {
            throw new Error(data.error || 'Unbekannter Fehler');
        }

        // Antwort als Audio abspielen
        vqState = 'ANSWERING';
        showVqState('answering', data.answer_text);

        answerPlayer.src = data.audio_url;
        answerPlayer.play();

        answerPlayer.onended = () => {
            if (!voiceQuestionActive) return;
            // Nach Antwort: wieder zuhören
            vqState = 'ASKING';
            showVqState('listening');
            speechRecognition = initSpeechRecognition();
            startListening();
        };

    } catch (error) {
        console.error('Chat-Audio Fehler:', error);
        // Bei Fehler: wieder zuhören
        vqState = 'ASKING';
        showVqState('listening');
        speechRecognition = initSpeechRecognition();
        startListening();
    }
}

function showVqState(state, text) {
    document.getElementById('vqListening').style.display = state === 'listening' ? 'block' : 'none';
    document.getElementById('vqProcessing').style.display = state === 'processing' ? 'block' : 'none';
    document.getElementById('vqAnswering').style.display = state === 'answering' ? 'block' : 'none';

    if (state === 'processing' && text) {
        document.getElementById('vqTranscript').textContent = `"${text}"`;
    }
    if (state === 'answering' && text) {
        // Antwort kürzen wenn zu lang
        const short = text.length > 200 ? text.substring(0, 200) + '...' : text;
        document.getElementById('vqAnswerText').textContent = short;
    }
}

// Floating-Button bei Audio-Events aktualisieren
const _origSetAudioBtnState = typeof setAudioBtnState === 'function' ? setAudioBtnState : null;
if (_origSetAudioBtnState) {
    const _wrappedSetAudioBtnState = setAudioBtnState;
    setAudioBtnState = function(bookId, state) {
        _wrappedSetAudioBtnState(bookId, state);
        setTimeout(updateVoiceQuestionButton, 50);
    };
}

// Initial prüfen
document.addEventListener('DOMContentLoaded', updateVoiceQuestionButton);
</script>
{% endblock %}
