{% extends "base.html" %}
{% load static %}

{% block title %}Bild bearbeiten - {{ image.unique_id }}{% endblock %}

{% block extra_css %}
<style>
.editor-container {
    max-width: 1600px;
    margin: 0 auto;
}

.canvas-container {
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
}

canvas {
    max-width: 100%;
    max-height: 600px;
    border: 1px solid #adb5bd;
    background: white;
    cursor: crosshair;
}

.control-panel {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.control-group {
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e9ecef;
}

.control-group:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.control-group h5 {
    margin-bottom: 1rem;
    color: #495057;
    font-weight: 600;
}

.slider-container {
    margin-bottom: 1rem;
}

.slider-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #6c757d;
}

.slider-value {
    color: #0d6efd;
    font-weight: 600;
}

input[type="range"] {
    width: 100%;
}

.btn-group-custom {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.loading-overlay.active {
    display: flex;
}

.loading-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

.alert-floating {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    min-width: 300px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.processing-info {
    background: #e7f3ff;
    border: 1px solid #b3d7ff;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.processing-info h6 {
    margin: 0 0 0.5rem 0;
    color: #004085;
}

.processing-info ul {
    margin: 0;
    padding-left: 1.5rem;
    font-size: 0.9rem;
    color: #004085;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 editor-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{% url 'shopify_uploads:image_detail' image.unique_id %}" class="btn btn-outline-secondary mb-2">
                <i class="bi bi-arrow-left"></i> Zurück
            </a>
            <h1>
                <i class="bi bi-brush"></i> Bildeditor - {{ image.unique_id }}
            </h1>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i>
        <strong>Fehler:</strong> {{ error }}
    </div>
    {% else %}

    <!-- Info-Box -->
    <div class="processing-info">
        <h6><i class="bi bi-info-circle"></i> Anleitung:</h6>
        <ul>
            <li>Verwenden Sie die Regler und Buttons, um das Bild anzupassen</li>
            <li>Das Original wird links angezeigt, die Vorschau rechts</li>
            <li>Für beste Laser-Gravur-Ergebnisse: Zu Graustufen konvertieren, dann Dithering anwenden</li>
            <li>Klicken Sie auf "Speichern", um die Änderungen zu übernehmen</li>
        </ul>
    </div>

    <div class="row">
        <!-- Linke Spalte: Original -->
        <div class="col-lg-6 mb-4">
            <div class="canvas-container">
                <div>
                    <h5 class="mb-3">Original</h5>
                    <canvas id="originalCanvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Rechte Spalte: Bearbeitet -->
        <div class="col-lg-6 mb-4">
            <div class="canvas-container">
                <div>
                    <h5 class="mb-3">Vorschau (bearbeitet)</h5>
                    <canvas id="processedCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <div class="row">
            <!-- Basisanpassungen -->
            <div class="col-md-6">
                <div class="control-group">
                    <h5><i class="bi bi-sliders"></i> Basisanpassungen</h5>

                    <!-- Helligkeit -->
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Helligkeit:</span>
                            <span class="slider-value" id="brightnessValue">0</span>
                        </div>
                        <input type="range" class="form-range" id="brightnessSlider"
                               min="-100" max="100" value="0" step="1">
                    </div>

                    <!-- Kontrast -->
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Kontrast:</span>
                            <span class="slider-value" id="contrastValue">0</span>
                        </div>
                        <input type="range" class="form-range" id="contrastSlider"
                               min="-100" max="100" value="0" step="1">
                    </div>

                    <!-- S/W Schwellenwert -->
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>S/W Schwellenwert:</span>
                            <span class="slider-value" id="thresholdValue">127</span>
                        </div>
                        <input type="range" class="form-range" id="thresholdSlider"
                               min="0" max="255" value="127" step="1">
                        <small class="text-muted">
                            Wird bei "S/W-Schwellenwert" und "Dithering" verwendet
                        </small>
                    </div>
                </div>
            </div>

            <!-- Erweiterte Operationen -->
            <div class="col-md-6">
                <div class="control-group">
                    <h5><i class="bi bi-gear"></i> Erweiterte Operationen</h5>

                    <div class="btn-group-custom">
                        <button type="button" class="btn btn-outline-secondary" id="btnGrayscale">
                            <i class="bi bi-circle-half"></i> Zu Graustufen
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="btnInvert">
                            <i class="bi bi-brightness-high"></i> Invertieren
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="btnThreshold">
                            <i class="bi bi-image"></i> S/W-Schwellenwert
                        </button>
                        <button type="button" class="btn btn-primary" id="btnDithering">
                            <i class="bi bi-grid-3x3"></i> Dithering anwenden
                        </button>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Empfohlener Workflow für Laser-Gravur:</strong><br>
                            1. Helligkeit/Kontrast anpassen (Echtzeit-Vorschau)<br>
                            2. Optional: "Zu Graustufen" klicken<br>
                            3. S/W-Schwellenwert einstellen<br>
                            4. "Dithering anwenden" klicken (nutzt aktuelle Vorschau)<br>
                            5. "Speichern" klicken<br>
                            <em>Hinweis: Jeder Schritt baut auf dem vorherigen auf!</em>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Laser-Gravur Einstellungen -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="control-group">
                    <h5><i class="bi bi-rulers"></i> Laser-Gravur Einstellungen</h5>

                    <div class="row">
                        <!-- Zielgröße -->
                        <div class="col-md-4">
                            <label class="form-label">Ziel-Breite (mm)</label>
                            <input type="number" class="form-control" id="targetWidth"
                                   value="100" min="10" max="500" step="1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Ziel-Höhe (mm)</label>
                            <input type="number" class="form-control" id="targetHeight"
                                   value="100" min="10" max="500" step="1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Schrittweite (mm)</label>
                            <input type="number" class="form-control" id="stepSize"
                                   value="0.05" min="0.01" max="1.0" step="0.01">
                        </div>
                    </div>

                    <div class="row mt-2">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="keepAspectRatio" checked>
                                <label class="form-check-label" for="keepAspectRatio">
                                    Seitenverhältnis beibehalten
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">
                                Berechnete Auflösung: <strong id="calculatedResolution">2000 x 2000 px</strong>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aktionsbuttons -->
        <div class="control-group">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="button" class="btn btn-warning" id="btnReset">
                        <i class="bi bi-arrow-counterclockwise"></i> Zurücksetzen
                    </button>
                </div>
                <div>
                    <a href="{% url 'shopify_uploads:image_detail' image.unique_id %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x"></i> Abbrechen
                    </a>
                    <button type="button" class="btn btn-success" id="btnSave">
                        <i class="bi bi-save"></i> Speichern
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% endif %}
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mb-0">Verarbeite Bild...</p>
    </div>
</div>

<!-- Alert Container -->
<div id="alertContainer"></div>

{% endblock %}

{% block extra_js %}
<script>
// Global variables
let originalImageSource = null;  // Das wirklich unveränderte Original (wird NIE modifiziert)
let workingImage = null;         // Arbeitskopie für fortschreitende Bearbeitung
let currentImageData = null;
let currentSettings = {
    brightness: 0,
    contrast: 0,
    threshold: 127,
    targetWidth: 100,      // mm
    targetHeight: 100,     // mm
    stepSize: 0.05,        // mm
    keepAspectRatio: true
};

// Canvas elements
const originalCanvas = document.getElementById('originalCanvas');
const processedCanvas = document.getElementById('processedCanvas');
const originalCtx = originalCanvas.getContext('2d');
const processedCtx = processedCanvas.getContext('2d');

// CSRF Token
const csrfToken = '{{ csrf_token }}';

// Load original image
function loadOriginalImage() {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function() {
        // Set canvas size
        originalCanvas.width = img.width;
        originalCanvas.height = img.height;
        processedCanvas.width = img.width;
        processedCanvas.height = img.height;

        // Draw original (wird nur hier EINMAL gezeichnet)
        originalCtx.drawImage(img, 0, 0);

        // Initialize processed canvas
        processedCtx.drawImage(img, 0, 0);

        // Store UNVERÄNDERLICHE original image data
        originalImageSource = originalCtx.getImageData(0, 0, img.width, img.height);

        // Clone für Arbeitskopie
        workingImage = processedCtx.createImageData(img.width, img.height);
        workingImage.data.set(originalImageSource.data);

        currentImageData = processedCtx.getImageData(0, 0, img.width, img.height);
    };
    img.src = '{{ image.original_image.url }}';
}

// Client-side image processing functions
function applyBrightness(imageData, value) {
    const data = imageData.data;
    for (let i = 0; i < data.length; i += 4) {
        data[i] = Math.min(255, Math.max(0, data[i] + value));     // R
        data[i+1] = Math.min(255, Math.max(0, data[i+1] + value)); // G
        data[i+2] = Math.min(255, Math.max(0, data[i+2] + value)); // B
    }
    return imageData;
}

function applyContrast(imageData, value) {
    const data = imageData.data;
    const factor = (259 * (value + 255)) / (255 * (259 - value));

    for (let i = 0; i < data.length; i += 4) {
        data[i] = Math.min(255, Math.max(0, factor * (data[i] - 128) + 128));     // R
        data[i+1] = Math.min(255, Math.max(0, factor * (data[i+1] - 128) + 128)); // G
        data[i+2] = Math.min(255, Math.max(0, factor * (data[i+2] - 128) + 128)); // B
    }
    return imageData;
}

function applyThresholdClient(imageData, threshold) {
    const data = imageData.data;
    for (let i = 0; i < data.length; i += 4) {
        // Convert to grayscale first
        const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
        const value = gray > threshold ? 255 : 0;
        data[i] = data[i+1] = data[i+2] = value;
    }
    return imageData;
}

// Update preview with current settings
function updatePreview() {
    if (!workingImage) return;

    // Clone working image data (NICHT das Original!)
    const imageData = processedCtx.createImageData(workingImage.width, workingImage.height);
    imageData.data.set(workingImage.data);

    // Apply brightness
    if (currentSettings.brightness !== 0) {
        applyBrightness(imageData, currentSettings.brightness);
    }

    // Apply contrast
    if (currentSettings.contrast !== 0) {
        applyContrast(imageData, currentSettings.contrast);
    }

    // Update canvas
    processedCtx.putImageData(imageData, 0, 0);
    currentImageData = imageData;
}

// Laser-Gravur: Auflösung berechnen
function calculateTargetResolution() {
    const width = parseFloat(document.getElementById('targetWidth').value);
    const height = parseFloat(document.getElementById('targetHeight').value);
    const stepSize = parseFloat(document.getElementById('stepSize').value);

    if (stepSize <= 0) return { width: 0, height: 0 };

    const pixelWidth = Math.round(width / stepSize);
    const pixelHeight = Math.round(height / stepSize);

    return { width: pixelWidth, height: pixelHeight };
}

// Laser-Gravur: Anzeige aktualisieren
function updateResolutionDisplay() {
    const resolution = calculateTargetResolution();
    document.getElementById('calculatedResolution').textContent =
        `${resolution.width} x ${resolution.height} px`;

    // Settings aktualisieren
    currentSettings.targetWidth = parseFloat(document.getElementById('targetWidth').value);
    currentSettings.targetHeight = parseFloat(document.getElementById('targetHeight').value);
    currentSettings.stepSize = parseFloat(document.getElementById('stepSize').value);
    currentSettings.keepAspectRatio = document.getElementById('keepAspectRatio').checked;
}

// Laser-Gravur: Canvas auf Zielgröße skalieren
function scaleCanvasToTarget(sourceCanvas) {
    const targetResolution = calculateTargetResolution();

    // Erstelle neues Canvas mit Zielgröße
    const scaledCanvas = document.createElement('canvas');
    scaledCanvas.width = targetResolution.width;
    scaledCanvas.height = targetResolution.height;
    const ctx = scaledCanvas.getContext('2d');

    // Hochqualitative Skalierung
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';

    // Skaliere Bild
    ctx.drawImage(sourceCanvas, 0, 0, targetResolution.width, targetResolution.height);

    return scaledCanvas;
}

// Server-side operation
async function processOnServer(operation, params = {}) {
    showLoading(true);

    try {
        // Hole aktuelles Canvas-Bild als Base64
        const currentImageBase64 = processedCanvas.toDataURL('image/png');

        const response = await fetch('{% url "shopify_uploads:process_image_ajax" image.unique_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                operation: operation,
                current_image_data: currentImageBase64,  // Sende aktuelles Canvas-Bild
                ...params
            })
        });

        const data = await response.json();

        if (data.success) {
            // Load processed image
            const img = new Image();
            img.onload = function() {
                processedCtx.clearRect(0, 0, processedCanvas.width, processedCanvas.height);
                processedCtx.drawImage(img, 0, 0);
                currentImageData = processedCtx.getImageData(0, 0, processedCanvas.width, processedCanvas.height);

                // Update workingImage für fortschreitende Bearbeitung
                // WICHTIG: Original-Canvas wird NICHT verändert!
                workingImage.data.set(currentImageData.data);

                showAlert('success', data.message);
            };
            img.src = data.image;
        } else {
            showAlert('danger', 'Fehler: ' + data.error);
        }
    } catch (error) {
        showAlert('danger', 'Netzwerkfehler: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// Save processed image
async function saveImage() {
    showLoading(true);

    try {
        // Skaliere Canvas auf Zielgröße für Laser-Gravur
        const scaledCanvas = scaleCanvasToTarget(processedCanvas);

        // Get image data from scaled canvas
        const imageData = scaledCanvas.toDataURL('image/png');

        const targetResolution = calculateTargetResolution();

        showAlert('info', `Speichere Bild mit ${targetResolution.width}x${targetResolution.height}px für ${currentSettings.targetWidth}x${currentSettings.targetHeight}mm @ ${currentSettings.stepSize}mm Schrittweite...`);

        const response = await fetch('{% url "shopify_uploads:save_processed_image" image.unique_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                image_data: imageData,
                processing_settings: currentSettings
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('success', 'Bild erfolgreich gespeichert! (' + data.file_size_kb + ' KB)');
            setTimeout(() => {
                window.location.href = '{% url "shopify_uploads:image_detail" image.unique_id %}';
            }, 1500);
        } else {
            showAlert('danger', 'Fehler beim Speichern: ' + data.error);
        }
    } catch (error) {
        showAlert('danger', 'Netzwerkfehler: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// UI Helper functions
function showLoading(show) {
    document.getElementById('loadingOverlay').classList.toggle('active', show);
}

function showAlert(type, message) {
    const container = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show alert-floating`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    container.appendChild(alert);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Load image
    loadOriginalImage();

    // Laser-Gravur Einstellungen (früh deklarieren für Reset-Handler)
    const targetWidthInput = document.getElementById('targetWidth');
    const targetHeightInput = document.getElementById('targetHeight');
    const stepSizeInput = document.getElementById('stepSize');
    const keepAspectRatioCheckbox = document.getElementById('keepAspectRatio');

    // Brightness slider
    const brightnessSlider = document.getElementById('brightnessSlider');
    const brightnessValue = document.getElementById('brightnessValue');
    brightnessSlider.addEventListener('input', function() {
        currentSettings.brightness = parseInt(this.value);
        brightnessValue.textContent = this.value;
        updatePreview();
    });

    // Contrast slider
    const contrastSlider = document.getElementById('contrastSlider');
    const contrastValue = document.getElementById('contrastValue');
    contrastSlider.addEventListener('input', function() {
        currentSettings.contrast = parseInt(this.value);
        contrastValue.textContent = this.value;
        updatePreview();
    });

    // Threshold slider
    const thresholdSlider = document.getElementById('thresholdSlider');
    const thresholdValue = document.getElementById('thresholdValue');
    thresholdSlider.addEventListener('input', function() {
        currentSettings.threshold = parseInt(this.value);
        thresholdValue.textContent = this.value;
    });

    // Grayscale button
    document.getElementById('btnGrayscale').addEventListener('click', function() {
        processOnServer('grayscale');
    });

    // Invert button
    document.getElementById('btnInvert').addEventListener('click', function() {
        processOnServer('invert');
    });

    // Threshold button
    document.getElementById('btnThreshold').addEventListener('click', function() {
        processOnServer('threshold', { threshold: currentSettings.threshold });
    });

    // Dithering button
    document.getElementById('btnDithering').addEventListener('click', function() {
        processOnServer('dithering', {
            threshold: currentSettings.threshold,
            method: 'floyd-steinberg'
        });
    });

    // Reset button
    document.getElementById('btnReset').addEventListener('click', function() {
        // Reset sliders
        brightnessSlider.value = 0;
        contrastSlider.value = 0;
        thresholdSlider.value = 127;
        brightnessValue.textContent = '0';
        contrastValue.textContent = '0';
        thresholdValue.textContent = '127';

        // Reset Laser-Gravur Einstellungen
        targetWidthInput.value = 100;
        targetHeightInput.value = 100;
        stepSizeInput.value = 0.05;
        keepAspectRatioCheckbox.checked = true;

        // Reset settings
        currentSettings = {
            brightness: 0,
            contrast: 0,
            threshold: 127,
            targetWidth: 100,
            targetHeight: 100,
            stepSize: 0.05,
            keepAspectRatio: true
        };

        // Reload original image
        loadOriginalImage();

        // Update resolution display
        updateResolutionDisplay();

        showAlert('info', 'Bild zurückgesetzt');
    });

    // Laser-Gravur Einstellungen Event Listeners
    let lastAspectRatio = 1.0;

    // Initial Auflösung berechnen
    updateResolutionDisplay();

    // Seitenverhältnis bei Breiten-Änderung
    targetWidthInput.addEventListener('input', function() {
        if (keepAspectRatioCheckbox.checked) {
            const newHeight = Math.round(parseFloat(this.value) / lastAspectRatio);
            targetHeightInput.value = newHeight;
        } else {
            lastAspectRatio = parseFloat(targetWidthInput.value) / parseFloat(targetHeightInput.value);
        }
        updateResolutionDisplay();
    });

    // Seitenverhältnis bei Höhen-Änderung
    targetHeightInput.addEventListener('input', function() {
        if (keepAspectRatioCheckbox.checked) {
            const newWidth = Math.round(parseFloat(this.value) * lastAspectRatio);
            targetWidthInput.value = newWidth;
        } else {
            lastAspectRatio = parseFloat(targetWidthInput.value) / parseFloat(targetHeightInput.value);
        }
        updateResolutionDisplay();
    });

    // Schrittweite geändert
    stepSizeInput.addEventListener('input', function() {
        updateResolutionDisplay();
    });

    // Seitenverhältnis-Lock
    keepAspectRatioCheckbox.addEventListener('change', function() {
        if (this.checked) {
            lastAspectRatio = parseFloat(targetWidthInput.value) / parseFloat(targetHeightInput.value);
        }
        updateResolutionDisplay();
    });

    // Save button
    document.getElementById('btnSave').addEventListener('click', function() {
        if (confirm('Möchten Sie die Änderungen wirklich speichern?')) {
            saveImage();
        }
    });
});
</script>
{% endblock %}
