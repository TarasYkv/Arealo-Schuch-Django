{% extends 'shopify_manager/base.html' %}

{% block title %}{{ product.title }} - Shopify Manager{% endblock %}

{% block shopify_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ product.title }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'shopify_manager:product_edit' product.pk %}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Bearbeiten
            </a>
            <a href="{% url 'shopify_manager:product_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-list"></i> Zur Liste
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8{% if product.status == 'archived' %} opacity-50{% endif %}">
        <!-- Produktinformationen -->
        <div class="card mb-4{% if product.status == 'archived' %} border-secondary{% endif %}">
            <div class="card-header">
                <h5 class="mb-0">Produktinformationen</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Titel:</dt>
                            <dd class="col-sm-8">{{ product.title }}</dd>
                            
                            <dt class="col-sm-4">Handle:</dt>
                            <dd class="col-sm-8">{{ product.handle|default:"—" }}</dd>
                            
                            <dt class="col-sm-4">Vendor:</dt>
                            <dd class="col-sm-8">{{ product.vendor|default:"—" }}</dd>
                            
                            <dt class="col-sm-4">Produkttyp:</dt>
                            <dd class="col-sm-8">{{ product.product_type|default:"—" }}</dd>
                            
                            <dt class="col-sm-4">Status:</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-{% if product.status == 'active' %}success{% elif product.status == 'draft' %}warning{% elif product.status == 'archived' %}dark{% else %}secondary{% endif %}">
                                    {% if product.status == 'archived' %}
                                        ✅ Erledigt (Ausgegraut)
                                    {% else %}
                                        {{ product.get_status_display }}
                                    {% endif %}
                                </span>
                            </dd>
                        </dl>
                    </div>
                    
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Preis:</dt>
                            <dd class="col-sm-8">
                                {% if product.price %}
                                    €{{ product.price }}
                                    {% if product.compare_at_price %}
                                        <small class="text-muted"><s>€{{ product.compare_at_price }}</s></small>
                                    {% endif %}
                                {% else %}
                                    —
                                {% endif %}
                            </dd>
                            
                            <dt class="col-sm-4">Store:</dt>
                            <dd class="col-sm-8">{{ product.store.name }}</dd>
                            
                            <dt class="col-sm-4">Shopify ID:</dt>
                            <dd class="col-sm-8">{{ product.shopify_id }}</dd>
                            
                            <dt class="col-sm-4">Tags:</dt>
                            <dd class="col-sm-8">
                                {% if product.tags %}
                                    {% for tag in product.get_tags_list %}
                                        <span class="badge bg-light text-dark me-1">{{ tag }}</span>
                                    {% endfor %}
                                {% else %}
                                    —
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>
                
                {% if product.body_html %}
                <div class="mt-3">
                    <h6>Beschreibung:</h6>
                    <div class="border rounded p-3 bg-light">
                        {{ product.body_html|safe }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- SEO-Informationen -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">SEO-Informationen</h5>
                <div>
                    {% with issues=product.has_seo_issues %}
                        {% if issues.missing_seo_title or issues.missing_seo_description %}
                            <span class="badge bg-warning">SEO unvollständig</span>
                        {% else %}
                            <span class="badge bg-success">SEO OK</span>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label"><strong>SEO Titel:</strong></label>
                        <div class="form-control-plaintext border rounded p-2 bg-light">
                            {% if product.seo_title %}
                                {{ product.seo_title }}
                                <small class="text-muted">({{ product.seo_title|length }}/70 Zeichen)</small>
                            {% else %}
                                <em class="text-muted">Nicht gesetzt</em>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <label class="form-label"><strong>SEO Beschreibung:</strong></label>
                        <div class="form-control-plaintext border rounded p-2 bg-light">
                            {% if product.seo_description %}
                                {{ product.seo_description }}
                                <small class="text-muted">({{ product.seo_description|length }}/160 Zeichen)</small>
                            {% else %}
                                <em class="text-muted">Nicht gesetzt</em>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Aktionen -->
                <div class="mt-4">
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="{% url 'shopify_manager:product_seo_optimization' product.id %}" class="btn btn-primary">
                            <i class="fas fa-robot"></i> Do-SEO
                        </a>
                        <button class="btn btn-outline-danger" onclick="deleteProductLocal({{ product.id }})">
                            <i class="fas fa-trash-alt"></i> Lokal löschen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4{% if product.status == 'archived' %} opacity-50{% endif %}">
        <!-- Produktbilder -->
        <div class="card mb-4{% if product.status == 'archived' %} border-secondary{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    Produktbilder
                    {% if product.images.count > 1 %}
                        <span class="badge bg-secondary ms-2">{{ product.images.count }}</span>
                    {% endif %}
                </h5>
                {% if product.images.count > 1 %}
                    <small class="text-muted"><i class="fas fa-hand-pointer"></i> Wischen zum Blättern</small>
                {% endif %}
            </div>
            <div class="card-body text-center p-0">
                {% if product.images.exists %}
                    <!-- Bild-Carousel -->
                    <div id="productImageCarousel" class="carousel slide" data-bs-touch="true">
                        <div class="carousel-inner">
                            {% for image in product.images.all %}
                                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                    <img src="{{ image.image_url }}"
                                         class="d-block w-100"
                                         alt="{{ image.alt_text|default:product.title }}"
                                         style="max-height: 400px; object-fit: contain; background: #f8f9fa;">
                                </div>
                            {% endfor %}
                        </div>
                        {% if product.images.count > 1 %}
                            <!-- Navigation Pfeile -->
                            <button class="carousel-control-prev" type="button" data-bs-target="#productImageCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon bg-dark rounded-circle p-3" aria-hidden="true"></span>
                                <span class="visually-hidden">Zurück</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#productImageCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon bg-dark rounded-circle p-3" aria-hidden="true"></span>
                                <span class="visually-hidden">Weiter</span>
                            </button>
                            <!-- Indikatoren -->
                            <div class="carousel-indicators">
                                {% for image in product.images.all %}
                                    <button type="button"
                                            data-bs-target="#productImageCarousel"
                                            data-bs-slide-to="{{ forloop.counter0 }}"
                                            {% if forloop.first %}class="active" aria-current="true"{% endif %}
                                            aria-label="Bild {{ forloop.counter }}">
                                    </button>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <!-- Thumbnail-Leiste bei mehreren Bildern -->
                    {% if product.images.count > 1 %}
                        <div class="d-flex flex-wrap justify-content-center gap-2 p-3 border-top bg-light">
                            {% for image in product.images.all %}
                                <img src="{{ image.image_url }}"
                                     class="img-thumbnail product-thumb {% if forloop.first %}border-primary{% endif %}"
                                     style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;"
                                     data-bs-target="#productImageCarousel"
                                     data-bs-slide-to="{{ forloop.counter0 }}"
                                     alt="Bild {{ forloop.counter }}">
                            {% endfor %}
                        </div>
                    {% endif %}
                {% elif product.image_url %}
                    <!-- Fallback: Nur Hauptbild -->
                    <img src="{{ product.image_url }}" class="img-fluid"
                         alt="{{ product.featured_image_alt|default:product.title }}"
                         style="max-height: 400px; object-fit: contain;">
                {% else %}
                    <div class="bg-light rounded p-4 m-3">
                        <i class="fas fa-image text-muted fa-4x"></i>
                        <p class="mt-3 text-muted">Kein Bild verfügbar</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Externe Links -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Externe Links</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ product.get_shopify_admin_url }}" target="_blank" class="btn btn-outline-primary">
                        <i class="fas fa-external-link-alt"></i> In Shopify Admin öffnen
                    </a>
                    {% if product.handle %}
                    <a href="{{ product.get_storefront_url }}" target="_blank" class="btn btn-outline-secondary">
                        <i class="fas fa-store"></i> Im Shop ansehen
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Metadaten -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Metadaten</h5>
            </div>
            <div class="card-body">
                <dl class="row small">
                    <dt class="col-sm-6">Shopify erstellt:</dt>
                    <dd class="col-sm-6">
                        {% if product.shopify_created_at %}
                            {{ product.shopify_created_at|date:"d.m.Y H:i" }}
                        {% else %}
                            —
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-6">Shopify aktualisiert:</dt>
                    <dd class="col-sm-6">
                        {% if product.shopify_updated_at %}
                            {{ product.shopify_updated_at|date:"d.m.Y H:i" }}
                        {% else %}
                            —
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-6">Lokal erstellt:</dt>
                    <dd class="col-sm-6">{{ product.created_at|date:"d.m.Y H:i" }}</dd>
                    
                    <dt class="col-sm-6">Lokal aktualisiert:</dt>
                    <dd class="col-sm-6">{{ product.updated_at|date:"d.m.Y H:i" }}</dd>
                </dl>
            </div>
        </div>
    </div>
</div>


<script>
// Bild-Carousel Thumbnail-Klicks und Highlight
document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.getElementById('productImageCarousel');
    if (carousel) {
        const thumbs = document.querySelectorAll('.product-thumb');

        // Thumbnail-Klicks
        thumbs.forEach(thumb => {
            thumb.addEventListener('click', function() {
                const slideIndex = this.getAttribute('data-bs-slide-to');
                const bsCarousel = bootstrap.Carousel.getOrCreateInstance(carousel);
                bsCarousel.to(parseInt(slideIndex));
            });
        });

        // Aktives Thumbnail hervorheben bei Slide-Wechsel
        carousel.addEventListener('slide.bs.carousel', function(e) {
            thumbs.forEach((thumb, index) => {
                if (index === e.to) {
                    thumb.classList.add('border-primary');
                    thumb.style.opacity = '1';
                } else {
                    thumb.classList.remove('border-primary');
                    thumb.style.opacity = '0.6';
                }
            });
        });

        // Initial: Nicht-aktive Thumbnails leicht ausblenden
        thumbs.forEach((thumb, index) => {
            if (index !== 0) {
                thumb.style.opacity = '0.6';
            }
        });
    }
});

function deleteProductLocal(productId) {
    if (!confirm('⚠️ Produkt lokal aus der App löschen?\n\nDas Produkt bleibt in Shopify bestehen und kann später wieder importiert werden.')) return;
    
    const btn = event.target;
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Lösche...';
    
    fetch(`/shopify/api/products/${productId}/delete-local/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            // Weiterleitung zur Produktliste
            window.location.href = '/shopify/products/';
        } else {
            alert('❌ Fehler beim lokalen Löschen: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Fehler beim lokalen Löschen');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalContent;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}