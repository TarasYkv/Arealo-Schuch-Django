{% extends 'shopify_manager/base.html' %}

{% block title %}Do-SEO: {{ content_title }} - Shopify Manager{% endblock %}

{% block shopify_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-robot text-primary"></i> Do-SEO: {{ content_title|truncatechars:50 }}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            {% if content_type == 'product' %}
                <a href="{% url 'shopify_manager:product_detail' content_object.pk %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Zur√ºck zum Produkt
                </a>
            {% else %}
                <a href="{% url 'shopify_manager:blog_post_detail' content_object.pk %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Zur√ºck zum Blog-Post
                </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Content-Informationen -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            {% if content_type == 'product' %}
                üì¶ Produktinformationen
            {% else %}
                üìù Blog-Post Informationen
            {% endif %}
        </h5>
        <button class="btn btn-outline-primary btn-sm" onclick="toggleEditMode()">
            <i class="fas fa-edit"></i> <span id="editButtonText">Bearbeiten</span>
        </button>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label"><strong>Titel:</strong></label>
                    <div class="form-control-plaintext border rounded p-2 bg-light" id="titleDisplay">
                        {{ content_title }}
                    </div>
                    <textarea class="form-control d-none" id="titleEdit" rows="2">{{ content_title }}</textarea>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label"><strong>Typ:</strong></label>
                    <div class="form-control-plaintext border rounded p-2 bg-light">
                        {% if content_type == 'product' %}
                            <span class="badge bg-primary"><i class="fas fa-box"></i> Produkt</span>
                        {% else %}
                            <span class="badge bg-success"><i class="fas fa-blog"></i> Blog-Post</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label class="form-label"><strong>Beschreibung/Inhalt:</strong></label>
            <div class="form-control-plaintext border rounded p-3 bg-light" id="descriptionDisplay">
                {% if content_description %}
                    <div style="max-height: none; line-height: 1.5;">
                        {{ content_description|safe|truncatewords:100 }}
                        {% if content_description|wordcount > 100 %}
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showFullContent()">
                                    <i class="fas fa-expand"></i> Vollst√§ndigen Inhalt anzeigen
                                </button>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <em class="text-muted">Keine Beschreibung vorhanden</em>
                {% endif %}
            </div>
            <textarea class="form-control d-none" id="descriptionEdit" rows="6">{{ content_description|striptags }}</textarea>
        </div>
        
        <div class="d-none" id="editActions">
            <div class="text-center">
                <button class="btn btn-success" onclick="saveContentChanges()">
                    <i class="fas fa-save"></i> √Ñnderungen speichern
                </button>
                <button class="btn btn-outline-secondary ms-2" onclick="cancelEdit()">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Aktuelle SEO-Daten -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">üè∑Ô∏è Aktuelle SEO-Daten</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label"><strong>SEO-Titel:</strong></label>
                    <div class="border rounded p-3 bg-white shadow-sm">
                        {% if current_seo_title %}
                            <div class="fs-5 fw-bold text-dark mb-2">{{ current_seo_title }}</div>
                            <div class="text-muted small">
                                L√§nge: {{ current_seo_title|length }}/70 Zeichen
                                {% if current_seo_title|length <= 70 %}
                                    <span class="badge bg-success ms-2">Optimal</span>
                                {% else %}
                                    <span class="badge bg-warning ms-2">Zu lang</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <em class="text-muted">Kein SEO-Titel vorhanden</em>
                            <span class="badge bg-danger ms-2">Fehlt</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label"><strong>SEO-Beschreibung:</strong></label>
                    <div class="border rounded p-3 bg-white shadow-sm">
                        {% if current_seo_description %}
                            <div class="text-dark mb-2">{{ current_seo_description }}</div>
                            <div class="text-muted small">
                                L√§nge: {{ current_seo_description|length }}/160 Zeichen
                                {% if current_seo_description|length <= 160 %}
                                    <span class="badge bg-success ms-2">Optimal</span>
                                {% else %}
                                    <span class="badge bg-warning ms-2">Zu lang</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <em class="text-muted">Keine SEO-Beschreibung vorhanden</em>
                            <span class="badge bg-danger ms-2">Fehlt</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SEO-Generierung -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">ü§ñ KI-SEO-Generierung</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="keywords" class="form-label"><strong>Keywords (kommagetrennt):</strong></label>
                    <input type="text" class="form-control" id="keywords" placeholder="baby, ratgeber, entwicklung, eltern" />
                    <div class="form-text">Geben Sie relevante Keywords ein, getrennt durch Kommas</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="aiModel" class="form-label"><strong>KI-Modell:</strong></label>
                    <select class="form-select" id="aiModel">
                        {% for value, label in ai_models %}
                            <option value="{{ value }}" {% if value == 'gemini-1.5-flash' %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
                
                <div class="text-center">
                    <button type="button" class="btn btn-primary btn-lg" id="generateSeoBtn">
                        <i class="fas fa-magic"></i> SEO-Texte generieren
                    </button>
                </div>

                <!-- Loading und Ergebnis -->
                <div class="mt-4">
                    <!-- Loading Spinner -->
                    <div class="text-center d-none" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Generierung l√§uft...</span>
                        </div>
                        <div class="mt-2">
                            <strong>KI generiert SEO-Texte...</strong><br>
                            <small class="text-muted">Das kann einige Sekunden dauern</small>
                        </div>
                    </div>

                    <!-- Generierte Ergebnisse -->
                    <div class="d-none" id="generatedResults">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle"></i> SEO-Texte erfolgreich generiert!</h6>
                            <div id="generationInfo"></div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="generatedSeoTitle" class="form-label"><strong>Generierter SEO-Titel:</strong></label>
                                    <textarea class="form-control" id="generatedSeoTitle" rows="2" placeholder="Generierter SEO-Titel erscheint hier..."></textarea>
                                    <div class="form-text">
                                        <span id="titleLength">0</span>/70 Zeichen
                                        <span id="titleStatus" class="badge"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="generatedSeoDescription" class="form-label"><strong>Generierte SEO-Beschreibung:</strong></label>
                                    <textarea class="form-control" id="generatedSeoDescription" rows="3" placeholder="Generierte SEO-Beschreibung erscheint hier..."></textarea>
                                    <div class="form-text">
                                        <span id="descriptionLength">0</span>/160 Zeichen
                                        <span id="descriptionStatus" class="badge"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-center align-items-center gap-3">
                            <button type="button" class="btn btn-success btn-lg" id="applySeoBtn">
                                <i class="fas fa-save"></i> √Ñnderungen anwenden
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" id="regenerateBtn">
                                <i class="fas fa-redo"></i> Neu generieren
                            </button>
                        </div>
                    </div>

                    <!-- Fehler -->
                    <div class="d-none" id="errorMessage">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle"></i> Fehler bei der Generierung</h6>
                            <div id="errorText"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Erfolgsmeldung -->
<div class="d-none" id="successMessage">
    <div class="alert alert-success alert-dismissible fade show">
        <h6><i class="fas fa-check-circle"></i> Erfolgreich aktualisiert!</h6>
        <div id="successText"></div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateSeoBtn');
    const applyBtn = document.getElementById('applySeoBtn');
    const regenerateBtn = document.getElementById('regenerateBtn');
    const keywordsInput = document.getElementById('keywords');
    const aiModelSelect = document.getElementById('aiModel');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const generatedResults = document.getElementById('generatedResults');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const generatedSeoTitle = document.getElementById('generatedSeoTitle');
    const generatedSeoDescription = document.getElementById('generatedSeoDescription');

    // Character Counter
    function updateCharacterCount() {
        // SEO Title/Description
        const titleLength = generatedSeoTitle.value.length;
        const descriptionLength = generatedSeoDescription.value.length;
        
        document.getElementById('titleLength').textContent = titleLength;
        document.getElementById('descriptionLength').textContent = descriptionLength;
        
        // SEO Title Status
        const titleStatus = document.getElementById('titleStatus');
        if (titleLength <= 70) {
            titleStatus.textContent = 'Optimal';
            titleStatus.className = 'badge bg-success';
        } else {
            titleStatus.textContent = 'Zu lang';
            titleStatus.className = 'badge bg-warning';
        }
        
        // SEO Description Status
        const descriptionStatus = document.getElementById('descriptionStatus');
        if (descriptionLength <= 160) {
            descriptionStatus.textContent = 'Optimal';
            descriptionStatus.className = 'badge bg-success';
        } else {
            descriptionStatus.textContent = 'Zu lang';
            descriptionStatus.className = 'badge bg-warning';
        }
    }

    generatedSeoTitle.addEventListener('input', updateCharacterCount);
    generatedSeoDescription.addEventListener('input', updateCharacterCount);

    // SEO-Generierung
    function generateSeo() {
        const keywords = keywordsInput.value.trim();
        const aiModel = aiModelSelect.value;

        if (!keywords) {
            alert('Bitte geben Sie mindestens ein Keyword ein.');
            return;
        }

        // UI-Update
        generateBtn.disabled = true;
        loadingSpinner.classList.remove('d-none');
        generatedResults.classList.add('d-none');
        errorMessage.classList.add('d-none');

        // API-Call
        fetch('{% url "shopify_manager:generate_integrated_seo" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                content_type: '{{ content_type }}',
                content_id: {{ content_object.id }},
                keywords: keywords,
                ai_model: aiModel
            })
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.classList.add('d-none');
            generateBtn.disabled = false;

            if (data.success) {
                // Ergebnisse anzeigen
                generatedSeoTitle.value = data.seo_title || '';
                generatedSeoDescription.value = data.seo_description || '';
                
                document.getElementById('generationInfo').innerHTML = `
                    <strong>Modell:</strong> ${data.ai_model}<br>
                    <strong>Keywords:</strong> ${data.keywords_used}<br>
                    <strong>Status:</strong> ${data.message}
                `;
                
                generatedResults.classList.remove('d-none');
                updateCharacterCount();
            } else {
                // Fehler anzeigen
                document.getElementById('errorText').textContent = data.error;
                errorMessage.classList.remove('d-none');
            }
        })
        .catch(error => {
            loadingSpinner.classList.add('d-none');
            generateBtn.disabled = false;
            document.getElementById('errorText').textContent = 'Netzwerkfehler: ' + error.message;
            errorMessage.classList.remove('d-none');
        });
    }

    // √Ñnderungen anwenden
    function applySeo() {
        const seoTitle = generatedSeoTitle.value.trim();
        const seoDescription = generatedSeoDescription.value.trim();

        if (!seoTitle && !seoDescription) {
            alert('Mindestens ein SEO-Feld muss ausgef√ºllt sein.');
            return;
        }

        applyBtn.disabled = true;

        fetch('{% url "shopify_manager:apply_integrated_seo" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                content_type: '{{ content_type }}',
                content_id: {{ content_object.id }},
                seo_title: seoTitle,
                seo_description: seoDescription
            })
        })
        .then(response => response.json())
        .then(data => {
            applyBtn.disabled = false;

            if (data.success) {
                // Erfolg anzeigen
                document.getElementById('successText').textContent = data.message;
                successMessage.classList.remove('d-none');
                
                // Zur entsprechenden √úbersicht weiterleiten
                setTimeout(() => {
                    {% if content_type == 'product' %}
                        window.location.href = "{% url 'shopify_manager:product_list' %}";
                    {% else %}
                        window.location.href = "{% url 'shopify_manager:blog_post_list' %}";
                    {% endif %}
                }, 2000);
            } else {
                alert('Fehler: ' + data.error);
            }
        })
        .catch(error => {
            applyBtn.disabled = false;
            alert('Netzwerkfehler: ' + error.message);
        });
    }

    // Event Listeners
    generateBtn.addEventListener('click', generateSeo);
    regenerateBtn.addEventListener('click', generateSeo);
    applyBtn.addEventListener('click', applySeo);

    // Enter-Taste in Keywords-Feld
    keywordsInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            generateSeo();
        }
    });

    // Edit Mode Funktionen
    window.toggleEditMode = function() {
        const titleDisplay = document.getElementById('titleDisplay');
        const titleEdit = document.getElementById('titleEdit');
        const descriptionDisplay = document.getElementById('descriptionDisplay');
        const descriptionEdit = document.getElementById('descriptionEdit');
        const editActions = document.getElementById('editActions');
        const editButtonText = document.getElementById('editButtonText');

        if (titleEdit.classList.contains('d-none')) {
            // Bearbeitungsmodus aktivieren
            titleDisplay.classList.add('d-none');
            titleEdit.classList.remove('d-none');
            descriptionDisplay.classList.add('d-none');
            descriptionEdit.classList.remove('d-none');
            editActions.classList.remove('d-none');
            editButtonText.textContent = 'Abbrechen';
        } else {
            // Bearbeitungsmodus deaktivieren
            cancelEdit();
        }
    };

    window.cancelEdit = function() {
        const titleDisplay = document.getElementById('titleDisplay');
        const titleEdit = document.getElementById('titleEdit');
        const descriptionDisplay = document.getElementById('descriptionDisplay');
        const descriptionEdit = document.getElementById('descriptionEdit');
        const editActions = document.getElementById('editActions');
        const editButtonText = document.getElementById('editButtonText');

        titleDisplay.classList.remove('d-none');
        titleEdit.classList.add('d-none');
        descriptionDisplay.classList.remove('d-none');
        descriptionEdit.classList.add('d-none');
        editActions.classList.add('d-none');
        editButtonText.textContent = 'Bearbeiten';

        // Originalwerte wiederherstellen
        titleEdit.value = '{{ content_title|escapejs }}';
        descriptionEdit.value = '{{ content_description|striptags|escapejs }}';
    };

    window.saveContentChanges = function() {
        const title = document.getElementById('titleEdit').value.trim();
        const description = document.getElementById('descriptionEdit').value.trim();

        if (!title && !description) {
            alert('Titel oder Beschreibung muss ausgef√ºllt sein.');
            return;
        }

        const saveBtn = event.target;
        const originalContent = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Speichere...';

        fetch('{% url "shopify_manager:apply_integrated_seo" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                content_type: '{{ content_type }}',
                content_id: {{ content_object.id }},
                title: title,
                description: description
            })
        })
        .then(response => response.json())
        .then(data => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalContent;

            if (data.success) {
                alert('√Ñnderungen erfolgreich gespeichert!');
                location.reload();
            } else {
                alert('Fehler beim Speichern: ' + data.error);
            }
        })
        .catch(error => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalContent;
            alert('Netzwerkfehler: ' + error.message);
        });
    };


    // Vollst√§ndigen Inhalt anzeigen
    window.showFullContent = function() {
        const descriptionDisplay = document.getElementById('descriptionDisplay');
        descriptionDisplay.innerHTML = `
            <div style="max-height: none; line-height: 1.5;">
                {{ content_description|safe|escapejs }}
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideFullContent()">
                        <i class="fas fa-compress"></i> Inhalt einklappen
                    </button>
                </div>
            </div>
        `;
    };

    window.hideFullContent = function() {
        const descriptionDisplay = document.getElementById('descriptionDisplay');
        descriptionDisplay.innerHTML = `
            {% if content_description %}
                <div style="max-height: none; line-height: 1.5;">
                    {{ content_description|safe|truncatewords:100|escapejs }}
                    {% if content_description|wordcount > 100 %}
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showFullContent()">
                                <i class="fas fa-expand"></i> Vollst√§ndigen Inhalt anzeigen
                            </button>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <em class="text-muted">Keine Beschreibung vorhanden</em>
            {% endif %}
        `;
    };
});
</script>

<style>
.card-header h5 {
    margin-bottom: 0;
}

.form-control-plaintext {
    padding: 0.5rem;
    background-color: #f8f9fa !important;
}

#generatedSeoTitle, #generatedSeoDescription {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.badge {
    font-size: 0.75em;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

.form-switch .form-check-input {
    width: 2.5em;
    height: 1.25em;
    background-color: #6c757d;
    border: none;
}

.form-switch .form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

.form-switch .form-check-label {
    margin-left: 0.5rem;
    font-weight: 500;
    color: #495057;
}
</style>

{% endblock %}