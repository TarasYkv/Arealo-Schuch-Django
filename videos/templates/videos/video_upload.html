{% extends 'base.html' %}
{% load static %}

{% block title %}Video hochladen{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1>Video hochladen</h1>
            
            <!-- Speicherplatz-Info -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-hdd"></i> Speicherplatz-Übersicht
                        </h6>
                        {% if not user_storage.is_premium %}
                        <a href="{% url 'payments:subscription_plans' %}" class="btn btn-warning btn-sm">
                            <i class="fas fa-crown"></i> Mehr Speicher
                        </a>
                        {% endif %}
                    </div>
                    
                    <div class="progress mb-2" style="height: 20px;">
                        <div class="progress-bar {% if used_percentage > 90 %}bg-danger{% elif used_percentage > 75 %}bg-warning{% else %}bg-success{% endif %}" 
                             role="progressbar" 
                             style="width: {{ used_percentage }}%"
                             aria-valuenow="{{ used_percentage }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ used_percentage|floatformat:1 }}%
                        </div>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Belegt</small><br>
                            <strong>{{ user_storage.get_used_storage_mb|floatformat:1 }} MB</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Verfügbar</small><br>
                            <strong>{{ available_storage_bytes|filesizeformat }}</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Gesamt</small><br>
                            <strong>{{ user_storage.get_max_storage_mb|floatformat:0 }} MB</strong>
                        </div>
                    </div>
                    
                    {% if not can_upload %}
                    <div class="alert alert-danger mt-3 mb-0">
                        <i class="fas fa-exclamation-triangle"></i>
                        {{ restriction_message }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="uploadForm">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">Titel</label>
                            {{ form.title }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Beschreibung (optional)</label>
                            {{ form.description }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.video_file.id_for_label }}" class="form-label">Video-Datei</label>
                            {{ form.video_file }}
                            <small class="form-text text-muted">
                                Unterstützte Formate: MP4, AVI, MOV, WMV, FLV, MKV, WebM<br>
                                Verfügbarer Speicher: {{ available_storage_bytes|filesizeformat }}
                            </small>
                            <div id="fileSizeWarning" class="alert alert-warning mt-2" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span id="fileSizeMessage"></span>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn">
                            <i class="fas fa-upload"></i> Video hochladen
                        </button>
                        <a href="{% url 'videos:list' %}" class="btn btn-secondary mt-2">Abbrechen</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Progress Modal -->
<div class="modal fade" id="uploadModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div id="uploadIcon" class="mb-4">
                    <i class="fas fa-cloud-upload-alt fa-4x text-primary"></i>
                </div>

                <h4 id="uploadStatus" class="mb-3">Video wird hochgeladen...</h4>

                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                         id="modalProgressBar" role="progressbar" style="width: 0%">
                        <span id="progressText">0%</span>
                    </div>
                </div>

                <p id="uploadDetails" class="text-muted mb-0">
                    <span id="uploadedSize">0 MB</span> von <span id="totalSize">0 MB</span>
                </p>

                <p id="uploadSpeed" class="text-muted small mt-2">
                    Geschwindigkeit: <span id="speedValue">-- MB/s</span>
                </p>

                <div id="uploadStage" class="mt-4">
                    <div class="d-flex justify-content-center align-items-center gap-3">
                        <div class="upload-stage active" id="stage1">
                            <i class="fas fa-upload"></i>
                            <small>Hochladen</small>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                        <div class="upload-stage" id="stage2">
                            <i class="fas fa-cog"></i>
                            <small>Verarbeiten</small>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                        <div class="upload-stage" id="stage3">
                            <i class="fas fa-check"></i>
                            <small>Fertig</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 15px;
    border-radius: 10px;
    color: #6c757d;
    transition: all 0.3s;
}
.upload-stage i {
    font-size: 1.5rem;
    margin-bottom: 5px;
}
.upload-stage.active {
    background: #e7f1ff;
    color: #0d6efd;
}
.upload-stage.done {
    background: #d1e7dd;
    color: #198754;
}
.upload-stage.error {
    background: #f8d7da;
    color: #dc3545;
}
</style>

<script>
// Storage limits from backend
const maxStorage = {{ user_storage.max_storage }};
const usedStorage = {{ user_storage.used_storage }};
const availableStorage = maxStorage - usedStorage;

// Upload state
let uploadStartTime = null;
let lastLoaded = 0;
let lastTime = null;

// Format bytes to readable size
function formatBytes(bytes, decimals = 1) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
}

// Update progress UI
function updateProgress(loaded, total) {
    const percent = Math.round((loaded / total) * 100);
    const progressBar = document.getElementById('modalProgressBar');
    const progressText = document.getElementById('progressText');
    const uploadedSize = document.getElementById('uploadedSize');
    const totalSize = document.getElementById('totalSize');
    const speedValue = document.getElementById('speedValue');

    // Update progress bar
    progressBar.style.width = percent + '%';
    progressText.textContent = percent + '%';

    // Update sizes
    uploadedSize.textContent = formatBytes(loaded);
    totalSize.textContent = formatBytes(total);

    // Calculate speed
    const now = Date.now();
    if (lastTime && (now - lastTime) > 500) {
        const bytesPerSecond = (loaded - lastLoaded) / ((now - lastTime) / 1000);
        speedValue.textContent = formatBytes(bytesPerSecond) + '/s';
        lastLoaded = loaded;
        lastTime = now;
    } else if (!lastTime) {
        lastTime = now;
        lastLoaded = loaded;
    }
}

// Set upload stage
function setStage(stageNum, status) {
    const stages = ['stage1', 'stage2', 'stage3'];
    stages.forEach((id, idx) => {
        const el = document.getElementById(id);
        el.classList.remove('active', 'done', 'error');
        if (idx + 1 < stageNum) {
            el.classList.add('done');
        } else if (idx + 1 === stageNum) {
            el.classList.add(status || 'active');
        }
    });
}

// Show error in modal
function showError(message) {
    const uploadIcon = document.getElementById('uploadIcon');
    const uploadStatus = document.getElementById('uploadStatus');
    const progressBar = document.getElementById('modalProgressBar');

    uploadIcon.innerHTML = '<i class="fas fa-exclamation-circle fa-4x text-danger"></i>';
    uploadStatus.textContent = message;
    uploadStatus.classList.add('text-danger');
    progressBar.classList.remove('bg-primary', 'progress-bar-animated');
    progressBar.classList.add('bg-danger');
    setStage(1, 'error');

    // Add close button
    const modalBody = document.querySelector('#uploadModal .modal-body');
    if (!document.getElementById('closeModalBtn')) {
        const closeBtn = document.createElement('button');
        closeBtn.id = 'closeModalBtn';
        closeBtn.className = 'btn btn-secondary mt-4';
        closeBtn.innerHTML = '<i class="fas fa-times"></i> Schließen';
        closeBtn.onclick = function() {
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
            location.reload();
        };
        modalBody.appendChild(closeBtn);
    }
}

// File size validation
document.getElementById('{{ form.video_file.id_for_label }}').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const warningDiv = document.getElementById('fileSizeWarning');
    const messageSpan = document.getElementById('fileSizeMessage');
    const submitBtn = document.getElementById('submitBtn');

    if (file) {
        const fileSize = file.size;
        const fileSizeMB = (fileSize / (1024 * 1024)).toFixed(1);
        const availableMB = (availableStorage / (1024 * 1024)).toFixed(1);
        const maxStorageMB = (maxStorage / (1024 * 1024)).toFixed(0);

        if (fileSize > availableStorage) {
            const totalNeededMB = ((usedStorage + fileSize) / (1024 * 1024)).toFixed(1);

            messageSpan.innerHTML = `
                Datei zu groß! Benötigt: <strong>${fileSizeMB} MB</strong>,
                verfügbar: <strong>${availableMB} MB</strong>
                (gesamt würde: ${totalNeededMB} MB von ${maxStorageMB} MB belegen).
                <br><a href="{% url 'payments:subscription_plans' %}" class="alert-link">Speicher erweitern</a>
                oder Videos löschen.
            `;
            warningDiv.style.display = 'block';
            warningDiv.className = 'alert alert-danger mt-2';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-ban"></i> Datei zu groß';
        } else if (fileSize > availableStorage * 0.8) {
            messageSpan.innerHTML = `
                Warnung: Datei ist ${fileSizeMB} MB groß.
                Nach dem Upload verbleiben nur noch ${(availableMB - fileSizeMB).toFixed(1)} MB.
            `;
            warningDiv.style.display = 'block';
            warningDiv.className = 'alert alert-warning mt-2';
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-upload"></i> Video hochladen';
        } else {
            warningDiv.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-upload"></i> Video hochladen';
        }
    } else {
        warningDiv.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-upload"></i> Video hochladen';
    }
});

// Form submission with real progress tracking
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const form = this;
    const submitBtn = document.getElementById('submitBtn');
    const fileInput = document.getElementById('{{ form.video_file.id_for_label }}');

    // Final check before submit
    if (fileInput.files[0] && fileInput.files[0].size > availableStorage) {
        alert('Die gewählte Datei ist zu groß für Ihren verfügbaren Speicherplatz.');
        return false;
    }

    // Check if file selected
    if (!fileInput.files[0]) {
        alert('Bitte wählen Sie eine Video-Datei aus.');
        return false;
    }

    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Wird hochgeladen...';

    // Show modal
    const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
    uploadModal.show();

    // Reset state
    uploadStartTime = Date.now();
    lastLoaded = 0;
    lastTime = null;
    setStage(1, 'active');

    // Create FormData
    const formData = new FormData(form);

    // Create XMLHttpRequest for progress tracking
    const xhr = new XMLHttpRequest();

    // Progress event
    xhr.upload.addEventListener('progress', function(e) {
        console.log('Upload progress:', e.loaded, '/', e.total);
        if (e.lengthComputable) {
            updateProgress(e.loaded, e.total);
        }
    });

    // Upload error on xhr.upload
    xhr.upload.addEventListener('error', function(e) {
        console.error('Upload error event:', e);
        showError('Upload-Fehler aufgetreten.');
    });

    // Upload complete - now server is processing
    xhr.upload.addEventListener('load', function() {
        console.log('Upload complete, waiting for server response...');
        document.getElementById('uploadStatus').textContent = 'Video wird verarbeitet...';
        document.getElementById('uploadSpeed').style.display = 'none';
        setStage(2, 'active');

        // Keep progress at 100% during processing
        const progressBar = document.getElementById('modalProgressBar');
        progressBar.style.width = '100%';
        document.getElementById('progressText').textContent = '100%';
    });

    // Response received
    xhr.addEventListener('load', function() {
        console.log('Server response received:', xhr.status, xhr.responseURL);
        if (xhr.status === 200) {
            // Check if response is a redirect (HTML page)
            if (xhr.responseURL && xhr.responseURL.includes('/videos/')) {
                // Success - show completion
                document.getElementById('uploadIcon').innerHTML = '<i class="fas fa-check-circle fa-4x text-success"></i>';
                document.getElementById('uploadStatus').textContent = 'Upload erfolgreich!';
                const progressBar = document.getElementById('modalProgressBar');
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
                setStage(3, 'done');

                // Redirect after short delay
                setTimeout(function() {
                    window.location.href = '{% url "videos:list" %}';
                }, 1500);
            } else {
                // Try to parse as JSON error
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.error) {
                        showError(response.error);
                    } else {
                        // Success - redirect
                        window.location.href = '{% url "videos:list" %}';
                    }
                } catch(e) {
                    // HTML response - check for success or error
                    if (xhr.responseText.includes('errorlist') || xhr.responseText.includes('alert-danger')) {
                        showError('Upload fehlgeschlagen. Bitte überprüfen Sie die Eingaben.');
                    } else {
                        // Assume success, redirect
                        window.location.href = '{% url "videos:list" %}';
                    }
                }
            }
        } else {
            showError('Server-Fehler: ' + xhr.status);
        }
    });

    // Error handling
    xhr.addEventListener('error', function(e) {
        console.error('XHR error:', e);
        showError('Verbindungsfehler. Bitte überprüfen Sie Ihre Internetverbindung.');
    });

    xhr.addEventListener('timeout', function() {
        console.error('XHR timeout');
        showError('Zeitüberschreitung. Das Video ist möglicherweise zu groß.');
    });

    xhr.addEventListener('abort', function() {
        console.error('XHR aborted');
        showError('Upload abgebrochen.');
    });

    // Ready state change for debugging
    xhr.onreadystatechange = function() {
        console.log('XHR readyState:', xhr.readyState, 'status:', xhr.status);
    };

    // Send request
    xhr.open('POST', form.action || window.location.href, true);
    xhr.timeout = 600000; // 10 minutes timeout

    // Add CSRF token header (required by Django)
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    xhr.setRequestHeader('X-CSRFToken', csrfToken);

    xhr.send(formData);
});
</script>
{% endblock %}