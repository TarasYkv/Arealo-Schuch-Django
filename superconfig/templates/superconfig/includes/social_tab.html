<!-- Social Page (Link in Bio) Tab -->
<div class="tab-pane fade" id="social-main-pane" role="tabpanel">
    <!-- Alert Area for notifications -->
    <div id="alertArea" class="mb-3"></div>

    <div class="row">
        <!-- Left Column: Editor -->
        <div class="col-lg-7">
            <!-- Profile Section -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-circle me-2"></i>
                        Profil
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <div id="socialProfilePreview" class="mb-2">
                                <img id="profilePicturePreview" src="" alt="Profilbild"
                                     class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover; display: none;">
                                <div id="profilePlaceholder" class="rounded-circle bg-light d-flex align-items-center justify-content-center"
                                     style="width: 120px; height: 120px; margin: 0 auto;">
                                    <i class="fas fa-user fa-3x text-muted"></i>
                                </div>
                            </div>
                            <input type="file" id="profilePictureInput" accept="image/*" class="d-none">
                            <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('profilePictureInput').click()">
                                <i class="fas fa-upload me-1"></i> Bild hochladen
                            </button>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Beschreibung</label>
                                <textarea id="socialProfileDescription" class="form-control" rows="3"
                                          maxlength="500" placeholder="Kurze Beschreibung..."></textarea>
                                <div class="form-text"><span id="descCharCount">0</span>/500 Zeichen</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Design Section -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-palette me-2"></i>
                        Design
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Hintergrundfarbe</label>
                            <div class="input-group">
                                <input type="color" id="socialBgColor" class="form-control form-control-color" value="#ffffff">
                                <input type="text" id="socialBgColorText" class="form-control" value="#ffffff" maxlength="7">
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Button-Farbe</label>
                            <div class="input-group">
                                <input type="color" id="socialBtnColor" class="form-control form-control-color" value="#000000">
                                <input type="text" id="socialBtnColorText" class="form-control" value="#000000" maxlength="7">
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Button-Textfarbe</label>
                            <div class="input-group">
                                <input type="color" id="socialBtnTextColor" class="form-control form-control-color" value="#ffffff">
                                <input type="text" id="socialBtnTextColorText" class="form-control" value="#ffffff" maxlength="7">
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Profil-Textfarbe</label>
                            <div class="input-group">
                                <input type="color" id="socialProfileTextColor" class="form-control form-control-color" value="#333333">
                                <input type="text" id="socialProfileTextColorText" class="form-control" value="#333333" maxlength="7">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Social Icons Section -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fab fa-instagram me-2"></i>
                        Social Media Icons
                    </h5>
                    <button class="btn btn-light btn-sm" onclick="addSocialIcon()">
                        <i class="fas fa-plus me-1"></i> Hinzufugen
                    </button>
                </div>
                <div class="card-body">
                    <div id="socialIconsList">
                        <!-- Icons will be loaded here -->
                        <p class="text-muted text-center" id="noIconsMessage">Keine Social Icons hinzugefugt</p>
                    </div>
                </div>
            </div>

            <!-- Buttons Section -->
            <div class="card mb-4">
                <div class="card-header bg-warning d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-external-link-alt me-2"></i>
                        Buttons
                    </h5>
                    <button class="btn btn-dark btn-sm" onclick="addSocialButton()">
                        <i class="fas fa-plus me-1"></i> Button hinzufugen
                    </button>
                </div>
                <div class="card-body">
                    <div id="socialButtonsList">
                        <!-- Buttons will be loaded here -->
                        <p class="text-muted text-center" id="noButtonsMessage">Keine Buttons hinzugefugt</p>
                    </div>
                </div>
            </div>

            <!-- Footer Section -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        Footer
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showAffiliateDisclaimer">
                        <label class="form-check-label" for="showAffiliateDisclaimer">
                            Affiliate-Hinweis anzeigen
                        </label>
                    </div>
                    <div id="affiliateTextContainer">
                        <label class="form-label">Affiliate-Hinweis Text</label>
                        <textarea id="affiliateDisclaimerText" class="form-control" rows="2"
                                  placeholder="Diese Seite enthalt Affiliate-Links..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="socialPageActive" checked>
                    <label class="form-check-label" for="socialPageActive">Seite aktiv</label>
                </div>
                <div>
                    <a href="/social/" target="_blank" class="btn btn-outline-primary me-2">
                        <i class="fas fa-external-link-alt me-1"></i> Vorschau
                    </a>
                    <button class="btn btn-success btn-lg" onclick="saveSocialConfig()">
                        <i class="fas fa-save me-2"></i> Speichern
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Column: Preview & Stats -->
        <div class="col-lg-5">
            <!-- Live Preview -->
            <div class="card mb-4 sticky-top" style="top: 20px;">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-mobile-alt me-2"></i>
                        Live-Vorschau
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="socialPreviewFrame" style="min-height: 500px; border-radius: 0 0 0.375rem 0.375rem;">
                        <div class="text-center py-5" id="previewContent">
                            <!-- Preview will be rendered here -->
                            <div class="d-flex flex-column align-items-center p-4">
                                <div id="previewProfilePic" class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mb-3"
                                     style="width: 100px; height: 100px;">
                                    <i class="fas fa-user fa-2x text-white"></i>
                                </div>
                                <p id="previewDescription" class="text-muted mb-3"></p>
                                <div id="previewIcons" class="d-flex gap-3 mb-4">
                                    <!-- Icons preview -->
                                </div>
                                <div id="previewButtons" class="w-100 px-3">
                                    <!-- Buttons preview -->
                                </div>
                                <div id="previewFooter" class="mt-4 pt-3 border-top w-100 text-center">
                                    <small class="text-muted" id="previewAffiliate"></small>
                                    <div class="mt-2">
                                        <a href="#" class="text-muted small me-2">Datenschutz</a>
                                        <a href="#" class="text-muted small">Impressum</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Klick-Statistiken
                    </h5>
                </div>
                <div class="card-body">
                    <div id="statsContent">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Laden...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Icon Modal -->
<div class="modal fade" id="iconModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="iconModalTitle">Social Icon hinzufugen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editIconId">
                <div class="mb-3">
                    <label class="form-label">Plattform</label>
                    <select id="iconPlatform" class="form-select">
                        <option value="instagram">Instagram</option>
                        <option value="tiktok">TikTok</option>
                        <option value="youtube">YouTube</option>
                        <option value="facebook">Facebook</option>
                        <option value="twitter">Twitter/X</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="pinterest">Pinterest</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="telegram">Telegram</option>
                        <option value="email">E-Mail</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">URL</label>
                    <input type="url" id="iconUrl" class="form-control" placeholder="https://...">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="saveIcon()">Speichern</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Button Modal -->
<div class="modal fade" id="buttonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="buttonModalTitle">Button hinzufugen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editButtonId">
                <div class="mb-3">
                    <label class="form-label">Titel *</label>
                    <input type="text" id="buttonTitle" class="form-control" placeholder="z.B. Mein Shop" maxlength="100">
                </div>
                <div class="mb-3">
                    <label class="form-label">URL *</label>
                    <input type="url" id="buttonUrl" class="form-control" placeholder="https://...">
                </div>
                <div class="mb-3">
                    <label class="form-label">Beschreibung (optional)</label>
                    <input type="text" id="buttonDescription" class="form-control" placeholder="Kurze Beschreibung" maxlength="200">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="saveButton()">Speichern</button>
            </div>
        </div>
    </div>
</div>

<script>
// Social Page Data
let socialConfig = {};
let socialIcons = [];
let socialButtons = [];
let iconModal, buttonModal;

// Initialize when tab is shown
document.getElementById('social-main-tab')?.addEventListener('shown.bs.tab', function() {
    loadSocialConfig();
});

// Initialize modals
document.addEventListener('DOMContentLoaded', function() {
    iconModal = new bootstrap.Modal(document.getElementById('iconModal'));
    buttonModal = new bootstrap.Modal(document.getElementById('buttonModal'));

    // Color picker sync
    syncColorPickers('socialBgColor', 'socialBgColorText');
    syncColorPickers('socialBtnColor', 'socialBtnColorText');
    syncColorPickers('socialBtnTextColor', 'socialBtnTextColorText');
    syncColorPickers('socialProfileTextColor', 'socialProfileTextColorText');

    // Description char counter
    document.getElementById('socialProfileDescription')?.addEventListener('input', function() {
        document.getElementById('descCharCount').textContent = this.value.length;
        updatePreview();
    });

    // Image upload handler
    document.getElementById('profilePictureInput')?.addEventListener('change', uploadProfilePicture);

    // Affiliate checkbox handler
    document.getElementById('showAffiliateDisclaimer')?.addEventListener('change', function() {
        document.getElementById('affiliateTextContainer').style.display = this.checked ? 'block' : 'none';
        updatePreview();
    });
});

function syncColorPickers(colorId, textId) {
    const colorPicker = document.getElementById(colorId);
    const textInput = document.getElementById(textId);

    colorPicker?.addEventListener('input', function() {
        textInput.value = this.value;
        updatePreview();
    });

    textInput?.addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
            colorPicker.value = this.value;
            updatePreview();
        }
    });
}

function loadSocialConfig() {
    console.log('Loading social config...');
    fetch('/superconfig/api/social/config/')
        .then(r => {
            console.log('Config load response status:', r.status);
            return r.json();
        })
        .then(data => {
            console.log('Config load response data:', data);
            if (data.success) {
                socialConfig = data.config;
                socialIcons = data.icons;
                socialButtons = data.buttons;

                // Fill form fields
                if (socialConfig.profile_picture) {
                    document.getElementById('profilePicturePreview').src = socialConfig.profile_picture;
                    document.getElementById('profilePicturePreview').style.display = 'block';
                    document.getElementById('profilePlaceholder').style.display = 'none';
                }

                document.getElementById('socialProfileDescription').value = socialConfig.profile_description || '';
                document.getElementById('descCharCount').textContent = (socialConfig.profile_description || '').length;

                document.getElementById('socialBgColor').value = socialConfig.background_color || '#ffffff';
                document.getElementById('socialBgColorText').value = socialConfig.background_color || '#ffffff';
                document.getElementById('socialBtnColor').value = socialConfig.button_color || '#000000';
                document.getElementById('socialBtnColorText').value = socialConfig.button_color || '#000000';
                document.getElementById('socialBtnTextColor').value = socialConfig.button_text_color || '#ffffff';
                document.getElementById('socialBtnTextColorText').value = socialConfig.button_text_color || '#ffffff';
                document.getElementById('socialProfileTextColor').value = socialConfig.profile_text_color || '#333333';
                document.getElementById('socialProfileTextColorText').value = socialConfig.profile_text_color || '#333333';

                document.getElementById('showAffiliateDisclaimer').checked = socialConfig.show_affiliate_disclaimer;
                document.getElementById('affiliateDisclaimerText').value = socialConfig.affiliate_disclaimer_text || '';
                document.getElementById('affiliateTextContainer').style.display = socialConfig.show_affiliate_disclaimer ? 'block' : 'none';

                document.getElementById('socialPageActive').checked = socialConfig.is_active;

                renderIcons();
                renderButtons();
                updatePreview();
                loadStats();
            }
        })
        .catch(err => console.error('Error loading social config:', err));
}

function renderIcons() {
    const container = document.getElementById('socialIconsList');
    const noMsg = document.getElementById('noIconsMessage');

    if (socialIcons.length === 0) {
        noMsg.style.display = 'block';
        container.innerHTML = '';
        container.appendChild(noMsg);
        return;
    }

    noMsg.style.display = 'none';
    container.innerHTML = socialIcons.map(icon => `
        <div class="d-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded" data-icon-id="${icon.id}">
            <div class="d-flex align-items-center">
                <i class="${icon.fa_icon_class} fa-lg me-3 text-primary"></i>
                <div>
                    <strong>${icon.platform_display}</strong><br>
                    <small class="text-muted">${icon.url.substring(0, 40)}...</small>
                </div>
            </div>
            <div>
                <button class="btn btn-outline-primary btn-sm me-1" onclick="editIcon(${icon.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteIcon(${icon.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function renderButtons() {
    const container = document.getElementById('socialButtonsList');
    const noMsg = document.getElementById('noButtonsMessage');

    if (socialButtons.length === 0) {
        noMsg.style.display = 'block';
        container.innerHTML = '';
        container.appendChild(noMsg);
        return;
    }

    noMsg.style.display = 'none';
    container.innerHTML = socialButtons.map(btn => `
        <div class="d-flex align-items-center justify-content-between mb-2 p-2 ${btn.is_active ? 'bg-light' : 'bg-secondary bg-opacity-25'} rounded" data-button-id="${btn.id}">
            <div class="d-flex align-items-center">
                <i class="fas fa-grip-vertical me-3 text-muted" style="cursor: grab;"></i>
                <div>
                    <strong>${btn.title}</strong>
                    ${!btn.is_active ? '<span class="badge bg-secondary ms-2">Inaktiv</span>' : ''}
                    <br>
                    <small class="text-muted">${btn.url.substring(0, 40)}...</small>
                    ${btn.description ? `<br><small class="text-info">${btn.description}</small>` : ''}
                </div>
            </div>
            <div>
                <span class="badge bg-primary me-2">${btn.click_count} Klicks</span>
                <button class="btn btn-outline-primary btn-sm me-1" onclick="editButton(${btn.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-${btn.is_active ? 'warning' : 'success'} btn-sm me-1" onclick="toggleButton(${btn.id}, ${!btn.is_active})">
                    <i class="fas fa-${btn.is_active ? 'eye-slash' : 'eye'}"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteButton(${btn.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function updatePreview() {
    const bgColor = document.getElementById('socialBgColor').value;
    const btnColor = document.getElementById('socialBtnColor').value;
    const btnTextColor = document.getElementById('socialBtnTextColor').value;
    const profileTextColor = document.getElementById('socialProfileTextColor').value;
    const description = document.getElementById('socialProfileDescription').value;
    const showAffiliate = document.getElementById('showAffiliateDisclaimer').checked;
    const affiliateText = document.getElementById('affiliateDisclaimerText').value;

    // Update preview frame background
    document.getElementById('socialPreviewFrame').style.backgroundColor = bgColor;

    // Update description
    const previewDesc = document.getElementById('previewDescription');
    previewDesc.textContent = description;
    previewDesc.style.color = profileTextColor;

    // Update profile picture in preview
    const previewPic = document.getElementById('previewProfilePic');
    const srcImg = document.getElementById('profilePicturePreview');
    if (srcImg && srcImg.style.display !== 'none' && srcImg.src) {
        previewPic.innerHTML = `<img src="${srcImg.src}" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">`;
    }

    // Update icons preview
    const iconsHtml = socialIcons.map(icon =>
        `<a href="#" class="text-dark fs-4"><i class="${icon.fa_icon_class}"></i></a>`
    ).join('');
    document.getElementById('previewIcons').innerHTML = iconsHtml;

    // Update buttons preview
    const buttonsHtml = socialButtons.filter(b => b.is_active).map(btn => `
        <div class="mb-2 p-3 rounded text-center" style="background-color: ${btnColor}; color: ${btnTextColor};">
            <strong>${btn.title}</strong>
            ${btn.description ? `<br><small style="opacity: 0.8;">${btn.description}</small>` : ''}
        </div>
    `).join('');
    document.getElementById('previewButtons').innerHTML = buttonsHtml;

    // Update affiliate text
    document.getElementById('previewAffiliate').textContent = showAffiliate ? affiliateText : '';
}

function uploadProfilePicture() {
    const input = document.getElementById('profilePictureInput');
    if (!input.files || !input.files[0]) return;

    const formData = new FormData();
    formData.append('profile_picture', input.files[0]);

    fetch('/superconfig/api/social/upload-image/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken')
        },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('profilePicturePreview').src = data.profile_picture;
            document.getElementById('profilePicturePreview').style.display = 'block';
            document.getElementById('profilePlaceholder').style.display = 'none';
            updatePreview();
            showAlert('success', 'Profilbild hochgeladen');
        } else {
            showAlert('danger', data.error || 'Fehler beim Hochladen');
        }
    })
    .catch(err => showAlert('danger', 'Fehler beim Hochladen: ' + err));
}

function saveSocialConfig() {
    const data = {
        profile_description: document.getElementById('socialProfileDescription').value,
        background_color: document.getElementById('socialBgColor').value,
        button_color: document.getElementById('socialBtnColor').value,
        button_text_color: document.getElementById('socialBtnTextColor').value,
        profile_text_color: document.getElementById('socialProfileTextColor').value,
        show_affiliate_disclaimer: document.getElementById('showAffiliateDisclaimer').checked,
        affiliate_disclaimer_text: document.getElementById('affiliateDisclaimerText').value,
        is_active: document.getElementById('socialPageActive').checked
    };

    fetch('/superconfig/api/social/config/save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Konfiguration gespeichert!');
        } else {
            showAlert('danger', data.error || 'Fehler beim Speichern');
        }
    })
    .catch(err => showAlert('danger', 'Fehler: ' + err));
}

// Icon functions
function addSocialIcon() {
    document.getElementById('editIconId').value = '';
    document.getElementById('iconPlatform').value = 'instagram';
    document.getElementById('iconUrl').value = '';
    document.getElementById('iconModalTitle').textContent = 'Social Icon hinzufugen';
    iconModal.show();
}

function editIcon(iconId) {
    const icon = socialIcons.find(i => i.id === iconId);
    if (!icon) return;

    document.getElementById('editIconId').value = iconId;
    document.getElementById('iconPlatform').value = icon.platform;
    document.getElementById('iconUrl').value = icon.url;
    document.getElementById('iconModalTitle').textContent = 'Social Icon bearbeiten';
    iconModal.show();
}

function saveIcon() {
    console.log('saveIcon() called');
    const iconId = document.getElementById('editIconId').value;
    const platform = document.getElementById('iconPlatform').value;
    const url = document.getElementById('iconUrl').value;

    console.log('Icon data:', { iconId, platform, url });

    if (!url) {
        showAlert('warning', 'Bitte URL eingeben');
        return;
    }

    const endpoint = iconId
        ? `/superconfig/api/social/icon/${iconId}/update/`
        : '/superconfig/api/social/icon/add/';

    console.log('Sending to endpoint:', endpoint);

    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ platform, url })
    })
    .then(r => {
        console.log('Icon save response status:', r.status);
        return r.json();
    })
    .then(data => {
        console.log('Icon save response data:', data);
        if (data.success) {
            iconModal.hide();
            loadSocialConfig();
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.error || 'Unbekannter Fehler');
        }
    })
    .catch(err => {
        console.error('Icon save error:', err);
        showAlert('danger', 'Fehler beim Speichern: ' + err.message);
    });
}

function deleteIcon(iconId) {
    if (!confirm('Icon wirklich loschen?')) return;

    fetch(`/superconfig/api/social/icon/${iconId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadSocialConfig();
            showAlert('success', 'Icon geloscht');
        } else {
            showAlert('danger', data.error);
        }
    });
}

// Button functions
function addSocialButton() {
    document.getElementById('editButtonId').value = '';
    document.getElementById('buttonTitle').value = '';
    document.getElementById('buttonUrl').value = '';
    document.getElementById('buttonDescription').value = '';
    document.getElementById('buttonModalTitle').textContent = 'Button hinzufugen';
    buttonModal.show();
}

function editButton(buttonId) {
    const btn = socialButtons.find(b => b.id === buttonId);
    if (!btn) return;

    document.getElementById('editButtonId').value = buttonId;
    document.getElementById('buttonTitle').value = btn.title;
    document.getElementById('buttonUrl').value = btn.url;
    document.getElementById('buttonDescription').value = btn.description || '';
    document.getElementById('buttonModalTitle').textContent = 'Button bearbeiten';
    buttonModal.show();
}

function saveButton() {
    console.log('saveButton() called');
    const buttonId = document.getElementById('editButtonId').value;
    const title = document.getElementById('buttonTitle').value;
    const url = document.getElementById('buttonUrl').value;
    const description = document.getElementById('buttonDescription').value;

    console.log('Button data:', { buttonId, title, url, description });

    if (!title || !url) {
        showAlert('warning', 'Bitte Titel und URL eingeben');
        return;
    }

    const endpoint = buttonId
        ? `/superconfig/api/social/button/${buttonId}/update/`
        : '/superconfig/api/social/button/add/';

    console.log('Sending to endpoint:', endpoint);

    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ title, url, description })
    })
    .then(r => {
        console.log('Button save response status:', r.status);
        return r.json();
    })
    .then(data => {
        console.log('Button save response data:', data);
        if (data.success) {
            buttonModal.hide();
            loadSocialConfig();
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.error || 'Unbekannter Fehler');
        }
    })
    .catch(err => {
        console.error('Button save error:', err);
        showAlert('danger', 'Fehler beim Speichern: ' + err.message);
    });
}

function toggleButton(buttonId, newState) {
    fetch(`/superconfig/api/social/button/${buttonId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ is_active: newState })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadSocialConfig();
        }
    });
}

function deleteButton(buttonId) {
    if (!confirm('Button wirklich loschen?')) return;

    fetch(`/superconfig/api/social/button/${buttonId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadSocialConfig();
            showAlert('success', 'Button geloscht');
        } else {
            showAlert('danger', data.error);
        }
    });
}

// Statistics
function loadStats() {
    fetch('/superconfig/api/social/stats/')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderStats(data);
            }
        });
}

function renderStats(data) {
    const container = document.getElementById('statsContent');

    if (data.buttons.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Keine Buttons vorhanden</p>';
        return;
    }

    container.innerHTML = `
        <div class="row text-center mb-4">
            <div class="col-4">
                <h4 class="mb-0">${data.totals.total}</h4>
                <small class="text-muted">Gesamt</small>
            </div>
            <div class="col-4">
                <h4 class="mb-0">${data.totals.last_7_days}</h4>
                <small class="text-muted">7 Tage</small>
            </div>
            <div class="col-4">
                <h4 class="mb-0">${data.totals.last_30_days}</h4>
                <small class="text-muted">30 Tage</small>
            </div>
        </div>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Button</th>
                    <th class="text-end">7d</th>
                    <th class="text-end">30d</th>
                    <th class="text-end">Gesamt</th>
                </tr>
            </thead>
            <tbody>
                ${data.buttons.map(btn => `
                    <tr class="${btn.is_active ? '' : 'text-muted'}">
                        <td>${btn.title} ${btn.is_active ? '' : '<small>(inaktiv)</small>'}</td>
                        <td class="text-end">${btn.clicks_7d}</td>
                        <td class="text-end">${btn.clicks_30d}</td>
                        <td class="text-end"><strong>${btn.clicks_total}</strong></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Helper functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showAlert(type, message) {
    const alertArea = document.getElementById('alertArea');
    if (!alertArea) return;

    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertArea.appendChild(alert);

    setTimeout(() => alert.remove(), 5000);
}
</script>
