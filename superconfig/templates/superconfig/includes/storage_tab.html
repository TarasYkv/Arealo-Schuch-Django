<!-- Storage & Subscriptions Tab -->
<div class="tab-pane fade" id="storage-main-pane" role="tabpanel">
    <!-- Storage Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card info-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie text-info me-2"></i>
                        Speicher-Übersicht
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Verwalten Sie Speicherpläne und überwachen Sie die Speichernutzung aller Benutzer</p>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="totalUsers">-</h3>
                                    <small>Aktive Benutzer</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="totalStorage">-</h3>
                                    <small>Gesamt-Speicher</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="premiumUsers">-</h3>
                                    <small>Premium Benutzer</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="totalRevenue">-</h3>
                                    <small>Monatl. Umsatz</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Storage Users -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card" style="border-left: 4px solid #dc3545;">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Top Speicher-Nutzer
                    </h5>
                </div>
                <div class="card-body" id="topStorageUsers">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Lädt...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card" style="border-left: 4px solid #28a745;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Speicher nach App
                    </h5>
                </div>
                <div class="card-body" id="storageByApp">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Lädt...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Storage Logs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" style="border-left: 4px solid #17a2b8;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Neueste Storage-Aktivitäten
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="storageLogs">
                            <thead>
                                <tr>
                                    <th>Benutzer</th>
                                    <th>App</th>
                                    <th>Aktion</th>
                                    <th>Größe</th>
                                    <th>Zeitpunkt</th>
                                </tr>
                            </thead>
                            <tbody id="storageLogsBody">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner-border text-info" role="status">
                                            <span class="visually-hidden">Lädt...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="text-center mt-3">
                        <a href="{% url 'payments:storage_logs' %}" class="btn btn-outline-primary">
                            <i class="fas fa-external-link-alt me-2"></i>
                            Alle Storage Logs anzeigen
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Quick Links -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" style="border-left: 4px solid #6f42c1;">
                <div class="card-header" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-tools me-2"></i>
                        Admin-Verwaltung
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Schnellzugriff auf wichtige Admin-Bereiche</p>

                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="{% url 'payments:subscriptions_management' %}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-users-cog d-block mb-2" style="font-size: 2rem;"></i>
                                <strong>Subscriptions</strong>
                                <small class="d-block text-muted">Abonnements verwalten</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'payments:storage_logs' %}" class="btn btn-outline-success w-100">
                                <i class="fas fa-list-alt d-block mb-2" style="font-size: 2rem;"></i>
                                <strong>Storage Logs</strong>
                                <small class="d-block text-muted">Speicher-Aktivitäten</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'payments:user_storage' %}" class="btn btn-outline-info w-100">
                                <i class="fas fa-hdd d-block mb-2" style="font-size: 2rem;"></i>
                                <strong>User Storage</strong>
                                <small class="d-block text-muted">Speicher-Übersicht</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'payments:webhook_events' %}" class="btn btn-outline-warning w-100">
                                <i class="fas fa-bolt d-block mb-2" style="font-size: 2rem;"></i>
                                <strong>Webhook Events</strong>
                                <small class="d-block text-muted">Stripe Webhooks</small>
                            </a>
                        </div>
                    </div>

                    <hr class="my-3">

                    <div class="row g-3">
                        <div class="col-md-4">
                            <a href="{% url 'payments:subscription_plans' %}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-crown me-2"></i>
                                Subscription Plans
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'payments:subscription_statistics' %}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-chart-bar me-2"></i>
                                Statistiken
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="/admin/payments/invoice/" class="btn btn-outline-secondary w-100" target="_blank">
                                <i class="fas fa-file-invoice me-2"></i>
                                Invoices (Admin)
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription Plans Management -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" style="border-left: 4px solid #ffc107;">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-crown me-2"></i>
                        Subscription Plans Übersicht
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Verwaltung der Speicher-Abonnement-Pläne</p>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Wichtig:</strong> Pläne werden über Stripe verwaltet. Änderungen hier werden nicht automatisch zu Stripe synchronisiert.
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Plan</th>
                                    <th>Speicher</th>
                                    <th>Preis</th>
                                    <th>Intervall</th>
                                    <th>Aktiv</th>
                                    <th>Abonnenten</th>
                                </tr>
                            </thead>
                            <tbody id="subscriptionPlans">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="spinner-border text-warning" role="status">
                                            <span class="visually-hidden">Lädt...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="text-center mt-3">
                        <a href="/payments/plans/" class="btn btn-primary" target="_blank">
                            <i class="fas fa-external-link-alt me-2"></i>
                            Öffentliche Plans-Seite ansehen
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Storage Detail Modal -->
<div class="modal fade" id="userStorageModal" tabindex="-1" aria-labelledby="userStorageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="userStorageModalLabel">
                    <i class="fas fa-user me-2"></i>
                    Speichernutzung: <span id="modalUsername">-</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="userStorageModalBody">
                <div class="d-flex justify-content-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Lädt...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<script>
// Storage Tab Scripts (will be loaded when tab is activated)
document.getElementById('storage-main-tab')?.addEventListener('shown.bs.tab', function () {
    loadStorageStats();
});

function loadStorageStats() {
    console.log('Loading storage stats...');

    // Load main statistics
    fetch('/superconfig/api/storage/statistics/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalUsers').textContent = data.stats.total_users;
                document.getElementById('totalStorage').textContent = data.stats.total_storage_gb + ' GB';
                document.getElementById('premiumUsers').textContent = data.stats.premium_users;
                document.getElementById('totalRevenue').textContent = data.stats.monthly_revenue;
            } else {
                console.error('Failed to load statistics:', data.message);
            }
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
        });

    // Load other sections...
    loadTopStorageUsers();
    loadStorageByApp();
    loadRecentLogs();
    loadSubscriptionPlans();
}

function loadTopStorageUsers() {
    fetch('/superconfig/api/storage/top-users/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.users.length > 0) {
                let html = '<div class="list-group">';
                data.users.forEach(user => {
                    const percentColor = user.percentage >= 90 ? 'danger' : user.percentage >= 70 ? 'warning' : 'success';
                    html += `
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action" onclick="showUserStorageDetail(${user.user_id}, '${user.username}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${user.username}</strong>
                                    <i class="fas fa-search text-muted ms-2" style="font-size: 0.8rem;"></i>
                                    <br>
                                    <small class="text-muted">${user.email}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-${percentColor}">${user.used_mb} MB / ${user.max_mb} MB</span>
                                    <br>
                                    <small class="text-muted">${user.percentage}% belegt</small>
                                </div>
                            </div>
                        </a>
                    `;
                });
                html += '</div>';
                html += '<small class="text-muted d-block mt-2"><i class="fas fa-info-circle me-1"></i>Klicken Sie auf einen Nutzer für Details</small>';
                document.getElementById('topStorageUsers').innerHTML = html;
            } else {
                document.getElementById('topStorageUsers').innerHTML = `
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Keine Speicher-Nutzer gefunden
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading top storage users:', error);
            document.getElementById('topStorageUsers').innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Fehler beim Laden der Daten
                </div>
            `;
        });
}

function showUserStorageDetail(userId, username) {
    // Modal öffnen
    const modal = new bootstrap.Modal(document.getElementById('userStorageModal'));
    document.getElementById('modalUsername').textContent = username;
    document.getElementById('userStorageModalBody').innerHTML = `
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Lädt...</span>
            </div>
        </div>
    `;
    modal.show();

    // Daten laden
    fetch(`/superconfig/api/storage/user/${userId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let html = '';

                // Speicher-Übersicht
                const percentColor = data.storage.percentage >= 90 ? 'danger' : data.storage.percentage >= 70 ? 'warning' : 'success';
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-hdd me-2"></i>Speicher-Übersicht</h6>
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar bg-${percentColor}" role="progressbar"
                                     style="width: ${data.storage.percentage}%;"
                                     aria-valuenow="${data.storage.percentage}" aria-valuemin="0" aria-valuemax="100">
                                    ${data.storage.percentage}%
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span><strong>Belegt:</strong> ${data.storage.used_mb} MB</span>
                                <span><strong>Verfügbar:</strong> ${data.storage.max_mb} MB</span>
                            </div>
                        </div>
                    </div>
                `;

                // Speicher pro App
                html += `
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-th-large me-2"></i>Speicherverbrauch pro App</h6>
                        </div>
                        <div class="card-body">
                `;

                if (data.apps && data.apps.length > 0) {
                    html += '<div class="table-responsive"><table class="table table-sm table-hover mb-0">';
                    html += '<thead><tr><th>App</th><th class="text-end">Größe</th></tr></thead><tbody>';
                    data.apps.forEach(app => {
                        html += `
                            <tr>
                                <td><i class="fas fa-folder me-2 text-primary"></i>${app.app}</td>
                                <td class="text-end"><span class="badge bg-secondary">${app.size_mb} MB</span></td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table></div>';
                } else {
                    html += `
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Keine App-spezifischen Speicherdaten vorhanden
                        </div>
                    `;
                }

                html += '</div></div>';

                document.getElementById('userStorageModalBody').innerHTML = html;
            } else {
                document.getElementById('userStorageModalBody').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.message || 'Fehler beim Laden der Daten'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading user storage detail:', error);
            document.getElementById('userStorageModalBody').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Fehler beim Laden der Benutzerdaten
                </div>
            `;
        });
}

function loadStorageByApp() {
    fetch('/superconfig/api/storage/by-app/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.storage_by_app.length > 0) {
                let html = '<div class="list-group">';
                data.storage_by_app.forEach(item => {
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${item.app}</strong>
                                    <br>
                                    <small class="text-muted">${item.table}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">${item.size_mb.toFixed(2)} MB</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('storageByApp').innerHTML = html;
            } else {
                document.getElementById('storageByApp').innerHTML = `
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Keine Speicher-Daten gefunden
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading storage by app:', error);
            document.getElementById('storageByApp').innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Fehler beim Laden der Daten
                </div>
            `;
        });
}

function loadRecentLogs() {
    fetch('/superconfig/api/storage/logs/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.logs.length > 0) {
                let html = '';
                data.logs.forEach(log => {
                    html += `
                        <tr>
                            <td>${log.username}</td>
                            <td>${log.app}</td>
                            <td>${log.action}</td>
                            <td>${log.size}</td>
                            <td>${log.timestamp}</td>
                        </tr>
                    `;
                });
                document.getElementById('storageLogsBody').innerHTML = html;
            } else {
                document.getElementById('storageLogsBody').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Keine Storage-Logs gefunden
                            </div>
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading storage logs:', error);
            document.getElementById('storageLogsBody').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Fehler beim Laden der Logs
                        </div>
                    </td>
                </tr>
            `;
        });
}

function loadSubscriptionPlans() {
    fetch('/superconfig/api/subscription/plans-overview/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.plans.length > 0) {
                let html = '';
                data.plans.forEach(plan => {
                    const activeClass = plan.is_active ? 'success' : 'danger';
                    const activeText = plan.is_active ? 'Ja' : 'Nein';
                    html += `
                        <tr>
                            <td><strong>${plan.name}</strong></td>
                            <td>${plan.storage}</td>
                            <td>${plan.price}</td>
                            <td>${plan.interval}</td>
                            <td>
                                <span class="badge bg-${activeClass}">${activeText}</span>
                            </td>
                            <td>
                                <span class="badge bg-primary">${plan.subscriber_count}</span>
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('subscriptionPlans').innerHTML = html;
            } else {
                document.getElementById('subscriptionPlans').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Keine Subscription-Pläne gefunden
                            </div>
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading subscription plans:', error);
            document.getElementById('subscriptionPlans').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Fehler beim Laden der Pläne
                        </div>
                    </td>
                </tr>
            `;
        });
}
</script>
