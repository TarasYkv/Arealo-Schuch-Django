<!-- Google OAuth Tab -->
<div class="tab-pane fade" id="google-oauth-main-pane" role="tabpanel">
    <!-- Google OAuth Status Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card info-card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fab fa-google text-danger me-2"></i>
                        Google Sign-In Status
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadGoogleOAuthStatus()">
                        <i class="fas fa-sync-alt"></i> Aktualisieren
                    </button>
                </div>
                <div class="card-body" id="googleOAuthStatus">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Ladt...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google OAuth Configuration Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-cog text-secondary me-2"></i>
                        Google OAuth Konfiguration
                    </h5>
                </div>
                <div class="card-body">
                    <form id="googleOAuthForm">
                        <div class="mb-3">
                            <label for="google_client_id" class="form-label">
                                <i class="fas fa-key me-1"></i> Client ID
                            </label>
                            <input type="text" class="form-control" id="google_client_id" name="client_id"
                                   placeholder="xxxxx.apps.googleusercontent.com">
                            <div class="form-text">Die Client ID aus der Google Cloud Console</div>
                        </div>

                        <div class="mb-3">
                            <label for="google_client_secret" class="form-label">
                                <i class="fas fa-lock me-1"></i> Client Secret
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="google_client_secret" name="client_secret"
                                       placeholder="Client Secret eingeben">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleSecretVisibility()">
                                    <i class="fas fa-eye" id="secretToggleIcon"></i>
                                </button>
                            </div>
                            <div class="form-text">Das Client Secret aus der Google Cloud Console (leer lassen um bestehendes zu behalten)</div>
                        </div>

                        <div class="alert alert-info mb-3">
                            <h6 class="alert-heading"><i class="fas fa-info-circle me-1"></i> Callback URL</h6>
                            <p class="mb-0">
                                <code id="callbackUrl">https://www.workloom.de/accounts/google/login/callback/</code>
                                <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="copyCallbackUrl()">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </p>
                            <small class="text-muted">Diese URL in Google Cloud Console unter "Autorisierte Weiterleitungs-URIs" eintragen</small>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i> Speichern
                            </button>
                            <button type="button" class="btn btn-info" onclick="testGoogleOAuth()">
                                <i class="fas fa-vial me-1"></i> Testen
                            </button>
                            <button type="button" class="btn btn-danger" onclick="deleteGoogleOAuth()">
                                <i class="fas fa-trash me-1"></i> Loschen
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Instructions Card -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-book text-info me-2"></i>
                        Einrichtungsanleitung
                    </h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="setupInstructions">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step1">
                                    <strong>Schritt 1:</strong>&nbsp;Google Cloud Projekt erstellen
                                </button>
                            </h2>
                            <div id="step1" class="accordion-collapse collapse" data-bs-parent="#setupInstructions">
                                <div class="accordion-body">
                                    <ol>
                                        <li>Gehen Sie zu <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                                        <li>Erstellen Sie ein neues Projekt oder wahlen Sie ein bestehendes</li>
                                        <li>Aktivieren Sie die "Google+ API" oder "People API"</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step2">
                                    <strong>Schritt 2:</strong>&nbsp;OAuth 2.0 Anmeldedaten erstellen
                                </button>
                            </h2>
                            <div id="step2" class="accordion-collapse collapse" data-bs-parent="#setupInstructions">
                                <div class="accordion-body">
                                    <ol>
                                        <li>Gehen Sie zu "APIs & Dienste" > "Anmeldedaten"</li>
                                        <li>Klicken Sie auf "Anmeldedaten erstellen" > "OAuth-Client-ID"</li>
                                        <li>Wahlen Sie "Webanwendung" als Anwendungstyp</li>
                                        <li>Geben Sie einen Namen ein (z.B. "WorkLoom Google Login")</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step3">
                                    <strong>Schritt 3:</strong>&nbsp;URIs konfigurieren
                                </button>
                            </h2>
                            <div id="step3" class="accordion-collapse collapse" data-bs-parent="#setupInstructions">
                                <div class="accordion-body">
                                    <p><strong>Autorisierte JavaScript-Quellen:</strong></p>
                                    <ul>
                                        <li><code>https://www.workloom.de</code></li>
                                        <li><code>https://workloom.de</code></li>
                                    </ul>
                                    <p><strong>Autorisierte Weiterleitungs-URIs:</strong></p>
                                    <ul>
                                        <li><code>https://www.workloom.de/accounts/google/login/callback/</code></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step4">
                                    <strong>Schritt 4:</strong>&nbsp;Credentials hier eintragen
                                </button>
                            </h2>
                            <div id="step4" class="accordion-collapse collapse" data-bs-parent="#setupInstructions">
                                <div class="accordion-body">
                                    <ol>
                                        <li>Kopieren Sie die "Client ID" und "Client Secret" aus Google Cloud Console</li>
                                        <li>Tragen Sie diese oben in das Formular ein</li>
                                        <li>Klicken Sie auf "Speichern"</li>
                                        <li>Testen Sie die Konfiguration mit "Testen"</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Google OAuth Functions
function loadGoogleOAuthStatus() {
    const statusDiv = document.getElementById('googleOAuthStatus');
    statusDiv.innerHTML = `
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-danger" role="status">
                <span class="visually-hidden">Ladt...</span>
            </div>
        </div>
    `;

    fetch('{% url "superconfig:google_oauth_status" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.configured && data.google_oauth) {
                    const oauth = data.google_oauth;
                    statusDiv.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="badge bg-success me-2">
                                        <i class="fas fa-check"></i> Konfiguriert
                                    </span>
                                    ${oauth.site_configured ?
                                        '<span class="badge bg-success"><i class="fas fa-link"></i> Site verknupft</span>' :
                                        '<span class="badge bg-warning"><i class="fas fa-unlink"></i> Site nicht verknupft</span>'
                                    }
                                </div>
                                <table class="table table-sm">
                                    <tr>
                                        <th>Name:</th>
                                        <td>${oauth.name}</td>
                                    </tr>
                                    <tr>
                                        <th>Client ID:</th>
                                        <td><code>${oauth.client_id}</code></td>
                                    </tr>
                                    <tr>
                                        <th>Secret:</th>
                                        <td>${oauth.secret_configured ?
                                            '<span class="text-success"><i class="fas fa-check"></i> Gesetzt</span>' :
                                            '<span class="text-danger"><i class="fas fa-times"></i> Nicht gesetzt</span>'
                                        }</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-light">
                                    <strong>Callback URL:</strong><br>
                                    <code>${oauth.callback_url}</code>
                                </div>
                                <a href="/accounts/login/" class="btn btn-outline-danger btn-sm" target="_blank">
                                    <i class="fab fa-google me-1"></i> Login-Seite offnen
                                </a>
                            </div>
                        </div>
                    `;

                    // Pre-fill form with existing client_id
                    const clientIdInput = document.getElementById('google_client_id');
                    const callbackUrlEl = document.getElementById('callbackUrl');
                    if (clientIdInput) clientIdInput.value = oauth.client_id_full || '';
                    if (callbackUrlEl) callbackUrlEl.textContent = oauth.callback_url;
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Nicht konfiguriert</strong> - Bitte tragen Sie die Google OAuth Credentials unten ein.
                        </div>
                        <div class="mt-3">
                            <strong>Callback URL fur Google Cloud Console:</strong><br>
                            <code>${data.callback_url}</code>
                        </div>
                    `;
                    const callbackEl = document.getElementById('callbackUrl');
                    if (callbackEl) callbackEl.textContent = data.callback_url;
                }
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-times-circle me-2"></i>
                        ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-times-circle me-2"></i>
                    Fehler beim Laden: ${error.message}
                </div>
            `;
        });
}

function toggleSecretVisibility() {
    const secretInput = document.getElementById('google_client_secret');
    const icon = document.getElementById('secretToggleIcon');

    if (secretInput.type === 'password') {
        secretInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        secretInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function copyCallbackUrl() {
    const callbackUrl = document.getElementById('callbackUrl').textContent;
    navigator.clipboard.writeText(callbackUrl).then(() => {
        showToast('Callback URL kopiert!', 'success');
    });
}

document.getElementById('googleOAuthForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch('{% url "superconfig:save_google_oauth" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            loadGoogleOAuthStatus();
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        showToast('Fehler: ' + error.message, 'danger');
    });
});

function testGoogleOAuth() {
    fetch('{% url "superconfig:test_google_oauth" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            showToast('Fehler: ' + error.message, 'danger');
        });
}

function deleteGoogleOAuth() {
    if (!confirm('Mochten Sie die Google OAuth Konfiguration wirklich loschen?')) {
        return;
    }

    fetch('{% url "superconfig:delete_google_oauth" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            loadGoogleOAuthStatus();
            document.getElementById('google_client_id').value = '';
            document.getElementById('google_client_secret').value = '';
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        showToast('Fehler: ' + error.message, 'danger');
    });
}

// Load status when tab is shown
document.getElementById('google-oauth-main-tab')?.addEventListener('shown.bs.tab', function() {
    loadGoogleOAuthStatus();
});

// Also load on page load if this tab is active
document.addEventListener('DOMContentLoaded', function() {
    // Check if Google OAuth tab exists and load status
    if (document.getElementById('google-oauth-main-pane')) {
        // Defer loading until tab is visible
        const tabButton = document.getElementById('google-oauth-main-tab');
        if (tabButton) {
            tabButton.addEventListener('click', function() {
                setTimeout(loadGoogleOAuthStatus, 100);
            }, { once: true });
        }
    }
});
</script>
