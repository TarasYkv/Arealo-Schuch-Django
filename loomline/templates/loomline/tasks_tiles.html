{% extends "base.html" %}
{% load static %}

{% block title %}Aufgaben-√úbersicht{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">üéØ Aufgaben-√úbersicht</h1>
                    <p class="text-muted mb-0">Alle erledigten Aufgaben in der modernen Kachelansicht</p>
                </div>
                <div class="d-flex gap-3 align-items-center flex-wrap">
                    <!-- Sucheingabe -->
                    <div class="flex-grow-1" style="min-width: 300px;">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="searchInput" class="form-control search-input" placeholder="Aufgaben durchsuchen...">
                            <button type="button" id="clearSearch" class="clear-search" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Filter Button -->
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filterModal">
                        <i class="fas fa-filter me-2"></i>Filter
                        <span id="filterCount" class="badge bg-primary ms-2" style="display: none;">0</span>
                    </button>

                    <!-- View Toggle -->
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="viewMode" id="tileView" checked>
                        <label class="btn btn-outline-secondary" for="tileView">
                            <i class="fas fa-th me-1"></i>Kacheln
                        </label>
                        <input type="radio" class="btn-check" name="viewMode" id="listView">
                        <label class="btn btn-outline-secondary" for="listView">
                            <i class="fas fa-list me-1"></i>Liste
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Summary -->
    <div id="filterSummary" style="display: none;" class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-filter me-2"></i>
                    <span id="filterSummaryText"></span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()">
                    <i class="fas fa-times me-1"></i>Filter zur√ºcksetzen
                </button>
            </div>
        </div>
    </div>


    <!-- Task Cards Container -->
    <div class="tasks-timeline-container">
        <div id="taskTiles" class="task-tiles-grid">
            {% for task in tasks %}
            <div class="task-container" data-task-id="{{ task.id }}">
                <!-- Main Task Card -->
                <div class="main-task-card">
                    <div class="task-tile-wrapper">
                        <div class="task-tile" data-task-id="{{ task.id }}">
                            <div class="task-front">
                                {% if forloop.first %}
                                <div class="newest-badge-corner">
                                    <span>Neuste</span>
                                </div>
                                {% endif %}
                                <div class="task-header">
                                    <div class="task-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="task-date-container">
                                        <div class="task-date">
                                            {{ task.completed_at|date:"d.m.Y H:i" }}
                                        </div>
                                    </div>
                                </div>
                                <div class="task-content">
                                    <div class="task-content-top">
                                        <h5 class="task-title">{{ task.title|truncatechars:40 }}</h5>
                                    </div>
                                    <div class="task-content-bottom">
                                        <div class="task-user">
                                            <i class="fas fa-user me-1"></i>{{ task.completed_by.first_name|default:task.completed_by.username|truncatechars:15 }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="task-back">
                                <!-- Main Task Add Button (Top Center) -->
                                <div class="task-back-add-main">
                                    <button class="action-btn add-task-btn" data-project-id="{{ task.project.id }}" title="Neue Hauptaufgabe erstellen">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>

                                <!-- Subcard Add Button (Right Center) -->
                                <div class="task-back-add-sub">
                                    <button class="action-btn add-subtask-btn" data-task-id="{{ task.id }}" data-project-id="{{ task.project.id }}" title="Neue Unteraufgabe erstellen">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>

                                <div class="task-back-header">
                                    <div class="task-back-actions">
                                        <button class="action-btn edit-btn" data-task-id="{{ task.id }}" data-title="{{ task.title }}" data-description="{{ task.description }}" title="Bearbeiten">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="action-btn delete-btn" data-task-id="{{ task.id }}" title="L√∂schen">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="task-back-content">
                                    <div class="task-back-top">
                                        <div class="task-back-title">Beschreibung</div>
                                        <div class="task-description">
                                            {% if task.description %}
                                            {{ task.description|truncatechars:80 }}
                                            {% else %}
                                            <em>Keine Beschreibung verf√ºgbar</em>
                                            {% endif %}
                                        </div>
                                        {% if task.description and task.description|length > 80 %}
                                        <button class="expand-btn"
                                                data-task-id="{{ task.id }}"
                                                data-description="{{ task.description }}"
                                                data-title="{{ task.title }}"
                                                data-date="{{ task.completed_at|date:'d.m.Y H:i' }}"
                                                data-user="{{ task.completed_by.username }}"
                                                data-has-notification="{% if task.notifications.exists %}true{% else %}false{% endif %}"
                                                {% if task.notifications.exists %}
                                                    {% with notification=task.notifications.first %}
                                                    data-notification-time="{{ notification.send_at|date:'d.m.Y H:i' }}"
                                                    data-notification-sent="{{ notification.sent|yesno:'true,false' }}"
                                                    data-notification-message="{{ notification.message }}"
                                                    {% endwith %}
                                                {% endif %}>
                                            <i class="fas fa-expand-alt"></i> Mehr anzeigen
                                        </button>
                                        {% endif %}
                                    </div>
                                    <div class="task-back-bottom">
                                        <div class="task-project-info">
                                            <i class="fas fa-folder me-1"></i>{{ task.project.name }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sub Cards (Example - these will be added dynamically) -->
                {% if task.subtasks.all %}
                <div class="subcards-container" data-task-id="{{ task.id }}" data-total-cards="{{ task.subtasks.all|length }}">
                    {% for subtask in task.subtasks.all %}
                    <div class="subcard-wrapper {% if forloop.counter <= 3 %}visible{% else %}hidden-card{% endif %}" data-index="{{ forloop.counter0 }}">
                        <div class="subcard" style="position: relative;">
                            <div class="subcard-front" style="position: relative;">
                                {% if forloop.first %}
                                <div class="newest-badge-corner subcard-newest-corner">
                                    <span>Neuste</span>
                                </div>
                                {% endif %}
                                {% if subtask.notifications.exists %}
                                <div class="subcard-notification-badge" style="position: absolute; top: 5px; right: 5px; background: {% if subtask.notifications.first.sent %}#28a745{% else %}#ffc107{% endif %}; color: {% if subtask.notifications.first.sent %}white{% else %}#856404{% endif %}; padding: 0.2rem 0.4rem; border-radius: 8px; font-size: 0.6rem; font-weight: bold; z-index: 10;">
                                    <i class="fas fa-bell" style="font-size: 0.5rem;"></i>
                                    {% if subtask.notifications.first.sent %}Gesendet{% else %}Erinnerung{% endif %}
                                </div>
                                {% endif %}
                                <div class="subcard-header">
                                    <div class="subcard-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="subcard-date-container">
                                        <div class="subcard-date">
                                            {{ subtask.completed_at|date:"d.m.Y H:i" }}
                                        </div>
                                    </div>
                                </div>
                                <div class="subcard-content">
                                    <div class="subcard-content-top">
                                        <h6 class="subcard-title">{{ subtask.title|truncatechars:30 }}</h6>
                                    </div>
                                    <div class="subcard-content-bottom">
                                        <div class="subcard-user">
                                            <i class="fas fa-user me-1"></i>{{ subtask.completed_by.first_name|default:subtask.completed_by.username|truncatechars:12 }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="subcard-back">
                                <div class="subcard-back-content">
                                    <div class="subcard-back-top">
                                        <div class="subcard-description">
                                            {% if subtask.description %}
                                            {{ subtask.description|truncatechars:100 }}
                                            {% else %}
                                            <em>Keine Beschreibung verf√ºgbar</em>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="subcard-back-bottom">
                                        <div class="subcard-project-name">
                                            <i class="fas fa-folder me-1"></i>{{ subtask.project.name|truncatechars:15 }}
                                        </div>
                                        <button class="btn btn-sm subcard-details-btn"
                                                data-task-id="{{ subtask.id }}"
                                                data-title="{{ subtask.title }}"
                                                data-description="{{ subtask.description|default:'' }}"
                                                data-date="{{ subtask.completed_at|date:'d.m.Y H:i' }}"
                                                data-user="{{ subtask.completed_by.first_name|default:subtask.completed_by.username }}"
                                                data-has-notification="{% if subtask.notifications.exists %}true{% else %}false{% endif %}"
                                                {% if subtask.notifications.exists %}
                                                    {% with notification=subtask.notifications.first %}
                                                    data-notification-time="{{ notification.send_at|date:'d.m.Y H:i' }}"
                                                    data-notification-sent="{{ notification.sent|yesno:'true,false' }}"
                                                    data-notification-message="{{ notification.message }}"
                                                    {% endwith %}
                                                {% endif %}>
                                            <i class="fas fa-info-circle me-1"></i>Mehr
                                            {% if subtask.notifications.exists %}
                                                {% if subtask.notifications.first.sent %}
                                                    <i class="fas fa-bell-slash text-success ms-1" title="Erinnerung wurde gesendet"></i>
                                                {% else %}
                                                    <i class="fas fa-bell text-warning ms-1" title="Erinnerung eingerichtet"></i>
                                                {% endif %}
                                            {% endif %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% if task.subtasks.all|length > 3 %}
                    <div class="subcards-expand-btn" onclick="toggleSubcards(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span class="expand-text">+{{ task.subtasks.all|length|add:"-3" }} √§ltere</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Timeline connector between tasks -->
            {% if not forloop.last %}
            {% with next_task=tasks|slice:forloop.counter|first %}
            <div class="timeline-connector" data-task-index="{{ forloop.counter0 }}" data-current-date="{{ task.completed_at|date:'c' }}" data-next-date="{{ next_task.completed_at|date:'c' }}">
                <div class="timeline-line">
                    <div class="timeline-badge">
                        <div class="timeline-duration">
                            <i class="fas fa-clock"></i>
                            <span class="duration-text">Berechne...</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endwith %}
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- List View (Hidden by default) -->
    <div id="taskList" class="task-list-container" style="display: none;">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                {% for task in tasks %}
                <div class="timeline-item mb-4 pb-4 {% if not forloop.last %}border-bottom{% endif %}">
                    <div class="d-flex align-items-start">
                        <div class="timeline-icon me-3 mt-1">
                            <i class="fas fa-check-circle text-success"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0 fw-bold">{{ task.title }}</h6>
                                <span class="badge bg-light text-dark">{{ task.project.name }}</span>
                            </div>
                            {% if task.description %}
                            <p class="mb-2 text-muted">{{ task.description }}</p>
                            {% endif %}
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>{{ task.completed_by.first_name|default:task.completed_by.username }}
                                </small>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>{{ task.completed_at|date:"d.m.Y H:i" }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Task pagination">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.project %}&project={{ request.GET.project }}{% endif %}{% if request.GET.timeframe %}&timeframe={{ request.GET.timeframe }}{% endif %}{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}">Erste</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.project %}&project={{ request.GET.project }}{% endif %}{% if request.GET.timeframe %}&timeframe={{ request.GET.timeframe }}{% endif %}{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}">Vorherige</a>
                    </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">
                            Seite {{ page_obj.number }} von {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.project %}&project={{ request.GET.project }}{% endif %}{% if request.GET.timeframe %}&timeframe={{ request.GET.timeframe }}{% endif %}{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}">N√§chste</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.project %}&project={{ request.GET.project }}{% endif %}{% if request.GET.timeframe %}&timeframe={{ request.GET.timeframe }}{% endif %}{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}">Letzte</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">
                    <i class="fas fa-filter me-2"></i>Aufgaben filtern
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="filterForm">
                    <div class="mb-3">
                        <label for="projectFilter" class="form-label">Projekt</label>
                        <select class="form-select" id="projectFilter" name="project">
                            <option value="">Alle Projekte</option>
                            {% for project in user_projects %}
                            <option value="{{ project.id }}" {% if request.GET.project == project.id|stringformat:"s" %}selected{% endif %}>
                                {{ project.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="timeframeFilter" class="form-label">Zeitraum</label>
                        <select class="form-select" id="timeframeFilter" name="timeframe">
                            <option value="">Alle Zeitr√§ume</option>
                            <option value="today" {% if request.GET.timeframe == 'today' %}selected{% endif %}>Heute</option>
                            <option value="week" {% if request.GET.timeframe == 'week' %}selected{% endif %}>Diese Woche</option>
                            <option value="month" {% if request.GET.timeframe == 'month' %}selected{% endif %}>Diesen Monat</option>
                            <option value="quarter" {% if request.GET.timeframe == 'quarter' %}selected{% endif %}>Dieses Quartal</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="userFilter" class="form-label">Benutzer</label>
                        <select class="form-select" id="userFilter" name="user">
                            <option value="">Alle Benutzer</option>
                            {% for user in available_users %}
                            <option value="{{ user.id }}" {% if request.GET.user == user.id|stringformat:"s" %}selected{% endif %}>
                                {{ user.first_name|default:user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-outline-danger" onclick="clearAllFilters()">
                    <i class="fas fa-times me-1"></i>Zur√ºcksetzen
                </button>
                <button type="button" class="btn btn-primary" onclick="applyFilters()">
                    <i class="fas fa-check me-1"></i>Filter anwenden
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content add-task-modal">
            <div class="modal-header add-task-header">
                <div class="add-task-header-content">
                    <div class="add-task-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <div class="add-task-title-section">
                        <h5 class="modal-title add-task-title" id="addTaskModalLabel">Neue Aufgabe erstellen</h5>
                        <div class="add-task-subtitle">F√ºgen Sie eine neue Aufgabe hinzu</div>
                    </div>
                </div>
                <button type="button" class="btn-close add-task-close" data-bs-dismiss="modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body add-task-body">
                <form id="addTaskForm" class="add-task-form">
                    <div class="form-group mb-4">
                        <label for="newTaskTitle" class="form-label">
                            <i class="fas fa-heading me-2"></i>Titel
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control add-input" id="newTaskTitle" placeholder="Aufgabentitel eingeben..." required>
                            <button type="button" class="btn btn-outline-secondary voice-btn" id="voiceTitleBtn" title="Spracheingabe">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group mb-4">
                        <label for="newTaskDescription" class="form-label">
                            <i class="fas fa-align-left me-2"></i>Beschreibung
                        </label>
                        <div class="input-group-textarea">
                            <textarea class="form-control add-textarea" id="newTaskDescription" rows="4" placeholder="Beschreibung der Aufgabe (optional)..."></textarea>
                            <button type="button" class="btn btn-outline-secondary voice-btn voice-btn-textarea" id="voiceDescriptionBtn" title="Spracheingabe">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-4">
                                <label for="newTaskProject" class="form-label">
                                    <i class="fas fa-folder me-2"></i>Projekt
                                </label>
                                <select class="form-control add-select" id="newTaskProject" required>
                                    <option value="">Projekt ausw√§hlen...</option>
                                    {% for project in user_projects %}
                                    <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-4">
                                <label for="newTaskCompletedAt" class="form-label">
                                    <i class="fas fa-calendar me-2"></i>Abgeschlossen am
                                </label>
                                <input type="datetime-local" class="form-control add-input" id="newTaskCompletedAt" required>
                            </div>
                        </div>
                    </div>

                    <!-- Notification Input -->
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group mb-4">
                                <label for="newNotificationDateTime" class="form-label">
                                    <i class="fas fa-bell me-2"></i>Erinnerung (optional)
                                </label>
                                <input type="datetime-local" class="form-control add-input" id="newNotificationDateTime">
                                <div class="form-text text-muted" style="font-size: 0.8rem; margin-top: 0.5rem;">
                                    Hinweis: Erinnerungen werden st√ºndlich verarbeitet. Die Zustellung erfolgt zur n√§chsten vollen Stunde.
                                </div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer add-task-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Abbrechen
                </button>
                <button type="submit" class="btn btn-primary" form="addTaskForm">
                    <i class="fas fa-plus me-2"></i>Aufgabe erstellen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Task Detail Modal -->
<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content task-detail-modal">
            <div class="modal-header task-detail-header">
                <div class="task-detail-header-content">
                    <div class="task-detail-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="task-detail-title-section">
                        <h5 class="modal-title task-detail-title" id="taskDetailModalLabel">Aufgaben-Details</h5>
                        <div class="task-detail-subtitle">Vollst√§ndige √úbersicht</div>
                    </div>
                </div>
                <button type="button" class="btn-close task-detail-close" data-bs-dismiss="modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body task-detail-body">
                <div id="taskDetailContent" class="task-detail-content">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
            </div>
            <div class="modal-footer task-detail-footer" id="taskDetailFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Schlie√üen
                </button>
                <button type="button" class="btn btn-primary" id="editTaskFromModalBtn">
                    <i class="fas fa-edit me-2"></i>Bearbeiten
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button for New Task -->
<div class="floating-add-btn" onclick="openAddTaskModal()">
    <i class="fas fa-plus"></i>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content delete-confirm-modal">
            <div class="modal-header delete-confirm-header">
                <div class="delete-icon-wrapper">
                    <div class="delete-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
            <div class="modal-body delete-confirm-body">
                <h4 class="delete-confirm-title">Aufgabe l√∂schen?</h4>
                <p class="delete-confirm-message">
                    Diese Aktion kann nicht r√ºckg√§ngig gemacht werden. Die Aufgabe wird dauerhaft entfernt.
                </p>
                <div class="task-preview" id="deleteTaskPreview">
                    <!-- Task preview will be inserted here -->
                </div>
            </div>
            <div class="modal-footer delete-confirm-footer">
                <button type="button" class="btn btn-secondary delete-cancel-btn" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Abbrechen
                </button>
                <button type="button" class="btn btn-danger delete-confirm-btn" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>L√∂schen
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Search Container */
.search-container {
    position: relative;
}

.search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    z-index: 2;
}

.search-input {
    padding-left: 40px;
    padding-right: 40px;
    border-radius: 25px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.search-input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.clear-search {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    z-index: 2;
}

.clear-search:hover {
    color: #dc3545;
}


/* Task Container */
.tasks-timeline-container {
    min-height: 400px;
}

.task-tiles-grid {
    display: flex;
    flex-direction: column;
    gap: 0;
}

.task-container {
    position: relative;
    margin-bottom: 0;
}

/* Main Task Card */
.main-task-card {
    position: relative;
    z-index: 1; /* UNTER den Subcards */
}

.task-tile-wrapper {
    perspective: 1000px;
    width: 320px;
    height: 200px;
    position: relative;
}

.task-tile {
    width: 100%;
    height: 100%;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.6s;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.task-tile:hover {
    transform: rotateY(180deg);
}

.task-front, .task-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 15px;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
}

.task-front {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.task-back {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    transform: rotateY(180deg);
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.task-date-container {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0.5rem;
}

.task-icon {
    font-size: 1.5rem;
    opacity: 0.9;
}

.task-date {
    font-size: 0.9rem;
    font-weight: bold;
    background: rgba(255, 255, 255, 0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
}

.task-date-full {
    font-size: 0.9rem;
    font-weight: bold;
    background: rgba(255, 255, 255, 0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
}

/* Corner Badge Styles */
.newest-badge-corner {
    position: absolute;
    top: 0;
    left: 0;
    background: linear-gradient(135deg, #ffd700 0%, #ffb000 100%);
    color: #333;
    font-size: 0.6rem;
    font-weight: bold;
    padding: 0.3rem 0.8rem;
    transform: rotate(-45deg) translate(-25%, 0%);
    transform-origin: top left;
    z-index: 20;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
    animation: pulseGlow 2s infinite;
    border-radius: 0 0 8px 0;
    min-width: 60px;
    text-align: center;
}

.newest-badge-corner span {
    font-size: 0.6rem;
    white-space: nowrap;
}

.subcard-newest-corner {
    font-size: 0.5rem;
    padding: 0.2rem 0.6rem;
    min-width: 50px;
}

.subcard-newest-corner span {
    font-size: 0.5rem;
}

@keyframes pulseGlow {
    0%, 100% {
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
    }
    50% {
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.7);
    }
}

.task-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.task-content-top {
    flex: 1;
    display: flex;
    align-items: flex-start;
}

.task-content-bottom {
    margin-top: auto;
    padding-bottom: 0.5rem;
}

.task-title {
    font-size: 1.1rem;
    font-weight: bold;
    margin-bottom: 0.75rem;
    line-height: 1.3;
}

.task-project, .task-user {
    font-size: 0.85rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
}

/* Task Back */
.task-back-content {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.task-back-top {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.task-back-bottom {
    margin-top: auto;
    padding-top: 0.5rem;
    padding-bottom: 1rem;
}

.task-back-title {
    font-size: 1rem;
    font-weight: bold;
    margin-bottom: 1rem;
}

.task-description {
    font-size: 0.85rem;
    line-height: 1.4;
    margin-bottom: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    height: 5.6em; /* 4 lines * 1.4 line-height */
    flex: 1;
}

.task-project-info {
    font-size: 0.8rem;
    opacity: 0.9;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.expand-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 8px;
    font-size: 0.75rem;
    cursor: pointer;
    margin-bottom: 0.5rem;
    margin-top: auto;
    transition: background 0.3s ease;
}

.expand-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.task-back-meta {
    font-size: 0.75rem;
    opacity: 0.9;
    margin-top: auto;
    padding-top: 0.5rem;
}

.meta-item {
    margin-bottom: 0.3rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Timeline Connector */
.timeline-connector {
    position: relative;
    display: flex;
    justify-content: flex-start;
    align-items: center;
    height: 60px;
    margin: 0.5rem 0;
    padding-left: 160px; /* Center relative to main task card (320px / 2) */
}

.timeline-line {
    width: 4px;
    height: 100%;
    background: linear-gradient(to bottom, #007bff, #6c757d);
    position: relative;
    border-radius: 2px;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

.timeline-line::before {
    content: '';
    position: absolute;
    top: 0;
    left: -4px;
    width: 12px;
    height: 12px;
    background: #007bff;
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
}

.timeline-line::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: -4px;
    width: 12px;
    height: 12px;
    background: #6c757d;
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(108, 117, 125, 0.5);
}

.timeline-badge {
    position: absolute;
    left: 50%; /* Center relative to the timeline line */
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
}

.timeline-duration {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border: 2px solid #007bff;
    border-radius: 15px;
    padding: 0.3rem 0.6rem;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
    display: flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.7rem;
    font-weight: bold;
    color: #007bff;
    white-space: nowrap;
    min-width: 80px;
    justify-content: center;
    transition: all 0.3s ease;
}

.timeline-duration:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
}

.timeline-duration i {
    font-size: 0.65rem;
    opacity: 0.8;
}

.duration-text {
    font-size: 0.7rem;
}

/* Sub Cards Container */
.subcards-container {
    position: absolute;
    left: 340px;
    top: 0;
    display: flex;
    gap: 20px; /* Sichtbarer Abstand zwischen den Subcards */
    z-index: 10; /* √úBER der Hauptkarte */
    min-height: 140px;
    align-items: center;
    /* Karten sind immer sichtbar nebeneinander */
}

/* Expand Button for Subcards */
.subcards-expand-btn {
    width: 50px;
    height: 100px;
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    color: white;
    font-size: 0.75rem;
    text-align: center;
    padding: 0.5rem;
    margin-left: 10px;
    order: 999; /* Ensure it's always at the end */
}

.subcards-expand-btn:hover {
    transform: translateX(3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    background: linear-gradient(135deg, #495057 0%, #343a40 100%);
}

.subcards-expand-btn i {
    font-size: 1rem;
    margin-bottom: 0.25rem;
    transition: transform 0.3s ease;
}

.subcards-expand-btn.expanded i {
    transform: rotate(180deg);
}

.subcards-expand-btn .expand-text {
    font-size: 0.65rem;
    font-weight: 600;
}

/* Hidden subcards */
.subcard-wrapper.hidden-card {
    display: none;
}

.subcards-container.expanded .subcard-wrapper.hidden-card {
    display: block;
    order: 4; /* Place hidden cards after the first 3 visible ones */
}

/* Ensure first 3 cards stay in their original order */
.subcard-wrapper.visible:nth-child(1) { order: 1; }
.subcard-wrapper.visible:nth-child(2) { order: 2; }
.subcard-wrapper.visible:nth-child(3) { order: 3; }

/* Subcard wrapper - normale Pointer-Events */
.subcard-wrapper {
    position: relative;
    perspective: 1000px;
    transition: transform 0.5s ease;
    z-index: 15; /* √úBER allem */
    pointer-events: auto; /* IMMER aktiviert */
}


/* === CARDS ALWAYS VISIBLE - NO STACKING === */
/* Normal state: cards side by side with gap */
.subcard-wrapper:nth-child(1) {
    transform: translateX(0);
}

.subcard-wrapper:nth-child(2) {
    transform: translateX(0);
}

.subcard-wrapper:nth-child(3) {
    transform: translateX(0);
}

.subcard-wrapper:nth-child(4) {
    transform: translateX(0);
}

.subcard-wrapper:nth-child(n+5) {
    transform: translateX(0);
}

/* JavaScript-controlled expansion - All positioning handled by JavaScript now */
/* CSS rules removed to avoid conflicts with absolute positioning */

/* === INDIVIDUAL CARD FLIP === */
.subcard {
    width: 200px;
    height: 140px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.6s ease;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
}

/* CSS fallback for hover */
.subcard:hover {
    transform: rotateY(180deg);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
}

/* JavaScript-controlled flip */
.subcard.flipped {
    transform: rotateY(180deg);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
}

/* Individual wrapper hover: slight lift effect - immer aktiv */
.subcard-wrapper:hover {
    z-index: 10;
    transform: translateY(-5px);
    transition: transform 0.3s ease, z-index 0.1s ease;
}

.subcard-front, .subcard-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
}

.subcard-front {
    background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%);
    color: white;
}

.subcard-back {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    color: #333;
    transform: rotateY(180deg);
}

.subcard-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.subcard-date-container {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0.3rem;
}

.subcard-icon {
    font-size: 1.2rem;
    opacity: 0.9;
}

.subcard-date {
    font-size: 0.75rem;
    font-weight: bold;
    background: rgba(255, 255, 255, 0.3);
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
}

.subcard-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    margin-top: 0.5rem;
}

.subcard-content-top {
    flex: 1;
}

.subcard-content-bottom {
    margin-top: auto;
}

.subcard-title {
    font-size: 0.85rem;
    font-weight: bold;
    line-height: 1.2;
    margin-bottom: 0.25rem;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.subcard-user {
    font-size: 0.7rem;
    opacity: 0.9;
}

/* Subcard Back - Enhanced Layout */
.subcard-back-content {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 0.25rem;
}

.subcard-back-top {
    flex: 1;
    display: flex;
    align-items: center;
}

.subcard-description {
    font-size: 0.75rem;
    line-height: 1.3;
    color: #444;
    text-align: center;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
}

.subcard-back-bottom {
    margin-top: auto;
    padding-top: 0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.subcard-project-name {
    font-size: 0.7rem;
    font-weight: 600;
    color: #555;
    margin-bottom: 0.25rem;
    text-align: center;
}

.subcard-back-meta {
    font-size: 0.65rem;
    color: #666;
    text-align: center;
}

/* Subcard Details Button */
.subcard-details-btn {
    background: rgba(255, 255, 255, 0.9);
    color: #e91e63;
    border: 1px solid rgba(233, 30, 99, 0.3);
    padding: 0.25rem 0.75rem;
    font-size: 0.7rem;
    border-radius: 15px;
    transition: all 0.3s ease;
    font-weight: 500;
}

.subcard-details-btn:hover {
    background: white;
    color: #d81b60;
    border-color: #e91e63;
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(233, 30, 99, 0.3);
}

.subcard-details-btn i {
    font-size: 0.65rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .task-tiles-grid {
        padding: 0 1rem;
    }

    .task-container {
        position: relative;
        margin-bottom: 0;
    }

    .subcards-container {
        position: static;
        margin-top: 1rem;
        flex-wrap: wrap;
    }

    .subcards-container:not(:hover) .subcard-wrapper:not(:first-child) {
        transform: none;
    }

    .task-tile-wrapper {
        width: 100%;
        max-width: 320px;
        margin: 0 auto;
    }

    .subcard {
        width: 180px;
        height: 120px;
    }

    .timeline-connector {
        height: 40px;
        margin: 0.25rem 0;
        padding-left: 50%; /* Center on mobile since cards are full width */
        justify-content: center;
    }

    .timeline-badge {
        left: 50%; /* Center relative to the timeline line */
        transform: translate(-50%, -50%);
    }

    .timeline-duration {
        font-size: 0.65rem;
        padding: 0.25rem 0.5rem;
        min-width: 70px;
    }

    .timeline-duration i {
        font-size: 0.6rem;
    }
}

/* View Mode Toggle */
.task-list-container {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.timeline-item {
    transition: all 0.3s ease;
}

.timeline-item:hover {
    background: rgba(0, 123, 255, 0.05);
    border-radius: 10px;
    padding: 1rem !important;
    margin: -0.5rem -1rem 1rem -1rem !important;
}

.timeline-icon {
    color: #28a745;
    font-size: 1.2rem;
}

/* No Results */
.no-results {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.no-results i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Task Detail Modal Styles */
.task-detail-modal {
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border: none;
}

.task-detail-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom: none;
    padding: 1rem 1.5rem;
}

.task-detail-header-content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.task-detail-icon {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.task-detail-title-section {
    flex: 1;
}

.task-detail-title {
    margin: 0;
    font-size: 1.4rem;
    font-weight: bold;
}

.task-detail-subtitle {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-top: 0.25rem;
}

.task-detail-close {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    border: none;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-size: 1.2rem;
    line-height: 1;
    padding: 0;
}

.task-detail-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.task-detail-body {
    padding: 1.25rem;
    background: #f8f9fa;
    min-height: 250px;
}

.task-detail-content {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
}

.task-detail-footer {
    background: white;
    border-top: 1px solid #e9ecef;
    padding: 1rem 1.5rem;
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
}

.task-detail-footer .btn {
    padding: 0.5rem 1.25rem;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.task-detail-footer .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.task-detail-footer .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.task-detail-footer .btn-secondary {
    background: #6c757d;
    border: none;
}

.task-detail-footer .btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-2px);
}

/* Task Detail Content Styles */
.task-detail-main {
    animation: fadeInUp 0.5s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.task-detail-main-header {
    margin-bottom: 1.25rem;
    text-align: center;
}

.task-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.85rem;
    font-weight: 500;
    margin-bottom: 1rem;
}

.task-detail-main-title {
    font-size: 1.4rem;
    font-weight: bold;
    color: #333;
    margin: 0;
    line-height: 1.3;
}

.task-detail-grid {
    display: grid;
    gap: 2rem;
}

.task-detail-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    border-left: 4px solid #667eea;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.section-header i {
    color: #667eea;
    font-size: 1.1rem;
}

.section-header h6 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #333;
}

.section-content {
    color: #555;
    line-height: 1.6;
}

.task-description-full {
    margin: 0;
    white-space: pre-wrap;
    word-break: break-word;
}

.task-detail-meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.meta-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.meta-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
}

.meta-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.meta-content {
    flex: 1;
}

.meta-label {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
    font-weight: 500;
}

.meta-value {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    line-height: 1.2;
}

/* Task Back Actions */
.task-back-header {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 15;
}

/* Main Task Add Button (Top Center) */
.task-back-add-main {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 16;
}

/* Subcard Add Button (Right Center) */
.task-back-add-sub {
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    z-index: 16;
}

.task-back-actions {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 8px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.action-btn:hover {
    background: white;
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.edit-btn {
    color: #007bff;
}

.edit-btn:hover {
    color: #0056b3;
    background: #e3f2fd;
}

.delete-btn {
    color: #dc3545;
}

.delete-btn:hover {
    color: #a71e2a;
    background: #ffebee;
}

.add-task-btn {
    color: #28a745;
}

.add-task-btn:hover {
    color: #1e7e34;
    background: #e8f5e8;
    transform: scale(1.15);
}

.add-subtask-btn {
    color: #17a2b8;
}

.add-subtask-btn:hover {
    color: #117a8b;
    background: #e3f7fc;
    transform: scale(1.15);
}

/* Add Task Modal Styles */
.add-task-modal {
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border: none;
}

.add-task-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border-bottom: none;
    padding: 1rem 1.5rem;
}

.add-task-header-content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.add-task-icon {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.add-task-title-section {
    flex: 1;
}

.add-task-title {
    margin: 0;
    font-size: 1.4rem;
    font-weight: bold;
}

.add-task-subtitle {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-top: 0.25rem;
}

.add-task-close {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    border: none;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-size: 1.4rem;
    line-height: 1;
    padding: 0;
    font-weight: 300;
}

.add-task-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.add-task-body {
    padding: 1.25rem;
    background: #f8f9fa;
}

.add-task-form {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.add-input, .add-textarea, .add-select {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.add-input:focus, .add-textarea:focus, .add-select:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.add-textarea {
    resize: vertical;
    min-height: 100px;
}

.add-task-footer {
    background: white;
    border-top: 1px solid #e9ecef;
    padding: 1rem 1.5rem;
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.add-task-footer .btn {
    padding: 0.5rem 1.25rem;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.add-task-footer .btn-primary {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
}

.add-task-footer .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
}

/* Floating Action Button */
.floating-add-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 1000;
}

.floating-add-btn i {
    color: white;
    font-size: 1.5rem;
    transition: transform 0.3s ease;
}

.floating-add-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5);
}

.floating-add-btn:hover i {
    transform: rotate(90deg);
}

.floating-add-btn:active {
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(40, 167, 69, 0.4);
}

/* Task Detail Info Cards */
.task-detail-info-card {
    background: #f1f4f7;
    border-radius: 8px;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
}

.task-detail-info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.detail-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.detail-content {
    flex: 1;
}

.detail-label {
    font-size: 0.75rem;
    color: #999;
    margin-bottom: 0.25rem;
}

.detail-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
}

.task-detail-description {
    margin-top: 1.25rem;
    padding-top: 0.75rem;
    border-top: 1px solid #e9ecef;
}

.detail-section-header {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.75rem;
}

.task-detail-description-content {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    font-size: 0.9rem;
    line-height: 1.6;
    color: #555;
}

/* Voice Input Button Styles */
.input-group-textarea {
    position: relative;
}

.voice-btn {
    transition: all 0.3s ease;
}

.voice-btn:hover {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
}

.voice-btn.recording {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
    animation: pulse 1s infinite;
}

.voice-btn-textarea {
    position: absolute;
    top: 8px;
    right: 8px;
    z-index: 10;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    min-width: auto;
}

@keyframes pulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
    100% {
        transform: scale(1);
    }
}

/* Edit Form Styles */
.edit-task-form {
    max-width: none;
}

.edit-form-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
}

.edit-form-header h3 {
    color: #333;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.edit-input, .edit-textarea {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.edit-input:focus, .edit-textarea:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.edit-textarea {
    resize: vertical;
    min-height: 150px;
}

.form-label {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.form-label i {
    color: #667eea;
}

.edit-form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
}

/* Delete Confirmation Modal Styles */
.delete-confirm-modal {
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    border: none;
}

.delete-confirm-header {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    border-bottom: none;
    padding: 2rem;
    text-align: center;
    position: relative;
}

.delete-icon-wrapper {
    display: flex;
    justify-content: center;
    margin-bottom: 0;
}

.delete-icon {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

.delete-confirm-body {
    padding: 2rem;
    text-align: center;
    background: #f8f9fa;
}

.delete-confirm-title {
    color: #333;
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 1rem;
}

.delete-confirm-message {
    color: #6c757d;
    font-size: 1rem;
    line-height: 1.5;
    margin-bottom: 1.5rem;
}

.task-preview {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    margin: 1rem 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #dc3545;
}

.task-preview-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.task-preview-description {
    color: #6c757d;
    font-size: 0.9rem;
    line-height: 1.4;
    margin: 0;
}

.delete-confirm-footer {
    background: white;
    border-top: 1px solid #e9ecef;
    padding: 1.5rem 2rem;
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.delete-confirm-footer .btn {
    padding: 0.75rem 2rem;
    border-radius: 10px;
    font-weight: 500;
    transition: all 0.3s ease;
    min-width: 120px;
}

.delete-cancel-btn {
    background: #6c757d;
    border: none;
}

.delete-cancel-btn:hover {
    background: #5a6268;
    transform: translateY(-2px);
}

.delete-confirm-btn {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border: none;
}

.delete-confirm-btn:hover {
    background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const taskTiles = document.querySelectorAll('.task-container');

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();

            if (searchTerm.length > 0) {
                clearSearch.style.display = 'block';
            } else {
                clearSearch.style.display = 'none';
            }

            taskTiles.forEach(function(tile) {
                const title = tile.querySelector('.task-title')?.textContent.toLowerCase() || '';
                const description = tile.querySelector('.task-description')?.textContent.toLowerCase() || '';
                const project = tile.querySelector('.task-project')?.textContent.toLowerCase() || '';
                const user = tile.querySelector('.task-user')?.textContent.toLowerCase() || '';

                if (title.includes(searchTerm) || description.includes(searchTerm) ||
                    project.includes(searchTerm) || user.includes(searchTerm)) {
                    tile.style.display = 'block';
                } else {
                    tile.style.display = 'none';
                }
            });
        });

        clearSearch.addEventListener('click', function() {
            searchInput.value = '';
            this.style.display = 'none';
            taskTiles.forEach(function(tile) {
                tile.style.display = 'block';
            });
        });
    }

    // View mode toggle
    const tileViewBtn = document.getElementById('tileView');
    const listViewBtn = document.getElementById('listView');
    const taskTilesContainer = document.getElementById('taskTiles');
    const taskListContainer = document.getElementById('taskList');

    if (tileViewBtn && listViewBtn) {
        tileViewBtn.addEventListener('change', function() {
            if (this.checked) {
                taskTilesContainer.style.display = 'flex';
                taskListContainer.style.display = 'none';
            }
        });

        listViewBtn.addEventListener('change', function() {
            if (this.checked) {
                taskTilesContainer.style.display = 'none';
                taskListContainer.style.display = 'block';
            }
        });
    }

    // Expand button functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('expand-btn') || e.target.closest('.expand-btn')) {
            const btn = e.target.classList.contains('expand-btn') ? e.target : e.target.closest('.expand-btn');
            const taskId = btn.getAttribute('data-task-id');
            const description = btn.getAttribute('data-description');
            const title = btn.getAttribute('data-title');
            const date = btn.getAttribute('data-date');
            const user = btn.getAttribute('data-user');
            const hasNotification = btn.getAttribute('data-has-notification') === 'true';
            const notificationTime = btn.getAttribute('data-notification-time');
            const notificationSent = btn.getAttribute('data-notification-sent') === 'true';
            const notificationMessage = btn.getAttribute('data-notification-message');

            // Build notification HTML if exists
            let notificationHtml = '';
            if (hasNotification) {
                notificationHtml = `
                    <div class="task-detail-notification" style="background: #fff3cd; border-radius: 8px; padding: 1rem; margin-top: 1rem; border: 1px solid #ffc107;">
                        <div class="section-header" style="color: #856404; margin-bottom: 0.5rem;">
                            <i class="fas fa-bell me-2"></i>
                            <h6 style="display: inline;">Erinnerung</h6>
                        </div>
                        <div style="display: grid; gap: 0.5rem;">
                            <div>
                                <strong>Zeitpunkt:</strong> ${notificationTime || 'Nicht festgelegt'}
                                ${notificationSent ? '<span class="badge bg-success ms-2">Gesendet</span>' : '<span class="badge bg-warning ms-2">Ausstehend</span>'}
                            </div>
                            ${notificationMessage ? `
                            <div>
                                <strong>Nachricht:</strong><br>
                                <em style="color: #666;">${notificationMessage}</em>
                            </div>` : ''}
                        </div>
                    </div>`;
            }

            const modalContent = document.getElementById('taskDetailContent');
            modalContent.innerHTML = `
                <div class="task-detail-main">
                    <div class="task-detail-main-header">
                        <div class="task-status-badge">
                            <i class="fas fa-check-circle"></i>
                            <span>Abgeschlossen</span>
                        </div>
                        <h2 class="task-detail-main-title">${title}</h2>
                    </div>

                    <div class="task-detail-grid">
                        <div class="task-detail-section">
                            <div class="section-header">
                                <i class="fas fa-align-left"></i>
                                <h6>Beschreibung</h6>
                            </div>
                            <div class="section-content">
                                <p class="task-description-full">${description}</p>
                            </div>
                        </div>

                        <div class="task-detail-meta-grid">
                            <div class="meta-card">
                                <div class="meta-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="meta-content">
                                    <div class="meta-label">Abgeschlossen am</div>
                                    <div class="meta-value">${date}</div>
                                </div>
                            </div>

                            <div class="meta-card">
                                <div class="meta-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="meta-content">
                                    <div class="meta-label">Erledigt von</div>
                                    <div class="meta-value">${user}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${notificationHtml}
                </div>
            `;

            // Store task ID for the edit button
            document.getElementById('taskDetailModal').setAttribute('data-current-task-id', taskId);

            const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            modal.show();
        }
    });

    // Subcard details button functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('subcard-details-btn') || e.target.closest('.subcard-details-btn')) {
            e.preventDefault();
            e.stopPropagation();

            const btn = e.target.classList.contains('subcard-details-btn')
                      ? e.target
                      : e.target.closest('.subcard-details-btn');
            const taskId = btn.getAttribute('data-task-id');
            const description = btn.getAttribute('data-description');
            const title = btn.getAttribute('data-title');
            const date = btn.getAttribute('data-date');
            const user = btn.getAttribute('data-user');
            const hasNotification = btn.getAttribute('data-has-notification') === 'true';
            const notificationTime = btn.getAttribute('data-notification-time');
            const notificationSent = btn.getAttribute('data-notification-sent') === 'true';
            const notificationMessage = btn.getAttribute('data-notification-message');

            // Build notification HTML if exists
            let notificationHtml = '';
            if (hasNotification) {
                notificationHtml = `
                    <div class="task-detail-notification" style="background: #fff3cd; border-radius: 8px; padding: 1rem; margin-top: 1rem; border: 1px solid #ffc107;">
                        <div class="detail-section-header" style="color: #856404; margin-bottom: 0.5rem;">
                            <i class="fas fa-bell me-2"></i>
                            Erinnerung
                        </div>
                        <div style="display: grid; gap: 0.5rem;">
                            <div>
                                <strong>Zeitpunkt:</strong> ${notificationTime || 'Nicht festgelegt'}
                                ${notificationSent ? '<span class="badge bg-success ms-2">Gesendet</span>' : '<span class="badge bg-warning ms-2">Ausstehend</span>'}
                            </div>
                            ${notificationMessage ? `
                            <div>
                                <strong>Nachricht:</strong><br>
                                <em style="color: #666;">${notificationMessage}</em>
                            </div>` : ''}
                        </div>
                    </div>`;
            }

            const modalContent = document.getElementById('taskDetailContent');
            modalContent.innerHTML = `
                <div class="task-detail-main">
                    <div class="task-detail-main-header">
                        <div class="task-status-badge">
                            <i class="fas fa-check-circle"></i>
                            <span>Abgeschlossen</span>
                        </div>
                        <h2 class="task-detail-main-title">${title}</h2>
                    </div>

                    <div class="task-detail-grid">
                        <div class="task-detail-info-card">
                            <div class="detail-icon">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div class="detail-content">
                                <div class="detail-label">Abgeschlossen am</div>
                                <div class="detail-value">${date || 'Kein Datum'}</div>
                            </div>
                        </div>

                        <div class="task-detail-info-card">
                            <div class="detail-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="detail-content">
                                <div class="detail-label">Abgeschlossen von</div>
                                <div class="detail-value">${user || 'Unbekannt'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="task-detail-description">
                        <div class="detail-section-header">
                            <i class="fas fa-align-left me-2"></i>
                            Beschreibung
                        </div>
                        <div class="task-detail-description-content">
                            ${description || '<em style="color: #999;">Keine Beschreibung verf√ºgbar</em>'}
                        </div>
                    </div>

                    ${notificationHtml}
                </div>
            `;

            // Store task ID for the edit button
            document.getElementById('taskDetailModal').setAttribute('data-current-task-id', taskId);

            const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            modal.show();
        }
    });

    // Delete button functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
            const btn = e.target.classList.contains('delete-btn') ? e.target : e.target.closest('.delete-btn');
            const taskId = btn.getAttribute('data-task-id');
            const taskContainer = btn.closest('.task-container');

            if (taskContainer) {
                const title = taskContainer.querySelector('.task-title')?.textContent || 'Unbekannte Aufgabe';
                const description = taskContainer.querySelector('.task-description')?.textContent || 'Keine Beschreibung';

                // Populate delete confirmation modal
                const deletePreview = document.getElementById('deleteTaskPreview');
                deletePreview.innerHTML = `
                    <div class="task-preview-title">${title}</div>
                    <div class="task-preview-description">${description}</div>
                `;

                // Show delete confirmation modal
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                deleteModal.show();

                // Handle confirmation
                document.getElementById('confirmDeleteBtn').onclick = function() {
                    // Send delete request to server
                    fetch(`/loomline/aufgaben/${taskId}/loeschen/`, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                          document.querySelector('meta[name="csrf-token"]')?.content ||
                                          getCookie('csrftoken')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Find associated timeline connector
                            const nextTimelineConnector = taskContainer.nextElementSibling;
                            const prevTimelineConnector = taskContainer.previousElementSibling;

                            // Remove the entire task container with animation
                            taskContainer.style.transition = 'all 0.5s ease';
                            taskContainer.style.transform = 'scale(0.8)';
                            taskContainer.style.opacity = '0';

                            // Also animate timeline connectors if they exist
                            if (nextTimelineConnector && nextTimelineConnector.classList.contains('timeline-connector')) {
                                nextTimelineConnector.style.transition = 'all 0.5s ease';
                                nextTimelineConnector.style.opacity = '0';
                                nextTimelineConnector.style.height = '0';
                            }

                            setTimeout(() => {
                                taskContainer.remove();

                                // Remove timeline connector if it exists
                                if (nextTimelineConnector && nextTimelineConnector.classList.contains('timeline-connector')) {
                                    nextTimelineConnector.remove();
                                }

                                // Check if this was the last task and remove orphaned timeline
                                const remainingTasks = document.querySelectorAll('.task-container');
                                if (remainingTasks.length === 0) {
                                    // Remove any remaining timeline connectors
                                    const remainingConnectors = document.querySelectorAll('.timeline-connector');
                                    remainingConnectors.forEach(connector => connector.remove());
                                } else if (remainingTasks.length === 1) {
                                    // If only one task remains, remove any timeline connectors
                                    const allConnectors = document.querySelectorAll('.timeline-connector');
                                    allConnectors.forEach(connector => connector.remove());
                                }
                            }, 500);

                            // Close modal
                            deleteModal.hide();

                            console.log('Aufgabe erfolgreich gel√∂scht:', data.message);
                        } else {
                            alert('Fehler beim L√∂schen: ' + (data.message || 'Unbekannter Fehler'));
                            deleteModal.hide();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Fehler beim L√∂schen der Aufgabe');
                        deleteModal.hide();
                    });
                };
            }
        }
    });

    // Edit button functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-btn') || e.target.closest('.edit-btn')) {
            const btn = e.target.classList.contains('edit-btn') ? e.target : e.target.closest('.edit-btn');
            const taskId = btn.getAttribute('data-task-id');
            const currentTitle = btn.getAttribute('data-title');
            const currentDescription = btn.getAttribute('data-description');

            // Create edit modal content
            const modalContent = document.getElementById('taskDetailContent');
            modalContent.innerHTML = `
                <form id="editTaskForm" class="edit-task-form">
                    <div class="edit-form-header">
                        <h3>Aufgabe bearbeiten</h3>
                        <p class="text-muted">√Ñndern Sie Titel und Beschreibung der Aufgabe</p>
                    </div>

                    <div class="form-group mb-4">
                        <label for="editTitle" class="form-label">
                            <i class="fas fa-heading me-2"></i>Titel
                        </label>
                        <input type="text" class="form-control edit-input" id="editTitle" value="${currentTitle}" required>
                    </div>

                    <div class="form-group mb-4">
                        <label for="editDescription" class="form-label">
                            <i class="fas fa-align-left me-2"></i>Beschreibung
                        </label>
                        <textarea class="form-control edit-textarea" id="editDescription" rows="6" placeholder="Beschreibung der Aufgabe...">${currentDescription || ''}</textarea>
                    </div>

                </form>
            `;

            // Update modal footer for edit mode
            const footer = document.getElementById('taskDetailFooter');
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Abbrechen
                </button>
                <button type="submit" class="btn btn-primary" form="editTaskForm">
                    <i class="fas fa-save me-2"></i>Speichern
                </button>
            `;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            modal.show();

            // Handle form submission
            document.getElementById('editTaskForm').addEventListener('submit', function(e) {
                e.preventDefault();

                const newTitle = document.getElementById('editTitle').value;
                const newDescription = document.getElementById('editDescription').value;

                // Update the card content
                const taskContainer = btn.closest('.task-container');
                if (taskContainer) {
                    const titleElement = taskContainer.querySelector('.task-title');
                    const descriptionElement = taskContainer.querySelector('.task-description');

                    if (titleElement) {
                        titleElement.textContent = newTitle.length > 40 ? newTitle.substring(0, 37) + '...' : newTitle;
                    }

                    if (descriptionElement) {
                        descriptionElement.innerHTML = newDescription ?
                            (newDescription.length > 80 ? newDescription.substring(0, 77) + '...' : newDescription) :
                            '<em>Keine Beschreibung verf√ºgbar</em>';
                    }

                    // Update data attributes
                    btn.setAttribute('data-title', newTitle);
                    btn.setAttribute('data-description', newDescription);
                }

                // Reset modal footer
                const footer = document.getElementById('taskDetailFooter');
                footer.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Schlie√üen
                    </button>
                    <button type="button" class="btn btn-primary">
                        <i class="fas fa-edit me-2"></i>Bearbeiten
                    </button>
                `;

                // Send update to server
                fetch(`/loomline/aufgaben/${taskId}/bearbeiten/`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                      document.querySelector('meta[name="csrf-token"]')?.content ||
                                      getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        title: newTitle,
                        description: newDescription
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        console.log('Aufgabe erfolgreich aktualisiert:', data.message);

                        // Close modal
                        modal.hide();
                    } else {
                        alert('Fehler beim Speichern: ' + (data.message || 'Unbekannter Fehler'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Fehler beim Speichern der √Ñnderungen');
                });
            });
        }
    });

    // Toggle subcards expand/collapse - global scope
    window.toggleSubcards = function(button) {
        const container = button.parentElement;
        container.classList.toggle('expanded');
        button.classList.toggle('expanded');

        // Update button text and icon
        const expandText = button.querySelector('.expand-text');
        const icon = button.querySelector('i');
        const totalCards = parseInt(container.getAttribute('data-total-cards'));

        if (container.classList.contains('expanded')) {
            expandText.textContent = 'Weniger';
            icon.className = 'fas fa-chevron-left';
        } else {
            expandText.textContent = `+${totalCards - 3} √§ltere`;
            icon.className = 'fas fa-chevron-right';
        }
    }

    // Floating button function - global scope
    window.openAddTaskModal = function() {
        // Get current date/time for default value
        const now = new Date();
        const localDatetime = now.toISOString().slice(0, 16);

        // Reset modal to main task mode
        document.getElementById('addTaskModalLabel').textContent = 'Neue Aufgabe erstellen';
        document.querySelector('.add-task-subtitle').textContent = 'F√ºgen Sie eine neue Aufgabe hinzu';
        document.getElementById('addTaskForm').removeAttribute('data-parent-task');
        document.getElementById('addTaskForm').removeAttribute('data-is-subtask');

        // Clear form
        document.getElementById('newTaskTitle').value = '';
        document.getElementById('newTaskDescription').value = '';
        document.getElementById('newTaskCompletedAt').value = localDatetime;

        // Show modal
        const addModal = new bootstrap.Modal(document.getElementById('addTaskModal'));
        addModal.show();
    }

    // Add task button functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-task-btn') || e.target.closest('.add-task-btn')) {
            const btn = e.target.classList.contains('add-task-btn') ? e.target : e.target.closest('.add-task-btn');
            const projectId = btn.getAttribute('data-project-id');

            // Set current date/time as default
            const now = new Date();
            const localDatetime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('newTaskCompletedAt').value = localDatetime;

            // Pre-select project if available
            if (projectId) {
                document.getElementById('newTaskProject').value = projectId;
            }

            // Reset modal to main task mode
            document.getElementById('addTaskModalLabel').textContent = 'Neue Aufgabe erstellen';
            document.querySelector('.add-task-subtitle').textContent = 'F√ºgen Sie eine neue Aufgabe hinzu';
            document.getElementById('addTaskForm').removeAttribute('data-parent-task');
            document.getElementById('addTaskForm').removeAttribute('data-is-subtask');

            // Clear form
            document.getElementById('addTaskForm').reset();
            document.getElementById('newTaskCompletedAt').value = localDatetime;
            if (projectId) {
                document.getElementById('newTaskProject').value = projectId;
            }

            // Show modal
            const addModal = new bootstrap.Modal(document.getElementById('addTaskModal'));
            addModal.show();
        }
    });

    // Add subtask button functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-subtask-btn') || e.target.closest('.add-subtask-btn')) {
            const btn = e.target.classList.contains('add-subtask-btn') ? e.target : e.target.closest('.add-subtask-btn');
            const taskId = btn.getAttribute('data-task-id');
            const projectId = btn.getAttribute('data-project-id');

            // Set current date/time as default
            const now = new Date();
            const localDatetime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('newTaskCompletedAt').value = localDatetime;

            // Pre-select project if available
            if (projectId) {
                document.getElementById('newTaskProject').value = projectId;
            }

            // Update modal title for subtask
            document.getElementById('addTaskModalLabel').textContent = 'Neue Unteraufgabe erstellen';
            document.querySelector('.add-task-subtitle').textContent = 'F√ºgen Sie eine neue Unteraufgabe hinzu';

            // Store parent task ID for later use
            document.getElementById('addTaskForm').setAttribute('data-parent-task', taskId);
            document.getElementById('addTaskForm').setAttribute('data-is-subtask', 'true');

            // Show modal
            const addModal = new bootstrap.Modal(document.getElementById('addTaskModal'));
            addModal.show();
        }
    });

    // Handle add task form submission
    // Handle add task form submission
    document.getElementById('addTaskForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const title = document.getElementById('newTaskTitle').value;
        const description = document.getElementById('newTaskDescription').value;
        const projectId = document.getElementById('newTaskProject').value;
        const completedAt = document.getElementById('newTaskCompletedAt').value;
        const notificationDateTime = document.getElementById('newNotificationDateTime').value;
        const parentTaskId = this.getAttribute('data-parent-task');
        const isSubtask = this.getAttribute('data-is-subtask') === 'true';

        // Debug logging
        console.log('Creating task:', {
            title, projectId, completedAt, notificationDateTime,
            parentTaskId, isSubtask
        });

        if (!title || !projectId || !completedAt) {
            alert('Bitte f√ºllen Sie alle Pflichtfelder aus.');
            return;
        }

        // Prepare request body
        const requestBody = {
            'title': title,
            'description': description,
            'project': projectId,
            'completed_at': completedAt
        };

        // Add notification time if set
        if (notificationDateTime) {
            requestBody['notification_datetime'] = notificationDateTime;
            console.log('Notification datetime added:', notificationDateTime);
        }

        // Add parent_task_id if it's a subtask
        if (isSubtask && parentTaskId) {
            requestBody['parent_task_id'] = parentTaskId;
        }

        // Determine URL based on whether it's a subtask or main task
        const url = isSubtask ? '/loomline/sub-aufgabe/' : '/loomline/eintragen/';

        // Send request to server
        fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                              document.querySelector('meta[name="csrf-token"]')?.content ||
                              getCookie('csrftoken')
            },
            body: new URLSearchParams(requestBody)
        })
        .then(response => {
            if (response.ok) {
                // Close modal
                const addModal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
                addModal.hide();

                // Reload page to show new task
                window.location.reload();
            } else {
                return response.text().then(text => {
                    throw new Error('Server error: ' + response.status);
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Erstellen der Aufgabe: ' + error.message);
        });
    });
});

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Filter functions
function applyFilters() {
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    const params = new URLSearchParams();

    for (let [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }

    window.location.href = '?' + params.toString();
}

function clearAllFilters() {
    window.location.href = window.location.pathname;
}

// Update filter count and summary
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    let filterCount = 0;
    let filterTexts = [];

    if (urlParams.get('project')) {
        filterCount++;
        const projectSelect = document.getElementById('projectFilter');
        const selectedProject = projectSelect.options[projectSelect.selectedIndex].text;
        filterTexts.push(`Projekt: ${selectedProject}`);
    }

    if (urlParams.get('timeframe')) {
        filterCount++;
        const timeframeSelect = document.getElementById('timeframeFilter');
        const selectedTimeframe = timeframeSelect.options[timeframeSelect.selectedIndex].text;
        filterTexts.push(`Zeitraum: ${selectedTimeframe}`);
    }

    if (urlParams.get('user')) {
        filterCount++;
        const userSelect = document.getElementById('userFilter');
        const selectedUser = userSelect.options[userSelect.selectedIndex].text;
        filterTexts.push(`Benutzer: ${selectedUser}`);
    }

    if (filterCount > 0) {
        document.getElementById('filterCount').textContent = filterCount;
        document.getElementById('filterCount').style.display = 'inline';
        document.getElementById('filterSummary').style.display = 'block';
        document.getElementById('filterSummaryText').textContent = filterTexts.join(', ');
    }

    // Calculate and display time durations between tasks
    calculateTimeDurations();
});

function calculateTimeDurations() {
    const timelineConnectors = document.querySelectorAll('.timeline-connector');

    // Update each timeline connector
    timelineConnectors.forEach((connector) => {
        const currentDateStr = connector.getAttribute('data-current-date');
        const nextDateStr = connector.getAttribute('data-next-date');

        if (currentDateStr && nextDateStr) {
            const currentDate = new Date(currentDateStr);
            const nextDate = new Date(nextDateStr);

            // Calculate time difference
            const timeDiff = Math.abs(nextDate - currentDate);
            const diffInMinutes = Math.floor(timeDiff / (1000 * 60));
            const diffInHours = Math.floor(timeDiff / (1000 * 60 * 60));
            const diffInDays = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

            let durationText = '';

            if (diffInDays > 0) {
                durationText = diffInDays + (diffInDays === 1 ? ' Tag' : ' Tage');
            } else if (diffInHours > 0) {
                durationText = diffInHours + (diffInHours === 1 ? ' Stunde' : ' Stunden');
            } else if (diffInMinutes > 0) {
                durationText = diffInMinutes + (diffInMinutes === 1 ? ' Minute' : ' Minuten');
            } else {
                durationText = '< 1 Min';
            }

            const durationElement = connector.querySelector('.duration-text');
            if (durationElement) {
                durationElement.textContent = durationText;
            }
        }
    });
}

// Voice Input Functionality
let recognition = null;
let isListening = false;

// Check if browser supports speech recognition
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();

    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'de-DE';

    recognition.onstart = function() {
        isListening = true;
    };

    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        if (recognition.currentTarget) {
            const input = document.getElementById(recognition.currentTarget);
            if (input) {
                if (input.tagName === 'TEXTAREA') {
                    // For textarea, append to existing content
                    const currentValue = input.value;
                    input.value = currentValue ? currentValue + ' ' + transcript : transcript;
                } else {
                    // For input fields, replace content
                    input.value = transcript;
                }

                // Trigger input event for any validation or formatting
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
    };

    recognition.onend = function() {
        isListening = false;
        // Reset all voice buttons
        document.querySelectorAll('.voice-btn').forEach(btn => {
            btn.classList.remove('recording');
            btn.innerHTML = '<i class="fas fa-microphone"></i>';
            btn.title = 'Spracheingabe';
        });
    };

    recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        isListening = false;
        // Reset all voice buttons
        document.querySelectorAll('.voice-btn').forEach(btn => {
            btn.classList.remove('recording');
            btn.innerHTML = '<i class="fas fa-microphone"></i>';
            btn.title = 'Spracheingabe';
        });

        // Show user-friendly error message
        if (event.error === 'not-allowed') {
            alert('Mikrofon-Zugriff wurde verweigert. Bitte erlauben Sie den Mikrofon-Zugriff in den Browser-Einstellungen.');
        } else if (event.error === 'no-speech') {
            alert('Keine Sprache erkannt. Bitte versuchen Sie es erneut.');
        } else {
            alert('Spracherkennung fehlgeschlagen. Bitte versuchen Sie es erneut.');
        }
    };
}

// Voice button event listeners
document.addEventListener('click', function(e) {
    if (e.target.closest('.voice-btn')) {
        e.preventDefault();
        const btn = e.target.closest('.voice-btn');

        if (!recognition) {
            alert('Spracherkennung wird von diesem Browser nicht unterst√ºtzt.');
            return;
        }

        if (isListening) {
            recognition.stop();
            return;
        }

        // Determine target input field
        let targetInputId = '';
        if (btn.id === 'voiceTitleBtn') {
            targetInputId = 'newTaskTitle';
        } else if (btn.id === 'voiceDescriptionBtn') {
            targetInputId = 'newTaskDescription';
        }

        if (targetInputId) {
            // Update button appearance
            btn.classList.add('recording');
            btn.innerHTML = '<i class="fas fa-stop"></i>';
            btn.title = 'Aufnahme stoppen';

            // Set target for recognition result
            recognition.currentTarget = targetInputId;

            // Start recognition
            try {
                recognition.start();
            } catch (error) {
                console.error('Error starting speech recognition:', error);
                btn.classList.remove('recording');
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
                btn.title = 'Spracheingabe';
            }
        }
    }
});

// Simplified Subcard Hover Behavior - Cards always visible and flip on hover
// Edit Task from Modal functionality
document.addEventListener('DOMContentLoaded', function() {
    const editBtn = document.getElementById('editTaskFromModalBtn');
    if (editBtn) {
        editBtn.addEventListener('click', function() {
            const modal = document.getElementById('taskDetailModal');
            const taskId = modal.getAttribute('data-current-task-id');

            if (!taskId) {
                alert('Keine Task-ID gefunden!');
                return;
            }

            // Close the current modal
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            }

            // Redirect to edit page
            window.location.href = `/loomline/aufgaben/${taskId}/bearbeiten/`;
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Subcard flip behavior initialized');

    // Wait for DOM to be fully ready
    setTimeout(() => {
        const subcardContainers = document.querySelectorAll('.subcards-container');
        console.log('üì¶ Setting up', subcardContainers.length, 'subcard containers');

        subcardContainers.forEach((container, index) => {
            const subcardCount = container.querySelectorAll('.subcard-wrapper').length;
            console.log('üìä Container', index, 'has', subcardCount, 'subcards');

            // Karten sind immer sichtbar nebeneinander - Flex-Layout bleibt aktiv
            // Keine Positionierungs√§nderungen mehr n√∂tig

            // Card hover events - Karten flippen beim Hover wie die Haupt-Cards
            const subcards = container.querySelectorAll('.subcard');
            subcards.forEach((card, cardIndex) => {
                // Hover-Events sind jetzt immer aktiv
                card.addEventListener('mouseenter', function() {
                    // Nur flippen wenn die Karte sichtbar ist
                    const wrapper = this.closest('.subcard-wrapper');
                    const isVisible = !wrapper.classList.contains('hidden-card') ||
                                      container.classList.contains('expanded');
                    if (isVisible) {
                        console.log('üîÑ Card', cardIndex, 'FLIP');
                        this.classList.add('flipped');
                    }
                });

                card.addEventListener('mouseleave', function() {
                    console.log('üîÑ Card', cardIndex, 'FLIP OUT');
                    // Karte zur√ºckdrehen
                    this.classList.remove('flipped');
                });
            });
        });
    }, 500);
});

</script>
{% endblock %}