{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Projekt bearbeiten{% else %}Neues Projekt erstellen{% endif %} - LoomLine
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0" style="background: red; color: white; padding: 10px;">
                        <i class="fas fa-project-diagram me-2"></i>
                        üî• TEMPLATE UPDATED! TINYMCE LOADING... üî• {% if form.instance.pk %}Projekt bearbeiten{% else %}Neues SEO Projekt erstellen{% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger" role="alert">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                Project Name <span class="text-danger">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.name.errors.0 }}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Choose a descriptive name for your SEO project</small>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                Description
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.description.errors.0 }}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Provide details about your project goals and scope</small>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.domain.id_for_label }}" class="form-label">
                                Domain/Website
                            </label>
                            {{ form.domain }}
                            {% if form.domain.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.domain.errors.0 }}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">The website you're tracking SEO for (e.g., example.com)</small>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.target_keywords.id_for_label }}" class="form-label">
                                Target Keywords
                            </label>
                            {{ form.target_keywords }}
                            {% if form.target_keywords.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.target_keywords.errors.0 }}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Comma-separated list of primary keywords to track</small>
                        </div>

                        {% if not form.instance.pk %}
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="shareWithTeam" name="share_with_team">
                                <label class="form-check-label" for="shareWithTeam">
                                    Share with team members after creation
                                </label>
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'loomline:dashboard' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                {% if form.instance.pk %}Save Changes{% else %}Create Project{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>


            {% if form.instance.pk %}
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="text-muted">Project Information</h6>
                    <small>
                        <strong>Created:</strong> {{ form.instance.created_at|date:"M d, Y H:i" }}<br>
                        <strong>Owner:</strong> {{ form.instance.owner.get_full_name|default:form.instance.owner.username }}<br>
                        <strong>Members:</strong> {{ form.instance.members.count }} member{{ form.instance.members.count|pluralize }}
                    </small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Simple Rich Text Editor -->
<style>
.simple-editor {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background: white;
}
.editor-toolbar {
    border-bottom: 1px solid #dee2e6;
    padding: 8px;
    background: #f8f9fa;
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}
.editor-btn {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}
.editor-btn:hover {
    background: #e9ecef;
}
.editor-content {
    min-height: 200px;
    padding: 12px;
    outline: none;
}
.editor-content img {
    max-width: 100%;
    height: auto;
    margin: 10px 0;
    cursor: move;
    border: 2px solid transparent;
    transition: border 0.3s;
}
.editor-content img:hover {
    border: 2px solid #007bff;
}
.editor-content img.selected {
    border: 2px solid #007bff;
    box-shadow: 0 0 0 1px rgba(0,123,255,0.25);
}
.editor-separator {
    width: 1px;
    height: 20px;
    background: #dee2e6;
    margin: 0 4px;
}
.size-select {
    padding: 4px 8px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background: white;
    font-size: 14px;
    cursor: pointer;
}
.size-select:hover {
    background: #e9ecef;
}
.image-resize-popup {
    position: absolute;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    display: none;
    z-index: 1000;
}
.image-resize-popup.show {
    display: block;
}
.resize-btn {
    padding: 4px 8px;
    margin: 2px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
}
.resize-btn:hover {
    background: #007bff;
    color: white;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const descriptionTextarea = document.querySelector('textarea[name="description"]');
    if (!descriptionTextarea) return;

    // Verstecke das originale Textarea
    descriptionTextarea.style.display = 'none';

    // Erstelle den Editor
    const editorHTML = `
        <div class="simple-editor">
            <div class="editor-toolbar">
                <select class="size-select" id="fontSize" title="Textgr√∂√üe">
                    <option value="">Normal</option>
                    <option value="1">Klein</option>
                    <option value="3">Mittel</option>
                    <option value="5">Gro√ü</option>
                    <option value="7">Sehr gro√ü</option>
                </select>
                <div class="editor-separator"></div>
                <button type="button" class="editor-btn" data-command="bold" title="Fett">
                    <strong>B</strong>
                </button>
                <button type="button" class="editor-btn" data-command="italic" title="Kursiv">
                    <em>I</em>
                </button>
                <button type="button" class="editor-btn" data-command="underline" title="Unterstrichen">
                    <u>U</u>
                </button>
                <div class="editor-separator"></div>
                <button type="button" class="editor-btn" data-command="insertUnorderedList" title="Aufz√§hlungsliste">
                    ‚Ä¢ ‚Äî
                </button>
                <div class="editor-separator"></div>
                <button type="button" class="editor-btn" data-command="createLink" title="Link einf√ºgen">
                    üîó
                </button>
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                <button type="button" class="editor-btn" id="imageBtn" title="Bild hochladen">
                    üñºÔ∏è Bild
                </button>
                <div class="editor-separator"></div>
                <button type="button" class="editor-btn" data-command="removeFormat" title="Formatierung entfernen">
                    ‚úñÔ∏è
                </button>
            </div>
            <div class="editor-content" contenteditable="true" data-placeholder="Projektbeschreibung eingeben...">
                ${descriptionTextarea.value || ''}
            </div>
            <div class="image-resize-popup" id="imageResizePopup">
                <button class="resize-btn" data-size="25">25%</button>
                <button class="resize-btn" data-size="50">50%</button>
                <button class="resize-btn" data-size="75">75%</button>
                <button class="resize-btn" data-size="100">100%</button>
                <button class="resize-btn" data-size="original">Original</button>
            </div>
        </div>
    `;

    // F√ºge den Editor nach dem Textarea ein
    descriptionTextarea.insertAdjacentHTML('afterend', editorHTML);

    const editorContent = document.querySelector('.editor-content');
    const buttons = document.querySelectorAll('.editor-btn[data-command]');
    const imageBtn = document.getElementById('imageBtn');
    const imageUpload = document.getElementById('imageUpload');
    const fontSize = document.getElementById('fontSize');
    const imageResizePopup = document.getElementById('imageResizePopup');
    let selectedImage = null;

    // Textgr√∂√üe Handler
    fontSize.addEventListener('change', () => {
        const size = fontSize.value;
        if (size) {
            document.execCommand('fontSize', false, size);
        }
        editorContent.focus();
    });

    // Button Click Handler
    buttons.forEach(button => {
        button.addEventListener('click', () => {
            const command = button.dataset.command;

            if (command === 'createLink') {
                const url = prompt('URL eingeben:', 'https://');
                if (url) {
                    document.execCommand(command, false, url);
                }
            } else {
                document.execCommand(command, false, null);
            }

            editorContent.focus();
        });
    });

    // Bild-Klick Handler f√ºr Gr√∂√üen√§nderung
    editorContent.addEventListener('click', (e) => {
        if (e.target.tagName === 'IMG') {
            // Entferne vorherige Auswahl
            document.querySelectorAll('.editor-content img').forEach(img => {
                img.classList.remove('selected');
            });

            // Markiere aktuelles Bild
            e.target.classList.add('selected');
            selectedImage = e.target;

            // Zeige Resize-Popup
            const rect = e.target.getBoundingClientRect();
            const editorRect = editorContent.getBoundingClientRect();
            imageResizePopup.style.left = (rect.left - editorRect.left) + 'px';
            imageResizePopup.style.top = (rect.bottom - editorRect.top + 5) + 'px';
            imageResizePopup.classList.add('show');
        } else {
            // Verstecke Popup wenn woanders geklickt
            imageResizePopup.classList.remove('show');
            document.querySelectorAll('.editor-content img').forEach(img => {
                img.classList.remove('selected');
            });
            selectedImage = null;
        }
    });

    // Bildgr√∂√üen-Buttons
    document.querySelectorAll('.resize-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!selectedImage) return;

            const size = btn.dataset.size;
            if (size === 'original') {
                selectedImage.style.width = '';
                selectedImage.style.maxWidth = '100%';
            } else {
                selectedImage.style.width = size + '%';
                selectedImage.style.maxWidth = size + '%';
            }

            // Verstecke Popup
            imageResizePopup.classList.remove('show');
            selectedImage.classList.remove('selected');
            selectedImage = null;
        });
    });

    // Bild Upload Handler
    imageBtn.addEventListener('click', () => {
        imageUpload.click();
    });

    imageUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        // Zeige Ladeanzeige
        const loadingText = '<p style="color: #6c757d;">Bild wird hochgeladen...</p>';
        document.execCommand('insertHTML', false, loadingText);

        fetch('/loomline/upload-image/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.location) {
                // Ersetze Ladetext mit Bild
                editorContent.innerHTML = editorContent.innerHTML.replace(
                    '<p style="color: #6c757d;">Bild wird hochgeladen...</p>',
                    `<img src="${result.location}" alt="${file.name}">`
                );
            } else {
                alert('Bildupload fehlgeschlagen');
                editorContent.innerHTML = editorContent.innerHTML.replace(
                    '<p style="color: #6c757d;">Bild wird hochgeladen...</p>',
                    ''
                );
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            alert('Bildupload fehlgeschlagen');
            editorContent.innerHTML = editorContent.innerHTML.replace(
                '<p style="color: #6c757d;">Bild wird hochgeladen...</p>',
                ''
            );
        });

        // Reset file input
        imageUpload.value = '';
    });

    // Synchronisiere Editor-Inhalt mit Textarea vor dem Absenden
    const form = descriptionTextarea.closest('form');
    if (form) {
        form.addEventListener('submit', () => {
            descriptionTextarea.value = editorContent.innerHTML;
        });
    }

    // Synchronisiere auch bei jeder √Ñnderung
    editorContent.addEventListener('input', () => {
        descriptionTextarea.value = editorContent.innerHTML;
    });
});
</script>

{% endblock %}

{% block page_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add Bootstrap classes to form fields
    const formFields = document.querySelectorAll('input[type="text"], input[type="url"]');
    formFields.forEach(field => {
        if (!field.classList.contains('form-control')) {
            field.classList.add('form-control');
        }
    });

    // Auto-format domain input
    const domainInput = document.querySelector('input[name="domain"]');
    if (domainInput) {
        domainInput.addEventListener('blur', function() {
            let value = this.value.trim();
            if (value && !value.startsWith('http')) {
                value = value.replace(/^(https?:\/\/)?(www\.)?/, '');
                this.value = value;
            }
        });
    }
});
</script>
{% endblock %}