{% extends "base.html" %}

{% block title %}{{ project.name }} - Timeline{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">{{ project.name }}</h1>
                    {% if project.domain %}
                    <p class="text-muted mb-0">
                        <i class="fas fa-globe me-2"></i>{{ project.domain }}
                    </p>
                    {% endif %}
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>Ersteller: {{ project.owner.username }}
                            {% if project.members.count > 0 %}
                            • <i class="fas fa-users me-1"></i>{{ project.members.count }} Mitglied{{ project.members.count|pluralize:"er" }}
                            {% endif %}
                        </small>
                    </div>
                </div>
                <a href="{% url 'loomline:project-list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Zurück
                </a>
            </div>
            {% if project.description %}
            <div class="mt-3">{{ project.description|safe }}</div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Linke Spalte: Aufgaben + Mitglieder -->
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">✅ Neue Aufgabe hinzufügen</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'loomline:add-task' project.pk %}">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="{{ task_form.title.id_for_label }}" class="form-label fw-bold">
                                Was wurde erledigt?
                            </label>
                            {{ task_form.title }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ task_form.description.id_for_label }}" class="form-label">
                                Details (optional)
                            </label>
                            {{ task_form.description }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ task_form.completed_at.id_for_label }}" class="form-label">
                                Erledigt am
                            </label>
                            {{ task_form.completed_at }}
                            <div class="form-text">Leer lassen für "jetzt"</div>
                        </div>

                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-plus me-2"></i>Aufgabe hinzufügen
                        </button>
                    </form>
                </div>
            </div>

            <!-- Mitglieder-Verwaltung (nur für Owner) -->
            {% if can_edit %}
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">👥 Mitglieder verwalten</h5>
                </div>
                <div class="card-body">
                    <!-- Aktuelle Mitglieder anzeigen -->
                    {% if project.members.count > 0 %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Aktuelle Mitglieder:</h6>
                        {% for member in project.members.all %}
                        <div class="d-flex justify-content-between align-items-center py-1">
                            <span><i class="fas fa-user me-2"></i>{{ member.username }}</span>
                            <a href="{% url 'loomline:remove-member' project.pk member.pk %}"
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('{{ member.username }} wirklich entfernen?')">
                                <i class="fas fa-times"></i>
                            </a>
                        </div>
                        {% endfor %}
                        <hr>
                    </div>
                    {% endif %}

                    <!-- Neues Mitglied hinzufügen -->
                    <form method="post" action="{% url 'loomline:add-member' project.pk %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="{{ add_member_form.username.id_for_label }}" class="form-label">
                                Nutzer hinzufügen
                            </label>
                            {{ add_member_form.username }}
                            {% if add_member_form.username.help_text %}
                            <div class="form-text">{{ add_member_form.username.help_text }}</div>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm w-100">
                            <i class="fas fa-user-plus me-2"></i>Hinzufügen
                        </button>
                    </form>
                </div>
            </div>
            {% else %}
            <!-- Mitglieder anzeigen (für Members) -->
            {% if project.members.count > 0 %}
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">👥 Projektmitglieder</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <i class="fas fa-crown me-2 text-warning"></i>{{ project.owner.username }} <small class="text-muted">(Ersteller)</small>
                    </div>
                    {% for member in project.members.all %}
                    <div class="mb-1">
                        <i class="fas fa-user me-2"></i>{{ member.username }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>

        <!-- Timeline / Feed -->
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0">📋 Projekt-Timeline ({{ tasks.count }} Aufgaben)</h5>
                <a href="{% url 'loomline:tasks-tiles' %}?project={{ project.id }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-th me-1"></i>Kachelansicht
                </a>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    {% if tasks %}
                        <div class="timeline">
                            {% for task in tasks %}
                            <div class="timeline-item mb-4 pb-4 border-bottom">
                                <div class="d-flex align-items-start">
                                    <div class="timeline-icon me-3 mt-1">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-2 fw-bold">{{ task.title }}</h6>
                                        {% if task.description %}
                                        <p class="mb-2 text-muted">{{ task.description }}</p>
                                        {% endif %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="fas fa-user me-1"></i>{{ task.completed_by.first_name|default:task.completed_by.username }}
                                            </small>
                                            <small class="text-muted">
                                                <i class="fas fa-clock me-1"></i>{{ task.completed_at|date:"d.m.Y H:i" }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list fa-4x text-muted mb-4"></i>
                            <h5 class="text-muted">Noch keine Aufgaben eingetragen</h5>
                            <p class="text-muted">Fügen Sie Ihre ersten erledigten Aufgaben hinzu.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline-item:last-child {
    border-bottom: none !important;
}

.timeline-icon {
    width: 24px;
    text-align: center;
}
</style>

<!-- Simple Rich Text Editor für Aufgaben -->
<style>
.simple-editor {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background: white;
}
.editor-toolbar {
    border-bottom: 1px solid #dee2e6;
    padding: 8px;
    background: #f8f9fa;
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}
.editor-btn {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}
.editor-btn:hover {
    background: #e9ecef;
}
.editor-content {
    min-height: 100px;
    padding: 12px;
    outline: none;
}
.editor-content img {
    max-width: 100%;
    height: auto;
    margin: 10px 0;
    cursor: move;
    border: 2px solid transparent;
}
.editor-content img:hover {
    border: 2px solid #007bff;
}
.editor-content img.selected {
    border: 2px solid #007bff;
    box-shadow: 0 0 0 1px rgba(0,123,255,0.25);
}
.editor-separator {
    width: 1px;
    height: 20px;
    background: #dee2e6;
    margin: 0 4px;
}
.size-select {
    padding: 4px 8px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background: white;
    font-size: 14px;
    cursor: pointer;
}
.image-resize-popup {
    position: absolute;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    display: none;
    z-index: 1000;
}
.image-resize-popup.show {
    display: block;
}
.resize-btn {
    padding: 4px 8px;
    margin: 2px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
}
.resize-btn:hover {
    background: #007bff;
    color: white;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const descriptionTextarea = document.querySelector('textarea[name="description"]');
    if (!descriptionTextarea) return;

    // Verstecke das originale Textarea
    descriptionTextarea.style.display = 'none';

    // Erstelle den Editor
    const editorHTML = `
        <div class="simple-editor">
            <div class="editor-toolbar">
                <select class="size-select" id="fontSize-${Math.random().toString(36).substr(2, 9)}" title="Textgröße">
                    <option value="">Normal</option>
                    <option value="1">Klein</option>
                    <option value="3">Mittel</option>
                    <option value="5">Groß</option>
                    <option value="7">Sehr groß</option>
                </select>
                <div class="editor-separator"></div>
                <button type="button" class="editor-btn" data-command="bold" title="Fett">
                    <strong>B</strong>
                </button>
                <button type="button" class="editor-btn" data-command="italic" title="Kursiv">
                    <em>I</em>
                </button>
                <button type="button" class="editor-btn" data-command="underline" title="Unterstrichen">
                    <u>U</u>
                </button>
                <div class="editor-separator"></div>
                <button type="button" class="editor-btn" data-command="insertUnorderedList" title="Aufzählungsliste">
                    • —
                </button>
                <div class="editor-separator"></div>
                <button type="button" class="editor-btn" data-command="createLink" title="Link einfügen">
                    🔗
                </button>
                <input type="file" id="imageUpload-${Math.random().toString(36).substr(2, 9)}" accept="image/*" style="display: none;">
                <button type="button" class="editor-btn" id="imageBtn-${Math.random().toString(36).substr(2, 9)}" title="Bild hochladen">
                    🖼️ Bild
                </button>
                <div class="editor-separator"></div>
                <button type="button" class="editor-btn" data-command="removeFormat" title="Formatierung entfernen">
                    ✖️
                </button>
            </div>
            <div class="editor-content" contenteditable="true" data-placeholder="Details eingeben...">
                ${descriptionTextarea.value || ''}
            </div>
            <div class="image-resize-popup" id="imageResizePopup-${Math.random().toString(36).substr(2, 9)}">
                <button class="resize-btn" data-size="25">25%</button>
                <button class="resize-btn" data-size="50">50%</button>
                <button class="resize-btn" data-size="75">75%</button>
                <button class="resize-btn" data-size="100">100%</button>
                <button class="resize-btn" data-size="original">Original</button>
            </div>
        </div>
    `;

    // Füge den Editor nach dem Textarea ein
    descriptionTextarea.insertAdjacentHTML('afterend', editorHTML);

    const editorContainer = descriptionTextarea.nextElementSibling;
    const editorContent = editorContainer.querySelector('.editor-content');
    const buttons = editorContainer.querySelectorAll('.editor-btn[data-command]');
    const imageBtn = editorContainer.querySelector('button[id^="imageBtn"]');
    const imageUpload = editorContainer.querySelector('input[id^="imageUpload"]');
    const fontSize = editorContainer.querySelector('select[id^="fontSize"]');
    const imageResizePopup = editorContainer.querySelector('div[id^="imageResizePopup"]');
    let selectedImage = null;

    // Textgröße Handler
    if (fontSize) {
        fontSize.addEventListener('change', () => {
            const size = fontSize.value;
            if (size) {
                document.execCommand('fontSize', false, size);
            }
            editorContent.focus();
        });
    }

    // Button Click Handler
    buttons.forEach(button => {
        button.addEventListener('click', () => {
            const command = button.dataset.command;

            if (command === 'createLink') {
                const url = prompt('URL eingeben:', 'https://');
                if (url) {
                    document.execCommand(command, false, url);
                }
            } else {
                document.execCommand(command, false, null);
            }

            editorContent.focus();
        });
    });

    // Bild-Klick Handler für Größenänderung
    if (editorContent) {
        editorContent.addEventListener('click', (e) => {
            if (e.target.tagName === 'IMG') {
                // Entferne vorherige Auswahl
                editorContent.querySelectorAll('img').forEach(img => {
                    img.classList.remove('selected');
                });

                // Markiere aktuelles Bild
                e.target.classList.add('selected');
                selectedImage = e.target;

                // Zeige Resize-Popup
                if (imageResizePopup) {
                    const rect = e.target.getBoundingClientRect();
                    const editorRect = editorContent.getBoundingClientRect();
                    imageResizePopup.style.left = (rect.left - editorRect.left) + 'px';
                    imageResizePopup.style.top = (rect.bottom - editorRect.top + 5) + 'px';
                    imageResizePopup.classList.add('show');
                }
            } else {
                // Verstecke Popup wenn woanders geklickt
                if (imageResizePopup) {
                    imageResizePopup.classList.remove('show');
                }
                editorContent.querySelectorAll('img').forEach(img => {
                    img.classList.remove('selected');
                });
                selectedImage = null;
            }
        });
    }

    // Bildgrößen-Buttons
    if (imageResizePopup) {
        imageResizePopup.querySelectorAll('.resize-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!selectedImage) return;

                const size = btn.dataset.size;
                if (size === 'original') {
                    selectedImage.style.width = '';
                    selectedImage.style.maxWidth = '100%';
                } else {
                    selectedImage.style.width = size + '%';
                    selectedImage.style.maxWidth = size + '%';
                }

                // Verstecke Popup
                imageResizePopup.classList.remove('show');
                selectedImage.classList.remove('selected');
                selectedImage = null;
            });
        });
    }

    // Bild Upload Handler
    if (imageBtn && imageUpload) {
        imageBtn.addEventListener('click', () => {
            imageUpload.click();
        });
    }

    if (imageUpload) {
        imageUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            // Zeige Ladeanzeige
            const loadingText = '<p style="color: #6c757d;">Bild wird hochgeladen...</p>';
            document.execCommand('insertHTML', false, loadingText);

            fetch('/loomline/upload-image/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.location) {
                    // Ersetze Ladetext mit Bild
                    editorContent.innerHTML = editorContent.innerHTML.replace(
                        '<p style="color: #6c757d;">Bild wird hochgeladen...</p>',
                        `<img src="${result.location}" alt="${file.name}">`
                    );
                } else {
                    alert('Bildupload fehlgeschlagen');
                    editorContent.innerHTML = editorContent.innerHTML.replace(
                        '<p style="color: #6c757d;">Bild wird hochgeladen...</p>',
                        ''
                    );
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('Bildupload fehlgeschlagen');
                editorContent.innerHTML = editorContent.innerHTML.replace(
                    '<p style="color: #6c757d;">Bild wird hochgeladen...</p>',
                    ''
                );
            });

            // Reset file input
            imageUpload.value = '';
        });
    }

    // Synchronisiere Editor-Inhalt mit Textarea vor dem Absenden
    const form = descriptionTextarea.closest('form');
    if (form) {
        form.addEventListener('submit', () => {
            descriptionTextarea.value = editorContent.innerHTML;
        });
    }

    // Synchronisiere auch bei jeder Änderung
    editorContent.addEventListener('input', () => {
        descriptionTextarea.value = editorContent.innerHTML;
    });
});
</script>
{% endblock %}