{% extends 'base.html' %}
{% load humanize %}

{% block title %}Speicherpläne - {{ block.super }}{% endblock %}

{% block content %}
<style>
    .storage-plan-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
    }

    .storage-plan-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    .plan-popular {
        position: relative;
        border: 2px solid #0d6efd !important;
    }

    .plan-popular::before {
        content: "⭐ EMPFOHLEN";
        position: absolute;
        top: -1px;
        right: -1px;
        background: #0d6efd;
        color: white;
        padding: 5px 15px;
        font-size: 0.75rem;
        font-weight: bold;
        border-bottom-left-radius: 8px;
        z-index: 1;
    }

    .billing-toggle {
        background: #f8f9fa;
        padding: 8px;
        border-radius: 50px;
        display: inline-flex;
        gap: 5px;
    }

    .billing-toggle input[type="radio"] {
        display: none;
    }

    .billing-toggle label {
        padding: 8px 20px;
        cursor: pointer;
        border-radius: 50px;
        transition: all 0.3s;
        margin: 0;
        font-weight: 500;
    }

    .billing-toggle input[type="radio"]:checked + label {
        background: #0d6efd;
        color: white;
        box-shadow: 0 2px 10px rgba(13,110,253,0.3);
    }

    .storage-meter {
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }

    .storage-meter-fill {
        height: 100%;
        transition: width 0.5s ease;
        background: linear-gradient(90deg, #28a745, #20c997);
    }

    .storage-meter-fill.warning {
        background: linear-gradient(90deg, #ffc107, #fd7e14);
    }

    .storage-meter-fill.danger {
        background: linear-gradient(90deg, #dc3545, #c82333);
    }

    .price-save {
        display: inline-block;
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        margin-left: 5px;
    }
</style>

<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-4 fw-bold mb-2">
                <i class="fas fa-database text-primary"></i> Speicherpläne
            </h1>
            <p class="lead text-muted">Wählen Sie den Plan, der zu Ihnen passt</p>
        </div>
    </div>

    <!-- Current Usage Card -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <h5 class="mb-3">
                                <i class="fas fa-chart-pie text-primary"></i>
                                Ihr aktueller Speicher
                                {% if storage_subscription %}
                                    <span class="badge bg-primary">{{ storage_subscription.plan.name }}</span>
                                {% else %}
                                    <span class="badge bg-success">Kostenlos (100MB)</span>
                                {% endif %}
                            </h5>

                            <div class="storage-meter mb-2">
                                <div class="storage-meter-fill {% if usage_percentage >= 90 %}danger{% elif usage_percentage >= 75 %}warning{% endif %}"
                                     style="width: {{ usage_percentage }}%;">
                                </div>
                            </div>

                            <div class="d-flex justify-content-between text-muted small">
                                <span>
                                    <strong class="text-dark">{{ used_storage_mb|floatformat:1 }} MB</strong> verwendet
                                </span>
                                <span>
                                    <strong class="text-dark">{{ max_storage_mb|floatformat:0 }} MB</strong> verfügbar
                                </span>
                            </div>

                            {% if usage_percentage >= 75 %}
                            <div class="alert alert-{{ usage_percentage >= 90|yesno:'danger,warning' }} mt-3 mb-0">
                                <i class="fas fa-exclamation-triangle"></i>
                                {% if usage_percentage >= 90 %}
                                    <strong>Speicher fast voll!</strong> Erweitern Sie Ihren Plan oder löschen Sie ungenutzte Dateien.
                                {% else %}
                                    <strong>Achtung:</strong> Ihr Speicher ist zu {{ usage_percentage|floatformat:0 }}% belegt.
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-lg-4 text-center mt-3 mt-lg-0">
                            <div class="bg-light p-3 rounded">
                                <div class="display-6 fw-bold text-primary">
                                    {{ usage_percentage|floatformat:0 }}%
                                </div>
                                <small class="text-muted">Speicher genutzt</small>
                            </div>

                            {% if storage_subscription %}
                            <div class="mt-3">
                                <a href="{% url 'payments:customer_portal' %}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-cog"></i> Abo verwalten
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Billing Period Toggle -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <div class="billing-toggle">
                <input type="radio" name="billing" id="billingMonthly" value="month" checked>
                <label for="billingMonthly">Monatlich</label>

                <input type="radio" name="billing" id="billingYearly" value="year">
                <label for="billingYearly">
                    Jährlich
                    <span class="price-save">2 Monate sparen</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Storage Plans Grid -->
    <div class="row justify-content-center">
        <!-- Free Plan -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card storage-plan-card h-100 shadow-sm">
                <div class="card-header bg-success text-white text-center py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-gift"></i> Kostenlos
                    </h5>
                </div>
                <div class="card-body d-flex flex-column text-center">
                    <div class="mb-3">
                        <div class="display-4 fw-bold">0€</div>
                        <small class="text-muted">für immer</small>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-primary fw-bold">100 MB</h6>
                        <small class="text-muted">Speicherplatz</small>
                    </div>

                    <ul class="list-unstyled flex-grow-1 text-start">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Videos, Fileshare, Streamrec</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Community Support</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Basis-Features</li>
                    </ul>

                    <button class="btn btn-outline-success w-100 mt-auto" disabled>
                        <i class="fas fa-check"></i> Aktueller Plan
                    </button>
                    <small class="text-muted mt-2">Für alle Nutzer verfügbar</small>
                </div>
            </div>
        </div>

        <!-- 1GB Plan -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card storage-plan-card h-100 shadow-sm plan-monthly" data-billing="month">
                <div class="card-header bg-primary text-white text-center py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-star"></i> Starter
                    </h5>
                </div>
                <div class="card-body d-flex flex-column text-center">
                    <div class="mb-3">
                        <div class="display-4 fw-bold">2,99€</div>
                        <small class="text-muted">pro Monat</small>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-primary fw-bold">1 GB</h6>
                        <small class="text-muted">Speicherplatz</small>
                    </div>

                    <ul class="list-unstyled flex-grow-1 text-start">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>10x mehr Speicher</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>E-Mail Support</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Basis-Statistiken</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Jederzeit kündbar</li>
                    </ul>

                    <button onclick="selectPlan('1gb', 'month')" class="btn btn-primary w-100 mt-auto">
                        <i class="fas fa-shopping-cart"></i> Jetzt wählen
                    </button>
                </div>
            </div>

            <div class="card storage-plan-card h-100 shadow-sm plan-yearly" data-billing="year" style="display:none;">
                <div class="card-header bg-primary text-white text-center py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-star"></i> Starter
                    </h5>
                </div>
                <div class="card-body d-flex flex-column text-center">
                    <div class="mb-3">
                        <div class="display-4 fw-bold">29,90€</div>
                        <small class="text-muted">pro Jahr <span class="price-save">-17% sparen</span></small>
                        <div class="text-muted small mt-1">≈ 2,49€/Monat</div>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-primary fw-bold">1 GB</h6>
                        <small class="text-muted">Speicherplatz</small>
                    </div>

                    <ul class="list-unstyled flex-grow-1 text-start">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>10x mehr Speicher</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>E-Mail Support</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Basis-Statistiken</li>
                        <li class="mb-2"><i class="fas fa-crown text-warning me-2"></i><strong>2 Monate gratis</strong></li>
                    </ul>

                    <button onclick="selectPlan('1gb', 'year')" class="btn btn-primary w-100 mt-auto">
                        <i class="fas fa-shopping-cart"></i> Jetzt wählen
                    </button>
                </div>
            </div>
        </div>

        <!-- 3GB Plan (POPULAR) -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card storage-plan-card plan-popular h-100 shadow plan-monthly" data-billing="month">
                <div class="card-header bg-info text-white text-center py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> Pro
                    </h5>
                </div>
                <div class="card-body d-flex flex-column text-center">
                    <div class="mb-3">
                        <div class="display-4 fw-bold">4,99€</div>
                        <small class="text-muted">pro Monat</small>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-primary fw-bold">3 GB</h6>
                        <small class="text-muted">Speicherplatz</small>
                    </div>

                    <ul class="list-unstyled flex-grow-1 text-start">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>30x mehr Speicher</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>E-Mail Support</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Erweiterte Statistiken</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Höhere Upload-Priorität</li>
                    </ul>

                    <button onclick="selectPlan('3gb', 'month')" class="btn btn-info text-white w-100 mt-auto">
                        <i class="fas fa-shopping-cart"></i> Jetzt wählen
                    </button>
                </div>
            </div>

            <div class="card storage-plan-card plan-popular h-100 shadow plan-yearly" data-billing="year" style="display:none;">
                <div class="card-header bg-info text-white text-center py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> Pro
                    </h5>
                </div>
                <div class="card-body d-flex flex-column text-center">
                    <div class="mb-3">
                        <div class="display-4 fw-bold">49,90€</div>
                        <small class="text-muted">pro Jahr <span class="price-save">-17% sparen</span></small>
                        <div class="text-muted small mt-1">≈ 4,16€/Monat</div>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-primary fw-bold">3 GB</h6>
                        <small class="text-muted">Speicherplatz</small>
                    </div>

                    <ul class="list-unstyled flex-grow-1 text-start">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>30x mehr Speicher</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>E-Mail Support</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Erweiterte Statistiken</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Höhere Upload-Priorität</li>
                        <li class="mb-2"><i class="fas fa-crown text-warning me-2"></i><strong>2 Monate gratis</strong></li>
                    </ul>

                    <button onclick="selectPlan('3gb', 'year')" class="btn btn-info text-white w-100 mt-auto">
                        <i class="fas fa-shopping-cart"></i> Jetzt wählen
                    </button>
                </div>
            </div>
        </div>

        <!-- 5GB Plan -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card storage-plan-card h-100 shadow-sm plan-monthly" data-billing="month">
                <div class="card-header bg-warning text-dark text-center py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-building"></i> Business
                    </h5>
                </div>
                <div class="card-body d-flex flex-column text-center">
                    <div class="mb-3">
                        <div class="display-4 fw-bold">7,99€</div>
                        <small class="text-muted">pro Monat</small>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-primary fw-bold">5 GB</h6>
                        <small class="text-muted">Speicherplatz</small>
                    </div>

                    <ul class="list-unstyled flex-grow-1 text-start">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>50x mehr Speicher</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Prioritäts-Support</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Pro-Statistiken</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Höchste Priorität</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Custom Branding</li>
                    </ul>

                    <button onclick="selectPlan('5gb', 'month')" class="btn btn-warning w-100 mt-auto">
                        <i class="fas fa-shopping-cart"></i> Jetzt wählen
                    </button>
                </div>
            </div>

            <div class="card storage-plan-card h-100 shadow-sm plan-yearly" data-billing="year" style="display:none;">
                <div class="card-header bg-warning text-dark text-center py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-building"></i> Business
                    </h5>
                </div>
                <div class="card-body d-flex flex-column text-center">
                    <div class="mb-3">
                        <div class="display-4 fw-bold">79,90€</div>
                        <small class="text-muted">pro Jahr <span class="price-save">-17% sparen</span></small>
                        <div class="text-muted small mt-1">≈ 6,66€/Monat</div>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-primary fw-bold">5 GB</h6>
                        <small class="text-muted">Speicherplatz</small>
                    </div>

                    <ul class="list-unstyled flex-grow-1 text-start">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>50x mehr Speicher</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Prioritäts-Support</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Pro-Statistiken</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Höchste Priorität</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Custom Branding</li>
                        <li class="mb-2"><i class="fas fa-crown text-warning me-2"></i><strong>2 Monate gratis</strong></li>
                    </ul>

                    <button onclick="selectPlan('5gb', 'year')" class="btn btn-warning w-100 mt-auto">
                        <i class="fas fa-shopping-cart"></i> Jetzt wählen
                    </button>
                </div>
            </div>
        </div>

        <!-- 10GB Plan -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card storage-plan-card h-100 shadow-sm plan-monthly" data-billing="month">
                <div class="card-header bg-dark text-white text-center py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-crown"></i> Enterprise
                    </h5>
                </div>
                <div class="card-body d-flex flex-column text-center">
                    <div class="mb-3">
                        <div class="display-4 fw-bold">9,99€</div>
                        <small class="text-muted">pro Monat</small>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-primary fw-bold">10 GB</h6>
                        <small class="text-muted">Speicherplatz</small>
                    </div>

                    <ul class="list-unstyled flex-grow-1 text-start">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>100x mehr Speicher</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>VIP-Support</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Pro-Statistiken</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Full Custom Branding</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>API Zugriff</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Auto-Backups</li>
                    </ul>

                    <button onclick="selectPlan('10gb', 'month')" class="btn btn-dark w-100 mt-auto">
                        <i class="fas fa-shopping-cart"></i> Jetzt wählen
                    </button>
                </div>
            </div>

            <div class="card storage-plan-card h-100 shadow-sm plan-yearly" data-billing="year" style="display:none;">
                <div class="card-header bg-dark text-white text-center py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-crown"></i> Enterprise
                    </h5>
                </div>
                <div class="card-body d-flex flex-column text-center">
                    <div class="mb-3">
                        <div class="display-4 fw-bold">99,90€</div>
                        <small class="text-muted">pro Jahr <span class="price-save">-17% sparen</span></small>
                        <div class="text-muted small mt-1">≈ 8,33€/Monat</div>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-primary fw-bold">10 GB</h6>
                        <small class="text-muted">Speicherplatz</small>
                    </div>

                    <ul class="list-unstyled flex-grow-1 text-start">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>100x mehr Speicher</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>VIP-Support</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Pro-Statistiken</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Full Custom Branding</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>API Zugriff</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Auto-Backups</li>
                        <li class="mb-2"><i class="fas fa-crown text-warning me-2"></i><strong>2 Monate gratis</strong></li>
                    </ul>

                    <button onclick="selectPlan('10gb', 'year')" class="btn btn-dark w-100 mt-auto">
                        <i class="fas fa-shopping-cart"></i> Jetzt wählen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FAQ / Info -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <h5 class="mb-3 text-center">
                        <i class="fas fa-info-circle text-primary"></i> Wichtige Informationen
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Jederzeit kündbar - keine Mindestlaufzeit</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Sichere Zahlung via Stripe (Kreditkarte, SEPA)</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Sofortige Aktivierung nach Zahlung</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>DSGVO-konforme Datenspeicherung</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>24/7 Support verfügbar</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Upgrade/Downgrade jederzeit möglich</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Plan Selection Mapping (Size -> Stripe Price IDs)
const PLAN_IDS = {
    '1gb_month': null,  // Will be filled from backend
    '1gb_year': null,
    '3gb_month': null,
    '3gb_year': null,
    '5gb_month': null,
    '5gb_year': null,
    '10gb_month': null,
    '10gb_year': null,
};

// Billing Toggle Logic
document.querySelectorAll('input[name="billing"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const selectedBilling = this.value;

        // Hide all plans
        document.querySelectorAll('.plan-monthly, .plan-yearly').forEach(card => {
            card.style.display = 'none';
        });

        // Show selected billing period
        if (selectedBilling === 'month') {
            document.querySelectorAll('.plan-monthly').forEach(card => {
                card.style.display = 'block';
            });
        } else {
            document.querySelectorAll('.plan-yearly').forEach(card => {
                card.style.display = 'block';
            });
        }
    });
});

async function selectPlan(size, interval) {
    const planKey = `${size}_${interval}`;
    const planId = PLAN_IDS[planKey];

    if (!planId) {
        alert('Dieser Plan ist noch nicht verfügbar. Bitte kontaktieren Sie den Support.');
        return;
    }

    // Redirect to checkout
    try {
        const response = await fetch(`/payments/checkout/${planId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
        });

        const data = await response.json();

        if (data.checkout_url) {
            window.location.href = data.checkout_url;
        } else {
            alert('Fehler beim Erstellen der Checkout-Session: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Fehler beim Erstellen der Checkout-Session');
    }
}
</script>
{% endblock %}
