{% extends 'base.html' %}
{% load static %}

{% block title %}Meine Pins - IdeoPin{% endblock %}

{% block content %}
<style>
.pinterest-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #E60023;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    z-index: 10;
}
.pinterest-badge i {
    margin-right: 4px;
}
.card-img-top-wrapper {
    position: relative;
}
.btn-pinterest {
    background-color: #E60023;
    color: white;
    border: none;
}
.btn-pinterest:hover {
    background-color: #BD081C;
    color: white;
}
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-pinterest text-danger"></i> Meine Pinterest Pins
        </h1>
        <div>
            <a href="{% url 'ideopin:wizard_step1' %}" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Neuen Pin erstellen
            </a>
            <a href="{% url 'ideopin:settings' %}" class="btn btn-outline-secondary">
                <i class="bi bi-gear"></i>
            </a>
        </div>
    </div>

    {% if pinterest_connected %}
    <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
        <i class="bi bi-pinterest me-2"></i>
        <strong>Pinterest verbunden!</strong> Du kannst Pins direkt auf Pinterest posten.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    {% if total_count > 0 %}
    <!-- Filter-Buttons -->
    <div class="d-flex flex-wrap gap-2 mb-4">
        <a href="?filter=all" class="btn btn-sm {% if current_filter == 'all' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
            <i class="bi bi-collection me-1"></i> Alle ({{ total_count }})
        </a>
        <a href="?filter=posted" class="btn btn-sm {% if current_filter == 'posted' %}btn-danger{% else %}btn-outline-danger{% endif %}">
            <i class="bi bi-pinterest me-1"></i> Gepostet ({{ posted_count }})
        </a>
        <a href="?filter=not_posted" class="btn btn-sm {% if current_filter == 'not_posted' %}btn-warning{% else %}btn-outline-warning{% endif %}">
            <i class="bi bi-clock me-1"></i> Noch zu posten ({{ to_post_count }})
        </a>
        <a href="?filter=drafts" class="btn btn-sm {% if current_filter == 'drafts' %}btn-info{% else %}btn-outline-info{% endif %}">
            <i class="bi bi-pencil me-1"></i> Entwürfe ({{ drafts_count }})
        </a>
    </div>
    {% endif %}

    {% if projects %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for project in projects %}
        <div class="col">
            <div class="card h-100 shadow-sm">
                <div class="card-img-top-wrapper bg-light" style="height: 200px; overflow: hidden;">
                    {% if project.pinterest_posted %}
                        <span class="pinterest-badge">
                            <i class="bi bi-check-circle-fill"></i>Gepostet
                        </span>
                    {% endif %}
                    {% if project.final_image %}
                        <img src="{{ project.final_image.url }}" alt="Pin"
                             style="width: 100%; height: 100%; object-fit: cover;">
                    {% elif project.generated_image %}
                        <img src="{{ project.generated_image.url }}" alt="Pin"
                             style="width: 100%; height: 100%; object-fit: cover;">
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-image" style="font-size: 48px;"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <h6 class="card-title text-truncate" title="{{ project.keywords }}">
                        {{ project.keywords|truncatechars:40 }}
                    </h6>
                    {% if project.overlay_text %}
                    <p class="card-text small text-muted">
                        "{{ project.overlay_text|truncatechars:50 }}"
                    </p>
                    {% endif %}
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-{% if project.status == 'completed' %}success{% elif project.status == 'draft' %}secondary{% else %}primary{% endif %}">
                                {% if project.status == 'completed' %}
                                    <i class="bi bi-check-circle"></i> Fertig
                                {% elif project.status == 'draft' %}
                                    <i class="bi bi-pencil"></i> Entwurf
                                {% else %}
                                    <i class="bi bi-clock"></i> In Bearbeitung
                                {% endif %}
                            </span>
                            {% if project.pinterest_posted %}
                                <span class="badge bg-danger ms-1" title="Auf Pinterest gepostet am {{ project.pinterest_posted_at|date:'d.m.Y H:i' }}">
                                    <i class="bi bi-pinterest"></i>
                                </span>
                            {% endif %}
                        </div>
                        <small class="text-muted">{{ project.updated_at|date:"d.m.Y" }}</small>
                    </div>
                </div>
                <div class="card-footer bg-white border-top-0">
                    <div class="btn-group w-100 mb-2" role="group">
                        {% if project.status == 'completed' %}
                            <a href="{% url 'ideopin:wizard_result' project.id %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye"></i> Ansehen
                            </a>
                        {% else %}
                            <a href="{% url 'ideopin:wizard_step1_edit' project.id %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-pencil"></i> Bearbeiten
                            </a>
                        {% endif %}
                        <a href="{% url 'ideopin:project_duplicate' project.id %}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-copy"></i>
                        </a>
                        <form action="{% url 'ideopin:project_delete' project.id %}" method="post" class="d-inline"
                              onsubmit="return confirm('Pin wirklich löschen?');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                    {% if project.status == 'completed' %}
                        {% if project.pinterest_posted %}
                            <!-- Bereits gepostet -->
                            {% if project.pinterest_pin_id %}
                                <a href="https://www.pinterest.com/pin/{{ project.pinterest_pin_id }}/"
                                   target="_blank" class="btn btn-outline-danger btn-sm w-100 mb-1">
                                    <i class="bi bi-box-arrow-up-right me-1"></i>Auf Pinterest ansehen
                                </a>
                            {% else %}
                                <div class="text-center text-success small mb-1">
                                    <i class="bi bi-check-circle-fill"></i> Gepostet am {{ project.pinterest_posted_at|date:"d.m.Y" }}
                                </div>
                            {% endif %}
                            <button type="button" class="btn btn-outline-secondary btn-sm w-100"
                                    onclick="unmarkAsPosted({{ project.id }})">
                                <i class="bi bi-x-circle me-1"></i>Markierung entfernen
                            </button>
                        {% elif pinterest_connected %}
                            <!-- OAuth-basiertes Posting -->
                            <button type="button" class="btn btn-pinterest btn-sm w-100 mb-1"
                                    data-bs-toggle="modal" data-bs-target="#pinterestModal"
                                    data-project-id="{{ project.id }}"
                                    data-project-title="{{ project.keywords|truncatechars:30 }}">
                                <i class="bi bi-pinterest me-1"></i>Auf Pinterest posten
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm w-100"
                                    onclick="markAsPosted({{ project.id }})">
                                <i class="bi bi-check-circle me-1"></i>Als gepostet markieren
                            </button>
                        {% elif project.final_image %}
                            <!-- Pin It Button - mit final_image -->
                            <button type="button" class="btn btn-pinterest btn-sm w-100 mb-1"
                                    onclick="openPinterestShare('{{ project.final_image.url }}', '{{ project.pin_url|escapejs }}', '{{ project.seo_description|escapejs|truncatechars:480 }}')">
                                <i class="bi bi-pinterest me-1"></i>Auf Pinterest teilen
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm w-100"
                                    onclick="markAsPosted({{ project.id }})">
                                <i class="bi bi-check-circle me-1"></i>Als gepostet markieren
                            </button>
                        {% elif project.generated_image %}
                            <!-- Pin It Button - mit generated_image -->
                            <button type="button" class="btn btn-pinterest btn-sm w-100 mb-1"
                                    onclick="openPinterestShare('{{ project.generated_image.url }}', '{{ project.pin_url|escapejs }}', '{{ project.seo_description|escapejs|truncatechars:480 }}')">
                                <i class="bi bi-pinterest me-1"></i>Auf Pinterest teilen
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm w-100"
                                    onclick="markAsPosted({{ project.id }})">
                                <i class="bi bi-check-circle me-1"></i>Als gepostet markieren
                            </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="bi bi-pinterest text-muted" style="font-size: 64px;"></i>
        <h4 class="mt-3">Noch keine Pins erstellt</h4>
        <p class="text-muted">Erstelle deinen ersten Pinterest Pin mit KI-Unterstützung!</p>
        <a href="{% url 'ideopin:wizard_step1' %}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-lg"></i> Ersten Pin erstellen
        </a>
    </div>
    {% endif %}
</div>

{% if pinterest_connected %}
<!-- Pinterest Post Modal -->
<div class="modal fade" id="pinterestModal" tabindex="-1" aria-labelledby="pinterestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #E60023, #BD081C); color: white;">
                <h5 class="modal-title" id="pinterestModalLabel">
                    <i class="bi bi-pinterest me-2"></i>Auf Pinterest posten
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong>Pin:</strong> <span id="modal-project-title"></span></p>
                <div class="mb-3">
                    <label for="modal-board-select" class="form-label">Board auswählen:</label>
                    <select class="form-select" id="modal-board-select">
                        <option value="">Boards werden geladen...</option>
                    </select>
                </div>
                <div id="modal-result" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-pinterest" id="modal-post-btn" onclick="postPinFromModal()">
                    <i class="bi bi-pinterest me-1"></i>Jetzt posten
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentProjectId = null;
let boardsLoaded = false;

// Modal-Event-Handler
document.getElementById('pinterestModal').addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    currentProjectId = button.getAttribute('data-project-id');
    const projectTitle = button.getAttribute('data-project-title');

    document.getElementById('modal-project-title').textContent = projectTitle;
    document.getElementById('modal-result').style.display = 'none';
    document.getElementById('modal-post-btn').disabled = false;
    document.getElementById('modal-post-btn').innerHTML = '<i class="bi bi-pinterest me-1"></i>Jetzt posten';

    if (!boardsLoaded) {
        loadBoards();
    }
});

function loadBoards() {
    const select = document.getElementById('modal-board-select');
    select.innerHTML = '<option value="">Boards werden geladen...</option>';
    select.disabled = true;

    fetch('{% url "ideopin:api_pinterest_boards" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.boards) {
                select.innerHTML = '<option value="">Board auswählen...</option>';
                data.boards.forEach(board => {
                    const option = document.createElement('option');
                    option.value = board.id;
                    option.textContent = board.name + (board.pin_count ? ` (${board.pin_count} Pins)` : '');
                    select.appendChild(option);
                });
                select.disabled = false;
                boardsLoaded = true;
            } else {
                select.innerHTML = '<option value="">Fehler beim Laden</option>';
            }
        })
        .catch(error => {
            select.innerHTML = '<option value="">Netzwerkfehler</option>';
        });
}

function postPinFromModal() {
    const boardId = document.getElementById('modal-board-select').value;
    const resultDiv = document.getElementById('modal-result');
    const postBtn = document.getElementById('modal-post-btn');

    if (!boardId) {
        alert('Bitte wähle ein Board aus.');
        return;
    }

    postBtn.disabled = true;
    postBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Wird gepostet...';

    fetch(`/ideopin/api/pinterest/post/${currentProjectId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ board_id: boardId })
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';

        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i>Erfolgreich gepostet!
                    <a href="${data.pin_url}" target="_blank" class="d-block mt-2">Pin ansehen</a>
                </div>
            `;
            postBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Gepostet!';

            // Seite nach 2 Sekunden neu laden
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>${data.error}
                </div>
            `;
            postBtn.disabled = false;
            postBtn.innerHTML = '<i class="bi bi-pinterest me-1"></i>Erneut versuchen';
        }
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>Netzwerkfehler
            </div>
        `;
        postBtn.disabled = false;
        postBtn.innerHTML = '<i class="bi bi-pinterest me-1"></i>Erneut versuchen';
    });
}
</script>
{% endif %}

<!-- Pin It Funktion - funktioniert immer ohne API -->
<script>
function openPinterestShare(imageUrl, linkUrl, description) {
    // Vollständige Bild-URL erstellen
    const baseUrl = window.location.origin;
    const fullImageUrl = imageUrl.startsWith('http') ? imageUrl : baseUrl + imageUrl;

    // Pinterest Share URL erstellen
    const params = new URLSearchParams({
        url: linkUrl || window.location.href,
        media: fullImageUrl,
        description: description || ''
    });

    // Pinterest-Fenster öffnen
    const pinterestUrl = `https://www.pinterest.com/pin/create/button/?${params.toString()}`;
    window.open(pinterestUrl, 'pinterest-share', 'width=750,height=600,scrollbars=yes');
}

// Als gepostet markieren
async function markAsPosted(projectId) {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
        const response = await fetch(`/ideopin/api/pinterest/mark-posted/${projectId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        const data = await response.json();

        if (data.success) {
            window.location.reload();
        } else {
            alert('Fehler: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    } catch (e) {
        alert('Fehler: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

// Markierung entfernen
async function unmarkAsPosted(projectId) {
    if (!confirm('Markierung wirklich entfernen?')) return;

    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
        const response = await fetch(`/ideopin/api/pinterest/unmark-posted/${projectId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        const data = await response.json();

        if (data.success) {
            window.location.reload();
        } else {
            alert('Fehler: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    } catch (e) {
        alert('Fehler: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}
</script>
{% endblock %}
