{% extends 'ideopin/base_wizard.html' %}

{% block wizard_content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-tags"></i> Schritt 1: Keywords eingeben</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Gib die Keywords ein, die deinen Pinterest Pin beschreiben.
                    Diese werden für den Text-Overlay und die SEO-Beschreibung verwendet.
                </p>

                <form method="post">
                    {% csrf_token %}

                    <div class="mb-4">
                        <label for="{{ form.keywords.id_for_label }}" class="form-label fw-bold">
                            Keywords
                        </label>
                        <div class="input-group">
                            {{ form.keywords }}
                            <button type="button" class="btn btn-outline-primary" id="generateKeywordsBtn" title="Verwandte Keywords generieren">
                                <i class="bi bi-magic"></i> Keywords erweitern
                            </button>
                        </div>
                        <div class="form-text">
                            Tipp: Gib ein Haupt-Keyword ein und klicke auf "Keywords erweitern" für weitere Vorschläge mit hohem Suchvolumen.
                        </div>
                    </div>

                    <!-- Keyword Suggestions -->
                    <div id="keywordSuggestions" class="mb-4" style="display: none;">
                        <label class="form-label fw-bold text-success">
                            <i class="bi bi-lightbulb"></i> Vorgeschlagene Keywords
                        </label>
                        <div id="keywordTags" class="d-flex flex-wrap gap-2">
                            <!-- Keywords werden hier eingefügt -->
                        </div>
                        <div class="form-text mt-2">
                            Klicke auf ein Keyword, um es hinzuzufügen.
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'ideopin:project_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg"></i> Abbrechen
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            Weiter <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block wizard_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateKeywordsBtn');
    const keywordsInput = document.getElementById('{{ form.keywords.id_for_label }}');
    const suggestionsDiv = document.getElementById('keywordSuggestions');
    const keywordTagsDiv = document.getElementById('keywordTags');

    // Set um bereits angezeigte Vorschläge zu tracken
    const shownSuggestions = new Set();

    generateBtn.addEventListener('click', async function() {
        const currentKeywords = keywordsInput.value.trim();

        if (!currentKeywords) {
            alert('Bitte zuerst ein Keyword eingeben.');
            return;
        }

        // Alle Keywords für mehr Variation verwenden
        const allKeywords = currentKeywords.split(',').map(k => k.trim()).filter(k => k);
        // Zufälliges Keyword als Seed wählen (für Variation bei wiederholtem Klicken)
        const seedKeyword = allKeywords[Math.floor(Math.random() * allKeywords.length)];

        // Button deaktivieren und Ladeanzeige
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generiere...';

        try {
            const response = await fetch('{% url "ideopin:api_generate_keywords" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    keyword: seedKeyword,
                    existing_keywords: allKeywords  // Bestehende Keywords mitschicken
                })
            });

            const data = await response.json();

            if (data.success && data.keywords) {
                addKeywordSuggestions(data.keywords);
            } else {
                alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Fehler beim Generieren der Keywords.');
        } finally {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="bi bi-magic"></i> Keywords erweitern';
        }
    });

    function addKeywordSuggestions(keywords) {
        // Aktuelle Keywords als Set für Duplikat-Prüfung
        const currentKeywords = new Set(
            keywordsInput.value.toLowerCase().split(',').map(k => k.trim()).filter(k => k)
        );

        let addedCount = 0;

        keywords.forEach(keyword => {
            const keywordLower = keyword.toLowerCase();

            // Überspringen wenn bereits in Vorschlägen angezeigt oder bereits als Keyword hinzugefügt
            if (shownSuggestions.has(keywordLower)) {
                // Nur Status aktualisieren falls bereits hinzugefügt
                updateTagStatus(keywordLower, currentKeywords.has(keywordLower));
                return;
            }

            const isAlreadyAdded = currentKeywords.has(keywordLower);
            shownSuggestions.add(keywordLower);

            const tag = document.createElement('button');
            tag.type = 'button';
            tag.className = `btn btn-sm ${isAlreadyAdded ? 'btn-secondary' : 'btn-outline-success'}`;
            tag.textContent = keyword;
            tag.disabled = isAlreadyAdded;
            tag.dataset.keyword = keywordLower;

            if (!isAlreadyAdded) {
                tag.addEventListener('click', function() {
                    addKeyword(keyword);
                    tag.className = 'btn btn-sm btn-secondary';
                    tag.disabled = true;
                });
            }

            keywordTagsDiv.appendChild(tag);
            addedCount++;
        });

        suggestionsDiv.style.display = 'block';

        // Info wenn keine neuen Keywords gefunden wurden
        if (addedCount === 0) {
            // Kurze Meldung anzeigen
            const infoMsg = document.createElement('span');
            infoMsg.className = 'badge bg-info ms-2';
            infoMsg.textContent = 'Keine neuen Vorschläge';
            infoMsg.id = 'noNewSuggestionsMsg';

            // Entfernen nach 2 Sekunden
            const existingMsg = document.getElementById('noNewSuggestionsMsg');
            if (existingMsg) existingMsg.remove();

            keywordTagsDiv.appendChild(infoMsg);
            setTimeout(() => infoMsg.remove(), 2000);
        }
    }

    function updateTagStatus(keywordLower, isAdded) {
        const tags = keywordTagsDiv.querySelectorAll('button');
        tags.forEach(tag => {
            if (tag.dataset.keyword === keywordLower && isAdded) {
                tag.className = 'btn btn-sm btn-secondary';
                tag.disabled = true;
            }
        });
    }

    function addKeyword(keyword) {
        const currentValue = keywordsInput.value.trim();
        if (currentValue) {
            keywordsInput.value = currentValue + ', ' + keyword;
        } else {
            keywordsInput.value = keyword;
        }
    }
});
</script>
{% endblock %}
