{% extends 'ideopin/base_wizard.html' %}

{% block wizard_content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-tags"></i> Schritt 1: Keywords eingeben</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Gib die Keywords ein, die deinen Pinterest Pin beschreiben.
                    Diese werden für den Text-Overlay und die SEO-Beschreibung verwendet.
                </p>

                <form method="post">
                    {% csrf_token %}

                    <div class="mb-4">
                        <label for="{{ form.keywords.id_for_label }}" class="form-label fw-bold">
                            Keywords
                        </label>
                        <div class="input-group">
                            {{ form.keywords }}
                            <button type="button" class="btn btn-outline-secondary" id="keywordHistoryBtn" title="Frühere Keywords anzeigen">
                                <i class="bi bi-clock-history"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="generateKeywordsBtn" title="Verwandte Keywords generieren">
                                <i class="bi bi-magic"></i> Keywords erweitern
                            </button>
                        </div>
                        <div class="form-text">
                            Tipp: Gib ein Haupt-Keyword ein und klicke auf "Keywords erweitern" für weitere Vorschläge mit hohem Suchvolumen.
                        </div>
                    </div>

                    <!-- Keyword Suggestions -->
                    <div id="keywordSuggestions" class="mb-4" style="display: none;">
                        <label class="form-label fw-bold text-success">
                            <i class="bi bi-lightbulb"></i> Vorgeschlagene Keywords
                        </label>
                        <div id="keywordTags" class="d-flex flex-wrap gap-2">
                            <!-- Keywords werden hier eingefügt -->
                        </div>
                        <div class="form-text mt-2">
                            <i class="bi bi-plus-circle"></i> Klicke auf ein Keyword zum Hinzufügen &nbsp;|&nbsp;
                            <i class="bi bi-pinterest text-danger"></i> Klicke auf das Pinterest-Icon um Suchvolumen zu prüfen
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'ideopin:project_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg"></i> Abbrechen
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            Weiter <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Keyword-Verlauf Modal -->
<div class="modal fade" id="keywordHistoryModal" tabindex="-1" aria-labelledby="keywordHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="keywordHistoryModalLabel">
                    <i class="bi bi-clock-history"></i> Frühere Keywords
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="keywordHistoryLoading" class="text-center py-4">
                    <span class="spinner-border spinner-border-sm"></span> Lade Keywords...
                </div>
                <div id="keywordHistoryEmpty" class="text-center py-4 text-muted" style="display: none;">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    Noch keine Keywords gespeichert.
                </div>
                <div id="keywordHistoryContent" style="display: none;">
                    <p class="text-muted mb-3">
                        <small>Klicke auf ein Keyword, um es hinzuzufügen:</small>
                    </p>
                    <div id="keywordHistoryTags" class="d-flex flex-wrap gap-2">
                        <!-- Keywords werden hier eingefügt -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span id="keywordHistoryCount" class="text-muted me-auto"></span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block wizard_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateKeywordsBtn');
    const keywordHistoryBtn = document.getElementById('keywordHistoryBtn');
    const keywordsInput = document.getElementById('{{ form.keywords.id_for_label }}');
    const suggestionsDiv = document.getElementById('keywordSuggestions');
    const keywordTagsDiv = document.getElementById('keywordTags');

    // Modal-Elemente
    const historyModal = new bootstrap.Modal(document.getElementById('keywordHistoryModal'));
    const historyLoading = document.getElementById('keywordHistoryLoading');
    const historyEmpty = document.getElementById('keywordHistoryEmpty');
    const historyContent = document.getElementById('keywordHistoryContent');
    const historyTags = document.getElementById('keywordHistoryTags');
    const historyCount = document.getElementById('keywordHistoryCount');

    // Set um bereits angezeigte Vorschläge zu tracken
    const shownSuggestions = new Set();

    // Keyword-Verlauf Button
    keywordHistoryBtn.addEventListener('click', async function() {
        historyModal.show();
        historyLoading.style.display = 'block';
        historyEmpty.style.display = 'none';
        historyContent.style.display = 'none';
        historyTags.innerHTML = '';

        try {
            const response = await fetch('{% url "ideopin:api_keyword_history" %}');
            const data = await response.json();

            historyLoading.style.display = 'none';

            if (data.success && data.keywords && data.keywords.length > 0) {
                // Aktuelle Keywords für Duplikat-Check
                const currentKeywords = new Set(
                    keywordsInput.value.toLowerCase().split(',').map(k => k.trim()).filter(k => k)
                );

                data.keywords.forEach(keyword => {
                    const isAlreadyAdded = currentKeywords.has(keyword.toLowerCase());

                    const tag = document.createElement('button');
                    tag.type = 'button';
                    tag.className = `btn btn-sm ${isAlreadyAdded ? 'btn-secondary' : 'btn-outline-primary'}`;
                    tag.textContent = keyword;
                    tag.disabled = isAlreadyAdded;

                    if (!isAlreadyAdded) {
                        tag.addEventListener('click', function() {
                            addKeyword(keyword);
                            tag.className = 'btn btn-sm btn-secondary';
                            tag.disabled = true;
                            currentKeywords.add(keyword.toLowerCase());
                        });
                    }

                    historyTags.appendChild(tag);
                });

                historyCount.textContent = `${data.count} Keywords gespeichert`;
                historyContent.style.display = 'block';
            } else {
                historyEmpty.style.display = 'block';
                historyCount.textContent = '';
            }
        } catch (error) {
            console.error('Error:', error);
            historyLoading.style.display = 'none';
            historyEmpty.innerHTML = '<i class="bi bi-exclamation-triangle text-danger fs-1 d-block mb-2"></i>Fehler beim Laden.';
            historyEmpty.style.display = 'block';
        }
    });

    generateBtn.addEventListener('click', async function() {
        const currentKeywords = keywordsInput.value.trim();

        if (!currentKeywords) {
            alert('Bitte zuerst ein Keyword eingeben.');
            return;
        }

        // Alle Keywords für mehr Variation verwenden
        const allKeywords = currentKeywords.split(',').map(k => k.trim()).filter(k => k);
        // Zufälliges Keyword als Seed wählen (für Variation bei wiederholtem Klicken)
        const seedKeyword = allKeywords[Math.floor(Math.random() * allKeywords.length)];

        // Button deaktivieren und Ladeanzeige
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generiere...';

        try {
            const response = await fetch('{% url "ideopin:api_generate_keywords" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    keyword: seedKeyword,
                    existing_keywords: allKeywords  // Bestehende Keywords mitschicken
                })
            });

            const data = await response.json();

            if (data.success && data.keywords) {
                addKeywordSuggestions(data.keywords);
            } else {
                alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Fehler beim Generieren der Keywords.');
        } finally {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="bi bi-magic"></i> Keywords erweitern';
        }
    });

    function addKeywordSuggestions(keywords) {
        // Aktuelle Keywords als Set für Duplikat-Prüfung
        const currentKeywords = new Set(
            keywordsInput.value.toLowerCase().split(',').map(k => k.trim()).filter(k => k)
        );

        let addedCount = 0;

        keywords.forEach(keyword => {
            const keywordLower = keyword.toLowerCase();

            // Überspringen wenn bereits in Vorschlägen angezeigt oder bereits als Keyword hinzugefügt
            if (shownSuggestions.has(keywordLower)) {
                // Nur Status aktualisieren falls bereits hinzugefügt
                updateTagStatus(keywordLower, currentKeywords.has(keywordLower));
                return;
            }

            const isAlreadyAdded = currentKeywords.has(keywordLower);
            shownSuggestions.add(keywordLower);

            // Container für Keyword + Pinterest-Link
            const tagGroup = document.createElement('div');
            tagGroup.className = 'btn-group';
            tagGroup.dataset.keyword = keywordLower;

            // Keyword-Button
            const tag = document.createElement('button');
            tag.type = 'button';
            tag.className = `btn btn-sm ${isAlreadyAdded ? 'btn-secondary' : 'btn-outline-success'}`;
            tag.textContent = keyword;
            tag.disabled = isAlreadyAdded;

            if (!isAlreadyAdded) {
                tag.addEventListener('click', function() {
                    addKeyword(keyword);
                    tag.className = 'btn btn-sm btn-secondary';
                    tag.disabled = true;
                });
            }

            // Pinterest-Recherche-Link
            const pinterestLink = document.createElement('a');
            pinterestLink.href = `https://www.pinterest.com/search/pins/?q=${encodeURIComponent(keyword)}`;
            pinterestLink.target = '_blank';
            pinterestLink.className = 'btn btn-sm btn-outline-danger';
            pinterestLink.title = `"${keyword}" auf Pinterest suchen`;
            pinterestLink.innerHTML = '<i class="bi bi-pinterest"></i>';

            tagGroup.appendChild(tag);
            tagGroup.appendChild(pinterestLink);
            keywordTagsDiv.appendChild(tagGroup);
            addedCount++;
        });

        suggestionsDiv.style.display = 'block';

        // Info wenn keine neuen Keywords gefunden wurden
        if (addedCount === 0) {
            // Kurze Meldung anzeigen
            const infoMsg = document.createElement('span');
            infoMsg.className = 'badge bg-info ms-2';
            infoMsg.textContent = 'Keine neuen Vorschläge';
            infoMsg.id = 'noNewSuggestionsMsg';

            // Entfernen nach 2 Sekunden
            const existingMsg = document.getElementById('noNewSuggestionsMsg');
            if (existingMsg) existingMsg.remove();

            keywordTagsDiv.appendChild(infoMsg);
            setTimeout(() => infoMsg.remove(), 2000);
        }
    }

    function updateTagStatus(keywordLower, isAdded) {
        const tagGroups = keywordTagsDiv.querySelectorAll('.btn-group');
        tagGroups.forEach(group => {
            if (group.dataset.keyword === keywordLower && isAdded) {
                const btn = group.querySelector('button');
                if (btn) {
                    btn.className = 'btn btn-sm btn-secondary';
                    btn.disabled = true;
                }
            }
        });
    }

    function addKeyword(keyword) {
        const currentValue = keywordsInput.value.trim();
        if (currentValue) {
            keywordsInput.value = currentValue + ', ' + keyword;
        } else {
            keywordsInput.value = keyword;
        }
    }
});
</script>
{% endblock %}
