{% extends 'ideopin/base_wizard.html' %}

{% block wizard_content %}
<div class="row">
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-check-circle"></i> Dein Pinterest Pin ist fertig!</h5>
            </div>
            <div class="card-body text-center">
                <div class="pin-preview mb-4">
                    {% if project.final_image %}
                        <img src="{{ project.final_image.url }}" alt="Fertiger Pin" class="img-fluid rounded"
                             style="max-height: 500px;">
                    {% elif project.generated_image %}
                        <img src="{{ project.generated_image.url }}" alt="Fertiger Pin" class="img-fluid rounded"
                             style="max-height: 500px;">
                    {% else %}
                        <div class="alert alert-warning">
                            Kein Bild generiert. Gehe zur체ck zu Schritt 3 um ein Bild zu erstellen.
                        </div>
                    {% endif %}
                </div>

                <div class="d-grid gap-2">
                    <a href="{% url 'ideopin:download_image' project.id %}" class="btn btn-primary btn-lg">
                        <i class="bi bi-download"></i> Bild herunterladen
                    </a>
                </div>
            </div>
        </div>

        <!-- Pinterest Posting Card -->
        <div class="card shadow-sm mt-4">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #E60023, #BD081C);">
                <h6 class="mb-0"><i class="bi bi-pinterest"></i> Auf Pinterest posten</h6>
            </div>
            <div class="card-body">
                {% if project.pinterest_posted %}
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>Bereits gepostet!</strong><br>
                        <small>Board: {{ project.pinterest_board_name|default:"Unbekannt" }} &bull; {{ project.pinterest_posted_at|date:"d.m.Y H:i" }}</small>
                    </div>
                    {% if project.pinterest_pin_id %}
                        <a href="https://www.pinterest.com/pin/{{ project.pinterest_pin_id }}/"
                           target="_blank" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-box-arrow-up-right me-1"></i>Pin auf Pinterest ansehen
                        </a>
                    {% endif %}
                {% elif pinterest_connected %}
                    <div id="pinterest-posting-section">
                        <div class="mb-3">
                            <label for="pinterest-board" class="form-label">Board ausw채hlen:</label>
                            <select class="form-select" id="pinterest-board" name="board_id">
                                <option value="">Board laden...</option>
                            </select>
                        </div>
                        <button type="button" class="btn w-100" id="btn-post-pinterest"
                                style="background-color: #E60023; color: white;"
                                onclick="postToPinterest()">
                            <i class="bi bi-pinterest me-2"></i>Jetzt auf Pinterest posten
                        </button>
                        <div id="pinterest-result" class="mt-3" style="display: none;"></div>
                    </div>
                {% else %}
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Pinterest ist noch nicht verbunden.
                    </div>
                    <a href="{% url 'accounts:neue_api_einstellungen' %}" class="btn btn-outline-danger">
                        <i class="bi bi-gear me-1"></i>Pinterest verbinden
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-link-45deg"></i> Pin-Link</h6>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input type="text" class="form-control" value="{{ project.pin_url }}" readonly id="pinUrl">
                    <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('pinUrl')">
                        <i class="bi bi-clipboard"></i> Kopieren
                    </button>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-card-text"></i> Pin-Beschreibung</h6>
            </div>
            <div class="card-body">
                <textarea class="form-control mb-2" rows="5" readonly id="pinDescription">{{ project.seo_description }}</textarea>
                <button class="btn btn-outline-primary" onclick="copyToClipboard('pinDescription')">
                    <i class="bi bi-clipboard"></i> Beschreibung kopieren
                </button>
                <small class="text-muted ms-2">{{ project.seo_description|length }} / 500 Zeichen</small>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Pin-Details</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>Keywords:</strong></td>
                        <td>{{ project.keywords }}</td>
                    </tr>
                    <tr>
                        <td><strong>Overlay-Text:</strong></td>
                        <td>{{ project.overlay_text }}</td>
                    </tr>
                    <tr>
                        <td><strong>Format:</strong></td>
                        <td>{{ project.get_pin_format_display }}</td>
                    </tr>
                    <tr>
                        <td><strong>Erstellt:</strong></td>
                        <td>{{ project.created_at|date:"d.m.Y H:i" }}</td>
                    </tr>
                    {% if project.pinterest_posted %}
                    <tr>
                        <td><strong>Pinterest-Status:</strong></td>
                        <td><span class="badge bg-success"><i class="bi bi-check"></i> Gepostet</span></td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        <div class="mt-4 d-flex gap-2 flex-wrap">
            <a href="{% url 'ideopin:wizard_step1' %}" class="btn btn-success">
                <i class="bi bi-plus-lg"></i> Neuen Pin erstellen
            </a>
            <a href="{% url 'ideopin:project_duplicate' project.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-copy"></i> Pin duplizieren
            </a>
            <a href="{% url 'ideopin:project_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-list"></i> Alle Pins
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block wizard_js %}
<script>
const projectId = {{ project.id }};
const csrfToken = '{{ csrf_token }}';

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.value || element.textContent;

    navigator.clipboard.writeText(text).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Kopiert!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');

        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    }).catch(err => {
        alert('Kopieren fehlgeschlagen');
    });
}

{% if pinterest_connected and not project.pinterest_posted %}
// Pinterest-Boards beim Laden abrufen
document.addEventListener('DOMContentLoaded', function() {
    loadPinterestBoards();
});

function loadPinterestBoards() {
    const select = document.getElementById('pinterest-board');
    select.innerHTML = '<option value="">Boards werden geladen...</option>';
    select.disabled = true;

    fetch('{% url "ideopin:api_pinterest_boards" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.boards) {
                select.innerHTML = '<option value="">Board ausw채hlen...</option>';
                data.boards.forEach(board => {
                    const option = document.createElement('option');
                    option.value = board.id;
                    option.textContent = board.name + (board.pin_count ? ` (${board.pin_count} Pins)` : '');
                    select.appendChild(option);
                });
                select.disabled = false;
            } else {
                select.innerHTML = '<option value="">Fehler beim Laden</option>';
                console.error('Pinterest boards error:', data.error);
            }
        })
        .catch(error => {
            select.innerHTML = '<option value="">Netzwerkfehler</option>';
            console.error('Pinterest boards fetch error:', error);
        });
}

function postToPinterest() {
    const boardSelect = document.getElementById('pinterest-board');
    const boardId = boardSelect.value;
    const resultDiv = document.getElementById('pinterest-result');
    const postBtn = document.getElementById('btn-post-pinterest');

    if (!boardId) {
        alert('Bitte w채hle ein Board aus.');
        return;
    }

    // Button deaktivieren und Loading anzeigen
    postBtn.disabled = true;
    postBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Wird gepostet...';

    fetch('{% url "ideopin:api_post_to_pinterest" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            board_id: boardId
        })
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';

        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Erfolgreich gepostet!</strong><br>
                    <a href="${data.pin_url}" target="_blank" class="mt-2 d-inline-block">
                        <i class="bi bi-box-arrow-up-right me-1"></i>Pin auf Pinterest ansehen
                    </a>
                </div>
            `;
            postBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Gepostet!';
            postBtn.classList.remove('btn-danger');
            postBtn.classList.add('btn-success');
            boardSelect.disabled = true;

            // Seite nach 2 Sekunden neu laden um Status zu aktualisieren
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Fehler:</strong> ${data.error}
                </div>
            `;
            postBtn.disabled = false;
            postBtn.innerHTML = '<i class="bi bi-pinterest me-2"></i>Erneut versuchen';
        }
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Netzwerkfehler:</strong> ${error.message}
            </div>
        `;
        postBtn.disabled = false;
        postBtn.innerHTML = '<i class="bi bi-pinterest me-2"></i>Erneut versuchen';
    });
}
{% endif %}
</script>
{% endblock %}
