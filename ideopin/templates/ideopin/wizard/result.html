{% extends 'ideopin/base_wizard.html' %}

{% block wizard_content %}
<div class="row">
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-check-circle"></i> Dein Pinterest Pin ist fertig!</h5>
            </div>
            <div class="card-body text-center">
                <div class="pin-preview mb-4">
                    {% if project.final_image %}
                        <img src="{{ project.final_image.url }}" alt="Fertiger Pin" class="img-fluid rounded"
                             style="max-height: 500px;">
                    {% elif project.generated_image %}
                        <img src="{{ project.generated_image.url }}" alt="Fertiger Pin" class="img-fluid rounded"
                             style="max-height: 500px;">
                    {% else %}
                        <div class="alert alert-warning">
                            Kein Bild generiert. Gehe zur√ºck zu Schritt 3 um ein Bild zu erstellen.
                        </div>
                    {% endif %}
                </div>

                <div class="d-grid gap-2">
                    <a href="{% url 'ideopin:download_image' project.id %}" class="btn btn-primary btn-lg">
                        <i class="bi bi-download"></i> Bild herunterladen
                    </a>
                </div>
            </div>
        </div>

        <!-- Pinterest Posting Card -->
        <div class="card shadow-sm mt-4">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #E60023, #BD081C);">
                <h6 class="mb-0"><i class="bi bi-pinterest"></i> Auf Pinterest posten</h6>
            </div>
            <div class="card-body">
                {% if project.pinterest_posted %}
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>Bereits gepostet!</strong><br>
                        <small>Board: {{ project.pinterest_board_name|default:"Unbekannt" }} &bull; {{ project.pinterest_posted_at|date:"d.m.Y H:i" }}</small>
                    </div>
                    {% if project.pinterest_pin_id %}
                        <a href="https://www.pinterest.com/pin/{{ project.pinterest_pin_id }}/"
                           target="_blank" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-box-arrow-up-right me-1"></i>Pin auf Pinterest ansehen
                        </a>
                    {% endif %}
                {% elif pinterest_connected %}
                    <div id="pinterest-posting-section">
                        <div class="mb-3">
                            <label for="pinterest-board" class="form-label">Board ausw√§hlen:</label>
                            <select class="form-select" id="pinterest-board" name="board_id">
                                <option value="">Board laden...</option>
                            </select>
                        </div>
                        <button type="button" class="btn w-100" id="btn-post-pinterest"
                                style="background-color: #E60023; color: white;"
                                onclick="postToPinterest()">
                            <i class="bi bi-pinterest me-2"></i>Jetzt auf Pinterest posten
                        </button>
                        <div id="pinterest-result" class="mt-3" style="display: none;"></div>
                    </div>
                {% else %}
                    <!-- Pin It Button - funktioniert ohne API -->
                    {% if project.pinterest_posted %}
                        <!-- Bereits als gepostet markiert -->
                        <div class="alert alert-success mb-3">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>Als gepostet markiert!</strong><br>
                            <small>{{ project.pinterest_posted_at|date:"d.m.Y H:i" }}</small>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="unmarkAsPosted()">
                            <i class="bi bi-x-circle me-1"></i>Markierung entfernen
                        </button>
                    {% elif project.final_image or project.generated_image %}
                        <!-- Pin erstellen (erscheint unter "Erstellt") -->
                        <button type="button" class="btn w-100 mb-2" id="btn-create-pin"
                                style="background-color: #E60023; color: white;"
                                onclick="createPinterestPin()">
                            <i class="bi bi-plus-circle me-2"></i>Pin erstellen
                        </button>
                        <p class="text-muted small mb-3">
                            <i class="bi bi-star-fill text-warning me-1"></i>
                            Erscheint unter "Erstellt" im Profil
                        </p>

                        <!-- Pin merken (erscheint unter "Gemerkt") -->
                        <button type="button" class="btn btn-outline-secondary w-100" id="btn-pin-it"
                                onclick="openPinterestShare()">
                            <i class="bi bi-bookmark me-2"></i>Auf Pinterest merken
                        </button>
                        <p class="text-muted small mt-1 mb-0">
                            Erscheint unter "Gemerkt"
                        </p>
                    {% else %}
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Kein Bild vorhanden. Gehe zur√ºck zu Schritt 3.
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Upload-Post API Card -->
        {% if upload_post_configured %}
        <div class="card shadow-sm mt-4">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                <h6 class="mb-0"><i class="bi bi-cloud-upload"></i> API-Post (Upload-Post.com)</h6>
            </div>
            <div class="card-body">
                {% if project.pinterest_posted %}
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>Bereits gepostet!</strong><br>
                        <small>{{ project.pinterest_board_name|default:"Upload-Post" }} &bull; {{ project.pinterest_posted_at|date:"d.m.Y H:i" }}</small>
                    </div>
                {% elif project.final_image or project.generated_image %}
                    <div class="alert alert-info small mb-3">
                        <i class="bi bi-info-circle me-1"></i>
                        Postet direkt √ºber die Upload-Post API auf Pinterest und andere Plattformen.
                    </div>
                    <div id="upload-post-section">
                        <!-- Pinterest Board Auswahl -->
                        <div class="mb-3">
                            <label for="upload-post-board" class="form-label">
                                <i class="bi bi-pinterest text-danger me-1"></i> Pinterest Board:
                            </label>
                            <select class="form-select" id="upload-post-board" name="pinterest_board_id">
                                <option value="">Board laden...</option>
                            </select>
                            <div class="form-text">W√§hle das Board f√ºr deinen Pin</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Zus√§tzliche Plattformen:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="instagram" id="platform-instagram">
                                <label class="form-check-label" for="platform-instagram">
                                    <i class="bi bi-instagram text-purple me-1"></i> Instagram
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="facebook" id="platform-facebook">
                                <label class="form-check-label" for="platform-facebook">
                                    <i class="bi bi-facebook text-primary me-1"></i> Facebook
                                </label>
                            </div>
                        </div>
                        <button type="button" class="btn w-100" id="btn-upload-post"
                                style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;"
                                onclick="postViaUploadPost()">
                            <i class="bi bi-cloud-upload me-2"></i>Jetzt via API posten
                        </button>
                        <div id="upload-post-result" class="mt-3" style="display: none;"></div>
                    </div>
                {% else %}
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Kein Bild vorhanden. Gehe zur√ºck zu Schritt 3.
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-lg-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-link-45deg"></i> Pin-Link</h6>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input type="text" class="form-control" value="{{ project.pin_url }}" readonly id="pinUrl">
                    <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('pinUrl')">
                        <i class="bi bi-clipboard"></i> Kopieren
                    </button>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-type-h1"></i> Pin-Titel</h6>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input type="text" class="form-control" value="{{ project.pin_title }}" readonly id="pinTitle">
                    <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('pinTitle')">
                        <i class="bi bi-clipboard"></i> Kopieren
                    </button>
                </div>
                <small class="text-muted">{{ project.pin_title|length }} / 100 Zeichen</small>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-card-text"></i> Pin-Beschreibung</h6>
            </div>
            <div class="card-body">
                <textarea class="form-control mb-2" rows="5" readonly id="pinDescription">{{ project.seo_description }}</textarea>
                <button class="btn btn-outline-primary" onclick="copyToClipboard('pinDescription')">
                    <i class="bi bi-clipboard"></i> Beschreibung kopieren
                </button>
                <small class="text-muted ms-2">{{ project.seo_description|length }} / 500 Zeichen</small>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Pin-Details</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>Keywords:</strong></td>
                        <td>{{ project.keywords }}</td>
                    </tr>
                    <tr>
                        <td><strong>Overlay-Text:</strong></td>
                        <td>{{ project.overlay_text }}</td>
                    </tr>
                    <tr>
                        <td><strong>Format:</strong></td>
                        <td>{{ project.get_pin_format_display }}</td>
                    </tr>
                    <tr>
                        <td><strong>Erstellt:</strong></td>
                        <td>{{ project.created_at|date:"d.m.Y H:i" }}</td>
                    </tr>
                    {% if project.pinterest_posted %}
                    <tr>
                        <td><strong>Pinterest-Status:</strong></td>
                        <td><span class="badge bg-success"><i class="bi bi-check"></i> Gepostet</span></td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        <div class="mt-4 d-flex gap-2 flex-wrap">
            <a href="{% url 'ideopin:wizard_step1' %}" class="btn btn-success">
                <i class="bi bi-plus-lg"></i> Neuen Pin erstellen
            </a>
            <a href="{% url 'ideopin:project_duplicate' project.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-copy"></i> Pin duplizieren
            </a>
            <a href="{% url 'ideopin:project_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-list"></i> Alle Pins
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block wizard_js %}
<script>
const projectId = {{ project.id }};
const csrfToken = '{{ csrf_token }}';

// Pinterest Pin It - funktioniert ohne API
async function openPinterestShare() {
    // Vollst√§ndige URLs f√ºr Pinterest erstellen
    const baseUrl = window.location.origin;
    {% if project.final_image %}
    const imageUrl = baseUrl + '{{ project.final_image.url }}';
    {% elif project.generated_image %}
    const imageUrl = baseUrl + '{{ project.generated_image.url }}';
    {% else %}
    const imageUrl = '';
    {% endif %}

    const linkUrl = '{{ project.pin_url|escapejs }}' || window.location.href;
    const title = `{{ project.pin_title|escapejs }}`;
    const description = `{{ project.seo_description|escapejs }}`;

    // Kombiniere Titel + Beschreibung f√ºr Pinterest
    let fullDescription = description;
    if (title) {
        fullDescription = `${title}\n\n${description}`;
    }

    if (!imageUrl) {
        alert('Kein Bild vorhanden. Bitte zuerst ein Bild generieren.');
        return;
    }

    // Pinterest Share URL erstellen
    const params = new URLSearchParams({
        url: linkUrl,
        media: imageUrl,
        description: fullDescription
    });

    // Pinterest-Fenster √∂ffnen
    const pinterestUrl = `https://www.pinterest.com/pin/create/button/?${params.toString()}`;
    window.open(pinterestUrl, 'pinterest-share', 'width=750,height=600,scrollbars=yes');

    // Automatisch als gepostet markieren
    try {
        await fetch('{% url "ideopin:api_mark_as_posted" project.id %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
        // Seite neu laden um Status zu aktualisieren
        setTimeout(() => window.location.reload(), 1000);
    } catch (e) {
        console.log('Konnte nicht als gepostet markieren:', e);
    }
}

// Pin erstellen - Bild herunterladen, Text kopieren, Pinterest √∂ffnen
async function createPinterestPin() {
    const btn = document.getElementById('btn-create-pin');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Wird vorbereitet...';

    try {
        // 1. Bild-URL und Infos sammeln
        const baseUrl = window.location.origin;
        {% if project.final_image %}
        const imageUrl = baseUrl + '{{ project.final_image.url }}';
        const imageName = 'pin_{{ project.id }}_final.png';
        {% elif project.generated_image %}
        const imageUrl = baseUrl + '{{ project.generated_image.url }}';
        const imageName = 'pin_{{ project.id }}.png';
        {% else %}
        const imageUrl = '';
        const imageName = 'pin.png';
        {% endif %}

        const linkUrl = '{{ project.pin_url|escapejs }}' || window.location.href;
        const title = `{{ project.pin_title|escapejs }}`;
        const description = `{{ project.seo_description|escapejs }}`;

        if (!imageUrl) {
            alert('Kein Bild vorhanden.');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            return;
        }

        // 2. Text f√ºr Zwischenablage vorbereiten (Titel + Beschreibung + Link ohne https://)
        const cleanLink = linkUrl.replace(/^https?:\/\//, '');
        let clipboardText = '';
        if (title) {
            clipboardText = `${title}\n\n${description}\n\n${cleanLink}`;
        } else {
            clipboardText = `${description}\n\n${cleanLink}`;
        }

        // 3. In Zwischenablage kopieren
        await navigator.clipboard.writeText(clipboardText);

        // 4. Bild herunterladen
        const response = await fetch(imageUrl);
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = imageName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(downloadUrl);

        // 5. Pinterest Pin-Erstellung √∂ffnen
        window.open('https://www.pinterest.com/pin-creation-tool/', '_blank');

        // 6. Als gepostet markieren
        await fetch('{% url "ideopin:api_mark_as_posted" project.id %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });

        // 7. Erfolgs-Feedback
        btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Bereit!';
        btn.classList.remove('btn-primary');
        btn.style.backgroundColor = '#10b981';

        // Info-Modal anzeigen
        alert('‚úÖ Bild heruntergeladen!\n‚úÖ Beschreibung in Zwischenablage kopiert!\n\nüëâ Jetzt bei Pinterest:\n1. Bild hochladen (aus Downloads)\n2. Text einf√ºgen (Strg+V)\n3. Ver√∂ffentlichen');

        setTimeout(() => window.location.reload(), 2000);

    } catch (e) {
        console.error('Fehler:', e);
        alert('Fehler: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

// Als gepostet markieren
async function markAsPosted() {
    const btn = document.getElementById('btn-mark-posted');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Markiere...';

    try {
        const response = await fetch('{% url "ideopin:api_mark_as_posted" project.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        const data = await response.json();

        if (data.success) {
            // Seite neu laden um Status zu aktualisieren
            window.location.reload();
        } else {
            alert('Fehler: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    } catch (e) {
        alert('Fehler: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

// Markierung entfernen
async function unmarkAsPosted() {
    if (!confirm('Markierung wirklich entfernen?')) return;

    try {
        const response = await fetch('{% url "ideopin:api_unmark_as_posted" project.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        const data = await response.json();

        if (data.success) {
            window.location.reload();
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (e) {
        alert('Fehler: ' + e.message);
    }
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.value || element.textContent;

    navigator.clipboard.writeText(text).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Kopiert!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');

        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    }).catch(err => {
        alert('Kopieren fehlgeschlagen');
    });
}

// Upload-Post API Funktion
{% if upload_post_configured and not project.pinterest_posted %}
// Boards beim Laden abrufen
document.addEventListener('DOMContentLoaded', function() {
    loadUploadPostBoards();
});

function loadUploadPostBoards() {
    const select = document.getElementById('upload-post-board');
    if (!select) return;

    select.innerHTML = '<option value="">Boards werden geladen...</option>';
    select.disabled = true;

    fetch('{% url "ideopin:api_upload_post_boards" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.boards) {
                select.innerHTML = '<option value="">Board ausw√§hlen...</option>';
                // Boards k√∂nnen verschiedene Formate haben
                const boards = Array.isArray(data.boards) ? data.boards : [];
                boards.forEach(board => {
                    const option = document.createElement('option');
                    // Flexibles Format: board kann id/name oder board_id/board_name haben
                    option.value = board.id || board.board_id || board.pinterest_board_id || '';
                    const name = board.name || board.board_name || board.title || 'Unbenannt';
                    const pinCount = board.pin_count || board.pins || '';
                    option.textContent = name + (pinCount ? ` (${pinCount} Pins)` : '');
                    select.appendChild(option);
                });
                select.disabled = false;
            } else {
                select.innerHTML = '<option value="">Fehler: ' + (data.error || 'Unbekannt') + '</option>';
                console.error('Upload-Post boards error:', data.error);
            }
        })
        .catch(error => {
            select.innerHTML = '<option value="">Netzwerkfehler</option>';
            console.error('Upload-Post boards fetch error:', error);
        });
}

function postViaUploadPost() {
    const btn = document.getElementById('btn-upload-post');
    const resultDiv = document.getElementById('upload-post-result');
    const boardSelect = document.getElementById('upload-post-board');
    const originalHtml = btn.innerHTML;

    // Board-ID holen (erforderlich f√ºr Pinterest)
    const pinterestBoardId = boardSelect ? boardSelect.value : '';

    if (!pinterestBoardId) {
        alert('Bitte w√§hle ein Pinterest Board aus.');
        return;
    }

    // Plattformen sammeln (Pinterest ist immer dabei wenn Board ausgew√§hlt)
    const platforms = ['pinterest'];
    if (document.getElementById('platform-instagram')?.checked) platforms.push('instagram');
    if (document.getElementById('platform-facebook')?.checked) platforms.push('facebook');

    // Button deaktivieren und Loading anzeigen
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Wird gepostet...';

    fetch('{% url "ideopin:api_upload_post" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            platforms: platforms,
            pinterest_board_id: pinterestBoardId
        })
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';

        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>${data.message}</strong>
                </div>
            `;
            btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Gepostet!';
            btn.style.background = '#10b981';

            // Inputs deaktivieren
            document.querySelectorAll('#upload-post-section input, #upload-post-section select').forEach(el => el.disabled = true);

            // Seite nach 2 Sekunden neu laden
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Fehler:</strong> ${data.error}
                </div>
            `;
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Netzwerkfehler:</strong> ${error.message}
            </div>
        `;
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    });
}
{% endif %}

{% if pinterest_connected and not project.pinterest_posted %}
// Pinterest-Boards beim Laden abrufen
document.addEventListener('DOMContentLoaded', function() {
    loadPinterestBoards();
});

function loadPinterestBoards() {
    const select = document.getElementById('pinterest-board');
    select.innerHTML = '<option value="">Boards werden geladen...</option>';
    select.disabled = true;

    fetch('{% url "ideopin:api_pinterest_boards" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.boards) {
                select.innerHTML = '<option value="">Board ausw√§hlen...</option>';
                data.boards.forEach(board => {
                    const option = document.createElement('option');
                    option.value = board.id;
                    option.textContent = board.name + (board.pin_count ? ` (${board.pin_count} Pins)` : '');
                    select.appendChild(option);
                });
                select.disabled = false;
            } else {
                select.innerHTML = '<option value="">Fehler beim Laden</option>';
                console.error('Pinterest boards error:', data.error);
            }
        })
        .catch(error => {
            select.innerHTML = '<option value="">Netzwerkfehler</option>';
            console.error('Pinterest boards fetch error:', error);
        });
}

function postToPinterest() {
    const boardSelect = document.getElementById('pinterest-board');
    const boardId = boardSelect.value;
    const resultDiv = document.getElementById('pinterest-result');
    const postBtn = document.getElementById('btn-post-pinterest');

    if (!boardId) {
        alert('Bitte w√§hle ein Board aus.');
        return;
    }

    // Button deaktivieren und Loading anzeigen
    postBtn.disabled = true;
    postBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Wird gepostet...';

    fetch('{% url "ideopin:api_post_to_pinterest" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            board_id: boardId
        })
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';

        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Erfolgreich gepostet!</strong><br>
                    <a href="${data.pin_url}" target="_blank" class="mt-2 d-inline-block">
                        <i class="bi bi-box-arrow-up-right me-1"></i>Pin auf Pinterest ansehen
                    </a>
                </div>
            `;
            postBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Gepostet!';
            postBtn.classList.remove('btn-danger');
            postBtn.classList.add('btn-success');
            boardSelect.disabled = true;

            // Seite nach 2 Sekunden neu laden um Status zu aktualisieren
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Fehler:</strong> ${data.error}
                </div>
            `;
            postBtn.disabled = false;
            postBtn.innerHTML = '<i class="bi bi-pinterest me-2"></i>Erneut versuchen';
        }
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Netzwerkfehler:</strong> ${error.message}
            </div>
        `;
        postBtn.disabled = false;
        postBtn.innerHTML = '<i class="bi bi-pinterest me-2"></i>Erneut versuchen';
    });
}
{% endif %}
</script>
{% endblock %}
