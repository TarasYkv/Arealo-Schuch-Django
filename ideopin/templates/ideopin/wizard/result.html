{% extends 'ideopin/base_wizard.html' %}

{% block wizard_content %}
{% if project.pins.count > 1 %}
<!-- ========================================
     MULTI-PIN ANSICHT
     ======================================== -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-check-circle"></i> {{ project.pins.count }} Pinterest Pins fertig!</h5>
        <div>
            <button type="button" class="btn btn-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#distributionModal">
                <i class="bi bi-calendar-range"></i> Auto-Verteilung
            </button>
            <button type="button" class="btn btn-light btn-sm" id="batchPublishBtn" onclick="openBatchPublish()">
                <i class="bi bi-cloud-upload"></i> Batch-Publish
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="row g-3">
            {% for pin in project.pins.all %}
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 multi-pin-card" data-position="{{ pin.position }}">
                    <!-- Pin-Bild -->
                    <div class="position-relative">
                        {% if pin.final_image %}
                        <img src="{{ pin.final_image.url }}" class="card-img-top" style="height: 250px; object-fit: cover;" alt="Pin {{ pin.position }}">
                        {% elif pin.generated_image %}
                        <img src="{{ pin.generated_image.url }}" class="card-img-top" style="height: 250px; object-fit: cover;" alt="Pin {{ pin.position }}">
                        {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center" style="height: 250px;">
                            <i class="bi bi-image text-muted fs-1"></i>
                        </div>
                        {% endif %}
                        <!-- Badges -->
                        <span class="badge bg-primary position-absolute top-0 start-0 m-2">Pin {{ pin.position }}</span>
                        {% if pin.pinterest_posted %}
                        <span class="badge bg-success position-absolute top-0 end-0 m-2">
                            <i class="bi bi-check"></i> Gepostet
                        </span>
                        {% elif pin.scheduled_at %}
                        <span class="badge bg-info position-absolute top-0 end-0 m-2">
                            <i class="bi bi-clock"></i> Geplant
                        </span>
                        {% endif %}
                    </div>

                    <div class="card-body p-3">
                        <h6 class="card-title small mb-1">{{ pin.pin_title|default:"Kein Titel"|truncatechars:40 }}</h6>
                        <p class="card-text text-muted small mb-2">{{ pin.overlay_text|truncatechars:50 }}</p>

                        {% if pin.scheduled_at %}
                        <div class="alert alert-info py-1 px-2 mb-2 small">
                            <i class="bi bi-calendar-check me-1"></i>
                            {{ pin.scheduled_at|date:"d.m.Y H:i" }}
                        </div>
                        {% endif %}
                    </div>

                    <div class="card-footer bg-white border-top-0 pt-0">
                        <div class="btn-group w-100" role="group">
                            <a href="{% url 'ideopin:download_pin_image' project.id pin.position %}" class="btn btn-outline-primary btn-sm" title="Download">
                                <i class="bi bi-download"></i>
                            </a>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openScheduleModal({{ pin.position }})" title="Planen">
                                <i class="bi bi-calendar-event"></i>
                            </button>
                            {% if not pin.pinterest_posted %}
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="postSinglePin({{ pin.position }})" title="Jetzt posten">
                                <i class="bi bi-pinterest"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Scheduling Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-event"></i> Pin <span id="scheduleModalPinNumber"></span> planen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="schedulePinPosition">
                <div class="mb-3">
                    <label class="form-label">Datum & Uhrzeit</label>
                    <div class="row g-2">
                        <div class="col-7">
                            <input type="date" class="form-control" id="schedulePinDate">
                        </div>
                        <div class="col-5">
                            <input type="time" class="form-control" id="schedulePinTime" value="12:00">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Pinterest Board</label>
                    <select class="form-select" id="schedulePinBoard">
                        <option value="">Board laden...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">
                    <i class="bi bi-check"></i> Speichern
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Auto-Verteilung Modal -->
<div class="modal fade" id="distributionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-range"></i> Automatische Verteilung</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="form-label">Startdatum</label>
                        <input type="date" class="form-control" id="distStartDate">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Startzeit</label>
                        <input type="time" class="form-control" id="distStartTime" value="12:00">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Intervall</label>
                        <select class="form-select" id="distInterval">
                            <option value="10">Alle 10 Minuten</option>
                            <option value="30">Alle 30 Minuten</option>
                            <option value="60">Jede Stunde</option>
                            <option value="1440">Täglich (1 Tag)</option>
                            <option value="2880" selected>Alle 2 Tage</option>
                            <option value="4320">Alle 3 Tage</option>
                            <option value="10080">Wöchentlich</option>
                        </select>
                        <small class="form-text text-muted">Werte in Minuten</small>
                    </div>
                </div>
                <!-- Plattform-Auswahl -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Plattformen</label>
                    <div class="row g-2">
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="pinterest" id="dist-platform-pinterest" checked>
                                <label class="form-check-label" for="dist-platform-pinterest">
                                    <i class="bi bi-pinterest me-1" style="color: #E60023;"></i> Pinterest
                                </label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="instagram" id="dist-platform-instagram">
                                <label class="form-check-label" for="dist-platform-instagram">
                                    <i class="bi bi-instagram me-1" style="color: #E1306C;"></i> Instagram
                                </label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="facebook" id="dist-platform-facebook">
                                <label class="form-check-label" for="dist-platform-facebook">
                                    <i class="bi bi-facebook text-primary me-1"></i> Facebook
                                </label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="threads" id="dist-platform-threads">
                                <label class="form-check-label" for="dist-platform-threads">
                                    <i class="bi bi-threads me-1"></i> Threads
                                </label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="bluesky" id="dist-platform-bluesky">
                                <label class="form-check-label" for="dist-platform-bluesky">
                                    <i class="bi bi-cloud me-1" style="color: #0085FF;"></i> Bluesky
                                </label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="x" id="dist-platform-x">
                                <label class="form-check-label" for="dist-platform-x">
                                    <i class="bi bi-twitter-x me-1"></i> X (Twitter)
                                </label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="linkedin" id="dist-platform-linkedin">
                                <label class="form-check-label" for="dist-platform-linkedin">
                                    <i class="bi bi-linkedin me-1" style="color: #0A66C2;"></i> LinkedIn
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3" id="distBoardSection">
                    <label class="form-label">Pinterest Board</label>
                    <select class="form-select" id="distBoard">
                        <option value="">Board laden...</option>
                    </select>
                    <small class="text-muted">Nur erforderlich wenn Pinterest ausgewählt</small>
                </div>
                <hr>
                <h6><i class="bi bi-list-check"></i> Vorschau der Verteilung</h6>
                <table class="table table-sm" id="distPreviewTable">
                    <thead><tr><th>Pin</th><th>Geplant für</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-outline-primary" onclick="previewDistribution()">
                    <i class="bi bi-eye"></i> Vorschau
                </button>
                <button type="button" class="btn btn-primary" onclick="applyDistribution()">
                    <i class="bi bi-check"></i> Verteilung anwenden
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Batch-Publish Modal -->
<div class="modal fade" id="batchPublishModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cloud-upload"></i> Batch-Publish</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Wähle die Pins aus, die du jetzt veröffentlichen möchtest:</p>
                <div id="batchPinList">
                    {% for pin in project.pins.all %}
                    {% if not pin.pinterest_posted %}
                    <div class="form-check mb-2">
                        <input class="form-check-input batch-pin-check" type="checkbox" value="{{ pin.position }}" id="batchPin{{ pin.position }}" checked>
                        <label class="form-check-label" for="batchPin{{ pin.position }}">
                            Pin {{ pin.position }}: {{ pin.pin_title|default:pin.overlay_text|truncatechars:40 }}
                        </label>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <!-- Plattform-Auswahl -->
                <div class="mt-3">
                    <label class="form-label fw-bold">Plattformen</label>
                    <div class="row g-2">
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="pinterest" id="batch-platform-pinterest" checked onchange="toggleBatchPinterestBoard()">
                                <label class="form-check-label" for="batch-platform-pinterest">
                                    <i class="bi bi-pinterest me-1" style="color: #E60023;"></i> Pinterest
                                </label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="instagram" id="batch-platform-instagram">
                                <label class="form-check-label" for="batch-platform-instagram">
                                    <i class="bi bi-instagram me-1" style="color: #E4405F;"></i> Instagram
                                </label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="facebook" id="batch-platform-facebook">
                                <label class="form-check-label" for="batch-platform-facebook">
                                    <i class="bi bi-facebook me-1" style="color: #1877F2;"></i> Facebook
                                </label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="threads" id="batch-platform-threads">
                                <label class="form-check-label" for="batch-platform-threads">
                                    <i class="bi bi-threads me-1"></i> Threads
                                </label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="x" id="batch-platform-x">
                                <label class="form-check-label" for="batch-platform-x">
                                    <i class="bi bi-twitter-x me-1"></i> X
                                </label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="linkedin" id="batch-platform-linkedin">
                                <label class="form-check-label" for="batch-platform-linkedin">
                                    <i class="bi bi-linkedin me-1" style="color: #0A66C2;"></i> LinkedIn
                                </label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="bluesky" id="batch-platform-bluesky">
                                <label class="form-check-label" for="batch-platform-bluesky">
                                    <i class="bi bi-cloud me-1" style="color: #0085FF;"></i> Bluesky
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pinterest Board (nur wenn Pinterest ausgewählt) -->
                <div class="mt-3" id="batchBoardContainer">
                    <label class="form-label">Pinterest Board</label>
                    <select class="form-select" id="batchBoard">
                        <option value="">Board laden...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="executeBatchPublish()">
                    <i class="bi bi-cloud-upload"></i> Ausgewählte veröffentlichen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Action-Buttons für Multi-Pin -->
<div class="mt-4 d-flex gap-2 flex-wrap">
    <a href="{% url 'ideopin:wizard_step1' %}" class="btn btn-success">
        <i class="bi bi-plus-lg"></i> Neues Projekt erstellen
    </a>
    <a href="{% url 'ideopin:project_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-list"></i> Alle Projekte
    </a>
</div>

{% else %}
<!-- ========================================
     SINGLE-PIN ANSICHT (Original)
     ======================================== -->
<div class="row">
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-check-circle"></i> Dein Pinterest Pin ist fertig!</h5>
            </div>
            <div class="card-body text-center">
                <div class="pin-preview mb-4">
                    {% if project.final_image %}
                        <img src="{{ project.final_image.url }}" alt="Fertiger Pin" class="img-fluid rounded"
                             style="max-height: 500px;">
                    {% elif project.generated_image %}
                        <img src="{{ project.generated_image.url }}" alt="Fertiger Pin" class="img-fluid rounded"
                             style="max-height: 500px;">
                    {% else %}
                        <div class="alert alert-warning">
                            Kein Bild generiert. Gehe zurück zu Schritt 3 um ein Bild zu erstellen.
                        </div>
                    {% endif %}
                </div>

                <div class="d-grid gap-2">
                    <a href="{% url 'ideopin:download_image' project.id %}" class="btn btn-primary btn-lg">
                        <i class="bi bi-download"></i> Bild herunterladen
                    </a>
                </div>
            </div>
        </div>
{% endif %}

{% if project.pins.count <= 1 %}
        <!-- Pinterest Posting Card (NUR für Single-Pin) -->
        <div class="card shadow-sm mt-4">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #E60023, #BD081C);">
                <h6 class="mb-0"><i class="bi bi-pinterest"></i> Auf Pinterest posten</h6>
            </div>
            <div class="card-body">
                {% if project.pinterest_posted %}
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>Bereits gepostet!</strong><br>
                        <small>Board: {{ project.pinterest_board_name|default:"Unbekannt" }} &bull; {{ project.pinterest_posted_at|date:"d.m.Y H:i" }}</small>
                    </div>
                    {% if project.pinterest_pin_id %}
                        <a href="https://www.pinterest.com/pin/{{ project.pinterest_pin_id }}/"
                           target="_blank" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-box-arrow-up-right me-1"></i>Pin auf Pinterest ansehen
                        </a>
                    {% endif %}
                {% elif pinterest_connected %}
                    <div id="pinterest-posting-section">
                        <div class="mb-3">
                            <label for="pinterest-board" class="form-label">Board auswählen:</label>
                            <select class="form-select" id="pinterest-board" name="board_id">
                                <option value="">Board laden...</option>
                            </select>
                        </div>
                        <button type="button" class="btn w-100" id="btn-post-pinterest"
                                style="background-color: #E60023; color: white;"
                                onclick="postToPinterest()">
                            <i class="bi bi-pinterest me-2"></i>Jetzt auf Pinterest posten
                        </button>
                        <div id="pinterest-result" class="mt-3" style="display: none;"></div>
                    </div>
                {% else %}
                    <!-- Pin It Button - funktioniert ohne API -->
                    {% if project.pinterest_posted %}
                        <!-- Bereits als gepostet markiert -->
                        <div class="alert alert-success mb-3">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>Als gepostet markiert!</strong><br>
                            <small>{{ project.pinterest_posted_at|date:"d.m.Y H:i" }}</small>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="unmarkAsPosted()">
                            <i class="bi bi-x-circle me-1"></i>Markierung entfernen
                        </button>
                    {% elif project.final_image or project.generated_image %}
                        <!-- Pin erstellen (erscheint unter "Erstellt") -->
                        <button type="button" class="btn w-100 mb-2" id="btn-create-pin"
                                style="background-color: #E60023; color: white;"
                                onclick="createPinterestPin()">
                            <i class="bi bi-plus-circle me-2"></i>Pin erstellen
                        </button>
                        <p class="text-muted small mb-3">
                            <i class="bi bi-star-fill text-warning me-1"></i>
                            Erscheint unter "Erstellt" im Profil
                        </p>

                        <!-- Pin merken (erscheint unter "Gemerkt") -->
                        <button type="button" class="btn btn-outline-secondary w-100" id="btn-pin-it"
                                onclick="openPinterestShare()">
                            <i class="bi bi-bookmark me-2"></i>Auf Pinterest merken
                        </button>
                        <p class="text-muted small mt-1 mb-0">
                            Erscheint unter "Gemerkt"
                        </p>
                    {% else %}
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Kein Bild vorhanden. Gehe zurück zu Schritt 3.
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Upload-Post API Card -->
        {% if upload_post_configured %}
        <div class="card shadow-sm mt-4">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                <h6 class="mb-0"><i class="bi bi-cloud-upload"></i> API-Post (Upload-Post.com)</h6>
            </div>
            <div class="card-body">
                {% if project.pinterest_posted %}
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>Bereits gepostet!</strong><br>
                        <small>{{ project.pinterest_board_name|default:"Upload-Post" }} &bull; {{ project.pinterest_posted_at|date:"d.m.Y H:i" }}</small>
                    </div>
                    <!-- Trotzdem posten Button -->
                    <button type="button" class="btn btn-outline-secondary w-100 mb-3" id="btn-repost-toggle" onclick="toggleRepostForm()">
                        <i class="bi bi-arrow-repeat me-2"></i>Trotzdem posten
                    </button>
                    <!-- Verstecktes Repost-Formular -->
                    <div id="repost-section" style="display: none;">
                        <!-- Plattformen Auswahl -->
                        <div class="mb-3">
                            <label class="form-label">Plattformen:</label>
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="pinterest" id="repost-platform-pinterest" checked onchange="toggleRepostPinterestBoard()">
                                        <label class="form-check-label" for="repost-platform-pinterest">
                                            <i class="bi bi-pinterest text-danger me-1"></i> Pinterest
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="instagram" id="repost-platform-instagram" onchange="toggleRepostPlatformOptions('instagram')">
                                        <label class="form-check-label" for="repost-platform-instagram">
                                            <i class="bi bi-instagram me-1" style="color: #E1306C;"></i> Instagram
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="facebook" id="repost-platform-facebook" onchange="toggleRepostPlatformOptions('facebook')">
                                        <label class="form-check-label" for="repost-platform-facebook">
                                            <i class="bi bi-facebook text-primary me-1"></i> Facebook
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="threads" id="repost-platform-threads">
                                        <label class="form-check-label" for="repost-platform-threads">
                                            <i class="bi bi-threads me-1" style="color: #000;"></i> Threads
                                        </label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="x" id="repost-platform-x">
                                        <label class="form-check-label" for="repost-platform-x">
                                            <i class="bi bi-twitter-x me-1" style="color: #000;"></i> X
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="linkedin" id="repost-platform-linkedin" onchange="toggleRepostPlatformOptions('linkedin')">
                                        <label class="form-check-label" for="repost-platform-linkedin">
                                            <i class="bi bi-linkedin me-1" style="color: #0A66C2;"></i> LinkedIn
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="bluesky" id="repost-platform-bluesky">
                                        <label class="form-check-label" for="repost-platform-bluesky">
                                            <i class="bi bi-cloud me-1" style="color: #0085FF;"></i> Bluesky
                                        </label>
                                    </div>
                                    <!-- Reddit nur für Text-Posts unterstützt, nicht für Fotos -->
                                </div>
                            </div>
                        </div>

                        <!-- Plattform-spezifische Optionen (Repost) -->
                        <!-- Instagram Optionen -->
                        <div class="mb-3 repost-platform-options" id="repost-instagram-options" style="display: none;">
                            <div class="card bg-light border-0">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block mb-2"><i class="bi bi-instagram me-1"></i> Instagram Optionen:</small>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small mb-1">Media-Typ:</label>
                                            <select class="form-select form-select-sm" id="repost-instagram-media-type">
                                                <option value="FEED">Beitrag (Feed)</option>
                                                <option value="STORIES">Story</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="repost-instagram-share-to-feed" checked>
                                                <label class="form-check-label small" for="repost-instagram-share-to-feed">Im Feed teilen</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Facebook Optionen -->
                        <div class="mb-3 repost-platform-options" id="repost-facebook-options" style="display: none;">
                            <div class="card bg-light border-0">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block mb-2"><i class="bi bi-facebook me-1"></i> Facebook Optionen:</small>
                                    <div class="row g-2">
                                        <div class="col-12">
                                            <label class="form-label small mb-1">Media-Typ:</label>
                                            <select class="form-select form-select-sm" id="repost-facebook-media-type">
                                                <option value="FEED">Beitrag</option>
                                                <option value="STORIES">Story</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- LinkedIn Optionen -->
                        <div class="mb-3 repost-platform-options" id="repost-linkedin-options" style="display: none;">
                            <div class="card bg-light border-0">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block mb-2"><i class="bi bi-linkedin me-1"></i> LinkedIn Optionen:</small>
                                    <div class="row g-2">
                                        <div class="col-12">
                                            <label class="form-label small mb-1">Sichtbarkeit:</label>
                                            <select class="form-select form-select-sm" id="repost-linkedin-visibility">
                                                <option value="PUBLIC">Öffentlich</option>
                                                <option value="CONNECTIONS">Nur Kontakte</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pinterest Board Auswahl (nur wenn Pinterest aktiviert) -->
                        <div class="mb-3" id="repost-pinterest-board-section">
                            <label for="repost-board" class="form-label">
                                <i class="bi bi-pinterest text-danger me-1"></i> Pinterest Board:
                            </label>
                            <select class="form-select" id="repost-board" name="pinterest_board_id">
                                <option value="">Board laden...</option>
                            </select>
                        </div>

                        <!-- Zeitplanung -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="repost-schedule-enabled" onchange="toggleRepostScheduleFields()">
                                <label class="form-check-label" for="repost-schedule-enabled">
                                    <i class="bi bi-calendar-event me-1"></i> Zeitgesteuert veröffentlichen
                                </label>
                            </div>
                            <div id="repost-schedule-fields" style="display: none;" class="mt-2 ps-4">
                                <div class="row g-2">
                                    <div class="col-7">
                                        <input type="date" class="form-control form-control-sm" id="repost-schedule-date">
                                    </div>
                                    <div class="col-5">
                                        <input type="time" class="form-control form-control-sm" id="repost-schedule-time" value="12:00">
                                    </div>
                                </div>
                                <div class="form-text">Pin wird zum gewählten Zeitpunkt veröffentlicht</div>
                            </div>
                        </div>

                        <button type="button" class="btn w-100" id="btn-repost"
                                style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;"
                                onclick="repostViaUploadPost()">
                            <i class="bi bi-cloud-upload me-2"></i>Jetzt via API posten
                        </button>
                        <div id="repost-result" class="mt-3" style="display: none;"></div>
                    </div>
                {% elif project.final_image or project.generated_image %}
                    <div class="alert alert-info small mb-3">
                        <i class="bi bi-info-circle me-1"></i>
                        Postet direkt über die Upload-Post API auf Pinterest und andere Plattformen.
                    </div>
                    <div id="upload-post-section">
                        <!-- Plattformen Auswahl -->
                        <div class="mb-3">
                            <label class="form-label">Plattformen:</label>
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="pinterest" id="platform-pinterest" checked onchange="togglePinterestBoard()">
                                        <label class="form-check-label" for="platform-pinterest">
                                            <i class="bi bi-pinterest text-danger me-1"></i> Pinterest
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="instagram" id="platform-instagram" onchange="togglePlatformOptions('instagram')">
                                        <label class="form-check-label" for="platform-instagram">
                                            <i class="bi bi-instagram me-1" style="color: #E1306C;"></i> Instagram
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="facebook" id="platform-facebook" onchange="togglePlatformOptions('facebook')">
                                        <label class="form-check-label" for="platform-facebook">
                                            <i class="bi bi-facebook text-primary me-1"></i> Facebook
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="threads" id="platform-threads">
                                        <label class="form-check-label" for="platform-threads">
                                            <i class="bi bi-threads me-1" style="color: #000;"></i> Threads
                                        </label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="x" id="platform-x">
                                        <label class="form-check-label" for="platform-x">
                                            <i class="bi bi-twitter-x me-1" style="color: #000;"></i> X
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="linkedin" id="platform-linkedin" onchange="togglePlatformOptions('linkedin')">
                                        <label class="form-check-label" for="platform-linkedin">
                                            <i class="bi bi-linkedin me-1" style="color: #0A66C2;"></i> LinkedIn
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="bluesky" id="platform-bluesky">
                                        <label class="form-check-label" for="platform-bluesky">
                                            <i class="bi bi-cloud me-1" style="color: #0085FF;"></i> Bluesky
                                        </label>
                                    </div>
                                    <!-- Reddit nur für Text-Posts unterstützt, nicht für Fotos -->
                                </div>
                            </div>
                        </div>

                        <!-- Plattform-spezifische Optionen -->
                        <!-- Instagram Optionen -->
                        <div class="mb-3 platform-options" id="instagram-options" style="display: none;">
                            <div class="card bg-light border-0">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block mb-2"><i class="bi bi-instagram me-1"></i> Instagram Optionen:</small>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small mb-1">Media-Typ:</label>
                                            <select class="form-select form-select-sm" id="instagram-media-type">
                                                <option value="FEED">Beitrag (Feed)</option>
                                                <option value="STORIES">Story</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="instagram-share-to-feed" checked>
                                                <label class="form-check-label small" for="instagram-share-to-feed">Im Feed teilen</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Facebook Optionen -->
                        <div class="mb-3 platform-options" id="facebook-options" style="display: none;">
                            <div class="card bg-light border-0">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block mb-2"><i class="bi bi-facebook me-1"></i> Facebook Optionen:</small>
                                    <div class="row g-2">
                                        <div class="col-12">
                                            <label class="form-label small mb-1">Media-Typ:</label>
                                            <select class="form-select form-select-sm" id="facebook-media-type">
                                                <option value="FEED">Beitrag</option>
                                                <option value="STORIES">Story</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- LinkedIn Optionen -->
                        <div class="mb-3 platform-options" id="linkedin-options" style="display: none;">
                            <div class="card bg-light border-0">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block mb-2"><i class="bi bi-linkedin me-1"></i> LinkedIn Optionen:</small>
                                    <div class="row g-2">
                                        <div class="col-12">
                                            <label class="form-label small mb-1">Sichtbarkeit:</label>
                                            <select class="form-select form-select-sm" id="linkedin-visibility">
                                                <option value="PUBLIC">Öffentlich</option>
                                                <option value="CONNECTIONS">Nur Kontakte</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pinterest Board Auswahl (nur wenn Pinterest aktiviert) -->
                        <div class="mb-3" id="pinterest-board-section">
                            <label for="upload-post-board" class="form-label">
                                <i class="bi bi-pinterest text-danger me-1"></i> Pinterest Board:
                            </label>
                            <select class="form-select" id="upload-post-board" name="pinterest_board_id">
                                <option value="">Board laden...</option>
                            </select>
                            <div class="form-text">Wähle das Board für deinen Pin</div>
                        </div>

                        <!-- Zeitplanung -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="schedule-enabled" onchange="toggleScheduleFields()">
                                <label class="form-check-label" for="schedule-enabled">
                                    <i class="bi bi-calendar-event me-1"></i> Zeitgesteuert veröffentlichen
                                </label>
                            </div>
                            <div id="schedule-fields" style="display: none;" class="mt-2 ps-4">
                                <div class="row g-2">
                                    <div class="col-7">
                                        <input type="date" class="form-control form-control-sm" id="schedule-date">
                                    </div>
                                    <div class="col-5">
                                        <input type="time" class="form-control form-control-sm" id="schedule-time" value="12:00">
                                    </div>
                                </div>
                                <div class="form-text">Pin wird zum gewählten Zeitpunkt veröffentlicht</div>
                            </div>
                        </div>

                        <button type="button" class="btn w-100" id="btn-upload-post"
                                style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;"
                                onclick="postViaUploadPost()">
                            <i class="bi bi-cloud-upload me-2"></i>Jetzt via API posten
                        </button>
                        <div id="upload-post-result" class="mt-3" style="display: none;"></div>
                    </div>
                {% else %}
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Kein Bild vorhanden. Gehe zurück zu Schritt 3.
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-lg-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-link-45deg"></i> Pin-Link</h6>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input type="text" class="form-control" value="{{ project.pin_url }}" readonly id="pinUrl">
                    <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('pinUrl')">
                        <i class="bi bi-clipboard"></i> Kopieren
                    </button>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-type-h1"></i> Pin-Titel</h6>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input type="text" class="form-control" value="{{ project.pin_title }}" readonly id="pinTitle">
                    <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('pinTitle')">
                        <i class="bi bi-clipboard"></i> Kopieren
                    </button>
                </div>
                <small class="text-muted">{{ project.pin_title|length }} / 100 Zeichen</small>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-card-text"></i> Pin-Beschreibung</h6>
            </div>
            <div class="card-body">
                <textarea class="form-control mb-2" rows="5" readonly id="pinDescription">{{ project.seo_description }}</textarea>
                <button class="btn btn-outline-primary" onclick="copyToClipboard('pinDescription')">
                    <i class="bi bi-clipboard"></i> Beschreibung kopieren
                </button>
                <small class="text-muted ms-2">{{ project.seo_description|length }} / 500 Zeichen</small>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Pin-Details</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>Keywords:</strong></td>
                        <td>{{ project.keywords }}</td>
                    </tr>
                    <tr>
                        <td><strong>Overlay-Text:</strong></td>
                        <td>{{ project.overlay_text }}</td>
                    </tr>
                    <tr>
                        <td><strong>Format:</strong></td>
                        <td>{{ project.get_pin_format_display }}</td>
                    </tr>
                    <tr>
                        <td><strong>Erstellt:</strong></td>
                        <td>{{ project.created_at|date:"d.m.Y H:i" }}</td>
                    </tr>
                    {% if project.pinterest_posted %}
                    <tr>
                        <td><strong>Pinterest-Status:</strong></td>
                        <td><span class="badge bg-success"><i class="bi bi-check"></i> Gepostet</span></td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
{% endif %}

        <div class="mt-4 d-flex gap-2 flex-wrap">
            <a href="{% url 'ideopin:wizard_step1' %}" class="btn btn-success">
                <i class="bi bi-plus-lg"></i> Neuen Pin erstellen
            </a>
            <a href="{% url 'ideopin:project_duplicate' project.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-copy"></i> Pin duplizieren
            </a>
            <a href="{% url 'ideopin:project_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-list"></i> Alle Pins
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block wizard_js %}
<script>
const projectId = {{ project.id }};
const csrfToken = '{{ csrf_token }}';

// Pinterest Pin It - funktioniert ohne API
async function openPinterestShare() {
    // Vollständige URLs für Pinterest erstellen
    const baseUrl = window.location.origin;
    {% if project.final_image %}
    const imageUrl = baseUrl + '{{ project.final_image.url }}';
    {% elif project.generated_image %}
    const imageUrl = baseUrl + '{{ project.generated_image.url }}';
    {% else %}
    const imageUrl = '';
    {% endif %}

    const linkUrl = '{{ project.pin_url|escapejs }}' || window.location.href;
    const title = `{{ project.pin_title|escapejs }}`;
    const description = `{{ project.seo_description|escapejs }}`;

    // Kombiniere Titel + Beschreibung für Pinterest
    let fullDescription = description;
    if (title) {
        fullDescription = `${title}\n\n${description}`;
    }

    if (!imageUrl) {
        alert('Kein Bild vorhanden. Bitte zuerst ein Bild generieren.');
        return;
    }

    // Pinterest Share URL erstellen
    const params = new URLSearchParams({
        url: linkUrl,
        media: imageUrl,
        description: fullDescription
    });

    // Pinterest-Fenster öffnen
    const pinterestUrl = `https://www.pinterest.com/pin/create/button/?${params.toString()}`;
    window.open(pinterestUrl, 'pinterest-share', 'width=750,height=600,scrollbars=yes');

    // Automatisch als gepostet markieren
    try {
        await fetch('{% url "ideopin:api_mark_as_posted" project.id %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
        // Seite neu laden um Status zu aktualisieren
        setTimeout(() => window.location.reload(), 1000);
    } catch (e) {
        console.log('Konnte nicht als gepostet markieren:', e);
    }
}

// Pin erstellen - Bild herunterladen, Text kopieren, Pinterest öffnen
async function createPinterestPin() {
    const btn = document.getElementById('btn-create-pin');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Wird vorbereitet...';

    try {
        // 1. Bild-URL und Infos sammeln
        const baseUrl = window.location.origin;
        {% if project.final_image %}
        const imageUrl = baseUrl + '{{ project.final_image.url }}';
        const imageName = 'pin_{{ project.id }}_final.png';
        {% elif project.generated_image %}
        const imageUrl = baseUrl + '{{ project.generated_image.url }}';
        const imageName = 'pin_{{ project.id }}.png';
        {% else %}
        const imageUrl = '';
        const imageName = 'pin.png';
        {% endif %}

        const linkUrl = '{{ project.pin_url|escapejs }}' || window.location.href;
        const title = `{{ project.pin_title|escapejs }}`;
        const description = `{{ project.seo_description|escapejs }}`;

        if (!imageUrl) {
            alert('Kein Bild vorhanden.');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            return;
        }

        // 2. Text für Zwischenablage vorbereiten (Titel + Beschreibung + Link ohne https://)
        const cleanLink = linkUrl.replace(/^https?:\/\//, '');
        let clipboardText = '';
        if (title) {
            clipboardText = `${title}\n\n${description}\n\n${cleanLink}`;
        } else {
            clipboardText = `${description}\n\n${cleanLink}`;
        }

        // 3. In Zwischenablage kopieren
        await navigator.clipboard.writeText(clipboardText);

        // 4. Bild herunterladen
        const response = await fetch(imageUrl);
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = imageName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(downloadUrl);

        // 5. Pinterest Pin-Erstellung öffnen
        window.open('https://www.pinterest.com/pin-creation-tool/', '_blank');

        // 6. Als gepostet markieren
        await fetch('{% url "ideopin:api_mark_as_posted" project.id %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });

        // 7. Erfolgs-Feedback
        btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Bereit!';
        btn.classList.remove('btn-primary');
        btn.style.backgroundColor = '#10b981';

        // Info-Modal anzeigen
        alert('✅ Bild heruntergeladen!\n✅ Beschreibung in Zwischenablage kopiert!\n\n👉 Jetzt bei Pinterest:\n1. Bild hochladen (aus Downloads)\n2. Text einfügen (Strg+V)\n3. Veröffentlichen');

        setTimeout(() => window.location.reload(), 2000);

    } catch (e) {
        console.error('Fehler:', e);
        alert('Fehler: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

// Als gepostet markieren
async function markAsPosted() {
    const btn = document.getElementById('btn-mark-posted');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Markiere...';

    try {
        const response = await fetch('{% url "ideopin:api_mark_as_posted" project.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        const data = await response.json();

        if (data.success) {
            // Seite neu laden um Status zu aktualisieren
            window.location.reload();
        } else {
            alert('Fehler: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    } catch (e) {
        alert('Fehler: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

// Markierung entfernen
async function unmarkAsPosted() {
    if (!confirm('Markierung wirklich entfernen?')) return;

    try {
        const response = await fetch('{% url "ideopin:api_unmark_as_posted" project.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        const data = await response.json();

        if (data.success) {
            window.location.reload();
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (e) {
        alert('Fehler: ' + e.message);
    }
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.value || element.textContent;

    navigator.clipboard.writeText(text).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Kopiert!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');

        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    }).catch(err => {
        alert('Kopieren fehlgeschlagen');
    });
}

// Upload-Post API Funktion
{% if upload_post_configured and not project.pinterest_posted %}
// Boards beim Laden abrufen
document.addEventListener('DOMContentLoaded', function() {
    loadUploadPostBoards();
    // Setze Minimum-Datum auf heute
    const dateInput = document.getElementById('schedule-date');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today;
        dateInput.value = today;
    }
});

function toggleScheduleFields() {
    const checkbox = document.getElementById('schedule-enabled');
    const fields = document.getElementById('schedule-fields');
    if (checkbox && fields) {
        fields.style.display = checkbox.checked ? 'block' : 'none';
    }
}

function togglePinterestBoard() {
    const checkbox = document.getElementById('platform-pinterest');
    const boardSection = document.getElementById('pinterest-board-section');
    if (checkbox && boardSection) {
        boardSection.style.display = checkbox.checked ? 'block' : 'none';
    }
}

// Plattform-spezifische Optionen ein-/ausblenden (Hauptbereich)
function togglePlatformOptions(platform) {
    const checkbox = document.getElementById(`platform-${platform}`);
    const optionsDiv = document.getElementById(`${platform}-options`);
    if (checkbox && optionsDiv) {
        optionsDiv.style.display = checkbox.checked ? 'block' : 'none';
    }
}

// Plattform-spezifische Optionen sammeln (Hauptbereich)
function getPlatformOptions() {
    const options = {};

    // Instagram Optionen
    const instagramChecked = document.getElementById('platform-instagram')?.checked;
    if (instagramChecked) {
        const mediaType = document.getElementById('instagram-media-type')?.value;
        const shareToFeed = document.getElementById('instagram-share-to-feed')?.checked;
        if (mediaType) options.media_type = mediaType;
        if (shareToFeed !== undefined) options.share_to_feed = shareToFeed;
    }

    // Facebook Optionen
    const facebookChecked = document.getElementById('platform-facebook')?.checked;
    if (facebookChecked) {
        const mediaType = document.getElementById('facebook-media-type')?.value;
        if (mediaType) options.facebook_media_type = mediaType;
    }

    // LinkedIn Optionen
    const linkedinChecked = document.getElementById('platform-linkedin')?.checked;
    if (linkedinChecked) {
        const visibility = document.getElementById('linkedin-visibility')?.value;
        if (visibility) options.visibility = visibility;
    }

    return options;
}

function loadUploadPostBoards() {
    const select = document.getElementById('upload-post-board');
    if (!select) return;

    select.innerHTML = '<option value="">Boards werden geladen...</option>';
    select.disabled = true;

    fetch('{% url "ideopin:api_upload_post_boards" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.boards) {
                select.innerHTML = '<option value="">Board auswählen...</option>';
                // Boards können verschiedene Formate haben
                const boards = Array.isArray(data.boards) ? data.boards : [];
                boards.forEach(board => {
                    const option = document.createElement('option');
                    // Flexibles Format: board kann id/name oder board_id/board_name haben
                    option.value = board.id || board.board_id || board.pinterest_board_id || '';
                    const name = board.name || board.board_name || board.title || 'Unbenannt';
                    const pinCount = board.pin_count || board.pins || '';
                    option.textContent = name + (pinCount ? ` (${pinCount} Pins)` : '');
                    select.appendChild(option);
                });
                select.disabled = false;
            } else {
                select.innerHTML = '<option value="">Fehler: ' + (data.error || 'Unbekannt') + '</option>';
                console.error('Upload-Post boards error:', data.error);
            }
        })
        .catch(error => {
            select.innerHTML = '<option value="">Netzwerkfehler</option>';
            console.error('Upload-Post boards fetch error:', error);
        });
}

function postViaUploadPost() {
    const btn = document.getElementById('btn-upload-post');
    const resultDiv = document.getElementById('upload-post-result');
    const boardSelect = document.getElementById('upload-post-board');
    const originalHtml = btn.innerHTML;

    // Plattformen sammeln (Reddit nur für Text-Posts unterstützt)
    const platforms = [];
    if (document.getElementById('platform-pinterest')?.checked) platforms.push('pinterest');
    if (document.getElementById('platform-instagram')?.checked) platforms.push('instagram');
    if (document.getElementById('platform-facebook')?.checked) platforms.push('facebook');
    if (document.getElementById('platform-threads')?.checked) platforms.push('threads');
    if (document.getElementById('platform-x')?.checked) platforms.push('x');
    if (document.getElementById('platform-linkedin')?.checked) platforms.push('linkedin');
    if (document.getElementById('platform-bluesky')?.checked) platforms.push('bluesky');

    if (platforms.length === 0) {
        alert('Bitte wähle mindestens eine Plattform aus.');
        return;
    }

    // Board-ID holen (nur erforderlich wenn Pinterest aktiviert)
    const pinterestBoardId = boardSelect ? boardSelect.value : '';

    if (platforms.includes('pinterest') && !pinterestBoardId) {
        alert('Bitte wähle ein Pinterest Board aus.');
        return;
    }

    // Zeitplanung prüfen
    let scheduledDate = null;
    const scheduleEnabled = document.getElementById('schedule-enabled')?.checked;
    if (scheduleEnabled) {
        const dateVal = document.getElementById('schedule-date')?.value;
        const timeVal = document.getElementById('schedule-time')?.value || '12:00';
        if (dateVal) {
            // ISO-8601 Format erstellen: 2024-12-31T23:45:00Z
            scheduledDate = `${dateVal}T${timeVal}:00Z`;
        }
    }

    // Button deaktivieren und Loading anzeigen
    btn.disabled = true;
    const statusText = scheduledDate ? 'Wird eingeplant...' : 'Wird gepostet...';
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${statusText}`;

    // Request-Daten vorbereiten
    const requestData = {
        platforms: platforms,
        pinterest_board_id: pinterestBoardId,
        platform_options: getPlatformOptions()
    };
    if (scheduledDate) {
        requestData.scheduled_date = scheduledDate;
    }

    fetch('{% url "ideopin:api_upload_post" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';

        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>${data.message}</strong>
                </div>
            `;
            btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Gepostet!';
            btn.style.background = '#10b981';

            // Inputs deaktivieren
            document.querySelectorAll('#upload-post-section input, #upload-post-section select').forEach(el => el.disabled = true);

            // Seite nach 2 Sekunden neu laden
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Fehler:</strong> ${data.error}
                </div>
            `;
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Netzwerkfehler:</strong> ${error.message}
            </div>
        `;
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    });
}
{% endif %}

{% if upload_post_configured and project.pinterest_posted %}
// Repost-Funktionen für bereits gepostete Pins
let repostBoardsLoaded = false;

function toggleRepostForm() {
    const section = document.getElementById('repost-section');
    const btn = document.getElementById('btn-repost-toggle');
    if (section.style.display === 'none') {
        section.style.display = 'block';
        btn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Abbrechen';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-danger');
        // Boards laden wenn noch nicht geschehen
        if (!repostBoardsLoaded) {
            loadRepostBoards();
            repostBoardsLoaded = true;
        }
        // Datum initialisieren
        const dateInput = document.getElementById('repost-schedule-date');
        if (dateInput && !dateInput.value) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            dateInput.value = today;
        }
    } else {
        section.style.display = 'none';
        btn.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i>Trotzdem posten';
        btn.classList.remove('btn-outline-danger');
        btn.classList.add('btn-outline-secondary');
    }
}

function toggleRepostScheduleFields() {
    const checkbox = document.getElementById('repost-schedule-enabled');
    const fields = document.getElementById('repost-schedule-fields');
    if (checkbox && fields) {
        fields.style.display = checkbox.checked ? 'block' : 'none';
    }
}

function toggleRepostPinterestBoard() {
    const checkbox = document.getElementById('repost-platform-pinterest');
    const boardSection = document.getElementById('repost-pinterest-board-section');
    if (checkbox && boardSection) {
        boardSection.style.display = checkbox.checked ? 'block' : 'none';
    }
}

// Plattform-spezifische Optionen ein-/ausblenden (Repost)
function toggleRepostPlatformOptions(platform) {
    const checkbox = document.getElementById(`repost-platform-${platform}`);
    const optionsDiv = document.getElementById(`repost-${platform}-options`);
    if (checkbox && optionsDiv) {
        optionsDiv.style.display = checkbox.checked ? 'block' : 'none';
    }
}

// Plattform-spezifische Optionen sammeln (Repost)
function getRepostPlatformOptions() {
    const options = {};

    // Instagram Optionen
    const instagramChecked = document.getElementById('repost-platform-instagram')?.checked;
    if (instagramChecked) {
        const mediaType = document.getElementById('repost-instagram-media-type')?.value;
        const shareToFeed = document.getElementById('repost-instagram-share-to-feed')?.checked;
        if (mediaType) options.media_type = mediaType;
        if (shareToFeed !== undefined) options.share_to_feed = shareToFeed;
    }

    // Facebook Optionen
    const facebookChecked = document.getElementById('repost-platform-facebook')?.checked;
    if (facebookChecked) {
        const mediaType = document.getElementById('repost-facebook-media-type')?.value;
        if (mediaType) options.facebook_media_type = mediaType;
    }

    // LinkedIn Optionen
    const linkedinChecked = document.getElementById('repost-platform-linkedin')?.checked;
    if (linkedinChecked) {
        const visibility = document.getElementById('repost-linkedin-visibility')?.value;
        if (visibility) options.visibility = visibility;
    }

    return options;
}

function loadRepostBoards() {
    const select = document.getElementById('repost-board');
    if (!select) return;

    select.innerHTML = '<option value="">Boards werden geladen...</option>';
    select.disabled = true;

    fetch('{% url "ideopin:api_upload_post_boards" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.boards) {
                select.innerHTML = '<option value="">Board auswählen...</option>';
                const boards = Array.isArray(data.boards) ? data.boards : [];
                boards.forEach(board => {
                    const option = document.createElement('option');
                    option.value = board.id || board.board_id || board.pinterest_board_id || '';
                    const name = board.name || board.board_name || board.title || 'Unbenannt';
                    const pinCount = board.pin_count || board.pins || '';
                    option.textContent = name + (pinCount ? ` (${pinCount} Pins)` : '');
                    select.appendChild(option);
                });
                select.disabled = false;
            } else {
                select.innerHTML = '<option value="">Fehler: ' + (data.error || 'Unbekannt') + '</option>';
            }
        })
        .catch(error => {
            select.innerHTML = '<option value="">Netzwerkfehler</option>';
        });
}

function repostViaUploadPost() {
    const btn = document.getElementById('btn-repost');
    const resultDiv = document.getElementById('repost-result');
    const boardSelect = document.getElementById('repost-board');
    const originalHtml = btn.innerHTML;

    // Plattformen sammeln (Reddit nur für Text-Posts unterstützt)
    const platforms = [];
    if (document.getElementById('repost-platform-pinterest')?.checked) platforms.push('pinterest');
    if (document.getElementById('repost-platform-instagram')?.checked) platforms.push('instagram');
    if (document.getElementById('repost-platform-facebook')?.checked) platforms.push('facebook');
    if (document.getElementById('repost-platform-threads')?.checked) platforms.push('threads');
    if (document.getElementById('repost-platform-x')?.checked) platforms.push('x');
    if (document.getElementById('repost-platform-linkedin')?.checked) platforms.push('linkedin');
    if (document.getElementById('repost-platform-bluesky')?.checked) platforms.push('bluesky');

    if (platforms.length === 0) {
        alert('Bitte wähle mindestens eine Plattform aus.');
        return;
    }

    // Board-ID holen (nur erforderlich wenn Pinterest aktiviert)
    const pinterestBoardId = boardSelect ? boardSelect.value : '';

    if (platforms.includes('pinterest') && !pinterestBoardId) {
        alert('Bitte wähle ein Pinterest Board aus.');
        return;
    }

    let scheduledDate = null;
    const scheduleEnabled = document.getElementById('repost-schedule-enabled')?.checked;
    if (scheduleEnabled) {
        const dateVal = document.getElementById('repost-schedule-date')?.value;
        const timeVal = document.getElementById('repost-schedule-time')?.value || '12:00';
        if (dateVal) {
            scheduledDate = `${dateVal}T${timeVal}:00Z`;
        }
    }

    btn.disabled = true;
    const statusText = scheduledDate ? 'Wird eingeplant...' : 'Wird gepostet...';
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${statusText}`;

    const requestData = {
        platforms: platforms,
        pinterest_board_id: pinterestBoardId,
        platform_options: getRepostPlatformOptions()
    };
    if (scheduledDate) {
        requestData.scheduled_date = scheduledDate;
    }

    fetch('{% url "ideopin:api_upload_post" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';

        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>${data.message}</strong>
                </div>
            `;
            btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Gepostet!';
            btn.style.background = '#10b981';
            document.querySelectorAll('#repost-section input, #repost-section select').forEach(el => el.disabled = true);
            setTimeout(() => window.location.reload(), 2000);
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Fehler:</strong> ${data.error}
                </div>
            `;
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Netzwerkfehler:</strong> ${error.message}
            </div>
        `;
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    });
}
{% endif %}

{% if pinterest_connected and not project.pinterest_posted %}
// Pinterest-Boards beim Laden abrufen
document.addEventListener('DOMContentLoaded', function() {
    loadPinterestBoards();
});

function loadPinterestBoards() {
    const select = document.getElementById('pinterest-board');
    select.innerHTML = '<option value="">Boards werden geladen...</option>';
    select.disabled = true;

    fetch('{% url "ideopin:api_pinterest_boards" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.boards) {
                select.innerHTML = '<option value="">Board auswählen...</option>';
                data.boards.forEach(board => {
                    const option = document.createElement('option');
                    option.value = board.id;
                    option.textContent = board.name + (board.pin_count ? ` (${board.pin_count} Pins)` : '');
                    select.appendChild(option);
                });
                select.disabled = false;
            } else {
                select.innerHTML = '<option value="">Fehler beim Laden</option>';
                console.error('Pinterest boards error:', data.error);
            }
        })
        .catch(error => {
            select.innerHTML = '<option value="">Netzwerkfehler</option>';
            console.error('Pinterest boards fetch error:', error);
        });
}

function postToPinterest() {
    const boardSelect = document.getElementById('pinterest-board');
    const boardId = boardSelect.value;
    const resultDiv = document.getElementById('pinterest-result');
    const postBtn = document.getElementById('btn-post-pinterest');

    if (!boardId) {
        alert('Bitte wähle ein Board aus.');
        return;
    }

    // Button deaktivieren und Loading anzeigen
    postBtn.disabled = true;
    postBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Wird gepostet...';

    fetch('{% url "ideopin:api_post_to_pinterest" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            board_id: boardId
        })
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';

        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Erfolgreich gepostet!</strong><br>
                    <a href="${data.pin_url}" target="_blank" class="mt-2 d-inline-block">
                        <i class="bi bi-box-arrow-up-right me-1"></i>Pin auf Pinterest ansehen
                    </a>
                </div>
            `;
            postBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Gepostet!';
            postBtn.classList.remove('btn-danger');
            postBtn.classList.add('btn-success');
            boardSelect.disabled = true;

            // Seite nach 2 Sekunden neu laden um Status zu aktualisieren
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Fehler:</strong> ${data.error}
                </div>
            `;
            postBtn.disabled = false;
            postBtn.innerHTML = '<i class="bi bi-pinterest me-2"></i>Erneut versuchen';
        }
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Netzwerkfehler:</strong> ${error.message}
            </div>
        `;
        postBtn.disabled = false;
        postBtn.innerHTML = '<i class="bi bi-pinterest me-2"></i>Erneut versuchen';
    });
}
{% endif %}

// ========================================
// MULTI-PIN FUNKTIONEN
// ========================================
{% if project.pins.count > 1 %}

// Boards für alle Modals laden
document.addEventListener('DOMContentLoaded', function() {
    loadMultiPinBoards();
    initDateFields();
});

function loadMultiPinBoards() {
    const selects = ['schedulePinBoard', 'distBoard', 'batchBoard'];

    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;

        select.innerHTML = '<option value="">Boards werden geladen...</option>';
        select.disabled = true;
    });

    fetch('{% url "ideopin:api_upload_post_boards" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.boards) {
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;

                    select.innerHTML = '<option value="">Board auswählen...</option>';
                    const boards = Array.isArray(data.boards) ? data.boards : [];
                    boards.forEach(board => {
                        const option = document.createElement('option');
                        option.value = board.id || board.board_id || board.pinterest_board_id || '';
                        const name = board.name || board.board_name || board.title || 'Unbenannt';
                        option.textContent = name;
                        select.appendChild(option);
                    });
                    select.disabled = false;
                });
            }
        })
        .catch(error => {
            console.error('Board loading error:', error);
        });
}

function initDateFields() {
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    // Aktuelle Uhrzeit im HH:MM Format
    const currentTime = now.toTimeString().slice(0, 5);

    // Datum-Felder auf heute setzen
    ['schedulePinDate', 'distStartDate'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.min = today;
            input.value = today;
        }
    });

    // Zeit-Felder auf aktuelle Uhrzeit setzen
    ['schedulePinTime', 'distStartTime'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.value = currentTime;
        }
    });

    // Pinterest-Checkbox Toggle für Board-Feld
    const pinterestCheckbox = document.getElementById('dist-platform-pinterest');
    const boardSection = document.getElementById('distBoardSection');
    if (pinterestCheckbox && boardSection) {
        pinterestCheckbox.addEventListener('change', function() {
            boardSection.style.display = this.checked ? 'block' : 'none';
        });
    }
}

// Schedule Modal öffnen
function openScheduleModal(position) {
    document.getElementById('schedulePinPosition').value = position;
    document.getElementById('scheduleModalPinNumber').textContent = position;

    const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    modal.show();
}

// Schedule speichern
async function saveSchedule() {
    const position = document.getElementById('schedulePinPosition').value;
    const date = document.getElementById('schedulePinDate').value;
    const time = document.getElementById('schedulePinTime').value;
    const boardId = document.getElementById('schedulePinBoard').value;

    if (!date) {
        alert('Bitte wähle ein Datum aus.');
        return;
    }

    const scheduledAt = `${date}T${time}:00`;

    try {
        const response = await fetch(`{% url "ideopin:api_schedule_pin" project.id 999 %}`.replace('999', position), {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                scheduled_at: scheduledAt,
                board_id: boardId
            })
        });
        const data = await response.json();

        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
            alert('Pin erfolgreich geplant!');
            window.location.reload();
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (e) {
        alert('Fehler: ' + e.message);
    }
}

// Vorschau der Verteilung
function previewDistribution() {
    const startDate = document.getElementById('distStartDate').value;
    const startTime = document.getElementById('distStartTime').value;
    const intervalMinutes = parseInt(document.getElementById('distInterval').value);
    const tbody = document.querySelector('#distPreviewTable tbody');

    if (!startDate) {
        alert('Bitte wähle ein Startdatum aus.');
        return;
    }

    tbody.innerHTML = '';

    let currentDate = new Date(`${startDate}T${startTime}:00`);
    const pinCount = {{ project.pins.count }};

    for (let i = 1; i <= pinCount; i++) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><span class="badge bg-primary">Pin ${i}</span></td>
            <td>${currentDate.toLocaleDateString('de-DE')} um ${currentDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}</td>
        `;
        tbody.appendChild(row);

        // Intervall in Minuten addieren
        currentDate.setTime(currentDate.getTime() + intervalMinutes * 60 * 1000);
    }
}

// Verteilung anwenden
async function applyDistribution() {
    const startDate = document.getElementById('distStartDate').value;
    const startTime = document.getElementById('distStartTime').value;
    const intervalMinutes = parseInt(document.getElementById('distInterval').value);
    const boardId = document.getElementById('distBoard').value;

    // Ausgewählte Plattformen sammeln
    const platforms = [];
    if (document.getElementById('dist-platform-pinterest')?.checked) platforms.push('pinterest');
    if (document.getElementById('dist-platform-instagram')?.checked) platforms.push('instagram');
    if (document.getElementById('dist-platform-facebook')?.checked) platforms.push('facebook');
    if (document.getElementById('dist-platform-threads')?.checked) platforms.push('threads');
    if (document.getElementById('dist-platform-bluesky')?.checked) platforms.push('bluesky');
    if (document.getElementById('dist-platform-x')?.checked) platforms.push('x');
    if (document.getElementById('dist-platform-linkedin')?.checked) platforms.push('linkedin');

    if (!startDate) {
        alert('Bitte wähle ein Startdatum aus.');
        return;
    }

    if (platforms.length === 0) {
        alert('Bitte wähle mindestens eine Plattform aus.');
        return;
    }

    // Board nur bei Pinterest erforderlich
    if (platforms.includes('pinterest') && !boardId) {
        alert('Bitte wähle ein Pinterest Board aus.');
        return;
    }

    const btn = document.querySelector('#distributionModal .btn-primary');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Plane Pins...';

    try {
        const response = await fetch('{% url "ideopin:api_apply_distribution" project.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                start_date: `${startDate}T${startTime}:00`,
                interval_minutes: intervalMinutes,
                board_id: boardId,
                platforms: platforms,
                schedule_via_api: true
            })
        });
        const data = await response.json();

        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('distributionModal')).hide();
            let msg = `${data.scheduled_count} Pins geplant!`;
            if (data.api_scheduled_count > 0) {
                msg += ` (${data.api_scheduled_count} via API geplant)`;
            }
            if (data.errors && data.errors.length > 0) {
                msg += '\n\nHinweise:\n' + data.errors.join('\n');
            }
            alert(msg);
            window.location.reload();
        } else {
            let errorMsg = data.error || data.message || (data.errors ? data.errors.join('\n') : 'Unbekannter Fehler');
            alert('Fehler: ' + errorMsg);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check"></i> Verteilung anwenden';
        }
    } catch (e) {
        alert('Fehler: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check"></i> Verteilung anwenden';
    }
}

// Batch-Publish Modal öffnen
function openBatchPublish() {
    const modal = new bootstrap.Modal(document.getElementById('batchPublishModal'));
    modal.show();
}

// Toggle Pinterest Board Auswahl für Batch-Publish
function toggleBatchPinterestBoard() {
    const pinterestChecked = document.getElementById('batch-platform-pinterest')?.checked;
    const boardContainer = document.getElementById('batchBoardContainer');
    if (boardContainer) {
        boardContainer.style.display = pinterestChecked ? 'block' : 'none';
    }
}

// Batch-Publish ausführen
async function executeBatchPublish() {
    const positions = [];
    document.querySelectorAll('.batch-pin-check:checked').forEach(cb => {
        positions.push(parseInt(cb.value));
    });

    const boardId = document.getElementById('batchBoard').value;

    // Ausgewählte Plattformen sammeln
    const platforms = [];
    if (document.getElementById('batch-platform-pinterest')?.checked) platforms.push('pinterest');
    if (document.getElementById('batch-platform-instagram')?.checked) platforms.push('instagram');
    if (document.getElementById('batch-platform-facebook')?.checked) platforms.push('facebook');
    if (document.getElementById('batch-platform-threads')?.checked) platforms.push('threads');
    if (document.getElementById('batch-platform-x')?.checked) platforms.push('x');
    if (document.getElementById('batch-platform-linkedin')?.checked) platforms.push('linkedin');
    if (document.getElementById('batch-platform-bluesky')?.checked) platforms.push('bluesky');

    if (positions.length === 0) {
        alert('Bitte wähle mindestens einen Pin aus.');
        return;
    }

    if (platforms.length === 0) {
        alert('Bitte wähle mindestens eine Plattform aus.');
        return;
    }

    // Board nur bei Pinterest erforderlich
    if (platforms.includes('pinterest') && !boardId) {
        alert('Bitte wähle ein Pinterest Board aus.');
        return;
    }

    const btn = document.querySelector('#batchPublishModal .btn-primary');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Posten...';

    try {
        const response = await fetch('{% url "ideopin:api_publish_batch" project.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                positions: positions,
                board_id: boardId,
                platforms: platforms
            })
        });
        const data = await response.json();

        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('batchPublishModal')).hide();
            let msg = `${data.published_count} Pins erfolgreich veröffentlicht!`;
            if (platforms.length > 1) {
                msg += `\nPlattformen: ${platforms.join(', ')}`;
            }
            if (data.errors && data.errors.length > 0) {
                msg += '\n\nHinweise:\n' + data.errors.join('\n');
            }
            alert(msg);
            window.location.reload();
        } else {
            // Fehler anzeigen - verschiedene Fehlermöglichkeiten abfangen
            let errorMsg = data.error || data.message || (data.errors ? data.errors.join('\n') : 'Unbekannter Fehler');
            alert('Fehler: ' + errorMsg);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-cloud-upload"></i> Ausgewählte veröffentlichen';
        }
    } catch (e) {
        alert('Fehler: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-cloud-upload"></i> Ausgewählte veröffentlichen';
    }
}

// Einzelnen Pin posten
async function postSinglePin(position) {
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
        // Board-ID aus Modal holen (falls gesetzt) oder leer lassen
        const boardSelect = document.getElementById('batchBoard');
        const boardId = boardSelect ? boardSelect.value : '';

        if (!boardId) {
            alert('Bitte wähle zuerst ein Pinterest Board aus (im Batch-Publish Dialog).');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-pinterest"></i>';
            return;
        }

        const response = await fetch(`{% url "ideopin:api_post_single_pin" project.id 999 %}`.replace('999', position), {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                board_id: boardId,
                platforms: ['pinterest']
            })
        });
        const data = await response.json();

        if (data.success) {
            btn.innerHTML = '<i class="bi bi-check"></i>';
            btn.classList.remove('btn-outline-danger');
            btn.classList.add('btn-success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            alert('Fehler: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-pinterest"></i>';
        }
    } catch (e) {
        alert('Fehler: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-pinterest"></i>';
    }
}

{% endif %}
</script>
{% endblock %}
