{% extends 'ideopin/base_wizard.html' %}

{% block wizard_content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-link-45deg"></i> Schritt 4: Pin-Link eingeben</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Wohin soll der Pinterest Pin verlinken? Dies ist die Zielseite,
                    die Nutzer sehen, wenn sie auf deinen Pin klicken.
                </p>

                <form method="post">
                    {% csrf_token %}

                    <div class="mb-4">
                        <label for="{{ form.pin_url.id_for_label }}" class="form-label fw-bold">
                            Ziel-URL
                        </label>
                        <div class="input-group">
                            {{ form.pin_url }}
                            <button type="button" class="btn btn-outline-secondary" id="linkHistoryBtn" title="Frühere Links anzeigen">
                                <i class="bi bi-clock-history"></i>
                            </button>
                        </div>
                        <div class="d-flex gap-2 mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertPrefix('https://')">
                                https://
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertPrefix('https://www.')">
                                https://www.
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertSuffix('.de')">
                                .de
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertSuffix('.com')">
                                .com
                            </button>
                        </div>
                        <div class="form-text">
                            Beispiel: https://deinshop.de/produkt-seite
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb"></i>
                        <strong>Tipp:</strong> Verlinke auf eine spezifische Produktseite
                        oder Landingpage, nicht auf die Startseite.
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'ideopin:wizard_step3' project.id %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Zurück
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            Weiter <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Link-Verlauf Modal -->
<div class="modal fade" id="linkHistoryModal" tabindex="-1" aria-labelledby="linkHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="linkHistoryModalLabel">
                    <i class="bi bi-clock-history"></i> Frühere Links
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="linkHistoryLoading" class="text-center py-4">
                    <span class="spinner-border spinner-border-sm"></span> Lade Links...
                </div>
                <div id="linkHistoryEmpty" class="text-center py-4 text-muted" style="display: none;">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    Noch keine Links gespeichert.
                </div>
                <div id="linkHistoryContent" style="display: none;">
                    <p class="text-muted mb-3">
                        <small>Klicke auf einen Link, um ihn zu übernehmen:</small>
                    </p>
                    <div id="linkHistoryList" class="list-group">
                        <!-- Links werden hier eingefügt -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span id="linkHistoryCount" class="text-muted me-auto"></span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block wizard_js %}
<script>
const urlInput = document.getElementById('{{ form.pin_url.id_for_label }}');

function insertPrefix(text) {
    // Entferne existierendes http:// oder https:// wenn vorhanden
    let currentValue = urlInput.value;
    currentValue = currentValue.replace(/^https?:\/\/(www\.)?/i, '');
    urlInput.value = text + currentValue;
    urlInput.focus();
}

function insertSuffix(text) {
    // Füge Suffix am Ende hinzu (oder ersetze existierende TLD)
    let currentValue = urlInput.value;
    // Entferne existierende TLD am Ende wenn vorhanden
    currentValue = currentValue.replace(/\.(de|com|net|org|at|ch|eu|io)$/i, '');
    urlInput.value = currentValue + text;
    urlInput.focus();
}

document.addEventListener('DOMContentLoaded', function() {
    const linkHistoryBtn = document.getElementById('linkHistoryBtn');

    // Modal-Elemente
    const historyModal = new bootstrap.Modal(document.getElementById('linkHistoryModal'));
    const historyLoading = document.getElementById('linkHistoryLoading');
    const historyEmpty = document.getElementById('linkHistoryEmpty');
    const historyContent = document.getElementById('linkHistoryContent');
    const historyList = document.getElementById('linkHistoryList');
    const historyCount = document.getElementById('linkHistoryCount');

    // Link-Verlauf Button
    linkHistoryBtn.addEventListener('click', async function() {
        historyModal.show();
        historyLoading.style.display = 'block';
        historyEmpty.style.display = 'none';
        historyContent.style.display = 'none';
        historyList.innerHTML = '';

        try {
            const response = await fetch('{% url "ideopin:api_link_history" %}');
            const data = await response.json();

            historyLoading.style.display = 'none';

            if (data.success && data.links && data.links.length > 0) {
                // Aktuellen Link für Duplikat-Check
                const currentLink = urlInput.value.toLowerCase().trim();

                data.links.forEach(link => {
                    const isCurrentLink = link.toLowerCase() === currentLink;

                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = `list-group-item list-group-item-action ${isCurrentLink ? 'active' : ''}`;

                    // Link-Text (vollständig mit Umbruch)
                    const linkText = document.createElement('span');
                    linkText.style.wordBreak = 'break-all';
                    linkText.textContent = link;

                    // Icon am Ende
                    if (isCurrentLink) {
                        const icon = document.createElement('i');
                        icon.className = 'bi bi-check-circle-fill ms-2';
                        linkText.appendChild(icon);
                    }

                    item.appendChild(linkText);

                    if (!isCurrentLink) {
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            urlInput.value = link;
                            historyModal.hide();
                        });
                    } else {
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                        });
                    }

                    historyList.appendChild(item);
                });

                historyCount.textContent = `${data.count} Links gespeichert`;
                historyContent.style.display = 'block';
            } else {
                historyEmpty.style.display = 'block';
                historyCount.textContent = '';
            }
        } catch (error) {
            console.error('Error:', error);
            historyLoading.style.display = 'none';
            historyEmpty.innerHTML = '<i class="bi bi-exclamation-triangle text-danger fs-1 d-block mb-2"></i>Fehler beim Laden.';
            historyEmpty.style.display = 'block';
        }
    });
});
</script>
{% endblock %}
