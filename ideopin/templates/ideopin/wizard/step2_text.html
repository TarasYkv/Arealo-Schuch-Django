{% extends 'ideopin/base_wizard.html' %}

{% block wizard_content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-fonts"></i> Schritt 2: Text-Overlay erstellen</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Gib den Text ein, der auf deinem Pin erscheinen soll.
                    Die KI wählt automatisch ein passendes Design mit Farben und Effekten, die zum Bild kontrastieren.
                </p>

                <form method="post" id="step2Form">
                    {% csrf_token %}

                    <!-- Overlay Text -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Overlay-Text</label>
                        <div class="input-group mb-2">
                            {{ form.overlay_text }}
                            <button type="button" class="btn btn-outline-primary" id="generateTextBtn">
                                <i class="bi bi-magic"></i> Text generieren
                            </button>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="form-text">Kurz und catchy - max. 200 Zeichen</span>
                            <span class="text-counter" id="textCounter">0 / 200</span>
                        </div>
                    </div>

                    <!-- Position -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Text-Position</label>
                        {{ form.text_position }}
                        <div class="form-text">Wo soll der Text im Bild platziert werden?</div>
                    </div>

                    <!-- Text-Hintergrund Optionen -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Text-Hintergrund</label>
                        <div class="form-check mb-2">
                            {{ form.text_background_enabled }}
                            <label class="form-check-label" for="text_background_enabled">
                                Text auf formpassendem Hintergrund platzieren
                            </label>
                            <div class="form-text">Der Text wird auf einem farblich passenden Hintergrund-Element platziert</div>
                        </div>
                        <div class="form-check ms-4" id="creativeFormsOption" style="display: none;">
                            {{ form.text_background_creative }}
                            <label class="form-check-label" for="text_background_creative">
                                Kreative Formen erlauben
                            </label>
                            <div class="form-text">Hintergrund kann kreative Formen haben (Banner, Ribbon, Splash, etc.)</div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-magic"></i>
                        <strong>KI-Design:</strong> Die KI wählt automatisch Schriftart, Farben und Effekte,
                        die perfekt zum generierten Hintergrundbild passen und optimal kontrastieren.
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'ideopin:wizard_step1_edit' project.id %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Zurück
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            Weiter <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Vorschau-Card -->
        <div class="card shadow-sm mt-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-eye"></i> Text-Vorschau</h6>
            </div>
            <div class="card-body">
                <div class="pin-preview" id="textPreview" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 12px;
                    min-height: 200px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: relative;
                    overflow: hidden;
                ">
                    <div id="previewTextContainer" style="
                        width: 80%;
                        text-align: center;
                        padding: 20px;
                    ">
                        <span id="previewText" style="
                            font-size: 28px;
                            font-weight: bold;
                            color: #FFFFFF;
                            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
                            line-height: 1.3;
                            display: block;
                        ">
                            {{ project.overlay_text|default:"Dein Text hier..." }}
                        </span>
                    </div>
                </div>
                <p class="text-muted mt-3 small text-center">
                    <i class="bi bi-info-circle"></i> Das finale Styling wird von der KI beim Generieren des Bildes erstellt
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block wizard_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const textInput = document.querySelector('#{{ form.overlay_text.id_for_label }}');
    const textCounter = document.getElementById('textCounter');
    const previewText = document.getElementById('previewText');
    const previewContainer = document.getElementById('previewTextContainer');
    const generateTextBtn = document.getElementById('generateTextBtn');
    const positionSelect = document.querySelector('[name="text_position"]');
    const pinPreview = document.getElementById('textPreview');
    const textBgEnabled = document.getElementById('text_background_enabled');
    const textBgCreative = document.getElementById('text_background_creative');
    const creativeFormsOption = document.getElementById('creativeFormsOption');

    // Text-Hintergrund Option: Zeige/Verstecke kreative Formen Option
    function updateCreativeFormsVisibility() {
        if (textBgEnabled && textBgEnabled.checked) {
            creativeFormsOption.style.display = 'block';
        } else {
            creativeFormsOption.style.display = 'none';
            if (textBgCreative) textBgCreative.checked = false;
        }
        updatePreviewBackground();
    }

    // Preview mit/ohne Hintergrund aktualisieren
    function updatePreviewBackground() {
        if (textBgEnabled && textBgEnabled.checked) {
            previewContainer.style.background = 'rgba(0,0,0,0.6)';
            previewContainer.style.borderRadius = textBgCreative && textBgCreative.checked ? '20px 5px 20px 5px' : '8px';
            previewContainer.style.padding = '15px 25px';
        } else {
            previewContainer.style.background = 'transparent';
            previewContainer.style.borderRadius = '0';
            previewContainer.style.padding = '20px';
        }
    }

    if (textBgEnabled) {
        textBgEnabled.addEventListener('change', updateCreativeFormsVisibility);
        updateCreativeFormsVisibility();
    }
    if (textBgCreative) {
        textBgCreative.addEventListener('change', updatePreviewBackground);
    }

    // Text counter & preview update
    function updateCounter() {
        const len = textInput.value.length;
        textCounter.textContent = `${len} / 200`;
        textCounter.className = 'text-counter';
        if (len > 180) textCounter.classList.add('text-danger');
        else if (len > 150) textCounter.classList.add('text-warning');

        previewText.textContent = textInput.value || 'Dein Text hier...';
    }

    // Update preview position
    function updatePreviewPosition() {
        const position = positionSelect?.value || 'center';
        switch(position) {
            case 'top':
                pinPreview.style.alignItems = 'flex-start';
                previewContainer.style.marginTop = '20px';
                previewContainer.style.marginBottom = '0';
                break;
            case 'bottom':
                pinPreview.style.alignItems = 'flex-end';
                previewContainer.style.marginTop = '0';
                previewContainer.style.marginBottom = '20px';
                break;
            default:
                pinPreview.style.alignItems = 'center';
                previewContainer.style.margin = '0';
        }
    }

    // Event listeners
    textInput.addEventListener('input', updateCounter);
    updateCounter();

    if (positionSelect) {
        positionSelect.addEventListener('change', updatePreviewPosition);
        updatePreviewPosition();
    }

    // Generate text via AI
    generateTextBtn.addEventListener('click', async function() {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generiere...';

        try {
            const response = await fetch('{% url "ideopin:api_generate_text" project.id %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            if (data.success) {
                textInput.value = data.text;
                updateCounter();
            } else {
                alert('Fehler: ' + data.error);
            }
        } catch (e) {
            alert('Fehler bei der Textgenerierung');
        }

        this.disabled = false;
        this.innerHTML = '<i class="bi bi-magic"></i> Text generieren';
    });
});
</script>
{% endblock %}
