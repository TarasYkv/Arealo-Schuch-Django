{% extends "base.html" %}
{% load form_extras %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col">
                            <h4 class="mb-0">
                                <i class="fas fa-calculator me-2"></i>
                                Wirtschaftlichkeitsrechner
                            </h4>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-light text-dark">
                                Schritt {{ step }} von {{ total_steps }}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="progress mb-4" style="height: 6px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: {% widthratio step total_steps 100 %}%"></div>
                    </div>

                    <h5 class="card-title">{{ page_title }}</h5>
                    <p class="text-muted mb-4">
                        Konfigurieren Sie das LMS (Lichtmanagementsystem) für optimale Energieeffizienz.
                    </p>

                    <form method="post" novalidate>
                        {% csrf_token %}

                        <!-- LMS Grundkonfiguration -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-microchip text-primary me-2"></i>
                                    LMS Grundkonfiguration
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <div class="form-check form-switch">
                                            {{ lms_form.lms_aktiviert|add_class:"form-check-input" }}
                                            <label class="form-check-label" for="{{ lms_form.lms_aktiviert.id_for_label }}">
                                                <strong>{{ lms_form.lms_aktiviert.label }}</strong>
                                            </label>
                                            <div class="form-text">{{ lms_form.lms_aktiviert.help_text }}</div>
                                        </div>
                                    </div>
                                </div>

                                <div id="lms-config" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label" for="{{ lms_form.lms_grundkosten.id_for_label }}">
                                                {{ lms_form.lms_grundkosten.label }}
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">€</span>
                                                {{ lms_form.lms_grundkosten|add_class:"form-control" }}
                                            </div>
                                            <div class="form-text">{{ lms_form.lms_grundkosten.help_text }}</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label" for="{{ lms_form.lms_aufpreis_pro_leuchte.id_for_label }}">
                                                {{ lms_form.lms_aufpreis_pro_leuchte.label }}
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">€</span>
                                                {{ lms_form.lms_aufpreis_pro_leuchte|add_class:"form-control" }}
                                                <span class="input-group-text">/Stück</span>
                                            </div>
                                            <div class="form-text">{{ lms_form.lms_aufpreis_pro_leuchte.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bewegungsmelder -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-walking text-success me-2"></i>
                                    Bewegungsmelder
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <div class="form-check form-switch">
                                            {{ motion_form.bewegungsmelder_aktiviert|add_class:"form-check-input" }}
                                            <label class="form-check-label" for="{{ motion_form.bewegungsmelder_aktiviert.id_for_label }}">
                                                <strong>{{ motion_form.bewegungsmelder_aktiviert.label }}</strong>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div id="motion-config" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label" for="{{ motion_form.bewegungsmelder_anzahl.id_for_label }}">
                                                {{ motion_form.bewegungsmelder_anzahl.label }}
                                            </label>
                                            <div class="input-group">
                                                {{ motion_form.bewegungsmelder_anzahl|add_class:"form-control" }}
                                                <span class="input-group-text">Stück</span>
                                            </div>
                                            <div class="form-text">{{ motion_form.bewegungsmelder_anzahl.help_text }}</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label" for="{{ motion_form.bewegungsmelder_abwesenheit_niveau.id_for_label }}">
                                                {{ motion_form.bewegungsmelder_abwesenheit_niveau.label }}
                                            </label>
                                            <div class="input-group">
                                                {{ motion_form.bewegungsmelder_abwesenheit_niveau|add_class:"form-control" }}
                                                <span class="input-group-text">%</span>
                                            </div>
                                            <div class="form-text">{{ motion_form.bewegungsmelder_abwesenheit_niveau.help_text }}</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label" for="{{ motion_form.bewegungsmelder_anwesenheit_niveau.id_for_label }}">
                                                {{ motion_form.bewegungsmelder_anwesenheit_niveau.label }}
                                            </label>
                                            <div class="input-group">
                                                {{ motion_form.bewegungsmelder_anwesenheit_niveau|add_class:"form-control" }}
                                                <span class="input-group-text">%</span>
                                            </div>
                                            <div class="form-text">{{ motion_form.bewegungsmelder_anwesenheit_niveau.help_text }}</div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Frequentierung</label>
                                            <div class="input-group">
                                                {{ motion_form.bewegungsmelder_frequentierung_stunden|add_class:"form-control" }}
                                                <span class="input-group-text">h</span>
                                                {{ motion_form.bewegungsmelder_frequentierung_minuten|add_class:"form-control" }}
                                                <span class="input-group-text">min</span>
                                            </div>
                                            <div class="form-text">{{ motion_form.bewegungsmelder_frequentierung_stunden.help_text }}</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label" for="{{ motion_form.bewegungsmelder_mehrkosten.id_for_label }}">
                                                {{ motion_form.bewegungsmelder_mehrkosten.label }}
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">€</span>
                                                {{ motion_form.bewegungsmelder_mehrkosten|add_class:"form-control" }}
                                            </div>
                                            <div class="form-text">{{ motion_form.bewegungsmelder_mehrkosten.help_text }}</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Fade-Zeiten</label>
                                            <div class="input-group">
                                                {{ motion_form.bewegungsmelder_fadein|add_class:"form-control" }}
                                                <span class="input-group-text">s In</span>
                                                {{ motion_form.bewegungsmelder_fadeout|add_class:"form-control" }}
                                                <span class="input-group-text">s Out</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tageslichtabhängige Regelung -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-sun text-warning me-2"></i>
                                    Tageslichtabhängige Regelung
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <div class="form-check form-switch">
                                            {{ daylight_form.tageslicht_aktiviert|add_class:"form-check-input" }}
                                            <label class="form-check-label" for="{{ daylight_form.tageslicht_aktiviert.id_for_label }}">
                                                <strong>{{ daylight_form.tageslicht_aktiviert.label }}</strong>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div id="daylight-config" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label" for="{{ daylight_form.tageslicht_anzahl.id_for_label }}">
                                                {{ daylight_form.tageslicht_anzahl.label }}
                                            </label>
                                            <div class="input-group">
                                                {{ daylight_form.tageslicht_anzahl|add_class:"form-control" }}
                                                <span class="input-group-text">Stück</span>
                                            </div>
                                            <div class="form-text">{{ daylight_form.tageslicht_anzahl.help_text }}</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label" for="{{ daylight_form.tageslicht_reduzierung_niveau.id_for_label }}">
                                                {{ daylight_form.tageslicht_reduzierung_niveau.label }}
                                            </label>
                                            <div class="input-group">
                                                {{ daylight_form.tageslicht_reduzierung_niveau|add_class:"form-control" }}
                                                <span class="input-group-text">%</span>
                                            </div>
                                            <div class="form-text">{{ daylight_form.tageslicht_reduzierung_niveau.help_text }}</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label" for="{{ daylight_form.tageslicht_mehrkosten.id_for_label }}">
                                                {{ daylight_form.tageslicht_mehrkosten.label }}
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">€</span>
                                                {{ daylight_form.tageslicht_mehrkosten|add_class:"form-control" }}
                                            </div>
                                            <div class="form-text">{{ daylight_form.tageslicht_mehrkosten.help_text }}</div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Tageslichtnutzung</label>
                                            <div class="input-group">
                                                {{ daylight_form.tageslicht_nutzung_stunden|add_class:"form-control" }}
                                                <span class="input-group-text">h</span>
                                                {{ daylight_form.tageslicht_nutzung_minuten|add_class:"form-control" }}
                                                <span class="input-group-text">min</span>
                                            </div>
                                            <div class="form-text">{{ daylight_form.tageslicht_nutzung_stunden.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Kalendersteuerung -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-calendar-alt text-info me-2"></i>
                                    Kalendersteuerung
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <div class="form-check form-switch">
                                            {{ calendar_form.kalender_aktiviert|add_class:"form-check-input" }}
                                            <label class="form-check-label" for="{{ calendar_form.kalender_aktiviert.id_for_label }}">
                                                <strong>{{ calendar_form.kalender_aktiviert.label }}</strong>
                                            </label>
                                            <div class="form-text">{{ calendar_form.kalender_aktiviert.help_text }}</div>
                                        </div>
                                    </div>
                                </div>

                                <div id="calendar-config" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label" for="{{ calendar_form.kalender_anzahl_ausschalttage.id_for_label }}">
                                                {{ calendar_form.kalender_anzahl_ausschalttage.label }}
                                            </label>
                                            <div class="input-group">
                                                {{ calendar_form.kalender_anzahl_ausschalttage|add_class:"form-control" }}
                                                <span class="input-group-text">Tage</span>
                                            </div>
                                            <div class="form-text">{{ calendar_form.kalender_anzahl_ausschalttage.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'amortization_calculator:wizard_step3' calc_id=calculation.id %}"
                               class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Zurück
                            </a>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-calculator me-2"></i>
                                Berechnung durchführen
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Progress Footer -->
                <div class="card-footer bg-light">
                    <div class="row text-center text-muted small">
                        <div class="col">
                            <i class="fas fa-check text-success"></i>
                            Projektdaten
                        </div>
                        <div class="col">
                            {% if calculation.neue_anlage_vorhanden %}
                                <i class="fas fa-check text-success"></i>
                            {% else %}
                                <i class="fas fa-minus text-muted"></i>
                            {% endif %}
                            Bestandsanlage
                        </div>
                        <div class="col">
                            <i class="fas fa-check text-success"></i>
                            LED-Anlage
                        </div>
                        <div class="col">
                            <i class="fas fa-lightbulb text-warning"></i>
                            LMS
                        </div>
                        <div class="col">
                            {% if step > 4 %}
                                <i class="fas fa-check text-success"></i>
                            {% else %}
                                <i class="fas fa-circle"></i>
                            {% endif %}
                            Ergebnisse
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Card -->
            <div class="card border-success mt-4">
                <div class="card-body">
                    <h6 class="text-success"><i class="fas fa-info-circle me-2"></i>LMS Einsparpotential</h6>
                    <div class="row small text-muted">
                        <div class="col-md-4">
                            <strong>Bewegungsmelder:</strong><br>
                            Bis zu 60% Einsparung in wenig frequentierten Bereichen
                        </div>
                        <div class="col-md-4">
                            <strong>Tageslichtregelung:</strong><br>
                            Bis zu 40% Einsparung bei guter Tageslichtversorgung
                        </div>
                        <div class="col-md-4">
                            <strong>Kalendersteuerung:</strong><br>
                            Automatische Abschaltung an Feiertagen und Ferienzeiten
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle-Funktionen für die verschiedenen LMS-Module
    const toggleConfigs = [
        { checkbox: '{{ lms_form.lms_aktiviert.id_for_label }}', config: 'lms-config' },
        { checkbox: '{{ motion_form.bewegungsmelder_aktiviert.id_for_label }}', config: 'motion-config' },
        { checkbox: '{{ daylight_form.tageslicht_aktiviert.id_for_label }}', config: 'daylight-config' },
        { checkbox: '{{ calendar_form.kalender_aktiviert.id_for_label }}', config: 'calendar-config' }
    ];

    toggleConfigs.forEach(({ checkbox, config }) => {
        const checkboxElement = document.getElementById(checkbox);
        const configElement = document.getElementById(config);

        if (checkboxElement && configElement) {
            function updateVisibility() {
                if (checkboxElement.checked) {
                    configElement.style.display = 'block';
                } else {
                    configElement.style.display = 'none';
                }
            }

            checkboxElement.addEventListener('change', updateVisibility);
            updateVisibility(); // Initial call
        }
    });

    // Validation: Ensure motion + daylight doesn't exceed total fixture count
    const motionAnzahl = document.getElementById('{{ motion_form.bewegungsmelder_anzahl.id_for_label }}');
    const daylightAnzahl = document.getElementById('{{ daylight_form.tageslicht_anzahl.id_for_label }}');

    function validateFixtureCounts() {
        if (motionAnzahl && daylightAnzahl) {
            const motion = parseInt(motionAnzahl.value) || 0;
            const daylight = parseInt(daylightAnzahl.value) || 0;
            const total = {{ calculation.neu_anzahl|default:0 }};

            if ((motion + daylight) > total && total > 0) {
                const warningId = 'fixture-count-warning';
                let warning = document.getElementById(warningId);

                if (!warning) {
                    warning = document.createElement('div');
                    warning.id = warningId;
                    warning.className = 'card border-warning mt-2';
                    warning.innerHTML = '<div class="card-body py-2"><small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i> Die Summe der gesteuerten Leuchten übersteigt die Gesamtanzahl!</small></div>';

                    const form = document.querySelector('form');
                    if (form) {
                        form.appendChild(warning);
                    }
                }
            } else {
                const existingWarning = document.getElementById('fixture-count-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
            }
        }
    }

    if (motionAnzahl) motionAnzahl.addEventListener('input', validateFixtureCounts);
    if (daylightAnzahl) daylightAnzahl.addEventListener('input', validateFixtureCounts);

    // Initial validation
    validateFixtureCounts();
});
</script>
{% endblock %}