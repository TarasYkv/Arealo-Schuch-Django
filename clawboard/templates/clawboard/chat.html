{% extends "clawboard/base_dark.html" %}
{% load static %}

{% block title %}KI-Chat - Clawboard{% endblock %}

{% block cb_body %}
<!-- Chat-Sidebar -->
<div class="cb-sidebar">
    <div class="cb-sidebar-header">
        <h6><i class="bi bi-chat-dots me-2"></i>Chats</h6>
        <button class="cb-btn-new" onclick="showNewChatModal()">
            <i class="bi bi-plus-lg"></i>
        </button>
    </div>
    <div class="cb-chat-list" id="chat-list">
        {% for chat in chats %}
            <a href="{% url 'clawboard:chat_detail' chat.pk %}"
               class="cb-chat-item {% if active_chat and active_chat.pk == chat.pk %}active{% endif %}"
               data-chat-id="{{ chat.pk }}">
                <div class="cb-chat-item-content">
                    <div class="cb-chat-title">{{ chat.title|default:"Neuer Chat"|truncatechars:28 }}</div>
                    <div class="cb-chat-meta">{{ chat.get_provider_display }} &middot; {{ chat.message_count }} Nachr.</div>
                </div>
                <button class="cb-chat-delete"
                        onclick="event.preventDefault(); event.stopPropagation(); deleteChat({{ chat.pk }});"
                        title="Loeschen">
                    <i class="bi bi-x-lg"></i>
                </button>
            </a>
        {% empty %}
            <div class="cb-empty-hint">Noch keine Chats</div>
        {% endfor %}
    </div>
    <div class="cb-sidebar-footer">
        <div class="cb-connector-status">
            <i class="bi bi-circle-fill me-1 {% if connector_online %}text-success{% else %}text-danger{% endif %}" style="font-size:0.5rem;"></i>
            <span style="font-size:0.7rem; color: #6c7086;">
                Connector {% if connector_online %}Online{% else %}Offline{% endif %}
            </span>
        </div>
        <div class="cb-models-label mt-2"><i class="bi bi-cloud me-1"></i>Gateway-Modelle</div>
        <div class="cb-models-list">
            {% for model in gateway_models %}
                <span class="cb-model-badge"><i class="bi {{ model.icon }}"></i> {{ model.name }}</span>
            {% empty %}
                <span class="cb-empty-hint small">Noch keine Modelle</span>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Haupt-Chat-Bereich -->
<div class="cb-main">
    {% if active_chat %}
        <div class="cb-main-header">
            <div>
                <span class="cb-main-title" id="chat-title">{{ active_chat.title|default:"Neuer Chat" }}</span>
                <span class="cb-main-model">
                    {% if active_chat.chat_mode == 'gateway' %}
                        <i class="bi bi-cloud me-1"></i>Gateway
                    {% else %}
                        <i class="bi bi-lightning me-1"></i>Direkt
                    {% endif %}
                    &middot; {{ active_chat.model_name }}
                </span>
            </div>
            <span class="cb-msg-count" id="msg-count">{{ active_chat.message_count }} Nachrichten</span>
        </div>
        <div class="cb-messages" id="messages-container">
            {% for msg in active_chat.messages %}
                {% if msg.role == 'user' %}
                    <div class="cb-msg cb-msg-user">
                        <div class="cb-msg-bubble cb-msg-bubble-user">{{ msg.content }}</div>
                    </div>
                {% elif msg.role == 'assistant' %}
                    <div class="cb-msg cb-msg-ai">
                        <div class="cb-msg-bubble cb-msg-bubble-ai">{{ msg.content }}</div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="cb-input-area">
            <form id="chat-form" onsubmit="sendMessage(event)" class="cb-input-form">
                <textarea class="cb-textarea" id="message-input" rows="2"
                          placeholder="Nachricht eingeben..."
                          onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendMessage(event);}"></textarea>
                <button class="cb-send-btn" type="submit" id="send-btn">
                    <i class="bi bi-send-fill"></i>
                </button>
            </form>
            <div class="cb-input-hint">Enter = Senden &middot; Shift+Enter = Neue Zeile</div>
        </div>
    {% else %}
        <div class="cb-empty-chat-state">
            <i class="bi bi-chat-dots display-1"></i>
            <h4>Starte einen neuen Chat</h4>
            <p>Chat ueber deinen lokalen OpenClaw Gateway.</p>
            {% if connector_online %}
                <button class="cb-btn-start" onclick="showNewChatModal()">
                    <i class="bi bi-plus-lg me-2"></i>Neuer Chat
                </button>
            {% else %}
                <div class="cb-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Connector ist offline. Starte den <a href="{% url 'clawboard:connector_setup' %}">Connector</a> auf deinem Rechner.
                </div>
                <button class="cb-btn-start mt-3" onclick="showNewChatModal()" style="opacity:0.7;">
                    <i class="bi bi-plus-lg me-2"></i>Trotzdem starten
                </button>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

<!-- Modal: Neuer Chat -->
{% block cb_extra_script %}
<div class="modal fade" id="newChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: #1e1e2e; color: #cdd6f4; border: 1px solid #45475a;">
            <div class="modal-header" style="border-color: #45475a;">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Neuer Chat</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Chat-Modus Toggle -->
                <div class="mb-3">
                    <label class="form-label">Modus</label>
                    <div class="cb-mode-toggle">
                        <button type="button" class="cb-mode-btn active" data-mode="gateway" onclick="setChatMode('gateway')">
                            <i class="bi bi-cloud me-1"></i>Gateway (OpenClaw)
                        </button>
                        <button type="button" class="cb-mode-btn" data-mode="direct" onclick="setChatMode('direct')">
                            <i class="bi bi-lightning me-1"></i>Direkt (API Key)
                        </button>
                    </div>
                </div>

                <!-- Gateway-Modelle -->
                <div class="mb-3" id="gateway-model-section">
                    <label class="form-label">Gateway-Modell waehlen</label>
                    <select class="form-select" id="gateway-model-select" style="background: #313244; color: #cdd6f4; border-color: #45475a;">
                        {% for model in gateway_models %}
                            <option value="gateway|{{ model.id }}">
                                {{ model.name }} {% if model.provider %}({{ model.provider }}){% endif %}
                            </option>
                        {% empty %}
                            <option value="" disabled selected>Keine Gateway-Modelle verfuegbar</option>
                        {% endfor %}
                    </select>
                    {% if not connector_online %}
                        <div class="form-text text-warning" style="font-size:0.75rem;">
                            <i class="bi bi-exclamation-triangle me-1"></i>Connector ist offline
                        </div>
                    {% endif %}
                </div>

                <!-- Direkte Modelle (versteckt by default) -->
                <div class="mb-3 d-none" id="direct-model-section">
                    <label class="form-label">API-Modell waehlen</label>
                    <select class="form-select" id="direct-model-select" style="background: #313244; color: #cdd6f4; border-color: #45475a;">
                        {% for model in available_models %}
                            <option value="{{ model.provider }}|{{ model.id }}">
                                {{ model.name }} ({{ model.description }})
                            </option>
                        {% empty %}
                            <option value="" disabled selected>Keine API-Keys konfiguriert</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Titel (optional)</label>
                    <input type="text" class="form-control" id="chat-title-input" placeholder="z.B. Python Hilfe..."
                           style="background: #313244; color: #cdd6f4; border-color: #45475a;">
                </div>
            </div>
            <div class="modal-footer" style="border-color: #45475a;">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn" onclick="createChat()" style="background: #89b4fa; color: #1e1e2e; font-weight: 600;">
                    <i class="bi bi-chat-dots me-1"></i>Chat starten
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const CSRF_TOKEN = '{{ csrf_token }}';
const CHAT_CREATE_API = '{% url "clawboard:api_chat_create" %}';
const CHAT_SEND_API = '{% url "clawboard:api_chat_send" %}';
const CHAT_POLL_API = '{% url "clawboard:api_chat_poll" %}';
{% if active_chat %}const ACTIVE_CHAT_ID = {{ active_chat.pk }};{% else %}const ACTIVE_CHAT_ID = null;{% endif %}
{% if active_chat %}const ACTIVE_CHAT_MODE = '{{ active_chat.chat_mode }}';{% else %}const ACTIVE_CHAT_MODE = 'gateway';{% endif %}

let selectedChatMode = 'gateway';

function scrollToBottom() {
    const c = document.getElementById('messages-container');
    if (c) c.scrollTop = c.scrollHeight;
}
document.addEventListener('DOMContentLoaded', scrollToBottom);

function showNewChatModal() { new bootstrap.Modal(document.getElementById('newChatModal')).show(); }

function setChatMode(mode) {
    selectedChatMode = mode;
    document.querySelectorAll('.cb-mode-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.mode === mode);
    });
    document.getElementById('gateway-model-section').classList.toggle('d-none', mode !== 'gateway');
    document.getElementById('direct-model-section').classList.toggle('d-none', mode !== 'direct');
}

function createChat() {
    let select, chatMode;
    if (selectedChatMode === 'gateway') {
        select = document.getElementById('gateway-model-select');
        chatMode = 'gateway';
    } else {
        select = document.getElementById('direct-model-select');
        chatMode = 'direct';
    }
    const title = document.getElementById('chat-title-input').value.trim();
    if (!select || !select.value) { alert('Bitte ein Modell waehlen'); return; }
    const parts = select.value.split('|');
    fetch(CHAT_CREATE_API, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN},
        body: JSON.stringify({provider: parts[0], model: parts[1], title: title, chat_mode: chatMode}),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) window.location.href = '/clawboard/chat/' + data.chat.id + '/';
        else alert(data.error || 'Fehler');
    })
    .catch(err => alert('Fehler: ' + err.message));
}

const LOADING_TEXTS = [
    'Sende an Gateway...',
    'Warte auf Connector...',
    'KI denkt nach...',
    'Verarbeite Antwort...',
    'Gleich fertig...',
];

function sendMessage(e) {
    e.preventDefault();
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    if (!message || !ACTIVE_CHAT_ID) return;
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    input.disabled = true;
    appendMessage('user', message);
    input.value = '';
    const loadingId = appendLoading();

    fetch(CHAT_SEND_API, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN},
        body: JSON.stringify({chat_id: ACTIVE_CHAT_ID, message: message}),
    })
    .then(r => r.json())
    .then(data => {
        if (data.pending && data.request_id) {
            // Gateway-Modus: Polling starten
            pollForResponse(data.request_id, loadingId, sendBtn, input);
        } else {
            // Direkt-Modus: Sofortige Antwort
            removeLoading(loadingId);
            resetInput(sendBtn, input);
            if (data.success) {
                appendMessage('assistant', data.response);
                updateChatInfo(data);
            } else {
                appendMessage('assistant', data.error || 'Fehler bei der KI-Antwort');
            }
        }
    })
    .catch(err => {
        removeLoading(loadingId);
        resetInput(sendBtn, input);
        appendMessage('assistant', 'Netzwerkfehler: ' + err.message);
    });
}

function pollForResponse(requestId, loadingId, sendBtn, input) {
    let pollCount = 0;
    const maxPolls = 60; // 60 * 2s = 120s
    let textIndex = 0;

    const interval = setInterval(() => {
        pollCount++;

        // Loading-Text rotieren
        if (pollCount % 3 === 0) {
            textIndex = Math.min(textIndex + 1, LOADING_TEXTS.length - 1);
            updateLoadingText(loadingId, LOADING_TEXTS[textIndex]);
        }

        if (pollCount > maxPolls) {
            clearInterval(interval);
            removeLoading(loadingId);
            resetInput(sendBtn, input);
            appendMessage('assistant', 'Timeout - keine Antwort vom Gateway nach 120 Sekunden.');
            return;
        }

        fetch(CHAT_POLL_API + '?request_id=' + requestId, {
            headers: {'X-CSRFToken': CSRF_TOKEN},
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'completed') {
                clearInterval(interval);
                removeLoading(loadingId);
                resetInput(sendBtn, input);
                appendMessage('assistant', data.response);
                updateChatInfo(data);
            } else if (data.status === 'error' || data.status === 'timeout') {
                clearInterval(interval);
                removeLoading(loadingId);
                resetInput(sendBtn, input);
                appendMessage('assistant', data.error || 'Fehler vom Gateway');
            }
            // queued/processing: weiter pollen
        })
        .catch(() => {
            // Netzwerkfehler beim Poll - weiter versuchen
        });
    }, 2000);
}

function resetInput(sendBtn, input) {
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<i class="bi bi-send-fill"></i>';
    input.disabled = false;
    input.focus();
}

function updateChatInfo(data) {
    if (data.chat_title) {
        const t = document.getElementById('chat-title');
        if (t) t.textContent = data.chat_title;
    }
    if (data.message_count) {
        const c = document.getElementById('msg-count');
        if (c) c.textContent = data.message_count + ' Nachrichten';
    }
}

function appendMessage(role, content) {
    const container = document.getElementById('messages-container');
    if (!container) return;
    const msg = document.createElement('div');
    msg.className = 'cb-msg ' + (role === 'user' ? 'cb-msg-user' : 'cb-msg-ai');
    const bubble = document.createElement('div');
    bubble.className = 'cb-msg-bubble ' + (role === 'user' ? 'cb-msg-bubble-user' : 'cb-msg-bubble-ai');
    bubble.textContent = content;
    msg.appendChild(bubble);
    container.appendChild(msg);
    scrollToBottom();
}

let loadingCounter = 0;
function appendLoading() {
    const container = document.getElementById('messages-container');
    if (!container) return null;
    const id = 'loading-' + (++loadingCounter);
    const el = document.createElement('div');
    el.id = id;
    el.className = 'cb-msg cb-msg-ai';
    el.innerHTML = '<div class="cb-msg-bubble cb-msg-bubble-ai"><span class="spinner-border spinner-border-sm me-2"></span><span class="loading-text">Sende an Gateway...</span></div>';
    container.appendChild(el);
    scrollToBottom();
    return id;
}

function updateLoadingText(id, text) {
    if (!id) return;
    const el = document.getElementById(id);
    if (el) {
        const span = el.querySelector('.loading-text');
        if (span) span.textContent = text;
    }
}

function removeLoading(id) { if (id) { const el = document.getElementById(id); if (el) el.remove(); } }

function deleteChat(chatId) {
    if (!confirm('Chat loeschen?')) return;
    fetch('/clawboard/api/chat/' + chatId + '/delete/', {
        method: 'POST',
        headers: {'X-CSRFToken': CSRF_TOKEN, 'X-Requested-With': 'XMLHttpRequest'},
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            if (ACTIVE_CHAT_ID === chatId) window.location.href = '/clawboard/chat/';
            else { const el = document.querySelector('[data-chat-id="' + chatId + '"]'); if (el) el.remove(); }
        }
    });
}
</script>
{% endblock %}

{% block cb_extra_style %}
<style>
/* Chat needs full-height without overflow */
.cb-wrapper { overflow: hidden; }

/* --- Chat-Sidebar --- */
.cb-sidebar {
    width: 260px; background: #1e1e2e; border-right: 1px solid #313244;
    display: flex; flex-direction: column; flex-shrink: 0;
}
.cb-sidebar-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 14px 14px 10px; border-bottom: 1px solid #313244;
}
.cb-sidebar-header h6 { margin: 0; color: #cdd6f4; font-size: 0.9rem; }
.cb-btn-new {
    background: #89b4fa; color: #1e1e2e; border: none; border-radius: 8px;
    width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 0.9rem; font-weight: 700; transition: background 0.15s;
}
.cb-btn-new:hover { background: #b4d0fb; }

.cb-chat-list { flex: 1; overflow-y: auto; padding: 8px; }
.cb-chat-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 10px; border-radius: 8px; color: #a6adc8; text-decoration: none;
    margin-bottom: 2px; transition: background 0.1s;
}
.cb-chat-item:hover { background: #313244; color: #cdd6f4; }
.cb-chat-item.active { background: #89b4fa22; color: #89b4fa; }
.cb-chat-item-content { flex: 1; min-width: 0; }
.cb-chat-title { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cb-chat-meta { font-size: 0.65rem; opacity: 0.6; }
.cb-chat-delete {
    background: none; border: none; color: #6c7086; cursor: pointer;
    opacity: 0; transition: opacity 0.15s; padding: 2px 4px; font-size: 0.75rem;
}
.cb-chat-item:hover .cb-chat-delete { opacity: 1; }
.cb-chat-delete:hover { color: #f38ba8; }

.cb-sidebar-footer { padding: 10px 14px; border-top: 1px solid #313244; }
.cb-models-label { font-size: 0.7rem; color: #6c7086; margin-bottom: 6px; }
.cb-models-list { display: flex; flex-wrap: wrap; gap: 4px; }
.cb-model-badge { font-size: 0.6rem; padding: 3px 7px; border-radius: 6px; background: #313244; color: #a6adc8; }
.cb-empty-hint { text-align: center; color: #6c7086; font-size: 0.8rem; padding: 20px 0; }

/* --- Haupt-Chat-Bereich --- */
.cb-main { flex: 1; display: flex; flex-direction: column; background: #11111b; min-width: 0; }
.cb-main-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 20px; border-bottom: 1px solid #313244; background: #1e1e2e;
}
.cb-main-title { color: #cdd6f4; font-weight: 600; font-size: 0.95rem; }
.cb-main-model { color: #6c7086; font-size: 0.75rem; margin-left: 10px; }
.cb-msg-count { font-size: 0.7rem; color: #6c7086; background: #313244; padding: 4px 10px; border-radius: 12px; }

/* --- Messages --- */
.cb-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
.cb-msg { display: flex; }
.cb-msg-user { justify-content: flex-end; }
.cb-msg-ai { justify-content: flex-start; }
.cb-msg-bubble { max-width: 70%; padding: 10px 14px; border-radius: 14px; font-size: 0.88rem; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
.cb-msg-bubble-user { background: #89b4fa; color: #1e1e2e; border-bottom-right-radius: 4px; }
.cb-msg-bubble-ai { background: #313244; color: #cdd6f4; border-bottom-left-radius: 4px; }

/* --- Input --- */
.cb-input-area { padding: 12px 20px 10px; border-top: 1px solid #313244; background: #1e1e2e; }
.cb-input-form { display: flex; gap: 8px; }
.cb-textarea {
    flex: 1; background: #313244; border: 1px solid #45475a; border-radius: 12px;
    color: #cdd6f4; padding: 10px 14px; font-size: 0.88rem; resize: none; outline: none; font-family: inherit;
}
.cb-textarea:focus { border-color: #89b4fa; }
.cb-textarea::placeholder { color: #6c7086; }
.cb-send-btn {
    background: #89b4fa; color: #1e1e2e; border: none; border-radius: 12px;
    width: 44px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 1.1rem; transition: background 0.15s;
}
.cb-send-btn:hover { background: #b4d0fb; }
.cb-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.cb-input-hint { text-align: center; font-size: 0.65rem; color: #45475a; margin-top: 6px; }

/* --- Chat Empty State --- */
.cb-empty-chat-state {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: #6c7086; gap: 8px;
}
.cb-empty-chat-state h4 { color: #a6adc8; }
.cb-btn-start {
    background: #89b4fa; color: #1e1e2e; border: none; border-radius: 12px;
    padding: 12px 28px; font-size: 1rem; font-weight: 600; cursor: pointer;
    margin-top: 10px; transition: background 0.15s;
}
.cb-btn-start:hover { background: #b4d0fb; }
.cb-warning { background: #45475a; color: #f9e2af; padding: 12px 20px; border-radius: 10px; margin-top: 10px; }
.cb-warning a { color: #89b4fa; }

/* --- Scrollbar --- */
.cb-chat-list::-webkit-scrollbar, .cb-messages::-webkit-scrollbar { width: 6px; }
.cb-chat-list::-webkit-scrollbar-track, .cb-messages::-webkit-scrollbar-track { background: transparent; }
.cb-chat-list::-webkit-scrollbar-thumb, .cb-messages::-webkit-scrollbar-thumb { background: #45475a; border-radius: 3px; }

/* --- Mode Toggle --- */
.cb-mode-toggle { display: flex; gap: 4px; }
.cb-mode-btn {
    flex: 1; padding: 8px 12px; background: #313244; color: #a6adc8;
    border: 1px solid #45475a; border-radius: 8px; font-size: 0.8rem;
    cursor: pointer; transition: all 0.15s; text-align: center;
}
.cb-mode-btn:hover { background: #45475a; color: #cdd6f4; }
.cb-mode-btn.active { background: #89b4fa22; color: #89b4fa; border-color: #89b4fa; }

.cb-connector-status { padding: 4px 0; }

@media (max-width: 768px) { .cb-sidebar { width: 200px; } }
@media (max-width: 576px) { .cb-sidebar { display: none; } }
</style>
{% endblock %}
