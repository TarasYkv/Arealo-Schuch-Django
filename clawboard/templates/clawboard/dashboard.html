{% extends "base.html" %}
{% load static %}

{% block title %}Clawboard - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="bi bi-robot me-2"></i>Clawboard
            </h1>
            <p class="text-muted mb-0">Dein Clawdbot Dashboard</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            {% if active_connection %}
                <button id="btn-refresh" class="btn btn-outline-primary" onclick="refreshDashboard()">
                    <i class="bi bi-arrow-clockwise me-1" id="refresh-icon"></i>Aktualisieren
                </button>
                <span id="status-badge" class="badge bg-{{ active_connection.status|default:'secondary' }} fs-6">
                    <i class="bi bi-circle-fill me-1"></i>
                    <span id="status-text">{{ active_connection.get_status_display|default:"Unbekannt" }}</span>
                </span>
            {% else %}
                <a href="{% url 'clawboard:connection_add' %}" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-1"></i>Verbindung hinzuf√ºgen
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
        <div id="refresh-toast" class="toast align-items-center border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toast-message"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    {% if not active_connection %}
        <!-- Keine Verbindung -->
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-robot display-1 text-muted mb-3"></i>
                <h4>Willkommen bei Clawboard!</h4>
                <p class="text-muted mb-4">
                    Verbinde dich mit deinem Clawdbot um loszulegen.
                </p>
                <a href="{% url 'clawboard:connection_add' %}" class="btn btn-primary btn-lg">
                    <i class="bi bi-plug me-2"></i>Erste Verbindung einrichten
                </a>
            </div>
        </div>
    {% else %}
        <!-- Dashboard mit aktiver Verbindung -->
        <div class="row g-4">
            <!-- System Status -->
            <div class="col-12 col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-speedometer2 me-2"></i>System
                            {% if active_connection.hostname %}
                                <small class="text-muted ms-2">{{ active_connection.hostname }}</small>
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body" id="system-card">
                        {% if system_status.cpu is not None %}
                            <!-- CPU -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-muted">CPU</small>
                                    <small id="cpu-value">{{ system_status.cpu|default:"-" }}%</small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-primary" id="cpu-bar" style="width: {{ system_status.cpu|default:0 }}%"></div>
                                </div>
                            </div>

                            <!-- RAM -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-muted">RAM</small>
                                    <small id="ram-value">{{ system_status.ram_used|default:"-" }} / {{ system_status.ram_total|default:"-" }} MB</small>
                                </div>
                                {% if system_status.ram_total %}
                                    {% widthratio system_status.ram_used system_status.ram_total 100 as ram_percent %}
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success" id="ram-bar" style="width: {{ ram_percent }}%"></div>
                                    </div>
                                {% else %}
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success" id="ram-bar" style="width: 0%"></div>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Disk -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-muted">Speicher</small>
                                    <small id="disk-value">{{ system_status.disk_used|default:"-" }} / {{ system_status.disk_total|default:"-" }} GB</small>
                                </div>
                                {% if system_status.disk_total %}
                                    {% widthratio system_status.disk_used system_status.disk_total 100 as disk_percent %}
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-warning" id="disk-bar" style="width: {{ disk_percent }}%"></div>
                                    </div>
                                {% else %}
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-warning" id="disk-bar" style="width: 0%"></div>
                                    </div>
                                {% endif %}
                            </div>

                            <hr>
                            <small class="text-muted" id="last-seen-text">
                                <i class="bi bi-clock me-1"></i>
                                Zuletzt gesehen: {% if system_status.last_seen %}{{ system_status.last_seen|timesince }}{% else %}Nie{% endif %}
                            </small>
                        {% else %}
                            <div class="text-center my-4" id="system-empty">
                                <i class="bi bi-cloud-slash display-4 text-muted"></i>
                                <p class="text-muted mt-2 mb-1">Keine System-Daten</p>
                                <small class="text-muted">
                                    Starte den Connector auf deinem Rechner,<br>
                                    damit Daten hier angezeigt werden.
                                </small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Projekte -->
            <div class="col-12 col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-folder me-2"></i>Projekte
                        </h5>
                        <a href="{% url 'clawboard:project_list' %}" class="btn btn-sm btn-outline-primary">
                            Alle
                        </a>
                    </div>
                    <div class="card-body" id="projects-card">
                        {% if projects %}
                            <ul class="list-group list-group-flush">
                                {% for project in projects %}
                                    <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                        <div>
                                            <span style="color: {{ project.color }}">{{ project.icon|default:"üìÅ" }}</span>
                                            <a href="{% url 'clawboard:project_detail' project.pk %}" class="text-decoration-none ms-2">
                                                {{ project.name }}
                                            </a>
                                        </div>
                                        <span class="badge bg-{{ project.status }}">{{ project.get_status_display }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted text-center my-4">
                                Noch keine Projekte
                            </p>
                        {% endif %}
                        <a href="{% url 'clawboard:project_add' %}" class="btn btn-sm btn-outline-secondary w-100 mt-3">
                            <i class="bi bi-plus me-1"></i>Neues Projekt
                        </a>
                    </div>
                </div>
            </div>

            <!-- Integrationen -->
            <div class="col-12 col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-plug me-2"></i>Integrationen
                        </h5>
                    </div>
                    <div class="card-body" id="integrations-card">
                        {% if integrations %}
                            <div class="row g-2">
                                {% for integration in integrations %}
                                    <div class="col-6">
                                        <div class="d-flex align-items-center p-2 rounded bg-light">
                                            <i class="bi {{ integration.icon|default:'bi-check-circle' }} text-success me-2"></i>
                                            <small>{{ integration.name }}</small>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted text-center my-4">
                                Wird automatisch erkannt
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Zweite Reihe: Skills & Konversationen -->
        <div class="row g-4 mt-2">
            <!-- Skills -->
            <div class="col-12 col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-lightning me-2"></i>Skills
                        </h5>
                    </div>
                    <div class="card-body" id="skills-card">
                        {% if skills %}
                            <div class="d-flex flex-wrap gap-2">
                                {% for skill in skills %}
                                    <span class="badge bg-{% if skill.category == 'language' %}primary{% else %}secondary{% endif %} bg-opacity-10 text-{% if skill.category == 'language' %}primary{% else %}secondary{% endif %} border px-3 py-2">
                                        <i class="bi {{ skill.icon }} me-1"></i>{{ skill.name }}
                                        {% if skill.version %}<small class="opacity-75 ms-1">{{ skill.version|truncatechars:30 }}</small>{% endif %}
                                    </span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted text-center my-4">
                                Wird automatisch erkannt
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Geplante Aufgaben -->
            <div class="col-12 col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-clock me-2"></i>Geplante Aufgaben
                        </h5>
                    </div>
                    <div class="card-body" id="tasks-card">
                        {% if scheduled_tasks %}
                            <ul class="list-group list-group-flush">
                                {% for task in scheduled_tasks %}
                                    <li class="list-group-item px-0">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong>{{ task.name }}</strong>
                                                <br>
                                                <small class="text-muted">{{ task.schedule }}</small>
                                            </div>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted text-center my-4">
                                Keine geplanten Aufgaben
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Dritte Reihe: Konversationen -->
        <div class="row g-4 mt-2">
            <!-- Letzte Konversationen -->
            <div class="col-12 col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-chat-dots me-2"></i>Letzte Konversationen
                        </h5>
                        <a href="{% url 'clawboard:conversation_list' %}" class="btn btn-sm btn-outline-primary">
                            Alle
                        </a>
                    </div>
                    <div class="card-body" id="conversations-card">
                        {% if recent_conversations %}
                            <ul class="list-group list-group-flush">
                                {% for conv in recent_conversations %}
                                    <li class="list-group-item px-0">
                                        <a href="{% url 'clawboard:conversation_detail' conv.pk %}" class="text-decoration-none">
                                            <div class="d-flex justify-content-between">
                                                <strong>{{ conv.title|default:"Untitled"|truncatechars:40 }}</strong>
                                                <small class="text-muted">{{ conv.started_at|timesince }}</small>
                                            </div>
                                            <small class="text-muted">
                                                {{ conv.message_count }} Nachrichten ¬∑ {{ conv.channel|default:"unknown" }}
                                            </small>
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted text-center my-4">
                                Noch keine Konversationen
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Memory Browser Link -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm bg-light">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">
                                <i class="bi bi-file-earmark-text me-2"></i>Memory Browser
                            </h5>
                            <p class="text-muted mb-0">Durchsuche und bearbeite deine .md Dateien</p>
                        </div>
                        <a href="{% url 'clawboard:memory_browser' %}" class="btn btn-primary">
                            <i class="bi bi-folder2-open me-1"></i>√ñffnen
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connector-Hilfe -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card border-0 shadow-sm" id="connector-help">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-cloud-download text-primary me-3 fs-4"></i>
                            <div>
                                <h6 class="mb-1">Connector einrichten</h6>
                                <p class="text-muted mb-0 small">
                                    Lade den Connector herunter und starte ihn auf deinem Rechner,
                                    damit System-Daten und Memory-Dateien hier erscheinen.
                                </p>
                            </div>
                        </div>
                        <a href="{% url 'clawboard:connector_setup' %}" class="btn btn-primary ms-3">
                            <i class="bi bi-download me-1"></i>Connector Setup
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

{% if active_connection %}
<script>
const DASHBOARD_API = '{% url "clawboard:api_dashboard_refresh" %}';
const CONNECTION_ID = {{ active_connection.pk }};

function showToast(message, type) {
    const toast = document.getElementById('refresh-toast');
    const toastMsg = document.getElementById('toast-message');
    toast.className = 'toast align-items-center border-0 text-white bg-' + (type || 'primary');
    toastMsg.textContent = message;
    const bsToast = new bootstrap.Toast(toast, {delay: 3000});
    bsToast.show();
}

function setRefreshing(active) {
    const btn = document.getElementById('btn-refresh');
    const icon = document.getElementById('refresh-icon');
    if (active) {
        btn.disabled = true;
        icon.classList.add('spin-animation');
        btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1 spin-animation" id="refresh-icon"></i>Laden...';
    } else {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1" id="refresh-icon"></i>Aktualisieren';
    }
}

function updateStatusBadge(conn) {
    const badge = document.getElementById('status-badge');
    const text = document.getElementById('status-text');
    if (conn.is_online) {
        badge.className = 'badge bg-success fs-6';
        text.textContent = 'Online';
    } else if (conn.status === 'offline') {
        badge.className = 'badge bg-secondary fs-6';
        text.textContent = 'Offline';
    } else {
        badge.className = 'badge bg-warning fs-6';
        text.textContent = conn.status || 'Unbekannt';
    }
}

function updateSystemCard(system, conn) {
    const card = document.getElementById('system-card');
    const emptyState = document.getElementById('system-empty');

    if (system.cpu !== null && system.cpu !== undefined) {
        // System-Daten vorhanden - ggf. Empty-State entfernen
        if (emptyState) {
            // Karte komplett neu rendern mit Daten
            card.innerHTML = buildSystemHTML(system, conn);
        } else {
            // Werte aktualisieren
            const cpuVal = document.getElementById('cpu-value');
            const cpuBar = document.getElementById('cpu-bar');
            if (cpuVal) cpuVal.textContent = system.cpu + '%';
            if (cpuBar) cpuBar.style.width = system.cpu + '%';

            const ramVal = document.getElementById('ram-value');
            const ramBar = document.getElementById('ram-bar');
            if (ramVal) ramVal.textContent = (system.ram_used || '-') + ' / ' + (system.ram_total || '-') + ' MB';
            if (ramBar && system.ram_total) ramBar.style.width = (system.ram_used / system.ram_total * 100) + '%';

            const diskVal = document.getElementById('disk-value');
            const diskBar = document.getElementById('disk-bar');
            if (diskVal) diskVal.textContent = (system.disk_used || '-') + ' / ' + (system.disk_total || '-') + ' GB';
            if (diskBar && system.disk_total) diskBar.style.width = (system.disk_used / system.disk_total * 100) + '%';

            const lastSeen = document.getElementById('last-seen-text');
            if (lastSeen) {
                lastSeen.innerHTML = '<i class="bi bi-clock me-1"></i>Zuletzt gesehen: ' + conn.last_seen_display;
            }
        }
    }
}

function buildSystemHTML(system, conn) {
    const ramPct = system.ram_total ? (system.ram_used / system.ram_total * 100).toFixed(0) : 0;
    const diskPct = system.disk_total ? (system.disk_used / system.disk_total * 100).toFixed(0) : 0;
    return `
        <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
                <small class="text-muted">CPU</small>
                <small id="cpu-value">${system.cpu || 0}%</small>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-primary" id="cpu-bar" style="width: ${system.cpu || 0}%"></div>
            </div>
        </div>
        <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
                <small class="text-muted">RAM</small>
                <small id="ram-value">${system.ram_used || '-'} / ${system.ram_total || '-'} MB</small>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-success" id="ram-bar" style="width: ${ramPct}%"></div>
            </div>
        </div>
        <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
                <small class="text-muted">Speicher</small>
                <small id="disk-value">${system.disk_used || '-'} / ${system.disk_total || '-'} GB</small>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-warning" id="disk-bar" style="width: ${diskPct}%"></div>
            </div>
        </div>
        <hr>
        <small class="text-muted" id="last-seen-text">
            <i class="bi bi-clock me-1"></i>
            Zuletzt gesehen: ${conn.last_seen_display}
        </small>
    `;
}

function updateIntegrationsCard(integrations) {
    const card = document.getElementById('integrations-card');
    if (!card) return;

    if (integrations.length === 0) {
        card.innerHTML = '<p class="text-muted text-center my-4">Wird automatisch erkannt</p>';
        return;
    }

    let html = '<div class="row g-2">';
    integrations.forEach(function(integ) {
        const icon = integ.icon || 'bi-check-circle';
        html += `<div class="col-6"><div class="d-flex align-items-center p-2 rounded bg-light"><i class="bi ${icon} text-success me-2"></i><small>${integ.name}</small></div></div>`;
    });
    html += '</div>';
    card.innerHTML = html;
}

function updateSkillsCard(skills) {
    const card = document.getElementById('skills-card');
    if (!card) return;

    if (!skills || skills.length === 0) {
        card.innerHTML = '<p class="text-muted text-center my-4">Wird automatisch erkannt</p>';
        return;
    }

    let html = '<div class="d-flex flex-wrap gap-2">';
    skills.forEach(function(sk) {
        const cls = sk.category === 'language' ? 'primary' : 'secondary';
        const icon = sk.icon || 'bi-code-square';
        const ver = sk.version ? `<small class="opacity-75 ms-1">${sk.version.substring(0, 30)}</small>` : '';
        html += `<span class="badge bg-${cls} bg-opacity-10 text-${cls} border px-3 py-2"><i class="bi ${icon} me-1"></i>${sk.name}${ver}</span>`;
    });
    html += '</div>';
    card.innerHTML = html;
}

function updateConversationsCard(conversations) {
    const card = document.getElementById('conversations-card');
    if (!card) return;

    if (conversations.length === 0) {
        card.innerHTML = '<p class="text-muted text-center my-4">Noch keine Konversationen</p>';
        return;
    }

    let html = '<ul class="list-group list-group-flush">';
    conversations.forEach(function(conv) {
        const title = conv.title.length > 40 ? conv.title.substring(0, 37) + '...' : conv.title;
        html += `
            <li class="list-group-item px-0">
                <a href="/clawboard/conversations/${conv.pk}/" class="text-decoration-none">
                    <div class="d-flex justify-content-between">
                        <strong>${title}</strong>
                        <small class="text-muted">${conv.age_display}</small>
                    </div>
                    <small class="text-muted">${conv.message_count} Nachrichten &middot; ${conv.channel}</small>
                </a>
            </li>`;
    });
    html += '</ul>';
    card.innerHTML = html;
}

function updateTasksCard(tasks) {
    const card = document.getElementById('tasks-card');
    if (!card) return;

    if (tasks.length === 0) {
        card.innerHTML = '<p class="text-muted text-center my-4">Keine geplanten Aufgaben</p>';
        return;
    }

    let html = '<ul class="list-group list-group-flush">';
    tasks.forEach(function(task) {
        html += `
            <li class="list-group-item px-0">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${task.name}</strong><br>
                        <small class="text-muted">${task.schedule}</small>
                    </div>
                </div>
            </li>`;
    });
    html += '</ul>';
    card.innerHTML = html;
}

function refreshDashboard() {
    setRefreshing(true);

    fetch(DASHBOARD_API, {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        setRefreshing(false);

        if (!data.success) {
            showToast('Keine aktive Verbindung gefunden', 'warning');
            return;
        }

        // Status-Badge aktualisieren
        updateStatusBadge(data.connection);

        // System-Karte aktualisieren
        updateSystemCard(data.system, data.connection);

        // Integrations aktualisieren
        updateIntegrationsCard(data.integrations);

        // Skills aktualisieren
        updateSkillsCard(data.skills);

        // Konversationen aktualisieren
        updateConversationsCard(data.conversations);

        // Tasks aktualisieren
        updateTasksCard(data.tasks);

        // Connector-Hilfe ausblenden wenn Daten da sind
        const help = document.getElementById('connector-help');
        if (help && data.connection.is_online) {
            help.style.display = 'none';
        }

        if (data.connection.is_online) {
            showToast('Dashboard aktualisiert', 'success');
        } else if (data.connection.last_seen) {
            showToast('Daten geladen (Connector offline seit ' + data.connection.last_seen_display + ')', 'warning');
        } else {
            showToast('Keine Daten vom Connector - starte den Connector auf deinem Rechner', 'warning');
        }
    })
    .catch(function(err) {
        setRefreshing(false);
        showToast('Fehler beim Laden: ' + err.message, 'danger');
    });
}

// Auto-refresh alle 60 Sekunden
setInterval(refreshDashboard, 60000);
</script>

<style>
.spin-animation {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endif %}
{% endblock %}
