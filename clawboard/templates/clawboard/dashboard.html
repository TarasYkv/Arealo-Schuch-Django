{% extends "clawboard/base_dark.html" %}
{% load static %}

{% block title %}Clawboard - Dashboard{% endblock %}

{% block cb_page %}
<!-- Header -->
<div class="cb-header">
    <div>
        <h1 class="cb-title"><i class="bi bi-robot me-2"></i>Clawboard</h1>
        <span class="cb-subtitle">Dein Clawdbot Dashboard</span>
    </div>
    <div class="cb-header-actions">
        {% if active_connection %}
            <button id="btn-refresh" class="cb-btn cb-btn-outline" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise me-1" id="refresh-icon"></i>Aktualisieren
            </button>
            <button class="cb-btn cb-btn-warn" onclick="restartConnector()" title="Connector neu starten">
                <i class="bi bi-arrow-repeat me-1"></i>Neu starten
            </button>
            <span id="status-badge" class="cb-status-badge {% if active_connection.status == 'online' %}online{% else %}offline{% endif %}">
                <i class="bi bi-circle-fill me-1"></i>
                <span id="status-text">{{ active_connection.get_status_display|default:"Unbekannt" }}</span>
            </span>
        {% else %}
            <a href="{% url 'clawboard:connection_add' %}" class="cb-btn cb-btn-primary">
                <i class="bi bi-plus-lg me-1"></i>Verbindung hinzufuegen
            </a>
        {% endif %}
    </div>
</div>

<!-- Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <div id="refresh-toast" class="toast align-items-center border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toast-message"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

{% if not active_connection %}
    <div class="cb-empty-state">
        <i class="bi bi-robot display-1"></i>
        <h4>Willkommen bei Clawboard!</h4>
        <p>Verbinde dich mit deinem Clawdbot um loszulegen.</p>
        <a href="{% url 'clawboard:connection_add' %}" class="cb-btn cb-btn-primary cb-btn-lg">
            <i class="bi bi-plug me-2"></i>Erste Verbindung einrichten
        </a>
    </div>
{% else %}
    <div class="cb-grid">
        <!-- System Status -->
        <div class="cb-card">
            <div class="cb-card-header">
                <h6><i class="bi bi-speedometer2 me-2"></i>System</h6>
                {% if active_connection.hostname %}
                    <span class="cb-card-badge">{{ active_connection.hostname }}</span>
                {% endif %}
            </div>
            <div class="cb-card-body" id="system-card">
                {% if system_status.cpu is not None %}
                    <div class="cb-meter">
                        <div class="cb-meter-label"><span>CPU</span><span id="cpu-value">{{ system_status.cpu|default:"-" }}%</span></div>
                        <div class="cb-progress"><div class="cb-progress-bar cb-bar-blue" id="cpu-bar" style="width: {{ system_status.cpu|default:0 }}%"></div></div>
                    </div>
                    <div class="cb-meter">
                        <div class="cb-meter-label"><span>RAM</span><span id="ram-value">{{ system_status.ram_used|default:"-" }} / {{ system_status.ram_total|default:"-" }} MB</span></div>
                        <div class="cb-progress">
                            {% if system_status.ram_total %}{% widthratio system_status.ram_used system_status.ram_total 100 as ram_percent %}{% endif %}
                            <div class="cb-progress-bar cb-bar-green" id="ram-bar" style="width: {{ ram_percent|default:0 }}%"></div>
                        </div>
                    </div>
                    <div class="cb-meter">
                        <div class="cb-meter-label"><span>Speicher</span><span id="disk-value">{{ system_status.disk_used|default:"-" }} / {{ system_status.disk_total|default:"-" }} GB</span></div>
                        <div class="cb-progress">
                            {% if system_status.disk_total %}{% widthratio system_status.disk_used system_status.disk_total 100 as disk_percent %}{% endif %}
                            <div class="cb-progress-bar cb-bar-yellow" id="disk-bar" style="width: {{ disk_percent|default:0 }}%"></div>
                        </div>
                    </div>
                    <div class="cb-card-footer-info" id="last-seen-text">
                        <i class="bi bi-clock me-1"></i>
                        Zuletzt gesehen: {% if system_status.last_seen %}{{ system_status.last_seen|timesince }}{% else %}Nie{% endif %}
                    </div>
                {% else %}
                    <div class="cb-card-empty" id="system-empty">
                        <i class="bi bi-cloud-slash"></i>
                        <p>Keine System-Daten</p>
                        <small>Starte den Connector auf deinem Rechner</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Projekte -->
        <div class="cb-card">
            <div class="cb-card-header">
                <h6><i class="bi bi-folder me-2"></i>Projekte</h6>
                <a href="{% url 'clawboard:project_list' %}" class="cb-link">Alle</a>
            </div>
            <div class="cb-card-body" id="projects-card">
                {% if projects %}
                    {% for project in projects %}
                        <a href="{% url 'clawboard:project_detail' project.pk %}" class="cb-list-item">
                            <span>{{ project.icon|default:"" }} {{ project.name }}</span>
                            <span class="cb-tag">{{ project.get_status_display }}</span>
                        </a>
                    {% endfor %}
                {% else %}
                    <div class="cb-card-empty small"><p>Noch keine Projekte</p></div>
                {% endif %}
            </div>
        </div>

        <!-- Integrationen -->
        <div class="cb-card">
            <div class="cb-card-header">
                <h6><i class="bi bi-plug me-2"></i>Integrationen</h6>
            </div>
            <div class="cb-card-body" id="integrations-card">
                {% if api_services or integrations %}
                    <div class="cb-badge-grid">
                        {% for svc in api_services %}
                            <div class="cb-integ-item">
                                <i class="bi {{ svc.icon }} cb-integ-icon"></i>
                                <span>{{ svc.name }}</span>
                            </div>
                        {% endfor %}
                        {% for integration in integrations %}
                            <div class="cb-integ-item">
                                <i class="bi {{ integration.icon|default:'bi-check-circle' }} cb-integ-icon"></i>
                                <span>{{ integration.name }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="cb-card-empty small"><p>Keine Integrationen</p></div>
                {% endif %}
            </div>
        </div>

        <!-- Skills -->
        <div class="cb-card">
            <div class="cb-card-header">
                <h6><i class="bi bi-lightning me-2"></i>Skills</h6>
            </div>
            <div class="cb-card-body" id="skills-card">
                {% if skills %}
                    <div class="cb-skills-wrap">
                        {% for skill in skills %}
                            <span class="cb-skill {% if skill.category == 'language' %}cb-skill-lang{% endif %}">
                                <i class="bi {{ skill.icon }} me-1"></i>{{ skill.name }}
                                {% if skill.version %}<small>{{ skill.version|truncatechars:20 }}</small>{% endif %}
                            </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="cb-card-empty small"><p>Wird automatisch erkannt</p></div>
                {% endif %}
            </div>
        </div>

        <!-- KI-Chats -->
        <div class="cb-card">
            <div class="cb-card-header">
                <h6><i class="bi bi-chat-dots me-2"></i>KI-Chats</h6>
                <a href="{% url 'clawboard:chat' %}" class="cb-link">Oeffnen</a>
            </div>
            <div class="cb-card-body" id="ai-chats-card">
                {% if recent_chats %}
                    {% for chat in recent_chats %}
                        <a href="{% url 'clawboard:chat_detail' chat.pk %}" class="cb-list-item">
                            <div>
                                <span class="cb-list-title">{{ chat.title|default:"Neuer Chat"|truncatechars:30 }}</span>
                                <span class="cb-list-meta">{{ chat.get_provider_display }} &middot; {{ chat.message_count }} Nachr.</span>
                            </div>
                            <span class="cb-list-time">{{ chat.updated_at|timesince }}</span>
                        </a>
                    {% endfor %}
                {% else %}
                    <div class="cb-card-empty small"><p>Noch keine KI-Chats</p></div>
                {% endif %}
                <a href="{% url 'clawboard:chat' %}" class="cb-btn cb-btn-outline cb-btn-sm cb-btn-block">
                    <i class="bi bi-plus me-1"></i>Neuer Chat
                </a>
            </div>
        </div>

        <!-- KI-Modelle -->
        <div class="cb-card">
            <div class="cb-card-header">
                <h6><i class="bi bi-cpu me-2"></i>KI-Modelle</h6>
            </div>
            <div class="cb-card-body" id="models-card">
                {% if ai_models %}
                    <div class="cb-badge-grid">
                        {% for model in ai_models %}
                            <div class="cb-integ-item">
                                <i class="bi {{ model.icon }} cb-model-icon"></i>
                                <div>
                                    <span class="cb-model-name">{{ model.name }}</span>
                                    <span class="cb-model-desc">{{ model.description }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="cb-card-empty small">
                        <p>Keine API-Keys konfiguriert</p>
                        <a href="/accounts/settings/" class="cb-link">API-Keys einrichten</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Geplante Aufgaben -->
        <div class="cb-card">
            <div class="cb-card-header">
                <h6><i class="bi bi-clock me-2"></i>Geplante Aufgaben</h6>
            </div>
            <div class="cb-card-body" id="tasks-card">
                {% if scheduled_tasks %}
                    {% for task in scheduled_tasks %}
                        <div class="cb-list-item">
                            <div>
                                <span class="cb-list-title">{{ task.name }}</span>
                                <span class="cb-list-meta">{{ task.schedule }}</span>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="cb-card-empty small"><p>Keine geplanten Aufgaben</p></div>
                {% endif %}
            </div>
        </div>

        <!-- Konversationen -->
        <div class="cb-card">
            <div class="cb-card-header">
                <h6><i class="bi bi-chat-left-text me-2"></i>Konversationen</h6>
                <a href="{% url 'clawboard:conversation_list' %}" class="cb-link">Alle</a>
            </div>
            <div class="cb-card-body" id="conversations-card">
                {% if recent_conversations %}
                    {% for conv in recent_conversations %}
                        <a href="{% url 'clawboard:conversation_detail' conv.pk %}" class="cb-list-item">
                            <div>
                                <span class="cb-list-title">{{ conv.title|default:"Untitled"|truncatechars:35 }}</span>
                                <span class="cb-list-meta">{{ conv.message_count }} Nachrichten &middot; {{ conv.channel|default:"unknown" }}</span>
                            </div>
                            <span class="cb-list-time">{{ conv.started_at|timesince }}</span>
                        </a>
                    {% endfor %}
                {% else %}
                    <div class="cb-card-empty small"><p>Noch keine Konversationen</p></div>
                {% endif %}
            </div>
        </div>

        <!-- Memory Browser -->
        <div class="cb-card cb-card-wide">
            <div class="cb-card-body cb-card-row">
                <div>
                    <h6 class="cb-card-row-title"><i class="bi bi-file-earmark-text me-2"></i>Memory Browser</h6>
                    <span class="cb-card-row-sub">Durchsuche und bearbeite deine .md Dateien</span>
                </div>
                <a href="{% url 'clawboard:memory_browser' %}" class="cb-btn cb-btn-primary">
                    <i class="bi bi-folder2-open me-1"></i>Oeffnen
                </a>
            </div>
        </div>

        <!-- Connector-Hilfe -->
        <div class="cb-card cb-card-wide" id="connector-help">
            <div class="cb-card-body cb-card-row">
                <div>
                    <h6 class="cb-card-row-title"><i class="bi bi-cloud-download me-2"></i>Connector einrichten</h6>
                    <span class="cb-card-row-sub">Lade den Connector herunter, damit System-Daten hier erscheinen.</span>
                </div>
                <a href="{% url 'clawboard:connector_setup' %}" class="cb-btn cb-btn-primary">
                    <i class="bi bi-download me-1"></i>Setup
                </a>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block cb_extra_script %}
{% if active_connection %}
<script>
const DASHBOARD_API = '{% url "clawboard:api_dashboard_refresh" %}';
const RESTART_API = '{% url "clawboard:api_connector_restart" %}';
const CONNECTION_ID = {{ active_connection.pk }};
const CSRF_TOKEN = '{{ csrf_token }}';

function showToast(msg, type) {
    const t = document.getElementById('refresh-toast');
    const m = document.getElementById('toast-message');
    t.className = 'toast align-items-center border-0 text-white bg-' + (type || 'primary');
    m.textContent = msg;
    new bootstrap.Toast(t, {delay: 3000}).show();
}

function setRefreshing(active) {
    const btn = document.getElementById('btn-refresh');
    if (active) {
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1 spin-animation"></i>Laden...';
    } else {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Aktualisieren';
    }
}

function updateStatusBadge(conn) {
    const badge = document.getElementById('status-badge');
    const text = document.getElementById('status-text');
    if (conn.is_online) {
        badge.className = 'cb-status-badge online';
        text.textContent = 'Online';
    } else {
        badge.className = 'cb-status-badge offline';
        text.textContent = conn.status || 'Offline';
    }
}

function updateSystemCard(system, conn) {
    const card = document.getElementById('system-card');
    if (system.cpu === null || system.cpu === undefined) return;
    const ramPct = system.ram_total ? (system.ram_used / system.ram_total * 100).toFixed(0) : 0;
    const diskPct = system.disk_total ? (system.disk_used / system.disk_total * 100).toFixed(0) : 0;
    card.innerHTML = `
        <div class="cb-meter">
            <div class="cb-meter-label"><span>CPU</span><span>${system.cpu}%</span></div>
            <div class="cb-progress"><div class="cb-progress-bar cb-bar-blue" style="width:${system.cpu}%"></div></div>
        </div>
        <div class="cb-meter">
            <div class="cb-meter-label"><span>RAM</span><span>${system.ram_used||'-'} / ${system.ram_total||'-'} MB</span></div>
            <div class="cb-progress"><div class="cb-progress-bar cb-bar-green" style="width:${ramPct}%"></div></div>
        </div>
        <div class="cb-meter">
            <div class="cb-meter-label"><span>Speicher</span><span>${system.disk_used||'-'} / ${system.disk_total||'-'} GB</span></div>
            <div class="cb-progress"><div class="cb-progress-bar cb-bar-yellow" style="width:${diskPct}%"></div></div>
        </div>
        <div class="cb-card-footer-info">
            <i class="bi bi-clock me-1"></i>Zuletzt gesehen: ${conn.last_seen_display}
        </div>`;
}

function updateIntegrationsCard(integrations, apiServices) {
    const card = document.getElementById('integrations-card');
    if (!card) return;
    const all = (apiServices || []).concat(integrations || []);
    if (!all.length) { card.innerHTML = '<div class="cb-card-empty small"><p>Keine Integrationen</p></div>'; return; }
    let h = '<div class="cb-badge-grid">';
    all.forEach(i => { h += `<div class="cb-integ-item"><i class="bi ${i.icon||'bi-check-circle'} cb-integ-icon"></i><span>${i.name}</span></div>`; });
    card.innerHTML = h + '</div>';
}

function updateSkillsCard(skills) {
    const card = document.getElementById('skills-card');
    if (!card) return;
    if (!skills || !skills.length) { card.innerHTML = '<div class="cb-card-empty small"><p>Wird automatisch erkannt</p></div>'; return; }
    let h = '<div class="cb-skills-wrap">';
    skills.forEach(s => {
        const cls = s.category === 'language' ? 'cb-skill-lang' : '';
        const ver = s.version ? `<small>${s.version.substring(0,20)}</small>` : '';
        h += `<span class="cb-skill ${cls}"><i class="bi ${s.icon||'bi-code-square'} me-1"></i>${s.name}${ver}</span>`;
    });
    card.innerHTML = h + '</div>';
}

function updateConversationsCard(convs) {
    const card = document.getElementById('conversations-card');
    if (!card) return;
    if (!convs.length) { card.innerHTML = '<div class="cb-card-empty small"><p>Noch keine Konversationen</p></div>'; return; }
    let h = '';
    convs.forEach(c => {
        const t = c.title.length > 35 ? c.title.substring(0,32)+'...' : c.title;
        h += `<a href="/clawboard/conversations/${c.pk}/" class="cb-list-item"><div><span class="cb-list-title">${t}</span><span class="cb-list-meta">${c.message_count} Nachrichten &middot; ${c.channel}</span></div><span class="cb-list-time">${c.age_display}</span></a>`;
    });
    card.innerHTML = h;
}

function updateTasksCard(tasks) {
    const card = document.getElementById('tasks-card');
    if (!card) return;
    if (!tasks.length) { card.innerHTML = '<div class="cb-card-empty small"><p>Keine geplanten Aufgaben</p></div>'; return; }
    let h = '';
    tasks.forEach(t => { h += `<div class="cb-list-item"><div><span class="cb-list-title">${t.name}</span><span class="cb-list-meta">${t.schedule}</span></div></div>`; });
    card.innerHTML = h;
}

function refreshDashboard() {
    setRefreshing(true);
    fetch(DASHBOARD_API, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
    .then(r => r.json())
    .then(data => {
        setRefreshing(false);
        if (!data.success) { showToast('Keine aktive Verbindung', 'warning'); return; }
        updateStatusBadge(data.connection);
        updateSystemCard(data.system, data.connection);
        updateIntegrationsCard(data.integrations, data.api_services);
        updateSkillsCard(data.skills);
        updateConversationsCard(data.conversations);
        updateTasksCard(data.tasks);
        const help = document.getElementById('connector-help');
        if (help && data.connection.is_online) help.style.display = 'none';
        if (data.connection.is_online) showToast('Dashboard aktualisiert', 'success');
        else if (data.connection.last_seen) showToast('Connector offline seit ' + data.connection.last_seen_display, 'warning');
        else showToast('Starte den Connector auf deinem Rechner', 'warning');
    })
    .catch(err => { setRefreshing(false); showToast('Fehler: ' + err.message, 'danger'); });
}

function restartConnector() {
    if (!confirm('Connector neu starten?')) return;
    fetch(RESTART_API, {method: 'POST', headers: {'X-CSRFToken': CSRF_TOKEN, 'X-Requested-With': 'XMLHttpRequest'}})
    .then(r => r.json())
    .then(data => { showToast(data.success ? 'Neustart beim naechsten Push (max. 30s)' : (data.error||'Fehler'), data.success ? 'success' : 'danger'); })
    .catch(err => showToast('Fehler: ' + err.message, 'danger'));
}

setInterval(refreshDashboard, 60000);
</script>
{% endif %}
{% endblock %}
