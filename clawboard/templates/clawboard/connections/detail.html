{% extends "clawboard/base_dark.html" %}
{% load static %}

{% block title %}{{ connection.name }} - Clawboard{% endblock %}

{% block cb_page %}
<div class="cb-page-header">
    <div>
        <div class="cb-breadcrumb">
            <a href="{% url 'clawboard:dashboard' %}">Clawboard</a>
            <span class="separator">/</span>
            <a href="{% url 'clawboard:connection_list' %}">Verbindungen</a>
            <span class="separator">/</span>
            <span class="current">{{ connection.name }}</span>
        </div>
        <h1 class="cb-page-title"><i class="bi bi-hdd-network me-2"></i>{{ connection.name }}</h1>
    </div>
    <span class="cb-badge {% if connection.status == 'online' %}cb-badge-green{% elif connection.status == 'offline' %}cb-badge-red{% else %}cb-badge-gray{% endif %}" style="font-size: 0.85rem; padding: 6px 14px;">
        {{ connection.get_status_display|default:"Unbekannt" }}
    </span>
</div>

<div class="cb-grid">
    <!-- Hauptinfo -->
    <div class="cb-card">
        <div class="cb-card-header">
            <h6><i class="bi bi-info-circle me-2"></i>Details</h6>
        </div>
        <div class="cb-card-body">
            <dl class="cb-dl">
                <dt>Gateway URL</dt>
                <dd><code>{{ connection.gateway_url }}</code></dd>
                <dt>Status</dt>
                <dd>
                    {% if connection.is_active %}
                        <span class="cb-badge cb-badge-green">Aktiv</span>
                    {% else %}
                        <span class="cb-badge cb-badge-gray">Inaktiv</span>
                    {% endif %}
                </dd>
                <dt>Zuletzt gesehen</dt>
                <dd>{% if connection.last_seen %}{{ connection.last_seen|timesince }}{% else %}Noch nie{% endif %}</dd>
                <dt>Erstellt</dt>
                <dd>{{ connection.created_at|date:"d.m.Y H:i" }}</dd>
                {% if connection.hostname %}
                    <dt>Hostname</dt>
                    <dd>{{ connection.hostname }}</dd>
                {% endif %}
            </dl>
            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button type="button" class="cb-btn cb-btn-primary" id="testConnection">
                    <i class="bi bi-wifi me-1"></i>Testen
                </button>
                <a href="{% url 'clawboard:connection_edit' connection.pk %}" class="cb-btn cb-btn-outline">
                    <i class="bi bi-pencil me-1"></i>Bearbeiten
                </a>
                <a href="{% url 'clawboard:connection_delete' connection.pk %}" class="cb-btn cb-btn-danger">
                    <i class="bi bi-trash me-1"></i>Loeschen
                </a>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="cb-card">
        <div class="cb-card-header">
            <h6><i class="bi bi-speedometer2 me-2"></i>System Status</h6>
        </div>
        <div class="cb-card-body">
            {% if connection.cpu_percent %}
                <div class="cb-meter">
                    <div class="cb-meter-label"><span>CPU</span><span>{{ connection.cpu_percent|floatformat:1 }}%</span></div>
                    <div class="cb-progress"><div class="cb-progress-bar cb-bar-blue" style="width: {{ connection.cpu_percent }}%"></div></div>
                </div>
            {% endif %}
            {% if connection.ram_total_mb %}
                <div class="cb-meter">
                    <div class="cb-meter-label"><span>RAM</span><span>{{ connection.ram_used_mb|floatformat:0 }} / {{ connection.ram_total_mb|floatformat:0 }} MB</span></div>
                    <div class="cb-progress">
                        {% widthratio connection.ram_used_mb connection.ram_total_mb 100 as ram_pct %}
                        <div class="cb-progress-bar cb-bar-green" style="width: {{ ram_pct }}%"></div>
                    </div>
                </div>
            {% endif %}
            {% if connection.disk_total_gb %}
                <div class="cb-meter">
                    <div class="cb-meter-label"><span>Disk</span><span>{{ connection.disk_used_gb|floatformat:1 }} / {{ connection.disk_total_gb|floatformat:1 }} GB</span></div>
                    <div class="cb-progress">
                        {% widthratio connection.disk_used_gb connection.disk_total_gb 100 as disk_pct %}
                        <div class="cb-progress-bar cb-bar-yellow" style="width: {{ disk_pct }}%"></div>
                    </div>
                </div>
            {% endif %}
            {% if not connection.cpu_percent and not connection.ram_total_mb %}
                <div class="cb-card-empty small"><p>Keine System-Daten verfuegbar</p></div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block cb_extra_script %}
<script>
document.getElementById('testConnection')?.addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Teste...';
    try {
        const r = await fetch('{% url "clawboard:connection_test" connection.pk %}');
        const data = await r.json();
        btn.innerHTML = data.success ? '<i class="bi bi-check-lg me-1"></i>Verbunden!' : '<i class="bi bi-x-lg me-1"></i>Fehler';
        btn.style.background = data.success ? '#a6e3a1' : '#f38ba8';
    } catch (e) {
        btn.innerHTML = '<i class="bi bi-x-lg me-1"></i>Fehler';
        btn.style.background = '#f38ba8';
    }
    setTimeout(() => { btn.disabled = false; btn.innerHTML = '<i class="bi bi-wifi me-1"></i>Testen'; btn.style.background = ''; }, 3000);
});
</script>
{% endblock %}
