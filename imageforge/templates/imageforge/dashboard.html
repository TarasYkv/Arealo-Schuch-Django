{% extends "base.html" %}
{% load static %}

{% block title %}ImageForge - KI Bildgenerierung{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'imageforge/css/style.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                <h1 class="h3 mb-0">
                    <span class="if-icon">&#x1F3A8;</span> ImageForge
                </h1>
                <div class="btn-group">
                    <a href="{% url 'imageforge:history' %}" class="btn btn-outline-primary">
                        <i class="fas fa-history me-2"></i>Verlauf
                    </a>
                    <a href="{% url 'imageforge:character_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-user me-2"></i>Charaktere
                    </a>
                    <a href="{% url 'imageforge:preset_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-sliders-h me-2"></i>Presets
                    </a>
                </div>
            </div>
            <p class="text-muted mt-2">
                KI-generierte Produktbilder, Hintergründe und Charakter-Szenen
            </p>
        </div>
    </div>

    {% if not has_any_key %}
    <!-- API-Key Warnung -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Kein API-Key konfiguriert!</strong>
                Für die Bildgenerierung wird ein Google- oder OpenAI-API-Key benötigt.
                <a href="{% url 'accounts:neue_api_einstellungen' %}" class="alert-link">Jetzt API-Keys einrichten</a>
            </div>
        </div>
    </div>
    {% elif not has_google_key and not has_openai_key %}
    {% elif not has_google_key %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Nur OpenAI verfügbar.</strong>
                Für Gemini/Imagen einen
                <a href="{% url 'accounts:neue_api_einstellungen' %}" class="alert-link">Google API-Key hinzufügen</a>.
            </div>
        </div>
    </div>
    {% elif not has_openai_key %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Nur Google verfügbar.</strong>
                Für DALL-E einen
                <a href="{% url 'accounts:neue_api_einstellungen' %}" class="alert-link">OpenAI API-Key hinzufügen</a>.
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Generator Card -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card if-generator-card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-magic me-2"></i>Neues Bild generieren</h5>
                </div>
                <div class="card-body">
                    <form id="generate-form" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- Modus-Auswahl -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Modus</label>
                            <div class="mode-selector">
                                <div class="mode-option active" data-mode="background">
                                    <i class="fas fa-image"></i>
                                    <span>Nur Hintergrund</span>
                                </div>
                                <div class="mode-option" data-mode="product">
                                    <i class="fas fa-box"></i>
                                    <span>Produkt + Hintergrund</span>
                                </div>
                                <div class="mode-option" data-mode="character">
                                    <i class="fas fa-user"></i>
                                    <span>Charakter + Szene</span>
                                </div>
                                <div class="mode-option" data-mode="character_product">
                                    <i class="fas fa-users"></i>
                                    <span>Charakter + Produkt</span>
                                </div>
                            </div>
                            <input type="hidden" name="generation_mode" id="generation-mode" value="background">
                        </div>

                        <!-- Produkt-Upload (nur bei product/character_product) -->
                        <div class="mb-4 product-upload-section" style="display: none;">
                            <label class="form-label fw-bold">Produktbild</label>
                            <div class="upload-zone" id="product-upload-zone">
                                <input type="file" name="product_image" id="product-image" accept="image/*" class="d-none">
                                <div class="upload-placeholder">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>Produktbild hierher ziehen oder klicken</p>
                                </div>
                                <div class="upload-preview d-none">
                                    <img src="" alt="Vorschau">
                                    <button type="button" class="btn btn-sm btn-danger remove-image">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Charakter-Auswahl (nur bei character/character_product) -->
                        <div class="mb-4 character-section" style="display: none;">
                            <label class="form-label fw-bold">Charakter</label>
                            {% if characters %}
                            <select name="character" id="character-select" class="form-select">
                                <option value="">-- Charakter wählen --</option>
                                {% for char in characters %}
                                <option value="{{ char.id }}">{{ char.name }} ({{ char.image_count }} Bilder)</option>
                                {% endfor %}
                            </select>
                            <div class="mt-2">
                                <a href="{% url 'imageforge:character_create' %}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-plus me-1"></i>Neuen Charakter erstellen
                                </a>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Noch keine Charaktere vorhanden.
                                <a href="{% url 'imageforge:character_create' %}" class="alert-link">Jetzt erstellen</a>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Szenen-Beschreibung -->
                        <div class="mb-4">
                            <label for="background-prompt" class="form-label fw-bold">
                                Szenen-/Hintergrund-Beschreibung
                            </label>
                            <textarea name="background_prompt" id="background-prompt" class="form-control"
                                      rows="3" required
                                      placeholder="z.B. Moderner Schreibtisch mit Pflanzen, warmes Tageslicht"></textarea>
                            <div class="form-text">Beschreibe den gewünschten Hintergrund oder die Szene</div>
                        </div>

                        <!-- Einstellungen -->
                        <div class="row mb-4">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Format</label>
                                <select name="aspect_ratio" class="form-select">
                                    <option value="1:1">Square (1:1)</option>
                                    <option value="4:3">Standard (4:3)</option>
                                    <option value="16:9">Widescreen (16:9)</option>
                                    <option value="9:16">Portrait (9:16)</option>
                                    <option value="3:4">Portrait (3:4)</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Lichtstil</label>
                                <select name="lighting_style" class="form-select">
                                    <option value="studio">Studio</option>
                                    <option value="natural" selected>Natürlich</option>
                                    <option value="dramatic">Dramatisch</option>
                                    <option value="soft">Soft Light</option>
                                    <option value="golden_hour">Golden Hour</option>
                                    <option value="high_key">High Key</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Perspektive</label>
                                <select name="perspective" class="form-select">
                                    <option value="frontal" selected>Frontal</option>
                                    <option value="angle_45">45 Grad Winkel</option>
                                    <option value="flat_lay">Flat Lay</option>
                                    <option value="floating">Schwebend</option>
                                    <option value="hero">Hero Shot</option>
                                    <option value="macro">Makro</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Stil-Preset</label>
                                <select name="style_preset" class="form-select">
                                    <option value="ecommerce">E-Commerce</option>
                                    <option value="lifestyle" selected>Lifestyle</option>
                                    <option value="minimal">Minimalistisch</option>
                                    <option value="luxury">Luxus</option>
                                    <option value="nature">Natur</option>
                                    <option value="tech">Tech</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Schatten</label>
                                <select name="shadow_type" class="form-select">
                                    <option value="none">Keiner</option>
                                    <option value="soft" selected>Weich</option>
                                    <option value="hard">Hart</option>
                                    <option value="reflection">Reflektion</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Farbstimmung</label>
                                <select name="color_mood" class="form-select">
                                    <option value="warm">Warm</option>
                                    <option value="neutral" selected>Neutral</option>
                                    <option value="cool">Kühl</option>
                                    <option value="vibrant">Lebhaft</option>
                                </select>
                            </div>
                        </div>

                        <!-- KI-Modell -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">KI-Modell</label>
                                <select name="ai_model" class="form-select">
                                    <optgroup label="Gemini (Nano Banana)">
                                        <option value="gemini-2.5-flash-image" selected>Nano Banana (Schnell)</option>
                                        <option value="gemini-3-pro-image-preview">Nano Banana Pro (Beste Qualität)</option>
                                    </optgroup>
                                    <optgroup label="Imagen 4">
                                        <option value="imagen-4.0-ultra-generate-001">Imagen 4 Ultra</option>
                                        <option value="imagen-4.0-generate-001">Imagen 4 Standard</option>
                                        <option value="imagen-4.0-fast-generate-001">Imagen 4 Fast</option>
                                    </optgroup>
                                    <optgroup label="OpenAI DALL-E">
                                        <option value="dall-e-3">DALL-E 3</option>
                                        <option value="dall-e-2">DALL-E 2</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Qualität</label>
                                <select name="quality" class="form-select">
                                    <option value="standard">Standard</option>
                                    <option value="hd">HD (nur DALL-E 3)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Generate Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="generate-btn">
                                <i class="fas fa-magic me-2"></i>Bild generieren
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar - Letzte Generierungen -->
        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-clock me-2"></i>Letzte Generierungen</h6>
                </div>
                <div class="card-body p-0">
                    {% if recent_generations %}
                    <div class="recent-generations">
                        {% for gen in recent_generations %}
                        <a href="{% url 'imageforge:generation_detail' gen.id %}" class="recent-gen-item">
                            {% if gen.generated_image %}
                            <img src="{{ gen.generated_image.url }}" alt="Generierung">
                            {% else %}
                            <div class="no-image">
                                <i class="fas fa-image"></i>
                            </div>
                            {% endif %}
                            <div class="gen-info">
                                <span class="gen-mode">{{ gen.mode_display }}</span>
                                <span class="gen-date">{{ gen.created_at|date:"d.m.Y H:i" }}</span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-images fa-2x mb-2"></i>
                        <p>Noch keine Generierungen</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Result Modal -->
<div class="modal fade" id="result-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success me-2"></i>Bild generiert
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="result-image" src="" alt="Generiertes Bild" class="img-fluid result-preview">
                <div class="mt-3">
                    <p class="text-muted" id="result-info"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                <a href="#" id="download-btn" class="btn btn-success" download="imageforge-generated.png">
                    <i class="fas fa-download me-2"></i>Herunterladen
                </a>
                <a href="#" id="view-detail-btn" class="btn btn-primary">
                    <i class="fas fa-eye me-2"></i>Details
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="d-none">
    <div class="loading-content">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Generating...</span>
        </div>
        <h5>Bild wird generiert...</h5>
        <p class="text-muted">Dies kann bis zu 60 Sekunden dauern</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'imageforge/js/app.js' %}?v={% now 'U' %}"></script>
{% endblock %}
