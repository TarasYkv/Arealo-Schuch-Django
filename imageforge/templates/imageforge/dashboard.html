{% extends "base.html" %}
{% load static %}
{% load loomads_tags %}
{% load thumbnail_tags %}

{% block title %}ImageForge - KI Bildgenerierung{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'imageforge/css/style.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                <h1 class="h3 mb-0">
                    <span class="if-icon">&#x1F3A8;</span> ImageForge
                </h1>
                <div class="btn-group">
                    <a href="{% url 'imageforge:history' %}" class="btn btn-outline-primary">
                        <i class="fas fa-history me-2"></i>Verlauf
                    </a>
                    <a href="{% url 'imageforge:character_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-user me-2"></i>Charaktere
                    </a>
                    <a href="{% url 'imageforge:mockup_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-font me-2"></i>Mockups
                    </a>
                    <a href="{% url 'imageforge:preset_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-sliders-h me-2"></i>Presets
                    </a>
                    <a href="{% url 'imageforge:cleanup' %}" class="btn btn-outline-danger" title="Alte Dateien löschen">
                        <i class="fas fa-broom"></i>
                    </a>
                </div>
            </div>
            <p class="text-muted mt-2">
                KI-generierte Produktbilder, Hintergründe und Charakter-Szenen
            </p>
        </div>
    </div>

    <!-- Ad Zone -->
    {% show_ad_zone 'imageforge_header' css_class='mb-4' %}

    {% if not has_any_key %}
    <!-- API-Key Warnung - Permanente Card -->
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <div class="card border-warning shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        API-Key erforderlich
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text mb-3">
                        Für die Bildgenerierung wird mindestens ein <strong>Google-</strong> oder <strong>OpenAI-API-Key</strong> benötigt.
                    </p>
                    <div class="d-flex flex-column flex-sm-row gap-2">
                        <a href="{% url 'accounts:neue_api_einstellungen' %}" class="btn btn-warning">
                            <i class="fas fa-key me-2"></i>API-Keys einrichten
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% elif not has_google_key and not has_openai_key %}
    {% elif not has_google_key %}
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <div class="card border-info shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Nur OpenAI verfügbar
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text mb-3">
                        Für <strong>Gemini/Imagen</strong> Bildgenerierung fehlt der Google API-Key.
                    </p>
                    <a href="{% url 'accounts:neue_api_einstellungen' %}" class="btn btn-info text-white">
                        <i class="fas fa-plus me-2"></i>Google API-Key hinzufügen
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% elif not has_openai_key %}
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <div class="card border-info shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Nur Google verfügbar
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text mb-3">
                        Für <strong>DALL-E</strong> Bildgenerierung fehlt der OpenAI API-Key.
                    </p>
                    <a href="{% url 'accounts:neue_api_einstellungen' %}" class="btn btn-info text-white">
                        <i class="fas fa-plus me-2"></i>OpenAI API-Key hinzufügen
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Generator Card -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card if-generator-card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-magic me-2"></i>Neues Bild generieren</h5>
                </div>
                <div class="card-body">
                    <form id="generate-form" action="{% url 'imageforge:generate' %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- Modus-Auswahl -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Modus</label>
                            <div class="mode-selector">
                                <div class="mode-option active" data-mode="background">
                                    <i class="fas fa-image"></i>
                                    <span>Nur Hintergrund</span>
                                </div>
                                <div class="mode-option" data-mode="product">
                                    <i class="fas fa-box"></i>
                                    <span>Produkt + Hintergrund</span>
                                </div>
                                <div class="mode-option" data-mode="character">
                                    <i class="fas fa-user"></i>
                                    <span>Charakter + Szene</span>
                                </div>
                                <div class="mode-option" data-mode="character_product">
                                    <i class="fas fa-users"></i>
                                    <span>Charakter + Produkt</span>
                                </div>
                                <div class="mode-option" data-mode="mockup_text">
                                    <i class="fas fa-font"></i>
                                    <span>Mockup + Text</span>
                                </div>
                                <div class="mode-option" data-mode="design">
                                    <i class="fas fa-palette"></i>
                                    <span>Kreatives Design</span>
                                </div>
                            </div>
                            <input type="hidden" name="generation_mode" id="generation-mode" value="background">
                        </div>

                        <!-- Produkt-Upload (nur bei product/character_product) -->
                        <div class="mb-4 product-upload-section" style="display: none;">
                            <label class="form-label fw-bold">Produktbild</label>
                            <div class="upload-zone" id="product-upload-zone">
                                <input type="file" name="product_image" id="product-image" accept="image/*" class="d-none">
                                <div class="upload-placeholder">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>Produktbild hierher ziehen oder klicken</p>
                                </div>
                                <div class="upload-preview d-none">
                                    <img src="" alt="Vorschau">
                                    <button type="button" class="btn btn-sm btn-danger remove-image">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Charakter-Auswahl (nur bei character/character_product) -->
                        <div class="mb-4 character-section" style="display: none;">
                            <label class="form-label fw-bold">Charakter</label>
                            {% if characters %}
                            <select name="character" id="character-select" class="form-select">
                                <option value="">-- Charakter wählen --</option>
                                {% for char in characters %}
                                <option value="{{ char.id }}">{{ char.name }} ({{ char.image_count }} Bilder)</option>
                                {% endfor %}
                            </select>
                            <div class="mt-2">
                                <a href="{% url 'imageforge:character_create' %}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-plus me-1"></i>Neuen Charakter erstellen
                                </a>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Noch keine Charaktere vorhanden.
                                <a href="{% url 'imageforge:character_create' %}" class="alert-link">Jetzt erstellen</a>
                            </div>
                            {% endif %}
                        </div>

                        <!-- ============================================================= -->
                        <!-- MOCKUP-TEXT WIZARD (nur bei mockup_text) -->
                        <!-- ============================================================= -->
                        <div class="mockup-wizard-section" style="display: none;">
                            <!-- Mockup Auswahl -->
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-layer-group me-2"></i>Mockup wählen</h6>
                                </div>
                                <div class="card-body">
                                    {% if mockups %}
                                    <!-- Gespeicherte Mockups -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Gespeichertes Mockup</label>
                                        <select id="saved-mockup-select" class="form-select">
                                            <option value="">-- Mockup wählen --</option>
                                            {% for m in mockups %}
                                            {% if m.mockup_image %}
                                            <option value="{{ m.id }}" data-image="{{ m.mockup_image.url }}">
                                                {{ m.name|default:m.text_content|truncatechars:40 }}
                                            </option>
                                            {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="text-center text-muted mb-3">— oder —</div>
                                    {% endif %}
                                    <!-- Neues Mockup erstellen Button -->
                                    <button type="button" class="btn btn-outline-primary w-100" id="show-create-mockup-btn">
                                        <i class="fas fa-plus me-2"></i>Neues Mockup erstellen
                                    </button>
                                </div>
                            </div>

                            <!-- MOCKUP ERSTELLEN FORMULAR (standardmäßig versteckt) -->
                            <div class="card mb-4 d-none" id="mockup-step1-card">
                                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-edit me-2"></i>Neues Mockup erstellen</h6>
                                    <button type="button" class="btn btn-sm btn-light" id="hide-create-mockup-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <!-- Produktbild Upload -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Produktbild *</label>
                                        <div class="d-flex gap-2 align-items-start">
                                            <div class="upload-zone flex-grow-1" id="mockup-product-upload-zone">
                                                <input type="file" name="mockup_product_image" id="mockup-product-image" accept="image/*" class="d-none">
                                                <div class="upload-placeholder">
                                                    <i class="fas fa-cloud-upload-alt"></i>
                                                    <p>Produktbild hierher ziehen oder klicken</p>
                                                </div>
                                                <div class="upload-preview d-none">
                                                    <img src="" alt="Vorschau">
                                                    <button type="button" class="btn btn-sm btn-danger remove-image">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#productHistoryModal" title="Aus Verlauf wählen">
                                                <i class="fas fa-history"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Toggle: Text oder Motiv -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Was soll auf das Produkt?</label>
                                        <div class="btn-group w-100" role="group" id="content-type-toggle">
                                            <input type="radio" class="btn-check" name="content_type" id="content-type-text" value="text" checked>
                                            <label class="btn btn-outline-primary" for="content-type-text">
                                                <i class="fas fa-font me-1"></i> Text/Beschriftung
                                            </label>
                                            <input type="radio" class="btn-check" name="content_type" id="content-type-motif" value="motif">
                                            <label class="btn btn-outline-primary" for="content-type-motif">
                                                <i class="fas fa-image me-1"></i> Motiv/Bild
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Text-Eingabe (bei Text-Modus) -->
                                    <div class="mb-3" id="text-input-section">
                                        <label class="form-label fw-bold">Text/Beschriftung *</label>
                                        <div class="d-flex gap-2">
                                            <input type="text" id="mockup-text-content" class="form-control"
                                                   placeholder="z.B. PREMIUM QUALITY" maxlength="200">
                                            <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#funnySayingsModal" title="KI-Sprüche generieren">
                                                <i class="fas fa-magic"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">Der Text der auf das Produkt soll - oder lass dir Sprüche generieren!</div>
                                    </div>

                                    <!-- Motiv-Upload (bei Motiv-Modus, initial versteckt) -->
                                    <div class="mb-3 d-none" id="motif-input-section">
                                        <label class="form-label fw-bold">Motiv/Bild *</label>
                                        <div class="d-flex gap-2 align-items-start">
                                            <div class="upload-zone flex-grow-1" id="mockup-motif-upload-zone">
                                                <input type="file" name="motif_image" id="motif-image" accept="image/*" class="d-none">
                                                <div class="upload-placeholder">
                                                    <i class="fas fa-image"></i>
                                                    <p>Motiv hierher ziehen oder klicken</p>
                                                </div>
                                                <div class="upload-preview d-none">
                                                    <img src="" alt="Motiv-Vorschau">
                                                    <button type="button" class="btn btn-sm btn-danger remove-image">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#motifHistoryModal" title="Aus Verlauf wählen">
                                                <i class="fas fa-history"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">Das Motiv/Logo/Bild das auf das Produkt gedruckt werden soll</div>
                                    </div>

                                    <!-- Stil-Referenzbild (Pflicht) -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Stil-Referenzbild *</label>
                                        <div class="d-flex gap-2 align-items-start">
                                            <div class="upload-zone upload-zone-small flex-grow-1" id="mockup-style-ref-zone">
                                                <input type="file" name="style_reference_image" id="style-reference-image" accept="image/*" class="d-none">
                                                <div class="upload-placeholder">
                                                    <i class="fas fa-palette"></i>
                                                    <p class="mb-0">Beispielbild hochladen</p>
                                                </div>
                                                <div class="upload-preview d-none">
                                                    <img src="" alt="Stil-Referenz">
                                                    <button type="button" class="btn btn-sm btn-danger remove-image">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#styleRefHistoryModal" title="Aus Verlauf wählen">
                                                <i class="fas fa-history"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">Lade ein Bild hoch das zeigt wie die Beschriftung aussehen soll (Gravur, Druck, Prägung, etc.)</div>
                                    </div>

                                    <!-- Generate Mockup Button -->
                                    <button type="button" class="btn btn-success w-100" id="generate-mockup-btn">
                                        <i class="fas fa-magic me-2"></i>Mockup erstellen & speichern
                                    </button>
                                </div>
                            </div>

                            <!-- Mockup Preview (zeigt nach Step 1) -->
                            <div class="card mb-4 d-none" id="mockup-preview-card">
                                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-check me-2"></i>Mockup erstellt</h6>
                                    <a id="mockup-download-btn" href="#" download="mockup.png" class="btn btn-sm btn-light">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </div>
                                <div class="card-body text-center">
                                    <img id="mockup-preview-image" src="" alt="Mockup" class="img-fluid rounded" style="max-height: 300px;">
                                    <input type="hidden" id="current-mockup-id" value="">
                                </div>
                            </div>

                            <!-- STEP 2: In Szene platzieren -->
                            <div class="card mb-4 mockup-step2-section" id="mockup-step2-card" style="opacity: 0.5; pointer-events: none;">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0"><i class="fas fa-2 me-2"></i>Step 2: In Szene platzieren</h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info mb-3" id="step2-hint">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Erst Mockup erstellen (Step 1) oder gespeichertes Mockup wählen.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Ende MOCKUP-TEXT WIZARD -->

                        <!-- ============================================================= -->
                        <!-- DESIGN-MODUS SECTION -->
                        <!-- ============================================================= -->
                        <div class="design-section" style="display: none;">
                            <!-- Design-Typ Toggle -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Design-Typ</label>
                                <div class="btn-group w-100" role="group" id="design-type-toggle">
                                    <input type="radio" class="btn-check" name="design_type" id="design-type-illustration" value="illustration" checked>
                                    <label class="btn btn-outline-primary" for="design-type-illustration">
                                        <i class="fas fa-paint-brush me-1"></i> Illustration/Grafik
                                    </label>
                                    <input type="radio" class="btn-check" name="design_type" id="design-type-pattern" value="pattern">
                                    <label class="btn btn-outline-primary" for="design-type-pattern">
                                        <i class="fas fa-th me-1"></i> Muster/Textur
                                    </label>
                                </div>
                            </div>

                            <!-- Thema -->
                            <div class="mb-4">
                                <label for="design-theme" class="form-label fw-bold">Thema / Motiv</label>
                                <textarea name="background_prompt" id="design-theme" class="form-control design-input"
                                          rows="2" disabled
                                          placeholder="z.B. Kaffee am Morgen, Hund mit Sonnenbrille, Abstrakte Formen"></textarea>
                                <div class="form-text">Beschreibe das Thema oder Motiv für dein Design</div>
                            </div>

                            <!-- Farbstil -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Farbstil</label>
                                <select name="design_color_style" class="form-select design-input">
                                    <option value="colorful">Farbig</option>
                                    <option value="grayscale">Grautöne</option>
                                    <option value="bw">Schwarz/Weiß</option>
                                    <option value="monochrome">Monochrom</option>
                                    <option value="pastel">Pastell</option>
                                    <option value="vibrant">Kräftig/Lebhaft</option>
                                    <option value="neon">Neon</option>
                                    <option value="earth">Erdtöne</option>
                                </select>
                            </div>

                            <!-- Tonalität -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Tonalität / Stil</label>
                                <select name="design_tonality" class="form-select design-input">
                                    <option value="modern">Modern</option>
                                    <option value="humorous">Humorvoll</option>
                                    <option value="elegant">Elegant</option>
                                    <option value="playful">Verspielt</option>
                                    <option value="minimalist">Minimalistisch</option>
                                    <option value="vintage">Vintage/Retro</option>
                                    <option value="professional">Professionell</option>
                                    <option value="artistic">Künstlerisch</option>
                                    <option value="cute">Niedlich/Kawaii</option>
                                </select>
                            </div>

                            <!-- Text-Option -->
                            <div class="mb-3">
                                <div class="form-check mb-2">
                                    <input type="checkbox" class="form-check-input" name="design_text_enabled" id="design-text-enabled">
                                    <label class="form-check-label fw-bold" for="design-text-enabled">
                                        <i class="fas fa-font me-1"></i> Text auf Design
                                    </label>
                                </div>
                                <div class="design-text-input" style="display: none;">
                                    <input type="text" name="design_text_content" id="design-text-content" class="form-control design-input"
                                           placeholder="z.B. Coffee First, Best Dad Ever, Dream Big">
                                    <div class="form-text">Der Text wird prominent in das Design integriert</div>
                                </div>
                            </div>

                            <!-- Stil-Referenzbild (optional) -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Stil-Referenzbild (optional)</label>
                                <div class="upload-zone upload-zone-small" id="design-reference-upload-zone">
                                    <input type="file" name="design_reference_image" id="design-reference-image" accept="image/*" class="d-none">
                                    <div class="upload-placeholder">
                                        <i class="fas fa-image"></i>
                                        <p class="mb-0">Bild als Stil-Inspiration hochladen</p>
                                    </div>
                                    <div class="upload-preview d-none">
                                        <img src="" alt="Stil-Referenz">
                                        <button type="button" class="btn btn-sm btn-danger remove-image">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-text">Optional: Ein Bild das den gewünschten Stil zeigt</div>
                            </div>

                            <!-- Format für Design -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">Format</label>
                                    <select name="aspect_ratio" class="form-select design-input">
                                        <option value="1:1" selected>Square (1:1)</option>
                                        <option value="4:3">Standard (4:3)</option>
                                        <option value="16:9">Widescreen (16:9)</option>
                                        <option value="9:16">Portrait (9:16)</option>
                                        <option value="3:4">Portrait (3:4)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">KI-Modell</label>
                                    <select name="ai_model" class="form-select design-input">
                                        <optgroup label="Nano Banana - Empfohlen">
                                            <option value="gemini-2.5-flash-image" selected>Nano Banana - Schnell</option>
                                            <option value="gemini-3-pro-image-preview">Nano Banana Pro - Profi</option>
                                        </optgroup>
                                        <optgroup label="Imagen 4">
                                            <option value="imagen-4.0-ultra-generate-001">Imagen 4 Ultra</option>
                                            <option value="imagen-4.0-generate-001">Imagen 4 Standard</option>
                                        </optgroup>
                                        <optgroup label="OpenAI">
                                            <option value="gpt-image-1">GPT-4o Image</option>
                                            <option value="dall-e-3">DALL-E 3</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>

                            <!-- Generate Button für Design -->
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" id="generate-design-btn">
                                    <i class="fas fa-palette me-2"></i>Design generieren
                                </button>
                            </div>
                        </div>
                        <!-- Ende DESIGN-MODUS SECTION -->

                        <!-- Szenen-Beschreibung (versteckt bei mockup_text, da im Wizard) -->
                        <div class="mb-4 standard-form-section">
                            <label for="background-prompt" class="form-label fw-bold">
                                Szenen-/Hintergrund-Beschreibung
                            </label>
                            <textarea name="background_prompt" id="background-prompt" class="form-control"
                                      rows="3"
                                      placeholder="z.B. Moderner Schreibtisch mit Pflanzen, warmes Tageslicht"></textarea>
                            <div class="form-text">Beschreibe den gewünschten Hintergrund oder die Szene</div>
                        </div>

                        <!-- Einstellungen (versteckt bei mockup_text) -->
                        <div class="row mb-4 standard-form-section">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Format</label>
                                <select name="aspect_ratio" class="form-select">
                                    <option value="1:1">Square (1:1)</option>
                                    <option value="4:3">Standard (4:3)</option>
                                    <option value="16:9">Widescreen (16:9)</option>
                                    <option value="9:16">Portrait (9:16)</option>
                                    <option value="3:4">Portrait (3:4)</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Lichtstil</label>
                                <select name="lighting_style" class="form-select">
                                    <option value="studio">Studio</option>
                                    <option value="natural" selected>Natürlich</option>
                                    <option value="dramatic">Dramatisch</option>
                                    <option value="soft">Soft Light</option>
                                    <option value="golden_hour">Golden Hour</option>
                                    <option value="high_key">High Key</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Perspektive</label>
                                <select name="perspective" class="form-select">
                                    <option value="frontal" selected>Frontal</option>
                                    <option value="angle_45">45 Grad Winkel</option>
                                    <option value="flat_lay">Flat Lay</option>
                                    <option value="floating">Schwebend</option>
                                    <option value="hero">Hero Shot</option>
                                    <option value="macro">Makro</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-4 standard-form-section">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Stil-Preset</label>
                                <select name="style_preset" class="form-select">
                                    <option value="ecommerce">E-Commerce</option>
                                    <option value="lifestyle" selected>Lifestyle</option>
                                    <option value="minimal">Minimalistisch</option>
                                    <option value="luxury">Luxus</option>
                                    <option value="nature">Natur</option>
                                    <option value="tech">Tech</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Schatten</label>
                                <select name="shadow_type" class="form-select">
                                    <option value="none">Keiner</option>
                                    <option value="soft" selected>Weich</option>
                                    <option value="hard">Hart</option>
                                    <option value="reflection">Reflektion</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Farbstimmung</label>
                                <select name="color_mood" class="form-select">
                                    <option value="warm">Warm</option>
                                    <option value="neutral" selected>Neutral</option>
                                    <option value="cool">Kühl</option>
                                    <option value="vibrant">Lebhaft</option>
                                </select>
                            </div>
                        </div>

                        <!-- KI-Modell (versteckt bei mockup_text) -->
                        <div class="row mb-4 standard-form-section">
                            <div class="col-md-6">
                                <label class="form-label">KI-Modell</label>
                                <select name="ai_model" id="ai-model-select" class="form-select">
                                    <optgroup label="Gemini (Nano Banana) - Empfohlen">
                                        <option value="gemini-2.5-flash-image" selected>Nano Banana - Schnell & vielseitig</option>
                                        <option value="gemini-3-pro-image-preview">Nano Banana Pro - Profi-Qualität bis 4K</option>
                                    </optgroup>
                                    <optgroup label="Imagen 4 - Fotorealismus">
                                        <option value="imagen-4.0-ultra-generate-001">Imagen 4 Ultra - Höchste Qualität</option>
                                        <option value="imagen-4.0-generate-001">Imagen 4 Standard - Ausgewogen</option>
                                        <option value="imagen-4.0-fast-generate-001">Imagen 4 Fast - Schnell</option>
                                    </optgroup>
                                    <optgroup label="Imagen 3 (Legacy)">
                                        <option value="imagen-3.0-generate-002">Imagen 3 - Bewährt & stabil</option>
                                    </optgroup>
                                    <optgroup label="OpenAI">
                                        <option value="gpt-image-1">GPT-4o Image - Beste Qualität bis 4K</option>
                                        <option value="dall-e-3">DALL-E 3 - Kreativ & künstlerisch</option>
                                        <option value="dall-e-2">DALL-E 2 - Schnell & günstig</option>
                                    </optgroup>
                                </select>
                                <div class="form-text" id="model-hint">
                                    <i class="fas fa-lightbulb text-warning me-1"></i>
                                    <span id="model-hint-text">Nano Banana: Schnell, guter Text in Bildern, bis 14 Referenzbilder</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Qualität</label>
                                <select name="quality" class="form-select">
                                    <option value="standard">Standard</option>
                                    <option value="hd">HD (nur DALL-E 3)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Generate Button (versteckt bei mockup_text) -->
                        <div class="d-grid standard-form-section" id="standard-generate-btn-wrapper">
                            <button type="submit" class="btn btn-primary btn-lg" id="generate-btn">
                                <i class="fas fa-magic me-2"></i>Bild generieren
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar - Letzte Generierungen -->
        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-clock me-2"></i>Letzte Generierungen</h6>
                </div>
                <div class="card-body p-0">
                    {% if recent_generations %}
                    <div class="recent-generations">
                        {% for gen in recent_generations %}
                        <a href="{% url 'imageforge:generation_detail' gen.id %}" class="recent-gen-item">
                            {% if gen.generated_image %}
                            <img src="{% thumbnail gen.generated_image 'small' %}" alt="Generierung" loading="lazy">
                            {% else %}
                            <div class="no-image">
                                <i class="fas fa-image"></i>
                            </div>
                            {% endif %}
                            <div class="gen-info">
                                <span class="gen-mode">{{ gen.mode_display }}</span>
                                <span class="gen-date">{{ gen.created_at|date:"d.m.Y H:i" }}</span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-images fa-2x mb-2"></i>
                        <p>Noch keine Generierungen</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Result Modal -->
<div class="modal fade" id="result-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success me-2"></i>Bild generiert
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="result-image" src="" alt="Generiertes Bild" class="img-fluid result-preview">
                <div class="mt-3">
                    <p class="text-muted" id="result-info"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                <a href="#" id="download-btn" class="btn btn-success" download="imageforge-generated.png">
                    <i class="fas fa-download me-2"></i>Herunterladen
                </a>
                <a href="#" id="view-detail-btn" class="btn btn-primary">
                    <i class="fas fa-eye me-2"></i>Details
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Produktbild History Modal -->
<div class="modal fade" id="productHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-history me-2"></i>Produktbild-Verlauf</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="product-history-loading" class="text-center py-4">
                    <div class="spinner-border text-primary mb-2"></div>
                    <p class="text-muted mb-0">Lade Verlauf...</p>
                </div>
                <div id="product-history-results" class="d-none">
                    <div class="row g-3" id="product-history-list">
                        <!-- Bilder werden hier dynamisch eingefügt -->
                    </div>
                    <!-- Pagination -->
                    <nav id="product-history-pagination" class="mt-3 d-none">
                        <ul class="pagination justify-content-center mb-0">
                            <li class="page-item" id="product-history-prev">
                                <a class="page-link" href="#" data-page="prev"><i class="fas fa-chevron-left"></i></a>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link" id="product-history-page-info">Seite 1 von 1</span>
                            </li>
                            <li class="page-item" id="product-history-next">
                                <a class="page-link" href="#" data-page="next"><i class="fas fa-chevron-right"></i></a>
                            </li>
                        </ul>
                    </nav>
                </div>
                <div id="product-history-empty" class="text-center py-4 text-muted d-none">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Noch keine Produktbilder im Verlauf</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stil-Referenzbild History Modal -->
<div class="modal fade" id="styleRefHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-history me-2"></i>Stil-Referenzbild-Verlauf</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="style-ref-history-loading" class="text-center py-4">
                    <div class="spinner-border text-primary mb-2"></div>
                    <p class="text-muted mb-0">Lade Verlauf...</p>
                </div>
                <div id="style-ref-history-results" class="d-none">
                    <div class="row g-3" id="style-ref-history-list">
                        <!-- Bilder werden hier dynamisch eingefügt -->
                    </div>
                    <!-- Pagination -->
                    <nav id="style-ref-history-pagination" class="mt-3 d-none">
                        <ul class="pagination justify-content-center mb-0">
                            <li class="page-item" id="style-ref-history-prev">
                                <a class="page-link" href="#" data-page="prev"><i class="fas fa-chevron-left"></i></a>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link" id="style-ref-history-page-info">Seite 1 von 1</span>
                            </li>
                            <li class="page-item" id="style-ref-history-next">
                                <a class="page-link" href="#" data-page="next"><i class="fas fa-chevron-right"></i></a>
                            </li>
                        </ul>
                    </nav>
                </div>
                <div id="style-ref-history-empty" class="text-center py-4 text-muted d-none">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Noch keine Stil-Referenzbilder im Verlauf</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KI-Sprüche Generator Modal -->
<div class="modal fade" id="funnySayingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-magic me-2"></i>KI-Sprüche Generator</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Keyword / Thema</label>
                    <div class="d-flex gap-2">
                        <input type="text" id="funny-sayings-keyword" class="form-control"
                               placeholder="z.B. Kaffee, Montag, Büro, Hund...">
                        <button type="button" class="btn btn-warning" id="generate-funny-sayings-btn">
                            <i class="fas fa-magic me-1"></i>Generieren
                        </button>
                    </div>
                    <div class="form-text">Gib ein Thema ein und lass dir 10 witzige Sprüche generieren!</div>
                </div>
                <div id="funny-sayings-loading" class="text-center py-4 d-none">
                    <div class="spinner-border text-warning mb-2"></div>
                    <p class="text-muted mb-0">Generiere Sprüche...</p>
                </div>
                <div id="funny-sayings-results" class="d-none">
                    <label class="form-label fw-bold">Wähle einen Spruch:</label>
                    <div class="list-group" id="funny-sayings-list">
                        <!-- Sprüche werden hier dynamisch eingefügt -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hintergrund-Beschreibung Verlauf Modal -->
<div class="modal fade" id="backgroundHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-history me-2"></i>Hintergrund-Beschreibungen Verlauf</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="background-history-loading" class="text-center py-4">
                    <div class="spinner-border text-info mb-2"></div>
                    <p class="text-muted mb-0">Lade Verlauf...</p>
                </div>
                <div id="background-history-results" class="d-none">
                    <div class="list-group" id="background-history-list">
                        <!-- Beschreibungen werden hier dynamisch eingefügt -->
                    </div>
                    <!-- Pagination -->
                    <nav id="background-history-pagination" class="mt-3 d-none">
                        <ul class="pagination justify-content-center mb-0">
                            <li class="page-item" id="background-history-prev">
                                <a class="page-link" href="#" data-page="prev"><i class="fas fa-chevron-left"></i></a>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link" id="background-history-page-info">Seite 1 von 1</span>
                            </li>
                            <li class="page-item" id="background-history-next">
                                <a class="page-link" href="#" data-page="next"><i class="fas fa-chevron-right"></i></a>
                            </li>
                        </ul>
                    </nav>
                </div>
                <div id="background-history-empty" class="text-center py-4 text-muted d-none">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Noch keine Hintergrund-Beschreibungen im Verlauf</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="d-none">
    <div class="loading-content">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Generating...</span>
        </div>
        <h5>Bild wird generiert...</h5>
        <p class="text-muted">Dies kann bis zu 60 Sekunden dauern</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'imageforge/js/app.js' %}?v={% now 'U' %}"></script>
{% endblock %}
