{% extends "base.html" %}
{% load static %}

{% block title %}DIN 13201-1 - Parameter konfigurieren{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 2rem; background-color: #f8f9fa;">
    <!-- Page Header -->
    <div style="text-align: center; margin-bottom: 3rem; padding: 2rem 0;">
        <h1 style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem;">
            <i class="fas fa-sliders-h" style="margin-right: 0.5rem; color: #007bff;"></i>
            DIN 13201-1 Parameter
        </h1>
        <p style="color: #6c757d; margin: 0; font-size: 1.1rem;">
            {{ classification.road_category.name }} - Tabelle {{ classification.road_category.table_number }}
        </p>
    </div>

    <!-- Step Indicator -->
    <div style="display: flex; justify-content: center; margin-bottom: 2rem; gap: 1rem;">
        <div style="display: flex; align-items: center; padding: 0.75rem 1.5rem; border-radius: 2rem; font-weight: 600; background: #28a745; color: white;">
            <i class="fas fa-check" style="margin-right: 0.5rem;"></i>
            1. Stra√üentyp
        </div>
        <div style="display: flex; align-items: center; padding: 0.75rem 1.5rem; border-radius: 2rem; font-weight: 600; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; transform: scale(1.05); box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);">
            <i class="fas fa-sliders-h" style="margin-right: 0.5rem;"></i>
            2. Parameter
        </div>
        <div style="display: flex; align-items: center; padding: 0.75rem 1.5rem; border-radius: 2rem; font-weight: 600; background: #e9ecef; color: #6c757d;">
            <i class="fas fa-lightbulb" style="margin-right: 0.5rem;"></i>
            3. Beleuchtungsklasse
        </div>
    </div>

    <!-- Current Classification Info -->
    <div style="background: white; border: 2px solid #007bff; border-radius: 12px; margin-bottom: 2rem; padding: 1.5rem; text-align: center; box-shadow: 0 4px 8px rgba(0, 123, 255, 0.1);">
        <h3 style="margin: 0; color: #007bff; font-size: 1.3rem;">
            üìã {{ classification.project_name }} - {{ classification.road_category.code }}
        </h3>
        <p style="margin: 0.5rem 0 0 0; color: #6c757d;">
            {{ classification.road_category.lighting_class_type }}-Klassen nach DIN 13201-1
            <span style="font-weight: 600;">| Formel: {{ classification.road_category.lighting_class_type }} = 6 - VWS</span>
        </p>
    </div>

    <!-- Parameters Form -->
    <form method="post" id="dinParameterForm">
        {% csrf_token %}

        {% for parameter in parameters %}
        <div style="background: white; border: 2px solid #e9ecef; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); overflow: hidden;">
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1.25rem 1.5rem; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057; display: flex; align-items: center;">
                <i class="fas fa-cog" style="margin-right: 0.75rem; color: #007bff;"></i>
                <span>{{ parameter.name }}</span>
                {% if parameter.is_variable %}
                    <span style="background: #ffc107; color: #212529; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 600; margin-left: 1rem;">Variabel</span>
                {% endif %}
            </div>
            <div style="padding: 1.5rem;">
                {% for choice in parameter.choices.all %}
                <div class="choice-option"
                     data-param-id="{{ parameter.id }}"
                     data-choice-id="{{ choice.id }}"
                     style="background: white; border: 2px solid #dee2e6; border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; min-height: 70px; position: relative; transition: all 0.3s ease;"
                     onmouseover="if(!this.classList.contains('selected')) { this.style.borderColor='#007bff'; this.style.background='linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0, 123, 255, 0.15)'; }"
                     onmouseout="if(!this.classList.contains('selected')) { this.style.borderColor='#dee2e6'; this.style.background='white'; this.style.transform='translateY(0)'; this.style.boxShadow='none'; }">

                    <!-- Plus/Minus Indicator -->
                    {% if choice.weighting_value > 0 %}
                        <div style="position: absolute; top: -8px; right: 10px; font-size: 0.75rem; font-weight: bold; padding: 0.25rem 0.5rem; border-radius: 10px; color: #dc3545; background: #fff5f5; border: 1px solid #fecaca; z-index: 10;">
                            +{{ choice.weighting_value }}
                        </div>
                    {% elif choice.weighting_value < 0 %}
                        <div style="position: absolute; top: -8px; right: 10px; font-size: 0.75rem; font-weight: bold; padding: 0.25rem 0.5rem; border-radius: 10px; color: #059669; background: #f0fdf4; border: 1px solid #bbf7d0; z-index: 10;">
                            {{ choice.weighting_value }}
                        </div>
                    {% else %}
                        <div style="position: absolute; top: -8px; right: 10px; font-size: 0.75rem; font-weight: bold; padding: 0.25rem 0.5rem; border-radius: 10px; color: #6b7280; background: #f9fafb; border: 1px solid #d1d5db; z-index: 10;">
                            0
                        </div>
                    {% endif %}

                    <div style="flex-grow: 1; font-weight: 500; font-size: 1.1rem; line-height: 1.4; color: #212529;">
                        {{ choice.choice_text }}
                    </div>

                    <div style="background: #007bff; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: bold; min-width: 80px; text-align: center; flex-shrink: 0;">
                        {% if choice.weighting_value > 0 %}
                            +{{ choice.weighting_value }} VW
                        {% elif choice.weighting_value < 0 %}
                            {{ choice.weighting_value }} VW
                        {% else %}
                            0 VW
                        {% endif %}
                    </div>

                    <input type="radio" name="param_{{ parameter.id }}" value="{{ choice.id }}" style="display: none;">
                </div>
                {% endfor %}
            </div>
        </div>
        {% empty %}
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 1rem; border-radius: 8px; margin: 2rem 0;">
            <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
            Keine Parameter f√ºr diese Stra√üenkategorie verf√ºgbar.
        </div>
        {% endfor %}

        <!-- Action Buttons -->
        <div style="text-align: center; margin-top: 3rem; padding: 2rem 0;">
            <a href="{% url 'lighting_classification:select_road_type' %}"
               style="padding: 0.75rem 2rem; font-size: 1.1rem; font-weight: 600; border-radius: 10px; text-decoration: none; display: inline-block; margin: 0 0.5rem; background: #6c757d; color: white;">
                <i class="fas fa-arrow-left" style="margin-right: 0.5rem;"></i>
                Zur√ºck
            </a>
            <button type="submit"
                    id="calculateBtn"
                    disabled
                    style="padding: 0.75rem 2rem; font-size: 1.1rem; font-weight: 600; border-radius: 10px; margin: 0 0.5rem; border: none; background: #6c757d; color: white; cursor: not-allowed; opacity: 0.6;">
                <i class="fas fa-calculator" style="margin-right: 0.5rem;"></i>
                Beleuchtungsklasse berechnen
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const choiceOptions = document.querySelectorAll('.choice-option');
    const calculateBtn = document.getElementById('calculateBtn');
    const form = document.getElementById('dinParameterForm');
    const selectedChoices = {};

    console.log('DIN Parameter System loaded');
    console.log('Found choice options:', choiceOptions.length);

    choiceOptions.forEach(option => {
        // Disable hover effects when selected
        option.addEventListener('mouseenter', function() {
            if (this.classList.contains('selected')) {
                // Keep selected styles, don't change on hover
                this.style.borderColor = '#007bff';
                this.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
                this.style.color = 'white';
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 8px 20px rgba(0, 123, 255, 0.3)';

                // Ensure text stays white
                const textDiv = this.querySelector('div[style*="flex-grow"]');
                if (textDiv) textDiv.style.color = 'white';

                // Ensure badge stays visible
                const badge = this.querySelectorAll('div')[this.querySelectorAll('div').length - 1];
                if (badge && badge.textContent.includes('VW')) {
                    badge.style.background = 'rgba(255, 255, 255, 0.25)';
                    badge.style.color = 'white';
                }
            }
        });

        option.addEventListener('mouseleave', function() {
            if (this.classList.contains('selected')) {
                // Keep selected styles when mouse leaves
                this.style.borderColor = '#007bff';
                this.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
                this.style.color = 'white';
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 8px 20px rgba(0, 123, 255, 0.3)';

                // Ensure text stays white
                const textDiv = this.querySelector('div[style*="flex-grow"]');
                if (textDiv) textDiv.style.color = 'white';

                // Ensure badge stays visible
                const badge = this.querySelectorAll('div')[this.querySelectorAll('div').length - 1];
                if (badge && badge.textContent.includes('VW')) {
                    badge.style.background = 'rgba(255, 255, 255, 0.25)';
                    badge.style.color = 'white';
                }
            }
        });

        option.addEventListener('click', function() {
            const paramId = this.dataset.paramId;
            const choiceId = this.dataset.choiceId;

            console.log('Choice selected:', paramId, choiceId);

            // Remove selection from other choices of this parameter
            choiceOptions.forEach(otherOption => {
                if (otherOption.dataset.paramId === paramId) {
                    // Reset styles for unselected options
                    otherOption.classList.remove('selected');
                    otherOption.style.borderColor = '#dee2e6';
                    otherOption.style.background = 'white';
                    otherOption.style.color = '#212529';
                    otherOption.style.transform = 'translateY(0)';
                    otherOption.style.boxShadow = 'none';

                    // Reset text color
                    const textDiv = otherOption.querySelector('div[style*="flex-grow"]');
                    if (textDiv) textDiv.style.color = '#212529';

                    // Reset badge
                    const badge = otherOption.querySelectorAll('div')[otherOption.querySelectorAll('div').length - 1];
                    if (badge && badge.textContent.includes('VW')) {
                        badge.style.background = '#007bff';
                        badge.style.color = 'white';
                    }

                    const radio = otherOption.querySelector('input[type="radio"]');
                    if (radio) radio.checked = false;
                }
            });

            // Apply selected styles to this choice
            this.classList.add('selected');
            this.style.borderColor = '#007bff';
            this.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
            this.style.color = 'white';
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 20px rgba(0, 123, 255, 0.3)';

            // Update text color
            const textDiv = this.querySelector('div[style*="flex-grow"]');
            if (textDiv) textDiv.style.color = 'white';

            // Update badge style
            const badge = this.querySelectorAll('div')[this.querySelectorAll('div').length - 1];
            if (badge && badge.textContent.includes('VW')) {
                badge.style.background = 'rgba(255, 255, 255, 0.25)';
                badge.style.color = 'white';
            }

            const radio = this.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;

            selectedChoices[paramId] = choiceId;
            updateCalculateButton();
        });
    });

    function updateCalculateButton() {
        const totalParams = {{ parameters.count }};
        const selectedParams = Object.keys(selectedChoices).length;

        console.log(`Selected ${selectedParams}/${totalParams} parameters`);

        if (selectedParams === totalParams && totalParams > 0) {
            calculateBtn.disabled = false;
            calculateBtn.style.opacity = '1';
            calculateBtn.style.cursor = 'pointer';
            calculateBtn.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
        } else {
            calculateBtn.disabled = true;
            calculateBtn.style.opacity = '0.6';
            calculateBtn.style.cursor = 'not-allowed';
            calculateBtn.style.background = '#6c757d';
        }
    }

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Show loading state
        calculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Berechnung l√§uft...';
        calculateBtn.disabled = true;

        // Submit form after short delay for visual feedback
        setTimeout(() => {
            this.submit();
        }, 500);
    });

    // Initial button state
    updateCalculateButton();
});
</script>
{% endblock %}