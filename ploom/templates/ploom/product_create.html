{% extends "base.html" %}
{% load static %}

{% block title %}{% if is_new %}Neues Produkt{% else %}{{ product.title }} bearbeiten{% endif %} - P-Loom{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'ploom/css/style.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-{% if is_new %}plus-lg{% else %}pencil{% endif %} me-2 text-primary"></i>
                        {% if is_new %}Neues Produkt{% else %}Produkt bearbeiten{% endif %}
                    </h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0 small">
                            <li class="breadcrumb-item"><a href="{% url 'ploom:dashboard' %}">P-Loom</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'ploom:product_list' %}">Produkte</a></li>
                            <li class="breadcrumb-item active">{% if is_new %}Neu{% else %}Bearbeiten{% endif %}</li>
                        </ol>
                    </nav>
                </div>
                <div class="d-flex gap-2">
                    {% if not is_new %}
                    <button type="button" class="btn btn-success" id="btn-upload-shopify" {% if not product.shopify_store %}disabled{% endif %}>
                        <i class="bi bi-cloud-upload me-2"></i>Zu Shopify hochladen
                    </button>
                    {% endif %}
                    <button type="submit" form="product-form" class="btn btn-primary">
                        <i class="bi bi-check-lg me-2"></i>Speichern
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SEO Keyword Generator -->
    {% if is_new %}
    <div class="card border-0 shadow-sm mb-4 border-primary" style="border-left: 4px solid #0d6efd !important;">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-search me-2"></i>SEO Produkt-Generator</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                Gib ein Haupt-Keyword ein und generiere automatisch alle SEO-optimierten Texte.
            </p>
            <div class="row align-items-end">
                <div class="col-md-6 mb-3 mb-md-0">
                    <label class="form-label fw-bold">Haupt-Keyword / Produktname</label>
                    <input type="text" class="form-control form-control-lg" id="seo-keyword"
                           placeholder="z.B. Bluetooth Kopfhörer, Yoga Matte, LED Schreibtischlampe">
                </div>
                <div class="col-md-3 mb-3 mb-md-0">
                    <label class="form-label">Sprache</label>
                    <select class="form-select" id="seo-language">
                        <option value="de" selected>Deutsch</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-primary btn-lg w-100" id="btn-generate-all">
                        <i class="bi bi-magic me-2"></i>Alles generieren
                    </button>
                </div>
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Generiert: Titel, Beschreibung, SEO-Titel, SEO-Beschreibung, Tags
                </small>
            </div>
            <!-- Progress -->
            <div id="generate-progress" class="mt-3 d-none">
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%" id="generate-progress-bar">
                        <span id="generate-progress-text">Starte...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <form id="product-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row">
            <!-- Hauptinhalt -->
            <div class="col-lg-8">
                <!-- Titel & Beschreibung -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-card-text me-2 text-muted"></i>Produktdaten</h5>
                    </div>
                    <div class="card-body">
                        <!-- Titel -->
                        <div class="mb-3">
                            <label class="form-label">Titel *</label>
                            <div class="input-group">
                                {{ form.title }}
                                <button type="button" class="btn btn-outline-primary btn-ai-generate"
                                        data-field="title" data-target="id_title">
                                    <i class="bi bi-magic"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-history"
                                        data-field="title" data-target="id_title">
                                    <i class="bi bi-clock-history"></i>
                                </button>
                            </div>
                            <small class="text-muted"><span id="title-count">0</span>/70 Zeichen</small>
                        </div>

                        <!-- Beschreibung -->
                        <div class="mb-3">
                            <label class="form-label">Beschreibung</label>
                            <div class="d-flex gap-2 mb-2">
                                <button type="button" class="btn btn-sm btn-outline-primary btn-ai-generate"
                                        data-field="description" data-target="id_description">
                                    <i class="bi bi-magic me-1"></i>KI generieren
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary btn-history"
                                        data-field="description" data-target="id_description">
                                    <i class="bi bi-clock-history me-1"></i>Verlauf
                                </button>
                            </div>
                            {{ form.description }}
                        </div>

                        <!-- Tags -->
                        <div class="mb-3">
                            <label class="form-label">Tags</label>
                            <div class="input-group">
                                {{ form.tags }}
                                <button type="button" class="btn btn-outline-primary btn-ai-generate"
                                        data-field="tags" data-target="id_tags">
                                    <i class="bi bi-magic"></i>
                                </button>
                            </div>
                            <small class="text-muted">Komma-getrennte Liste</small>
                        </div>
                    </div>
                </div>

                <!-- SEO -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-search me-2 text-muted"></i>SEO</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-generate-seo">
                            <i class="bi bi-magic me-1"></i>KI generieren
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">SEO-Titel</label>
                            {{ form.seo_title }}
                            <small class="text-muted"><span id="seo-title-count">0</span>/70 Zeichen</small>
                        </div>
                        <div class="mb-0">
                            <label class="form-label">SEO-Beschreibung</label>
                            {{ form.seo_description }}
                            <small class="text-muted"><span id="seo-desc-count">0</span>/160 Zeichen</small>
                        </div>

                        <!-- SEO Preview -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <small class="text-muted d-block mb-1">Vorschau in Google:</small>
                            <div class="text-primary" id="seo-preview-title" style="font-size: 18px;">Titel hier...</div>
                            <div class="text-success small" id="seo-preview-url">www.example.com/products/...</div>
                            <div class="text-muted small" id="seo-preview-desc">Beschreibung hier...</div>
                        </div>
                    </div>
                </div>

                <!-- Bilder -->
                {% if is_new %}
                <div class="card border-0 shadow-sm mb-4 bg-light">
                    <div class="card-header bg-white">
                        <h5 class="mb-0 text-muted"><i class="bi bi-images me-2"></i>Bilder</h5>
                    </div>
                    <div class="card-body text-center py-4">
                        <i class="bi bi-save display-4 text-muted"></i>
                        <p class="mt-2 mb-0 text-muted">Speichere das Produkt zuerst, um Bilder hinzuzufügen</p>
                    </div>
                </div>
                {% else %}
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-images me-2 text-muted"></i>Bilder</h5>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#imageforgeModal">
                                <i class="bi bi-magic me-1"></i>Aus ImageForge
                            </button>
                            <label class="btn btn-sm btn-outline-secondary mb-0">
                                <i class="bi bi-upload me-1"></i>Hochladen
                                <input type="file" accept="image/*" multiple class="d-none" id="image-upload">
                            </label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="images-container" class="row g-3">
                            {% if images %}
                                {% for image in images %}
                                <div class="col-md-3 col-4" data-id="{{ image.id }}">
                                    <div class="position-relative ploom-image-item {% if image.is_featured %}is-featured{% endif %}">
                                        <img src="{{ image.image_url }}" class="img-fluid rounded">
                                        {% if image.is_featured %}
                                        <span class="badge bg-primary position-absolute top-0 start-0 m-1">Hauptbild</span>
                                        {% endif %}
                                        {% if image.variant_id %}
                                        <span class="badge bg-info position-absolute top-0 end-0 m-1 variant-badge" data-variant-id="{{ image.variant_id }}">
                                            <i class="bi bi-link-45deg"></i>
                                        </span>
                                        {% endif %}
                                        <div class="ploom-image-actions">
                                            <button type="button" class="btn btn-sm btn-light btn-set-featured" data-id="{{ image.id }}" title="Als Hauptbild">
                                                <i class="bi bi-star{% if image.is_featured %}-fill{% endif %}"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-info btn-assign-variant" data-id="{{ image.id }}" data-variant="{{ image.variant_id }}" title="Variante zuweisen">
                                                <i class="bi bi-link-45deg"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger btn-delete-image" data-id="{{ image.id }}" title="Löschen">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        {% if not images %}
                        <div id="no-images" class="text-center py-4 text-muted">
                            <i class="bi bi-images display-4"></i>
                            <p class="mt-2">Keine Bilder vorhanden</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Varianten -->
                {% if is_new %}
                <div class="card border-0 shadow-sm mb-4 bg-light">
                    <div class="card-header bg-white">
                        <h5 class="mb-0 text-muted"><i class="bi bi-list-ul me-2"></i>Varianten</h5>
                    </div>
                    <div class="card-body text-center py-4">
                        <i class="bi bi-save display-4 text-muted"></i>
                        <p class="mt-2 mb-0 text-muted">Speichere das Produkt zuerst, um Varianten hinzuzufügen</p>
                    </div>
                </div>
                {% else %}
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-ul me-2 text-muted"></i>Varianten</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-variant">
                            <i class="bi bi-plus-lg me-1"></i>Variante hinzufügen
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="variants-container">
                            {% if variants %}
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Optionen</th>
                                        <th>SKU</th>
                                        <th>Preis</th>
                                        <th>Bestand</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="variants-tbody">
                                    {% for variant in variants %}
                                    <tr data-id="{{ variant.id }}">
                                        <td>{{ variant.option_string|default:"-" }}</td>
                                        <td><code>{{ variant.sku|default:"-" }}</code></td>
                                        <td>{{ variant.price|default:"-" }} EUR</td>
                                        <td>{{ variant.inventory_quantity }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-variant" data-id="{{ variant.id }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger btn-delete-variant" data-id="{{ variant.id }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <div id="no-variants" class="text-center py-4 text-muted">
                                <p class="mb-0">Keine Varianten - Produkt hat nur eine Version</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Status & Store -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-gear me-2 text-muted"></i>Einstellungen</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Shopify Store</label>
                            {{ form.shopify_store }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Shopify Template</label>
                            <div class="input-group">
                                <select class="form-select" id="id_template_suffix" name="template_suffix">
                                    <option value="">— Templates laden... —</option>
                                </select>
                                <button type="button" class="btn btn-outline-secondary" id="refreshTemplatesBtn" title="Templates neu laden">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            <small class="text-muted">Bestimmt das Layout der Produktseite in Shopify</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">P-Loom Vorlage</label>
                            <div class="input-group">
                                {{ form.theme }}
                                <button type="button" class="btn btn-outline-primary" id="applyThemeBtn" title="Theme-Werte übernehmen">
                                    <i class="bi bi-arrow-down-circle"></i> Anwenden
                                </button>
                            </div>
                            <small class="text-muted">Wähle ein Theme und klicke "Anwenden" um die Vorlagen-Werte zu übernehmen</small>
                        </div>
                        {% if not is_new %}
                        <div class="mb-0">
                            <label class="form-label">Status</label>
                            <div>
                                <span class="badge fs-6
                                    {% if product.status == 'draft' %}bg-warning text-dark
                                    {% elif product.status == 'ready' %}bg-info
                                    {% elif product.status == 'uploaded' %}bg-success
                                    {% else %}bg-danger{% endif %}">
                                    {{ product.get_status_display }}
                                </span>
                                {% if product.shopify_product_id %}
                                <br><small class="text-muted mt-1">Shopify ID: {{ product.shopify_product_id }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Vertriebskanäle -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-broadcast me-2 text-muted"></i>Vertriebskanäle</h5>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshPublicationsBtn" title="Kanäle neu laden">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="publications-container">
                            <div class="text-center py-3 text-muted">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Lade Kanäle...</span>
                            </div>
                        </div>
                        <input type="hidden" name="sales_channels" id="id_sales_channels" value="{% if product.sales_channels %}{{ product.sales_channels|safe }}{% else %}[]{% endif %}">
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            Wähle aus, wo das Produkt veröffentlicht werden soll
                        </small>
                    </div>
                </div>

                <!-- Preise -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-currency-euro me-2 text-muted"></i>Preise</h5>
                        <button type="button" class="btn btn-sm btn-outline-secondary btn-history"
                                data-field="prices" data-target="id_price">
                            <i class="bi bi-clock-history"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Preis (EUR)</label>
                            {{ form.price }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vergleichspreis (EUR)</label>
                            {{ form.compare_at_price }}
                            <small class="text-muted">Durchgestrichener Original-Preis</small>
                        </div>
                        <div class="mb-0">
                            <label class="form-label">Gewicht</label>
                            <div class="input-group">
                                {{ form.weight }}
                                {{ form.weight_unit }}
                            </div>
                            <small class="text-muted">Für Versandkosten-Berechnung</small>
                        </div>
                    </div>
                </div>

                <!-- Produktdetails -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2 text-muted"></i>Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Hersteller</label>
                            {{ form.vendor }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Produkttyp</label>
                            {{ form.product_type }}
                        </div>
                        <div class="mb-0">
                            <label class="form-label">Collection</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="collection-display"
                                       value="{{ product.collection_name|default:'' }}" readonly
                                       placeholder="Keine Collection">
                                <button type="button" class="btn btn-outline-primary" id="btn-select-collection">
                                    <i class="bi bi-folder"></i>
                                </button>
                            </div>
                            {{ form.collection_id }}
                            {{ form.collection_name }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{% if not is_new %}
<!-- ImageForge Modal -->
<div class="modal fade" id="imageforgeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-magic me-2"></i>Bilder aus ImageForge</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-generations">
                            Generierungen
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-mockups">
                            Mockups
                        </button>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tab-generations">
                        <div class="row g-2" id="imageforge-generations">
                            <div class="text-center py-4">
                                <div class="spinner-border" role="status"></div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tab-mockups">
                        <div class="row g-2" id="imageforge-mockups">
                            <div class="text-center py-4">
                                <div class="spinner-border" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-clock-history me-2"></i>Verlauf</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="history-items"></div>
                <div id="history-pagination" class="d-flex justify-content-between mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Variant Modal -->
<div class="modal fade" id="variantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-list-ul me-2"></i>Variante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="variant-id">
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label">Option 1 Name</label>
                        <input type="text" class="form-control" id="variant-option1-name" placeholder="z.B. Größe">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">Option 1 Wert</label>
                        <input type="text" class="form-control" id="variant-option1-value" placeholder="z.B. M">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">Option 2 Name</label>
                        <input type="text" class="form-control" id="variant-option2-name" placeholder="z.B. Farbe">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">Option 2 Wert</label>
                        <input type="text" class="form-control" id="variant-option2-value" placeholder="z.B. Rot">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">SKU</label>
                        <input type="text" class="form-control" id="variant-sku">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">Preis (EUR)</label>
                        <input type="number" step="0.01" class="form-control" id="variant-price">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">Bestand</label>
                        <input type="number" class="form-control" id="variant-quantity" value="0">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">Barcode</label>
                        <input type="text" class="form-control" id="variant-barcode">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="btn-save-variant">Speichern</button>
            </div>
        </div>
    </div>
</div>

<!-- Varianten-Bild-Zuordnung Modal -->
<div class="modal fade" id="variantImageModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-link-45deg me-2"></i>Variante zuweisen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="variant-image-id">
                <div class="mb-3">
                    <label class="form-label">Bild zuweisen an:</label>
                    <select class="form-select" id="variant-image-select">
                        <option value="">— Keine Variante (Hauptprodukt) —</option>
                        {% for variant in variants %}
                        <option value="{{ variant.id }}">{{ variant }}</option>
                        {% endfor %}
                    </select>
                </div>
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Das Bild wird in Shopify der gewählten Variante zugeordnet.
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="btn-save-variant-image">Zuweisen</button>
            </div>
        </div>
    </div>
</div>

<!-- Collection Modal -->
<div class="modal fade" id="collectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-folder me-2"></i>Collection auswählen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="collections-list">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'ploom/js/product_editor.js' %}?v={% now 'U' %}"></script>
<script>
const PRODUCT_ID = '{% if product %}{{ product.id }}{% endif %}';
const CSRF_TOKEN = '{{ csrf_token }}';
const IS_NEW = {{ is_new|yesno:"true,false" }};

// SEO Komplett-Generator
document.getElementById('btn-generate-all')?.addEventListener('click', async function() {
    const keyword = document.getElementById('seo-keyword')?.value.trim();
    const language = document.getElementById('seo-language')?.value || 'de';

    if (!keyword) {
        alert('Bitte gib ein Keyword oder Produktnamen ein');
        document.getElementById('seo-keyword')?.focus();
        return;
    }

    const btn = this;
    const progress = document.getElementById('generate-progress');
    const progressBar = document.getElementById('generate-progress-bar');
    const progressText = document.getElementById('generate-progress-text');

    // UI aktualisieren
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generiere...';
    progress?.classList.remove('d-none');

    const updateProgress = (percent, text) => {
        if (progressBar) progressBar.style.width = percent + '%';
        if (progressText) progressText.textContent = text;
    };

    updateProgress(10, 'Starte KI-Generierung...');

    try {
        const response = await fetch('/ploom/api/generate/all/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify({ keyword, language })
        });

        updateProgress(50, 'Verarbeite Antwort...');

        const data = await response.json();

        if (data.success && data.content) {
            const content = data.content;

            updateProgress(70, 'Fülle Formularfelder...');

            // Felder ausfüllen
            if (content.title) {
                document.getElementById('id_title').value = content.title;
            }
            if (content.description) {
                document.getElementById('id_description').value = content.description;
            }
            if (content.seo_title) {
                document.getElementById('id_seo_title').value = content.seo_title;
            }
            if (content.seo_description) {
                document.getElementById('id_seo_description').value = content.seo_description;
            }
            if (content.tags) {
                document.getElementById('id_tags').value = content.tags;
            }

            updateProgress(100, 'Fertig!');

            // Erfolg anzeigen
            setTimeout(() => {
                progress?.classList.add('d-none');
                progressBar.style.width = '0%';

                // Zum Titel scrollen
                document.getElementById('id_title')?.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Zeichen-Zähler aktualisieren (falls vorhanden)
                document.getElementById('id_title')?.dispatchEvent(new Event('input'));
                document.getElementById('id_seo_title')?.dispatchEvent(new Event('input'));
                document.getElementById('id_seo_description')?.dispatchEvent(new Event('input'));
            }, 500);

        } else {
            throw new Error(data.error || 'Generierung fehlgeschlagen');
        }

    } catch (error) {
        console.error('Error:', error);
        alert('Fehler bei der Generierung: ' + error.message);
        progress?.classList.add('d-none');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-magic me-2"></i>Alles generieren';
    }
});

// Theme anwenden
document.getElementById('applyThemeBtn')?.addEventListener('click', async function() {
    const themeSelect = document.getElementById('id_theme');
    const themeId = themeSelect?.value;

    if (!themeId) {
        alert('Bitte wähle zuerst ein Theme aus');
        return;
    }

    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
        const response = await fetch(`/ploom/api/themes/${themeId}/`);
        const data = await response.json();

        if (data.success) {
            const theme = data.theme;

            // Felder übernehmen (nur wenn leer oder nach Bestätigung)
            const fieldsToApply = [];

            if (theme.default_price) fieldsToApply.push(['id_price', theme.default_price, 'Preis']);
            if (theme.default_compare_at_price) fieldsToApply.push(['id_compare_at_price', theme.default_compare_at_price, 'Vergleichspreis']);
            if (theme.default_vendor) fieldsToApply.push(['id_vendor', theme.default_vendor, 'Anbieter']);
            if (theme.default_product_type) fieldsToApply.push(['id_product_type', theme.default_product_type, 'Produkttyp']);
            if (theme.default_tags) fieldsToApply.push(['id_tags', theme.default_tags, 'Tags']);
            if (theme.description_template) fieldsToApply.push(['id_description', theme.description_template, 'Beschreibung']);
            if (theme.seo_title_template) fieldsToApply.push(['id_seo_title', theme.seo_title_template, 'SEO-Titel']);
            if (theme.seo_description_template) fieldsToApply.push(['id_seo_description', theme.seo_description_template, 'SEO-Beschreibung']);

            let appliedCount = 0;
            fieldsToApply.forEach(([fieldId, value, label]) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Nur überschreiben wenn leer oder User bestätigt
                    if (!field.value || field.value.trim() === '') {
                        field.value = value;
                        appliedCount++;
                    }
                }
            });

            // Visuelles Feedback
            const themeName = themeSelect.options[themeSelect.selectedIndex].text;
            if (appliedCount > 0) {
                alert(`Theme "${themeName}" angewendet!\n${appliedCount} Felder wurden ausgefüllt.`);
            } else {
                if (confirm(`Alle Felder sind bereits ausgefüllt.\nMöchtest du sie mit den Theme-Werten überschreiben?`)) {
                    fieldsToApply.forEach(([fieldId, value]) => {
                        const field = document.getElementById(fieldId);
                        if (field) field.value = value;
                    });
                    alert(`Theme "${themeName}" angewendet!`);
                }
            }
        } else {
            alert('Fehler: ' + (data.error || 'Theme konnte nicht geladen werden'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Fehler beim Laden des Themes');
    } finally {
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-arrow-down-circle"></i> Anwenden';
    }
});

// Shopify Templates laden
async function loadShopifyTemplates() {
    const templateSelect = document.getElementById('id_template_suffix');
    const storeSelect = document.getElementById('id_shopify_store');
    const refreshBtn = document.getElementById('refreshTemplatesBtn');
    const currentValue = templateSelect?.value || '{% if product %}{{ product.template_suffix }}{% endif %}';

    if (!templateSelect) return;

    // Loading-State
    templateSelect.innerHTML = '<option value="">— Lade Templates... —</option>';
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    }

    try {
        const storeId = storeSelect?.value || '';
        const url = storeId ? `/ploom/api/shopify/templates/?store_id=${storeId}` : '/ploom/api/shopify/templates/';
        const response = await fetch(url);
        const data = await response.json();

        templateSelect.innerHTML = '';

        if (data.success && data.templates) {
            data.templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.suffix;
                option.textContent = template.name;
                if (template.suffix === currentValue) {
                    option.selected = true;
                }
                templateSelect.appendChild(option);
            });
        } else {
            // Nur Standard-Option bei Fehler
            templateSelect.innerHTML = '<option value="">— Standard —</option>';
            console.warn('Templates konnten nicht geladen werden:', data.error);
        }
    } catch (error) {
        console.error('Error loading templates:', error);
        templateSelect.innerHTML = '<option value="">— Fehler beim Laden —</option>';
    } finally {
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
        }
    }
}

// Templates beim Laden der Seite abrufen
document.addEventListener('DOMContentLoaded', loadShopifyTemplates);

// Templates neu laden bei Store-Wechsel
document.getElementById('id_shopify_store')?.addEventListener('change', loadShopifyTemplates);

// Refresh-Button
document.getElementById('refreshTemplatesBtn')?.addEventListener('click', loadShopifyTemplates);

// ============================================================================
// Vertriebskanäle (Sales Channels / Publications)
// ============================================================================

let selectedPublications = [];

// Initiale Auswahl aus Hidden Field laden
try {
    const initialValue = document.getElementById('id_sales_channels')?.value;
    if (initialValue && initialValue !== '[]') {
        selectedPublications = JSON.parse(initialValue);
    }
} catch (e) {
    console.warn('Could not parse initial sales channels:', e);
}

async function loadPublications() {
    const container = document.getElementById('publications-container');
    const storeSelect = document.getElementById('id_shopify_store');

    if (!container) return;

    // Loading-State
    container.innerHTML = `
        <div class="text-center py-3 text-muted">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            <span class="ms-2">Lade Kanäle...</span>
        </div>
    `;

    try {
        const storeId = storeSelect?.value || '';
        const url = storeId ? `/ploom/api/shopify/publications/?store_id=${storeId}` : '/ploom/api/shopify/publications/';
        const response = await fetch(url);
        const data = await response.json();

        if (data.success && data.publications && data.publications.length > 0) {
            renderPublications(data.publications, container);
        } else if (data.success && (!data.publications || data.publications.length === 0)) {
            container.innerHTML = '<p class="text-muted mb-0 small">Keine Vertriebskanäle verfügbar</p>';
        } else {
            container.innerHTML = `<p class="text-danger mb-0 small">${data.error || 'Fehler beim Laden'}</p>`;
        }
    } catch (error) {
        console.error('Error loading publications:', error);
        container.innerHTML = '<p class="text-danger mb-0 small">Fehler beim Laden der Kanäle</p>';
    }
}

function renderPublications(publications, container) {
    container.innerHTML = publications.map(pub => {
        const isChecked = selectedPublications.includes(pub.id);
        const iconClass = getPublicationIcon(pub.name, pub.handle);
        return `
            <div class="form-check mb-2">
                <input class="form-check-input publication-checkbox" type="checkbox"
                       value="${pub.id}" id="pub-${pub.id}" ${isChecked ? 'checked' : ''}>
                <label class="form-check-label" for="pub-${pub.id}">
                    <i class="bi ${iconClass} me-1 text-muted"></i>
                    ${escapeHtml(pub.name)}
                </label>
            </div>
        `;
    }).join('');

    // Event-Listener für Checkboxen
    container.querySelectorAll('.publication-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedPublications();
        });
    });
}

function getPublicationIcon(name, handle) {
    const lowerName = (name + ' ' + handle).toLowerCase();
    if (lowerName.includes('online') || lowerName.includes('store') || lowerName.includes('shop')) {
        return 'bi-globe';
    } else if (lowerName.includes('pos') || lowerName.includes('point')) {
        return 'bi-shop';
    } else if (lowerName.includes('facebook') || lowerName.includes('fb')) {
        return 'bi-facebook';
    } else if (lowerName.includes('instagram') || lowerName.includes('insta')) {
        return 'bi-instagram';
    } else if (lowerName.includes('google')) {
        return 'bi-google';
    } else if (lowerName.includes('amazon')) {
        return 'bi-box-seam';
    } else if (lowerName.includes('ebay')) {
        return 'bi-cart3';
    } else if (lowerName.includes('tiktok')) {
        return 'bi-tiktok';
    } else if (lowerName.includes('pinterest')) {
        return 'bi-pinterest';
    }
    return 'bi-broadcast';
}

function updateSelectedPublications() {
    selectedPublications = [];
    document.querySelectorAll('.publication-checkbox:checked').forEach(checkbox => {
        selectedPublications.push(checkbox.value);
    });

    // Hidden Field aktualisieren
    const hiddenField = document.getElementById('id_sales_channels');
    if (hiddenField) {
        hiddenField.value = JSON.stringify(selectedPublications);
    }
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Publications beim Laden der Seite abrufen
document.addEventListener('DOMContentLoaded', loadPublications);

// Publications neu laden bei Store-Wechsel
document.getElementById('id_shopify_store')?.addEventListener('change', function() {
    selectedPublications = []; // Reset bei Store-Wechsel
    loadPublications();
});

// Refresh-Button für Publications
document.getElementById('refreshPublicationsBtn')?.addEventListener('click', loadPublications);
</script>
{% endblock %}
