{% extends "base.html" %}
{% load static %}

{% block title %}Neue Kampagne - LoomMarket{% endblock %}

{% block extra_css %}
<style>
    .image-select-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.75rem;
    }
    .image-select-item {
        aspect-ratio: 1;
        border: 3px solid transparent;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
    }
    .image-select-item:hover {
        border-color: #0d6efd;
    }
    .image-select-item.selected {
        border-color: #0d6efd;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
    }
    .image-select-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .template-select-item {
        cursor: pointer;
        transition: all 0.2s;
    }
    .template-select-item:hover {
        background-color: #f8f9fa;
    }
    .template-select-item.selected {
        background-color: #e7f1ff;
        border-color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'loommarket:dashboard' %}">LoomMarket</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'loommarket:campaign_list' %}">Kampagnen</a></li>
                    <li class="breadcrumb-item active">Neue Kampagne</li>
                </ol>
            </nav>
            <h1 class="h3">
                <i class="bi bi-megaphone me-2"></i>Neue Kampagne fuer {{ business.name|default:business.instagram_username }}
            </h1>
        </div>
    </div>

    <form method="post" id="campaign-form">
        {% csrf_token %}
        <input type="hidden" name="selected_image" id="selected-image">
        <input type="hidden" name="selected_template" id="selected-template">

        <div class="row">
            <div class="col-lg-8">
                <!-- Kampagnenname -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Kampagnen-Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="name" class="form-label fw-bold">Kampagnenname *</label>
                            <input type="text" class="form-control" id="name" name="name" required
                                   placeholder="z.B. Fruehlings-Promotion {{ business.name|default:business.instagram_username }}"
                                   value="Kampagne {{ business.name|default:business.instagram_username }} - {% now 'd.m.Y' %}">
                        </div>
                    </div>
                </div>

                <!-- Design-Bild auswaehlen -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-image me-2"></i>Design-Bild auswaehlen *</h5>
                    </div>
                    <div class="card-body">
                        {% if images %}
                        <p class="text-muted small">Waehle das Bild (Logo oder Produktbild), das auf das Mockup graviert werden soll.</p>
                        <div class="image-select-grid">
                            {% for img in images %}
                            <div class="image-select-item {% if img.is_logo %}border-primary{% endif %}"
                                 data-id="{{ img.pk }}" onclick="selectImage(this, {{ img.pk }})">
                                <img src="{{ img.image.url }}" alt="Bild {{ forloop.counter }}" loading="lazy">
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Keine Bilder vorhanden.
                            <a href="{% url 'loommarket:business_detail' business.pk %}">Bilder hinzufuegen</a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Mockup-Vorlage auswaehlen -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-images me-2"></i>Mockup-Vorlage (optional)</h5>
                    </div>
                    <div class="card-body p-0">
                        {% if templates %}
                        <div class="list-group list-group-flush">
                            <!-- Option: Keine Vorlage -->
                            <div class="list-group-item template-select-item selected" data-id="0"
                                 onclick="selectTemplate(this, 0)">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <div class="bg-secondary d-flex align-items-center justify-content-center text-white"
                                             style="width: 60px; height: 60px; border-radius: 4px;">
                                            <i class="bi bi-x-lg"></i>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <h6 class="mb-1">Keine Vorlage</h6>
                                        <small class="text-muted">Nur Captions generieren, kein Mockup</small>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-check-circle-fill text-primary selected-check"></i>
                                    </div>
                                </div>
                            </div>
                            {% for template in templates %}
                            <div class="list-group-item template-select-item" data-id="{{ template.pk }}"
                                 onclick="selectTemplate(this, {{ template.pk }})">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        {% if template.product_image_blank %}
                                        <img src="{{ template.product_image_blank.url }}"
                                             style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;"
                                             alt="{{ template.name }}">
                                        {% else %}
                                        <div class="bg-light d-flex align-items-center justify-content-center"
                                             style="width: 60px; height: 60px; border-radius: 4px;">
                                            <i class="bi bi-image text-muted"></i>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col">
                                        <h6 class="mb-1">{{ template.name }}</h6>
                                        {% if template.description %}
                                        <small class="text-muted">{{ template.description|truncatechars:60 }}</small>
                                        {% endif %}
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-check-circle-fill text-primary d-none selected-check"></i>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="list-group list-group-flush">
                            <!-- Option: Keine Vorlage wenn keine existieren -->
                            <div class="list-group-item template-select-item selected" data-id="0"
                                 onclick="selectTemplate(this, 0)">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <div class="bg-secondary d-flex align-items-center justify-content-center text-white"
                                             style="width: 60px; height: 60px; border-radius: 4px;">
                                            <i class="bi bi-x-lg"></i>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <h6 class="mb-1">Keine Vorlage</h6>
                                        <small class="text-muted">Nur Captions generieren, kein Mockup</small>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-check-circle-fill text-primary selected-check"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-3 border-top bg-light">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Fuer Mockup-Generierung: <a href="{% url 'loommarket:template_create' %}">Vorlage erstellen</a>
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Hintergrund-Beschreibung -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-palette me-2"></i>Hintergrund (optional)</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="background_prompt" class="form-label">Hintergrundbeschreibung</label>
                            <textarea class="form-control" id="background_prompt" name="background_prompt" rows="2"
                                      placeholder="z.B. Moderner Schreibtisch mit Pflanzen, warmes Tageslicht"></textarea>
                            <div class="form-text">Wenn leer, wird der Standard-Hintergrund der Vorlage verwendet.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Unternehmen Info -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-building me-2"></i>Unternehmen</h6>
                    </div>
                    <div class="card-body">
                        <h5>{{ business.name|default:business.instagram_username }}</h5>
                        <p class="text-muted mb-2">
                            <i class="bi bi-instagram text-danger me-1"></i>@{{ business.instagram_username }}
                        </p>
                        {% if business.website %}
                        <p class="text-muted mb-0 small">
                            <i class="bi bi-globe me-1"></i>{{ business.website|truncatechars:40 }}
                        </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Aktionen -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-lg" id="submit-btn" disabled>
                        <i class="bi bi-check-lg me-2"></i>Kampagne erstellen
                    </button>
                    <a href="{% url 'loommarket:campaign_list' %}" class="btn btn-outline-secondary">
                        Abbrechen
                    </a>
                </div>

                <!-- Hinweise -->
                <div class="card bg-light mt-4">
                    <div class="card-body">
                        <h6><i class="bi bi-lightbulb me-2"></i>Naechste Schritte</h6>
                        <ol class="small text-muted mb-0">
                            <li>Design-Bild und Vorlage auswaehlen</li>
                            <li>Kampagne erstellen</li>
                            <li>Mockup mit KI generieren</li>
                            <li>Captions erstellen lassen</li>
                            <li>Auf Social Media posten oder herunterladen</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedImageId = null;
let selectedTemplateId = 0;  // Default: keine Vorlage

function selectImage(element, imageId) {
    // Alle abwaehlen
    document.querySelectorAll('.image-select-item').forEach(el => {
        el.classList.remove('selected');
    });

    // Dieses auswaehlen
    element.classList.add('selected');
    selectedImageId = imageId;
    document.getElementById('selected-image').value = imageId;

    checkSubmitButton();
}

function selectTemplate(element, templateId) {
    // Alle abwaehlen
    document.querySelectorAll('.template-select-item').forEach(el => {
        el.classList.remove('selected');
        const check = el.querySelector('.selected-check');
        if (check) check.classList.add('d-none');
    });

    // Dieses auswaehlen
    element.classList.add('selected');
    const check = element.querySelector('.selected-check');
    if (check) check.classList.remove('d-none');
    selectedTemplateId = templateId;
    document.getElementById('selected-template').value = templateId || '';

    checkSubmitButton();
}

function checkSubmitButton() {
    const submitBtn = document.getElementById('submit-btn');
    const nameInput = document.getElementById('name');

    // Nur Image und Name sind required, Template ist optional
    if (selectedImageId && nameInput.value.trim()) {
        submitBtn.disabled = false;
    } else {
        submitBtn.disabled = true;
    }
}

// Name-Eingabe ueberwachen
document.getElementById('name').addEventListener('input', checkSubmitButton);

// Initial check
checkSubmitButton();

// Formular-Validierung
document.getElementById('campaign-form').addEventListener('submit', function(e) {
    if (!selectedImageId) {
        e.preventDefault();
        alert('Bitte waehle ein Design-Bild aus.');
    }
});
</script>
{% endblock %}
