{% extends "blogprep/base_wizard.html" %}

{% block wizard_content %}
<h2><i class="bi bi-search me-2"></i>Schritt 2: Recherche & Gliederung</h2>

<div class="alert alert-info mb-4">
    <strong>Keyword:</strong> {{ project.main_keyword }}
    {% if project.secondary_keywords %}
    | <strong>Sekundär:</strong> {{ project.secondary_keywords|join:", " }}
    {% endif %}
</div>

<!-- Research Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-globe me-2"></i>Web-Recherche</h5>
        <button type="button" class="btn btn-primary btn-sm" onclick="runResearch()" id="researchBtn">
            <i class="bi bi-play"></i> Recherche starten
        </button>
    </div>
    <div class="card-body" id="researchResults">
        {% if project.research_data %}
        <div class="research-data">
            {% if project.research_data.sources %}
            <div class="alert alert-success mb-3">
                <h6 class="mb-2"><i class="bi bi-check-circle me-2"></i>Analysierte Quellen (Top {{ project.research_data.sources|length }}):</h6>
                <ul class="mb-0 small">
                    {% for source in project.research_data.sources %}
                    <li><a href="{{ source.url }}" target="_blank" rel="noopener">{{ source.title|truncatechars:60 }}</a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="row">
                <div class="col-md-6">
                    {% if project.research_data.main_topics %}
                    <h6><i class="bi bi-tags me-1"></i>Hauptthemen:</h6>
                    <ul>
                        {% for topic in project.research_data.main_topics %}
                        <li>{{ topic }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if project.research_data.key_facts %}
                    <h6><i class="bi bi-lightbulb me-1"></i>Wichtige Fakten:</h6>
                    <ul>
                        {% for fact in project.research_data.key_facts %}
                        <li>{{ fact }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {% if project.research_data.user_questions %}
                    <h6><i class="bi bi-question-circle me-1"></i>Häufige Fragen:</h6>
                    <ul>
                        {% for question in project.research_data.user_questions %}
                        <li>{{ question }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if project.research_data.content_gaps %}
                    <h6><i class="bi bi-arrow-up-circle me-1"></i>Content-Lücken:</h6>
                    <ul class="small text-muted">
                        {% for gap in project.research_data.content_gaps %}
                        <li>{{ gap }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <p class="text-muted">
            <i class="bi bi-info-circle me-2"></i>
            Klicke auf "Recherche starten" um die <strong>Top-5 Suchergebnisse</strong> zu analysieren.
            Die KI liest die Inhalte der gefundenen Seiten und extrahiert relevante Informationen.
        </p>
        {% endif %}
    </div>
</div>

<!-- Outline Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-list-ol me-2"></i>Gliederung</h5>
        <button type="button" class="btn btn-primary btn-sm" onclick="generateOutline()" id="outlineBtn"
                {% if not project.research_data %}disabled{% endif %}>
            <i class="bi bi-magic"></i> Gliederung generieren
        </button>
    </div>
    <div class="card-body">
        <div id="outlineEditor">
            {% if project.outline %}
            {% for item in project.outline %}
            <div class="outline-item mb-3 p-3 bg-light rounded border-start border-4 border-primary">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong class="fs-5">{{ item.h2 }}</strong>
                        <span class="badge bg-secondary ms-2">{{ item.section }}</span>
                        <span class="badge bg-info ms-1">~{{ item.word_target }} Wörter</span>
                    </div>
                </div>
                {% if item.key_points %}
                <ul class="mt-2 mb-2">
                    {% for point in item.key_points %}
                    <li>{{ point }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% if item.research_reference %}
                <p class="mb-0 small text-muted fst-italic">
                    <i class="bi bi-link-45deg me-1"></i>Recherche-Bezug: {{ item.research_reference }}
                </p>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted" id="outlinePlaceholder">
                Führe zuerst die Recherche durch, dann generiere die Gliederung.
            </p>
            {% endif %}
        </div>
    </div>
</div>

<form method="post" id="step2Form">
    {% csrf_token %}
    <input type="hidden" name="outline" id="outlineData"
           value='{{ project.outline|safe|default:"[]" }}'>

    <div class="wizard-actions">
        <a href="{% url 'blogprep:wizard_step1_edit' project_id=project.id %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Zurück
        </a>
        <button type="submit" class="btn btn-primary" {% if not project.outline %}disabled{% endif %} id="nextBtn">
            Weiter zu Content <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</form>
{% endblock %}

{% block wizard_js %}
<script>
    let outlineData = {{ project.outline|safe|default:"[]" }};

    async function runResearch() {
        showLoading('Führe echte Web-Recherche durch... (analysiere Top-5 Suchergebnisse)');
        const btn = document.getElementById('researchBtn');
        btn.disabled = true;

        try {
            const result = await apiCall('{% url "blogprep:api_run_research" project_id=project.id %}');

            if (result.success && result.data) {
                // Update UI with research results
                let html = '<div class="research-data">';

                // Zeige analysierte Quellen
                if (result.data.sources && result.data.sources.length) {
                    html += `<div class="alert alert-success mb-3">
                        <h6 class="mb-2"><i class="bi bi-check-circle me-2"></i>Analysierte Quellen (Top ${result.data.sources.length}):</h6>
                        <ul class="mb-0 small">`;
                    result.data.sources.forEach(s => {
                        const title = s.title.length > 60 ? s.title.substring(0, 60) + '...' : s.title;
                        html += `<li><a href="${s.url}" target="_blank" rel="noopener">${title}</a></li>`;
                    });
                    html += '</ul></div>';
                }

                html += '<div class="row"><div class="col-md-6">';

                if (result.data.main_topics && result.data.main_topics.length) {
                    html += '<h6><i class="bi bi-tags me-1"></i>Hauptthemen:</h6><ul>';
                    result.data.main_topics.forEach(t => html += `<li>${t}</li>`);
                    html += '</ul>';
                }

                if (result.data.key_facts && result.data.key_facts.length) {
                    html += '<h6><i class="bi bi-lightbulb me-1"></i>Wichtige Fakten:</h6><ul>';
                    result.data.key_facts.forEach(f => html += `<li>${f}</li>`);
                    html += '</ul>';
                }

                html += '</div><div class="col-md-6">';

                if (result.data.user_questions && result.data.user_questions.length) {
                    html += '<h6><i class="bi bi-question-circle me-1"></i>Häufige Fragen:</h6><ul>';
                    result.data.user_questions.forEach(q => html += `<li>${q}</li>`);
                    html += '</ul>';
                }

                if (result.data.content_gaps && result.data.content_gaps.length) {
                    html += '<h6><i class="bi bi-arrow-up-circle me-1"></i>Content-Lücken:</h6><ul class="small text-muted">';
                    result.data.content_gaps.forEach(g => html += `<li>${g}</li>`);
                    html += '</ul>';
                }

                html += '</div></div></div>';
                document.getElementById('researchResults').innerHTML = html;

                // Enable outline button
                document.getElementById('outlineBtn').disabled = false;
            } else {
                alert(result.error || 'Fehler bei der Recherche');
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        } finally {
            hideLoading();
            btn.disabled = false;
        }
    }

    async function generateOutline() {
        showLoading('Generiere ausführliche Blog-Gliederung basierend auf Recherche...');
        const btn = document.getElementById('outlineBtn');
        btn.disabled = true;

        try {
            const result = await apiCall('{% url "blogprep:api_generate_outline" project_id=project.id %}');

            if (result.success && result.data && result.data.outline) {
                outlineData = result.data.outline;
                document.getElementById('outlineData').value = JSON.stringify(outlineData);

                // Zeige unique_angle wenn vorhanden
                let html = '';
                if (result.data.unique_angle) {
                    html += `<div class="alert alert-success mb-3">
                        <i class="bi bi-star me-2"></i><strong>Unser Vorteil:</strong> ${result.data.unique_angle}
                    </div>`;
                }

                // Render outline
                outlineData.forEach(item => {
                    html += `
                    <div class="outline-item mb-3 p-3 bg-light rounded border-start border-4 border-primary">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="fs-5">${item.h2}</strong>
                                <span class="badge bg-secondary ms-2">${item.section}</span>
                                <span class="badge bg-info ms-1">~${item.word_target} Wörter</span>
                            </div>
                        </div>
                        ${item.key_points ? `
                        <ul class="mt-2 mb-2">
                            ${item.key_points.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                        ` : ''}
                        ${item.research_reference ? `
                        <p class="mb-0 small text-muted fst-italic">
                            <i class="bi bi-link-45deg me-1"></i>Recherche-Bezug: ${item.research_reference}
                        </p>
                        ` : ''}
                    </div>`;
                });

                // Zeige Gesamtwortziel
                if (result.data.total_word_target) {
                    html += `<p class="text-muted mt-3">
                        <i class="bi bi-file-text me-1"></i>Gesamt: ~${result.data.total_word_target} Wörter
                    </p>`;
                }

                document.getElementById('outlineEditor').innerHTML = html;
                document.getElementById('nextBtn').disabled = false;
            } else {
                alert(result.error || 'Fehler beim Generieren der Gliederung');
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        } finally {
            hideLoading();
            btn.disabled = false;
        }
    }
</script>
{% endblock %}
