{% extends "blogprep/base_wizard.html" %}

{% block wizard_content %}
<h2><i class="bi bi-search me-2"></i>Schritt 2: Recherche & Gliederung</h2>

<div class="alert alert-info mb-4">
    <strong>Keyword:</strong> {{ project.main_keyword }}
    {% if project.secondary_keywords %}
    | <strong>Sekundär:</strong> {{ project.secondary_keywords|join:", " }}
    {% endif %}
</div>

<!-- Research Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-globe me-2"></i>Web-Recherche</h5>
        <button type="button" class="btn btn-primary btn-sm" onclick="runResearch()" id="researchBtn">
            <i class="bi bi-play"></i> Recherche starten
        </button>
    </div>
    <div class="card-body" id="researchResults">
        {% if project.research_data %}
        <div class="research-data">
            {% if project.research_data.sources %}
            <div class="alert alert-success mb-3">
                <h6 class="mb-2"><i class="bi bi-check-circle me-2"></i>Analysierte Quellen (Top {{ project.research_data.sources|length }}):</h6>
                <ul class="mb-0 small">
                    {% for source in project.research_data.sources %}
                    <li><a href="{{ source.url }}" target="_blank" rel="noopener">{{ source.title|truncatechars:60 }}</a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="row">
                <div class="col-md-6">
                    {% if project.research_data.main_topics %}
                    <h6><i class="bi bi-tags me-1"></i>Hauptthemen:</h6>
                    <ul>
                        {% for topic in project.research_data.main_topics %}
                        <li>{{ topic }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if project.research_data.key_facts %}
                    <h6><i class="bi bi-lightbulb me-1"></i>Wichtige Fakten:</h6>
                    <ul>
                        {% for fact in project.research_data.key_facts %}
                        <li>{{ fact }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {% if project.research_data.user_questions %}
                    <h6><i class="bi bi-question-circle me-1"></i>Häufige Fragen:</h6>
                    <ul>
                        {% for question in project.research_data.user_questions %}
                        <li>{{ question }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if project.research_data.content_gaps %}
                    <h6><i class="bi bi-arrow-up-circle me-1"></i>Content-Lücken:</h6>
                    <ul class="small text-muted">
                        {% for gap in project.research_data.content_gaps %}
                        <li>{{ gap }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <p class="text-muted">
            <i class="bi bi-info-circle me-2"></i>
            Klicke auf "Recherche starten" um die <strong>Top-5 Suchergebnisse</strong> zu analysieren.
            Die KI liest die Inhalte der gefundenen Seiten und extrahiert relevante Informationen.
        </p>
        {% endif %}
    </div>
</div>

<!-- Internal Articles Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Interne Artikel</h5>
        <div>
            <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="checkBlogArticles()" id="syncBtn"
                    title="Vergleiche mit Shopify">
                <i class="bi bi-arrow-repeat"></i> Prüfen
            </button>
            <button type="button" class="btn btn-primary btn-sm" onclick="analyzeInternalArticles()" id="internalBtn"
                    {% if not project.research_data %}disabled{% endif %}>
                <i class="bi bi-search"></i> Analysieren
            </button>
        </div>
    </div>
    <div class="card-body" id="internalResults">
        <div id="syncInfo" class="mb-3" style="display: none;"></div>
        {% if project.research_data.internal_articles %}
        <div class="internal-data">
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle me-2"></i>
                <strong>{{ project.research_data.internal_articles_relevant }}</strong> von {{ project.research_data.internal_articles_analyzed }} Artikeln sind thematisch relevant.
            </div>

            {% for article in project.research_data.internal_articles %}
            <div class="internal-article mb-2 p-2 bg-light rounded border-start border-3 border-success">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>{{ article.title }}</strong>
                        <span class="badge bg-success ms-2">{{ article.relevance_score|floatformat:0|default:"0" }}%</span>
                    </div>
                    <small class="text-muted">{{ article.store_name }}</small>
                </div>
                <p class="mb-1 small text-muted">{{ article.relevance_reason }}</p>
                <div class="small">
                    <span class="text-primary">Ankertexte:</span>
                    {% for anchor in article.suggested_anchor_texts %}
                    <span class="badge bg-secondary me-1">{{ anchor }}</span>
                    {% endfor %}
                </div>
                <a href="{{ article.url }}" target="_blank" class="small text-muted">
                    <i class="bi bi-box-arrow-up-right"></i> {{ article.url|truncatechars:50 }}
                </a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">
            <i class="bi bi-info-circle me-2"></i>
            Klicke auf "Analysieren" um deine bestehenden Blog-Artikel zu durchsuchen.
            Relevante Artikel werden beim Content-Generieren automatisch verlinkt.
        </p>
        {% endif %}
    </div>
</div>

<!-- Outline Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-list-ol me-2"></i>Gliederung</h5>
        <button type="button" class="btn btn-primary btn-sm" onclick="generateOutline()" id="outlineBtn"
                {% if not project.research_data %}disabled{% endif %}>
            <i class="bi bi-magic"></i> Gliederung generieren
        </button>
    </div>
    <div class="card-body">
        <div id="outlineEditor">
            {% if project.outline %}
            {% for item in project.outline %}
            <div class="outline-item mb-3 p-3 bg-light rounded border-start border-4 border-primary">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong class="fs-5">{{ item.h2 }}</strong>
                        <span class="badge bg-secondary ms-2">{{ item.section }}</span>
                        <span class="badge bg-info ms-1">~{{ item.word_target }} Wörter</span>
                    </div>
                </div>
                {% if item.key_points %}
                <ul class="mt-2 mb-2">
                    {% for point in item.key_points %}
                    <li>{{ point }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% if item.research_reference %}
                <p class="mb-0 small text-muted fst-italic">
                    <i class="bi bi-link-45deg me-1"></i>Recherche-Bezug: {{ item.research_reference }}
                </p>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted" id="outlinePlaceholder">
                Führe zuerst die Recherche durch, dann generiere die Gliederung.
            </p>
            {% endif %}
        </div>
    </div>
</div>

<form method="post" id="step2Form">
    {% csrf_token %}
    <input type="hidden" name="outline" id="outlineData"
           value='{{ project.outline|safe|default:"[]" }}'>

    <div class="wizard-actions">
        <a href="{% url 'blogprep:wizard_step1_edit' project_id=project.id %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Zurück
        </a>
        <button type="submit" class="btn btn-primary" {% if not project.outline %}disabled{% endif %} id="nextBtn">
            Weiter zu Content <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</form>
{% endblock %}

{% block wizard_js %}
<script>
    let outlineData = {{ project.outline|safe|default:"[]" }};

    async function runResearch() {
        showLoading('Führe echte Web-Recherche durch... (analysiere Top-5 Suchergebnisse)');
        const btn = document.getElementById('researchBtn');
        btn.disabled = true;

        try {
            const result = await apiCall('{% url "blogprep:api_run_research" project_id=project.id %}');

            if (result.success && result.data) {
                // Update UI with research results
                let html = '<div class="research-data">';

                // Zeige analysierte Quellen
                if (result.data.sources && result.data.sources.length) {
                    html += `<div class="alert alert-success mb-3">
                        <h6 class="mb-2"><i class="bi bi-check-circle me-2"></i>Analysierte Quellen (Top ${result.data.sources.length}):</h6>
                        <ul class="mb-0 small">`;
                    result.data.sources.forEach(s => {
                        const title = s.title.length > 60 ? s.title.substring(0, 60) + '...' : s.title;
                        html += `<li><a href="${s.url}" target="_blank" rel="noopener">${title}</a></li>`;
                    });
                    html += '</ul></div>';
                }

                html += '<div class="row"><div class="col-md-6">';

                if (result.data.main_topics && result.data.main_topics.length) {
                    html += '<h6><i class="bi bi-tags me-1"></i>Hauptthemen:</h6><ul>';
                    result.data.main_topics.forEach(t => html += `<li>${t}</li>`);
                    html += '</ul>';
                }

                if (result.data.key_facts && result.data.key_facts.length) {
                    html += '<h6><i class="bi bi-lightbulb me-1"></i>Wichtige Fakten:</h6><ul>';
                    result.data.key_facts.forEach(f => html += `<li>${f}</li>`);
                    html += '</ul>';
                }

                html += '</div><div class="col-md-6">';

                if (result.data.user_questions && result.data.user_questions.length) {
                    html += '<h6><i class="bi bi-question-circle me-1"></i>Häufige Fragen:</h6><ul>';
                    result.data.user_questions.forEach(q => html += `<li>${q}</li>`);
                    html += '</ul>';
                }

                if (result.data.content_gaps && result.data.content_gaps.length) {
                    html += '<h6><i class="bi bi-arrow-up-circle me-1"></i>Content-Lücken:</h6><ul class="small text-muted">';
                    result.data.content_gaps.forEach(g => html += `<li>${g}</li>`);
                    html += '</ul>';
                }

                html += '</div></div></div>';
                document.getElementById('researchResults').innerHTML = html;

                // Enable outline button and internal articles button
                document.getElementById('outlineBtn').disabled = false;
                document.getElementById('internalBtn').disabled = false;
            } else {
                alert(result.error || 'Fehler bei der Recherche');
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        } finally {
            hideLoading();
            btn.disabled = false;
        }
    }

    async function generateOutline() {
        showLoading('Generiere ausführliche Blog-Gliederung basierend auf Recherche...');
        const btn = document.getElementById('outlineBtn');
        btn.disabled = true;

        try {
            const result = await apiCall('{% url "blogprep:api_generate_outline" project_id=project.id %}');

            if (result.success && result.data && result.data.outline) {
                outlineData = result.data.outline;
                document.getElementById('outlineData').value = JSON.stringify(outlineData);

                // Zeige unique_angle wenn vorhanden
                let html = '';
                if (result.data.unique_angle) {
                    html += `<div class="alert alert-success mb-3">
                        <i class="bi bi-star me-2"></i><strong>Unser Vorteil:</strong> ${result.data.unique_angle}
                    </div>`;
                }

                // Render outline
                outlineData.forEach(item => {
                    html += `
                    <div class="outline-item mb-3 p-3 bg-light rounded border-start border-4 border-primary">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="fs-5">${item.h2}</strong>
                                <span class="badge bg-secondary ms-2">${item.section}</span>
                                <span class="badge bg-info ms-1">~${item.word_target} Wörter</span>
                            </div>
                        </div>
                        ${item.key_points ? `
                        <ul class="mt-2 mb-2">
                            ${item.key_points.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                        ` : ''}
                        ${item.research_reference ? `
                        <p class="mb-0 small text-muted fst-italic">
                            <i class="bi bi-link-45deg me-1"></i>Recherche-Bezug: ${item.research_reference}
                        </p>
                        ` : ''}
                    </div>`;
                });

                // Zeige Gesamtwortziel
                if (result.data.total_word_target) {
                    html += `<p class="text-muted mt-3">
                        <i class="bi bi-file-text me-1"></i>Gesamt: ~${result.data.total_word_target} Wörter
                    </p>`;
                }

                document.getElementById('outlineEditor').innerHTML = html;
                document.getElementById('nextBtn').disabled = false;
            } else {
                alert(result.error || 'Fehler beim Generieren der Gliederung');
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        } finally {
            hideLoading();
            btn.disabled = false;
        }
    }

    async function analyzeInternalArticles() {
        showLoading('Analysiere interne Blog-Artikel...');
        const btn = document.getElementById('internalBtn');
        btn.disabled = true;

        try {
            const result = await apiCall('{% url "blogprep:api_analyze_internal_articles" project_id=project.id %}');

            if (result.success) {
                let html = '';

                // Sync-Info anzeigen
                if (result.sync_info) {
                    html += renderSyncInfo(result.sync_info);
                }

                html += '<div class="internal-data">';

                const relevant = result.internal_articles_relevant || 0;
                const total = result.internal_articles_analyzed || 0;

                html += `<div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>${relevant}</strong> von ${total} Artikeln sind thematisch relevant.
                </div>`;

                if (result.internal_articles && result.internal_articles.length > 0) {
                    result.internal_articles.forEach(article => {
                        const score = Math.round((article.relevance_score || 0) * 100);
                        const anchors = article.suggested_anchor_texts || [];

                        html += `
                        <div class="internal-article mb-2 p-2 bg-light rounded border-start border-3 border-success">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${article.title}</strong>
                                    <span class="badge bg-success ms-2">${score}%</span>
                                </div>
                                <small class="text-muted">${article.store_name || ''}</small>
                            </div>
                            <p class="mb-1 small text-muted">${article.relevance_reason || ''}</p>
                            <div class="small">
                                <span class="text-primary">Ankertexte:</span>
                                ${anchors.map(a => `<span class="badge bg-secondary me-1">${a}</span>`).join('')}
                            </div>
                            <a href="${article.url}" target="_blank" class="small text-muted">
                                <i class="bi bi-box-arrow-up-right"></i> ${article.url.substring(0, 50)}...
                            </a>
                        </div>`;
                    });
                } else {
                    html += '<p class="text-muted">Keine thematisch passenden Artikel gefunden.</p>';
                }

                html += '</div>';
                document.getElementById('internalResults').innerHTML = html;
            } else {
                alert(result.error || result.message || 'Fehler bei der Analyse');
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        } finally {
            hideLoading();
            btn.disabled = false;
        }
    }

    function renderSyncInfo(syncInfo) {
        if (!syncInfo || !syncInfo.last_sync) return '';

        const lastSync = new Date(syncInfo.last_sync);
        const formattedDate = lastSync.toLocaleDateString('de-DE', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });

        const alertClass = syncInfo.sync_warning ? 'alert-warning' : 'alert-secondary';
        const icon = syncInfo.sync_warning ? 'bi-exclamation-triangle' : 'bi-clock';

        let message = `<i class="bi ${icon} me-2"></i>`;
        message += `<strong>${syncInfo.total_count}</strong> Artikel in Datenbank`;
        message += ` (Stand: ${formattedDate})`;

        if (syncInfo.sync_warning) {
            message += `<br><small class="text-muted">Daten sind ${syncInfo.sync_age_days} Tage alt. Klicke "Aktualisieren" für aktuelle Daten.</small>`;
        }

        return `<div class="alert ${alertClass} py-2 mb-3">${message}</div>`;
    }

    async function checkBlogArticles() {
        showLoading('Prüfe Shopify-Datenbestand...');
        const btn = document.getElementById('syncBtn');
        btn.disabled = true;

        try {
            const result = await apiCall('{% url "blogprep:api_check_blog_articles" %}');

            if (result.success) {
                // Zeige Vergleichsergebnis
                let alertClass = 'alert-success';
                let icon = 'bi-check-circle';

                if (result.difference > 0) {
                    alertClass = 'alert-info';
                    icon = 'bi-plus-circle';
                } else if (result.difference < 0) {
                    alertClass = 'alert-warning';
                    icon = 'bi-exclamation-triangle';
                }

                let html = `<div class="alert ${alertClass} mb-3">
                    <i class="bi ${icon} me-2"></i>
                    <strong>Shopify:</strong> ${result.total_shopify} Artikel |
                    <strong>Lokal:</strong> ${result.total_local} Artikel
                    <br><small>${result.status_message}</small>`;

                if (result.difference !== 0) {
                    html += `<br><small class="text-muted mt-1 d-block">
                        → Für vollständigen Sync: <a href="/shopify/blogs/" target="_blank">Shopify Manager → Blogs</a>
                    </small>`;
                }

                html += '</div>';

                // Füge das Ergebnis oben in internalResults ein
                const syncInfoDiv = document.getElementById('syncInfo');
                if (syncInfoDiv) {
                    syncInfoDiv.innerHTML = html;
                    syncInfoDiv.style.display = 'block';
                }
            } else {
                alert(result.error || 'Fehler beim Prüfen');
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        } finally {
            hideLoading();
            btn.disabled = false;
        }
    }
</script>
{% endblock %}
