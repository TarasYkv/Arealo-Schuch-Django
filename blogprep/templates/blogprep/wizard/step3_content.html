{% extends "blogprep/base_wizard.html" %}

{% block wizard_content %}
<h2><i class="bi bi-pencil-square me-2"></i>Schritt 3: Content erstellen</h2>

<!-- Generation Progress -->
<div class="generation-progress mb-4" id="generationProgress" style="display: none;">
    <h6 class="mb-3">Generierungs-Fortschritt:</h6>
    <div class="generation-item" id="gen-intro" data-status="pending">
        <div class="status-icon"><i class="bi bi-circle"></i></div>
        <span>Einleitung (~300 Wörter)</span>
    </div>
    <div class="generation-item" id="gen-main" data-status="pending">
        <div class="status-icon"><i class="bi bi-circle"></i></div>
        <span>Hauptteil (~800 Wörter)</span>
    </div>
    <div class="generation-item" id="gen-tips" data-status="pending">
        <div class="status-icon"><i class="bi bi-circle"></i></div>
        <span>Do's & Don'ts (~300 Wörter)</span>
    </div>
    <div class="generation-item" id="gen-faqs" data-status="pending">
        <div class="status-icon"><i class="bi bi-circle"></i></div>
        <span>FAQs (7-10 Fragen)</span>
    </div>
    <div class="generation-item" id="gen-seo" data-status="pending">
        <div class="status-icon"><i class="bi bi-circle"></i></div>
        <span>SEO-Titel & Meta</span>
    </div>
</div>

<!-- Quick Generate All -->
<div class="mb-4">
    <button type="button" class="btn btn-success" onclick="generateAllContent()">
        <i class="bi bi-magic"></i> Alles automatisch generieren
    </button>
    <span class="text-muted ms-2">oder generiere einzelne Abschnitte unten</span>
</div>

<form method="post" id="contentForm">
    {% csrf_token %}

    <!-- SEO Meta -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-search me-2"></i>SEO-Daten</h5>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="generateSection('seo')">
                <i class="bi bi-magic"></i> Generieren
            </button>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">SEO-Titel <small class="text-muted">(max. 60 Zeichen)</small></label>
                        <input type="text" class="form-control" name="seo_title" id="seo_title"
                               value="{{ project.seo_title }}" maxlength="70">
                        <small class="text-muted"><span id="seoTitleCount">{{ project.seo_title|length|default:0 }}</span>/60</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Meta-Description <small class="text-muted">(max. 155 Zeichen)</small></label>
                        <input type="text" class="form-control" name="meta_description" id="meta_description"
                               value="{{ project.meta_description }}" maxlength="160">
                        <small class="text-muted"><span id="metaDescCount">{{ project.meta_description|length|default:0 }}</span>/155</small>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Zusammenfassung</label>
                <textarea class="form-control" name="summary" id="summary" rows="2">{{ project.summary }}</textarea>
            </div>
        </div>
    </div>

    <!-- Einleitung -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-bookmark me-2"></i>Einleitung (~300 Wörter)</h5>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="generateSection('intro')">
                <i class="bi bi-magic"></i> Generieren
            </button>
        </div>
        <div class="card-body">
            <textarea class="form-control content-editor" name="content_intro" id="content_intro"
                      rows="12">{{ project.content_intro }}</textarea>
            <small class="text-muted">Wörter: <span id="introWordCount">{{ project.content_intro|default:""|wordcount }}</span></small>
        </div>
    </div>

    <!-- Hauptteil -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-card-text me-2"></i>Hauptteil (~800 Wörter)</h5>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="generateSection('main')">
                <i class="bi bi-magic"></i> Generieren
            </button>
        </div>
        <div class="card-body">
            <textarea class="form-control content-editor" name="content_main" id="content_main"
                      rows="12">{{ project.content_main }}</textarea>
            <small class="text-muted">Wörter: <span id="mainWordCount">{{ project.content_main|default:""|wordcount }}</span></small>
        </div>
    </div>

    <!-- Tipps -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Do's & Don'ts (~300 Wörter)</h5>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="generateSection('tips')">
                <i class="bi bi-magic"></i> Generieren
            </button>
        </div>
        <div class="card-body">
            <textarea class="form-control content-editor" name="content_tips" id="content_tips"
                      rows="12">{{ project.content_tips }}</textarea>
            <small class="text-muted">Wörter: <span id="tipsWordCount">{{ project.content_tips|default:""|wordcount }}</span></small>
        </div>
    </div>

    <!-- FAQs -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i>FAQs</h5>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="generateSection('faqs')">
                <i class="bi bi-magic"></i> Generieren
            </button>
        </div>
        <div class="card-body" id="faqsContainer">
            {% if project.faqs %}
            {% for faq in project.faqs %}
            <div class="faq-item mb-3 p-3 bg-light rounded">
                <div class="form-group mb-2">
                    <label class="form-label small">Frage {{ forloop.counter }}</label>
                    <input type="text" class="form-control faq-question" value="{{ faq.question }}">
                </div>
                <div class="form-group mb-0">
                    <label class="form-label small">Antwort</label>
                    <textarea class="form-control faq-answer" rows="2">{{ faq.answer }}</textarea>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted">Klicke auf "Generieren" um FAQs zu erstellen.</p>
            {% endif %}
        </div>
    </div>

    <input type="hidden" name="faqs" id="faqsData" value='{{ project.faqs|safe|default:"[]" }}'>

    <!-- SEO-Analyse -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>SEO-Analyse</h5>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="runSeoAnalysis()" id="seoAnalyzeBtn">
                <i class="bi bi-search"></i> Analysieren
            </button>
        </div>
        <div class="card-body" id="seoAnalysisContainer">
            {% if project.seo_analysis and project.seo_analysis.success %}
            <!-- Ergebnis anzeigen falls vorhanden -->
            <div class="seo-results">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="h4 me-2">Gesamt-Score: {{ project.seo_analysis.overall_score }}/100</span>
                        {% if project.seo_analysis.overall_score >= 80 %}
                        <span class="badge bg-success">Gut</span>
                        {% elif project.seo_analysis.overall_score >= 60 %}
                        <span class="badge bg-warning">Verbesserbar</span>
                        {% else %}
                        <span class="badge bg-danger">Optimieren</span>
                        {% endif %}
                    </div>
                    <small class="text-muted">Zuletzt analysiert</small>
                </div>
                <p class="text-muted">Klicke auf "Analysieren" um eine neue Analyse durchzuführen.</p>
            </div>
            {% else %}
            <p class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Führe eine SEO-Analyse durch, um deinen Content zu optimieren.
                Die Analyse prüft Keyword-Dichte, Bild-SEO, Outbound-Links und mehr.
            </p>
            {% endif %}
            <div id="seoAnalysisResults" style="display: none;"></div>
        </div>
    </div>

    <style>
        .seo-check-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .seo-check-item:last-child {
            border-bottom: none;
        }
        .seo-check-status {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1rem;
        }
        .seo-check-status.good { background: #dcfce7; color: #16a34a; }
        .seo-check-status.warning { background: #fef3c7; color: #d97706; }
        .seo-check-status.bad { background: #fee2e2; color: #dc2626; }
        .seo-check-content {
            flex: 1;
        }
        .seo-check-title {
            font-weight: 600;
            color: #1e293b;
        }
        .seo-check-desc {
            font-size: 0.85rem;
            color: #64748b;
        }
        .seo-check-score {
            font-weight: 700;
            font-size: 1.1rem;
            width: 50px;
            text-align: right;
        }
        .seo-recommendations {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        .seo-recommendations h6 {
            color: #1e293b;
            margin-bottom: 0.75rem;
        }
        .seo-recommendations ul {
            margin: 0;
            padding-left: 1.25rem;
        }
        .seo-recommendations li {
            color: #475569;
            margin-bottom: 0.5rem;
        }
        .seo-overall-score {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 1rem;
            margin-bottom: 1.5rem;
        }
        .seo-overall-score .score-value {
            font-size: 3rem;
            font-weight: 700;
        }
        .seo-overall-score.good .score-value { color: #16a34a; }
        .seo-overall-score.warning .score-value { color: #d97706; }
        .seo-overall-score.bad .score-value { color: #dc2626; }
    </style>

    <!-- Update-Reminder Einstellung (projektspezifisch) -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Update-Erinnerung</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <label class="form-label" for="custom_update_days">Nach wie vielen Tagen aktualisieren?</label>
                    <input type="number" class="form-control" id="custom_update_days" name="custom_update_days"
                           value="{{ project.custom_update_days|default:'' }}"
                           placeholder="Leer = aus Einstellungen"
                           min="30" max="1095">
                </div>
                <div class="col-md-8">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Leer lassen = Globale Einstellungen verwenden
                        (Warnung: {{ settings.update_reminder_warning_days|default:270 }} Tage, Kritisch: {{ settings.update_reminder_critical_days|default:365 }} Tage).
                        <br>
                        Wert eingeben = Dieser Artikel wird nach X Tagen als aktualisierungsbedürftig markiert.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="wizard-actions">
        <a href="{% url 'blogprep:wizard_step2' project_id=project.id %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Zurück
        </a>
        <button type="submit" class="btn btn-primary">
            Weiter zu Bilder <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</form>
{% endblock %}

{% block wizard_js %}
<script>
    let faqsData = {{ project.faqs|safe|default:"[]" }};

    // Character counters
    document.getElementById('seo_title').addEventListener('input', function() {
        document.getElementById('seoTitleCount').textContent = this.value.length;
    });
    document.getElementById('meta_description').addEventListener('input', function() {
        document.getElementById('metaDescCount').textContent = this.value.length;
    });

    // Word counters
    function updateWordCount(elementId, counterId) {
        const text = document.getElementById(elementId).value;
        const count = text.trim() ? text.trim().split(/\s+/).length : 0;
        document.getElementById(counterId).textContent = count;
    }

    document.getElementById('content_intro').addEventListener('input', () => updateWordCount('content_intro', 'introWordCount'));
    document.getElementById('content_main').addEventListener('input', () => updateWordCount('content_main', 'mainWordCount'));
    document.getElementById('content_tips').addEventListener('input', () => updateWordCount('content_tips', 'tipsWordCount'));

    function updateGenerationStatus(section, status) {
        const item = document.getElementById(`gen-${section}`);
        if (!item) return;

        item.dataset.status = status;
        item.className = `generation-item ${status}`;

        const icon = item.querySelector('.status-icon i');
        if (status === 'running') {
            icon.className = 'bi bi-arrow-repeat';
        } else if (status === 'completed') {
            icon.className = 'bi bi-check';
        } else if (status === 'error') {
            icon.className = 'bi bi-x';
        } else {
            icon.className = 'bi bi-circle';
        }
    }

    async function generateSection(section) {
        const progressDiv = document.getElementById('generationProgress');
        progressDiv.style.display = 'block';

        updateGenerationStatus(section, 'running');

        try {
            let result;
            if (section === 'faqs') {
                result = await apiCall('{% url "blogprep:api_generate_faqs" project_id=project.id %}');
                if (result.success && result.faqs) {
                    faqsData = result.faqs;
                    renderFaqs();
                }
            } else if (section === 'seo') {
                result = await apiCall('{% url "blogprep:api_generate_seo_meta" project_id=project.id %}');
                if (result.success && result.data) {
                    document.getElementById('seo_title').value = result.data.title || '';
                    document.getElementById('meta_description').value = result.data.description || '';
                    document.getElementById('summary').value = result.data.summary || '';
                    document.getElementById('seoTitleCount').textContent = (result.data.title || '').length;
                    document.getElementById('metaDescCount').textContent = (result.data.description || '').length;
                }
            } else {
                result = await apiCall('{% url "blogprep:api_generate_content" project_id=project.id %}', {
                    section_type: section
                });
                if (result.success && result.content) {
                    document.getElementById(`content_${section}`).value = result.content;
                    updateWordCount(`content_${section}`, `${section}WordCount`);
                }
            }

            if (result.success) {
                updateGenerationStatus(section, 'completed');
            } else {
                updateGenerationStatus(section, 'error');
                alert(result.error || 'Fehler bei der Generierung');
            }
        } catch (error) {
            updateGenerationStatus(section, 'error');
            alert('Fehler: ' + error.message);
        }
    }

    async function generateAllContent() {
        const sections = ['intro', 'main', 'tips', 'faqs', 'seo'];
        const progressDiv = document.getElementById('generationProgress');
        progressDiv.style.display = 'block';

        for (const section of sections) {
            await generateSection(section);
            // Small delay between generations
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }

    function renderFaqs() {
        const container = document.getElementById('faqsContainer');
        if (!faqsData || faqsData.length === 0) {
            container.innerHTML = '<p class="text-muted">Keine FAQs generiert.</p>';
            return;
        }

        let html = '';
        faqsData.forEach((faq, index) => {
            html += `
            <div class="faq-item mb-3 p-3 bg-light rounded">
                <div class="form-group mb-2">
                    <label class="form-label small">Frage ${index + 1}</label>
                    <input type="text" class="form-control faq-question" value="${faq.question}" onchange="updateFaq(${index}, 'question', this.value)">
                </div>
                <div class="form-group mb-0">
                    <label class="form-label small">Antwort</label>
                    <textarea class="form-control faq-answer" rows="2" onchange="updateFaq(${index}, 'answer', this.value)">${faq.answer}</textarea>
                </div>
            </div>`;
        });

        container.innerHTML = html;
        document.getElementById('faqsData').value = JSON.stringify(faqsData);
    }

    function updateFaq(index, field, value) {
        if (faqsData[index]) {
            faqsData[index][field] = value;
            document.getElementById('faqsData').value = JSON.stringify(faqsData);
        }
    }

    // Save FAQs before form submit
    document.getElementById('contentForm').addEventListener('submit', function() {
        // Collect FAQs from form
        const questions = document.querySelectorAll('.faq-question');
        const answers = document.querySelectorAll('.faq-answer');
        const faqs = [];

        questions.forEach((q, i) => {
            if (q.value && answers[i] && answers[i].value) {
                faqs.push({
                    question: q.value,
                    answer: answers[i].value
                });
            }
        });

        document.getElementById('faqsData').value = JSON.stringify(faqs);
    });

    // SEO Analysis
    async function runSeoAnalysis() {
        const btn = document.getElementById('seoAnalyzeBtn');
        const resultsDiv = document.getElementById('seoAnalysisResults');
        const container = document.getElementById('seoAnalysisContainer');

        // Check if content exists
        const intro = document.getElementById('content_intro').value;
        const main = document.getElementById('content_main').value;
        if (!intro && !main) {
            alert('Bitte erst Content generieren, bevor du die SEO-Analyse durchführst.');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Analysiere...';
        showLoading('SEO-Analyse wird durchgeführt...');

        try {
            const result = await apiCall('{% url "blogprep:api_seo_analysis" project_id=project.id %}');
            hideLoading();

            if (result.success) {
                renderSeoResults(result, resultsDiv);
                resultsDiv.style.display = 'block';

                // Hide the initial text
                const initialText = container.querySelector('p.text-muted');
                if (initialText) initialText.style.display = 'none';
                const existingResults = container.querySelector('.seo-results');
                if (existingResults) existingResults.style.display = 'none';
            } else {
                alert(result.error || 'Fehler bei der SEO-Analyse');
            }
        } catch (error) {
            hideLoading();
            alert('Fehler: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-search"></i> Analysieren';
        }
    }

    function renderSeoResults(data, container) {
        const results = data.results;
        const overallScore = data.overall_score;

        // Score class
        let scoreClass = 'bad';
        if (overallScore >= 80) scoreClass = 'good';
        else if (overallScore >= 60) scoreClass = 'warning';

        // Check configurations
        const checks = [
            {
                key: 'keyword_density',
                title: 'Keyword-Dichte',
                getDesc: (r) => {
                    if (r.main_keyword) {
                        return `${r.main_keyword.keyword}: ${r.main_keyword.count}x (${r.main_keyword.percentage}%)`;
                    }
                    return r.message || 'Analyse durchgeführt';
                }
            },
            {
                key: 'image_seo',
                title: 'Bild-SEO',
                getDesc: (r) => {
                    if (r.total_images > 0) {
                        return `${r.with_keyword}/${r.total_images} Bilder mit Keyword im Alt-Text`;
                    }
                    return r.message || 'Keine Bilder vorhanden';
                }
            },
            {
                key: 'outbound_links',
                title: 'Externe Links',
                getDesc: (r) => `${r.current_count} externe Links vorhanden`
            },
            {
                key: 'content_gaps',
                title: 'Content-Vollständigkeit',
                getDesc: (r) => {
                    const missing = r.missing_topics?.length || 0;
                    return missing > 0 ? `${missing} fehlende Themen identifiziert` : 'Alle wichtigen Themen abgedeckt';
                }
            },
            {
                key: 'duplicate_check',
                title: 'Einzigartigkeit',
                getDesc: (r) => {
                    if (r.similar_articles?.length > 0) {
                        return `${r.similar_articles.length} ähnliche Artikel gefunden`;
                    }
                    return 'Content ist einzigartig';
                }
            },
            {
                key: 'cannibalization',
                title: 'Keyword-Kannibalisierung',
                getDesc: (r) => {
                    if (r.conflicts?.length > 0) {
                        return `${r.conflicts.length} Konflikte gefunden`;
                    }
                    return 'Keine Konflikte';
                }
            },
            {
                key: 'update_reminders',
                title: 'Alte Artikel',
                getDesc: (r) => {
                    if (r.outdated_articles?.length > 0) {
                        return `${r.outdated_articles.length} Artikel sollten aktualisiert werden`;
                    }
                    return 'Keine veralteten Artikel';
                }
            }
        ];

        let html = `
            <div class="seo-overall-score ${scoreClass}">
                <div class="score-value">${overallScore}</div>
                <div class="text-muted">von 100 Punkten</div>
            </div>

            <div class="seo-checks">
        `;

        checks.forEach(check => {
            const result = results[check.key];
            if (!result) return;

            const score = result.score || 0;
            let statusClass = 'bad';
            let icon = 'x-lg';
            if (score >= 80) {
                statusClass = 'good';
                icon = 'check-lg';
            } else if (score >= 60) {
                statusClass = 'warning';
                icon = 'exclamation-lg';
            }

            html += `
                <div class="seo-check-item">
                    <div class="seo-check-status ${statusClass}">
                        <i class="bi bi-${icon}"></i>
                    </div>
                    <div class="seo-check-content">
                        <div class="seo-check-title">${check.title}</div>
                        <div class="seo-check-desc">${check.getDesc(result)}</div>
                    </div>
                    <div class="seo-check-score" style="color: ${score >= 80 ? '#16a34a' : score >= 60 ? '#d97706' : '#dc2626'}">
                        ${score}
                    </div>
                </div>
            `;
        });

        html += '</div>';

        // Recommendations
        if (data.top_recommendations && data.top_recommendations.length > 0) {
            html += `
                <div class="seo-recommendations">
                    <h6><i class="bi bi-lightbulb me-2"></i>Empfehlungen</h6>
                    <ul>
                        ${data.top_recommendations.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        container.innerHTML = html;
    }
</script>
{% endblock %}
