{% extends "blogprep/base_wizard.html" %}

{% block wizard_content %}
<h2><i class="bi bi-key me-2"></i>Schritt 1: Keywords eingeben</h2>

<!-- Duplicate Warning Modal -->
<div id="duplicateModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
            <h3>Keyword bereits verwendet</h3>
        </div>
        <div class="modal-body">
            <p id="duplicateMessage"></p>
            <div id="duplicateList" class="duplicate-list"></div>
        </div>
        <div class="modal-actions" id="duplicateModalActions">
            <!-- Buttons werden dynamisch eingefügt -->
        </div>
    </div>
</div>

<!-- Auto Create Progress Modal -->
<div id="autoCreateModal" class="modal-overlay" style="display: none;">
    <div class="modal-content auto-create-modal">
        <div class="modal-header">
            <i class="bi bi-gear-wide-connected spinning" id="autoCreateIcon"></i>
            <h3 id="autoCreateTitle">Auto Create wird gestartet...</h3>
        </div>
        <div class="modal-body">
            <div class="auto-create-progress">
                <div class="auto-create-progress-fill" id="autoCreateProgressBar"></div>
            </div>
            <div class="auto-create-steps" id="autoCreateSteps">
                <!-- Dynamisch generiert -->
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="autoCreateCancelBtn" onclick="cancelAutoCreate()">
                <i class="bi bi-x-lg"></i> Abbrechen
            </button>
        </div>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1001;
    }
    .modal-content {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }
    .modal-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    .modal-header h3 {
        margin-top: 0.5rem;
        color: #1e293b;
    }
    .modal-body {
        margin-bottom: 1.5rem;
    }
    .modal-body p {
        color: #64748b;
        margin-bottom: 1rem;
    }
    .duplicate-list {
        background: #f8fafc;
        border-radius: 0.5rem;
        padding: 1rem;
        max-height: 200px;
        overflow-y: auto;
    }
    .duplicate-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e2e8f0;
    }
    .duplicate-item:last-child {
        border-bottom: none;
    }
    .duplicate-item .keyword {
        font-weight: 600;
        color: #1e293b;
    }
    .duplicate-item .date {
        font-size: 0.85rem;
        color: #94a3b8;
    }
    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }
    .text-warning {
        color: #f59e0b;
    }

    /* Auto Create Modal */
    .auto-create-modal {
        max-width: 600px;
        width: 95%;
    }
    .auto-create-modal .modal-header {
        margin-bottom: 1.5rem;
    }
    .auto-create-modal .modal-header i {
        font-size: 2.5rem;
        color: #6366f1;
    }
    .auto-create-modal .modal-header h3 {
        margin-top: 0.75rem;
        color: #1e293b;
    }
    .auto-create-progress {
        background: #e2e8f0;
        border-radius: 1rem;
        height: 12px;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }
    .auto-create-progress-fill {
        background: linear-gradient(90deg, #6366f1, #8b5cf6);
        height: 100%;
        border-radius: 1rem;
        transition: width 0.3s ease;
        width: 0%;
    }
    .auto-create-steps {
        max-height: 350px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }
    .auto-create-step {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.6rem 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 0.25rem;
        transition: background 0.2s;
    }
    .auto-create-step.pending {
        color: #94a3b8;
    }
    .auto-create-step.running {
        background: #f0f9ff;
        color: #0369a1;
    }
    .auto-create-step.completed {
        color: #059669;
    }
    .auto-create-step.error {
        background: #fef2f2;
        color: #dc2626;
    }
    .auto-create-step .step-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        flex-shrink: 0;
    }
    .auto-create-step.pending .step-icon {
        background: #e2e8f0;
        color: #64748b;
    }
    .auto-create-step.running .step-icon {
        background: #dbeafe;
        color: #2563eb;
    }
    .auto-create-step.completed .step-icon {
        background: #d1fae5;
        color: #059669;
    }
    .auto-create-step.error .step-icon {
        background: #fee2e2;
        color: #dc2626;
    }
    .auto-create-step .step-name {
        flex: 1;
        font-size: 0.9rem;
    }
    .auto-create-step .step-time {
        font-size: 0.8rem;
        color: #94a3b8;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .spinning {
        animation: spin 2s linear infinite;
    }
    .btn-auto-create {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
    }
    .btn-auto-create:hover {
        background: linear-gradient(135deg, #059669, #047857);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
</style>

<form method="post" id="keywordsForm">
    {% csrf_token %}

    <div class="form-group">
        <label class="form-label" for="main_keyword">
            Hauptkeyword
        </label>
        <input type="text"
               class="form-control"
               id="main_keyword"
               name="main_keyword"
               value="{{ project.main_keyword|default:'' }}"
               placeholder="z.B. was kann man zur Geburt schenken"
               required>
        <p class="form-help">
            Das Hauptkeyword, auf das der Blog optimiert werden soll.
        </p>
    </div>

    <div class="form-group">
        <label class="form-label" for="secondary_keywords">
            Sekundäre Keywords <span class="optional">(optional)</span>
        </label>
        <div class="d-flex gap-2 mb-2">
            <textarea class="form-control"
                      id="secondary_keywords"
                      name="secondary_keywords"
                      rows="4"
                      placeholder="Geschenkideen zur Geburt&#10;persönliche Geschenke Baby&#10;originelle Geschenke Geburt">{% if project.secondary_keywords %}{% for kw in project.secondary_keywords %}{{ kw }}{% if not forloop.last %}
{% endif %}{% endfor %}{% endif %}</textarea>
        </div>
        <button type="button" class="btn btn-outline btn-sm" onclick="suggestKeywords()">
            <i class="bi bi-lightbulb"></i> Keywords vorschlagen
        </button>
        <p class="form-help">
            Ein Keyword pro Zeile. Diese Keywords werden in den Blog integriert.
        </p>
    </div>

    <div class="wizard-actions">
        <a href="{% url 'blogprep:project_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Abbrechen
        </a>
        <div style="display: flex; gap: 0.75rem;">
            <button type="button" class="btn btn-auto-create" onclick="startAutoCreate()">
                <i class="bi bi-magic"></i> Auto Create
            </button>
            <button type="submit" class="btn btn-primary">
                Weiter zu Recherche <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block wizard_js %}
<script>
    let skipDuplicateCheck = false;

    // Form Submit Handler
    document.getElementById('keywordsForm').addEventListener('submit', async function(e) {
        // Wenn bereits bestätigt, direkt absenden
        if (skipDuplicateCheck) {
            return true;
        }

        e.preventDefault();

        const mainKeyword = document.getElementById('main_keyword').value.trim();
        if (!mainKeyword) {
            alert('Bitte gib ein Hauptkeyword ein.');
            return;
        }

        showLoading('Prüfe Keyword...');

        try {
            const params = { main_keyword: mainKeyword };
            {% if project %}
            params.project_id = '{{ project.id }}';
            {% endif %}
            const result = await apiCall('{% url "blogprep:api_check_duplicate_keyword" %}', params);

            hideLoading();

            if (result.success && result.is_duplicate) {
                // Zeige Warnung mit passenden Optionen
                showDuplicateModal(result.duplicates, result.message, result.has_open_projects, result.open_project_id);
            } else {
                // Kein Duplikat - direkt absenden
                skipDuplicateCheck = true;
                document.getElementById('keywordsForm').submit();
            }
        } catch (error) {
            hideLoading();
            // Bei Fehler trotzdem fortfahren
            skipDuplicateCheck = true;
            document.getElementById('keywordsForm').submit();
        }
    });

    // Speichert die ID des offenen Projekts für Weiterleitung
    let currentOpenProjectId = null;

    function showDuplicateModal(duplicates, message, hasOpenProjects, openProjectId) {
        document.getElementById('duplicateMessage').textContent = message;
        currentOpenProjectId = openProjectId;

        const listContainer = document.getElementById('duplicateList');
        listContainer.innerHTML = duplicates.map(dup => `
            <div class="duplicate-item">
                <span class="keyword">${dup.title || dup.main_keyword}</span>
                <span class="date">${dup.created_at} - ${dup.status_display || dup.status}</span>
            </div>
        `).join('');

        // Generiere Buttons basierend auf Situation
        const actionsContainer = document.getElementById('duplicateModalActions');

        if (hasOpenProjects && openProjectId) {
            // Es gibt ein offenes Projekt → Primär: Zum bestehenden Projekt
            actionsContainer.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="closeDuplicateModal()">
                    <i class="bi bi-x-lg"></i> Abbrechen
                </button>
                <button type="button" class="btn btn-outline-warning" onclick="proceedAnyway()">
                    <i class="bi bi-plus-lg"></i> Neues erstellen
                </button>
                <button type="button" class="btn btn-primary" onclick="goToExistingProject()">
                    <i class="bi bi-arrow-right"></i> Zum bestehenden Projekt
                </button>
            `;
        } else {
            // Nur exportierte Projekte → Warnung, aber "Trotzdem erstellen" erlauben
            actionsContainer.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="closeDuplicateModal()">
                    <i class="bi bi-x-lg"></i> Abbrechen
                </button>
                <button type="button" class="btn btn-primary" onclick="proceedAnyway()">
                    <i class="bi bi-check-lg"></i> Trotzdem erstellen
                </button>
            `;
        }

        document.getElementById('duplicateModal').style.display = 'flex';
    }

    function closeDuplicateModal() {
        document.getElementById('duplicateModal').style.display = 'none';
        currentOpenProjectId = null;
    }

    function proceedAnyway() {
        closeDuplicateModal();
        skipDuplicateCheck = true;
        document.getElementById('keywordsForm').submit();
    }

    function goToExistingProject() {
        if (currentOpenProjectId) {
            // Weiterleitung zum bestehenden Projekt (Step 1 mit project_id in URL)
            window.location.href = '/blogprep/wizard/step1/' + currentOpenProjectId + '/';
        }
        closeDuplicateModal();
    }

    async function suggestKeywords() {
        const mainKeyword = document.getElementById('main_keyword').value;
        if (!mainKeyword) {
            alert('Bitte gib zuerst ein Hauptkeyword ein.');
            return;
        }

        showLoading('Generiere Keyword-Vorschläge...');

        try {
            const result = await apiCall('{% url "blogprep:api_suggest_keywords" %}', {
                main_keyword: mainKeyword
            });

            if (result.success && result.keywords) {
                const textarea = document.getElementById('secondary_keywords');
                const existing = textarea.value.trim();
                const newKeywords = result.keywords.join('\n');

                if (existing) {
                    textarea.value = existing + '\n' + newKeywords;
                } else {
                    textarea.value = newKeywords;
                }
            } else {
                alert(result.error || 'Fehler beim Generieren der Keywords');
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // ========================================================================
    // Auto Create Functionality
    // ========================================================================

    // Schritte für Auto Create (Diagramm JA, Video NEIN)
    const AUTO_CREATE_STEPS = [
        { id: 'project', name: 'Projekt erstellen' },
        { id: 'research', name: 'Web-Recherche durchführen' },
        { id: 'outline', name: 'Gliederung generieren' },
        { id: 'internal', name: 'Interne Artikel analysieren' },
        { id: 'intro', name: 'Content: Einleitung' },
        { id: 'main', name: 'Content: Hauptteil' },
        { id: 'tips', name: 'Content: Tipps & Tricks' },
        { id: 'faqs', name: 'FAQs generieren' },
        { id: 'seo', name: 'SEO-Meta generieren' },
        { id: 'title_image', name: 'Titelbild generieren' },
        { id: 'section_intro', name: 'Bild: Einleitung' },
        { id: 'section_main', name: 'Bild: Hauptteil' },
        { id: 'section_tips', name: 'Bild: Tipps' },
        { id: 'diagram_analyze', name: 'Diagramm analysieren' },
        { id: 'diagram_image', name: 'Diagramm generieren' },
        { id: 'finalize', name: 'Abschließen' }
    ];

    let autoCreateCancelled = false;
    let currentProjectId = null;

    function showAutoCreateModal() {
        const stepsHtml = AUTO_CREATE_STEPS.map(step => `
            <div class="auto-create-step pending" id="step-${step.id}">
                <div class="step-icon"><i class="bi bi-circle"></i></div>
                <span class="step-name">${step.name}</span>
                <span class="step-time" id="time-${step.id}"></span>
            </div>
        `).join('');

        document.getElementById('autoCreateSteps').innerHTML = stepsHtml;
        document.getElementById('autoCreateProgressBar').style.width = '0%';
        document.getElementById('autoCreateTitle').textContent = 'Auto Create wird gestartet...';
        document.getElementById('autoCreateIcon').className = 'bi bi-gear-wide-connected spinning';
        document.getElementById('autoCreateCancelBtn').style.display = 'inline-flex';
        document.getElementById('autoCreateModal').style.display = 'flex';
    }

    function updateStepStatus(stepId, status, duration = null) {
        const stepEl = document.getElementById(`step-${stepId}`);
        if (!stepEl) return;

        stepEl.className = `auto-create-step ${status}`;

        const iconEl = stepEl.querySelector('.step-icon i');
        if (status === 'running') {
            iconEl.className = 'bi bi-arrow-repeat spinning';
        } else if (status === 'completed') {
            iconEl.className = 'bi bi-check-lg';
        } else if (status === 'error') {
            iconEl.className = 'bi bi-x-lg';
        }

        if (duration !== null) {
            document.getElementById(`time-${stepId}`).textContent = `${duration.toFixed(1)}s`;
        }

        // Scroll to current step
        stepEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function updateProgress(currentStep, totalSteps) {
        const percentage = Math.round((currentStep / totalSteps) * 100);
        document.getElementById('autoCreateProgressBar').style.width = `${percentage}%`;
    }

    async function startAutoCreate() {
        const mainKeyword = document.getElementById('main_keyword').value.trim();
        if (!mainKeyword) {
            alert('Bitte gib ein Hauptkeyword ein.');
            return;
        }

        const secondaryKeywords = document.getElementById('secondary_keywords').value;

        autoCreateCancelled = false;
        currentProjectId = null;
        showAutoCreateModal();

        let completedSteps = 0;
        const totalSteps = AUTO_CREATE_STEPS.length;

        try {
            // ================================================================
            // Step 1: Projekt erstellen
            // ================================================================
            updateStepStatus('project', 'running');
            let startTime = Date.now();

            const initParams = {
                main_keyword: mainKeyword,
                secondary_keywords: secondaryKeywords
            };
            {% if project %}
            // Wenn wir in einem bestehenden Projekt sind, verwende dieses statt ein neues zu erstellen
            initParams.project_id = '{{ project.id }}';
            {% endif %}
            const initResult = await apiCall('{% url "blogprep:api_auto_create_init" %}', initParams);

            if (!initResult.success) {
                throw new Error(initResult.error || 'Projekt konnte nicht erstellt werden');
            }

            currentProjectId = initResult.project_id;
            updateStepStatus('project', 'completed', (Date.now() - startTime) / 1000);
            completedSteps++;
            updateProgress(completedSteps, totalSteps);

            if (autoCreateCancelled) throw new Error('Abgebrochen');

            // ================================================================
            // Step 2: Web-Recherche
            // ================================================================
            updateStepStatus('research', 'running');
            document.getElementById('autoCreateTitle').textContent = 'Recherche läuft...';
            startTime = Date.now();

            const researchResult = await apiCall(`/blogprep/api/research/${currentProjectId}/`, {});
            if (!researchResult.success) {
                console.warn('Research warning:', researchResult.error);
            }
            updateStepStatus('research', 'completed', (Date.now() - startTime) / 1000);
            completedSteps++;
            updateProgress(completedSteps, totalSteps);

            if (autoCreateCancelled) throw new Error('Abgebrochen');

            // ================================================================
            // Step 3: Gliederung
            // ================================================================
            updateStepStatus('outline', 'running');
            startTime = Date.now();

            const outlineResult = await apiCall(`/blogprep/api/outline/${currentProjectId}/`, {});
            if (!outlineResult.success) {
                console.warn('Outline warning:', outlineResult.error);
            }
            updateStepStatus('outline', 'completed', (Date.now() - startTime) / 1000);
            completedSteps++;
            updateProgress(completedSteps, totalSteps);

            if (autoCreateCancelled) throw new Error('Abgebrochen');

            // ================================================================
            // Step 4: Interne Artikel
            // ================================================================
            updateStepStatus('internal', 'running');
            startTime = Date.now();

            const internalResult = await apiCall(`/blogprep/api/internal-articles/${currentProjectId}/`, {});
            if (!internalResult.success) {
                console.warn('Internal articles warning:', internalResult.error);
            }
            updateStepStatus('internal', 'completed', (Date.now() - startTime) / 1000);
            completedSteps++;
            updateProgress(completedSteps, totalSteps);

            if (autoCreateCancelled) throw new Error('Abgebrochen');

            // ================================================================
            // Step 5-7: Content generieren (intro, main, tips)
            // ================================================================
            document.getElementById('autoCreateTitle').textContent = 'Content wird generiert...';

            for (const section of ['intro', 'main', 'tips']) {
                updateStepStatus(section, 'running');
                startTime = Date.now();

                const contentResult = await apiCall(`/blogprep/api/content/${currentProjectId}/`, {
                    section_type: section
                });
                if (!contentResult.success) {
                    console.warn(`Content ${section} warning:`, contentResult.error);
                }
                updateStepStatus(section, 'completed', (Date.now() - startTime) / 1000);
                completedSteps++;
                updateProgress(completedSteps, totalSteps);

                if (autoCreateCancelled) throw new Error('Abgebrochen');
            }

            // ================================================================
            // Step 8: FAQs
            // ================================================================
            updateStepStatus('faqs', 'running');
            startTime = Date.now();

            const faqsResult = await apiCall(`/blogprep/api/faqs/${currentProjectId}/`, {});
            if (!faqsResult.success) {
                console.warn('FAQs warning:', faqsResult.error);
            }
            updateStepStatus('faqs', 'completed', (Date.now() - startTime) / 1000);
            completedSteps++;
            updateProgress(completedSteps, totalSteps);

            if (autoCreateCancelled) throw new Error('Abgebrochen');

            // ================================================================
            // Step 9: SEO Meta
            // ================================================================
            updateStepStatus('seo', 'running');
            startTime = Date.now();

            const seoResult = await apiCall(`/blogprep/api/seo-meta/${currentProjectId}/`, {});
            if (!seoResult.success) {
                console.warn('SEO warning:', seoResult.error);
            }
            updateStepStatus('seo', 'completed', (Date.now() - startTime) / 1000);
            completedSteps++;
            updateProgress(completedSteps, totalSteps);

            if (autoCreateCancelled) throw new Error('Abgebrochen');

            // ================================================================
            // Step 10: Titelbild
            // ================================================================
            document.getElementById('autoCreateTitle').textContent = 'Bilder werden generiert...';
            updateStepStatus('title_image', 'running');
            startTime = Date.now();

            const titleImageResult = await apiCall(`/blogprep/api/title-image/${currentProjectId}/`, {});
            if (!titleImageResult.success) {
                console.warn('Title image warning:', titleImageResult.error);
            }
            updateStepStatus('title_image', 'completed', (Date.now() - startTime) / 1000);
            completedSteps++;
            updateProgress(completedSteps, totalSteps);

            if (autoCreateCancelled) throw new Error('Abgebrochen');

            // ================================================================
            // Step 11-13: Abschnittsbilder (intro, main, tips)
            // ================================================================
            // Zuerst Bildvorschläge generieren
            const suggestResult = await apiCall(`/blogprep/api/suggest-section-images/${currentProjectId}/`, {});
            const suggestions = suggestResult.success ? suggestResult.suggestions : {};

            for (const section of ['intro', 'main', 'tips']) {
                updateStepStatus(`section_${section}`, 'running');
                startTime = Date.now();

                const sectionText = suggestions[section] || `Illustration für ${section} Abschnitt`;
                const sectionImageResult = await apiCall(`/blogprep/api/section-image/${currentProjectId}/`, {
                    section_text: sectionText,
                    section_name: section
                });
                if (!sectionImageResult.success) {
                    console.warn(`Section image ${section} warning:`, sectionImageResult.error);
                }
                updateStepStatus(`section_${section}`, 'completed', (Date.now() - startTime) / 1000);
                completedSteps++;
                updateProgress(completedSteps, totalSteps);

                if (autoCreateCancelled) throw new Error('Abgebrochen');
            }

            // ================================================================
            // Step 14: Diagramm analysieren
            // ================================================================
            document.getElementById('autoCreateTitle').textContent = 'Diagramm wird erstellt...';
            updateStepStatus('diagram_analyze', 'running');
            startTime = Date.now();

            const diagramAnalyzeResult = await apiCall(`/blogprep/api/diagram-analyze/${currentProjectId}/`, {});
            if (!diagramAnalyzeResult.success) {
                console.warn('Diagram analyze warning:', diagramAnalyzeResult.error);
            }
            updateStepStatus('diagram_analyze', 'completed', (Date.now() - startTime) / 1000);
            completedSteps++;
            updateProgress(completedSteps, totalSteps);

            if (autoCreateCancelled) throw new Error('Abgebrochen');

            // ================================================================
            // Step 15: Diagramm generieren
            // ================================================================
            updateStepStatus('diagram_image', 'running');
            startTime = Date.now();

            const diagramImageResult = await apiCall(`/blogprep/api/diagram-image/${currentProjectId}/`, {});
            if (!diagramImageResult.success) {
                console.warn('Diagram image warning:', diagramImageResult.error);
            }
            updateStepStatus('diagram_image', 'completed', (Date.now() - startTime) / 1000);
            completedSteps++;
            updateProgress(completedSteps, totalSteps);

            if (autoCreateCancelled) throw new Error('Abgebrochen');

            // ================================================================
            // Step 16: Finalisieren
            // ================================================================
            document.getElementById('autoCreateTitle').textContent = 'Wird abgeschlossen...';
            updateStepStatus('finalize', 'running');
            startTime = Date.now();

            const finalizeResult = await apiCall(`/blogprep/api/auto-create/finalize/${currentProjectId}/`, {});
            if (!finalizeResult.success) {
                throw new Error(finalizeResult.error || 'Finalisierung fehlgeschlagen');
            }
            updateStepStatus('finalize', 'completed', (Date.now() - startTime) / 1000);
            completedSteps++;
            updateProgress(completedSteps, totalSteps);

            // ================================================================
            // Erfolg! Weiterleitung zu Step 7
            // ================================================================
            document.getElementById('autoCreateTitle').textContent = 'Auto Create abgeschlossen!';
            document.getElementById('autoCreateIcon').className = 'bi bi-check-circle-fill';
            document.getElementById('autoCreateIcon').style.color = '#059669';
            document.getElementById('autoCreateCancelBtn').style.display = 'none';

            // Kurze Pause, dann Weiterleitung
            setTimeout(() => {
                window.location.href = `/blogprep/wizard/step7/${currentProjectId}/`;
            }, 1500);

        } catch (error) {
            if (error.message === 'Abgebrochen') {
                document.getElementById('autoCreateTitle').textContent = 'Auto Create abgebrochen';
                document.getElementById('autoCreateIcon').className = 'bi bi-x-circle-fill';
                document.getElementById('autoCreateIcon').style.color = '#dc2626';
            } else {
                document.getElementById('autoCreateTitle').textContent = 'Fehler aufgetreten';
                document.getElementById('autoCreateIcon').className = 'bi bi-exclamation-circle-fill';
                document.getElementById('autoCreateIcon').style.color = '#dc2626';
                console.error('Auto Create error:', error);
                alert('Fehler: ' + error.message);
            }
        }
    }

    function cancelAutoCreate() {
        autoCreateCancelled = true;
        document.getElementById('autoCreateModal').style.display = 'none';
    }
</script>
{% endblock %}
