{% extends "blogprep/base_wizard.html" %}

{% with steps="1:Keywords,2:Recherche,3:Content,4:Bilder,5:Diagramm,6:Video,7:Export"|make_list %}
{% endwith %}

{% block wizard_content %}
<h2><i class="bi bi-key me-2"></i>Schritt 1: Keywords eingeben</h2>

<form method="post" id="keywordsForm">
    {% csrf_token %}

    <div class="form-group">
        <label class="form-label" for="main_keyword">
            Hauptkeyword
        </label>
        <input type="text"
               class="form-control"
               id="main_keyword"
               name="main_keyword"
               value="{{ project.main_keyword|default:'' }}"
               placeholder="z.B. was kann man zur Geburt schenken"
               required>
        <p class="form-help">
            Das Hauptkeyword, auf das der Blog optimiert werden soll.
        </p>
    </div>

    <div class="form-group">
        <label class="form-label" for="secondary_keywords">
            Sekundäre Keywords <span class="optional">(optional)</span>
        </label>
        <div class="d-flex gap-2 mb-2">
            <textarea class="form-control"
                      id="secondary_keywords"
                      name="secondary_keywords"
                      rows="4"
                      placeholder="Geschenkideen zur Geburt&#10;persönliche Geschenke Baby&#10;originelle Geschenke Geburt">{% if project.secondary_keywords %}{% for kw in project.secondary_keywords %}{{ kw }}{% if not forloop.last %}
{% endif %}{% endfor %}{% endif %}</textarea>
        </div>
        <button type="button" class="btn btn-outline btn-sm" onclick="suggestKeywords()">
            <i class="bi bi-lightbulb"></i> Keywords vorschlagen
        </button>
        <p class="form-help">
            Ein Keyword pro Zeile. Diese Keywords werden in den Blog integriert.
        </p>
    </div>

    <div class="wizard-actions">
        <a href="{% url 'blogprep:project_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Abbrechen
        </a>
        <button type="submit" class="btn btn-primary">
            Weiter zu Recherche <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</form>
{% endblock %}

{% block wizard_js %}
<script>
    async function suggestKeywords() {
        const mainKeyword = document.getElementById('main_keyword').value;
        if (!mainKeyword) {
            alert('Bitte gib zuerst ein Hauptkeyword ein.');
            return;
        }

        showLoading('Generiere Keyword-Vorschläge...');

        try {
            const result = await apiCall('{% url "blogprep:api_suggest_keywords" %}', {
                main_keyword: mainKeyword
            });

            if (result.success && result.keywords) {
                const textarea = document.getElementById('secondary_keywords');
                const existing = textarea.value.trim();
                const newKeywords = result.keywords.join('\n');

                if (existing) {
                    textarea.value = existing + '\n' + newKeywords;
                } else {
                    textarea.value = newKeywords;
                }
            } else {
                alert(result.error || 'Fehler beim Generieren der Keywords');
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        } finally {
            hideLoading();
        }
    }
</script>
{% endblock %}
