{% extends "somi_plan/base.html" %}
{% load static %}
{% load math_filters %}

{% block page_title %}{{ plan.title }}{% endblock %}
{% block page_description %}{{ plan.platform.name }} ‚Ä¢ {{ posts.count }} Posts ‚Ä¢ {{ plan.get_status_display }}{% endblock %}

{% block header_actions %}
<div class="btn-group">
    <a href="{% url 'somi_plan:plan_edit' plan.pk %}" class="btn btn-outline-light">
        <i class="fas fa-edit me-2"></i>Bearbeiten
    </a>
    <a href="{% url 'somi_plan:calendar' %}" class="btn btn-light">
        <i class="fas fa-calendar me-2"></i>Kalender
    </a>
</div>
{% endblock %}

{% block main_content %}
<!-- Plan Overview -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <i class="{{ plan.platform.icon }} fa-3x me-3" style="color: {{ plan.platform.color }};"></i>
                    <div class="flex-grow-1">
                        <h4 class="mb-1">{{ plan.title }}</h4>
                        <p class="text-muted mb-0">{{ plan.description|default:"Keine Beschreibung vorhanden" }}</p>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-{% if plan.status == 'active' %}success{% elif plan.status == 'draft' %}secondary{% elif plan.status == 'completed' %}primary{% else %}warning{% endif %} fs-6">
                            {{ plan.get_status_display }}
                        </span>
                    </div>
                </div>
                
                {% if plan.description %}
                <div class="card-text mb-3">
                    <div class="plan-description" style="line-height: 1.5;">
                        {{ plan.description|linebreaks }}
                    </div>
                </div>
                {% endif %}
                
                <div class="row text-center">
                    <div class="col-3">
                        <div class="p-2">
                            <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                            <div class="h5 mb-0">{{ posts.count }}</div>
                            <small class="text-muted">Posts</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="p-2">
                            <i class="fas fa-calendar fa-2x text-info mb-2"></i>
                            <div class="h5 mb-0">{{ plan.get_scheduled_posts_count }}</div>
                            <small class="text-muted">Geplant</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="p-2">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <div class="h5 mb-0">0</div>
                            <small class="text-muted">Erledigt</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="p-2">
                            <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                            <div class="h5 mb-0">--</div>
                            <small class="text-muted">Reichweite</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>Plan-Einstellungen
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label small text-muted">Plattform</label>
                    <div class="d-flex align-items-center">
                        <i class="{{ plan.platform.icon }} me-2" style="color: {{ plan.platform.color }};"></i>
                        <span>{{ plan.platform.name }}</span>
                        <small class="text-muted ms-auto">{{ plan.platform.character_limit }} Zeichen</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small text-muted">Erstellt</label>
                    <div>{{ plan.created_at|date:"d.m.Y H:i" }}</div>
                </div>
                
                {% if plan.strategy_data %}
                <div class="mb-3">
                    <label class="form-label small text-muted">Posting-H√§ufigkeit</label>
                    <div>
                        {% if plan.strategy_data.posting_frequency == 'daily' %}T√§glich
                        {% elif plan.strategy_data.posting_frequency == 'every_other_day' %}Jeden 2. Tag
                        {% elif plan.strategy_data.posting_frequency == '3_times_week' %}3x pro Woche
                        {% elif plan.strategy_data.posting_frequency == '2_times_week' %}2x pro Woche
                        {% elif plan.strategy_data.posting_frequency == 'weekly' %}W√∂chentlich
                        {% else %}{{ plan.strategy_data.posting_frequency }}{% endif %}
                    </div>
                </div>
                {% endif %}
                
                <div class="d-grid gap-2">
                    {% if plan.status == 'draft' %}
                    <a href="{% url 'somi_plan:create_plan_step2' plan.id %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-play me-1"></i>Weiter bearbeiten
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'somi_plan:plan_edit' plan.pk %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-edit me-1"></i>Plan bearbeiten
                    </a>
                    
                    <button class="btn btn-outline-info btn-sm" onclick="exportPlan()">
                        <i class="fas fa-download me-1"></i>Exportieren
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Strategy Overview -->
{% if plan.strategy_data %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-chart-pie me-2"></i>Content-Strategie
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% if plan.strategy_data.content_types %}
            <div class="col-md-6">
                <h6>Content-Typen</h6>
                <div class="mb-3">
                    {% for content_type in plan.strategy_data.content_types %}
                    <span class="badge bg-primary me-1 mb-1">
                        {% if content_type == 'tips' %}Tipps & Tricks
                        {% elif content_type == 'behind_scenes' %}Behind the Scenes  
                        {% elif content_type == 'product' %}Produktvorstellungen
                        {% elif content_type == 'educational' %}Bildungsinhalte
                        {% elif content_type == 'motivational' %}Motivierende Posts
                        {% elif content_type == 'testimonials' %}Kundenstimmen
                        {% elif content_type == 'news' %}News & Updates
                        {% elif content_type == 'questions' %}Fragen an Community
                        {% else %}{{ content_type }}{% endif %}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if plan.strategy_data.best_times %}
            <div class="col-md-6">
                <h6>Beste Posting-Zeiten</h6>
                <div class="mb-3">
                    {% for time in plan.strategy_data.best_times %}
                    <span class="badge bg-info me-1 mb-1">
                        {% if time == 'morning' %}Morgens (6-9 Uhr)
                        {% elif time == 'midday' %}Mittags (11-14 Uhr)
                        {% elif time == 'afternoon' %}Nachmittags (15-17 Uhr)
                        {% elif time == 'evening' %}Abends (18-21 Uhr)
                        {% elif time == 'night' %}Nachts (21-23 Uhr)
                        {% else %}{{ time }}{% endif %}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        {% if plan.strategy_data.additional_notes %}
        <div class="mt-3">
            <h6><i class="fas fa-sticky-note me-2"></i>Zus√§tzliche Anmerkungen</h6>
            <div class="bg-light p-3 rounded border">
                <div class="strategy-notes" style="line-height: 1.5;">
                    {{ plan.strategy_data.additional_notes|linebreaks }}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Posts Section -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-layer-group me-2"></i>Content Posts ({{ posts.count }})
        </h5>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="generateMorePosts()">
                <i class="fas fa-magic me-1"></i>Mehr Ideen
            </button>
            <a href="{% url 'somi_plan:post_create' plan.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-plus me-1"></i>Manuell hinzuf√ºgen
            </a>
        </div>
    </div>
    <div class="card-body">
        {% if posts %}
        <div class="row">
            {% for post in posts %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 post-card {% if post.post_type == 'story' %}story{% else %}individual{% endif %}" onclick="showPostModal({{ post.id }})">
                    {% if post.story_position %}
                    <div class="story-order-badge">
                        <span class="badge bg-success">
                            <i class="fas fa-list-ol me-1"></i>{{ post.story_position }}
                        </span>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">{{ post.title|truncatechars:40 }}</h6>
                            <div class="post-badges">
                                {% if post.post_type == 'story' %}
                                <span class="badge bg-gradient-success me-1" title="Story-Serie">
                                    <i class="fas fa-stream"></i>
                                </span>
                                {% endif %}
                                {% if post.ai_generated %}
                                <span class="badge bg-gradient-primary">
                                    <i class="fas fa-robot"></i>
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <p class="card-text small text-muted">{{ post.content|truncatechars:80|linebreaks }}</p>
                        
                        {% if post.hashtags %}
                        <div class="mb-2">
                            {% for hashtag in post.hashtags|split:" "|slice:":3" %}
                            <span class="badge bg-light text-dark">{{ hashtag }}</span>
                            {% endfor %}
                            {% if post.hashtags|split:" "|length > 3 %}
                            <span class="text-muted small">+{{ post.hashtags|split:" "|length|add:"-3" }} mehr</span>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-font me-1"></i>
                                <span class="{% if post.get_character_limit_percentage > 100 %}text-danger{% elif post.get_character_limit_percentage > 80 %}text-warning{% endif %}">
                                    {{ post.character_count }}/{{ post.posting_plan.platform.character_limit }}
                                </span>
                            </small>
                            
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" 
                                        onclick="event.stopPropagation(); quickCopy({{ post.id }})" 
                                        title="Post kopieren">
                                    <i class="fas fa-copy"></i>
                                </button>
                                {% if post.schedule %}
                                <button class="btn btn-success" disabled>
                                    <i class="fas fa-calendar me-1"></i>{{ post.schedule.scheduled_date|date:"d.m." }}
                                </button>
                                {% else %}
                                <button class="btn btn-outline-primary" onclick="event.stopPropagation(); schedulePost({{ post.id }})">
                                    <i class="fas fa-calendar me-1"></i>Planen
                                </button>
                                {% endif %}
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-no-caret" 
                                            type="button" 
                                            data-bs-toggle="dropdown" 
                                            onclick="event.stopPropagation();"
                                            title="Weitere Aktionen">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="event.stopPropagation(); editPost({{ post.id }})">
                                                <i class="fas fa-edit me-2 text-primary"></i>Bearbeiten
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="event.stopPropagation(); duplicatePost({{ post.id }})">
                                                <i class="fas fa-copy me-2 text-info"></i>Duplizieren
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" onclick="event.stopPropagation(); deletePost({{ post.id }}, '{{ post.title|escapejs }}')">
                                                <i class="fas fa-trash me-2"></i>L√∂schen
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
            <h6 class="text-muted">Noch keine Posts erstellt</h6>
            <p class="text-muted">Erstelle Posts automatisch mit KI oder f√ºge sie manuell hinzu.</p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="generateMorePosts()">
                    <i class="fas fa-magic me-2"></i>Posts mit KI erstellen
                </button>
                <a href="{% url 'somi_plan:post_create' plan.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-plus me-2"></i>Manuell hinzuf√ºgen
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Post Detail Modal -->
<div class="modal fade" id="postModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="postModalTitle">Post Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="postModalBody">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                <button type="button" class="btn btn-outline-primary" id="editPostBtn">
                    <i class="fas fa-edit me-1"></i>Bearbeiten
                </button>
                <button type="button" class="btn btn-primary" id="schedulePostBtn">
                    <i class="fas fa-calendar me-1"></i>Terminieren
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
// Add functions to global scope - ensure they're available
window.showPostModal = function(postId) {
    console.log('showPostModal called with postId:', postId);
    
    // Mock post data - in real implementation, this would fetch from API
    const posts = {
        {% for post in posts %}
        {{ post.id }}: {
            title: `{{ post.title|escapejs }}`,
            content: `{{ post.content|escapejs }}`,
            script: `{{ post.script|escapejs }}`,
            hashtags: `{{ post.hashtags|escapejs }}`,
            call_to_action: `{{ post.call_to_action|escapejs }}`,
            character_count: {{ post.character_count }},
            character_limit: {{ post.posting_plan.platform.character_limit }}
        },
        {% endfor %}
    };
    
    const post = posts[postId];
    if (!post) return;
    
    document.getElementById('postModalTitle').textContent = post.title;
    
    const percentage = (post.character_count / post.character_limit) * 100;
    let characterClass = '';
    if (percentage > 100) characterClass = 'text-danger';
    else if (percentage > 80) characterClass = 'text-warning';
    
    // Format content with proper line breaks and structure
    const formatContent = (text) => {
        if (!text) return '';
        return text
            .replace(/\n\n/g, '</p><p>')        // Double line breaks become paragraph breaks
            .replace(/\n/g, '<br>')             // Single line breaks become <br>
            .replace(/^/, '<p>')                // Start with paragraph
            .replace(/$/, '</p>')               // End with paragraph
            .replace(/<p><\/p>/g, '')           // Remove empty paragraphs
            .replace(/\*\*(.*?)\*\*/g, '<strong class="fw-bold text-dark">$1</strong>')  // Bold text **text**
            .replace(/\*(.*?)\*/g, '<em class="fst-italic text-secondary">$1</em>')      // Italic text *text*
            .replace(/#(\w+)/g, '<span class="text-primary fw-bold">#$1</span>')         // Hashtags
            .replace(/(@\w+)/g, '<span class="text-info fw-bold">$1</span>')             // Mentions
            .replace(/(\b(?:https?|ftp):\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-decoration-none text-primary">$1</a>') // URLs
            .replace(/(\d+\.)/g, '<span class="text-primary fw-bold me-1">$1</span>')    // Numbered lists
            .replace(/(-\s)/g, '<span class="text-primary fw-bold me-1">‚Ä¢</span> ')      // Bullet points
            .replace(/(üëâ|‚û°Ô∏è|üî•|üí°|‚≠ê|‚ú®)/g, '<span class="fs-5 me-1">$1</span>');      // Emojis with spacing
    };
    
    const formatScript = (text) => {
        if (!text) return '';
        return text
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>')
            .replace(/^/, '<p>')
            .replace(/$/, '</p>')
            .replace(/<p><\/p>/g, '')
            .replace(/\*\*(.*?)\*\*/g, '<strong class="fw-bold text-dark">$1</strong>')
            .replace(/\*(.*?)\*/g, '<em class="fst-italic">$1</em>')
            .replace(/(\d+\.|\-|\‚Ä¢)/g, '<span class="text-primary fw-bold me-2">$1</span>') // Numbers and bullets
            .replace(/(Schritt \d+|Phase \d+|Teil \d+|Aktion \d+)/gi, '<span class="badge bg-info text-dark me-1 mb-1">$1</span>') // Steps/phases
            .replace(/(Wichtig:|Hinweis:|Tipp:|Achtung:|Beachte:|Info:)/gi, '<span class="badge bg-warning text-dark me-1 mb-1">$1</span>') // Important notes
            .replace(/(\[.*?\])/g, '<span class="text-success fw-bold">$1</span>') // Brackets for actions
            .replace(/(".*?")/g, '<span class="text-muted fst-italic">$1</span>') // Quoted text
            .replace(/(TODO:|DONE:|NEXT:)/gi, '<span class="badge bg-secondary me-1 mb-1">$1</span>'); // Task markers
    };

    document.getElementById('postModalBody').innerHTML = `
        <div class="mb-3">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-file-alt me-2"></i>Content</span>
                <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('${post.content.replace(/'/g, "\\'")}', 'content')">
                    <i class="fas fa-copy me-1"></i>Kopieren
                </button>
            </h6>
            <div class="bg-light p-3 rounded border">
                <div class="content-formatted" style="line-height: 1.6; font-size: 0.95rem;">
                    ${formatContent(post.content)}
                </div>
            </div>
            <small class="text-muted mt-1 d-block">
                <i class="fas fa-font me-1"></i>
                <span class="${characterClass}">${post.character_count}/${post.character_limit} Zeichen</span>
            </small>
        </div>
        
        ${post.script ? `
        <div class="mb-3">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-script me-2"></i>Umsetzungs-Skript</span>
                <button class="btn btn-sm btn-outline-info" onclick="copyToClipboard('${post.script.replace(/'/g, "\\'")}', 'script')">
                    <i class="fas fa-copy me-1"></i>Kopieren
                </button>
            </h6>
            <div class="bg-info bg-opacity-10 p-3 rounded border border-info">
                <div class="script-formatted" style="line-height: 1.5; font-size: 0.9rem;">
                    ${formatScript(post.script)}
                </div>
            </div>
        </div>
        ` : ''}
        
        ${post.hashtags ? `
        <div class="mb-3">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-hashtag me-2"></i>Hashtags</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${post.hashtags}', 'hashtags')">
                    <i class="fas fa-copy me-1"></i>Kopieren
                </button>
            </h6>
            <div>
                ${post.hashtags.split(' ').filter(tag => tag).map(tag => 
                    `<span class="badge bg-primary me-1">${tag}</span>`
                ).join('')}
            </div>
        </div>
        ` : ''}
        
        ${post.call_to_action ? `
        <div class="mb-3">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-bullhorn me-2"></i>Call-to-Action</span>
                <button class="btn btn-sm btn-outline-warning" onclick="copyToClipboard('${post.call_to_action.replace(/'/g, "\\'")}', 'cta')">
                    <i class="fas fa-copy me-1"></i>Kopieren
                </button>
            </h6>
            <div class="bg-warning bg-opacity-10 p-2 rounded">
                <strong>${post.call_to_action}</strong>
            </div>
        </div>
        ` : ''}
        
        <!-- Quick Copy Section -->
        <div class="mt-4 p-3 bg-light rounded">
            <h6 class="mb-3"><i class="fas fa-magic me-2"></i>Schnell-Kopiervorlagen f√ºr {{ plan.platform.name }}</h6>
            <div class="row g-2">
                <div class="col-12">
                    <button class="btn btn-sm btn-outline-dark w-100" onclick="copyCompletePost(${postId})">
                        <i class="fas fa-copy me-1"></i>Kompletter Post (Content + Hashtags + CTA)
                    </button>
                </div>
                ${post.hashtags || post.call_to_action ? `
                <div class="col-md-6">
                    <button class="btn btn-sm btn-outline-secondary w-100" onclick="copyContentWithHashtags(${postId})">
                        <i class="fas fa-copy me-1"></i>Content + Hashtags
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-sm btn-outline-secondary w-100" onclick="copyContentWithCTA(${postId})">
                        <i class="fas fa-copy me-1"></i>Content + Call-to-Action
                    </button>
                </div>
                ` : ''}
            </div>
        </div>
    `;
    
    // Set button actions
    document.getElementById('editPostBtn').onclick = () => editPost(postId);
    document.getElementById('schedulePostBtn').onclick = () => schedulePost(postId);
    
    // Show modal - check if Bootstrap is loaded
    if (typeof bootstrap !== 'undefined') {
        new bootstrap.Modal(document.getElementById('postModal')).show();
    } else {
        console.error('Bootstrap is not loaded!');
        // Fallback: show modal manually
        const modal = document.getElementById('postModal');
        if (modal) {
            modal.classList.add('show');
            modal.style.display = 'block';
            document.body.classList.add('modal-open');
        }
    }
};

window.generateMorePosts = async function() {
    // Show beautiful confirmation modal instead of ugly confirm()
    showGenerateIdeasModal();
}

function showGenerateIdeasModal() {
    const modalHTML = `
        <div class="modal fade" id="generateIdeasModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header border-0 bg-gradient-primary text-white">
                        <h5 class="modal-title d-flex align-items-center">
                            <i class="fas fa-magic me-2"></i>
                            Neue Post-Ideen generieren
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="text-center mb-3">
                            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                <i class="fas fa-lightbulb fa-2x text-primary"></i>
                            </div>
                        </div>
                        <h6 class="text-center mb-3">KI-gest√ºtzte Content-Erstellung</h6>
                        <p class="text-muted text-center mb-4">
                            M√∂chtest du weitere kreative Post-Ideen f√ºr deinen Plan generieren lassen? 
                            Die KI wird basierend auf deiner aktuellen Strategie neue, passende Inhalte vorschlagen.
                        </p>
                        <div class="bg-light p-3 rounded mb-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <i class="fas fa-robot text-primary mb-1"></i>
                                    <small class="d-block text-muted">KI-generiert</small>
                                </div>
                                <div class="col-4">
                                    <i class="fas fa-target text-success mb-1"></i>
                                    <small class="d-block text-muted">Zielgruppen-optimiert</small>
                                </div>
                                <div class="col-4">
                                    <i class="fas fa-heart text-danger mb-1"></i>
                                    <small class="d-block text-muted">Engagement-fokussiert</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 px-4 pb-4">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Abbrechen
                        </button>
                        <button type="button" class="btn btn-primary" onclick="executeGenerateIdeas()" id="confirmGenerateBtn">
                            <i class="fas fa-magic me-1"></i>Ideen generieren
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('generateIdeasModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('generateIdeasModal'));
    modal.show();
    
    // Clean up after modal is hidden
    document.getElementById('generateIdeasModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

async function executeGenerateIdeas() {
    const btn = document.getElementById('confirmGenerateBtn');
    const originalBtnContent = btn.innerHTML;
    
    // Update button to show loading
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generiere Ideen...';
    
    try {
        const response = await fetch(`{% url 'somi_plan:generate_more_ideas' plan.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // Update modal to show success
            btn.innerHTML = '<i class="fas fa-check me-1"></i>Erfolgreich generiert!';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            
            // Hide modal after short delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('generateIdeasModal')).hide();
                
                // Show success message
                showSuccessAlert(result.message);
                
                // Reload to show new posts
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }, 1000);
            
        } else {
            // Show error in modal
            btn.disabled = false;
            btn.innerHTML = originalBtnContent;
            showErrorInModal(`Fehler: ${result.message}`);
        }
        
    } catch (error) {
        btn.disabled = false;
        btn.innerHTML = originalBtnContent;
        console.error('Error generating posts:', error);
        showErrorInModal('Netzwerkfehler beim Generieren neuer Posts. Bitte versuche es sp√§ter erneut.');
    }
}

function showErrorInModal(message) {
    const modalBody = document.querySelector('#generateIdeasModal .modal-body');
    const errorAlert = `
        <div class="alert alert-danger d-flex align-items-center" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
    modalBody.insertAdjacentHTML('beforeend', errorAlert);
}

function showSuccessAlert(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-magic me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert alert at top of page
    const mainContent = document.querySelector('.col-lg-8, .col-12');
    if (mainContent) {
        mainContent.insertBefore(alert, mainContent.firstChild);
    }
}

window.editPost = function(postId) {
    // Close modal and redirect to edit page
    bootstrap.Modal.getInstance(document.getElementById('postModal')).hide();
    window.location.href = "{% url 'somi_plan:post_edit' 0 %}".replace('0', postId);
}

window.schedulePost = function(postId) {
    // Close modal if open
    const modal = bootstrap.Modal.getInstance(document.getElementById('postModal'));
    if (modal) modal.hide();
    
    // Redirect to scheduling page using Django URL
    window.location.href = "{% url 'somi_plan:schedule_post' 0 %}".replace('0', postId);
};

window.exportPlan = function() {
    alert('Export-Funktion wird in Phase 5 implementiert');
};

// Copy to clipboard functionality
window.copyToClipboard = function(text, type) {
    // Clean text for proper copying
    const cleanText = text
        .replace(/\\n/g, '\n')
        .replace(/\\'/g, "'")
        .replace(/\\"/g, '"');
    
    navigator.clipboard.writeText(cleanText).then(() => {
        showCopyNotification(type);
    }).catch(err => {
        console.error('Copy failed:', err);
        // Fallback for older browsers
        const textArea = document.createElement("textarea");
        textArea.value = cleanText;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showCopyNotification(type);
        } catch (err) {
            alert('Kopieren fehlgeschlagen. Bitte manuell kopieren.');
        }
        document.body.removeChild(textArea);
    });
};

window.showCopyNotification = function(type) {
    const messages = {
        content: 'Content kopiert!',
        script: 'Skript kopiert!',
        hashtags: 'Hashtags kopiert!',
        cta: 'Call-to-Action kopiert!',
        complete: 'Kompletter Post kopiert!',
        contentHashtags: 'Content + Hashtags kopiert!',
        contentCTA: 'Content + Call-to-Action kopiert!'
    };
    
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 end-0 p-3';
    toast.style.zIndex = '11';
    toast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">${messages[type] || 'Kopiert!'}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                Der Text wurde in die Zwischenablage kopiert.
            </div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
};

// Get post data helper
window.getPostData = function(postId) {
    const posts = {
        {% for post in posts %}
        {{ post.id }}: {
            title: `{{ post.title|escapejs }}`,
            content: `{{ post.content|escapejs }}`,
            script: `{{ post.script|escapejs }}`,
            hashtags: `{{ post.hashtags|escapejs }}`,
            call_to_action: `{{ post.call_to_action|escapejs }}`,
            character_count: {{ post.character_count }},
            character_limit: {{ post.posting_plan.platform.character_limit }}
        },
        {% endfor %}
    };
    return posts[postId];
};

window.copyCompletePost = function(postId) {
    const post = getPostData(postId);
    let completeText = post.content;
    
    if (post.call_to_action) {
        completeText += '\n\n' + post.call_to_action;
    }
    
    if (post.hashtags) {
        completeText += '\n\n' + post.hashtags;
    }
    
    copyToClipboard(completeText, 'complete');
};

window.copyContentWithHashtags = function(postId) {
    const post = getPostData(postId);
    let text = post.content;
    
    if (post.hashtags) {
        text += '\n\n' + post.hashtags;
    }
    
    copyToClipboard(text, 'contentHashtags');
};

window.copyContentWithCTA = function(postId) {
    const post = getPostData(postId);
    let text = post.content;
    
    if (post.call_to_action) {
        text += '\n\n' + post.call_to_action;
    }
    
    copyToClipboard(text, 'contentCTA');
};

window.quickCopy = function(postId) {
    const post = getPostData(postId);
    let text = post.content;
    
    // Add CTA if exists
    if (post.call_to_action) {
        text += '\n\n' + post.call_to_action;
    }
    
    // Add hashtags if exists
    if (post.hashtags) {
        text += '\n\n' + post.hashtags;
    }
    
    copyToClipboard(text, 'complete');
};

// Delete Post Function
window.deletePost = function(postId, postTitle) {
    showDeleteConfirmationModal(postId, postTitle);
};

function showDeleteConfirmationModal(postId, postTitle) {
    const modalHTML = `
        <div class="modal fade" id="deletePostModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header border-0 bg-danger text-white">
                        <h5 class="modal-title d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Post l√∂schen
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="text-center mb-3">
                            <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                <i class="fas fa-trash fa-2x text-danger"></i>
                            </div>
                        </div>
                        <h6 class="text-center mb-3">Post endg√ºltig l√∂schen?</h6>
                        <p class="text-muted text-center mb-4">
                            M√∂chtest du den Post <strong>"${postTitle}"</strong> wirklich l√∂schen? 
                            Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.
                        </p>
                        <div class="bg-light p-3 rounded mb-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <i class="fas fa-file-alt text-danger mb-1"></i>
                                    <small class="d-block text-muted">Content verloren</small>
                                </div>
                                <div class="col-4">
                                    <i class="fas fa-calendar text-warning mb-1"></i>
                                    <small class="d-block text-muted">Termine entfernt</small>
                                </div>
                                <div class="col-4">
                                    <i class="fas fa-undo text-muted mb-1"></i>
                                    <small class="d-block text-muted">Nicht wiederherstellbar</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 px-4 pb-4">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Abbrechen
                        </button>
                        <button type="button" class="btn btn-danger" onclick="executeDeletePost(${postId})" id="confirmDeleteBtn">
                            <i class="fas fa-trash me-1"></i>Endg√ºltig l√∂schen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('deletePostModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deletePostModal'));
    modal.show();
    
    // Clean up after modal is hidden
    document.getElementById('deletePostModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

async function executeDeletePost(postId) {
    const btn = document.getElementById('confirmDeleteBtn');
    const originalBtnContent = btn.innerHTML;
    
    // Update button to show loading
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>L√∂sche...';
    
    try {
        const response = await fetch(`/somi-plan/post/${postId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // Update modal to show success
            btn.innerHTML = '<i class="fas fa-check me-1"></i>Gel√∂scht!';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-success');
            
            // Hide modal after short delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('deletePostModal')).hide();
                
                // Remove post card from DOM
                const postCard = document.querySelector(\`[onclick*="showPostModal(\${postId})"]\`);
                if (postCard) {
                    const cardContainer = postCard.closest('.col-md-6');
                    if (cardContainer) {
                        cardContainer.style.transition = 'all 0.3s ease';
                        cardContainer.style.opacity = '0';
                        cardContainer.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            cardContainer.remove();
                            // Check if no posts left
                            const remainingPosts = document.querySelectorAll('.post-card').length;
                            if (remainingPosts === 0) {
                                location.reload(); // Reload to show empty state
                            }
                        }, 300);
                    }
                }
                
                // Show success message
                showSuccessAlert(result.message || 'Post wurde erfolgreich gel√∂scht.');
            }, 1000);
            
        } else {
            // Show error in modal
            btn.disabled = false;
            btn.innerHTML = originalBtnContent;
            showErrorInModal(\`Fehler: \${result.message}\`);
        }
        
    } catch (error) {
        btn.disabled = false;
        btn.innerHTML = originalBtnContent;
        console.error('Error deleting post:', error);
        showErrorInModal('Netzwerkfehler beim L√∂schen des Posts. Bitte versuche es sp√§ter erneut.');
    }
}

function showErrorInModal(message) {
    const modalBody = document.querySelector('#deletePostModal .modal-body');
    const errorAlert = \`
        <div class="alert alert-danger d-flex align-items-center mt-3" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            \${message}
        </div>
    \`;
    modalBody.insertAdjacentHTML('beforeend', errorAlert);
}

window.duplicatePost = function(postId) {
    // TODO: Implement post duplication
    alert('Duplizierung wird in einer sp√§teren Version implementiert');
};

// Verify functions are available
console.log('Functions registered:', {
    showPostModal: typeof window.showPostModal,
    editPost: typeof window.editPost,
    schedulePost: typeof window.schedulePost,
    generateMorePosts: typeof window.generateMorePosts,
    exportPlan: typeof window.exportPlan,
    copyToClipboard: typeof window.copyToClipboard,
    quickCopy: typeof window.quickCopy
});
</script>
{% endblock %}

{% block page_css %}
<style>
    /* Post Cards */
    .post-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
        background: #ffffff;
    }
    
    .post-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-color: #0d6efd;
    }
    
    .post-card .card-body {
        padding: 1.25rem;
    }
    
    .post-card .card-title {
        color: #212529;
        font-weight: 600;
    }
    
    .post-card .card-text {
        color: #6c757d;
        line-height: 1.4;
    }
    
    .post-card .badge {
        font-size: 0.75rem;
    }
    
    .post-card .btn {
        font-size: 0.875rem;
    }
    
    /* Post card states */
    .post-card.scheduled {
        border-left: 4px solid #198754;
    }
    
    .post-card.draft {
        border-left: 4px solid #ffc107;
    }
    
    /* Character counter colors */
    .character-counter {
        font-weight: 500;
    }
    
    .character-counter.danger {
        color: #dc3545 !important;
    }
    
    .character-counter.warning {
        color: #ffc107 !important;
    }
    
    /* Content formatting in modal */
    .content-formatted p {
        margin-bottom: 0.75rem;
    }
    
    .content-formatted p:last-child {
        margin-bottom: 0;
    }
    
    .content-formatted strong {
        font-weight: 600;
        color: #212529;
    }
    
    .content-formatted em {
        font-style: italic;
        color: #495057;
    }
    
    .script-formatted p {
        margin-bottom: 0.5rem;
    }
    
    .script-formatted p:last-child {
        margin-bottom: 0;
    }
    
    .script-formatted .badge {
        font-size: 0.7rem;
        margin-right: 0.25rem;
    }
    
    /* Enhanced post card content preview */
    .post-card .card-text {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.4;
        height: calc(1.4em * 3);
    }
    
    /* Hashtag styling */
    .hashtag-preview {
        display: inline-block;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Modal content styling */
    .modal-content {
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
        border-bottom: 2px solid #e9ecef;
        background: #f8f9fa;
    }
    
    .modal-body h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 0.75rem;
    }
    
    .modal-body h6 i {
        color: #6c757d;
    }
    
    /* Plan description formatting */
    .plan-description p {
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    .plan-description p:last-child {
        margin-bottom: 0;
    }
    
    /* Strategy notes formatting */
    .strategy-notes p {
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    .strategy-notes p:last-child {
        margin-bottom: 0;
    }
    
    /* Better line height for formatted content */
    .linebreaks {
        line-height: 1.5;
    }
    
    /* Story Post Styling */
    .post-card.story {
        border-left: 4px solid #28a745;
        position: relative;
    }
    
    .story-order-badge {
        position: absolute;
        top: -8px;
        left: 15px;
        z-index: 10;
    }
    
    .story-order-badge .badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .post-badges {
        display: flex;
        gap: 0.25rem;
        align-items: center;
    }
    
    .post-badges .badge {
        font-size: 0.7rem;
    }
    
    /* Story cards get special styling */
    .post-card.story:hover {
        border-left-color: #20c997;
        transform: translateY(-3px);
    }
    
    /* Enhanced text formatting */
    .content-formatted p {
        margin-bottom: 0.75rem;
        line-height: 1.6;
    }
    
    .content-formatted p:last-child {
        margin-bottom: 0;
    }
    
    .content-formatted strong {
        font-weight: 600;
        color: #212529;
    }
    
    .content-formatted em {
        font-style: italic;
        color: #6c757d;
    }
    
    .content-formatted a {
        text-decoration: underline;
        word-break: break-word;
    }
    
    .content-formatted a:hover {
        text-decoration: none;
    }
    
    /* Post Action Dropdown */
    .post-card .dropdown {
        position: relative;
    }
    
    .post-card .dropdown-menu {
        position: absolute !important;
        top: 100% !important;
        right: 0 !important;
        left: auto !important;
        z-index: 1050;
        min-width: 160px;
        margin-top: 0.25rem;
        border: 1px solid rgba(0,0,0,.125);
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15) !important;
        background-color: white;
    }
    
    .dropdown-toggle-no-caret::after {
        display: none;
    }
    
    .dropdown-item {
        padding: 0.5rem 0.75rem;
        transition: all 0.2s ease;
    }
    
    .dropdown-item:hover {
        background-color: #f8f9fa;
        transform: translateX(2px);
    }
    
    .dropdown-item i {
        width: 16px;
        text-align: center;
    }
    
    /* Generate Ideas Modal Styling */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }
    
    #generateIdeasModal .modal-content {
        border-radius: 15px;
        overflow: hidden;
    }
    
    #generateIdeasModal .modal-header {
        padding: 1.5rem;
    }
    
    #generateIdeasModal .modal-body {
        padding: 2rem;
    }
    
    #generateIdeasModal .modal-footer {
        padding: 1.5rem 2rem 2rem 2rem;
    }
    
    #generateIdeasModal .rounded-circle {
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }
    
    #generateIdeasModal .btn {
        border-radius: 8px;
        font-weight: 500;
        padding: 0.75rem 1.5rem;
    }
    
    #generateIdeasModal .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    #generateIdeasModal .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    #generateIdeasModal .btn-light {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    #generateIdeasModal .btn-light:hover {
        background: #e9ecef;
        transform: translateY(-1px);
    }
</style>
{% endblock %}