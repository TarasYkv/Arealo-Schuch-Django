{% extends "somi_plan/base.html" %}
{% load static %}
{% load math_filters from core.templatetags %}

{% block page_title %}{{ plan.title }} - Schritt 3{% endblock %}
{% block page_description %}Content-Erstellung: Die KI erstellt deine Post-Ideen{% endblock %}

{% block main_content %}
<!-- Progress Steps -->
<div class="progress-steps mb-4">
    <div class="step completed">
        <div class="step-number">
            <i class="fas fa-check"></i>
        </div>
        <span>Basis-Setup</span>
    </div>
    <div class="step completed">
        <div class="step-number">
            <i class="fas fa-check"></i>
        </div>
        <span>Strategie</span>
    </div>
    <div class="step active">
        <div class="step-number">3</div>
        <span>Content</span>
    </div>
</div>

<div class="row">
    <div class="col-12">
        
        <!-- Plan Info Header -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="{{ plan.platform.icon }} fa-2x me-3" style="color: {{ plan.platform.color }};"></i>
                        <div>
                            <h5 class="card-title mb-1">{{ plan.title }}</h5>
                            <small class="text-muted">{{ plan.platform.name }} • Content Posts werden erstellt...</small>
                        </div>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-info mb-1">{{ posts.count }} Posts erstellt</span><br>
                        <span class="badge bg-{{ plan.status|yesno:"success,warning,secondary" }}">{{ plan.get_status_display }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Content Generation Status -->
        <div class="card mb-4" id="content-generation-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-magic me-2"></i>KI-Content-Erstellung
                </h5>
                <button class="btn btn-outline-primary btn-sm" onclick="generateMoreIdeas()" id="generate-more-btn">
                    <span class="loading-spinner spinner-border spinner-border-sm me-2" role="status"></span>
                    <i class="fas fa-plus me-1"></i>Mehr kreative Ideen
                </button>
            </div>
            <div class="card-body">
                
                <!-- Initial Loading State -->
                <div id="content-loading" {% if posts %}style="display: none;"{% endif %}>
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h6>KI erstellt deine Content-Posts...</h6>
                        <p class="text-muted">
                            Basierend auf deiner Strategie werden jetzt individuelle Posts mit Skripten 
                            und Anweisungen für {{ plan.platform.name }} generiert.
                        </p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="content-progress"></div>
                        </div>
                        <small class="text-muted mt-2 d-block" id="progress-text">Analyse der Strategie...</small>
                    </div>
                </div>
                
                <!-- Content Generated State -->
                <div id="content-generated" {% if not posts %}style="display: none;"{% endif %}>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <strong id="posts-count">{{ posts.count }} Posts erstellt</strong>
                            <small class="text-muted ms-2">Klicke auf eine Kachel um den vollständigen Inhalt zu sehen</small>
                        </div>
                        <div>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="selectAllPosts()">
                                    <i class="fas fa-check-square me-1"></i>Alle auswählen
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="deleteSelectedPosts()" id="delete-selected-btn" disabled>
                                    <i class="fas fa-trash me-1"></i>Ausgewählte löschen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- Post Cards Grid -->
        <div id="posts-grid">
            {% for post in posts %}
            <div class="post-card" data-post-id="{{ post.id }}">
                <div class="ai-badge">
                    <i class="fas fa-robot me-1"></i>{{ post.ai_model_used|default:"AI" }}
                </div>
                
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="form-check">
                        <input class="form-check-input post-checkbox" type="checkbox" value="{{ post.id }}" onchange="updateBulkActions()">
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="editPost({{ post.id }})">
                                <i class="fas fa-edit me-2"></i>Bearbeiten
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="duplicatePost({{ post.id }})">
                                <i class="fas fa-copy me-2"></i>Duplizieren
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="schedulePost({{ post.id }})">
                                <i class="fas fa-calendar me-2"></i>Terminieren
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deletePost({{ post.id }})">
                                <i class="fas fa-trash me-2"></i>Löschen
                            </a></li>
                        </ul>
                    </div>
                </div>
                
                <h6 class="post-title mb-2">{{ post.title }}</h6>
                
                <div class="post-preview mb-3">
                    <p class="text-muted small mb-2">{{ post.content|truncatechars:120|linebreaks }}</p>
                    {% if post.hashtags %}
                    <div class="hashtags mb-2">
                        {% for hashtag in post.hashtags|split:" " %}
                            {% if hashtag %}
                            <span class="badge bg-light text-dark me-1">{{ hashtag }}</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="post-meta d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">
                            <i class="fas fa-font me-1"></i>
                            <span class="character-counter {% if post.get_character_limit_percentage > 100 %}danger{% elif post.get_character_limit_percentage > 80 %}warning{% endif %}">
                                {{ post.character_count }}/{{ post.posting_plan.platform.character_limit }}
                            </span>
                        </small>
                        {% if post.post_type %}
                        <span class="badge bg-secondary ms-2">{{ post.post_type }}</span>
                        {% endif %}
                    </div>
                    <div>
                        <small class="text-muted">
                            Priorität: 
                            {% if post.priority == 1 %}
                                <span class="text-danger">Hoch</span>
                            {% elif post.priority == 2 %}
                                <span class="text-warning">Mittel</span>
                            {% else %}
                                <span class="text-muted">Niedrig</span>
                            {% endif %}
                        </small>
                    </div>
                </div>
                
                <!-- Expanded Content (hidden by default) -->
                <div class="post-expanded mt-3" style="display: none;">
                    <hr>
                    <h6 class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-file-alt me-2"></i>Vollständiger Content:</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('{{ post.content|escapejs }}', 'content')">
                            <i class="fas fa-copy me-1"></i>Kopieren
                        </button>
                    </h6>
                    <div class="bg-light p-3 rounded mb-3 border">
                        <div class="content-formatted" style="line-height: 1.6; font-size: 0.95rem;">
                            {{ post.content|linebreaks }}
                        </div>
                    </div>
                    
                    <h6 class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-script me-2"></i>Umsetzungs-Skript:</span>
                        <button class="btn btn-sm btn-outline-info" onclick="copyToClipboard('{{ post.script|escapejs }}', 'script')">
                            <i class="fas fa-copy me-1"></i>Kopieren
                        </button>
                    </h6>
                    <div class="bg-info bg-opacity-10 p-3 rounded mb-3 border border-info">
                        <div class="script-formatted" style="line-height: 1.5; font-size: 0.9rem;">
                            {{ post.script|linebreaks }}
                        </div>
                    </div>
                    
                    {% if post.call_to_action %}
                    <h6 class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-bullhorn me-2"></i>Call-to-Action:</span>
                        <button class="btn btn-sm btn-outline-warning" onclick="copyToClipboard('{{ post.call_to_action|escapejs }}', 'cta')">
                            <i class="fas fa-copy me-1"></i>Kopieren
                        </button>
                    </h6>
                    <div class="bg-warning bg-opacity-10 p-2 rounded mb-3">
                        <strong>{{ post.call_to_action }}</strong>
                    </div>
                    {% endif %}
                    
                    <!-- Quick Copy Section -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6 class="mb-2"><i class="fas fa-magic me-2"></i>Schnell-Kopieren für {{ plan.platform.name }}</h6>
                        <div class="btn-group btn-group-sm w-100">
                            <button class="btn btn-outline-dark" onclick="copyCompletePost('{{ post.content|escapejs }}', '{{ post.hashtags|escapejs }}', '{{ post.call_to_action|escapejs }}')">
                                <i class="fas fa-copy me-1"></i>Alles
                            </button>
                            <button class="btn btn-outline-secondary" onclick="copyContentHashtags('{{ post.content|escapejs }}', '{{ post.hashtags|escapejs }}')">
                                <i class="fas fa-copy me-1"></i>Content+Tags
                            </button>
                        </div>
                    </div>
                    
                    <hr>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary btn-sm me-2" onclick="schedulePost({{ post.id }})">
                            <i class="fas fa-calendar me-1"></i>Terminieren
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="editPost({{ post.id }})">
                            <i class="fas fa-edit me-1"></i>Bearbeiten
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <!-- Empty state - will be replaced by JavaScript generated content -->
            <div class="text-center py-5" id="empty-state">
                <i class="fas fa-magic fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">Content wird generiert...</h5>
                <p class="text-muted">Die KI erstellt gerade deine ersten Post-Ideen basierend auf deiner Strategie.</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Action Bar -->
        <div class="card mt-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <a href="{% url 'somi_plan:create_plan_step2' plan.id %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Zurück zu Schritt 2
                        </a>
                    </div>
                    
                    <div class="d-flex align-items-center">
                        <span class="text-muted me-3">
                            <i class="fas fa-check-circle me-1"></i>
                            <span id="ready-posts-count">{{ posts.count }}</span> Posts bereit
                        </span>
                        
                        <button class="btn btn-outline-primary me-2" onclick="saveAsDraft()">
                            <i class="fas fa-save me-2"></i>Als Entwurf speichern
                        </button>
                        
                        <button class="btn btn-success btn-lg" onclick="activatePlan()" id="activate-plan-btn">
                            <span class="loading-spinner spinner-border spinner-border-sm me-2" role="status"></span>
                            <i class="fas fa-rocket me-2"></i>Plan aktivieren
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if not posts %}
    // Start content generation if no posts exist
    generateInitialContent();
    {% endif %}
    
    // Add click listeners to post cards
    document.querySelectorAll('.post-card').forEach(card => {
        card.addEventListener('click', function(e) {
            // Don't expand if clicking on checkbox or dropdown
            if (e.target.closest('.form-check') || e.target.closest('.dropdown')) {
                return;
            }
            
            togglePostExpansion(this);
        });
    });
});

async function generateInitialContent() {
    const progressBar = document.getElementById('content-progress');
    const progressText = document.getElementById('progress-text');
    
    const steps = [
        'Analyse der Strategie...',
        'Content-Themen identifizieren...',
        'Post-Strukturen erstellen...',
        'Texte generieren...',
        'Skripte und Anweisungen hinzufügen...',
        'Hashtags optimieren...',
        'Finale Überprüfung...'
    ];
    
    let currentStep = 0;
    let progress = 0;
    
    const updateProgress = () => {
        if (currentStep < steps.length) {
            progress = (currentStep / steps.length) * 100;
            progressBar.style.width = progress + '%';
            progressText.textContent = steps[currentStep];
            currentStep++;
            
            setTimeout(updateProgress, 800 + Math.random() * 1200);
        } else {
            // Generation complete
            progressBar.style.width = '100%';
            progressText.textContent = 'Content-Erstellung abgeschlossen!';
            
            setTimeout(() => {
                document.getElementById('content-loading').style.display = 'none';
                document.getElementById('content-generated').style.display = 'block';
                document.getElementById('empty-state').style.display = 'none';
                
                // Show generated posts
                showGeneratedPosts();
            }, 1000);
        }
    };
    
    updateProgress();
}

function showGeneratedPosts() {
    // Mock generated posts (in real implementation, this would come from AI API)
    const mockPosts = [
        {
            id: 'new_1',
            title: '5 Tipps für mehr Motivation im Alltag',
            content: `💪 5 TIPPS FÜR MEHR MOTIVATION IM ALLTAG

Du kennst das: Montag morgen und die Motivation ist im Keller? 😴

Hier sind meine bewährtesten Strategien:

✅ 1. Kleine Ziele setzen
Statt "Ich werde fit" → "Ich mache heute 10 Liegestütze"

✅ 2. Erfolge sichtbar machen
Führe ein Erfolgs-Journal. Auch kleine Siege zählen!

✅ 3. Routine entwickeln
Motivation ist vergänglich, Gewohnheiten bleiben.

✅ 4. Dich belohnen
Kleine Erfolge verdienen kleine Belohnungen.

✅ 5. Community suchen
Umgib dich mit Menschen, die ähnliche Ziele haben.

👉 Welcher Tipp spricht dich am meisten an? Schreib's in die Kommentare!

#motivation #erfolg #tipps #mindset #ziele`,
            script: `POST-SKRIPT: Motivations-Tipps

🎯 ZIEL: Praktische Hilfe bieten und Engagement fördern

📱 ANWEISUNGEN:
1. Mit relatable Hook starten (Montag-Motivation)
2. Konkrete, umsetzbare Tipps geben
3. Beispiele für besseres Verständnis
4. Community-Frage am Ende für Interaktion
5. Relevante Hashtags für Reichweite

⏰ BESTE POSTING-ZEIT: Montag 7-8 Uhr oder Sonntag Abend
📊 ERWARTUNG: Hohe Engagement-Rate durch praktischen Nutzen
🎨 VISUAL: Carousel mit jedem Tipp oder motivierendes Zitat-Design
💬 FOLLOW-UP: Auf Kommentare eingehen und weitere Tipps teilen`,
            hashtags: '#motivation #erfolg #tipps #mindset #ziele #inspiration #persönlichkeitsentwicklung',
            post_type: 'Tipps & Tricks',
            priority: 1
        },
        {
            id: 'new_2', 
            title: 'Behind the Scenes: Mein Arbeitsplatz',
            content: `🏠 BEHIND THE SCENES: Mein Arbeitsplatz

Ihr habt so oft gefragt, wie mein Setup aussieht! 👀

Hier ist mein "Command Center":

🖥️ Monitor: 27" für den Überblick
⌨️ Tastatur: Mechanisch - für das Gefühl
☕ Kaffee: IMMER griffbereit (Lebenselixier!)
📝 Notizbuch: Für spontane Ideen
🪴 Pflanze: Bringt Leben in den Raum
🎧 Kopfhörer: Für die Fokus-Sessions

Das Geheimnis? Es ist nicht die perfekte Ausrüstung...
...sondern die Konstanz, jeden Tag dranzubleiben! 💪

Wie sieht euer Arbeitsplatz aus? Zeigt mir gern eure Setups! 📸

#behindthescenes #workspace #homeoffice #productivity #setup`,
            script: `POST-SKRIPT: Behind the Scenes Arbeitsplatz

🎯 ZIEL: Persönlichkeit zeigen und Community-Austausch fördern

📱 ANWEISUNGEN:
1. Authentischen Einblick geben
2. Setup-Items einzeln auflisten (relatable)
3. Persönliche Note hinzufügen (Kaffee-Liebe)
4. Wertvolle Message am Ende (Konstanz > Equipment)
5. Community zum Teilen ermutigen

⏰ BESTE POSTING-ZEIT: Dienstag oder Mittwoch 9-10 Uhr
📊 ERWARTUNG: Hohe Story-Shares und Kommentare
🎨 VISUAL: Arbeitsplatz-Foto von oben oder Carousel mit Details
💬 FOLLOW-UP: Auf geteilte Setups reagieren und kommentieren`,
            hashtags: '#behindthescenes #workspace #homeoffice #productivity #setup',
            post_type: 'Behind the Scenes',
            priority: 2
        },
        {
            id: 'new_3',
            title: 'Motivations-Montag: Dein Warum finden',
            content: `🔥 MOTIVATIONS-MONTAG: Finde dein WARUM

"Wer ein Warum zum Leben hat, erträgt fast jedes Wie." - Nietzsche

Aber wie findest du dein WARUM? 🤔

3 mächtige Fragen:

❓ Was würdest du tun, auch wenn du nicht dafür bezahlt würdest?

❓ Wofür werden Menschen dir am meisten danken?

❓ Was würdest du bereuen, wenn du es nie versucht hättest?

Dein WARUM ist nicht nur ein schöner Gedanke...
...es ist dein Antrieb, wenn es schwer wird! 💪

Nimm dir heute 10 Minuten Zeit für diese Fragen.
Schreib die Antworten auf. Du wirst überrascht sein! ✍️

Was ist DEIN Warum? Teile es in den Kommentaren! 👇

#motivation #warum #sinn #ziele #klarheit #montag`,
            script: `POST-SKRIPT: Motivations-Montag WARUM

🎯 ZIEL: Tiefere Reflexion anregen und starkes Engagement

📱 ANWEISUNGEN:
1. Starkes Zitat als Hook verwenden
2. Praktische Fragen zum Nachdenken geben
3. Wichtigkeit des WARUM erklären
4. Klare Handlungsaufforderung (10 Min Time)
5. Persönliche Frage für Kommentare

⏰ BESTE POSTING-ZEIT: Montag 6-8 Uhr (Wochenstart)
📊 ERWARTUNG: Nachdenkliche Kommentare und Saves
🎨 VISUAL: Inspirierendes Zitat-Design oder Mindmap-Stil
💬 FOLLOW-UP: Auf persönliche WARUM-Antworten eingehen`,
            hashtags: '#motivation #warum #sinn #ziele #klarheit #montag',
            post_type: 'Motivation',
            priority: 1
        }
    ];
    
    const postsGrid = document.getElementById('posts-grid');
    postsGrid.innerHTML = '';
    
    mockPosts.forEach((post, index) => {
        setTimeout(() => {
            const postCard = createPostCard(post);
            postsGrid.appendChild(postCard);
            
            // Update counter
            document.getElementById('posts-count').textContent = `${index + 1} Posts erstellt`;
            document.getElementById('ready-posts-count').textContent = index + 1;
            
            // Animate in
            postCard.style.opacity = '0';
            postCard.style.transform = 'translateY(20px)';
            setTimeout(() => {
                postCard.style.transition = 'all 0.5s ease';
                postCard.style.opacity = '1';
                postCard.style.transform = 'translateY(0)';
            }, 100);
            
        }, index * 600);
    });
}

function createPostCard(post) {
    const card = document.createElement('div');
    card.className = 'post-card';
    card.dataset.postId = post.id;
    
    const characterCount = post.content.length;
    const characterLimit = {{ plan.platform.character_limit }};
    const percentage = (characterCount / characterLimit) * 100;
    
    let characterClass = '';
    if (percentage > 100) characterClass = 'danger';
    else if (percentage > 80) characterClass = 'warning';
    
    card.innerHTML = `
        <div class="ai-badge">
            <i class="fas fa-robot me-1"></i>GPT-4
        </div>
        
        <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="form-check">
                <input class="form-check-input post-checkbox" type="checkbox" value="${post.id}" onchange="updateBulkActions()">
            </div>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="editPost('${post.id}')">
                        <i class="fas fa-edit me-2"></i>Bearbeiten
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="duplicatePost('${post.id}')">
                        <i class="fas fa-copy me-2"></i>Duplizieren
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="schedulePost('${post.id}')">
                        <i class="fas fa-calendar me-2"></i>Terminieren
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="deletePost('${post.id}')">
                        <i class="fas fa-trash me-2"></i>Löschen
                    </a></li>
                </ul>
            </div>
        </div>
        
        <h6 class="post-title mb-2">${post.title}</h6>
        
        <div class="post-preview mb-3">
            <p class="text-muted small mb-2" style="white-space: pre-line;">${post.content.substring(0, 120)}...</p>
            <div class="hashtags mb-2">
                ${post.hashtags.split(' ').filter(tag => tag).map(tag => 
                    `<span class="badge bg-light text-dark me-1">${tag}</span>`
                ).join('')}
            </div>
        </div>
        
        <div class="post-meta d-flex justify-content-between align-items-center">
            <div>
                <small class="text-muted">
                    <i class="fas fa-font me-1"></i>
                    <span class="character-counter ${characterClass}">
                        ${characterCount}/${characterLimit}
                    </span>
                </small>
                <span class="badge bg-secondary ms-2">${post.post_type}</span>
            </div>
            <div>
                <small class="text-muted">
                    Priorität: 
                    <span class="${post.priority === 1 ? 'text-danger' : post.priority === 2 ? 'text-warning' : 'text-muted'}">
                        ${post.priority === 1 ? 'Hoch' : post.priority === 2 ? 'Mittel' : 'Niedrig'}
                    </span>
                </small>
            </div>
        </div>
        
        <!-- Expanded Content -->
        <div class="post-expanded mt-3" style="display: none;">
            <hr>
            <h6><i class="fas fa-file-alt me-2"></i>Vollständiger Content:</h6>
            <div class="bg-light p-3 rounded mb-3 border">
                <div class="content-formatted" style="line-height: 1.6; font-size: 0.95rem;">
                    ${post.content.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>').replace(/^/, '<p>').replace(/$/, '</p>').replace(/<p><\/p>/g, '').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/#(\w+)/g, '<span class="text-primary fw-bold">#$1</span>')}
                </div>
            </div>
            
            <h6><i class="fas fa-script me-2"></i>Umsetzungs-Skript:</h6>
            <div class="bg-info bg-opacity-10 p-3 rounded mb-3 border border-info">
                <div class="script-formatted" style="line-height: 1.5; font-size: 0.9rem;">
                    ${post.script.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>').replace(/^/, '<p>').replace(/$/, '</p>').replace(/<p><\/p>/g, '').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/(\d+\.|\-|\•)/g, '<span class="text-primary fw-bold">$1</span>').replace(/(Schritt \d+|Phase \d+|Teil \d+)/gi, '<span class="badge bg-info me-1">$1</span>')}
                </div>
            </div>
            
            <div class="d-flex justify-content-end">
                <button class="btn btn-primary btn-sm me-2" onclick="schedulePost('${post.id}')">
                    <i class="fas fa-calendar me-1"></i>Terminieren
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="editPost('${post.id}')">
                    <i class="fas fa-edit me-1"></i>Bearbeiten
                </button>
            </div>
        </div>
    `;
    
    // Add click listener
    card.addEventListener('click', function(e) {
        if (e.target.closest('.form-check') || e.target.closest('.dropdown')) {
            return;
        }
        togglePostExpansion(this);
    });
    
    return card;
}

function togglePostExpansion(card) {
    const expandedContent = card.querySelector('.post-expanded');
    const isExpanded = expandedContent.style.display !== 'none';
    
    // Close all other cards
    document.querySelectorAll('.post-card').forEach(otherCard => {
        if (otherCard !== card) {
            otherCard.querySelector('.post-expanded').style.display = 'none';
            otherCard.classList.remove('expanded');
        }
    });
    
    // Toggle this card
    if (isExpanded) {
        expandedContent.style.display = 'none';
        card.classList.remove('expanded');
    } else {
        expandedContent.style.display = 'block';
        card.classList.add('expanded');
    }
}

async function generateMoreIdeas() {
    const btn = document.getElementById('generate-more-btn');
    SomiPlan.setLoading(btn);
    
    try {
        const response = await fetch(`{% url 'somi_plan:generate_more_ideas' plan.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        });
        
        const result = await response.json();
        SomiPlan.setLoading(btn, false);
        
        if (result.status === 'success') {
            // Add new posts to the grid
            result.new_posts.forEach(postData => {
                const newPost = {
                    id: postData.id,
                    title: postData.title,
                    content: postData.content,
                    script: '', // Will be populated from actual data
                    hashtags: postData.hashtags,
                    post_type: postData.post_type,
                    priority: 2
                };
                
                const postCard = createPostCard(newPost);
                document.getElementById('posts-grid').appendChild(postCard);
                
                // Animate in
                postCard.style.opacity = '0';
                postCard.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    postCard.style.transition = 'all 0.5s ease';
                    postCard.style.opacity = '1';
                    postCard.style.transform = 'translateY(0)';
                }, 100);
            });
            
            // Update counters
            const currentCount = document.querySelectorAll('.post-card').length;
            document.getElementById('posts-count').textContent = `${currentCount} Posts erstellt`;
            document.getElementById('ready-posts-count').textContent = currentCount;
            
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-magic me-2"></i>
                ${result.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.col-12').insertBefore(alert, document.querySelector('.col-12').firstChild);
            
        } else {
            // Show error message
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                Fehler: ${result.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.col-12').insertBefore(alert, document.querySelector('.col-12').firstChild);
        }
        
    } catch (error) {
        SomiPlan.setLoading(btn, false);
        console.error('Error generating ideas:', error);
        
        // Show error message
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            Netzwerkfehler beim Generieren neuer Ideen. Bitte versuche es später erneut.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.col-12').insertBefore(alert, document.querySelector('.col-12').firstChild);
    }
}

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.post-checkbox');
    const checkedBoxes = document.querySelectorAll('.post-checkbox:checked');
    const deleteBtn = document.getElementById('delete-selected-btn');
    
    deleteBtn.disabled = checkedBoxes.length === 0;
}

function selectAllPosts() {
    const checkboxes = document.querySelectorAll('.post-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
    });
    
    updateBulkActions();
}

function deleteSelectedPosts() {
    const checkedBoxes = document.querySelectorAll('.post-checkbox:checked');
    if (checkedBoxes.length === 0) return;
    
    if (confirm(`${checkedBoxes.length} Posts löschen?`)) {
        checkedBoxes.forEach(checkbox => {
            const postCard = checkbox.closest('.post-card');
            postCard.remove();
        });
        
        // Update counters
        const remainingCount = document.querySelectorAll('.post-card').length;
        document.getElementById('posts-count').textContent = `${remainingCount} Posts erstellt`;
        document.getElementById('ready-posts-count').textContent = remainingCount;
        
        updateBulkActions();
    }
}

window.editPost = function(postId) {
    // Redirect to edit page
    window.location.href = "{% url 'somi_plan:post_edit' 0 %}".replace('0', postId);
};

window.duplicatePost = function(postId) {
    const originalCard = document.querySelector(`[data-post-id="${postId}"]`);
    const newCard = originalCard.cloneNode(true);
    
    // Update ID
    const newId = 'copy_' + Date.now();
    newCard.dataset.postId = newId;
    newCard.querySelector('.post-checkbox').value = newId;
    
    // Add "Kopie" to title
    const title = newCard.querySelector('.post-title');
    title.textContent = title.textContent + ' (Kopie)';
    
    // Insert after original
    originalCard.parentNode.insertBefore(newCard, originalCard.nextSibling);
    
    // Update counters
    const currentCount = document.querySelectorAll('.post-card').length;
    document.getElementById('posts-count').textContent = `${currentCount} Posts erstellt`;
    document.getElementById('ready-posts-count').textContent = currentCount;
}

// Make function globally available
window.schedulePost = function(postId) {
    // Redirect to scheduling page
    window.location.href = "{% url 'somi_plan:schedule_post' 0 %}".replace('0', postId);
};

window.deletePost = function(postId) {
    if (confirm('Post löschen?')) {
        const postCard = document.querySelector(`[data-post-id="${postId}"]`);
        postCard.remove();
        
        // Update counters
        const remainingCount = document.querySelectorAll('.post-card').length;
        document.getElementById('posts-count').textContent = `${remainingCount} Posts erstellt`;
        document.getElementById('ready-posts-count').textContent = remainingCount;
    }
};

// Copy functionality
window.copyToClipboard = function(text, type) {
    const cleanText = text
        .replace(/\\n/g, '\n')
        .replace(/\\'/g, "'")
        .replace(/\\"/g, '"');
    
    navigator.clipboard.writeText(cleanText).then(() => {
        showCopyNotification(type);
    }).catch(err => {
        console.error('Copy failed:', err);
        // Fallback
        const textArea = document.createElement("textarea");
        textArea.value = cleanText;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showCopyNotification(type);
        } catch (err) {
            alert('Kopieren fehlgeschlagen.');
        }
        document.body.removeChild(textArea);
    });
};

window.showCopyNotification = function(type) {
    const messages = {
        content: 'Content kopiert!',
        script: 'Skript kopiert!',
        hashtags: 'Hashtags kopiert!',
        cta: 'Call-to-Action kopiert!',
        complete: 'Kompletter Post kopiert!'
    };
    
    // Create toast
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 end-0 p-3';
    toast.style.zIndex = '11';
    toast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">${messages[type] || 'Kopiert!'}</strong>
                <button type="button" class="btn-close btn-close-white" onclick="this.closest('.toast').remove()"></button>
            </div>
        </div>
    `;
    
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
};

window.copyCompletePost = function(content, hashtags, cta) {
    let text = content;
    if (cta) text += '\n\n' + cta;
    if (hashtags) text += '\n\n' + hashtags;
    copyToClipboard(text, 'complete');
};

window.copyContentHashtags = function(content, hashtags) {
    let text = content;
    if (hashtags) text += '\n\n' + hashtags;
    copyToClipboard(text, 'complete');
};

window.saveAsDraft = function() {
    // Save plan as draft
    fetch("{% url 'somi_plan:plan_detail' plan.id %}", {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({ status: 'draft' })
    }).then(() => {
        showDraftSuccessMessage();
        setTimeout(() => {
            window.location.href = "{% url 'somi_plan:dashboard' %}";
        }, 2000);
    });
};

window.activatePlan = function() {
    const btn = document.getElementById('activate-plan-btn');
    SomiPlan.setLoading(btn);
    
    // Simulate activation
    setTimeout(() => {
        showSuccessModal();
    }, 1500);
};

function showSuccessModal() {
    // Create modal HTML
    const modalHTML = `
        <div class="modal fade" id="planActivatedModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-body text-center p-5">
                        <div class="success-animation mb-4">
                            <div class="success-checkmark">
                                <div class="check-icon">
                                    <span class="icon-line line-tip"></span>
                                    <span class="icon-line line-long"></span>
                                    <div class="icon-circle"></div>
                                    <div class="icon-fix"></div>
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="text-success mb-3">🎉 Plan erfolgreich aktiviert!</h3>
                        
                        <p class="text-muted mb-4">
                            Dein Social Media Plan ist jetzt bereit für die Umsetzung. 
                            Du kannst deine Posts im Kalender terminieren und mit der Content-Erstellung beginnen.
                        </p>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success btn-lg" onclick="goToPlanDetail()">
                                <i class="fas fa-calendar-alt me-2"></i>Zum Kalender
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="goToDashboard()">
                                <i class="fas fa-home me-2"></i>Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add custom CSS for animation
    const styleElement = document.createElement('style');
    styleElement.textContent = `
        .success-animation {
            position: relative;
            height: 80px;
        }
        
        .success-checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #28a745;
            stroke-miterlimit: 10;
            margin: 0 auto;
            box-shadow: inset 0px 0px 0px #28a745;
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        
        .success-checkmark .check-icon {
            width: 56px;
            height: 56px;
            position: relative;
            border-radius: 50%;
            box-sizing: content-box;
            border: 4px solid #28a745;
            margin: 8px auto;
        }
        
        .success-checkmark .check-icon::before {
            top: 3px;
            left: -2px;
            width: 30px;
            transform-origin: 100% 50%;
            border-radius: 100px 0 0 100px;
        }
        
        .success-checkmark .check-icon::after {
            top: 0;
            left: 30px;
            width: 60px;
            transform-origin: 0 50%;
            border-radius: 0 100px 100px 0;
            animation: rotate-circle 4.25s ease-in;
        }
        
        .success-checkmark .check-icon::before,
        .success-checkmark .check-icon::after {
            content: '';
            height: 100px;
            position: absolute;
            background: #FFFFFF;
            transform: rotate(-45deg);
        }
        
        .success-checkmark .icon-line {
            height: 5px;
            background-color: #28a745;
            display: block;
            border-radius: 2px;
            position: absolute;
            z-index: 10;
        }
        
        .success-checkmark .icon-line.line-tip {
            top: 46px;
            left: 14px;
            width: 25px;
            transform: rotate(45deg);
            animation: icon-line-tip 0.75s;
        }
        
        .success-checkmark .icon-line.line-long {
            top: 38px;
            right: 8px;
            width: 47px;
            transform: rotate(-45deg);
            animation: icon-line-long 0.75s;
        }
        
        .success-checkmark .icon-circle {
            top: -4px;
            left: -4px;
            z-index: 10;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            position: absolute;
            box-sizing: content-box;
            border: 4px solid rgba(40, 167, 69, .5);
        }
        
        .success-checkmark .icon-fix {
            top: 8px;
            width: 5px;
            left: 26px;
            z-index: 1;
            height: 85px;
            position: absolute;
            transform: rotate(-45deg);
            background-color: #FFFFFF;
        }
        
        @keyframes rotate-circle {
            0% { transform: rotate(-45deg); }
            5% { transform: rotate(-45deg); }
            12% { transform: rotate(-405deg); }
            100% { transform: rotate(-405deg); }
        }
        
        @keyframes icon-line-tip {
            0% { width: 0; left: 1px; top: 19px; }
            54% { width: 0; left: 1px; top: 19px; }
            70% { width: 50px; left: -8px; top: 37px; }
            84% { width: 17px; left: 21px; top: 48px; }
            100% { width: 25px; left: 14px; top: 45px; }
        }
        
        @keyframes icon-line-long {
            0% { width: 0; right: 46px; top: 54px; }
            65% { width: 0; right: 46px; top: 54px; }
            84% { width: 55px; right: 0px; top: 35px; }
            100% { width: 47px; right: 8px; top: 38px; }
        }
        
        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 60px #28a745;
            }
        }
        
        @keyframes scale {
            0%, 100% {
                transform: none;
            }
            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }
        
        .modal-content {
            border-radius: 20px;
        }
        
        .btn {
            border-radius: 50px;
            font-weight: 600;
            padding: 12px 24px;
        }
    `;
    document.head.appendChild(styleElement);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('planActivatedModal'));
    modal.show();
    
    // Clean up when modal is hidden
    document.getElementById('planActivatedModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
        styleElement.remove();
    });
}

function goToPlanDetail() {
    window.location.href = "{% url 'somi_plan:plan_detail' plan.id %}";
}

function goToDashboard() {
    window.location.href = "{% url 'somi_plan:dashboard' %}";
}

function showDraftSuccessMessage() {
    // Create toast notification
    const toastHTML = `
        <div class="toast-container position-fixed top-0 end-0 p-3">
            <div id="draftToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-info text-white">
                    <i class="fas fa-save me-2"></i>
                    <strong class="me-auto">Plan gespeichert</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="spinner-border spinner-border-sm text-info" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div>
                            <strong>Plan als Entwurf gespeichert!</strong><br>
                            <small class="text-muted">Du wirst zum Dashboard weitergeleitet...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add toast to page
    document.body.insertAdjacentHTML('beforeend', toastHTML);
    
    // Show toast
    const toast = new bootstrap.Toast(document.getElementById('draftToast'), {
        autohide: false
    });
    toast.show();
    
    // Clean up when hidden
    document.getElementById('draftToast').addEventListener('hidden.bs.toast', function() {
        this.closest('.toast-container').remove();
    });
}
</script>
{% endblock %}

{% block page_css %}
<style>
    /* Progress Steps */
    .progress-steps {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 2rem 0;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .progress-steps .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
        max-width: 120px;
    }
    
    .progress-steps .step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 20px;
        right: -50%;
        width: 100%;
        height: 2px;
        background: #dee2e6;
        z-index: 1;
    }
    
    .progress-steps .step.active:not(:last-child)::after,
    .progress-steps .step.completed:not(:last-child)::after {
        background: #0d6efd;
    }
    
    .progress-steps .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #dee2e6;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 2;
        transition: all 0.3s ease;
    }
    
    .progress-steps .step.active .step-number {
        background: #0d6efd;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2);
    }
    
    .progress-steps .step.completed .step-number {
        background: #198754;
        color: white;
    }
    
    .progress-steps .step.completed .step-number i {
        font-size: 1rem;
    }
    
    .progress-steps .step span {
        font-size: 0.875rem;
        font-weight: 500;
        color: #6c757d;
        text-align: center;
        transition: color 0.3s ease;
    }
    
    .progress-steps .step.active span {
        color: #0d6efd;
        font-weight: 600;
    }
    
    .progress-steps .step.completed span {
        color: #198754;
    }
    
    /* Post Cards in Grid */
    #posts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
    }
    
    .post-card {
        background: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .post-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-color: #0d6efd;
    }
    
    .post-card.expanded {
        border-color: #0d6efd;
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .ai-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #e7f1ff;
        color: #0d6efd;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .post-title {
        color: #212529;
        font-weight: 600;
        margin-bottom: 0.75rem;
    }
    
    .post-preview {
        margin-bottom: 1rem;
    }
    
    .post-meta {
        font-size: 0.875rem;
    }
    
    .character-counter {
        font-weight: 500;
    }
    
    .character-counter.danger {
        color: #dc3545;
    }
    
    .character-counter.warning {
        color: #ffc107;
    }
    
    .post-expanded {
        border-top: 1px solid #dee2e6;
        margin-top: 1rem;
        padding-top: 1rem;
    }
    
    .hashtags .badge {
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
    }
    
    /* Loading spinner in buttons */
    .loading-spinner {
        display: none;
    }
    
    .loading .loading-spinner {
        display: inline-block;
    }
    
    /* Content formatting */
    .content-formatted p {
        margin-bottom: 0.75rem;
    }
    
    .content-formatted p:last-child {
        margin-bottom: 0;
    }
    
    .content-formatted strong {
        font-weight: 600;
        color: #212529;
    }
    
    .content-formatted em {
        font-style: italic;
        color: #495057;
    }
    
    .script-formatted p {
        margin-bottom: 0.5rem;
    }
    
    .script-formatted p:last-child {
        margin-bottom: 0;
    }
    
    .script-formatted .badge {
        font-size: 0.7rem;
        margin-right: 0.25rem;
    }
    
    /* Enhanced post preview */
    .post-preview p {
        line-height: 1.4;
        white-space: pre-line;
    }
</style>
{% endblock %}