{% extends 'chat/base.html' %}
{% load chat_extras %}

{% block content %}
<style>
.chat-container {
    height: calc(100vh - 200px);
    display: flex;
}

/* Chat Info Modal Styles */
.modal-lg {
    max-width: 800px;
}

.chat-info-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.online-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
}

.chat-info-card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    transition: box-shadow 0.2s ease;
}

.chat-info-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.participant-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.participant-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.stat-icon {
    font-size: 1.2em;
    margin-right: 8px;
}

.modal-header.bg-primary {
    border-top-left-radius: calc(0.375rem - 1px);
    border-top-right-radius: calc(0.375rem - 1px);
}

.chat-sidebar {
    width: 400px;
    border-right: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    background: #f8f9fa;
}

.chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
}

.chat-header {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    background: white;
}

.chat-list {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

.chat-room-item {
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: background-color 0.2s;
}

.chat-room-item:hover {
    background-color: #e9ecef;
}

.chat-room-item.active {
    background-color: #007bff;
    color: white;
}

.chat-room-item.active .text-muted {
    color: rgba(255, 255, 255, 0.8) !important;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    margin-right: 12px;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
}

.message-input-area {
    padding: 1rem;
    border-top: 1px solid #dee2e6;
    background: white;
}

.message-bubble {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    margin-bottom: 10px;
    word-wrap: break-word;
}

.message-own {
    background-color: #007bff;
    color: white;
    margin-left: auto;
}

.message-other {
    background-color: white;
    color: #333;
    border: 1px solid #dee2e6;
}

.empty-chat {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    flex-direction: column;
    color: #6c757d;
}

.no-chat-selected {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    flex-direction: column;
    color: #6c757d;
}

.badge-unread {
    background-color: #dc3545;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.7rem;
    min-width: 18px;
    text-align: center;
}

.user-avatar-img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.online-indicator {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 12px;
    height: 12px;
    background-color: #28a745;
    border: 2px solid white;
    border-radius: 50%;
    z-index: 1;
}

/* Floating Call Window Styles */
.floating-call-window {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 320px;
    height: 240px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    z-index: 9999;
    color: white;
    font-size: 14px;
    display: flex;
    flex-direction: column;
    resize: both;
    overflow: hidden;
    min-width: 280px;
    min-height: 180px;
    max-width: 600px;
    max-height: 400px;
    transition: all 0.3s ease;
}

.floating-call-window.minimized {
    height: 60px;
    width: 200px;
}

.floating-call-window.maximized {
    width: 500px;
    height: 350px;
}

.call-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px 12px 0 0;
    cursor: move;
    user-select: none;
}

.call-info {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.call-status-text {
    font-size: 12px;
    opacity: 0.8;
}

.call-header-controls {
    display: flex;
    gap: 4px;
}

.call-header-controls .btn {
    padding: 2px 6px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border-radius: 4px;
    font-size: 12px;
}

.call-header-controls .btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.call-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
    position: relative;
}

.call-avatar-container {
    text-align: center;
}

.call-avatar-container h5 {
    margin: 8px 0 0 0;
    font-size: 14px;
    font-weight: 500;
}

.video-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    border-radius: 0 0 8px 8px;
    overflow: hidden;
}

.remote-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.local-video {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 80px;
    height: 60px;
    border: 2px solid #fff;
    border-radius: 6px;
    object-fit: cover;
    z-index: 10;
}

.call-controls {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 8px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 0 0 12px 12px;
}

.call-controls .btn {
    padding: 6px 10px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border-radius: 20px;
    font-size: 12px;
}

.call-controls .btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.call-controls .btn-danger {
    background: #dc3545;
}

.call-controls .btn-danger:hover {
    background: #c82333;
}

.floating-call-window.minimized .call-content,
.floating-call-window.minimized .call-controls {
    display: none;
}

/* Fix modal scrollbar flicker */
.modal-open {
    padding-right: 0 !important;
    overflow: hidden !important;
}
.modal {
    padding-right: 0 !important;
    overflow-x: hidden !important;
    overflow-y: auto !important;
}
body.modal-open {
    overflow: hidden !important;
    padding-right: 0 !important;
}

/* Prevent modal from causing layout shifts */
.modal-dialog {
    transform: none !important;
    transition: none !important;
}

/* Stabilize modal content */
.modal-content {
    transform: translateZ(0);
    will-change: auto;
}

/* Prevent layout shift when modal opens */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100vw;
    height: 100vh;
}

.local-video {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 150px;
    height: 100px;
    border-radius: 8px;
    border: 2px solid white;
    z-index: 2;
}

.remote-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.call-controls {
    padding: 15px;
}

.call-controls button {
    margin: 0 10px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.search-box {
    padding: 0.5rem;
    border: none;
    border-bottom: 1px solid #dee2e6;
    background: white;
}

.search-box:focus {
    outline: none;
    border-bottom-color: #007bff;
}
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-comments text-primary"></i>
                            Chat
                        </h4>
                        <div class="d-flex gap-2">
                            <a href="{% url 'chat:user_search' %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-search"></i> Nutzer suchen
                            </a>
                            <a href="{% url 'chat:create_group_chat' %}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-users"></i> Gruppe erstellen
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="chat-container">
                        <!-- Chat Sidebar -->
                        <div class="chat-sidebar">
                            <div class="chat-header">
                                <h6 class="mb-0">Chats ({{ chat_rooms|length }})</h6>
                            </div>
                            <input type="text" class="search-box" placeholder="Chats durchsuchen..." id="chatSearch">
                            <div class="chat-list" id="chatList">
                                {% for room in chat_rooms %}
                                <div class="chat-room-item" data-room-id="{{ room.id }}" onclick="loadChat({{ room.id }})">
                                    <div class="d-flex align-items-center">
                                        <div class="position-relative">
                                            {% if room.is_group_chat %}
                                                <div class="user-avatar bg-success">
                                                    <i class="fas fa-users"></i>
                                                </div>
                                            {% else %}
                                                {% with other_user=room|get_other_participant:request.user %}
                                                    {% if other_user %}
                                                        {% if other_user.profile_picture %}
                                                            <img src="{{ other_user.profile_picture.url }}" alt="{{ other_user.get_full_name|default:other_user.username }}" class="user-avatar-img">
                                                        {% else %}
                                                            <div class="user-avatar bg-primary">
                                                                {{ other_user.get_full_name.0|default:other_user.username.0|upper }}
                                                            </div>
                                                        {% endif %}
                                                        <!-- Online-Status-Indikator -->
                                                        {% if other_user.is_currently_online %}
                                                            <span class="online-indicator"></span>
                                                        {% endif %}
                                                    {% elif room.created_by %}
                                                        {% if room.created_by.profile_picture %}
                                                            <img src="{{ room.created_by.profile_picture.url }}" alt="{{ room.created_by.get_full_name|default:room.created_by.username }}" class="user-avatar-img">
                                                        {% else %}
                                                            <div class="user-avatar bg-primary">
                                                                {{ room.created_by.get_full_name.0|default:room.created_by.username.0|upper }}
                                                            </div>
                                                        {% endif %}
                                                        <!-- Online-Status-Indikator -->
                                                        {% if room.created_by.is_currently_online %}
                                                            <span class="online-indicator"></span>
                                                        {% endif %}
                                                    {% else %}
                                                        <div class="user-avatar bg-warning">
                                                            <i class="fas fa-bug"></i>
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-0">
                                                        {% if room.is_group_chat %}
                                                            {{ room.name|default:room }}
                                                        {% else %}
                                                            {% with other_user=room|get_other_participant:request.user %}
                                                                {% if other_user %}
                                                                    {{ other_user.get_full_name|default:other_user.username }}
                                                                    {% if other_user.is_currently_online %}
                                                                        <small class="text-success">• Online</small>
                                                                    {% else %}
                                                                        <small class="text-muted">• Offline</small>
                                                                    {% endif %}
                                                                {% elif room.created_by %}
                                                                    {{ room.created_by.get_full_name|default:room.created_by.username }}
                                                                    {% if room.created_by.is_currently_online %}
                                                                        <small class="text-success">• Online</small>
                                                                    {% else %}
                                                                        <small class="text-muted">• Offline</small>
                                                                    {% endif %}
                                                                {% else %}
                                                                    Bug-Meldung
                                                                {% endif %}
                                                            {% endwith %}
                                                        {% endif %}
                                                    </h6>
                                                    {% with last_message=room.get_last_message %}
                                                        {% if last_message %}
                                                            <small class="text-muted">
                                                                {% if last_message.sender %}
                                                                    {{ last_message.sender.get_full_name|default:last_message.sender.username }}
                                                                {% else %}
                                                                    {{ last_message.sender_name|default:"Anonym" }}
                                                                {% endif %}:
                                                                {{ last_message.content|truncatewords:5 }}
                                                            </small>
                                                        {% else %}
                                                            <small class="text-muted">Noch keine Nachrichten</small>
                                                        {% endif %}
                                                    {% endwith %}
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-muted">{{ room.last_message_at|timesince }}</small>
                                                    {% if room.unread_count > 0 %}
                                                        <div class="badge-unread">{{ room.unread_count }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="empty-chat">
                                    <i class="fas fa-comments fa-3x mb-3"></i>
                                    <p>Keine Chats vorhanden</p>
                                    <a href="{% url 'chat:user_search' %}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-search"></i> Nutzer suchen
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Chat Main Area -->
                        <div class="chat-main">
                            <div id="chatHeader" class="chat-header" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div id="chatAvatar" class="user-avatar bg-primary me-3"></div>
                                        <div>
                                            <h6 class="mb-0" id="chatTitle">Chat-Name</h6>
                                            <small class="text-muted" id="chatSubtitle">Informationen</small>
                                        </div>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="startCallWithValidation('audio')"><i class="fas fa-phone"></i> Anrufen</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="startCallWithValidation('video')"><i class="fas fa-video"></i> Videoanruf</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="#" onclick="showChatInfo()"><i class="fas fa-info-circle"></i> Info</a></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteChat()"><i class="fas fa-trash"></i> Löschen</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chat-messages" id="chatMessages">
                                <div class="no-chat-selected">
                                    <i class="fas fa-comments fa-4x mb-3"></i>
                                    <h5>Wählen Sie einen Chat aus</h5>
                                    <p>Klicken Sie auf einen Chat in der Seitenleiste, um die Unterhaltung zu beginnen.</p>
                                </div>
                            </div>
                            
                            <!-- Floating Call Window -->
                            <div id="floatingCallWindow" class="floating-call-window" style="display: none;">
                                <div class="call-header">
                                    <div class="call-info">
                                        <i class="fas fa-phone" id="callIcon"></i>
                                        <span id="callTitle">Anruf</span>
                                        <span id="callStatus" class="call-status-text">Verbinde...</span>
                                    </div>
                                    <div class="call-header-controls">
                                        <button class="btn btn-sm btn-outline-light" id="minimizeBtn" onclick="minimizeCallWindow()" title="Minimieren">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-light" id="maximizeBtn" onclick="maximizeCallWindow()" title="Maximieren">
                                            <i class="fas fa-expand"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-light" onclick="endCall()" title="Beenden">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="call-content">
                                    <div class="call-avatar-container" id="callAvatarContainer">
                                        <div class="call-avatar">
                                            <i class="fas fa-user-circle fa-3x text-primary"></i>
                                        </div>
                                        <h5 id="callParticipantName">Teilnehmer</h5>
                                    </div>
                                    
                                    <!-- Video Elements -->
                                    <div class="video-container" id="videoContainer" style="display: none;">
                                        <video id="remoteVideo" autoplay playsinline class="remote-video"></video>
                                        <video id="localVideo" autoplay muted playsinline class="local-video"></video>
                                    </div>
                                </div>
                                
                                <!-- Call Controls -->
                                <div class="call-controls">
                                    <button class="btn btn-sm btn-outline-light" id="muteBtn" onclick="toggleMute()" title="Stummschalten">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-light" id="videoBtn" onclick="toggleVideo()" style="display: none;" title="Video ein/aus">
                                        <i class="fas fa-video"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" id="endCallBtn" onclick="endCall()" title="Anruf beenden">
                                        <i class="fas fa-phone-slash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="message-input-area" id="messageInput" style="display: none;">
                                <div class="d-flex align-items-end gap-2">
                                    <div class="flex-grow-1">
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="Nachricht eingeben..." id="messageText" onkeypress="handleKeyPress(event)">
                                        </div>
                                        <div id="attachmentPreview" class="mt-2" style="display: none;"></div>
                                    </div>
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-outline-secondary" onclick="document.getElementById('fileInput').click()" title="Datei anhängen">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        <button class="btn btn-primary" onclick="sendMessage()">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect(event)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentRoomId = null;
let messagesContainer = document.getElementById('chatMessages');
let messageInput = document.getElementById('messageText');
let selectedFiles = [];
let attachmentPreview = document.getElementById('attachmentPreview');

// Use global call variables from base.html
// globalCallSocket, globalPeerConnection, globalLocalStream, etc. are defined globally

function loadChat(roomId) {
    // Update active chat room
    document.querySelectorAll('.chat-room-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-room-id="${roomId}"]`).classList.add('active');
    
    currentRoomId = roomId;
    
    // Connect WebSocket for this room
    connectCallWebSocket();
    
    // Mark messages as read when chat is loaded
    markMessagesAsRead(roomId);
    
    // Show chat header and input
    document.getElementById('chatHeader').style.display = 'block';
    document.getElementById('messageInput').style.display = 'block';
    
    // Load messages
    fetch(`/chat/api/room/${roomId}/messages/`)
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                displayMessages(data.messages);
                updateChatHeader(data.room);
            } else {
                console.error('Error loading messages:', data.error);
                alert('Fehler beim Laden der Nachrichten: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Netzwerkfehler beim Laden der Nachrichten');
        });
}

function displayMessages(messages) {
    console.log('displayMessages called with:', messages);
    messagesContainer.innerHTML = '';
    
    if (!messages || messages.length === 0) {
        messagesContainer.innerHTML = `
            <div class="empty-chat">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <p>Noch keine Nachrichten</p>
                <p class="text-muted">Senden Sie die erste Nachricht!</p>
            </div>
        `;
        return;
    }
    
    messages.forEach(message => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `d-flex ${message.is_own ? 'justify-content-end' : 'justify-content-start'} mb-3`;
        
        const isOwn = message.is_own;
        const senderName = message.sender_name || 'Anonym';
        
        let attachmentsHtml = '';
        if (message.attachments && message.attachments.length > 0) {
            attachmentsHtml = '<div class="attachments mt-2">';
            message.attachments.forEach(attachment => {
                if (attachment.is_image) {
                    attachmentsHtml += `
                        <div class="attachment-item mb-2">
                            <img src="${attachment.file_url}" alt="${attachment.filename}" class="img-fluid rounded" style="max-width: 300px; max-height: 200px;">
                            <div class="small text-muted">${attachment.filename} (${attachment.file_size})</div>
                        </div>
                    `;
                } else {
                    attachmentsHtml += `
                        <div class="attachment-item mb-2">
                            <a href="${attachment.file_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-file"></i> ${attachment.filename} (${attachment.file_size})
                            </a>
                        </div>
                    `;
                }
            });
            attachmentsHtml += '</div>';
        }
        
        messageDiv.innerHTML = `
            <div class="message-bubble ${isOwn ? 'message-own' : 'message-other'}">
                ${!isOwn ? `<div class="mb-1"><small><strong>${senderName}</strong></small></div>` : ''}
                <div>${message.content || ''}</div>
                ${attachmentsHtml}
                <div class="mt-1">
                    <small class="opacity-75">${message.formatted_time}</small>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
    });
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function updateChatHeader(room) {
    document.getElementById('chatTitle').textContent = room.name || room.display_name;
    document.getElementById('chatSubtitle').textContent = room.is_group_chat ? 
        `${room.participant_count} Teilnehmer` : 'Privater Chat';
    
    const avatar = document.getElementById('chatAvatar');
    avatar.className = `user-avatar ${room.is_group_chat ? 'bg-success' : 'bg-primary'} me-3`;
    avatar.innerHTML = room.is_group_chat ? '<i class="fas fa-users"></i>' : room.avatar_text;
}

function sendMessage() {
    const messageText = messageInput.value.trim();
    if (!messageText && selectedFiles.length === 0) return;
    if (!currentRoomId) return;
    
    const formData = new FormData();
    formData.append('content', messageText);
    
    // Add attachments
    selectedFiles.forEach(file => {
        formData.append('attachments', file);
    });
    
    fetch(`/chat/api/room/${currentRoomId}/send/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            selectedFiles = [];
            attachmentPreview.style.display = 'none';
            attachmentPreview.innerHTML = '';
            loadChat(currentRoomId); // Reload messages
        } else {
            alert('Fehler beim Senden der Nachricht: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Verbindungsfehler');
    });
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// Search functionality
document.getElementById('chatSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const chatItems = document.querySelectorAll('.chat-room-item');
    
    chatItems.forEach(item => {
        const chatName = item.querySelector('h6').textContent.toLowerCase();
        const lastMessage = item.querySelector('.text-muted').textContent.toLowerCase();
        
        if (chatName.includes(searchTerm) || lastMessage.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
});

// Get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Handle file selection
function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    selectedFiles = files;
    
    if (files.length === 0) {
        attachmentPreview.style.display = 'none';
        return;
    }
    
    let previewHtml = '<div class="selected-files"><strong>Ausgewählte Dateien:</strong><br>';
    files.forEach((file, index) => {
        const fileSize = formatFileSize(file.size);
        previewHtml += `
            <div class="file-item d-flex align-items-center gap-2 mb-1">
                <i class="fas fa-file"></i>
                <span>${file.name} (${fileSize})</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });
    previewHtml += '</div>';
    
    attachmentPreview.innerHTML = previewHtml;
    attachmentPreview.style.display = 'block';
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    if (selectedFiles.length === 0) {
        attachmentPreview.style.display = 'none';
    } else {
        // Update preview
        handleFileSelect({ target: { files: selectedFiles } });
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Mark messages as read
function markMessagesAsRead(roomId) {
    fetch(`/chat/api/room/${roomId}/mark_read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update chat notification counter
            if (window.updateChatNotifications) {
                window.updateChatNotifications();
            }
            // Update unread badges in chat list
            updateUnreadBadges();
        }
    })
    .catch(error => {
        console.error('Error marking messages as read:', error);
    });
}

// Update unread badges in chat list
function updateUnreadBadges() {
    const roomItem = document.querySelector(`[data-room-id="${currentRoomId}"]`);
    if (roomItem) {
        const unreadBadge = roomItem.querySelector('.badge-unread');
        if (unreadBadge) {
            unreadBadge.style.display = 'none';
        }
    }
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Auto-refresh messages every 5 seconds (but not during active calls)
setInterval(() => {
    if (currentRoomId && !globalIsCallActive) {
        loadChat(currentRoomId);
    }
}, 5000);

// Check for room parameter in URL and load chat
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');
    if (roomId) {
        loadChat(parseInt(roomId));
        // Connect WebSocket for calls when room is loaded
        setTimeout(() => {
            currentRoomId = parseInt(roomId);
            connectCallWebSocket();
        }, 500);
        
        // Check if we should auto-answer a call
        const answerCallId = urlParams.get('answerCall');
        if (answerCallId) {
            setTimeout(() => {
                // Find call type from URL or default to audio
                const callType = urlParams.get('callType') || 'audio';
                answerCall(answerCallId, callType);
            }, 1000); // Wait 1 second for room to load
        }
    }
});

// Update online status every 30 seconds (but not during calls)
setInterval(() => {
    if (!globalIsCallActive) {
        fetch('/chat/update-online-status/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Error updating online status:', data.error);
            }
        })
        .catch(error => {
            console.error('Error updating online status:', error);
        });
    }
}, 30000);

// Update online status immediately when page loads
document.addEventListener('DOMContentLoaded', function() {
    fetch('/chat/update-online-status/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    });
});

// Delete chat function
function deleteChat() {
    if (!currentRoomId) {
        alert('Kein Chat ausgewählt');
        return;
    }
    
    if (confirm('Sind Sie sicher, dass Sie diesen Chat löschen möchten?')) {
        fetch(`/chat/api/room/${currentRoomId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Remove chat from list
                const chatItem = document.querySelector(`[data-room-id="${currentRoomId}"]`);
                if (chatItem) {
                    chatItem.remove();
                }
                // Clear chat area
                document.getElementById('chatMessages').innerHTML = '';
                document.getElementById('chatHeader').style.display = 'none';
                document.getElementById('messageInput').style.display = 'none';
                currentRoomId = null;
                // Reload page to refresh chat list
                window.location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting chat:', error);
            alert('Fehler beim Löschen des Chats');
        });
    }
}

// Call validation wrapper function
function startCallWithValidation(callType) {
    console.log('🔍 Starting call validation...');
    console.log('Current room ID:', currentRoomId);
    console.log('Call type:', callType);
    
    // Check if currentRoomId is defined
    if (!currentRoomId) {
        console.error('❌ No room selected');
        alert('Bitte wählen Sie zuerst einen Chat aus.');
        return;
    }
    
    // Check if globalStartCall function exists
    if (typeof globalStartCall !== 'function') {
        console.error('❌ globalStartCall function not found');
        console.log('Available global functions:', Object.keys(window).filter(key => key.includes('global')));
        alert('Anruf-System nicht verfügbar. Bitte laden Sie die Seite neu.');
        return;
    }
    
    // Check if we're in the right context
    if (typeof window.globalStartCall !== 'function' && typeof parent.globalStartCall !== 'function') {
        console.error('❌ globalStartCall not found in window or parent');
        alert('Anruf-System nicht geladen. Bitte warten Sie einen Moment und versuchen Sie es erneut.');
        return;
    }
    
    console.log('✅ Validation passed, starting call...');
    
    // Call the global function
    try {
        // Try global function first
        if (typeof globalStartCall === 'function') {
            globalStartCall(currentRoomId, callType);
        } else if (typeof window.globalStartCall === 'function') {
            window.globalStartCall(currentRoomId, callType);
        } else {
            // Fallback to local implementation
            console.log('🔄 Using fallback local call implementation');
            startLocalCall(currentRoomId, callType);
        }
    } catch (error) {
        console.error('❌ Error calling start call function:', error);
        alert('Fehler beim Starten des Anrufs: ' + (error.message || error));
    }
}

// Fallback local call implementation
async function startLocalCall(roomId, callType) {
    try {
        console.log('📞 Starting local call implementation:', roomId, callType);
        
        const csrfToken = getCookie('csrftoken') || 
                         document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        
        if (!csrfToken) {
            throw new Error('CSRF-Token nicht gefunden');
        }
        
        const response = await fetch(`/chat/api/room/${roomId}/call/initiate/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                call_type: callType
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        console.log('📋 Local call response:', result);
        
        if (result.success) {
            alert(`${callType === 'video' ? 'Video' : 'Audio'}-Anruf gestartet! (Call ID: ${result.call_id})`);
        } else {
            throw new Error(result.error || 'Anruf konnte nicht gestartet werden');
        }
        
    } catch (error) {
        console.error('❌ Local call error:', error);
        throw error;
    }
}

// Show chat info function
function showChatInfo() {
    if (!currentRoomId) {
        alert('Kein Chat ausgewählt');
        return;
    }
    
    // Show modal immediately with loading state
    const modal = new bootstrap.Modal(document.getElementById('chatInfoModal'));
    modal.show();
    
    // Reset content to loading state
    document.getElementById('chatInfoContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Lade Chat-Informationen...</p>
        </div>
    `;
    
    // Fetch chat info
    fetch(`/chat/api/room/${currentRoomId}/info/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderChatInfo(data.room);
        } else {
            document.getElementById('chatInfoContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Fehler beim Laden der Chat-Informationen: ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading chat info:', error);
        document.getElementById('chatInfoContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> 
                Fehler beim Laden der Chat-Informationen
            </div>
        `;
    });
}

function renderChatInfo(roomData) {
    // Update modal title
    document.getElementById('chatInfoTitle').textContent = 
        roomData.name || (roomData.is_group_chat ? 'Gruppenchat' : 'Privater Chat');
    
    let content = '';
    
    // Chat Overview Section
    content += `
        <div class="row mb-4">
            <div class="col-12">
                <div class="card chat-info-card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-comments stat-icon text-primary"></i> Chat-Übersicht
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <i class="fas fa-tag stat-icon text-info"></i>
                                    <strong>Name:</strong> ${roomData.name || 'Privater Chat'}
                                </div>
                                <div class="mb-3">
                                    <i class="fas fa-${roomData.is_group_chat ? 'users' : 'user'} stat-icon text-info"></i>
                                    <strong>Typ:</strong> ${roomData.is_group_chat ? 'Gruppenchat' : 'Privater Chat'}
                                </div>
                                <div class="mb-3">
                                    <i class="fas fa-calendar-plus stat-icon text-info"></i>
                                    <strong>Erstellt am:</strong> ${roomData.created_at}
                                </div>
                                ${roomData.created_by ? `
                                    <div class="mb-3">
                                        <i class="fas fa-user-plus stat-icon text-info"></i>
                                        <strong>Erstellt von:</strong> ${roomData.created_by.name}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <i class="fas fa-users stat-icon text-success"></i>
                                    <strong>Teilnehmer:</strong> ${roomData.participants_count}
                                </div>
                                <div class="mb-3">
                                    <i class="fas fa-comments stat-icon text-success"></i>
                                    <strong>Gesamte Nachrichten:</strong> ${roomData.total_messages}
                                </div>
                                <div class="mb-3">
                                    <i class="fas fa-clock stat-icon text-success"></i>
                                    <strong>Letzte 7 Tage:</strong> ${roomData.recent_messages_count} Nachrichten
                                </div>
                                ${roomData.last_message_at ? `
                                    <div class="mb-3">
                                        <i class="fas fa-paper-plane stat-icon text-success"></i>
                                        <strong>Letzte Nachricht:</strong> ${roomData.last_message_at}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Participants Section
    content += `
        <div class="row">
            <div class="col-12">
                <div class="card chat-info-card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-users stat-icon text-primary"></i> 
                            Teilnehmer (${roomData.participants_count})
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
    `;
    
    // Render each participant
    roomData.participants_detailed.forEach(participant => {
        const fallbackAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(participant.name)}&size=80&background=007bff&color=ffffff&bold=true`;
        const avatarUrl = participant.profile_picture || fallbackAvatar;
        
        content += `
            <div class="col-md-6 mb-3">
                <div class="participant-card d-flex align-items-center p-3 border rounded ${participant.is_current_user ? 'bg-light border-primary' : ''}">
                    <div class="position-relative me-3">
                        <img src="${avatarUrl}" alt="${participant.name}" 
                             class="chat-info-avatar"
                             onerror="this.src='${fallbackAvatar}'">
                        <span class="position-absolute bottom-0 end-0 online-indicator ${participant.is_online ? 'bg-success' : 'bg-secondary'}"></span>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 d-flex align-items-center">
                            ${participant.name}
                            ${participant.is_current_user ? '<span class="badge bg-primary ms-2 small">Sie</span>' : ''}
                        </h6>
                        <p class="mb-2 text-muted small">
                            <i class="fas fa-at text-info"></i> ${participant.username}
                        </p>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge ${participant.is_online ? 'bg-success' : 'bg-secondary'} me-2">
                                <i class="fas fa-circle small"></i> ${participant.is_online ? 'Online' : 'Offline'}
                            </span>
                            ${participant.is_current_user || !participant.email ? '' : 
                                `<small class="text-muted">
                                    <i class="fas fa-envelope text-info"></i> ${participant.email}
                                </small>`
                            }
                        </div>
                        ${participant.last_activity ? 
                            `<small class="text-muted d-block">
                                <i class="fas fa-clock text-info"></i> Letzte Aktivität: ${participant.last_activity}
                            </small>` : ''
                        }
                        <small class="text-muted d-block">
                            <i class="fas fa-user-plus text-info"></i> Beigetreten: ${participant.date_joined}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });
    
    content += `
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('chatInfoContent').innerHTML = content;
}

// WebRTC and Call Variables - using globals from base.html
let remoteStream = null;
let callSocket = null; // Keep local for this page's WebSocket connection

// WebRTC configuration
const rtcConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

// Floating window functions
function minimizeCallWindow() {
    const floatingWindow = document.getElementById('floatingCallWindow');
    floatingWindow.classList.add('minimized');
}

function maximizeCallWindow() {
    const floatingWindow = document.getElementById('floatingCallWindow');
    floatingWindow.classList.remove('minimized');
    floatingWindow.classList.add('maximized');
}

function showFloatingCallWindow() {
    const floatingWindow = document.getElementById('floatingCallWindow');
    floatingWindow.style.display = 'flex';
    makeFloatingWindowDraggable();
}

function hideFloatingCallWindow() {
    const floatingWindow = document.getElementById('floatingCallWindow');
    floatingWindow.style.display = 'none';
    floatingWindow.classList.remove('minimized', 'maximized');
}

function makeFloatingWindowDraggable() {
    const floatingWindow = document.getElementById('floatingCallWindow');
    const header = floatingWindow.querySelector('.call-header');
    
    let isDragging = false;
    let startX, startY, startLeft, startTop;
    
    header.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = parseInt(window.getComputedStyle(floatingWindow).left);
        startTop = parseInt(window.getComputedStyle(floatingWindow).top);
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });
    
    function onMouseMove(e) {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        floatingWindow.style.left = (startLeft + deltaX) + 'px';
        floatingWindow.style.top = (startTop + deltaY) + 'px';
        floatingWindow.style.right = 'auto';
        floatingWindow.style.bottom = 'auto';
    }
    
    function onMouseUp() {
        isDragging = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }
}

// Initiate a call
function initiateCall(callType) {
    if (!currentRoomId) {
        alert('Kein Chat ausgewählt');
        return;
    }
    
    if (globalIsCallActive) {
        alert('Es läuft bereits ein Anruf');
        return;
    }
    
    // Check if WebSocket error exists (call functionality not available)
    if (document.getElementById('websocket-error')) {
        alert('Die Anruf-Funktion ist momentan nicht verfügbar. WebSocket-Verbindung fehlgeschlagen.');
        return;
    }
    
    // Show global floating call window
    showGlobalCallWindow();
    
    // Update UI
    document.getElementById('globalCallTitle').textContent = callType === 'video' ? 'Videoanruf' : 'Anruf';
    document.getElementById('globalCallIcon').className = callType === 'video' ? 'fas fa-video' : 'fas fa-phone';
    document.getElementById('globalCallStatus').textContent = 'Startet Anruf...';
    
    // Show/hide video controls
    if (callType === 'video') {
        document.getElementById('globalVideoBtn').style.display = 'inline-block';
        document.getElementById('globalVideoContainer').style.display = 'block';
        globalIsVideoEnabled = true;
    } else {
        document.getElementById('globalVideoBtn').style.display = 'none';
        document.getElementById('globalVideoContainer').style.display = 'none';
        globalIsVideoEnabled = false;
    }
    
    // Start call
    startCall(callType);
}

// Start call process
async function startCall(callType) {
    try {
        // Get user media
        const constraints = {
            audio: true,
            video: callType === 'video'
        };
        
        globalLocalStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        if (callType === 'video') {
            document.getElementById('globalLocalVideo').srcObject = globalLocalStream;
        }
        
        // Create WebSocket connection
        connectCallWebSocket();
        
        // Initiate call via API
        const response = await fetch(`/chat/api/room/${currentRoomId}/call/initiate/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                call_type: callType
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            globalCurrentCallId = data.call_id;
            globalIsCallActive = true;
            document.getElementById('globalCallStatus').textContent = 'Ruft an...';
            
            console.log('DEBUG: Call created successfully, ID:', globalCurrentCallId);
            
            // Send call initiation through WebSocket
            if (callSocket && callSocket.readyState === WebSocket.OPEN) {
                console.log('Sending call initiate via WebSocket', {
                    type: 'call_initiate',
                    call_type: callType,
                    call_id: globalCurrentCallId
                });
                callSocket.send(JSON.stringify({
                    type: 'call_initiate',
                    call_type: callType,
                    call_id: globalCurrentCallId
                }));
            } else {
                console.error('DEBUG: WebSocket not available:', callSocket?.readyState);
                // WebSocket not available, show error message
                document.getElementById('globalCallStatus').textContent = 'WebSocket-Verbindung fehlgeschlagen';
                showWebSocketError();
                setTimeout(() => {
                    endCall();
                }, 2000);
            }
        } else {
            alert('Fehler beim Starten des Anrufs: ' + data.error);
            endCall();
        }
        
    } catch (error) {
        console.error('Error starting call:', error);
        alert('Fehler beim Zugriff auf Mikrofon/Kamera');
        endCall();
    }
}

// Connect to call WebSocket
function connectCallWebSocket() {
    if (callSocket && callSocket.readyState === WebSocket.OPEN) {
        console.log('WebSocket already connected');
        return;
    }
    
    if (callSocket) {
        callSocket.close();
    }
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    // Use the same host and port as the current page
    const wsHost = window.location.host;
    const wsUrl = `${protocol}//${wsHost}/ws/call/${currentRoomId}/`;
    
    console.log('🔌 Connecting to Call WebSocket:', wsUrl);
    callSocket = new WebSocket(wsUrl);
    
    callSocket.onopen = function(e) {
        console.log('Call WebSocket connected');
        // Hide any previous connection error messages
        hideWebSocketError();
    };
    
    callSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        handleCallMessage(data);
    };
    
    callSocket.onclose = function(e) {
        console.log('Call WebSocket disconnected');
        if (e.code !== 1000) {
            showWebSocketError();
        }
    };
    
    callSocket.onerror = function(e) {
        console.error('Call WebSocket error:', e);
        showWebSocketError();
    };
}

// Show WebSocket connection error
function showWebSocketError() {
    const errorDiv = document.createElement('div');
    errorDiv.id = 'websocket-error';
    errorDiv.className = 'alert alert-warning alert-dismissible fade show';
    errorDiv.style.position = 'fixed';
    errorDiv.style.top = '10px';
    errorDiv.style.right = '10px';
    errorDiv.style.zIndex = '9999';
    errorDiv.innerHTML = `
        <strong>Anruf-Funktion nicht verfügbar:</strong> WebSocket-Verbindung fehlgeschlagen. 
        Die Anruf-Funktion ist momentan nicht verfügbar.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Remove any existing error message
    const existing = document.getElementById('websocket-error');
    if (existing) {
        existing.remove();
    }
    
    document.body.appendChild(errorDiv);
    
    // Hide call buttons
    document.querySelectorAll('.call-btn').forEach(btn => {
        btn.style.display = 'none';
    });
}

// Hide WebSocket error message
function hideWebSocketError() {
    const errorDiv = document.getElementById('websocket-error');
    if (errorDiv) {
        errorDiv.remove();
    }
    
    // Show call buttons
    document.querySelectorAll('.call-btn').forEach(btn => {
        btn.style.display = 'inline-block';
    });
}

// Handle call messages from WebSocket
function handleCallMessage(data) {
    console.log('Received call message:', data);
    switch(data.type) {
        case 'call_initiated':
            if (data.caller !== '{{ user.username }}') {
                console.log('Incoming call from:', data.caller);
                handleIncomingCall(data);
            }
            break;
        case 'call_answered':
            handleCallAnswered(data);
            break;
        case 'call_rejected':
            handleCallRejected(data);
            break;
        case 'call_ended':
            handleCallEnded(data);
            break;
        case 'webrtc_offer':
            handleWebRTCOffer(data);
            break;
        case 'webrtc_answer':
            handleWebRTCAnswer(data);
            break;
        case 'webrtc_ice_candidate':
            handleWebRTCIceCandidate(data);
            break;
    }
}

// Handle incoming call
function handleIncomingCall(data) {
    console.log('handleIncomingCall called with:', data);
    
    if (globalIsCallActive) {
        console.log('Already in a call, ignoring');
        return; // Already in a call
    }
    
    // Create notification element directly
    const notification = document.createElement('div');
    notification.className = 'call-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 20px;
        min-width: 300px;
        animation: slideIn 0.3s ease-out;
    `;
    notification.innerHTML = `
        <div class="d-flex align-items-center mb-3">
            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                <i class="fas fa-${data.call_type === 'video' ? 'video' : 'phone'} fa-lg"></i>
            </div>
            <div>
                <h5 class="mb-1">Eingehender ${data.call_type === 'video' ? 'Video' : 'Audio'}-Anruf</h5>
                <p class="mb-0 text-muted">von ${data.caller}</p>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success flex-fill" onclick="answerCall('${data.call_id}', '${data.call_type}')">
                <i class="fas fa-phone"></i> Annehmen
            </button>
            <button class="btn btn-danger flex-fill" onclick="rejectCall('${data.call_id}'); this.closest('.call-notification').remove();">
                <i class="fas fa-phone-slash"></i> Ablehnen
            </button>
        </div>
    `;
    
    // Add CSS animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(notification);
    
    // Play sound notification
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
        audio.play().catch(e => console.log('Could not play sound:', e));
    } catch (e) {
        console.log('Audio not supported:', e);
    }
    
    // Auto-remove after 30 seconds
    setTimeout(() => {
        if (document.body.contains(notification)) {
            notification.remove();
        }
    }, 30000);
}

// Answer incoming call
async function answerCall(callId, callType) {
    try {
        globalCurrentCallId = callId;
        globalIsCallActive = true;
        
        // Show global floating call window
        showGlobalCallWindow();
        
        // Update UI
        document.getElementById('globalCallTitle').textContent = callType === 'video' ? 'Videoanruf' : 'Anruf';
        document.getElementById('globalCallIcon').className = callType === 'video' ? 'fas fa-video' : 'fas fa-phone';
        document.getElementById('globalCallStatus').textContent = 'Verbunden';
        
        // Get user media
        const constraints = {
            audio: true,
            video: callType === 'video'
        };
        
        globalLocalStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        if (callType === 'video') {
            document.getElementById('globalLocalVideo').srcObject = globalLocalStream;
            document.getElementById('globalVideoContainer').style.display = 'block';
            document.getElementById('globalVideoBtn').style.display = 'inline-block';
            globalIsVideoEnabled = true;
        }
        
        // Ensure WebSocket connection
        if (!callSocket || callSocket.readyState !== WebSocket.OPEN) {
            connectCallWebSocket();
            // Wait a bit for connection
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // Create peer connection
        createPeerConnection();
        
        // Send answer through WebSocket
        if (callSocket && callSocket.readyState === WebSocket.OPEN) {
            callSocket.send(JSON.stringify({
                type: 'call_answer',
                call_id: callId
            }));
        } else {
            throw new Error('WebSocket connection failed');
        }
        
    } catch (error) {
        console.error('Error answering call:', error);
        alert('Fehler beim Annehmen des Anrufs');
        endCall();
    }
}

// Reject incoming call
function rejectCall(callId) {
    if (callSocket && callSocket.readyState === WebSocket.OPEN) {
        callSocket.send(JSON.stringify({
            type: 'call_reject',
            call_id: callId
        }));
    }
}

// Create peer connection
function createPeerConnection() {
    globalPeerConnection = new RTCPeerConnection(rtcConfig);
    
    // Add local stream to peer connection
    if (globalLocalStream) {
        globalLocalStream.getTracks().forEach(track => {
            globalPeerConnection.addTrack(track, globalLocalStream);
        });
    }
    
    // Handle remote stream
    globalPeerConnection.ontrack = function(event) {
        remoteStream = event.streams[0];
        document.getElementById('globalRemoteVideo').srcObject = remoteStream;
    };
    
    // Handle ICE candidates
    globalPeerConnection.onicecandidate = function(event) {
        if (event.candidate && callSocket && callSocket.readyState === WebSocket.OPEN) {
            callSocket.send(JSON.stringify({
                type: 'webrtc_ice_candidate',
                candidate: event.candidate
            }));
        }
    };
    
    // Handle connection state changes
    globalPeerConnection.onconnectionstatechange = function() {
        console.log('Connection state:', globalPeerConnection.connectionState);
        if (globalPeerConnection.connectionState === 'connected') {
            document.getElementById('globalCallStatus').textContent = 'Verbunden';
        } else if (globalPeerConnection.connectionState === 'disconnected') {
            globalEndCall();
        }
    };
}

// Handle WebRTC offer
async function handleWebRTCOffer(data) {
    try {
        if (!globalPeerConnection) {
            createPeerConnection();
        }
        
        await globalPeerConnection.setRemoteDescription(data.offer);
        const answer = await globalPeerConnection.createAnswer();
        await globalPeerConnection.setLocalDescription(answer);
        
        if (callSocket && callSocket.readyState === WebSocket.OPEN) {
            callSocket.send(JSON.stringify({
                type: 'webrtc_answer',
                answer: answer
            }));
        }
    } catch (error) {
        console.error('Error handling WebRTC offer:', error);
    }
}

// Handle WebRTC answer
async function handleWebRTCAnswer(data) {
    try {
        if (globalPeerConnection) {
            await globalPeerConnection.setRemoteDescription(data.answer);
        }
    } catch (error) {
        console.error('Error handling WebRTC answer:', error);
    }
}

// Handle WebRTC ICE candidate
async function handleWebRTCIceCandidate(data) {
    try {
        if (globalPeerConnection) {
            await globalPeerConnection.addIceCandidate(data.candidate);
        }
    } catch (error) {
        console.error('Error handling ICE candidate:', error);
    }
}

// Toggle mute
function toggleMute() {
    if (globalLocalStream) {
        const audioTrack = globalLocalStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            globalIsMuted = !audioTrack.enabled;
            
            const muteBtn = document.getElementById('globalMuteBtn');
            if (globalIsMuted) {
                muteBtn.classList.remove('btn-outline-light');
                muteBtn.classList.add('btn-danger');
                muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            } else {
                muteBtn.classList.remove('btn-danger');
                muteBtn.classList.add('btn-outline-light');
                muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }
    }
}

// Toggle video
function toggleVideo() {
    if (globalLocalStream) {
        const videoTrack = globalLocalStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            globalIsVideoEnabled = videoTrack.enabled;
            
            const videoBtn = document.getElementById('globalVideoBtn');
            if (!globalIsVideoEnabled) {
                videoBtn.classList.remove('btn-outline-light');
                videoBtn.classList.add('btn-danger');
                videoBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
            } else {
                videoBtn.classList.remove('btn-danger');
                videoBtn.classList.add('btn-outline-light');
                videoBtn.innerHTML = '<i class="fas fa-video"></i>';
            }
        }
    }
}

// End call
function endCall() {
    // Send end call message
    if (callSocket && callSocket.readyState === WebSocket.OPEN && globalCurrentCallId) {
        callSocket.send(JSON.stringify({
            type: 'call_end',
            call_id: globalCurrentCallId
        }));
    }
    
    // Clean up WebRTC
    if (globalPeerConnection) {
        globalPeerConnection.close();
        globalPeerConnection = null;
    }
    
    // Clean up media streams
    if (globalLocalStream) {
        globalLocalStream.getTracks().forEach(track => track.stop());
        globalLocalStream = null;
    }
    
    if (remoteStream) {
        remoteStream.getTracks().forEach(track => track.stop());
        remoteStream = null;
    }
    
    // Close WebSocket
    if (callSocket) {
        callSocket.close();
        callSocket = null;
    }
    
    // Reset state
    globalIsCallActive = false;
    globalCurrentCallId = null;
    globalIsMuted = false;
    globalIsVideoEnabled = false;
    
    // Hide global floating call window
    hideGlobalCallWindow();
    
    // Reset UI
    document.getElementById('globalCallStatus').textContent = 'Verbinde...';
    document.getElementById('globalMuteBtn').className = 'btn btn-sm btn-outline-light';
    document.getElementById('globalMuteBtn').innerHTML = '<i class="fas fa-microphone"></i>';
    document.getElementById('globalVideoBtn').className = 'btn btn-sm btn-outline-light';
    document.getElementById('globalVideoBtn').innerHTML = '<i class="fas fa-video"></i>';
    document.getElementById('globalLocalVideo').srcObject = null;
    document.getElementById('globalRemoteVideo').srcObject = null;
}

// Handle call events
function handleCallAnswered(data) {
    document.getElementById('callStatus').textContent = 'Verbunden';
    
    // Create peer connection and send offer
    createPeerConnection();
    
    setTimeout(async () => {
        try {
            const offer = await globalPeerConnection.createOffer();
            await globalPeerConnection.setLocalDescription(offer);
            
            if (callSocket && callSocket.readyState === WebSocket.OPEN) {
                callSocket.send(JSON.stringify({
                    type: 'webrtc_offer',
                    offer: offer
                }));
            }
        } catch (error) {
            console.error('Error creating offer:', error);
        }
    }, 1000);
}

function handleCallRejected(data) {
    alert('Anruf wurde abgelehnt');
    endCall();
}

function handleCallEnded(data) {
    alert('Anruf wurde beendet');
    endCall();
}
</script>

<!-- Chat Info Modal -->
<div class="modal fade" id="chatInfoModal" tabindex="-1" aria-labelledby="chatInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="chatInfoModalLabel">
                    <i class="fas fa-info-circle"></i> <span id="chatInfoTitle">Chat-Informationen</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="chatInfoContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Lade Chat-Informationen...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}