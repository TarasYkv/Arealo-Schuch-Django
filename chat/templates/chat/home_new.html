{% extends 'base.html' %}
{% load static %}

{% block title %}Chat System{% endblock %}

{% block content %}
<div class="chat-app">
    <div class="chat-sidebar">
        <div class="chat-header-fixed">
            <h4><i class="fas fa-comments me-2"></i>Chats</h4>
            <button class="btn btn-outline-primary btn-sm" onclick="createNewChat()">
                <i class="fas fa-plus"></i> Neuer Chat
            </button>
        </div>

        <div class="search-container">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="chatSearch" placeholder="Chats durchsuchen...">
            </div>
        </div>

        <div class="chat-list-container">
            {% for room in chat_rooms %}
            <div class="chat-item" data-room-id="{{ room.id }}">
                <div class="chat-item-content" onclick="chatManager.loadChat({{ room.id }})">
                <div class="chat-avatar">
                    {% if room.is_group_chat %}
                        <i class="fas fa-users"></i>
                    {% elif room.profile_picture_url %}
                        <img src="{{ room.profile_picture_url }}" alt="Profilbild" class="profile-image">
                    {% else %}
                        <span class="avatar-text">{{ room.avatar_text }}</span>
                    {% endif %}
                </div>
                <div class="chat-info">
                    <div class="chat-name">{{ room.display_name|default:room.name }}</div>
                    <div class="chat-meta-line">
                        {% if not room.is_group_chat %}
                            <span class="online-status {{ room.online_status_class|default:'text-muted' }}">
                                <i class="fas fa-circle" style="font-size: 0.6rem;"></i>
                                {{ room.online_status_text|default:"Offline" }}
                            </span>
                        {% endif %}
                        <div class="chat-preview">{{ room.last_message|default:"Keine Nachrichten" }}</div>
                    </div>
                </div>
                <div class="chat-meta">
                    <div class="chat-time">{{ room.last_message_time|date:"H:i"|default:"" }}</div>
                    {% if room.unread_count > 0 %}
                    <span class="unread-badge">{{ room.unread_count }}</span>
                    {% endif %}
                </div>
                </div>
                <div class="chat-item-actions">
                    <button class="btn-delete-chat" onclick="deleteChat({{ room.id }}, event)" title="Chat lÃ¶schen">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="chat-main">
        <div class="chat-welcome" id="chatWelcome">
            <div class="welcome-content">
                <i class="fas fa-comments fa-4x mb-3"></i>
                <h3>Willkommen im Chat</h3>
                <p class="text-muted">WÃ¤hlen Sie einen Chat aus der Liste, um zu beginnen</p>
            </div>
        </div>

        <div class="active-chat" id="activeChat" style="display: none;">
            <div class="chat-header-main">
                <div class="chat-info-main">
                    <div class="chat-avatar-main">
                        <div id="activeChatAvatar">ğŸ‘¤</div>
                    </div>
                    <div class="chat-details">
                        <h5 id="activeChatName">Chat Name</h5>
                        <small id="activeChatStatus" class="text-muted">Online Status</small>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="btn btn-outline-secondary btn-sm" onclick="showChatInfo()" title="Benutzerinformationen">
                        <i class="fas fa-info-circle"></i>
                        <span class="ms-1">Info</span>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteCurrentChat()" title="Chat lÃ¶schen">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="messages-area" id="messagesArea">
                <div class="messages-content" id="messagesContent">
                    <!-- Messages will be loaded here -->
                </div>
            </div>

            <div class="message-input-area">
                <div class="input-container">
                    <div class="input-group">
                        <input type="file" id="fileInput" multiple style="display: none;" accept="*/*">
                        <button class="btn btn-outline-secondary" type="button" onclick="openFileDialog()" title="Datei anhÃ¤ngen">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="toggleEmojiPicker()" title="Emojis">
                            <i class="fas fa-smile"></i>
                        </button>
                        <input type="text" class="form-control" id="messageInput"
                               placeholder="Nachricht eingeben..." onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" onclick="chatManager.sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <!-- Emoji Picker -->
                    <div id="emojiPicker" class="emoji-picker" style="display: none;">
                        <div class="emoji-picker-header">
                            <i class="fas fa-smile me-2"></i>
                            <span>Emojis auswÃ¤hlen</span>
                            <button type="button" class="btn-close btn-sm" onclick="toggleEmojiPicker()"></button>
                        </div>
                        <div class="emoji-picker-tabs">
                            <button class="emoji-tab active" onclick="showEmojiCategory('smileys')" title="Smileys & Emotionen">ğŸ˜€</button>
                            <button class="emoji-tab" onclick="showEmojiCategory('gestures')" title="Gesten">ğŸ‘‹</button>
                            <button class="emoji-tab" onclick="showEmojiCategory('hearts')" title="Herzen">â¤ï¸</button>
                            <button class="emoji-tab" onclick="showEmojiCategory('symbols')" title="Symbole">â­</button>
                        </div>
                        <div class="emoji-picker-content">
                            <!-- Emojis will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Info Modal -->
<div class="modal fade" id="chatInfoModal" tabindex="-1" aria-labelledby="chatInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="chatInfoModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Chat-Informationen
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="SchlieÃŸen"></button>
            </div>
            <div class="modal-body">
                <div id="chatInfoContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Laden...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="exportChatToPDF()" id="exportChatBtn">
                    <i class="fas fa-file-pdf me-2"></i>Als PDF exportieren
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">SchlieÃŸen</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Reset and base styles */
* {
    box-sizing: border-box;
}

/* Dark Mode Variables */
{% if user.is_authenticated and user.dark_mode %}
:root {
    --chat-bg-primary: #212529;
    --chat-bg-secondary: #343a40;
    --chat-bg-tertiary: #495057;
    --chat-text-primary: #ffffff;
    --chat-text-secondary: #adb5bd;
    --chat-border: #495057;
    --chat-hover: #6c757d;
}
{% else %}
:root {
    --chat-bg-primary: #ffffff;
    --chat-bg-secondary: #f8f9fa;
    --chat-bg-tertiary: #ffffff;
    --chat-text-primary: #212529;
    --chat-text-secondary: #6c757d;
    --chat-border: #e9ecef;
    --chat-hover: #f8f9fa;
}
{% endif %}

.chat-app {
    display: flex;
    height: 100vh;
    max-height: 100vh;
    background: var(--chat-bg-primary);
    color: var(--chat-text-primary);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Sidebar styles */
.chat-sidebar {
    width: 350px;
    background: var(--chat-bg-secondary);
    border-right: 1px solid var(--chat-border);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.chat-header-fixed {
    padding: 20px;
    border-bottom: 1px solid var(--chat-border);
    background: var(--chat-bg-tertiary);
    color: var(--chat-text-primary);
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.search-container {
    padding: 15px 20px;
    background: var(--chat-bg-tertiary);
    border-bottom: 1px solid var(--chat-border);
    flex-shrink: 0;
}

.chat-list-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 0;
}

/* Chat item styles */
.chat-item {
    display: flex;
    padding: 15px 20px;
    cursor: pointer;
    border-bottom: 1px solid var(--chat-border);
    transition: background-color 0.2s;
    position: relative;
}

.chat-item:hover {
    background: var(--chat-hover);
}

.chat-item.active {
    background: var(--chat-hover);
}

.chat-item-content {
    display: flex;
    flex: 1;
    align-items: center;
    min-width: 0;
}

.chat-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    flex-shrink: 0;
    margin-right: 15px;
}

.chat-info {
    flex: 1;
    min-width: 0;
}

.chat-name {
    font-weight: 600;
    color: var(--chat-text-primary);
    margin-bottom: 5px;
}

.chat-preview {
    color: var(--chat-text-secondary);
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.unread-badge {
    background: #dc3545;
    color: white;
    border-radius: 10px;
    padding: 2px 8px;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Main chat area */
.chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--chat-bg-primary);
}

.chat-welcome {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.active-chat {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.chat-header-main {
    padding: 20px;
    border-bottom: 1px solid var(--chat-border);
    background: var(--chat-bg-tertiary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.messages-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.message-input-area {
    padding: 20px;
    border-top: 1px solid var(--chat-border);
    background: var(--chat-bg-tertiary);
    position: relative;
}

/* Emoji Picker Styles */
.emoji-picker {
    position: absolute;
    bottom: 100%;
    left: 50px;
    width: 320px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid #e1e4e8;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.08);
    z-index: 1000;
    margin-bottom: 10px;
    animation: slideUp 0.2s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.emoji-picker-header {
    padding: 12px 16px;
    border-bottom: 1px solid #e1e4e8;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 11px 11px 0 0;
    font-weight: 600;
    font-size: 14px;
}

.emoji-picker-header .btn-close {
    filter: brightness(0) invert(1);
    opacity: 0.8;
    transition: opacity 0.2s;
}

.emoji-picker-header .btn-close:hover {
    opacity: 1;
}

.emoji-picker-tabs {
    display: flex;
    padding: 8px 12px;
    background: #f8f9fa;
    border-bottom: 1px solid #e1e4e8;
    gap: 4px;
}

.emoji-tab {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 6px;
    transition: all 0.2s ease;
    opacity: 0.6;
}

.emoji-tab:hover {
    opacity: 1;
    background: rgba(102, 126, 234, 0.1);
}

.emoji-tab.active {
    opacity: 1;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    transform: scale(1.05);
}

.emoji-picker-content {
    padding: 12px;
    max-height: 280px;
    overflow-y: auto;
    overflow-x: hidden;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    box-sizing: border-box;
    width: 100%;
}

/* Custom scrollbar */
.emoji-picker-content::-webkit-scrollbar {
    width: 6px;
}

.emoji-picker-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.emoji-picker-content::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.emoji-picker-content::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}

.emoji-btn {
    background: transparent;
    border: none;
    font-size: 22px;
    cursor: pointer;
    padding: 6px;
    border-radius: 8px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    aspect-ratio: 1;
}

.emoji-btn:hover {
    background: linear-gradient(135deg, #f0f3ff 0%, #e8ebff 100%);
    transform: scale(1.15);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
}

/* Attachment Styles */
.message-attachments {
    margin: 8px 0;
    min-height: 40px;
}

.attachment-item {
    margin: 4px 0;
    padding: 8px;
    border: 1px solid #e1e4e8;
    border-radius: 8px;
    background: #f8f9fa;
}

.attachment-item.image {
    display: inline-block;
    max-width: 250px;
}

.attachment-image {
    max-width: 100%;
    max-height: 200px;
    border-radius: 6px;
    cursor: pointer;
    transition: transform 0.2s;
}

.attachment-image:hover {
    transform: scale(1.02);
}

.attachment-link {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: #333 !important;
}

.attachment-link:hover {
    color: #007bff !important;
    text-decoration: none;
}

.attachment-link:hover .attachment-name {
    color: #007bff !important;
}

.attachment-icon {
    margin-right: 10px;
    font-size: 24px;
    color: #007bff;
    min-width: 30px;
}

.attachment-info {
    display: flex;
    flex-direction: column;
}

.attachment-name {
    font-weight: 500;
    margin-bottom: 2px;
    color: #333 !important;
}

.attachment-size {
    font-size: 0.85em;
    color: #6c757d;
}

.emoji-btn:active {
    transform: scale(0.95);
}

/* Message styles */
.message {
    display: flex;
    margin-bottom: 15px;
}

.message.own {
    flex-direction: row-reverse;
}

.message-content {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    background: var(--chat-bg-secondary);
    color: var(--chat-text-primary);
}

.message.own .message-content {
    background: #007bff;
    color: white;
}

.message-time {
    font-size: 0.75rem;
    color: var(--chat-text-secondary);
    margin-top: 5px;
}
</style>

<!-- Optimized Chat JavaScript -->
<script>
// Advanced Chat Manager with Adaptive Polling
class ChatManager {
    constructor() {
        this.currentRoomId = null;
        this.pollingInterval = null;
        this.onlineStatusInterval = null;
        this.lastMessageId = null;
        this.lastActivity = Date.now();
        this.isTabVisible = true;
        this.requestQueue = [];
        this.abortController = null;
        this.notificationPermission = false;

        // Adaptive polling intervals (milliseconds)
        this.intervals = {
            active: 3000,     // 3 seconds when actively chatting
            normal: 8000,     // 8 seconds for normal activity
            idle: 20000,      // 20 seconds when idle
            background: 60000 // 60 seconds when tab is hidden
        };

        // Initialize visibility API
        this.initVisibilityHandlers();

        // Initialize notifications
        this.initNotifications();

        // Start online status updates
        this.startOnlineStatusUpdates();

        // Initialize performance monitoring
        this.performanceMetrics = {
            avgResponseTime: 0,
            requestCount: 0,
            errorCount: 0
        };
    }

    initVisibilityHandlers() {
        // Handle tab visibility changes
        document.addEventListener('visibilitychange', () => {
            this.isTabVisible = !document.hidden;
            this.adjustPollingFrequency();

            if (this.isTabVisible && this.currentRoomId) {
                // Tab became visible, do an immediate update
                this.checkForUpdates();
                this.sendOnlineStatusToServer();
            }
        });

        // Handle window focus/blur
        window.addEventListener('focus', () => {
            this.isTabVisible = true;
            this.adjustPollingFrequency();
            this.sendOnlineStatusToServer();
        });

        window.addEventListener('blur', () => {
            this.isTabVisible = false;
            this.adjustPollingFrequency();
        });
    }

    initNotifications() {
        // Request permission for notifications
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                this.notificationPermission = permission === 'granted';
            });
        } else if ('Notification' in window && Notification.permission === 'granted') {
            this.notificationPermission = true;
        }
    }

    startOnlineStatusUpdates() {
        // Update online status every 30 seconds
        this.sendOnlineStatusToServer();
        this.onlineStatusInterval = setInterval(() => {
            this.sendOnlineStatusToServer();
        }, 30000);
    }

    sendOnlineStatusToServer() {
        // Send online status update to server
        fetch('/chat/update-online-status/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
    }

    adjustPollingFrequency() {
        if (!this.currentRoomId) return;

        // Clear existing interval
        if (this.pollingInterval) {
            clearInterval(this.pollingInterval);
        }

        // Determine appropriate interval
        let interval;
        const timeSinceActivity = Date.now() - this.lastActivity;

        if (!this.isTabVisible) {
            interval = this.intervals.background;
        } else if (timeSinceActivity < 60000) { // Active in last minute
            interval = this.intervals.active;
        } else if (timeSinceActivity < 300000) { // Active in last 5 minutes
            interval = this.intervals.normal;
        } else {
            interval = this.intervals.idle;
        }

        console.log(`Polling interval adjusted to ${interval}ms`);

        // Set new interval
        this.pollingInterval = setInterval(() => {
            this.checkForUpdates();
        }, interval);
    }

    async makeRequest(url, options = {}) {
        // Cancel any pending request
        if (this.abortController) {
            this.abortController.abort();
        }

        this.abortController = new AbortController();
        const startTime = performance.now();

        try {
            const response = await fetch(url, {
                ...options,
                signal: this.abortController.signal
            });

            const responseTime = performance.now() - startTime;
            this.updatePerformanceMetrics(responseTime);

            return response;
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Request aborted');
            } else {
                this.performanceMetrics.errorCount++;
                throw error;
            }
        }
    }

    updatePerformanceMetrics(responseTime) {
        this.performanceMetrics.requestCount++;
        this.performanceMetrics.avgResponseTime =
            (this.performanceMetrics.avgResponseTime * (this.performanceMetrics.requestCount - 1) + responseTime)
            / this.performanceMetrics.requestCount;

        // Auto-adjust if response times are too slow
        if (this.performanceMetrics.avgResponseTime > 3000 && this.intervals.active < 10000) {
            this.intervals.active = Math.min(this.intervals.active * 1.5, 10000);
            this.intervals.normal = Math.min(this.intervals.normal * 1.5, 20000);
        }
    }

    async loadChat(roomId) {
        if (this.currentRoomId === roomId) return;

        this.currentRoomId = roomId;
        this.lastActivity = Date.now();
        this.lastMessageId = null; // Reset to load all messages

        // Update UI
        document.getElementById('chatWelcome').style.display = 'none';
        document.getElementById('activeChat').style.display = 'flex';

        // Clear messages area for fresh load
        document.getElementById('messagesContent').innerHTML = '';

        // Update active state and clear unread badge
        document.querySelectorAll('.chat-item').forEach(item => {
            const isActive = item.dataset.roomId == roomId;
            item.classList.toggle('active', isActive);

            // Clear unread badge for selected room
            if (isActive) {
                const badge = item.querySelector('.unread-badge');
                if (badge) {
                    badge.style.display = 'none';
                }
            }
        });

        // Load chat data
        await this.batchUpdate();

        // Mark messages as read
        fetch(`/chat/api/room/${roomId}/mark_read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        // Start adaptive polling
        this.adjustPollingFrequency();
    }

    async batchUpdate() {
        if (!this.currentRoomId) return;

        try {
            const response = await this.makeRequest(`/chat/api/batch/${this.currentRoomId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    last_message_id: this.lastMessageId,
                    include_room_info: true,  // Always include to get online status
                    include_participants: true  // Always include for status updates
                })
            });

            if (!response || !response.ok) return;

            const data = await response.json();

            if (data.success) {
                // Update room info if provided
                if (data.room_info) {
                    this.updateRoomInfo(data.room_info);
                }

                // Update messages if new ones exist
                if (data.messages && data.messages.length > 0) {
                    this.displayMessages(data.messages);
                    this.lastMessageId = data.last_message_id;

                    // Show notification for new messages (not from self)
                    const newMessages = data.messages.filter(msg => !msg.is_own);
                    if (newMessages.length > 0 && !this.isTabVisible) {
                        this.showNotification(newMessages[newMessages.length - 1]);
                    }
                }

                // Update unread counts
                if (data.unread_counts) {
                    this.updateUnreadCounts(data.unread_counts);
                }

                // Update online status
                if (data.online_status) {
                    this.updateOnlineStatus(data.online_status);
                }
            }
        } catch (error) {
            console.error('Batch update error:', error);
        }
    }

    async checkForUpdates() {
        if (document.hidden && !this.isTabVisible) return;

        // Use requestIdleCallback for non-critical updates
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => this.batchUpdate(), { timeout: 2000 });
        } else {
            await this.batchUpdate();
        }
    }

    updateRoomInfo(roomInfo) {
        document.getElementById('activeChatName').textContent = roomInfo.name || 'Chat';

        const avatarElement = document.getElementById('activeChatAvatar');
        if (roomInfo.profile_picture_url) {
            avatarElement.innerHTML = `<img src="${roomInfo.profile_picture_url}" alt="Profile" class="profile-image">`;
        } else {
            avatarElement.textContent = roomInfo.avatar_text || 'ğŸ‘¤';
        }

        const statusElement = document.getElementById('activeChatStatus');
        if (roomInfo.is_online !== undefined) {
            statusElement.innerHTML = roomInfo.is_online ?
                '<i class="fas fa-circle text-success" style="font-size: 0.6rem;"></i> Online' :
                '<i class="fas fa-circle text-muted" style="font-size: 0.6rem;"></i> Offline';
        } else if (roomInfo.is_group_chat) {
            statusElement.innerHTML = '<i class="fas fa-users text-info" style="font-size: 0.6rem;"></i> Gruppenchat';
        } else {
            statusElement.innerHTML = '<i class="fas fa-circle text-muted" style="font-size: 0.6rem;"></i> Status unbekannt';
        }
    }

    displayMessages(messages) {
        const messagesContent = document.getElementById('messagesContent');
        const shouldScroll = this.isNearBottom();

        // Use DocumentFragment for better performance
        const fragment = document.createDocumentFragment();

        messages.forEach(message => {
            if (document.querySelector(`[data-message-id="${message.id}"]`)) {
                return; // Message already displayed
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.is_own ? 'own' : ''}`;
            messageDiv.dataset.messageId = message.id;

            let attachmentsHtml = '';
            if (message.attachments && message.attachments.length > 0) {
                attachmentsHtml = '<div class="message-attachments">';
                message.attachments.forEach(attachment => {
                    if (attachment.is_image) {
                        attachmentsHtml += `
                            <div class="attachment-item image">
                                <img src="${attachment.file_url}" alt="${attachment.filename}"
                                     class="attachment-image" onclick="openImageModal('${attachment.file_url}', '${attachment.filename}')">
                                <div class="attachment-info">
                                    <span class="attachment-name">${attachment.filename}</span>
                                    <span class="attachment-size">${attachment.file_size}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        const icon = this.getFileIcon(attachment.file_type);
                        attachmentsHtml += `
                            <div class="attachment-item file">
                                <a href="${attachment.file_url}" download="${attachment.filename}" class="attachment-link">
                                    <div class="attachment-icon">${icon}</div>
                                    <div class="attachment-info">
                                        <span class="attachment-name">${attachment.filename}</span>
                                        <span class="attachment-size">${attachment.file_size}</span>
                                    </div>
                                </a>
                            </div>
                        `;
                    }
                });
                attachmentsHtml += '</div>';
            }

            messageDiv.innerHTML = `
                <div class="message-content">
                    ${message.content ? `<div class="message-text">${this.escapeHtml(message.content)}</div>` : ''}
                    ${attachmentsHtml}
                    <div class="message-time">${message.formatted_time}</div>
                </div>
            `;

            fragment.appendChild(messageDiv);
        });

        messagesContent.appendChild(fragment);

        if (shouldScroll) {
            this.scrollToBottom();
        }
    }

    async sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();

        if (!content || !this.currentRoomId) return;

        this.lastActivity = Date.now();
        input.value = '';

        try {
            const response = await this.makeRequest(`/chat/api/room/${this.currentRoomId}/send/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `content=${encodeURIComponent(content)}`
            });

            if (!response || !response.ok) return;

            const data = await response.json();

            if (data.success) {
                // Display message immediately
                this.displayMessages([data.message]);
                this.lastMessageId = data.message.id;

                // Adjust polling to active mode
                this.adjustPollingFrequency();
            }
        } catch (error) {
            console.error('Send message error:', error);
            input.value = content; // Restore message on error
        }
    }

    updateUnreadCounts(counts) {
        // Update all room badges
        document.querySelectorAll('.chat-item').forEach(item => {
            const roomId = item.dataset.roomId;
            const badge = item.querySelector('.unread-badge');
            if (badge) {
                const count = counts[roomId] || 0;
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        });

        // Clear badge for current room
        if (this.currentRoomId) {
            const currentBadge = document.querySelector(`[data-room-id="${this.currentRoomId}"] .unread-badge`);
            if (currentBadge) {
                currentBadge.style.display = 'none';
            }
        }
    }

    updateOnlineStatus(statuses) {
        if (!statuses || typeof statuses !== 'object') return;

        Object.entries(statuses).forEach(([userId, isOnline]) => {
            const statusElements = document.querySelectorAll(`[data-user-id="${userId}"] .online-status`);
            statusElements.forEach(element => {
                element.innerHTML = isOnline ?
                    '<i class="fas fa-circle text-success" style="font-size: 0.6rem;"></i> Online' :
                    '<i class="fas fa-circle text-muted" style="font-size: 0.6rem;"></i> Offline';
            });
        });
    }

    isNearBottom() {
        const messagesArea = document.getElementById('messagesArea');
        return messagesArea.scrollHeight - messagesArea.scrollTop - messagesArea.clientHeight < 100;
    }

    scrollToBottom() {
        const messagesArea = document.getElementById('messagesArea');
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    getFileIcon(fileType) {
        if (fileType.startsWith('image/')) return '<i class="fas fa-image"></i>';
        if (fileType.startsWith('video/')) return '<i class="fas fa-video"></i>';
        if (fileType.startsWith('audio/')) return '<i class="fas fa-music"></i>';
        if (fileType.includes('pdf')) return '<i class="fas fa-file-pdf"></i>';
        if (fileType.includes('word') || fileType.includes('document')) return '<i class="fas fa-file-word"></i>';
        if (fileType.includes('excel') || fileType.includes('spreadsheet')) return '<i class="fas fa-file-excel"></i>';
        if (fileType.includes('powerpoint') || fileType.includes('presentation')) return '<i class="fas fa-file-powerpoint"></i>';
        if (fileType.includes('zip') || fileType.includes('rar') || fileType.includes('7z')) return '<i class="fas fa-file-archive"></i>';
        if (fileType.includes('text')) return '<i class="fas fa-file-alt"></i>';
        return '<i class="fas fa-file"></i>';
    }

    showNotification(message) {
        if (this.notificationPermission && 'Notification' in window) {
            const notification = new Notification('Neue Nachricht', {
                body: `${message.sender}: ${message.content.substring(0, 100)}`,
                icon: '/static/images/chat-icon.png',
                tag: 'chat-message',
                requireInteraction: false
            });

            notification.onclick = () => {
                window.focus();
                if (this.currentRoomId) {
                    this.checkForUpdates();
                }
                notification.close();
            };

            // Auto-close after 5 seconds
            setTimeout(() => notification.close(), 5000);
        }
    }

    cleanup() {
        if (this.pollingInterval) {
            clearInterval(this.pollingInterval);
        }
        if (this.onlineStatusInterval) {
            clearInterval(this.onlineStatusInterval);
        }
        if (this.abortController) {
            this.abortController.abort();
        }

        // Set offline status
        navigator.sendBeacon('/chat/set-offline/', new FormData());
    }
}

// Initialize chat manager
const chatManager = new ChatManager();

// Stop global chat notifications if they exist (we handle it locally)
if (window.globalChatNotifications) {
    try {
        window.globalChatNotifications.cleanup();
        window.globalChatNotifications = null;
    } catch (error) {
        console.warn('Error stopping global notifications:', error);
    }
}

// Helper functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        chatManager.sendMessage();
    }
}

function showChatInfo() {
    if (!chatManager.currentRoomId) return;

    // Show modal with loading spinner
    const modal = new bootstrap.Modal(document.getElementById('chatInfoModal'));
    modal.show();

    // Reset content
    document.getElementById('chatInfoContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
        </div>
    `;

    fetch(`/chat/api/room/${chatManager.currentRoomId}/info/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const room = data.room;
                let htmlContent = `
                    <div class="chat-info-details">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                                        <i class="fas fa-comments text-primary fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">${room.name || 'Privater Chat'}</h6>
                                        <small class="text-muted">${room.is_group_chat ? 'Gruppenchat' : 'Einzelchat'}</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="info-item mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-users text-primary me-3" style="width: 20px;"></i>
                                <div class="flex-grow-1">
                                    <small class="text-muted d-block">Teilnehmer</small>
                                    <div class="fw-semibold">
                                        ${room.participants ? room.participants.map(p => `
                                            <span class="badge bg-secondary me-1">${p}</span>
                                        `).join('') : 'Keine Teilnehmer'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="info-item mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar text-primary me-3" style="width: 20px;"></i>
                                <div class="flex-grow-1">
                                    <small class="text-muted d-block">Erstellt am</small>
                                    <div class="fw-semibold">
                                        ${room.created_at ? new Date(room.created_at).toLocaleDateString('de-DE', {
                                            weekday: 'long',
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        }) : 'Unbekannt'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="info-item mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-envelope text-primary me-3" style="width: 20px;"></i>
                                <div class="flex-grow-1">
                                    <small class="text-muted d-block">Nachrichten</small>
                                    <div class="fw-semibold">${room.message_count || 0} Nachrichten</div>
                                </div>
                            </div>
                        </div>

                        ${room.last_message_at ? `
                        <div class="info-item">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock text-primary me-3" style="width: 20px;"></i>
                                <div class="flex-grow-1">
                                    <small class="text-muted d-block">Letzte AktivitÃ¤t</small>
                                    <div class="fw-semibold">
                                        ${new Date(room.last_message_at).toLocaleDateString('de-DE', {
                                            weekday: 'long',
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                document.getElementById('chatInfoContent').innerHTML = htmlContent;
            } else {
                document.getElementById('chatInfoContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Fehler beim Laden der Chat-Informationen
                    </div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('chatInfoContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Ein Fehler ist aufgetreten: ${error.message}
                </div>
            `;
        });
}

function deleteCurrentChat() {
    if (!chatManager.currentRoomId) return;

    if (confirm('MÃ¶chten Sie diesen Chat wirklich lÃ¶schen?')) {
        deleteChat(chatManager.currentRoomId);
    }
}

function deleteChat(roomId, event) {
    if (event) {
        event.stopPropagation();
    }

    fetch(`/chat/api/room/${roomId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove from list
            document.querySelector(`[data-room-id="${roomId}"]`).remove();

            // If this was the active chat, show welcome
            if (chatManager.currentRoomId === roomId) {
                chatManager.currentRoomId = null;
                document.getElementById('chatWelcome').style.display = 'flex';
                document.getElementById('activeChat').style.display = 'none';
            }
        }
    });
}

function createNewChat() {
    window.location.href = '/chat/search/';
}

// Global function to update chat list
function updateChatList() {
    fetch('/chat/unread-count/')
        .then(response => response.json())
        .then(data => {
            // Update total unread count if you have a global badge
            const totalUnread = data.unread_count || 0;

            // Update document title with unread count
            if (totalUnread > 0) {
                document.title = `(${totalUnread}) Chat System`;
            } else {
                document.title = 'Chat System';
            }
        });
}

// Export chat to PDF
function exportChatToPDF() {
    if (!chatManager.currentRoomId) return;

    // Show loading state
    const exportBtn = document.getElementById('exportChatBtn');
    const originalText = exportBtn.innerHTML;
    exportBtn.disabled = true;
    exportBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Exportiere...';

    fetch(`/chat/api/room/${chatManager.currentRoomId}/export-pdf/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('Export fehlgeschlagen');
        }
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `chat_export_${chatManager.currentRoomId}_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        // Show success message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            Chat wurde erfolgreich als PDF exportiert!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);

        // Remove alert after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    })
    .catch(error => {
        console.error('Export error:', error);
        alert('Fehler beim Exportieren des Chats: ' + error.message);
    })
    .finally(() => {
        // Reset button state
        exportBtn.disabled = false;
        exportBtn.innerHTML = originalText;
    });
}

// Emoji Picker Functions
function toggleEmojiPicker() {
    const picker = document.getElementById('emojiPicker');
    if (picker.style.display === 'none') {
        picker.style.display = 'block';
        if (!picker.dataset.initialized) {
            initializeEmojiPicker();
            picker.dataset.initialized = 'true';
        }
    } else {
        picker.style.display = 'none';
    }
}

function openFileDialog() {
    document.getElementById('fileInput').click();
}

function sendFilesAsAttachments(files) {
    if (!chatManager.currentRoomId) {
        alert('Bitte wÃ¤hlen Sie zuerst einen Chat aus.');
        return;
    }

    const formData = new FormData();
    formData.append('content', ''); // Empty content since we're only sending files

    files.forEach(file => {
        formData.append('attachments', file);
    });

    fetch(`/chat/api/room/${chatManager.currentRoomId}/send/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reset file input
            document.getElementById('fileInput').value = '';

            // Add message to chat
            if (data.message) {
                chatManager.displayMessages([data.message]);
                updateChatList();
            }
        } else {
            alert('Fehler beim Senden der Datei: ' + (data.error || 'Unbekannter Fehler'));
        }
    })
    .catch(error => {
        console.error('Fehler beim Senden der Datei:', error);
        alert('Fehler beim Senden der Datei.');
    });
}

// Emoji categories
const emojiCategories = {
    smileys: [
        'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ',
        'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™',
        'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”',
        'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥',
        'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®',
        'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤“',
        'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º',
        'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£',
        'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ',
        'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸', 'ğŸ’©', 'ğŸ¤¡', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ‘¾',
        'ğŸ¤–', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾'
    ],
    gestures: [
        'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤',
        'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘',
        'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤',
        'ğŸ™', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ',
        'ğŸ«€', 'ğŸ«', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹', 'ğŸ©¸'
    ],
    hearts: [
        'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”',
        'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'ğŸ’Œ',
        'ğŸ’', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸŒ·', 'ğŸŒº', 'ğŸŒ¸', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸ’', 'ğŸ’'
    ],
    symbols: [
        'â­', 'ğŸŒŸ', 'âœ¨', 'âš¡', 'ğŸ”¥', 'ğŸ’«', 'ğŸŒˆ', 'â˜€ï¸', 'â›…', 'ğŸŒ¤ï¸',
        'â›ˆï¸', 'ğŸŒ©ï¸', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'ğŸ‰', 'ğŸŠ', 'ğŸˆ', 'ğŸ', 'ğŸ†',
        'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ…', 'ğŸ–ï¸', 'ğŸ—ï¸', 'ğŸ¯', 'ğŸ²', 'ğŸ®', 'ğŸ•¹ï¸',
        'ğŸ°', 'ğŸ³', 'ğŸ¯', 'ğŸš€', 'ğŸ›¸', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸ—ºï¸', 'â­',
        'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸', 'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸'
    ]
};

function initializeEmojiPicker() {
    // Start with smileys category
    showEmojiCategory('smileys');
}

function showEmojiCategory(category) {
    const emojiContent = document.querySelector('.emoji-picker-content');
    const tabs = document.querySelectorAll('.emoji-tab');

    // Clear content
    emojiContent.innerHTML = '';

    // Update active tab
    tabs.forEach((tab, index) => {
        tab.classList.remove('active');
        if ((category === 'smileys' && index === 0) ||
            (category === 'gestures' && index === 1) ||
            (category === 'hearts' && index === 2) ||
            (category === 'symbols' && index === 3)) {
            tab.classList.add('active');
        }
    });

    // Add emojis for selected category
    const emojis = emojiCategories[category] || emojiCategories.smileys;

    emojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn';
        btn.textContent = emoji;
        btn.onclick = () => insertEmoji(emoji);
        emojiContent.appendChild(btn);
    });
}

function insertEmoji(emoji) {
    const input = document.getElementById('messageInput');
    const cursorPos = input.selectionStart;
    const textBefore = input.value.substring(0, cursorPos);
    const textAfter = input.value.substring(cursorPos);

    input.value = textBefore + emoji + textAfter;
    input.focus();
    input.selectionStart = input.selectionEnd = cursorPos + emoji.length;
}

function openImageModal(imageUrl, filename) {
    // Create modal HTML
    const modalHtml = `
        <div class="modal fade" id="imageModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${filename}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="${imageUrl}" alt="${filename}" style="max-width: 100%; height: auto;">
                    </div>
                    <div class="modal-footer">
                        <a href="${imageUrl}" download="${filename}" class="btn btn-primary">
                            <i class="fas fa-download me-2"></i>Herunterladen
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">SchlieÃŸen</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('imageModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();

    // Remove modal from DOM when closed
    document.getElementById('imageModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Close emoji picker when clicking outside
document.addEventListener('click', function(event) {
    const picker = document.getElementById('emojiPicker');
    const button = event.target.closest('button[onclick="toggleEmojiPicker()"]');

    if (!picker.contains(event.target) && !button) {
        picker.style.display = 'none';
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize file input handler
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            sendFilesAsAttachments(files);
        }
    });

    // Initialize search
    const searchInput = document.getElementById('chatSearch');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.toLowerCase();

            searchTimeout = setTimeout(() => {
                document.querySelectorAll('.chat-item').forEach(item => {
                    const name = item.querySelector('.chat-name').textContent.toLowerCase();
                    const preview = item.querySelector('.chat-preview').textContent.toLowerCase();
                    item.style.display = (name.includes(query) || preview.includes(query)) ? 'flex' : 'none';
                });
            }, 300);
        });
    }

    // Check URL for auto-load room
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');
    if (roomId) {
        chatManager.loadChat(parseInt(roomId));
    }

    // Start global chat list updates
    updateChatList();
    setInterval(updateChatList, 30000); // Every 30 seconds
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    chatManager.cleanup();
});
</script>
{% endblock %}