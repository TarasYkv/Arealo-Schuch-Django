{% extends 'chat/base.html' %}
{% load chat_extras %}

{% block content %}
<style>
.chat-container {
    height: calc(100vh - 200px);
    display: flex;
}

.chat-sidebar {
    width: 400px;
    border-right: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    background: #f8f9fa;
}

.chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
}

.chat-header {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    background: white;
}

.chat-list {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

.chat-room-item {
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: background-color 0.2s;
}

.chat-room-item:hover {
    background-color: #e9ecef;
}

.chat-room-item.active {
    background-color: #007bff;
    color: white;
}

.chat-room-item.active .text-muted {
    color: rgba(255, 255, 255, 0.8) !important;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    margin-right: 12px;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
}

.message-input-area {
    padding: 1rem;
    border-top: 1px solid #dee2e6;
    background: white;
}

.message-bubble {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    margin-bottom: 10px;
    word-wrap: break-word;
}

.message-own {
    background-color: #007bff;
    color: white;
    margin-left: auto;
}

.message-other {
    background-color: white;
    color: #333;
    border: 1px solid #dee2e6;
}

.empty-chat {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    flex-direction: column;
    color: #6c757d;
}

.no-chat-selected {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    flex-direction: column;
    color: #6c757d;
}

.badge-unread {
    background-color: #dc3545;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.7rem;
    min-width: 18px;
    text-align: center;
}

.user-avatar-img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.online-indicator {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 12px;
    height: 12px;
    background-color: #28a745;
    border: 2px solid white;
    border-radius: 50%;
    z-index: 1;
}

.call-container {
    text-align: center;
}

.call-avatar {
    margin: 20px 0;
}

.video-container {
    position: relative;
    height: 300px;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
}

.local-video {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 150px;
    height: 100px;
    border-radius: 8px;
    border: 2px solid white;
    z-index: 2;
}

.remote-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.call-controls {
    padding: 15px;
}

.call-controls button {
    margin: 0 10px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.search-box {
    padding: 0.5rem;
    border: none;
    border-bottom: 1px solid #dee2e6;
    background: white;
}

.search-box:focus {
    outline: none;
    border-bottom-color: #007bff;
}
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-comments text-primary"></i>
                            Chat
                        </h4>
                        <div class="d-flex gap-2">
                            <a href="{% url 'chat:user_search' %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-search"></i> Nutzer suchen
                            </a>
                            <a href="{% url 'chat:create_group_chat' %}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-users"></i> Gruppe erstellen
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="chat-container">
                        <!-- Chat Sidebar -->
                        <div class="chat-sidebar">
                            <div class="chat-header">
                                <h6 class="mb-0">Chats ({{ chat_rooms|length }})</h6>
                            </div>
                            <input type="text" class="search-box" placeholder="Chats durchsuchen..." id="chatSearch">
                            <div class="chat-list" id="chatList">
                                {% for room in chat_rooms %}
                                <div class="chat-room-item" data-room-id="{{ room.id }}" onclick="loadChat({{ room.id }})">
                                    <div class="d-flex align-items-center">
                                        <div class="position-relative">
                                            {% if room.is_group_chat %}
                                                <div class="user-avatar bg-success">
                                                    <i class="fas fa-users"></i>
                                                </div>
                                            {% else %}
                                                {% with other_user=room|get_other_participant:request.user %}
                                                    {% if other_user %}
                                                        {% if other_user.profile_picture %}
                                                            <img src="{{ other_user.profile_picture.url }}" alt="{{ other_user.get_full_name|default:other_user.username }}" class="user-avatar-img">
                                                        {% else %}
                                                            <div class="user-avatar bg-primary">
                                                                {{ other_user.get_full_name.0|default:other_user.username.0|upper }}
                                                            </div>
                                                        {% endif %}
                                                        <!-- Online-Status-Indikator -->
                                                        {% if other_user.is_currently_online %}
                                                            <span class="online-indicator"></span>
                                                        {% endif %}
                                                    {% elif room.created_by %}
                                                        {% if room.created_by.profile_picture %}
                                                            <img src="{{ room.created_by.profile_picture.url }}" alt="{{ room.created_by.get_full_name|default:room.created_by.username }}" class="user-avatar-img">
                                                        {% else %}
                                                            <div class="user-avatar bg-primary">
                                                                {{ room.created_by.get_full_name.0|default:room.created_by.username.0|upper }}
                                                            </div>
                                                        {% endif %}
                                                        <!-- Online-Status-Indikator -->
                                                        {% if room.created_by.is_currently_online %}
                                                            <span class="online-indicator"></span>
                                                        {% endif %}
                                                    {% else %}
                                                        <div class="user-avatar bg-warning">
                                                            <i class="fas fa-bug"></i>
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-0">
                                                        {% if room.is_group_chat %}
                                                            {{ room.name|default:room }}
                                                        {% else %}
                                                            {% with other_user=room|get_other_participant:request.user %}
                                                                {% if other_user %}
                                                                    {{ other_user.get_full_name|default:other_user.username }}
                                                                    {% if other_user.is_currently_online %}
                                                                        <small class="text-success">• Online</small>
                                                                    {% else %}
                                                                        <small class="text-muted">• Offline</small>
                                                                    {% endif %}
                                                                {% elif room.created_by %}
                                                                    {{ room.created_by.get_full_name|default:room.created_by.username }}
                                                                    {% if room.created_by.is_currently_online %}
                                                                        <small class="text-success">• Online</small>
                                                                    {% else %}
                                                                        <small class="text-muted">• Offline</small>
                                                                    {% endif %}
                                                                {% else %}
                                                                    Bug-Meldung
                                                                {% endif %}
                                                            {% endwith %}
                                                        {% endif %}
                                                    </h6>
                                                    {% with last_message=room.get_last_message %}
                                                        {% if last_message %}
                                                            <small class="text-muted">
                                                                {% if last_message.sender %}
                                                                    {{ last_message.sender.get_full_name|default:last_message.sender.username }}
                                                                {% else %}
                                                                    {{ last_message.sender_name|default:"Anonym" }}
                                                                {% endif %}:
                                                                {{ last_message.content|truncatewords:5 }}
                                                            </small>
                                                        {% else %}
                                                            <small class="text-muted">Noch keine Nachrichten</small>
                                                        {% endif %}
                                                    {% endwith %}
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-muted">{{ room.last_message_at|timesince }}</small>
                                                    {% if room.unread_count > 0 %}
                                                        <div class="badge-unread">{{ room.unread_count }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="empty-chat">
                                    <i class="fas fa-comments fa-3x mb-3"></i>
                                    <p>Keine Chats vorhanden</p>
                                    <a href="{% url 'chat:user_search' %}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-search"></i> Nutzer suchen
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Chat Main Area -->
                        <div class="chat-main">
                            <div id="chatHeader" class="chat-header" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div id="chatAvatar" class="user-avatar bg-primary me-3"></div>
                                        <div>
                                            <h6 class="mb-0" id="chatTitle">Chat-Name</h6>
                                            <small class="text-muted" id="chatSubtitle">Informationen</small>
                                        </div>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="initiateCall('audio')"><i class="fas fa-phone"></i> Anrufen</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="initiateCall('video')"><i class="fas fa-video"></i> Videoanruf</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="#" onclick="showChatInfo()"><i class="fas fa-info-circle"></i> Info</a></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteChat()"><i class="fas fa-trash"></i> Löschen</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chat-messages" id="chatMessages">
                                <div class="no-chat-selected">
                                    <i class="fas fa-comments fa-4x mb-3"></i>
                                    <h5>Wählen Sie einen Chat aus</h5>
                                    <p>Klicken Sie auf einen Chat in der Seitenleiste, um die Unterhaltung zu beginnen.</p>
                                </div>
                            </div>
                            
                            <!-- Call Modal -->
                            <div class="modal fade" id="callModal" tabindex="-1" aria-labelledby="callModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="callModalLabel">
                                                <i class="fas fa-phone" id="callIcon"></i>
                                                <span id="callTitle">Anruf</span>
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="endCall()"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="call-container">
                                                <div class="call-status text-center mb-3">
                                                    <div class="call-avatar mb-2">
                                                        <i class="fas fa-user-circle fa-4x text-primary"></i>
                                                    </div>
                                                    <h4 id="callParticipantName">Teilnehmer</h4>
                                                    <p id="callStatus" class="text-muted">Verbinde...</p>
                                                </div>
                                                
                                                <!-- Video Elements -->
                                                <div class="video-container" id="videoContainer" style="display: none;">
                                                    <video id="localVideo" autoplay muted playsinline class="local-video"></video>
                                                    <video id="remoteVideo" autoplay playsinline class="remote-video"></video>
                                                </div>
                                                
                                                <!-- Call Controls -->
                                                <div class="call-controls text-center mt-3">
                                                    <button class="btn btn-outline-secondary me-2" id="muteBtn" onclick="toggleMute()">
                                                        <i class="fas fa-microphone"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary me-2" id="videoBtn" onclick="toggleVideo()" style="display: none;">
                                                        <i class="fas fa-video"></i>
                                                    </button>
                                                    <button class="btn btn-danger" id="endCallBtn" onclick="endCall()">
                                                        <i class="fas fa-phone-slash"></i> Beenden
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="message-input-area" id="messageInput" style="display: none;">
                                <div class="d-flex align-items-end gap-2">
                                    <div class="flex-grow-1">
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="Nachricht eingeben..." id="messageText" onkeypress="handleKeyPress(event)">
                                        </div>
                                        <div id="attachmentPreview" class="mt-2" style="display: none;"></div>
                                    </div>
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-outline-secondary" onclick="document.getElementById('fileInput').click()" title="Datei anhängen">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        <button class="btn btn-primary" onclick="sendMessage()">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect(event)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentRoomId = null;
let messagesContainer = document.getElementById('chatMessages');
let messageInput = document.getElementById('messageText');
let selectedFiles = [];
let attachmentPreview = document.getElementById('attachmentPreview');

function loadChat(roomId) {
    // Update active chat room
    document.querySelectorAll('.chat-room-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-room-id="${roomId}"]`).classList.add('active');
    
    currentRoomId = roomId;
    
    // Mark messages as read when chat is loaded
    markMessagesAsRead(roomId);
    
    // Show chat header and input
    document.getElementById('chatHeader').style.display = 'block';
    document.getElementById('messageInput').style.display = 'block';
    
    // Load messages
    fetch(`/chat/api/room/${roomId}/messages/`)
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                displayMessages(data.messages);
                updateChatHeader(data.room);
            } else {
                console.error('Error loading messages:', data.error);
                alert('Fehler beim Laden der Nachrichten: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Netzwerkfehler beim Laden der Nachrichten');
        });
}

function displayMessages(messages) {
    console.log('displayMessages called with:', messages);
    messagesContainer.innerHTML = '';
    
    if (!messages || messages.length === 0) {
        messagesContainer.innerHTML = `
            <div class="empty-chat">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <p>Noch keine Nachrichten</p>
                <p class="text-muted">Senden Sie die erste Nachricht!</p>
            </div>
        `;
        return;
    }
    
    messages.forEach(message => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `d-flex ${message.is_own ? 'justify-content-end' : 'justify-content-start'} mb-3`;
        
        const isOwn = message.is_own;
        const senderName = message.sender_name || 'Anonym';
        
        let attachmentsHtml = '';
        if (message.attachments && message.attachments.length > 0) {
            attachmentsHtml = '<div class="attachments mt-2">';
            message.attachments.forEach(attachment => {
                if (attachment.is_image) {
                    attachmentsHtml += `
                        <div class="attachment-item mb-2">
                            <img src="${attachment.file_url}" alt="${attachment.filename}" class="img-fluid rounded" style="max-width: 300px; max-height: 200px;">
                            <div class="small text-muted">${attachment.filename} (${attachment.file_size})</div>
                        </div>
                    `;
                } else {
                    attachmentsHtml += `
                        <div class="attachment-item mb-2">
                            <a href="${attachment.file_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-file"></i> ${attachment.filename} (${attachment.file_size})
                            </a>
                        </div>
                    `;
                }
            });
            attachmentsHtml += '</div>';
        }
        
        messageDiv.innerHTML = `
            <div class="message-bubble ${isOwn ? 'message-own' : 'message-other'}">
                ${!isOwn ? `<div class="mb-1"><small><strong>${senderName}</strong></small></div>` : ''}
                <div>${message.content || ''}</div>
                ${attachmentsHtml}
                <div class="mt-1">
                    <small class="opacity-75">${message.formatted_time}</small>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
    });
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function updateChatHeader(room) {
    document.getElementById('chatTitle').textContent = room.name || room.display_name;
    document.getElementById('chatSubtitle').textContent = room.is_group_chat ? 
        `${room.participant_count} Teilnehmer` : 'Privater Chat';
    
    const avatar = document.getElementById('chatAvatar');
    avatar.className = `user-avatar ${room.is_group_chat ? 'bg-success' : 'bg-primary'} me-3`;
    avatar.innerHTML = room.is_group_chat ? '<i class="fas fa-users"></i>' : room.avatar_text;
}

function sendMessage() {
    const messageText = messageInput.value.trim();
    if (!messageText && selectedFiles.length === 0) return;
    if (!currentRoomId) return;
    
    const formData = new FormData();
    formData.append('content', messageText);
    
    // Add attachments
    selectedFiles.forEach(file => {
        formData.append('attachments', file);
    });
    
    fetch(`/chat/api/room/${currentRoomId}/send/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            selectedFiles = [];
            attachmentPreview.style.display = 'none';
            attachmentPreview.innerHTML = '';
            loadChat(currentRoomId); // Reload messages
        } else {
            alert('Fehler beim Senden der Nachricht: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Verbindungsfehler');
    });
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// Search functionality
document.getElementById('chatSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const chatItems = document.querySelectorAll('.chat-room-item');
    
    chatItems.forEach(item => {
        const chatName = item.querySelector('h6').textContent.toLowerCase();
        const lastMessage = item.querySelector('.text-muted').textContent.toLowerCase();
        
        if (chatName.includes(searchTerm) || lastMessage.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
});

// Get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Handle file selection
function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    selectedFiles = files;
    
    if (files.length === 0) {
        attachmentPreview.style.display = 'none';
        return;
    }
    
    let previewHtml = '<div class="selected-files"><strong>Ausgewählte Dateien:</strong><br>';
    files.forEach((file, index) => {
        const fileSize = formatFileSize(file.size);
        previewHtml += `
            <div class="file-item d-flex align-items-center gap-2 mb-1">
                <i class="fas fa-file"></i>
                <span>${file.name} (${fileSize})</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });
    previewHtml += '</div>';
    
    attachmentPreview.innerHTML = previewHtml;
    attachmentPreview.style.display = 'block';
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    if (selectedFiles.length === 0) {
        attachmentPreview.style.display = 'none';
    } else {
        // Update preview
        handleFileSelect({ target: { files: selectedFiles } });
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Mark messages as read
function markMessagesAsRead(roomId) {
    fetch(`/chat/api/room/${roomId}/mark_read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update chat notification counter
            if (window.updateChatNotifications) {
                window.updateChatNotifications();
            }
            // Update unread badges in chat list
            updateUnreadBadges();
        }
    })
    .catch(error => {
        console.error('Error marking messages as read:', error);
    });
}

// Update unread badges in chat list
function updateUnreadBadges() {
    const roomItem = document.querySelector(`[data-room-id="${currentRoomId}"]`);
    if (roomItem) {
        const unreadBadge = roomItem.querySelector('.badge-unread');
        if (unreadBadge) {
            unreadBadge.style.display = 'none';
        }
    }
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Auto-refresh messages every 5 seconds
setInterval(() => {
    if (currentRoomId) {
        loadChat(currentRoomId);
    }
}, 5000);

// Check for room parameter in URL and load chat
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');
    if (roomId) {
        loadChat(parseInt(roomId));
    }
});

// Update online status every 30 seconds
setInterval(() => {
    fetch('/chat/update-online-status/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Error updating online status:', data.error);
        }
    })
    .catch(error => {
        console.error('Error updating online status:', error);
    });
}, 30000);

// Update online status immediately when page loads
document.addEventListener('DOMContentLoaded', function() {
    fetch('/chat/update-online-status/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    });
});

// Delete chat function
function deleteChat() {
    if (!currentRoomId) {
        alert('Kein Chat ausgewählt');
        return;
    }
    
    if (confirm('Sind Sie sicher, dass Sie diesen Chat löschen möchten?')) {
        fetch(`/chat/api/room/${currentRoomId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Remove chat from list
                const chatItem = document.querySelector(`[data-room-id="${currentRoomId}"]`);
                if (chatItem) {
                    chatItem.remove();
                }
                // Clear chat area
                document.getElementById('chatMessages').innerHTML = '';
                document.getElementById('chatHeader').style.display = 'none';
                document.getElementById('messageInput').style.display = 'none';
                currentRoomId = null;
                // Reload page to refresh chat list
                window.location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting chat:', error);
            alert('Fehler beim Löschen des Chats');
        });
    }
}

// Show chat info function
function showChatInfo() {
    if (!currentRoomId) {
        alert('Kein Chat ausgewählt');
        return;
    }
    
    // Get chat room data
    const chatItem = document.querySelector(`[data-room-id="${currentRoomId}"]`);
    if (!chatItem) {
        alert('Chat-Informationen nicht gefunden');
        return;
    }
    
    // Show info modal or section
    // For now, just show a simple alert with basic info
    fetch(`/chat/api/room/${currentRoomId}/info/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let infoText = `Chat-Informationen:\n\n`;
            infoText += `Name: ${data.room.name || 'Privater Chat'}\n`;
            infoText += `Typ: ${data.room.is_group_chat ? 'Gruppenchat' : 'Privater Chat'}\n`;
            infoText += `Erstellt am: ${data.room.created_at}\n`;
            infoText += `Teilnehmer: ${data.room.participants.join(', ')}\n`;
            if (data.room.other_user) {
                infoText += `\nProfil-Informationen:\n`;
                infoText += `Name: ${data.room.other_user.name}\n`;
                infoText += `Benutzername: ${data.room.other_user.username}\n`;
                infoText += `Online: ${data.room.other_user.is_online ? 'Ja' : 'Nein'}\n`;
            }
            alert(infoText);
        } else {
            alert('Fehler beim Laden der Chat-Informationen: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error loading chat info:', error);
        alert('Fehler beim Laden der Chat-Informationen');
    });
}

// WebRTC and Call Variables
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let callSocket = null;
let currentCallId = null;
let isCallActive = false;
let isMuted = false;
let isVideoEnabled = false;

// WebRTC configuration
const rtcConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

// Initiate a call
function initiateCall(callType) {
    if (!currentRoomId) {
        alert('Kein Chat ausgewählt');
        return;
    }
    
    if (isCallActive) {
        alert('Es läuft bereits ein Anruf');
        return;
    }
    
    // Show call modal
    const callModal = new bootstrap.Modal(document.getElementById('callModal'));
    callModal.show();
    
    // Update UI
    document.getElementById('callTitle').textContent = callType === 'video' ? 'Videoanruf' : 'Anruf';
    document.getElementById('callIcon').className = callType === 'video' ? 'fas fa-video' : 'fas fa-phone';
    document.getElementById('callStatus').textContent = 'Startet Anruf...';
    
    // Show/hide video controls
    if (callType === 'video') {
        document.getElementById('videoBtn').style.display = 'inline-block';
        document.getElementById('videoContainer').style.display = 'block';
        isVideoEnabled = true;
    } else {
        document.getElementById('videoBtn').style.display = 'none';
        document.getElementById('videoContainer').style.display = 'none';
        isVideoEnabled = false;
    }
    
    // Start call
    startCall(callType);
}

// Start call process
async function startCall(callType) {
    try {
        // Get user media
        const constraints = {
            audio: true,
            video: callType === 'video'
        };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        if (callType === 'video') {
            document.getElementById('localVideo').srcObject = localStream;
        }
        
        // Create WebSocket connection
        connectCallWebSocket();
        
        // Initiate call via API
        const response = await fetch(`/chat/api/room/${currentRoomId}/call/initiate/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                call_type: callType
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentCallId = data.call_id;
            isCallActive = true;
            document.getElementById('callStatus').textContent = 'Ruft an...';
            
            // Send call initiation through WebSocket
            if (callSocket && callSocket.readyState === WebSocket.OPEN) {
                callSocket.send(JSON.stringify({
                    type: 'call_initiate',
                    call_type: callType,
                    call_id: currentCallId
                }));
            }
        } else {
            alert('Fehler beim Starten des Anrufs: ' + data.error);
            endCall();
        }
        
    } catch (error) {
        console.error('Error starting call:', error);
        alert('Fehler beim Zugriff auf Mikrofon/Kamera');
        endCall();
    }
}

// Connect to call WebSocket
function connectCallWebSocket() {
    if (callSocket) {
        callSocket.close();
    }
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/call/${currentRoomId}/`;
    
    callSocket = new WebSocket(wsUrl);
    
    callSocket.onopen = function(e) {
        console.log('Call WebSocket connected');
    };
    
    callSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        handleCallMessage(data);
    };
    
    callSocket.onclose = function(e) {
        console.log('Call WebSocket disconnected');
    };
    
    callSocket.onerror = function(e) {
        console.error('Call WebSocket error:', e);
    };
}

// Handle call messages from WebSocket
function handleCallMessage(data) {
    switch(data.type) {
        case 'call_initiated':
            if (data.caller !== '{{ user.username }}') {
                handleIncomingCall(data);
            }
            break;
        case 'call_answered':
            handleCallAnswered(data);
            break;
        case 'call_rejected':
            handleCallRejected(data);
            break;
        case 'call_ended':
            handleCallEnded(data);
            break;
        case 'webrtc_offer':
            handleWebRTCOffer(data);
            break;
        case 'webrtc_answer':
            handleWebRTCAnswer(data);
            break;
        case 'webrtc_ice_candidate':
            handleWebRTCIceCandidate(data);
            break;
    }
}

// Handle incoming call
function handleIncomingCall(data) {
    if (isCallActive) {
        return; // Already in a call
    }
    
    const accept = confirm(`Eingehender ${data.call_type === 'video' ? 'Video' : 'Audio'}-Anruf von ${data.caller}. Annehmen?`);
    
    if (accept) {
        answerCall(data.call_id, data.call_type);
    } else {
        rejectCall(data.call_id);
    }
}

// Answer incoming call
async function answerCall(callId, callType) {
    try {
        currentCallId = callId;
        isCallActive = true;
        
        // Show call modal
        const callModal = new bootstrap.Modal(document.getElementById('callModal'));
        callModal.show();
        
        // Update UI
        document.getElementById('callTitle').textContent = callType === 'video' ? 'Videoanruf' : 'Anruf';
        document.getElementById('callIcon').className = callType === 'video' ? 'fas fa-video' : 'fas fa-phone';
        document.getElementById('callStatus').textContent = 'Verbunden';
        
        // Get user media
        const constraints = {
            audio: true,
            video: callType === 'video'
        };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        if (callType === 'video') {
            document.getElementById('localVideo').srcObject = localStream;
            document.getElementById('videoContainer').style.display = 'block';
            document.getElementById('videoBtn').style.display = 'inline-block';
            isVideoEnabled = true;
        }
        
        // Create peer connection
        createPeerConnection();
        
        // Send answer through WebSocket
        if (callSocket && callSocket.readyState === WebSocket.OPEN) {
            callSocket.send(JSON.stringify({
                type: 'call_answer',
                call_id: callId
            }));
        }
        
    } catch (error) {
        console.error('Error answering call:', error);
        alert('Fehler beim Annehmen des Anrufs');
        endCall();
    }
}

// Reject incoming call
function rejectCall(callId) {
    if (callSocket && callSocket.readyState === WebSocket.OPEN) {
        callSocket.send(JSON.stringify({
            type: 'call_reject',
            call_id: callId
        }));
    }
}

// Create peer connection
function createPeerConnection() {
    peerConnection = new RTCPeerConnection(rtcConfig);
    
    // Add local stream to peer connection
    if (localStream) {
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });
    }
    
    // Handle remote stream
    peerConnection.ontrack = function(event) {
        remoteStream = event.streams[0];
        document.getElementById('remoteVideo').srcObject = remoteStream;
    };
    
    // Handle ICE candidates
    peerConnection.onicecandidate = function(event) {
        if (event.candidate && callSocket && callSocket.readyState === WebSocket.OPEN) {
            callSocket.send(JSON.stringify({
                type: 'webrtc_ice_candidate',
                candidate: event.candidate
            }));
        }
    };
    
    // Handle connection state changes
    peerConnection.onconnectionstatechange = function() {
        console.log('Connection state:', peerConnection.connectionState);
        if (peerConnection.connectionState === 'connected') {
            document.getElementById('callStatus').textContent = 'Verbunden';
        } else if (peerConnection.connectionState === 'disconnected') {
            endCall();
        }
    };
}

// Handle WebRTC offer
async function handleWebRTCOffer(data) {
    try {
        if (!peerConnection) {
            createPeerConnection();
        }
        
        await peerConnection.setRemoteDescription(data.offer);
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        
        if (callSocket && callSocket.readyState === WebSocket.OPEN) {
            callSocket.send(JSON.stringify({
                type: 'webrtc_answer',
                answer: answer
            }));
        }
    } catch (error) {
        console.error('Error handling WebRTC offer:', error);
    }
}

// Handle WebRTC answer
async function handleWebRTCAnswer(data) {
    try {
        if (peerConnection) {
            await peerConnection.setRemoteDescription(data.answer);
        }
    } catch (error) {
        console.error('Error handling WebRTC answer:', error);
    }
}

// Handle WebRTC ICE candidate
async function handleWebRTCIceCandidate(data) {
    try {
        if (peerConnection) {
            await peerConnection.addIceCandidate(data.candidate);
        }
    } catch (error) {
        console.error('Error handling ICE candidate:', error);
    }
}

// Toggle mute
function toggleMute() {
    if (localStream) {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            isMuted = !audioTrack.enabled;
            
            const muteBtn = document.getElementById('muteBtn');
            if (isMuted) {
                muteBtn.classList.remove('btn-outline-secondary');
                muteBtn.classList.add('btn-danger');
                muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            } else {
                muteBtn.classList.remove('btn-danger');
                muteBtn.classList.add('btn-outline-secondary');
                muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }
    }
}

// Toggle video
function toggleVideo() {
    if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            isVideoEnabled = videoTrack.enabled;
            
            const videoBtn = document.getElementById('videoBtn');
            if (!isVideoEnabled) {
                videoBtn.classList.remove('btn-outline-secondary');
                videoBtn.classList.add('btn-danger');
                videoBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
            } else {
                videoBtn.classList.remove('btn-danger');
                videoBtn.classList.add('btn-outline-secondary');
                videoBtn.innerHTML = '<i class="fas fa-video"></i>';
            }
        }
    }
}

// End call
function endCall() {
    // Send end call message
    if (callSocket && callSocket.readyState === WebSocket.OPEN && currentCallId) {
        callSocket.send(JSON.stringify({
            type: 'call_end',
            call_id: currentCallId
        }));
    }
    
    // Clean up WebRTC
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }
    
    // Clean up media streams
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    if (remoteStream) {
        remoteStream.getTracks().forEach(track => track.stop());
        remoteStream = null;
    }
    
    // Close WebSocket
    if (callSocket) {
        callSocket.close();
        callSocket = null;
    }
    
    // Reset state
    isCallActive = false;
    currentCallId = null;
    isMuted = false;
    isVideoEnabled = false;
    
    // Hide call modal
    const callModal = bootstrap.Modal.getInstance(document.getElementById('callModal'));
    if (callModal) {
        callModal.hide();
    }
    
    // Reset UI
    document.getElementById('callStatus').textContent = 'Verbinde...';
    document.getElementById('muteBtn').className = 'btn btn-outline-secondary me-2';
    document.getElementById('muteBtn').innerHTML = '<i class="fas fa-microphone"></i>';
    document.getElementById('videoBtn').className = 'btn btn-outline-secondary me-2';
    document.getElementById('videoBtn').innerHTML = '<i class="fas fa-video"></i>';
    document.getElementById('localVideo').srcObject = null;
    document.getElementById('remoteVideo').srcObject = null;
}

// Handle call events
function handleCallAnswered(data) {
    document.getElementById('callStatus').textContent = 'Verbunden';
    
    // Create peer connection and send offer
    createPeerConnection();
    
    setTimeout(async () => {
        try {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            if (callSocket && callSocket.readyState === WebSocket.OPEN) {
                callSocket.send(JSON.stringify({
                    type: 'webrtc_offer',
                    offer: offer
                }));
            }
        } catch (error) {
            console.error('Error creating offer:', error);
        }
    }, 1000);
}

function handleCallRejected(data) {
    alert('Anruf wurde abgelehnt');
    endCall();
}

function handleCallEnded(data) {
    alert('Anruf wurde beendet');
    endCall();
}
</script>
{% endblock %}