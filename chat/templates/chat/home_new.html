{% extends 'base.html' %}
{% load static %}

{% block title %}Chat System{% endblock %}

{% block content %}
<div class="chat-app">
    <div class="chat-sidebar">
        <div class="chat-header-fixed">
            <h4><i class="fas fa-comments me-2"></i>Chats</h4>
            <button class="btn btn-outline-primary btn-sm" onclick="createNewChat()">
                <i class="fas fa-plus"></i> Neuer Chat
            </button>
        </div>

        <div class="search-container">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="chatSearch" placeholder="Chats durchsuchen...">
            </div>
        </div>

        <div class="chat-list-container">
            {% for room in chat_rooms %}
            <div class="chat-item" data-room-id="{{ room.id }}">
                <div class="chat-item-content" onclick="chatManager.loadChat({{ room.id }})">
                <div class="chat-avatar">
                    {% if room.is_group_chat %}
                        <i class="fas fa-users"></i>
                    {% elif room.profile_picture_url %}
                        <img src="{{ room.profile_picture_url }}" alt="Profilbild" class="profile-image">
                    {% else %}
                        <span class="avatar-text">{{ room.avatar_text }}</span>
                    {% endif %}
                </div>
                <div class="chat-info">
                    <div class="chat-name">{{ room.display_name|default:room.name }}</div>
                    <div class="chat-meta-line">
                        {% if not room.is_group_chat %}
                            <span class="online-status {{ room.online_status_class|default:'text-muted' }}">
                                <i class="fas fa-circle" style="font-size: 0.6rem;"></i>
                                {{ room.online_status_text|default:"Offline" }}
                            </span>
                        {% endif %}
                        <div class="chat-preview">{{ room.last_message|default:"Keine Nachrichten" }}</div>
                    </div>
                </div>
                <div class="chat-meta">
                    <div class="chat-time">{{ room.last_message_time|date:"H:i"|default:"" }}</div>
                    {% if room.unread_count > 0 %}
                    <span class="unread-badge">{{ room.unread_count }}</span>
                    {% endif %}
                </div>
                </div>
                <div class="chat-item-actions">
                    <button class="btn-delete-chat" onclick="deleteChat({{ room.id }}, event)" title="Chat lÃ¶schen">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="chat-main">
        <div class="chat-welcome" id="chatWelcome">
            <div class="welcome-content">
                <i class="fas fa-comments fa-4x mb-3"></i>
                <h3>Willkommen im Chat</h3>
                <p class="text-muted">WÃ¤hlen Sie einen Chat aus der Liste, um zu beginnen</p>
            </div>
        </div>

        <div class="active-chat" id="activeChat" style="display: none;">
            <div class="chat-header-main">
                <div class="chat-info-main">
                    <div class="chat-avatar-main">
                        <div id="activeChatAvatar">ðŸ‘¤</div>
                    </div>
                    <div class="chat-details">
                        <h5 id="activeChatName">Chat Name</h5>
                        <small id="activeChatStatus" class="text-muted">Online Status</small>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="btn btn-outline-secondary btn-sm" onclick="showChatInfo()" title="Benutzerinformationen">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteCurrentChat()" title="Chat lÃ¶schen">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="messages-area" id="messagesArea">
                <div class="messages-content" id="messagesContent">
                    <!-- Messages will be loaded here -->
                </div>
            </div>

            <div class="message-input-area">
                <div class="input-container">
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="text" class="form-control" id="messageInput"
                               placeholder="Nachricht eingeben..." onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" onclick="chatManager.sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Reset and base styles */
* {
    box-sizing: border-box;
}

/* Dark Mode Variables */
{% if user.is_authenticated and user.dark_mode %}
:root {
    --chat-bg-primary: #212529;
    --chat-bg-secondary: #343a40;
    --chat-bg-tertiary: #495057;
    --chat-text-primary: #ffffff;
    --chat-text-secondary: #adb5bd;
    --chat-border: #495057;
    --chat-hover: #6c757d;
}
{% else %}
:root {
    --chat-bg-primary: #ffffff;
    --chat-bg-secondary: #f8f9fa;
    --chat-bg-tertiary: #ffffff;
    --chat-text-primary: #212529;
    --chat-text-secondary: #6c757d;
    --chat-border: #e9ecef;
    --chat-hover: #f8f9fa;
}
{% endif %}

.chat-app {
    display: flex;
    height: 100vh;
    max-height: 100vh;
    background: var(--chat-bg-primary);
    color: var(--chat-text-primary);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Sidebar styles */
.chat-sidebar {
    width: 350px;
    background: var(--chat-bg-secondary);
    border-right: 1px solid var(--chat-border);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.chat-header-fixed {
    padding: 20px;
    border-bottom: 1px solid var(--chat-border);
    background: var(--chat-bg-tertiary);
    color: var(--chat-text-primary);
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.search-container {
    padding: 15px 20px;
    background: var(--chat-bg-tertiary);
    border-bottom: 1px solid var(--chat-border);
    flex-shrink: 0;
}

.chat-list-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 0;
}

/* Chat item styles */
.chat-item {
    display: flex;
    padding: 15px 20px;
    cursor: pointer;
    border-bottom: 1px solid var(--chat-border);
    transition: background-color 0.2s;
    position: relative;
}

.chat-item:hover {
    background: var(--chat-hover);
}

.chat-item.active {
    background: var(--chat-hover);
}

.chat-item-content {
    display: flex;
    flex: 1;
    align-items: center;
    min-width: 0;
}

.chat-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    flex-shrink: 0;
    margin-right: 15px;
}

.chat-info {
    flex: 1;
    min-width: 0;
}

.chat-name {
    font-weight: 600;
    color: var(--chat-text-primary);
    margin-bottom: 5px;
}

.chat-preview {
    color: var(--chat-text-secondary);
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.unread-badge {
    background: #dc3545;
    color: white;
    border-radius: 10px;
    padding: 2px 8px;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Main chat area */
.chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--chat-bg-primary);
}

.chat-welcome {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.active-chat {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.chat-header-main {
    padding: 20px;
    border-bottom: 1px solid var(--chat-border);
    background: var(--chat-bg-tertiary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.messages-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.message-input-area {
    padding: 20px;
    border-top: 1px solid var(--chat-border);
    background: var(--chat-bg-tertiary);
}

/* Message styles */
.message {
    display: flex;
    margin-bottom: 15px;
}

.message.own {
    flex-direction: row-reverse;
}

.message-content {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    background: var(--chat-bg-secondary);
    color: var(--chat-text-primary);
}

.message.own .message-content {
    background: #007bff;
    color: white;
}

.message-time {
    font-size: 0.75rem;
    color: var(--chat-text-secondary);
    margin-top: 5px;
}
</style>

<!-- Optimized Chat JavaScript -->
<script>
// Advanced Chat Manager with Adaptive Polling
class ChatManager {
    constructor() {
        this.currentRoomId = null;
        this.pollingInterval = null;
        this.onlineStatusInterval = null;
        this.lastMessageId = null;
        this.lastActivity = Date.now();
        this.isTabVisible = true;
        this.requestQueue = [];
        this.abortController = null;
        this.notificationPermission = false;

        // Adaptive polling intervals (milliseconds)
        this.intervals = {
            active: 3000,     // 3 seconds when actively chatting
            normal: 8000,     // 8 seconds for normal activity
            idle: 20000,      // 20 seconds when idle
            background: 60000 // 60 seconds when tab is hidden
        };

        // Initialize visibility API
        this.initVisibilityHandlers();

        // Initialize notifications
        this.initNotifications();

        // Start online status updates
        this.startOnlineStatusUpdates();

        // Initialize performance monitoring
        this.performanceMetrics = {
            avgResponseTime: 0,
            requestCount: 0,
            errorCount: 0
        };
    }

    initVisibilityHandlers() {
        // Handle tab visibility changes
        document.addEventListener('visibilitychange', () => {
            this.isTabVisible = !document.hidden;
            this.adjustPollingFrequency();

            if (this.isTabVisible && this.currentRoomId) {
                // Tab became visible, do an immediate update
                this.checkForUpdates();
                this.sendOnlineStatusToServer();
            }
        });

        // Handle window focus/blur
        window.addEventListener('focus', () => {
            this.isTabVisible = true;
            this.adjustPollingFrequency();
            this.sendOnlineStatusToServer();
        });

        window.addEventListener('blur', () => {
            this.isTabVisible = false;
            this.adjustPollingFrequency();
        });
    }

    initNotifications() {
        // Request permission for notifications
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                this.notificationPermission = permission === 'granted';
            });
        } else if ('Notification' in window && Notification.permission === 'granted') {
            this.notificationPermission = true;
        }
    }

    startOnlineStatusUpdates() {
        // Update online status every 30 seconds
        this.sendOnlineStatusToServer();
        this.onlineStatusInterval = setInterval(() => {
            this.sendOnlineStatusToServer();
        }, 30000);
    }

    sendOnlineStatusToServer() {
        // Send online status update to server
        fetch('/chat/update-online-status/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
    }

    adjustPollingFrequency() {
        if (!this.currentRoomId) return;

        // Clear existing interval
        if (this.pollingInterval) {
            clearInterval(this.pollingInterval);
        }

        // Determine appropriate interval
        let interval;
        const timeSinceActivity = Date.now() - this.lastActivity;

        if (!this.isTabVisible) {
            interval = this.intervals.background;
        } else if (timeSinceActivity < 60000) { // Active in last minute
            interval = this.intervals.active;
        } else if (timeSinceActivity < 300000) { // Active in last 5 minutes
            interval = this.intervals.normal;
        } else {
            interval = this.intervals.idle;
        }

        console.log(`Polling interval adjusted to ${interval}ms`);

        // Set new interval
        this.pollingInterval = setInterval(() => {
            this.checkForUpdates();
        }, interval);
    }

    async makeRequest(url, options = {}) {
        // Cancel any pending request
        if (this.abortController) {
            this.abortController.abort();
        }

        this.abortController = new AbortController();
        const startTime = performance.now();

        try {
            const response = await fetch(url, {
                ...options,
                signal: this.abortController.signal
            });

            const responseTime = performance.now() - startTime;
            this.updatePerformanceMetrics(responseTime);

            return response;
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Request aborted');
            } else {
                this.performanceMetrics.errorCount++;
                throw error;
            }
        }
    }

    updatePerformanceMetrics(responseTime) {
        this.performanceMetrics.requestCount++;
        this.performanceMetrics.avgResponseTime =
            (this.performanceMetrics.avgResponseTime * (this.performanceMetrics.requestCount - 1) + responseTime)
            / this.performanceMetrics.requestCount;

        // Auto-adjust if response times are too slow
        if (this.performanceMetrics.avgResponseTime > 3000 && this.intervals.active < 10000) {
            this.intervals.active = Math.min(this.intervals.active * 1.5, 10000);
            this.intervals.normal = Math.min(this.intervals.normal * 1.5, 20000);
        }
    }

    async loadChat(roomId) {
        if (this.currentRoomId === roomId) return;

        this.currentRoomId = roomId;
        this.lastActivity = Date.now();
        this.lastMessageId = null; // Reset to load all messages

        // Update UI
        document.getElementById('chatWelcome').style.display = 'none';
        document.getElementById('activeChat').style.display = 'flex';

        // Clear messages area for fresh load
        document.getElementById('messagesContent').innerHTML = '';

        // Update active state and clear unread badge
        document.querySelectorAll('.chat-item').forEach(item => {
            const isActive = item.dataset.roomId == roomId;
            item.classList.toggle('active', isActive);

            // Clear unread badge for selected room
            if (isActive) {
                const badge = item.querySelector('.unread-badge');
                if (badge) {
                    badge.style.display = 'none';
                }
            }
        });

        // Load chat data
        await this.batchUpdate();

        // Mark messages as read
        fetch(`/chat/api/room/${roomId}/mark_read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        // Start adaptive polling
        this.adjustPollingFrequency();
    }

    async batchUpdate() {
        if (!this.currentRoomId) return;

        try {
            const response = await this.makeRequest(`/chat/api/batch/${this.currentRoomId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    last_message_id: this.lastMessageId,
                    include_room_info: true,  // Always include to get online status
                    include_participants: true  // Always include for status updates
                })
            });

            if (!response || !response.ok) return;

            const data = await response.json();

            if (data.success) {
                // Update room info if provided
                if (data.room_info) {
                    this.updateRoomInfo(data.room_info);
                }

                // Update messages if new ones exist
                if (data.messages && data.messages.length > 0) {
                    this.displayMessages(data.messages);
                    this.lastMessageId = data.last_message_id;

                    // Show notification for new messages (not from self)
                    const newMessages = data.messages.filter(msg => !msg.is_own);
                    if (newMessages.length > 0 && !this.isTabVisible) {
                        this.showNotification(newMessages[newMessages.length - 1]);
                    }
                }

                // Update unread counts
                if (data.unread_counts) {
                    this.updateUnreadCounts(data.unread_counts);
                }

                // Update online status
                if (data.online_status) {
                    this.updateOnlineStatus(data.online_status);
                }
            }
        } catch (error) {
            console.error('Batch update error:', error);
        }
    }

    async checkForUpdates() {
        if (document.hidden && !this.isTabVisible) return;

        // Use requestIdleCallback for non-critical updates
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => this.batchUpdate(), { timeout: 2000 });
        } else {
            await this.batchUpdate();
        }
    }

    updateRoomInfo(roomInfo) {
        document.getElementById('activeChatName').textContent = roomInfo.name || 'Chat';

        const avatarElement = document.getElementById('activeChatAvatar');
        if (roomInfo.profile_picture_url) {
            avatarElement.innerHTML = `<img src="${roomInfo.profile_picture_url}" alt="Profile" class="profile-image">`;
        } else {
            avatarElement.textContent = roomInfo.avatar_text || 'ðŸ‘¤';
        }

        const statusElement = document.getElementById('activeChatStatus');
        if (roomInfo.is_online !== undefined) {
            statusElement.innerHTML = roomInfo.is_online ?
                '<i class="fas fa-circle text-success" style="font-size: 0.6rem;"></i> Online' :
                '<i class="fas fa-circle text-muted" style="font-size: 0.6rem;"></i> Offline';
        } else if (roomInfo.is_group_chat) {
            statusElement.innerHTML = '<i class="fas fa-users text-info" style="font-size: 0.6rem;"></i> Gruppenchat';
        } else {
            statusElement.innerHTML = '<i class="fas fa-circle text-muted" style="font-size: 0.6rem;"></i> Status unbekannt';
        }
    }

    displayMessages(messages) {
        const messagesContent = document.getElementById('messagesContent');
        const shouldScroll = this.isNearBottom();

        // Use DocumentFragment for better performance
        const fragment = document.createDocumentFragment();

        messages.forEach(message => {
            if (document.querySelector(`[data-message-id="${message.id}"]`)) {
                return; // Message already displayed
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.is_own ? 'own' : ''}`;
            messageDiv.dataset.messageId = message.id;

            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${this.escapeHtml(message.content)}</div>
                    <div class="message-time">${message.formatted_time}</div>
                </div>
            `;

            fragment.appendChild(messageDiv);
        });

        messagesContent.appendChild(fragment);

        if (shouldScroll) {
            this.scrollToBottom();
        }
    }

    async sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();

        if (!content || !this.currentRoomId) return;

        this.lastActivity = Date.now();
        input.value = '';

        try {
            const response = await this.makeRequest(`/chat/api/room/${this.currentRoomId}/send/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `content=${encodeURIComponent(content)}`
            });

            if (!response || !response.ok) return;

            const data = await response.json();

            if (data.success) {
                // Display message immediately
                this.displayMessages([data.message]);
                this.lastMessageId = data.message.id;

                // Adjust polling to active mode
                this.adjustPollingFrequency();
            }
        } catch (error) {
            console.error('Send message error:', error);
            input.value = content; // Restore message on error
        }
    }

    updateUnreadCounts(counts) {
        // Update all room badges
        document.querySelectorAll('.chat-item').forEach(item => {
            const roomId = item.dataset.roomId;
            const badge = item.querySelector('.unread-badge');
            if (badge) {
                const count = counts[roomId] || 0;
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        });

        // Clear badge for current room
        if (this.currentRoomId) {
            const currentBadge = document.querySelector(`[data-room-id="${this.currentRoomId}"] .unread-badge`);
            if (currentBadge) {
                currentBadge.style.display = 'none';
            }
        }
    }

    updateOnlineStatus(statuses) {
        if (!statuses || typeof statuses !== 'object') return;

        Object.entries(statuses).forEach(([userId, isOnline]) => {
            const statusElements = document.querySelectorAll(`[data-user-id="${userId}"] .online-status`);
            statusElements.forEach(element => {
                element.innerHTML = isOnline ?
                    '<i class="fas fa-circle text-success" style="font-size: 0.6rem;"></i> Online' :
                    '<i class="fas fa-circle text-muted" style="font-size: 0.6rem;"></i> Offline';
            });
        });
    }

    isNearBottom() {
        const messagesArea = document.getElementById('messagesArea');
        return messagesArea.scrollHeight - messagesArea.scrollTop - messagesArea.clientHeight < 100;
    }

    scrollToBottom() {
        const messagesArea = document.getElementById('messagesArea');
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    showNotification(message) {
        if (this.notificationPermission && 'Notification' in window) {
            const notification = new Notification('Neue Nachricht', {
                body: `${message.sender}: ${message.content.substring(0, 100)}`,
                icon: '/static/images/chat-icon.png',
                tag: 'chat-message',
                requireInteraction: false
            });

            notification.onclick = () => {
                window.focus();
                if (this.currentRoomId) {
                    this.checkForUpdates();
                }
                notification.close();
            };

            // Auto-close after 5 seconds
            setTimeout(() => notification.close(), 5000);
        }
    }

    cleanup() {
        if (this.pollingInterval) {
            clearInterval(this.pollingInterval);
        }
        if (this.onlineStatusInterval) {
            clearInterval(this.onlineStatusInterval);
        }
        if (this.abortController) {
            this.abortController.abort();
        }

        // Set offline status
        navigator.sendBeacon('/chat/set-offline/', new FormData());
    }
}

// Initialize chat manager
const chatManager = new ChatManager();

// Stop global chat notifications if they exist (we handle it locally)
if (window.globalChatNotifications) {
    try {
        window.globalChatNotifications.cleanup();
        window.globalChatNotifications = null;
    } catch (error) {
        console.warn('Error stopping global notifications:', error);
    }
}

// Helper functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        chatManager.sendMessage();
    }
}

function showChatInfo() {
    if (!chatManager.currentRoomId) return;

    fetch(`/chat/api/room/${chatManager.currentRoomId}/info/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show chat info modal or sidebar
                alert(`Chat Info:\n${JSON.stringify(data.room, null, 2)}`);
            }
        });
}

function deleteCurrentChat() {
    if (!chatManager.currentRoomId) return;

    if (confirm('MÃ¶chten Sie diesen Chat wirklich lÃ¶schen?')) {
        deleteChat(chatManager.currentRoomId);
    }
}

function deleteChat(roomId, event) {
    if (event) {
        event.stopPropagation();
    }

    fetch(`/chat/api/room/${roomId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove from list
            document.querySelector(`[data-room-id="${roomId}"]`).remove();

            // If this was the active chat, show welcome
            if (chatManager.currentRoomId === roomId) {
                chatManager.currentRoomId = null;
                document.getElementById('chatWelcome').style.display = 'flex';
                document.getElementById('activeChat').style.display = 'none';
            }
        }
    });
}

function createNewChat() {
    window.location.href = '/chat/search/';
}

// Global function to update chat list
function updateChatList() {
    fetch('/chat/unread-count/')
        .then(response => response.json())
        .then(data => {
            // Update total unread count if you have a global badge
            const totalUnread = data.unread_count || 0;

            // Update document title with unread count
            if (totalUnread > 0) {
                document.title = `(${totalUnread}) Chat System`;
            } else {
                document.title = 'Chat System';
            }
        });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize search
    const searchInput = document.getElementById('chatSearch');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.toLowerCase();

            searchTimeout = setTimeout(() => {
                document.querySelectorAll('.chat-item').forEach(item => {
                    const name = item.querySelector('.chat-name').textContent.toLowerCase();
                    const preview = item.querySelector('.chat-preview').textContent.toLowerCase();
                    item.style.display = (name.includes(query) || preview.includes(query)) ? 'flex' : 'none';
                });
            }, 300);
        });
    }

    // Check URL for auto-load room
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');
    if (roomId) {
        chatManager.loadChat(parseInt(roomId));
    }

    // Start global chat list updates
    updateChatList();
    setInterval(updateChatList, 30000); // Every 30 seconds
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    chatManager.cleanup();
});
</script>
{% endblock %}