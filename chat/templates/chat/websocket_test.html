{% extends 'base.html' %}

{% block title %}WebSocket Test{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4>WebSocket Verbindungstest</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h5>Status:</h5>
                        <div id="status" class="alert alert-info">Initialisiere...</div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Verbindungsdetails:</h5>
                        <div id="connection-info" class="text-muted"></div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Nachrichten:</h5>
                        <div id="messages" class="border rounded p-3" style="height: 200px; overflow-y: auto;">
                            <em>Keine Nachrichten</em>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <button class="btn btn-primary" onclick="testConnection()">Verbindung testen</button>
                        <button class="btn btn-success" onclick="sendTestMessage()">Test-Nachricht senden</button>
                        <button class="btn btn-danger" onclick="closeConnection()">Verbindung trennen</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let socket = null;
const statusDiv = document.getElementById('status');
const messagesDiv = document.getElementById('messages');
const connectionInfo = document.getElementById('connection-info');

function updateStatus(message, type = 'info') {
    statusDiv.className = `alert alert-${type}`;
    statusDiv.textContent = message;
}

function addMessage(message) {
    const msgElement = document.createElement('div');
    msgElement.className = 'mb-2';
    msgElement.innerHTML = `<small class="text-muted">${new Date().toLocaleTimeString()}</small> ${message}`;
    messagesDiv.appendChild(msgElement);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function testConnection() {
    if (socket && socket.readyState === WebSocket.OPEN) {
        updateStatus('WebSocket bereits verbunden', 'success');
        return;
    }
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsHost = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost' 
        ? '127.0.0.1:8001' 
        : window.location.host;
    const wsUrl = `${protocol}//${wsHost}/ws/call/test/`;
    
    connectionInfo.innerHTML = `
        <strong>WebSocket URL:</strong> ${wsUrl}<br>
        <strong>Protocol:</strong> ${protocol}<br>
        <strong>Host:</strong> ${wsHost}
    `;
    
    updateStatus('Verbinde zu WebSocket...', 'warning');
    messagesDiv.innerHTML = '';
    
    try {
        socket = new WebSocket(wsUrl);
        
        socket.onopen = function(e) {
            updateStatus('✅ WebSocket erfolgreich verbunden!', 'success');
            addMessage('<strong>Verbindung hergestellt</strong>');
        };
        
        socket.onmessage = function(e) {
            addMessage(`<strong>Empfangen:</strong> ${e.data}`);
        };
        
        socket.onclose = function(e) {
            if (e.code === 1000) {
                updateStatus('WebSocket Verbindung geschlossen', 'info');
            } else {
                updateStatus(`❌ WebSocket Verbindung unterbrochen (Code: ${e.code})`, 'danger');
            }
            addMessage(`<strong>Verbindung geschlossen</strong> (Code: ${e.code}, Reason: ${e.reason || 'Keine Angabe'})`);
        };
        
        socket.onerror = function(e) {
            updateStatus('❌ WebSocket Fehler aufgetreten', 'danger');
            addMessage('<strong class="text-danger">Verbindungsfehler</strong>');
            
            // Zusätzliche Debugging-Informationen
            connectionInfo.innerHTML += `
                <br><strong class="text-danger">Fehler:</strong> Kann keine Verbindung herstellen<br>
                <strong>Mögliche Ursachen:</strong><br>
                - WebSocket-Server (Daphne) läuft nicht auf Port 8001<br>
                - Firewall blockiert die Verbindung<br>
                - CORS-Probleme
            `;
        };
        
    } catch (error) {
        updateStatus(`❌ Fehler: ${error.message}`, 'danger');
        addMessage(`<strong class="text-danger">Exception:</strong> ${error.message}`);
    }
}

function sendTestMessage() {
    if (!socket || socket.readyState !== WebSocket.OPEN) {
        updateStatus('Keine aktive WebSocket-Verbindung', 'warning');
        return;
    }
    
    const testMessage = {
        type: 'test',
        message: 'Hallo WebSocket Server!',
        timestamp: new Date().toISOString()
    };
    
    socket.send(JSON.stringify(testMessage));
    addMessage(`<strong>Gesendet:</strong> ${JSON.stringify(testMessage)}`);
}

function closeConnection() {
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close(1000, 'Test beendet');
        updateStatus('Verbindung wird getrennt...', 'warning');
    } else {
        updateStatus('Keine aktive Verbindung', 'info');
    }
}

// Auto-Test beim Laden
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(testConnection, 1000);
});
</script>
{% endblock %}