{% extends "base.html" %}
{% load static %}

{% block title %}{{ project.keyword }} | VSkript{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'vskript:dashboard' %}">VSkript</a></li>
                    <li class="breadcrumb-item active">{{ project.keyword|truncatechars:30 }}</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h2 mb-0">
                    <i class="bi bi-camera-video me-2"></i>{{ project.keyword }}
                </h1>
                <div>
                    <form method="post" action="{% url 'vskript:delete' project_id=project.id %}"
                          style="display: inline;"
                          onsubmit="return confirm('Skript wirklich löschen?')">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> Löschen
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Skript-Bereich -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-file-text me-1"></i>Videoskript
                    </h5>
                    <div>
                        {% if project.script %}
                        <span class="badge bg-success me-2">
                            <i class="bi bi-alphabet me-1"></i>{{ project.word_count }} Worte
                        </span>
                        <span class="badge bg-info me-2">
                            <i class="bi bi-clock me-1"></i>{{ project.estimated_duration }} Min
                        </span>
                        <span class="badge bg-secondary">
                            <i class="bi bi-robot me-1"></i>{{ project.get_ai_model_display }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if not project.script %}
                    <!-- Skript noch nicht generiert -->
                    <div class="text-center py-5" id="generateSection">
                        <i class="bi bi-magic" style="font-size: 3rem; color: #6c757d;"></i>
                        <h5 class="mt-3">Skript generieren</h5>
                        <p class="text-muted">Klicke auf den Button um dein Skript zu erstellen.</p>
                        <button type="button" class="btn btn-primary btn-lg" id="generateBtn" onclick="generateScript()">
                            <i class="bi bi-stars me-1"></i>Skript generieren
                        </button>
                    </div>
                    {% endif %}

                    <!-- Loading -->
                    <div class="text-center py-5 d-none" id="loadingSection">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Lädt...</span>
                        </div>
                        <h5 class="mt-3">Skript wird generiert...</h5>
                        <p class="text-muted">Das kann einige Sekunden dauern.</p>
                    </div>

                    <!-- Skript Anzeige -->
                    <div id="scriptSection" {% if not project.script %}class="d-none"{% endif %}>
                        <form method="post" id="saveForm">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="save_script">

                            <textarea class="form-control" id="scriptText" name="script"
                                      rows="15" style="font-size: 1.1rem; line-height: 1.8;">{{ project.script }}</textarea>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>
                                    <span class="text-muted" id="wordCountDisplay">
                                        {{ project.word_count }} Worte | {{ project.estimated_duration }} Min | <i class="bi bi-robot"></i> {{ project.get_ai_model_display }}
                                    </span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="copyScript()">
                                        <i class="bi bi-clipboard me-1"></i>Kopieren
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="regenerateScript()">
                                        <i class="bi bi-arrow-repeat me-1"></i>Neu generieren
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-check-lg me-1"></i>Speichern
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Bilder-Bereich -->
            {% if project.script %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-images me-1"></i>Bilder zum Skript
                    </h5>
                    <div>
                        <span class="badge bg-info me-2" id="imageCountBadge">
                            <i class="bi bi-image me-1"></i>{{ images.count }} Bilder
                        </span>
                        <span class="badge bg-secondary">
                            <i class="bi bi-robot me-1"></i>{{ project.get_image_model_display }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Keine Bilder vorhanden -->
                    <div id="noImagesSection" {% if images %}class="d-none"{% endif %}>
                        <div class="text-center py-4">
                            <i class="bi bi-images" style="font-size: 3rem; color: #6c757d;"></i>
                            <h5 class="mt-3">Bilder generieren</h5>
                            <p class="text-muted">Erstelle Bilder basierend auf deinem Skript.</p>
                            <button type="button" class="btn btn-primary" onclick="generateAllImages()">
                                <i class="bi bi-stars me-1"></i>Bilder generieren
                            </button>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div class="text-center py-4 d-none" id="imageLoadingSection">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Lädt...</span>
                        </div>
                        <h5 class="mt-3">Bilder werden erstellt...</h5>
                        <p class="text-muted" id="imageLoadingText">Prompts werden generiert...</p>
                        <div class="progress mt-3" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 id="imageProgressBar" role="progressbar" style="width: 0%">0%</div>
                        </div>
                    </div>

                    <!-- Bilder Grid -->
                    <div id="imagesGrid" {% if not images %}class="d-none"{% endif %}>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="generateAllImages()">
                                    <i class="bi bi-arrow-repeat me-1"></i>Alle neu generieren
                                </button>
                                <a href="{% url 'vskript:api_download_all_images' project_id=project.id %}"
                                   class="btn btn-outline-success btn-sm" id="downloadAllBtn">
                                    <i class="bi bi-download me-1"></i>Alle herunterladen (ZIP)
                                </a>
                            </div>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteAllImages()">
                                <i class="bi bi-trash me-1"></i>Alle löschen
                            </button>
                        </div>

                        <div class="row g-3" id="imagesList">
                            {% for image in images %}
                            <div class="col-md-4 col-lg-3" id="image-card-{{ image.id }}">
                                <div class="card h-100">
                                    <div class="position-relative">
                                        {% if image.image_file %}
                                        <img src="{{ image.image_file.url }}" class="card-img-top"
                                             alt="Bild {{ image.order|add:1 }}" style="height: 150px; object-fit: cover;">
                                        {% elif image.status == 'generating' %}
                                        <div class="d-flex align-items-center justify-content-center bg-light"
                                             style="height: 150px;">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Generiert...</span>
                                            </div>
                                        </div>
                                        {% elif image.status == 'failed' %}
                                        <div class="d-flex align-items-center justify-content-center bg-danger bg-opacity-10"
                                             style="height: 150px;">
                                            <i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
                                        </div>
                                        {% else %}
                                        <div class="d-flex align-items-center justify-content-center bg-light"
                                             style="height: 150px;">
                                            <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                                        </div>
                                        {% endif %}
                                        <span class="position-absolute top-0 start-0 badge bg-dark m-1">
                                            {{ image.position_seconds|floatformat:0 }}s
                                        </span>
                                    </div>
                                    <div class="card-body p-2">
                                        <p class="card-text small text-muted mb-2" style="height: 40px; overflow: hidden;">
                                            {{ image.prompt|truncatechars:60 }}
                                        </p>
                                        <div class="btn-group btn-group-sm w-100">
                                            <button type="button" class="btn btn-outline-primary"
                                                    onclick="regenerateImage('{{ image.id }}')" title="Neu generieren">
                                                <i class="bi bi-arrow-repeat"></i>
                                            </button>
                                            {% if image.image_file %}
                                            <a href="{% url 'vskript:api_download_image' image_id=image.id %}"
                                               class="btn btn-outline-success" title="Herunterladen">
                                                <i class="bi bi-download"></i>
                                            </a>
                                            {% endif %}
                                            <button type="button" class="btn btn-outline-danger"
                                                    onclick="deleteImage('{{ image.id }}')" title="Löschen">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Einstellungen Sidebar -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-gear me-1"></i>Einstellungen</h6>
                </div>
                <div class="card-body">
                    <form method="post" id="settingsForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_settings">

                        <div class="mb-3">
                            <label for="keyword" class="form-label small fw-bold">Keyword</label>
                            <input type="text" class="form-control form-control-sm"
                                   id="keyword" name="keyword" value="{{ project.keyword }}">
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label small fw-bold">Beschreibung</label>
                            <textarea class="form-control form-control-sm" id="description"
                                      name="description" rows="2">{{ project.description }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="script_type" class="form-label small fw-bold">Skript-Art</label>
                            <select class="form-select form-select-sm" id="script_type" name="script_type">
                                {% for value, label in script_types %}
                                <option value="{{ value }}" {% if project.script_type == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="tone" class="form-label small fw-bold">Ton</label>
                            <select class="form-select form-select-sm" id="tone" name="tone">
                                {% for value, label in tones %}
                                <option value="{{ value }}" {% if project.tone == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="target_audience" class="form-label small fw-bold">Zielgruppe</label>
                            <select class="form-select form-select-sm" id="target_audience" name="target_audience">
                                {% for value, label in target_audiences %}
                                <option value="{{ value }}" {% if project.target_audience == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="platform" class="form-label small fw-bold">Plattform</label>
                            <select class="form-select form-select-sm" id="platform" name="platform">
                                {% for value, label in platforms %}
                                <option value="{{ value }}" {% if project.platform == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="duration" class="form-label small fw-bold">Video-Länge</label>
                            <select class="form-select form-select-sm" id="duration" name="duration">
                                {% for value, label in durations %}
                                <option value="{{ value }}" {% if project.duration == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="ai_model" class="form-label small fw-bold">KI-Modell</label>
                            <select class="form-select form-select-sm" id="ai_model" name="ai_model">
                                {% for value, label in ai_models %}
                                <option value="{{ value }}" {% if project.ai_model == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="submit" class="btn btn-outline-primary btn-sm w-100">
                            <i class="bi bi-save me-1"></i>Einstellungen speichern
                        </button>
                    </form>
                </div>
            </div>

            <!-- Bild-Einstellungen -->
            {% if project.script %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-image me-1"></i>Bild-Einstellungen</h6>
                </div>
                <div class="card-body">
                    <form method="post" id="imageSettingsForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_image_settings">

                        <div class="mb-3">
                            <label for="image_interval" class="form-label small fw-bold">Bild-Intervall</label>
                            <select class="form-select form-select-sm" id="image_interval" name="image_interval">
                                {% for value, label in image_intervals %}
                                <option value="{{ value }}" {% if project.image_interval == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="image_style" class="form-label small fw-bold">Bild-Stil</label>
                            <select class="form-select form-select-sm" id="image_style" name="image_style">
                                {% for value, label in image_styles %}
                                <option value="{{ value }}" {% if project.image_style == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="image_model" class="form-label small fw-bold">Bild-KI-Modell</label>
                            <select class="form-select form-select-sm" id="image_model" name="image_model">
                                {% for value, label in image_models %}
                                <option value="{{ value }}" {% if project.image_model == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="image_format" class="form-label small fw-bold">Bild-Format</label>
                            <select class="form-select form-select-sm" id="image_format" name="image_format">
                                {% for value, label in image_formats %}
                                <option value="{{ value }}" {% if project.image_format == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="submit" class="btn btn-outline-primary btn-sm w-100">
                            <i class="bi bi-save me-1"></i>Bild-Einstellungen speichern
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Info Card -->
            <div class="card bg-light">
                <div class="card-body small">
                    <p class="mb-1"><strong>Erstellt:</strong> {{ project.created_at|date:"d.m.Y H:i" }}</p>
                    <p class="mb-0"><strong>Aktualisiert:</strong> {{ project.updated_at|date:"d.m.Y H:i" }}</p>
                </div>
            </div>

            {% if generation_logs %}
            <!-- Generation History -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-clock-history me-1"></i>Generierungs-Historie</h6>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush small">
                        {% for log in generation_logs %}
                        <li class="list-group-item d-flex justify-content-between">
                            <span>{{ log.created_at|date:"d.m. H:i" }}</span>
                            <span class="text-muted">{{ log.model|truncatechars:15 }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
const projectId = '{{ project.id }}';
const csrfToken = '{{ csrf_token }}';
let currentModelLabel = '{{ project.get_ai_model_display }}';

function generateScript() {
    const generateSection = document.getElementById('generateSection');
    const loadingSection = document.getElementById('loadingSection');
    const scriptSection = document.getElementById('scriptSection');

    if (generateSection) generateSection.classList.add('d-none');
    loadingSection.classList.remove('d-none');

    fetch('{% url "vskript:api_generate" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            keyword: '{{ project.keyword|escapejs }}',
            description: '{{ project.description|escapejs }}',
            script_type: '{{ project.script_type }}',
            tone: '{{ project.tone }}',
            target_audience: '{{ project.target_audience }}',
            platform: '{{ project.platform }}',
            duration: {{ project.duration }},
            ai_model: '{{ project.ai_model }}',
            project_id: projectId
        })
    })
    .then(response => response.json())
    .then(data => {
        loadingSection.classList.add('d-none');

        if (data.success) {
            document.getElementById('scriptText').value = data.script;
            currentModelLabel = data.ai_model_label;
            document.getElementById('wordCountDisplay').innerHTML =
                data.word_count + ' Worte | ' + data.estimated_duration + ' Min | <i class="bi bi-robot"></i> ' + data.ai_model_label;
            scriptSection.classList.remove('d-none');
            // Seite neu laden um Header-Badges zu aktualisieren
            setTimeout(() => location.reload(), 500);
        } else {
            alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
            if (generateSection) generateSection.classList.remove('d-none');
        }
    })
    .catch(error => {
        loadingSection.classList.add('d-none');
        alert('Fehler: ' + error.message);
        if (generateSection) generateSection.classList.remove('d-none');
    });
}

function regenerateScript() {
    if (!confirm('Skript neu generieren? Das aktuelle Skript wird überschrieben.')) {
        return;
    }

    const loadingSection = document.getElementById('loadingSection');
    const scriptSection = document.getElementById('scriptSection');

    scriptSection.classList.add('d-none');
    loadingSection.classList.remove('d-none');

    fetch('{% url "vskript:api_regenerate" project_id=project.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        loadingSection.classList.add('d-none');

        if (data.success) {
            document.getElementById('scriptText').value = data.script;
            currentModelLabel = data.ai_model_label;
            document.getElementById('wordCountDisplay').innerHTML =
                data.word_count + ' Worte | ' + data.estimated_duration + ' Min | <i class="bi bi-robot"></i> ' + data.ai_model_label;
            scriptSection.classList.remove('d-none');
            // Seite neu laden um Header-Badges zu aktualisieren
            setTimeout(() => location.reload(), 500);
        } else {
            alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
            scriptSection.classList.remove('d-none');
        }
    })
    .catch(error => {
        loadingSection.classList.add('d-none');
        alert('Fehler: ' + error.message);
        scriptSection.classList.remove('d-none');
    });
}

function copyScript() {
    const scriptText = document.getElementById('scriptText');
    scriptText.select();
    document.execCommand('copy');

    // Feedback
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check me-1"></i>Kopiert!';
    btn.classList.remove('btn-outline-secondary');
    btn.classList.add('btn-success');

    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-secondary');
    }, 2000);
}

// Update word count on edit
document.getElementById('scriptText')?.addEventListener('input', function() {
    const words = this.value.trim().split(/\s+/).filter(w => w).length;
    const minutes = (words / 130).toFixed(1);
    document.getElementById('wordCountDisplay').innerHTML = words + ' Worte | ' + minutes + ' Min | <i class="bi bi-robot"></i> ' + currentModelLabel;
});

// ============================================
// Bild-Generierung Funktionen
// ============================================

function generateAllImages() {
    const noImagesSection = document.getElementById('noImagesSection');
    const imageLoadingSection = document.getElementById('imageLoadingSection');
    const imagesGrid = document.getElementById('imagesGrid');
    const imagesList = document.getElementById('imagesList');
    const progressBar = document.getElementById('imageProgressBar');
    const loadingText = document.getElementById('imageLoadingText');

    // UI vorbereiten
    if (noImagesSection) noImagesSection.classList.add('d-none');
    if (imagesGrid) imagesGrid.classList.add('d-none');
    imageLoadingSection.classList.remove('d-none');
    loadingText.textContent = 'Bilder werden generiert...';
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';

    fetch('{% url "vskript:api_generate_images" project_id=project.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fortschritt anzeigen
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            loadingText.textContent = `${data.completed} von ${data.total} Bildern erstellt`;

            // Seite neu laden um Bilder anzuzeigen
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
            imageLoadingSection.classList.add('d-none');
            if (noImagesSection) noImagesSection.classList.remove('d-none');
        }
    })
    .catch(error => {
        alert('Fehler: ' + error.message);
        imageLoadingSection.classList.add('d-none');
        if (noImagesSection) noImagesSection.classList.remove('d-none');
    });
}

function regenerateImage(imageId) {
    if (!confirm('Bild neu generieren?')) return;

    const card = document.getElementById('image-card-' + imageId);
    if (!card) return;

    // Loading-Status anzeigen
    const imgContainer = card.querySelector('.position-relative');
    const originalContent = imgContainer.innerHTML;
    imgContainer.innerHTML = `
        <div class="d-flex align-items-center justify-content-center bg-light" style="height: 150px;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generiert...</span>
            </div>
        </div>
        <span class="position-absolute top-0 start-0 badge bg-warning m-1">
            <i class="bi bi-hourglass-split"></i>
        </span>
    `;

    fetch(`/vskript/api/images/regenerate/${imageId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Seite neu laden um neues Bild anzuzeigen
            location.reload();
        } else {
            alert('Fehler: ' + (data.error || 'Bild konnte nicht generiert werden'));
            imgContainer.innerHTML = originalContent;
        }
    })
    .catch(error => {
        alert('Fehler: ' + error.message);
        imgContainer.innerHTML = originalContent;
    });
}

function deleteImage(imageId) {
    if (!confirm('Bild wirklich löschen?')) return;

    fetch(`/vskript/api/images/delete/${imageId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Bild-Karte entfernen
            const card = document.getElementById('image-card-' + imageId);
            if (card) {
                card.remove();
            }
            // Badge aktualisieren
            const badge = document.getElementById('imageCountBadge');
            if (badge) {
                const remaining = document.querySelectorAll('[id^="image-card-"]').length;
                badge.innerHTML = `<i class="bi bi-image me-1"></i>${remaining} Bilder`;

                // Falls keine Bilder mehr, zeige "Keine Bilder"-Section
                if (remaining === 0) {
                    document.getElementById('imagesGrid').classList.add('d-none');
                    document.getElementById('noImagesSection').classList.remove('d-none');
                }
            }
        } else {
            alert('Fehler: ' + (data.error || 'Bild konnte nicht gelöscht werden'));
        }
    })
    .catch(error => {
        alert('Fehler: ' + error.message);
    });
}

function deleteAllImages() {
    if (!confirm('Alle Bilder wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) return;

    fetch('{% url "vskript:api_delete_all_images" project_id=project.id %}', {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Alle Bild-Karten entfernen
            document.getElementById('imagesList').innerHTML = '';
            document.getElementById('imagesGrid').classList.add('d-none');
            document.getElementById('noImagesSection').classList.remove('d-none');
            // Badge aktualisieren
            const badge = document.getElementById('imageCountBadge');
            if (badge) {
                badge.innerHTML = '<i class="bi bi-image me-1"></i>0 Bilder';
            }
        } else {
            alert('Fehler: ' + (data.error || 'Bilder konnten nicht gelöscht werden'));
        }
    })
    .catch(error => {
        alert('Fehler: ' + error.message);
    });
}
</script>
{% endblock %}
