{% extends 'base.html' %}

{% block content %}

<style>
    .card-header {
        background-color: rgba(0, 64, 119, 0.05);
        font-weight: 500;
    }
    .list-group-item {
        transition: background-color 0.2s ease-in-out;
    }
    .font-monospace {
        background-color: #f8f9fa;
        padding: 0.2em 0.4em;
        border-radius: 3px;
        white-space: pre-wrap;
        word-break: break-word;
    }
    .copy-btn {
        transition: all 0.2s ease-in-out;
    }
    #pdf-preview-container {
        display: none;
        position: fixed;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        border: 1px solid #ccc;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        background-color: white;
        padding: 10px;
        border-radius: 8px;
        z-index: 1000;
        max-width: 40%;
        max-height: 90vh;
        overflow-y: auto;
    }
    #pdf-preview-container img {
        max-width: 100%;
        height: auto;
    }
</style>

<div class="row">
    <div class="col-lg-7">
        <div class="row justify-content-center">
            <div class="col-12">

                <h1 class="text-center mb-4">Analyse technischer Ausschreibungen</h1>

                {% if error_message %}
                    <div class="alert alert-danger">
                        <strong>Fehler:</strong> {{ error_message }}
                    </div>
                {% endif %}

                <div class="card shadow-sm mb-5" id="search-card">
                    <div class="card-header">1. Suche starten</div>
                    <div class="card-body">
                        <form method="post" enctype="multipart/form-data" id="mainSearchForm">
                            {% csrf_token %}

                            <div class="mb-3">
                                <label for="pdf_datei" class="form-label">Ausschreibungs-PDF</label>
                                <input class="form-control" type="file" id="pdf_datei" name="pdf_datei" accept=".pdf" required>
                            </div>
                             <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="seite_von" class="form-label">Seitenbereich (optional)</label>
                                    <input type="number" class="form-control" id="seite_von" name="seite_von" placeholder="Von Seite" min="1">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="seite_bis" class="form-label">&nbsp;</label>
                                    <input type="number" class="form-control" id="seite_bis" name="seite_bis" placeholder="Bis Seite" min="1">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Suchmethode</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="search_type" id="aiSearch" value="ai" checked>
                                    <label class="form-check-label" for="aiSearch">
                                        <strong>KI-gestützte Kontextsuche:</strong> Versteht den Sinn Ihrer Anfrage.
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="search_type" id="simpleSearch" value="simple">
                                    <label class="form-check-label" for="simpleSearch">
                                        <strong>Einfache Textsuche:</strong> Findet exakte Wörter (Begriffe mit Komma trennen).
                                    </label>
                                </div>
                            </div>

                            <div class="mb-4" id="perspective-container">
                                <label class="form-label">Suchperspektive</label>
                                <small class="form-text text-muted mb-2 d-block">
                                    Wählen Sie die Perspektive, aus der die Ausschreibung analysiert werden soll:
                                </small>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="search_perspective" id="salesPerspective" value="sales" checked>
                                    <label class="form-check-label" for="salesPerspective">
                                        <strong>Vertriebsmitarbeiter:</strong> 
                                        <small class="text-muted">Fokus auf Produkteigenschaften, Preise, Lieferbedingungen, Zertifizierungen und Kundenanforderungen</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="search_perspective" id="techPerspective" value="technical">
                                    <label class="form-check-label" for="techPerspective">
                                        <strong>Entwickler/Techniker:</strong> 
                                        <small class="text-muted">Fokus auf technische Spezifikationen, Normen, Installationsdetails, Schaltpläne und technische Umsetzung</small>
                                    </label>
                                </div>
                            </div>

                            <div class="mb-4" id="ai-strictness-container">
                                <label for="ai-strictness" class="form-label">Strenge der KI-Suche: <span id="strictness-value">Mittel</span></label>
                                <div class="d-flex align-items-center">
                                    <span class="me-2 small text-muted">Locker</span>
                                    <input type="range" class="form-range" min="0" max="100" step="5" value="50" id="ai-strictness" name="ai_strictness">
                                    <span class="ms-2 small text-muted">Streng</span>
                                </div>
                                <small class="form-text text-muted">
                                    "Streng" findet nur sehr genaue Treffer. "Locker" findet auch thematisch entferntere Ergebnisse.
                                </small>
                            </div>

                            <div class="mb-3">
                                <label for="suchanfrage" class="form-label">Ihre Anfrage / Suchbegriffe</label>
                                <input type="text" class="form-control" id="suchanfrage" name="suchanfrage" placeholder="z.B. 'Anforderungen an Notbeleuchtung' oder 'IP65, Leuchte, Mast'" required>
                            </div>
                            <input type="hidden" name="step" value="initial">
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="mainSearchButton">Suche starten</button>
                        </form>
                    </div>
                </div>

                <div id="ladeanzeige" class="mt-5 text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                    <h5 class="mt-3">Dokument wird analysiert... Dieser Vorgang kann einen Moment dauern.</h5>
                </div>

                {% if step == 'preview_terms' %}
                    <div class="card shadow-sm mb-5" id="preview-terms-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-lightbulb"></i> 
                                2. Erweiterte Suchbegriffe auswählen
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-4">
                                Die KI hat basierend auf Ihrer Anfrage "<strong>{{ suchanfrage }}</strong>" zusätzliche verwandte Begriffe gefunden. 
                                Wählen Sie aus, welche Begriffe in die Suche einbezogen werden sollen:
                            </p>
                            
                            <form method="post" id="expandedTermsForm">
                                {% csrf_token %}
                                <input type="hidden" name="step" value="search">
                                <input type="hidden" name="pdf_filename" value="{{ pdf_filename }}">
                                <input type="hidden" name="suchanfrage" value="{{ suchanfrage }}">
                                <input type="hidden" name="search_type" value="{{ search_type }}">
                                <input type="hidden" name="search_perspective" value="{{ search_perspective }}">
                                <input type="hidden" name="seite_von" value="{{ seite_von }}">
                                <input type="hidden" name="seite_bis" value="{{ seite_bis }}">
                                <input type="hidden" name="ai_strictness" id="hidden_ai_strictness" value="50">
                                
                                <!-- Strenge-Einstellung für die Vorschau -->
                                <div class="mb-4">
                                    <label for="preview-ai-strictness" class="form-label">Strenge der KI-Suche: <span id="preview-strictness-value">Mittel</span></label>
                                    <div class="d-flex align-items-center">
                                        <span class="me-2 small text-muted">Locker</span>
                                        <input type="range" class="form-range" min="0" max="100" step="5" value="50" id="preview-ai-strictness">
                                        <span class="ms-2 small text-muted">Streng</span>
                                    </div>
                                    <small class="form-text text-muted">
                                        "Streng" findet nur sehr genaue Treffer. "Locker" findet auch thematisch entferntere Ergebnisse.
                                    </small>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-success mb-3">
                                            <i class="bi bi-check-circle"></i> 
                                            Ihre ursprünglichen Suchbegriffe:
                                        </h6>
                                        <div class="mb-3">
                                            {% for term in original_terms %}
                                                <span class="badge bg-success me-2 mb-2 p-2">{{ term }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-3">
                                            <i class="bi bi-plus-circle"></i> 
                                            KI-erweiterte Begriffe (optional auswählen):
                                        </h6>
                                        <div class="mb-3">
                                            {% for term in expanded_terms %}
                                                <div class="form-check form-check-inline mb-2">
                                                    <input class="form-check-input" type="checkbox" 
                                                           id="expanded_term_{{ forloop.counter }}" 
                                                           name="expanded_term_{{ forloop.counter }}"
                                                           value="{{ term }}"
                                                           checked>
                                                    <label class="form-check-label btn btn-outline-primary btn-sm" 
                                                           for="expanded_term_{{ forloop.counter }}">
                                                        {{ term }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mt-4">
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleAllTerms(false)">
                                        Alle abwählen
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="toggleAllTerms(true)">
                                        Alle auswählen
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-search"></i> 
                                        Jetzt suchen
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% endif %}

                {% if step == 'results' %}
                    {% if ergebnisse %}
                        <div class="d-flex justify-content-between align-items-center mt-5 mb-3">
                            <h2 class="mb-0">Suchergebnisse</h2>
                            <div class="text-end">
                                <small class="text-muted">Suchanfrage:</small><br>
                                <strong>"{{ suchanfrage }}"</strong>
                            </div>
                        </div>
                        
                        <!-- Legende für Hervorhebungen -->
                        <div class="alert alert-info mb-4">
                            <h6 class="mb-2"><i class="bi bi-info-circle"></i> Legende der Hervorhebungen:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <span style="background-color: #ffeb3b; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Gelb</span>
                                    <small class="ms-2">Ihre ursprünglichen Suchbegriffe</small>
                                </div>
                                <div class="col-md-6">
                                    <span style="background-color: #ff9800; padding: 2px 6px; border-radius: 3px; color: white; font-weight: bold;">Orange</span>
                                    <small class="ms-2">KI-erweiterte verwandte Begriffe</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Erweiterte Suchbegriffe anzeigen (nur bei KI-Suche) -->
                        {% if search_type == 'ai' and expanded_terms %}
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-lightbulb"></i> 
                                        Erweiterte Suchbegriffe 
                                        <small class="text-muted">(von KI gefunden)</small>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p class="small text-muted mb-2">Klicken Sie auf einen Begriff um eine neue Suche zu starten:</p>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for term in expanded_terms %}
                                            <button class="btn btn-outline-primary btn-sm search-term-btn" 
                                                    data-term="{{ term }}" 
                                                    data-perspective="{{ search_perspective }}"
                                                    type="button">
                                                {{ term }}
                                            </button>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        <div class="list-group" id="ergebnis-liste">
                            {% for ergebnis in ergebnisse %}
                                <div class="list-group-item flex-column align-items-start" data-preview-url="{% url 'pdf_sucher:pdf_page_preview' filename=pdf_filename page_num=ergebnis.seitenzahl %}?search_terms={{ search_terms|urlencode }}&search_type={{ search_type }}&context_text={{ ergebnis.textstelle|urlencode }}">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <a href="{% url 'pdf_sucher:view_pdf' filename=pdf_filename %}#page={{ ergebnis.seitenzahl }}" target="_blank" class="text-decoration-none">
                                            <span class="badge bg-secondary rounded-pill fs-6">Seite {{ ergebnis.seitenzahl }}</span>
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm copy-btn" data-text-to-copy="{{ ergebnis.textstelle }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM9 2H7v1h2V2z"/></svg>
                                            Kopieren
                                        </button>
                                    </div>
                                    <hr class="my-2">
                                    <p class="mb-1 mt-2 font-monospace">
                                        {% if ergebnis.textstelle_highlighted %}
                                            {{ ergebnis.textstelle_highlighted|safe }}
                                        {% else %}
                                            {{ ergebnis.textstelle }}
                                        {% endif %}
                                    </p>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                         <div class="alert alert-warning mt-5">Keine passenden Textstellen für Ihre Anfrage gefunden.</div>
                    {% endif %}
                
                <!-- PDF Download Bereich -->
                <!-- DEBUG: results_pdf_filename = "{{ results_pdf_filename }}" -->
                {% if results_pdf_filename %}
                    <div class="alert alert-success mt-4">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="alert-heading mb-1">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                    PDF mit Suchergebnissen erstellt!
                                </h6>
                                <p class="mb-0 small">
                                    Ihre Suchergebnisse wurden in einer PDF zusammengefasst. 
                                    Die PDF enthält alle Fundstellen mit Links zu den entsprechenden Seiten.
                                </p>
                            </div>
                            <div class="ms-3">
                                <a href="{% url 'pdf_sucher:view_pdf' filename=results_pdf_filename %}" 
                                   class="btn btn-success btn-lg" target="_blank">
                                    <i class="bi bi-download"></i>
                                    PDF öffnen
                                </a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- DEBUG: Kein results_pdf_filename gefunden! Ergebnisse: {{ ergebnisse|length }} -->
                    {% if ergebnisse %}
                        <div class="alert alert-warning mt-4">
                            <strong>DEBUG:</strong> Suchergebnisse gefunden ({{ ergebnisse|length }}), aber PDF-Dateiname fehlt!
                        </div>
                    {% endif %}
                {% endif %}
                
                <div class="mt-4 text-center">
                    <a href="{% url 'pdf_sucher:pdf_suche' %}" class="btn btn-outline-primary">Neue Suche starten</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <div id="pdf-preview-container" class="sticky-top">
            <h6 class="text-muted text-center mb-2">Seiten-Vorschau</h6>
            <div id="preview-loader" class="text-center p-5" style="display: none;">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
            <img id="pdf-preview-image" src="" alt="PDF-Vorschau">
        </div>
    </div>
</div>

{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Logik für Ladeanzeige ---
    const form = document.getElementById('mainSearchForm');
    if (form) {
        form.addEventListener('submit', function() {
            document.getElementById('search-card').style.display = 'none';
            document.getElementById('ladeanzeige').style.display = 'block';
            document.getElementById('mainSearchButton').disabled = true;
        });
    }

    // --- Logik für Strenge-Regler ---
    const aiRadio = document.getElementById('aiSearch');
    const simpleRadio = document.getElementById('simpleSearch');
    const strictnessContainer = document.getElementById('ai-strictness-container');
    const strictnessSlider = document.getElementById('ai-strictness');
    const strictnessValueSpan = document.getElementById('strictness-value');

    function toggleStrictness() {
        strictnessContainer.style.display = aiRadio.checked ? 'block' : 'none';
    }

    function updateStrictnessLabel() {
        const value = parseInt(strictnessSlider.value);
        if (value < 25) {
            strictnessValueSpan.textContent = 'Sehr Locker';
        } else if (value < 50) {
            strictnessValueSpan.textContent = 'Locker';
        } else if (value < 75) {
            strictnessValueSpan.textContent = 'Mittel';
        } else {
            strictnessValueSpan.textContent = 'Streng';
        }
    }

    aiRadio.addEventListener('change', toggleStrictness);
    simpleRadio.addEventListener('change', toggleStrictness);
    strictnessSlider.addEventListener('input', updateStrictnessLabel);

    toggleStrictness();
    updateStrictnessLabel();


    // --- Logik für Kopier-Button ---
    document.addEventListener('click', function(event) {
        const copyButton = event.target.closest('.copy-btn');
        if (copyButton) {
            navigator.clipboard.writeText(copyButton.dataset.textToCopy).then(() => {
                const originalHTML = copyButton.innerHTML;
                copyButton.innerHTML = 'Kopiert!';
                copyButton.classList.add('btn-success');
                copyButton.classList.remove('btn-outline-secondary');
                setTimeout(() => {
                    copyButton.innerHTML = originalHTML;
                    copyButton.classList.remove('btn-success');
                    copyButton.classList.add('btn-outline-secondary');
                }, 2000);
            });
        }
    });

    // --- Logik für erweiterte Suchbegriffe ---
    document.addEventListener('click', function(event) {
        const searchTermBtn = event.target.closest('.search-term-btn');
        if (searchTermBtn) {
            const term = searchTermBtn.dataset.term;
            const perspective = searchTermBtn.dataset.perspective;
            
            // Setze den Begriff in das Suchfeld
            const suchfeld = document.getElementById('suchanfrage');
            if (suchfeld) {
                suchfeld.value = term;
            }
            
            // Setze die richtige Perspektive
            const perspectiveRadio = document.querySelector(`input[name="search_perspective"][value="${perspective}"]`);
            if (perspectiveRadio) {
                perspectiveRadio.checked = true;
            }
            
            // Setze auf KI-Suche
            const aiRadio = document.getElementById('aiSearch');
            if (aiRadio) {
                aiRadio.checked = true;
            }
            
            // Scrolle zum Suchformular
            document.getElementById('search-card').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
            
            // Optional: Markiere das Suchfeld
            if (suchfeld) {
                suchfeld.focus();
                suchfeld.select();
            }
        }
    });

    // --- Logik für die PDF-Vorschau ---
    const ergebnisListe = document.getElementById('ergebnis-liste');
    const previewContainer = document.getElementById('pdf-preview-container');
    const previewImage = document.getElementById('pdf-preview-image');
    const previewLoader = document.getElementById('preview-loader');

    if (ergebnisListe) {
        ergebnisListe.addEventListener('mouseover', function(e) {
            const resultItem = e.target.closest('.list-group-item');
            if (resultItem && resultItem.dataset.previewUrl) {
                if (previewContainer) previewContainer.style.display = 'block';
                if (previewImage) previewImage.style.display = 'none';
                if (previewLoader) previewLoader.style.display = 'block';
                if (previewImage.src !== resultItem.dataset.previewUrl) {
                    previewImage.src = resultItem.dataset.previewUrl;
                } else {
                     if (previewLoader) previewLoader.style.display = 'none';
                     if (previewImage) previewImage.style.display = 'block';
                }
            }
        });

        if (previewImage) {
            previewImage.onload = function() {
                if (previewLoader) previewLoader.style.display = 'none';
                previewImage.style.display = 'block';
            };
            previewImage.onerror = function() {
                if (previewLoader) previewLoader.innerHTML = 'Vorschau-Fehler';
            }
        }
    }
    
    // --- Funktion für Erweiterte Begriffe Auswahl ---
    window.toggleAllTerms = function(selectAll) {
        const checkboxes = document.querySelectorAll('input[name^="expanded_term_"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll;
        });
    };
    
    // --- Logik für Vorschau-Strenge-Regler ---
    const previewStrictnessSlider = document.getElementById('preview-ai-strictness');
    const previewStrictnessValueSpan = document.getElementById('preview-strictness-value');
    const hiddenStrictnessInput = document.getElementById('hidden_ai_strictness');
    
    if (previewStrictnessSlider && previewStrictnessValueSpan && hiddenStrictnessInput) {
        function updatePreviewStrictnessLabel() {
            const value = parseInt(previewStrictnessSlider.value);
            if (value < 25) {
                previewStrictnessValueSpan.textContent = 'Sehr Locker';
            } else if (value < 50) {
                previewStrictnessValueSpan.textContent = 'Locker';
            } else if (value < 75) {
                previewStrictnessValueSpan.textContent = 'Mittel';
            } else {
                previewStrictnessValueSpan.textContent = 'Streng';
            }
            // Sync with hidden input
            hiddenStrictnessInput.value = value;
        }
        
        previewStrictnessSlider.addEventListener('input', updatePreviewStrictnessLabel);
        updatePreviewStrictnessLabel(); // Initial call
    }
});
</script>
{% endblock %}