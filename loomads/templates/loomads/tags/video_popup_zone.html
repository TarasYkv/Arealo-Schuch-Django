{% if error %}
    <!-- LoomAds Video Popup Error: {{ error }} -->
{% else %}
    <div id="loomads-video-popup-{{ zone_code }}" 
         class="loomads-video-popup {{ css_class }}" 
         style="position: fixed; 
                bottom: 20px; 
                right: 20px; 
                width: {{ width }}px; 
                height: {{ height }}px; 
                background: #000; 
                border-radius: 8px; 
                box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
                z-index: 9999; 
                display: none;
                {{ style }}">
        
        <!-- Close Button -->
        <button id="loomads-close-{{ zone_code }}" 
                style="position: absolute; 
                       top: -10px; 
                       right: -10px; 
                       width: 30px; 
                       height: 30px; 
                       border-radius: 50%; 
                       background: #ff4444; 
                       color: white; 
                       border: 2px solid white; 
                       cursor: pointer; 
                       font-size: 16px; 
                       font-weight: bold; 
                       line-height: 1; 
                       z-index: 10000;
                       display: flex;
                       align-items: center;
                       justify-content: center;"
                title="SchlieÃŸen">Ã—</button>
        
        <!-- Video Container -->
        <div id="loomads-video-content-{{ zone_code }}" 
             style="width: 100%; 
                    height: 100%; 
                    border-radius: 8px; 
                    overflow: hidden; 
                    position: relative;">
            <div style="position: absolute; 
                        top: 50%; 
                        left: 50%; 
                        transform: translate(-50%, -50%); 
                        color: white; 
                        text-align: center;">
                <div style="font-size: 20px; margin-bottom: 10px;">ðŸ“º</div>
                <div>Video wird geladen...</div>
            </div>
        </div>
    </div>
    
    <script>
    (function() {
        const zoneCode = '{{ zone_code }}';
        const apiUrl = '{{ api_url }}';
        const trackUrlTemplate = '{{ track_url }}';
        const popupDelay = {{ popup_delay|default:5 }} * 1000; // Convert to milliseconds
        let popupShown = false;
        let popupClosed = false;
        
        // Check if popup was already closed in this session
        const sessionKey = 'loomads_popup_closed_' + zoneCode;
        if (sessionStorage.getItem(sessionKey)) {
            popupClosed = true;
            return;
        }
        
        function showVideoPopup() {
            if (popupShown || popupClosed) return;
            popupShown = true;
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.warn('LoomAds Video Popup: ' + data.error);
                        return;
                    }
                    
                    if (data.type !== 'video' || !data.video_url) {
                        console.warn('LoomAds Video Popup: Keine Video-Anzeige verfÃ¼gbar');
                        return;
                    }
                    
                    const popupContainer = document.getElementById('loomads-video-popup-' + zoneCode);
                    const videoContainer = document.getElementById('loomads-video-content-' + zoneCode);
                    const closeButton = document.getElementById('loomads-close-' + zoneCode);
                    
                    if (!popupContainer || !videoContainer || !closeButton) return;
                    
                    // Create video element
                    const videoHtml = '<video autoplay ' +
                        (data.video_with_audio ? '' : 'muted') +
                        ' loop onclick="trackClick(\'' + data.id + '\', \'' + zoneCode + '\'); window.open(\'' + data.target_url + '\', \'' + data.target_type + '\');" ' +
                        'style="width: 100%; height: 100%; object-fit: cover; cursor: pointer; border-radius: 8px;">' +
                        '<source src="' + data.video_url + '" type="video/mp4">' +
                        'Ihr Browser unterstuetzt keine Videos.' +
                        '</video>';
                    
                    videoContainer.innerHTML = videoHtml;
                    
                    // Show popup with animation
                    popupContainer.style.display = 'block';
                    popupContainer.style.opacity = '0';
                    popupContainer.style.transform = 'translateY(100px)';
                    popupContainer.style.transition = 'all 0.3s ease-out';
                    
                    setTimeout(() => {
                        popupContainer.style.opacity = '1';
                        popupContainer.style.transform = 'translateY(0)';
                    }, 10);
                    
                    // Close button functionality
                    closeButton.addEventListener('click', function() {
                        closePopup();
                    });
                    
                    // Auto-close after 30 seconds (optional)
                    setTimeout(() => {
                        if (!popupClosed) {
                            closePopup();
                        }
                    }, 30000);
                })
                .catch(error => {
                    console.error('LoomAds Video Popup error:', error);
                });
        }
        
        function closePopup() {
            if (popupClosed) return;
            popupClosed = true;
            
            const popupContainer = document.getElementById('loomads-video-popup-' + zoneCode);
            if (!popupContainer) return;
            
            // Close with animation
            popupContainer.style.transition = 'all 0.3s ease-in';
            popupContainer.style.opacity = '0';
            popupContainer.style.transform = 'translateY(100px)';
            
            setTimeout(() => {
                popupContainer.style.display = 'none';
            }, 300);
            
            // Remember that popup was closed
            sessionStorage.setItem(sessionKey, 'true');
        }
        
        function trackClick(adId, zoneCode) {
            const trackUrl = trackUrlTemplate.replace('AD_ID_PLACEHOLDER', adId);
            const formData = new FormData();
            formData.append('zone_code', zoneCode);
            
            // CSRF Token holen
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                              document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
                              '{{ csrf_token }}';
            if (csrfToken) {
                formData.append('csrfmiddlewaretoken', csrfToken);
            }
            
            fetch(trackUrl, {
                method: 'POST',
                body: formData
            }).catch(error => console.error('LoomAds tracking error:', error));
        }
        
        // Show popup after delay
        setTimeout(showVideoPopup, popupDelay);
    })();
    </script>
{% endif %}