{% if error %}
    <!-- LoomAds Error: {{ error }} -->
    {% if fallback %}
        {{ fallback|safe }}
    {% endif %}
{% else %}
    <div id="loomads-multi-zone-{{ zone_code }}-{{ random_id }}" 
         class="loomads-multi-zone loomads-{{ zone_type }} {{ css_class }}" 
         data-zone-code="{{ zone_code }}"
         data-zone-type="{{ zone_type }}"
         data-ad-count="{{ ad_count }}"
         style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: flex-start; {{ style }}">
        
        <!-- Loading indicators -->
        {% for i in "123"|make_list %}
            {% if forloop.counter <= ad_count %}
            <div id="loomads-ad-slot-{{ forloop.counter }}-{{ random_id }}" 
                 class="loomads-ad-slot"
                 style="flex: 1; min-width: 250px; max-width: 350px; text-align: center; padding: 8px; color: #6c757d; font-size: 12px;">
                <div style="padding: 8px; color: #999; font-size: 11px;">Hier kann Deine Werbung stehen!</div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    
    <script>
    (function() {
        const zoneCode = '{{ zone_code }}';
        const uniqueId = 'loomads-multi-zone-{{ zone_code }}-{{ random_id }}';
        const adCount = {{ ad_count }};
        const apiUrl = '{{ api_url }}';
        const trackUrlTemplate = '{{ track_url }}';
        let adsLoaded = false;
        
        console.log('[LoomAds Multi] Loading ' + adCount + ' ads for zone: ' + zoneCode);
        console.log('[LoomAds Multi] API URL: ' + apiUrl);
        
        function loadAds() {
            if (adsLoaded) {
                console.log('[LoomAds Multi] ' + uniqueId + ': Ads already loaded, skipping');
                return;
            }
            adsLoaded = true;

            console.log('[LoomAds Multi] ' + uniqueId + ': Starting ads fetch from ' + apiUrl);
            fetch(apiUrl)
                .then(response => {
                    console.log('[LoomAds Multi] ' + uniqueId + ': API response status: ' + response.status);
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('[LoomAds Multi] ' + uniqueId + ': API response data:', data);

                    if (data.error) {
                        console.warn('[LoomAds Multi] ' + uniqueId + ': API returned error: ' + data.error);
                        return;
                    }
                    
                    const container = document.getElementById(uniqueId);
                    if (!container) {
                        console.error('[LoomAds Multi] ' + uniqueId + ': Container element not found');
                        return;
                    }
                    
                    // Clear loading indicators
                    container.innerHTML = '';
                    
                    const ads = data.ads || [];
                    console.log('[LoomAds Multi] ' + uniqueId + ': Rendering ' + ads.length + ' ads');
                    
                    ads.forEach((ad, index) => {
                        const adSlot = document.createElement('div');
                        adSlot.className = 'loomads-ad-slot';
                        adSlot.style.cssText = 'flex: 1; min-width: 120px; max-width: 200px; text-align: center; padding: 4px;';
                        
                        let adHtml = '';
                        const trackUrl = trackUrlTemplate.replace('AD_ID_PLACEHOLDER', ad.id);
                        
                        if (ad.type === 'image' && ad.image_url) {
                            adHtml = '<a href="' + ad.target_url + '" target="' + ad.target_type + '" ' +
                                'onclick="trackClick(\'' + ad.id + '\', \'' + uniqueId + '-' + index + '\'); return true;" ' +
                                'class="loomads-link" style="display: block; text-decoration: none;">' +
                                '<img src="' + ad.image_url + '" alt="' + (ad.title || '') + '" ' +
                                'class="loomads-image" ' +
                                'style="max-width: 100%; height: auto; border-radius: 6px;" />' +
                                '</a>';
                        } else if (ad.type === 'html' && ad.html_content) {
                            // Make HTML content responsive for multi-ad display
                            let responsiveHtml = ad.html_content
                                .replace(/max-width:\s*\d+px/g, 'max-width: 100%')
                                .replace(/width:\s*\d+px/g, 'width: 100%')
                                .replace(/min-width:\s*\d+px/g, 'min-width: auto');
                            
                            adHtml = '<div onclick="if(window.trackClick) window.trackClick(\'' + ad.id + '\', \'' + uniqueId + '-' + index + '\')" ' +
                                'class="loomads-html" style="cursor: pointer; width: 100%;">' +
                                responsiveHtml +
                                '</div>';
                        } else if (ad.type === 'text') {
                            adHtml = '<a href="' + ad.target_url + '" target="' + ad.target_type + '" ' +
                                'onclick="trackClick(\'' + ad.id + '\', \'' + uniqueId + '-' + index + '\'); return true;" ' +
                                'class="loomads-text" style="display: block; text-decoration: none; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 6px;">' +
                                (ad.title ? '<h5 style="margin: 0 0 4px 0; font-size: 13px;">' + ad.title + '</h5>' : '') +
                                (ad.description ? '<p style="margin: 0; font-size: 11px; opacity: 0.9;">' + ad.description + '</p>' : '') +
                                '</a>';
                        }
                        
                        if (adHtml) {
                            adSlot.innerHTML = adHtml;
                            container.appendChild(adSlot);
                            console.log('[LoomAds Multi] ' + uniqueId + ': Ad ' + (index + 1) + ' rendered successfully');
                        }
                    });
                    
                    if (ads.length === 0) {
                        container.innerHTML = '<div style="color: #999; font-size: 12px; text-align: center; width: 100%;">Hier kann Deine Werbung stehen!</div>';
                    }
                })
                .catch(error => {
                    console.error('[LoomAds Multi] ' + uniqueId + ': Fetch error:', error);
                    const container = document.getElementById(uniqueId);
                    if (container) {
                        {% if fallback %}
                        container.innerHTML = "{{ fallback|escapejs }}";
                        {% else %}
                        container.innerHTML = '<div style="color: #999; font-size: 12px; text-align: center;">Hier kann Deine Werbung stehen!</div>';
                        {% endif %}
                    }
                });
        }
        
        function trackClick(adId, containerId) {
            console.log('[LoomAds Multi] ' + containerId + ': Tracking click for ad ' + adId);
            const trackUrl = trackUrlTemplate.replace('AD_ID_PLACEHOLDER', adId);
            const formData = new FormData();
            formData.append('zone_code', zoneCode);
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                              document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
                              '{{ csrf_token }}';
            if (csrfToken) {
                formData.append('csrfmiddlewaretoken', csrfToken);
            }
            
            fetch(trackUrl, {
                method: 'POST',
                body: formData
            }).then(() => {
                console.log('[LoomAds Multi] ' + containerId + ': Click tracked successfully');
            }).catch(error => {
                console.error('[LoomAds Multi] ' + containerId + ': Tracking error:', error);
            });
        }
        
        // Make trackClick available globally
        window.trackClick = window.trackClick || trackClick;
        
        // Load ads when DOM is ready
        console.log('[LoomAds Multi] ' + uniqueId + ': DOM ready state: ' + document.readyState);
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadAds, { once: true });
        } else {
            setTimeout(loadAds, 100);
        }
    })();
    </script>
{% endif %}