{% extends 'loomads/wizard/wizard_base.html' %}
{% load loomads_tags %}

{% block wizard_title %}Creative-Upload{% endblock %}

{% block extra_head %}
<!-- Cropper.js for Image Cropping - CDN mit Integrity Check -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css"
      integrity="sha512-0SPWAwpC/17yYyZ/4HSllgaK7/gg9OvnYYlbeIuDn4wP9WnrWDMyOvZ7jOu3RbmO9LmEH3LYM5cg8w4F2USFQ=="
      crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
.crop-container {
    max-height: 350px;  /* Reduziert von 500px */
    min-height: 250px;  /* Reduziert von 300px */
    overflow: visible !important; /* Wichtig für Cropper */
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    position: relative;
}
.crop-container img {
    max-width: 100%;
    display: block;
}
.crop-preview {
    width: 100%;
    max-width: 250px;  /* Reduziert von 300px */
    height: 150px;     /* Reduziert von 200px */
    margin: 0 auto;
    overflow: hidden;
    border: 2px dashed #ddd;
    background: #f8f9fa;
}
.zoom-controls {
    margin-top: 10px;
}

/* Modal muss scrollbar sein */
#cropModal .modal-body {
    max-height: calc(100vh - 210px); /* Viewport height minus Header+Footer */
    overflow-y: auto;
}
#cropModal .modal-footer {
    position: sticky;
    bottom: 0;
    background: white;
    border-top: 2px solid #dee2e6;
    z-index: 10050 !important;
}

/* Kritische z-index Fixes für Interaktivität */
#cropModal {
    z-index: 9999 !important;
}
#cropModal .modal-dialog {
    z-index: 10000 !important;
    position: relative;
}
#cropModal .modal-content {
    z-index: 10001 !important;
    position: relative;
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5) !important; /* Starker Schatten ohne Backdrop */
    border: 2px solid #0d6efd; /* Blauer Border für Sichtbarkeit */
}
#cropModal .modal-body {
    z-index: 10002 !important;
    position: relative;
}
/* Modal-Header hervorheben */
#cropModal .modal-header {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    color: white;
    border-bottom: 3px solid #084298;
}
#cropModal .modal-header .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
}

/* Cropper Elements müssen über allem sein */
.cropper-container {
    z-index: 10003 !important;
    position: relative !important;
}
.cropper-wrap-box,
.cropper-canvas,
.cropper-drag-box,
.cropper-crop-box,
.cropper-modal {
    z-index: inherit !important;
}

/* Buttons und Controls müssen klickbar sein */
#cropModal button,
#cropModal .btn {
    z-index: 10010 !important;
    position: relative;
    pointer-events: auto !important;
}

/* Kein Backdrop verwenden - deaktiviert im JavaScript */
/* Modal ist ohne dunklen Overlay voll interaktiv */

/* Optional: Eigener semi-transparenter Hintergrund der NICHT blockiert */
#cropModal.show {
    background-color: rgba(0, 0, 0, 0.3);
}
#cropModal.show .modal-dialog {
    pointer-events: auto; /* Dialog bleibt klickbar */
}

/* ========== KRITISCHES CROPPER.JS CSS (Inline Fallback) ========== */
/* Falls CDN nicht lädt, haben wir zumindest das Wichtigste */
.cropper-container {
    direction: ltr;
    font-size: 0;
    line-height: 0;
    position: relative;
    touch-action: none;
    user-select: none;
}
.cropper-container img {
    display: block;
    height: 100%;
    image-orientation: 0deg;
    max-height: none !important;
    max-width: none !important;
    min-height: 0 !important;
    min-width: 0 !important;
    width: 100%;
}
.cropper-wrap-box,
.cropper-canvas,
.cropper-drag-box,
.cropper-crop-box,
.cropper-modal {
    bottom: 0;
    left: 0;
    position: absolute;
    right: 0;
    top: 0;
}
.cropper-wrap-box,
.cropper-canvas {
    overflow: hidden;
}
.cropper-drag-box {
    background-color: #fff;
    opacity: 0;
}
.cropper-modal {
    background-color: #000;
    opacity: 0.5;
}
.cropper-view-box {
    display: block;
    height: 100%;
    outline: 1px solid #39f;
    outline-color: rgba(51, 153, 255, 0.75);
    overflow: hidden;
    width: 100%;
}
.cropper-dashed {
    border: 0 dashed #eee;
    display: block;
    opacity: 0.5;
    position: absolute;
}
.cropper-dashed.dashed-h {
    border-bottom-width: 1px;
    border-top-width: 1px;
    height: calc(100% / 3);
    left: 0;
    top: calc(100% / 3);
    width: 100%;
}
.cropper-dashed.dashed-v {
    border-left-width: 1px;
    border-right-width: 1px;
    height: 100%;
    left: calc(100% / 3);
    top: 0;
    width: calc(100% / 3);
}
.cropper-center {
    display: block;
    height: 0;
    left: 50%;
    opacity: 0.75;
    position: absolute;
    top: 50%;
    width: 0;
}
.cropper-center::before,
.cropper-center::after {
    background-color: #eee;
    content: ' ';
    display: block;
    position: absolute;
}
.cropper-center::before {
    height: 1px;
    left: -3px;
    top: 0;
    width: 7px;
}
.cropper-center::after {
    height: 7px;
    left: 0;
    top: -3px;
    width: 1px;
}
.cropper-face,
.cropper-line,
.cropper-point {
    display: block;
    height: 100%;
    opacity: 0.1;
    position: absolute;
    width: 100%;
}
.cropper-face {
    background-color: #fff;
    left: 0;
    top: 0;
}
.cropper-line {
    background-color: #39f;
}
.cropper-line.line-e {
    cursor: ew-resize;
    right: -3px;
    top: 0;
    width: 5px;
}
.cropper-line.line-n {
    cursor: ns-resize;
    height: 5px;
    left: 0;
    top: -3px;
}
.cropper-line.line-w {
    cursor: ew-resize;
    left: -3px;
    top: 0;
    width: 5px;
}
.cropper-line.line-s {
    bottom: -3px;
    cursor: ns-resize;
    height: 5px;
    left: 0;
}
.cropper-point {
    background-color: #39f;
    height: 5px;
    opacity: 0.75;
    width: 5px;
}
.cropper-point.point-e {
    cursor: ew-resize;
    margin-top: -3px;
    right: -3px;
    top: 50%;
}
.cropper-point.point-n {
    cursor: ns-resize;
    left: 50%;
    margin-left: -3px;
    top: -3px;
}
.cropper-point.point-w {
    cursor: ew-resize;
    left: -3px;
    margin-top: -3px;
    top: 50%;
}
.cropper-point.point-s {
    bottom: -3px;
    cursor: s-resize;
    left: 50%;
    margin-left: -3px;
}
.cropper-point.point-ne {
    cursor: nesw-resize;
    right: -3px;
    top: -3px;
}
.cropper-point.point-nw {
    cursor: nwse-resize;
    left: -3px;
    top: -3px;
}
.cropper-point.point-sw {
    bottom: -3px;
    cursor: nesw-resize;
    left: -3px;
}
.cropper-point.point-se {
    bottom: -3px;
    cursor: nwse-resize;
    right: -3px;
}
.cropper-invisible {
    opacity: 0;
}
.cropper-bg {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAAA3NCSVQICAjb4U/gAAAABlBMVEXMzMz////TjRV2AAAACXBIWXMAAArrAAAK6wGCiw1aAAAAHHRFWHRTb2Z0d2FyZQBBZG9iZSBGaXJld29ya3MgQ1M26LyyjAAAABFJREFUCJlj+M/AgBVhF/0PAH6/D/HkDxOGAAAAAElFTkSuQmCC');
}
.cropper-hide {
    display: block;
    height: 0;
    position: absolute;
    width: 0;
}
.cropper-hidden {
    display: none !important;
}
.cropper-move {
    cursor: move;
}
.cropper-crop {
    cursor: crosshair;
}
.cropper-disabled .cropper-drag-box,
.cropper-disabled .cropper-face,
.cropper-disabled .cropper-line,
.cropper-disabled .cropper-point {
    cursor: not-allowed;
}
</style>
{% endblock %}

{% block wizard_content %}
<h3 class="mb-4">
    <i class="bi bi-cloud-upload text-primary"></i>
    Schritt 4: Creatives hochladen
</h3>

<p class="text-muted mb-4">
    Laden Sie für jedes gewählte Format ein Bild oder Video hoch oder geben Sie eine URL an.
</p>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {% for fmt in formats %}
    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-image"></i>
                Format: {{ fmt.dimension }} px ({{ fmt.width }} x {{ fmt.height }})
            </h5>
            <small class="text-muted">
                {{ fmt.zone_count }} Zone{{ fmt.zone_count|pluralize:"n" }}
                {% if fmt.zone_types %} • {{ fmt.zone_types }}{% endif %}
            </small>
        </div>
        <div class="card-body">
            <!-- Creative Type Selection -->
            <div class="mb-3">
                <label class="form-label fw-bold">Anzeigentyp wählen:</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="creative_type_{{ fmt.dimension }}"
                           id="type_file_{{ fmt.dimension }}" value="file" checked
                           onchange="toggleCreativeType('{{ fmt.dimension }}', 'file')">
                    <label class="btn btn-outline-primary" for="type_file_{{ fmt.dimension }}">
                        <i class="bi bi-file-image"></i> Datei hochladen
                    </label>

                    <input type="radio" class="btn-check" name="creative_type_{{ fmt.dimension }}"
                           id="type_url_{{ fmt.dimension }}" value="url"
                           onchange="toggleCreativeType('{{ fmt.dimension }}', 'url')">
                    <label class="btn btn-outline-primary" for="type_url_{{ fmt.dimension }}">
                        <i class="bi bi-link-45deg"></i> URL eingeben
                    </label>

                    <input type="radio" class="btn-check" name="creative_type_{{ fmt.dimension }}"
                           id="type_html_{{ fmt.dimension }}" value="html"
                           onchange="toggleCreativeType('{{ fmt.dimension }}', 'html')">
                    <label class="btn btn-outline-primary" for="type_html_{{ fmt.dimension }}">
                        <i class="bi bi-code-square"></i> HTML/Rich Text
                    </label>
                </div>
            </div>

            <!-- File Upload Option -->
            <div id="file_section_{{ fmt.dimension }}" class="creative-section">
                <label class="form-label">Bild hochladen und zuschneiden</label>

                <!-- Hidden file input -->
                <input type="file" class="d-none image-upload-input" id="creative_input_{{ fmt.dimension }}"
                       accept="image/*" data-dimension="{{ fmt.dimension }}" data-width="{{ fmt.width }}" data-height="{{ fmt.height }}">

                <!-- Hidden input for cropped image -->
                <input type="hidden" name="creative_{{ fmt.dimension }}_cropped" id="creative_{{ fmt.dimension }}_cropped">

                <!-- Upload Button -->
                <button type="button" class="btn btn-outline-primary w-100" onclick="document.getElementById('creative_input_{{ fmt.dimension }}').click()">
                    <i class="bi bi-upload"></i> Bild auswählen ({{ fmt.width }}x{{ fmt.height }} px)
                </button>

                <!-- Preview -->
                <div id="preview_{{ fmt.dimension }}" class="mt-3" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-success">
                                    <i class="bi bi-check-circle"></i> Bild zugeschnitten und bereit
                                </small>
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                        onclick="document.getElementById('creative_input_{{ fmt.dimension }}').click()">
                                    <i class="bi bi-pencil"></i> Ändern
                                </button>
                            </div>
                            <img id="preview_img_{{ fmt.dimension }}" class="img-fluid rounded" style="max-height: 150px;">
                        </div>
                    </div>
                </div>

                <small class="form-text text-muted">
                    Empfohlene Größe: {{ fmt.width }}x{{ fmt.height }} px. Sie können das Bild zuschneiden und zoomen.
                </small>
            </div>

            <!-- URL Option -->
            <div id="url_section_{{ fmt.dimension }}" class="creative-section" style="display: none;">
                <label for="creative_url_{{ fmt.dimension }}" class="form-label">Bild/Video URL</label>
                <input type="url" class="form-control" id="creative_url_{{ fmt.dimension }}"
                       name="creative_url_{{ fmt.dimension }}" placeholder="https://example.com/image.jpg">
                <small class="form-text text-muted">URL zu einem existierenden Bild oder Video</small>
            </div>

            <!-- HTML/Rich Text Option -->
            <div id="html_section_{{ fmt.dimension }}" class="creative-section" style="display: none;">
                <label for="creative_html_{{ fmt.dimension }}" class="form-label">HTML/Rich Text Content</label>
                <textarea class="form-control" id="creative_html_{{ fmt.dimension }}"
                          name="creative_html_{{ fmt.dimension }}" rows="8"
                          placeholder="<div style='text-align: center; padding: 20px; background: #f0f0f0;'>
    <h3>Ihre Werbung</h3>
    <p>Beschreibung hier...</p>
    <a href='#' class='btn'>Mehr erfahren</a>
</div>" style="font-family: monospace;"></textarea>
                <small class="form-text text-muted">
                    HTML-Code für Rich Content Anzeigen (max. {{ fmt.width }}x{{ fmt.height }} px)
                </small>
            </div>

            <!-- Status Badge -->
            {% if uploaded_creatives and fmt.dimension in uploaded_creatives %}
            <div class="mt-3">
                <span class="badge bg-success">
                    <i class="bi bi-check-circle"></i>
                    {% with creative_info=uploaded_creatives|get_item:fmt.dimension %}
                        {% if creative_info.filename %}
                            Hochgeladen: {{ creative_info.filename }}
                        {% elif creative_info.url %}
                            URL: {{ creative_info.url }}
                        {% elif creative_info.html %}
                            HTML-Content gespeichert
                        {% else %}
                            Hochgeladen ✓
                        {% endif %}
                    {% endwith %}
                </span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <strong>Hinweis:</strong> Wählen Sie für jedes Format einen Anzeigentyp:
        <ul class="mb-0 mt-2">
            <li><strong>Datei hochladen:</strong> Für Bilder und Videos</li>
            <li><strong>URL eingeben:</strong> Für extern gehostete Medien</li>
            <li><strong>HTML/Rich Text:</strong> Für individuelle, gestaltete Anzeigen</li>
        </ul>
        Mindestens ein Creative muss vorhanden sein.
    </div>

    <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'loomads:wizard_step' draft.id 'format_selection' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Zurück zu Schritt 3
        </a>
        <button type="submit" class="btn btn-primary">
            Weiter zur Überprüfung <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</form>

<!-- Image Crop Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropModalLabel">
                    <i class="bi bi-crop"></i> Bild zuschneiden
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="crop-container">
                            <img id="cropImage" style="max-width: 100%;">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Vorschau:</h6>
                        <div class="crop-preview" id="cropPreview"></div>

                        <div class="zoom-controls mt-3">
                            <label class="form-label">Zoom:</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-secondary" id="zoomOut">
                                    <i class="bi bi-zoom-out"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="resetZoom">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="zoomIn">
                                    <i class="bi bi-zoom-in"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">Ziel-Format:</label>
                            <div class="alert alert-info py-2 px-3">
                                <small id="targetDimensions"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="cropAndSave">
                    <i class="bi bi-check-circle"></i> Zuschneiden & Übernehmen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- EIGENER Canvas-basierter Cropper - KEINE externen Dependencies! -->
<script>
console.log('🚀 Lade eigenen Canvas-Cropper (keine CDN-Dependencies)...');

// Simpler Canvas-basierter Cropper
class SimpleCropper {
    constructor(imageElement, options) {
        this.image = imageElement;
        this.options = options || {};
        this.aspectRatio = options.aspectRatio || 1;
        this.container = null;
        this.canvas = null;
        this.ctx = null;
        this.cropBox = {
            x: 0,
            y: 0,
            width: 200,
            height: 200
        };
        this.isDragging = false;
        this.dragStart = { x: 0, y: 0 };
        this.scale = 1;

        this.init();
    }

    init() {
        const parent = this.image.parentElement;

        // Canvas erstellen
        this.canvas = document.createElement('canvas');
        this.canvas.style.maxWidth = '100%';
        this.canvas.style.cursor = 'move';
        this.canvas.style.border = '1px solid #dee2e6';
        this.canvas.style.borderRadius = '4px';
        this.canvas.style.background = '#f8f9fa';

        this.ctx = this.canvas.getContext('2d');

        // Bild laden und Canvas initialisieren
        const img = new Image();
        img.onload = () => {
            console.log('✅ Bild geladen:', img.width, 'x', img.height);
            this.canvas.width = Math.min(600, parent.clientWidth - 20);
            this.canvas.height = Math.min(400, parent.clientHeight - 20);

            // Crop-Box initial zentrieren
            const boxWidth = this.canvas.width * 0.7;
            const boxHeight = boxWidth / this.aspectRatio;
            this.cropBox = {
                x: (this.canvas.width - boxWidth) / 2,
                y: (this.canvas.height - boxHeight) / 2,
                width: boxWidth,
                height: boxHeight
            };

            this.draw();
            this.addEventListeners();

            if (this.options.ready) {
                this.options.ready();
            }
        };
        img.src = this.image.src;
        this.sourceImage = img;

        // Ersetze Bild durch Canvas
        parent.innerHTML = '';
        parent.appendChild(this.canvas);

        console.log('✅ SimpleCropper initialisiert');
    }

    draw() {
        const ctx = this.ctx;
        const canvas = this.canvas;

        // Clear
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Bild zeichnen (zentriert und skaliert)
        const imgWidth = this.sourceImage.width * this.scale;
        const imgHeight = this.sourceImage.height * this.scale;
        const imgX = (canvas.width - imgWidth) / 2;
        const imgY = (canvas.height - imgHeight) / 2;

        ctx.drawImage(this.sourceImage, imgX, imgY, imgWidth, imgHeight);

        // Dunkler Overlay außerhalb Crop-Box
        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Clear Crop-Box Bereich
        ctx.clearRect(this.cropBox.x, this.cropBox.y, this.cropBox.width, this.cropBox.height);

        // Re-draw Bild in Crop-Box
        ctx.save();
        ctx.beginPath();
        ctx.rect(this.cropBox.x, this.cropBox.y, this.cropBox.width, this.cropBox.height);
        ctx.clip();
        ctx.drawImage(this.sourceImage, imgX, imgY, imgWidth, imgHeight);
        ctx.restore();

        // Crop-Box Border
        ctx.strokeStyle = '#39f';
        ctx.lineWidth = 2;
        ctx.strokeRect(this.cropBox.x, this.cropBox.y, this.cropBox.width, this.cropBox.height);

        // Hilfslinien (Drittel-Raster)
        ctx.strokeStyle = '#eee';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]);

        // Horizontale Linien
        ctx.beginPath();
        ctx.moveTo(this.cropBox.x, this.cropBox.y + this.cropBox.height / 3);
        ctx.lineTo(this.cropBox.x + this.cropBox.width, this.cropBox.y + this.cropBox.height / 3);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(this.cropBox.x, this.cropBox.y + 2 * this.cropBox.height / 3);
        ctx.lineTo(this.cropBox.x + this.cropBox.width, this.cropBox.y + 2 * this.cropBox.height / 3);
        ctx.stroke();

        // Vertikale Linien
        ctx.beginPath();
        ctx.moveTo(this.cropBox.x + this.cropBox.width / 3, this.cropBox.y);
        ctx.lineTo(this.cropBox.x + this.cropBox.width / 3, this.cropBox.y + this.cropBox.height);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(this.cropBox.x + 2 * this.cropBox.width / 3, this.cropBox.y);
        ctx.lineTo(this.cropBox.x + 2 * this.cropBox.width / 3, this.cropBox.y + this.cropBox.height);
        ctx.stroke();

        ctx.setLineDash([]);
    }

    addEventListeners() {
        this.canvas.addEventListener('mousedown', (e) => {
            this.isDragging = true;
            const rect = this.canvas.getBoundingClientRect();
            this.dragStart = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        });

        this.canvas.addEventListener('mousemove', (e) => {
            if (!this.isDragging) return;

            const rect = this.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const dx = x - this.dragStart.x;
            const dy = y - this.dragStart.y;

            this.cropBox.x += dx;
            this.cropBox.y += dy;

            // Bounds checking
            this.cropBox.x = Math.max(0, Math.min(this.canvas.width - this.cropBox.width, this.cropBox.x));
            this.cropBox.y = Math.max(0, Math.min(this.canvas.height - this.cropBox.height, this.cropBox.y));

            this.dragStart = { x, y };
            this.draw();
        });

        this.canvas.addEventListener('mouseup', () => {
            this.isDragging = false;
        });

        this.canvas.addEventListener('mouseleave', () => {
            this.isDragging = false;
        });
    }

    zoom(delta) {
        this.scale += delta;
        this.scale = Math.max(0.1, Math.min(3, this.scale));
        this.draw();
    }

    reset() {
        this.scale = 1;
        const boxWidth = this.canvas.width * 0.7;
        const boxHeight = boxWidth / this.aspectRatio;
        this.cropBox = {
            x: (this.canvas.width - boxWidth) / 2,
            y: (this.canvas.height - boxHeight) / 2,
            width: boxWidth,
            height: boxHeight
        };
        this.draw();
    }

    getCroppedCanvas(options) {
        const targetWidth = options.width;
        const targetHeight = options.height;

        const resultCanvas = document.createElement('canvas');
        resultCanvas.width = targetWidth;
        resultCanvas.height = targetHeight;
        const resultCtx = resultCanvas.getContext('2d');

        // Calculate source coordinates
        const imgWidth = this.sourceImage.width * this.scale;
        const imgHeight = this.sourceImage.height * this.scale;
        const imgX = (this.canvas.width - imgWidth) / 2;
        const imgY = (this.canvas.height - imgHeight) / 2;

        // Source region in original image
        const sourceX = (this.cropBox.x - imgX) / this.scale;
        const sourceY = (this.cropBox.y - imgY) / this.scale;
        const sourceWidth = this.cropBox.width / this.scale;
        const sourceHeight = this.cropBox.height / this.scale;

        // Draw cropped portion
        resultCtx.drawImage(
            this.sourceImage,
            sourceX, sourceY, sourceWidth, sourceHeight,
            0, 0, targetWidth, targetHeight
        );

        return resultCanvas;
    }

    destroy() {
        // Cleanup
        this.canvas.remove();
    }
}

// Globale Variable für Kompatibilität
window.Cropper = SimpleCropper;
console.log('✅ SimpleCropper als window.Cropper verfügbar');
</script>

<script>
// Debugging: Überprüfe ob Cropper.js geladen ist
window.addEventListener('DOMContentLoaded', function() {
    console.log('=== Cropper Debug Info ===');
    console.log('Cropper verfügbar:', typeof Cropper !== 'undefined');

    if (typeof Cropper !== 'undefined') {
        console.log('✅ Cropper.js erfolgreich geladen');
    } else {
        console.error('❌ Cropper.js NICHT geladen! CDN-Problem?');
    }

    // Überprüfe CSS
    const cropperCSS = Array.from(document.styleSheets).find(sheet => {
        try {
            return sheet.href && sheet.href.includes('cropper');
        } catch (e) {
            return false;
        }
    });
    console.log('Cropper CSS geladen:', !!cropperCSS);

    // Test z-index des Modals
    const modal = document.getElementById('cropModal');
    if (modal) {
        const modalStyle = window.getComputedStyle(modal);
        console.log('Modal z-index:', modalStyle.zIndex);
    }
});

let cropper = null;
let currentDimension = null;
let currentWidth = 0;
let currentHeight = 0;

function toggleCreativeType(dimension, type) {
    // Hide all sections
    document.getElementById('file_section_' + dimension).style.display = 'none';
    document.getElementById('url_section_' + dimension).style.display = 'none';
    document.getElementById('html_section_' + dimension).style.display = 'none';

    // Show selected section
    document.getElementById(type + '_section_' + dimension).style.display = 'block';
}

// Handle image upload and open crop modal
document.querySelectorAll('.image-upload-input').forEach(input => {
    input.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) {
            console.log('Keine Datei ausgewählt');
            return;
        }

        // Validiere Dateityp
        if (!file.type.startsWith('image/')) {
            alert('Bitte wählen Sie eine Bilddatei aus.');
            this.value = '';
            return;
        }

        console.log('Lade Bild:', file.name, file.size, 'bytes');

        // Get dimension info
        currentDimension = this.dataset.dimension;
        currentWidth = parseInt(this.dataset.width);
        currentHeight = parseInt(this.dataset.height);

        console.log('Ziel-Dimensionen:', currentWidth, 'x', currentHeight);

        // Load image
        const reader = new FileReader();
        reader.onerror = function(error) {
            console.error('Fehler beim Laden der Datei:', error);
            alert('Fehler beim Laden der Datei. Bitte versuchen Sie es erneut.');
        };

        reader.onload = function(event) {
            console.log('Bild geladen, öffne Crop-Modal');
            const image = document.getElementById('cropImage');
            image.src = event.target.result;

            // Show modal OHNE Backdrop (wichtig für Interaktivität!)
            const modalEl = document.getElementById('cropModal');
            const modal = new bootstrap.Modal(modalEl, {
                backdrop: false,  // KEIN dunkler Overlay
                keyboard: true,   // ESC zum Schließen erlaubt
                focus: true
            });
            modal.show();
            console.log('Modal ohne Backdrop geöffnet');

            // Initialize cropper after modal is shown AND image is loaded
            modalEl.addEventListener('shown.bs.modal', function initCropper() {
                console.log('Modal geöffnet, warte auf Bild-Laden...');

                // Prüfe ob Buttons sichtbar sind
                const footer = document.querySelector('#cropModal .modal-footer');
                const cropButton = document.getElementById('cropAndSave');
                if (footer && cropButton) {
                    const footerRect = footer.getBoundingClientRect();
                    const isVisible = footerRect.top < window.innerHeight && footerRect.bottom > 0;
                    console.log('🔍 Footer Position:', footerRect.top, 'px von oben');
                    console.log('🔍 Footer sichtbar:', isVisible);
                    console.log('🔍 Viewport Höhe:', window.innerHeight, 'px');

                    if (!isVisible) {
                        console.warn('⚠️ Footer NICHT sichtbar! Scrolle runter oder Modal zu groß.');
                    } else {
                        console.log('✅ Footer und Buttons sind sichtbar!');
                    }
                }

                // Show target dimensions
                const targetDimEl = document.getElementById('targetDimensions');
                if (targetDimEl) {
                    targetDimEl.textContent = `${currentWidth} x ${currentHeight} px (${(currentWidth / currentHeight).toFixed(2)}:1)`;
                }

                // Warte bis Bild komplett geladen ist
                if (image.complete) {
                    console.log('Bild bereits geladen, initialisiere Cropper');
                    initializeCropper();
                } else {
                    image.onload = function() {
                        console.log('Bild fertig geladen, initialisiere Cropper');
                        initializeCropper();
                    };
                }

                function initializeCropper() {
                    if (cropper) {
                        console.log('Zerstöre alten Cropper');
                        cropper.destroy();
                    }

                    try {
                        console.log('Erstelle neuen Cropper mit Aspect Ratio:', currentWidth / currentHeight);
                        cropper = new Cropper(image, {
                            aspectRatio: currentWidth / currentHeight,
                            viewMode: 1,
                            autoCropArea: 1,
                            responsive: true,
                            preview: '#cropPreview',
                            dragMode: 'move',
                            guides: true,
                            center: true,
                            highlight: true,
                            cropBoxMovable: true,
                            cropBoxResizable: true,
                            toggleDragModeOnDblclick: false,
                            ready: function() {
                                console.log('✅ Cropper erfolgreich initialisiert und bereit!');
                                // Fit image to crop box
                                const containerData = cropper.getContainerData();
                                const cropBoxWidth = containerData.width * 0.8;
                                const cropBoxHeight = cropBoxWidth * (currentHeight / currentWidth);

                                cropper.setCropBoxData({
                                    width: cropBoxWidth,
                                    height: cropBoxHeight
                                });
                                console.log('Crop-Box gesetzt:', cropBoxWidth, 'x', cropBoxHeight);
                            }
                        });
                    } catch (error) {
                        console.error('❌ Fehler beim Initialisieren von Cropper:', error);
                        alert('Fehler beim Initialisieren des Crop-Tools. Bitte versuchen Sie es erneut.');
                    }
                }
            }, { once: true });
        };
        reader.readAsDataURL(file);
    });
});

// Zoom controls
document.getElementById('zoomIn').addEventListener('click', function(e) {
    console.log('🔍 Zoom In Button geklickt', e);
    if (cropper) {
        cropper.zoom(0.1);
        console.log('✅ Zoom In ausgeführt');
    } else {
        console.error('❌ Cropper nicht verfügbar');
    }
});

document.getElementById('zoomOut').addEventListener('click', function(e) {
    console.log('🔍 Zoom Out Button geklickt', e);
    if (cropper) {
        cropper.zoom(-0.1);
        console.log('✅ Zoom Out ausgeführt');
    } else {
        console.error('❌ Cropper nicht verfügbar');
    }
});

document.getElementById('resetZoom').addEventListener('click', function(e) {
    console.log('🔄 Reset Zoom Button geklickt', e);
    if (cropper) {
        cropper.reset();
        cropper.setCropBoxData({
            width: cropper.getContainerData().width * 0.9,
            height: (cropper.getContainerData().width * 0.9) * (currentHeight / currentWidth)
        });
        console.log('✅ Reset ausgeführt');
    } else {
        console.error('❌ Cropper nicht verfügbar');
    }
});

// Crop and save
document.getElementById('cropAndSave').addEventListener('click', function(e) {
    console.log('✂️ "Zuschneiden & Übernehmen" Button geklickt', e);

    if (!cropper || !currentDimension) {
        console.error('❌ Cropper oder Dimension fehlt');
        alert('Crop-Tool ist nicht bereit. Bitte laden Sie das Bild erneut.');
        return;
    }

    console.log('Schneide Bild zu:', currentWidth, 'x', currentHeight);

    // Get cropped canvas
    const canvas = cropper.getCroppedCanvas({
        width: currentWidth,
        height: currentHeight,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
    });

    if (!canvas) {
        console.error('Canvas konnte nicht erstellt werden');
        alert('Fehler beim Zuschneiden des Bildes. Bitte versuchen Sie es erneut.');
        return;
    }

    console.log('Canvas erstellt:', canvas.width, 'x', canvas.height);

    // Convert to blob and then to base64
    canvas.toBlob(function(blob) {
        if (!blob) {
            console.error('Blob konnte nicht erstellt werden');
            alert('Fehler beim Speichern des Bildes. Bitte versuchen Sie es erneut.');
            return;
        }

        console.log('Blob erstellt, Größe:', blob.size, 'bytes');

        const reader = new FileReader();
        reader.onerror = function(error) {
            console.error('Fehler beim Lesen des Blobs:', error);
            alert('Fehler beim Speichern des Bildes. Bitte versuchen Sie es erneut.');
        };

        reader.onloadend = function() {
            const base64data = reader.result;
            console.log('Base64 erstellt, Länge:', base64data.length);

            // Save to hidden input
            const hiddenInput = document.getElementById('creative_' + currentDimension + '_cropped');
            if (hiddenInput) {
                hiddenInput.value = base64data;
                console.log('Base64 in Hidden Input gespeichert');
            } else {
                console.error('Hidden Input nicht gefunden:', 'creative_' + currentDimension + '_cropped');
            }

            // Show preview
            const previewImg = document.getElementById('preview_img_' + currentDimension);
            const previewDiv = document.getElementById('preview_' + currentDimension);
            if (previewImg && previewDiv) {
                previewImg.src = base64data;
                previewDiv.style.display = 'block';
                console.log('Vorschau angezeigt');
            } else {
                console.error('Preview-Elemente nicht gefunden');
            }

            // Close modal
            const modalEl = document.getElementById('cropModal');
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) {
                modalInstance.hide();
                console.log('Modal geschlossen');
            }
        };
        reader.readAsDataURL(blob);
    }, 'image/jpeg', 0.95);
});

// Cleanup on modal close
document.getElementById('cropModal').addEventListener('hidden.bs.modal', function() {
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
});
</script>
{% endblock %}
