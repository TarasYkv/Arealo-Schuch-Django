{% extends 'loomads/wizard/wizard_base.html' %}
{% load loomads_tags %}

{% block wizard_title %}Creative-Upload{% endblock %}

{% block extra_head %}
<!-- Cropper.js for Image Cropping -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<style>
.crop-container {
    max-height: 400px;
    overflow: hidden;
}
.crop-preview {
    width: 100%;
    max-width: 300px;
    margin: 0 auto;
    overflow: hidden;
    border: 2px dashed #ddd;
}
.zoom-controls {
    margin-top: 10px;
}
</style>
{% endblock %}

{% block wizard_content %}
<h3 class="mb-4">
    <i class="bi bi-cloud-upload text-primary"></i>
    Schritt 4: Creatives hochladen
</h3>

<p class="text-muted mb-4">
    Laden Sie für jedes gewählte Format ein Bild oder Video hoch oder geben Sie eine URL an.
</p>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {% for fmt in formats %}
    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-image"></i>
                Format: {{ fmt.dimension }} px ({{ fmt.width }} x {{ fmt.height }})
            </h5>
            <small class="text-muted">
                {{ fmt.zone_count }} Zone{{ fmt.zone_count|pluralize:"n" }}
                {% if fmt.zone_types %} • {{ fmt.zone_types }}{% endif %}
            </small>
        </div>
        <div class="card-body">
            <!-- Creative Type Selection -->
            <div class="mb-3">
                <label class="form-label fw-bold">Anzeigentyp wählen:</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="creative_type_{{ fmt.dimension }}"
                           id="type_file_{{ fmt.dimension }}" value="file" checked
                           onchange="toggleCreativeType('{{ fmt.dimension }}', 'file')">
                    <label class="btn btn-outline-primary" for="type_file_{{ fmt.dimension }}">
                        <i class="bi bi-file-image"></i> Datei hochladen
                    </label>

                    <input type="radio" class="btn-check" name="creative_type_{{ fmt.dimension }}"
                           id="type_url_{{ fmt.dimension }}" value="url"
                           onchange="toggleCreativeType('{{ fmt.dimension }}', 'url')">
                    <label class="btn btn-outline-primary" for="type_url_{{ fmt.dimension }}">
                        <i class="bi bi-link-45deg"></i> URL eingeben
                    </label>

                    <input type="radio" class="btn-check" name="creative_type_{{ fmt.dimension }}"
                           id="type_html_{{ fmt.dimension }}" value="html"
                           onchange="toggleCreativeType('{{ fmt.dimension }}', 'html')">
                    <label class="btn btn-outline-primary" for="type_html_{{ fmt.dimension }}">
                        <i class="bi bi-code-square"></i> HTML/Rich Text
                    </label>
                </div>
            </div>

            <!-- File Upload Option -->
            <div id="file_section_{{ fmt.dimension }}" class="creative-section">
                <label class="form-label">Bild hochladen und zuschneiden</label>

                <!-- Hidden file input -->
                <input type="file" class="d-none image-upload-input" id="creative_input_{{ fmt.dimension }}"
                       accept="image/*" data-dimension="{{ fmt.dimension }}" data-width="{{ fmt.width }}" data-height="{{ fmt.height }}">

                <!-- Hidden input for cropped image -->
                <input type="hidden" name="creative_{{ fmt.dimension }}_cropped" id="creative_{{ fmt.dimension }}_cropped">

                <!-- Upload Button -->
                <button type="button" class="btn btn-outline-primary w-100" onclick="document.getElementById('creative_input_{{ fmt.dimension }}').click()">
                    <i class="bi bi-upload"></i> Bild auswählen ({{ fmt.width }}x{{ fmt.height }} px)
                </button>

                <!-- Preview -->
                <div id="preview_{{ fmt.dimension }}" class="mt-3" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-success">
                                    <i class="bi bi-check-circle"></i> Bild zugeschnitten und bereit
                                </small>
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                        onclick="document.getElementById('creative_input_{{ fmt.dimension }}').click()">
                                    <i class="bi bi-pencil"></i> Ändern
                                </button>
                            </div>
                            <img id="preview_img_{{ fmt.dimension }}" class="img-fluid rounded" style="max-height: 150px;">
                        </div>
                    </div>
                </div>

                <small class="form-text text-muted">
                    Empfohlene Größe: {{ fmt.width }}x{{ fmt.height }} px. Sie können das Bild zuschneiden und zoomen.
                </small>
            </div>

            <!-- URL Option -->
            <div id="url_section_{{ fmt.dimension }}" class="creative-section" style="display: none;">
                <label for="creative_url_{{ fmt.dimension }}" class="form-label">Bild/Video URL</label>
                <input type="url" class="form-control" id="creative_url_{{ fmt.dimension }}"
                       name="creative_url_{{ fmt.dimension }}" placeholder="https://example.com/image.jpg">
                <small class="form-text text-muted">URL zu einem existierenden Bild oder Video</small>
            </div>

            <!-- HTML/Rich Text Option -->
            <div id="html_section_{{ fmt.dimension }}" class="creative-section" style="display: none;">
                <label for="creative_html_{{ fmt.dimension }}" class="form-label">HTML/Rich Text Content</label>
                <textarea class="form-control" id="creative_html_{{ fmt.dimension }}"
                          name="creative_html_{{ fmt.dimension }}" rows="8"
                          placeholder="<div style='text-align: center; padding: 20px; background: #f0f0f0;'>
    <h3>Ihre Werbung</h3>
    <p>Beschreibung hier...</p>
    <a href='#' class='btn'>Mehr erfahren</a>
</div>" style="font-family: monospace;"></textarea>
                <small class="form-text text-muted">
                    HTML-Code für Rich Content Anzeigen (max. {{ fmt.width }}x{{ fmt.height }} px)
                </small>
            </div>

            <!-- Status Badge -->
            {% if uploaded_creatives and fmt.dimension in uploaded_creatives %}
            <div class="mt-3">
                <span class="badge bg-success">
                    <i class="bi bi-check-circle"></i>
                    {% with creative_info=uploaded_creatives|get_item:fmt.dimension %}
                        {% if creative_info.filename %}
                            Hochgeladen: {{ creative_info.filename }}
                        {% elif creative_info.url %}
                            URL: {{ creative_info.url }}
                        {% elif creative_info.html %}
                            HTML-Content gespeichert
                        {% else %}
                            Hochgeladen ✓
                        {% endif %}
                    {% endwith %}
                </span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <strong>Hinweis:</strong> Wählen Sie für jedes Format einen Anzeigentyp:
        <ul class="mb-0 mt-2">
            <li><strong>Datei hochladen:</strong> Für Bilder und Videos</li>
            <li><strong>URL eingeben:</strong> Für extern gehostete Medien</li>
            <li><strong>HTML/Rich Text:</strong> Für individuelle, gestaltete Anzeigen</li>
        </ul>
        Mindestens ein Creative muss vorhanden sein.
    </div>

    <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'loomads:wizard_step' draft.id 'format_selection' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Zurück zu Schritt 3
        </a>
        <button type="submit" class="btn btn-primary">
            Weiter zur Überprüfung <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</form>

<!-- Image Crop Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropModalLabel">
                    <i class="bi bi-crop"></i> Bild zuschneiden
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="crop-container">
                            <img id="cropImage" style="max-width: 100%;">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Vorschau:</h6>
                        <div class="crop-preview" id="cropPreview"></div>

                        <div class="zoom-controls mt-3">
                            <label class="form-label">Zoom:</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-secondary" id="zoomOut">
                                    <i class="bi bi-zoom-out"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="resetZoom">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="zoomIn">
                                    <i class="bi bi-zoom-in"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">Ziel-Format:</label>
                            <div class="alert alert-info py-2 px-3">
                                <small id="targetDimensions"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="cropAndSave">
                    <i class="bi bi-check-circle"></i> Zuschneiden & Übernehmen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cropper.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
let cropper = null;
let currentDimension = null;
let currentWidth = 0;
let currentHeight = 0;

function toggleCreativeType(dimension, type) {
    // Hide all sections
    document.getElementById('file_section_' + dimension).style.display = 'none';
    document.getElementById('url_section_' + dimension).style.display = 'none';
    document.getElementById('html_section_' + dimension).style.display = 'none';

    // Show selected section
    document.getElementById(type + '_section_' + dimension).style.display = 'block';
}

// Handle image upload and open crop modal
document.querySelectorAll('.image-upload-input').forEach(input => {
    input.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Get dimension info
        currentDimension = this.dataset.dimension;
        currentWidth = parseInt(this.dataset.width);
        currentHeight = parseInt(this.dataset.height);

        // Show target dimensions
        document.getElementById('targetDimensions').textContent =
            `${currentWidth} x ${currentHeight} px (${(currentWidth / currentHeight).toFixed(2)}:1)`;

        // Load image
        const reader = new FileReader();
        reader.onload = function(event) {
            const image = document.getElementById('cropImage');
            image.src = event.target.result;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('cropModal'));
            modal.show();

            // Initialize cropper after modal is shown
            document.getElementById('cropModal').addEventListener('shown.bs.modal', function() {
                if (cropper) {
                    cropper.destroy();
                }

                cropper = new Cropper(image, {
                    aspectRatio: currentWidth / currentHeight,
                    viewMode: 1,
                    autoCropArea: 1,
                    responsive: true,
                    preview: '#cropPreview',
                    ready: function() {
                        // Fit image to crop box
                        cropper.setCropBoxData({
                            width: cropper.getContainerData().width * 0.9,
                            height: (cropper.getContainerData().width * 0.9) * (currentHeight / currentWidth)
                        });
                    }
                });
            }, { once: true });
        };
        reader.readAsDataURL(file);
    });
});

// Zoom controls
document.getElementById('zoomIn').addEventListener('click', function() {
    if (cropper) cropper.zoom(0.1);
});

document.getElementById('zoomOut').addEventListener('click', function() {
    if (cropper) cropper.zoom(-0.1);
});

document.getElementById('resetZoom').addEventListener('click', function() {
    if (cropper) {
        cropper.reset();
        cropper.setCropBoxData({
            width: cropper.getContainerData().width * 0.9,
            height: (cropper.getContainerData().width * 0.9) * (currentHeight / currentWidth)
        });
    }
});

// Crop and save
document.getElementById('cropAndSave').addEventListener('click', function() {
    if (!cropper || !currentDimension) return;

    // Get cropped canvas
    const canvas = cropper.getCroppedCanvas({
        width: currentWidth,
        height: currentHeight,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
    });

    // Convert to blob and then to base64
    canvas.toBlob(function(blob) {
        const reader = new FileReader();
        reader.onloadend = function() {
            const base64data = reader.result;

            // Save to hidden input
            document.getElementById('creative_' + currentDimension + '_cropped').value = base64data;

            // Show preview
            document.getElementById('preview_img_' + currentDimension).src = base64data;
            document.getElementById('preview_' + currentDimension).style.display = 'block';

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('cropModal')).hide();
        };
        reader.readAsDataURL(blob);
    }, 'image/jpeg', 0.95);
});

// Cleanup on modal close
document.getElementById('cropModal').addEventListener('hidden.bs.modal', function() {
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
});
</script>
{% endblock %}
