{% extends 'base.html' %}

{% block title %}API Keys verwalten{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>API Keys verwalten</h1>
    <p>Geben Sie hier Ihre API-Schlüssel ein. Diese werden sicher und verschlüsselt gespeichert.</p>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <form method="post">
        {% csrf_token %}
        <div class="mb-3">
            <label for="{{ form.openai_api_key.id_for_label }}" class="form-label">{{ form.openai_api_key.label }}</label>
            {{ form.openai_api_key }}
            {% if form.openai_api_key.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.openai_api_key.errors.0 }}
                </div>
            {% endif %}
        </div>
        <div class="mb-3">
            <label for="{{ form.anthropic_api_key.id_for_label }}" class="form-label">{{ form.anthropic_api_key.label }}</label>
            {{ form.anthropic_api_key }}
            {% if form.anthropic_api_key.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.anthropic_api_key.errors.0 }}
                </div>
            {% endif %}
        </div>
        <button type="submit" class="btn btn-primary">Speichern</button>
    </form>
    
    <!-- Canva API Einstellungen -->
    <div class="mt-5">
        <h2>
            <i class="fas fa-palette text-warning"></i> Canva Integration
        </h2>
        <p class="text-muted">
            Verbinden Sie Ihr Canva-Konto, um Designs direkt in den Bildeditor zu importieren.
        </p>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog"></i> Canva API-Einstellungen
                </h5>
            </div>
            <div class="card-body">
                {% if canva_settings.has_access_token %}
                    <!-- Verbunden -->
                    <div class="alert alert-success" role="alert">
                        <i class="fas fa-check-circle"></i>
                        <strong>Erfolgreich verbunden!</strong> 
                        Ihr Canva-Konto ist mit dem Bildeditor verknüpft.
                        {% if canva_settings.token_expires_at %}
                        <br><small class="text-muted">
                            Token läuft ab am: {{ canva_settings.token_expires_at|date:"d.m.Y H:i" }}
                        </small>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <a href="{% url 'image_editor:canva_import' %}" class="btn btn-warning btn-lg w-100">
                                <i class="fas fa-download"></i> Designs importieren
                            </a>
                        </div>
                        <div class="col-md-6">
                            <form method="post" action="{% url 'accounts:canva_disconnect' %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-danger btn-lg w-100" 
                                        onclick="return confirm('Möchten Sie die Canva-Verbindung wirklich trennen?')">
                                    <i class="fas fa-unlink"></i> Verbindung trennen
                                </button>
                            </form>
                        </div>
                    </div>
                    
                {% else %}
                    <!-- Nicht verbunden -->
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle"></i>
                        <strong>Noch nicht verbunden.</strong> 
                        Konfigurieren Sie zuerst Ihre Canva API-Einstellungen.
                    </div>
                    
                    {% if canva_settings.has_valid_credentials %}
                        <div class="mb-3">
                            <a href="{% url 'accounts:canva_oauth_start' %}" class="btn btn-warning btn-lg">
                                <i class="fab fa-canva"></i> Mit Canva verbinden
                            </a>
                        </div>
                    {% endif %}
                {% endif %}
                
                <!-- Einstellungsformular -->
                <div class="border-top pt-3 mt-3">
                    <h6>API-Konfiguration</h6>
                    <form method="post" action="{% url 'accounts:canva_settings' %}">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-key"></i> Client ID
                                    </label>
                                    <input type="text" name="client_id" class="form-control" 
                                           value="{{ canva_settings.client_id }}"
                                           placeholder="Ihre Canva Client ID">
                                    <div class="form-text">
                                        Erhalten Sie von der 
                                        <a href="https://www.canva.com/developers/" target="_blank">
                                            Canva Developer Console <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-lock"></i> Client Secret
                                    </label>
                                    <input type="password" name="client_secret" class="form-control" 
                                           value="{{ canva_settings.client_secret }}"
                                           placeholder="Ihr Canva Client Secret">
                                    <div class="form-text">
                                        Wird sicher verschlüsselt gespeichert
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tags"></i> Brand Template ID (optional)
                                    </label>
                                    <input type="text" name="brand_template_id" class="form-control" 
                                           value="{{ canva_settings.brand_template_id }}"
                                           placeholder="Standard Brand Template">
                                    <div class="form-text">
                                        Für konsistentes Branding
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-folder"></i> Ordner ID (optional)
                                    </label>
                                    <input type="text" name="folder_id" class="form-control" 
                                           value="{{ canva_settings.folder_id }}"
                                           placeholder="Standard Ordner">
                                    <div class="form-text">
                                        Designs aus spezifischem Ordner
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Canva-Einstellungen speichern
                        </button>
                    </form>
                </div>
                
                <!-- Hilfe-Sektion -->
                <div class="border-top pt-3 mt-3">
                    <h6>
                        <i class="fas fa-question-circle text-info"></i> Einrichtungshilfe
                    </h6>
                    <div class="small text-muted">
                        <ol>
                            <li>Besuchen Sie die <a href="https://www.canva.com/developers/" target="_blank">Canva Developer Console</a></li>
                            <li>Erstellen Sie eine neue App</li>
                            <li>Fügen Sie diese Redirect URI hinzu: <code>{{ request.build_absolute_uri }}canva-oauth-callback/</code></li>
                            <li>Kopieren Sie Client ID und Secret hierher</li>
                            <li>Klicken Sie auf "Mit Canva verbinden"</li>
                        </ol>
                        
                        <div class="alert alert-warning alert-sm mt-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Wichtig:</strong> Stellen Sie sicher, dass die Redirect URI exakt übereinstimmt.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}