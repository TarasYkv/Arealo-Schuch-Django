{% extends 'base.html' %}

{% block title %}API-Einstellungen - Workloom{% endblock %}

{% block content %}

<style>
/* Dark Mode Compatibility Styles */
body.bg-dark .card {
    background-color: #2d3748 !important;
    border-color: #4a5568 !important;
    color: #e2e8f0 !important;
}

body.bg-dark .card-header {
    background-color: #1a202c !important;
    border-color: #4a5568 !important;
    color: #e2e8f0 !important;
}

body.bg-dark .form-control,
body.bg-dark .form-select {
    background-color: #1a202c !important;
    border-color: #4a5568 !important;
    color: #e2e8f0 !important;
}

body.bg-dark .form-control::placeholder {
    color: #718096 !important;
}

body.bg-dark .input-group-text {
    background-color: #2d3748 !important;
    border-color: #4a5568 !important;
    color: #e2e8f0 !important;
}

body.bg-dark .btn-outline-secondary {
    border-color: #718096 !important;
    color: #e2e8f0 !important;
}

body.bg-dark .btn-outline-secondary:hover {
    background-color: #4a5568 !important;
    border-color: #718096 !important;
    color: #ffffff !important;
}

body.bg-dark .text-muted {
    color: #a0aec0 !important;
}

body.bg-dark .alert-info {
    background-color: #2c5282 !important;
    border-color: #2d3748 !important;
    color: #bee3f8 !important;
}

body.bg-dark .alert-success {
    background-color: #276749 !important;
    border-color: #2d3748 !important;
    color: #c6f6d5 !important;
}

body.bg-dark .alert-warning {
    background-color: #744210 !important;
    border-color: #2d3748 !important;
    color: #fefcbf !important;
}

body.bg-dark .breadcrumb {
    background-color: #2d3748 !important;
}

body.bg-dark .breadcrumb-item a {
    color: #90cdf4 !important;
}

body.bg-dark .breadcrumb-item.active {
    color: #e2e8f0 !important;
}

body.bg-dark .modal-content {
    background-color: #2d3748 !important;
    border-color: #4a5568 !important;
    color: #e2e8f0 !important;
}

body.bg-dark .modal-header {
    border-color: #4a5568 !important;
}

body.bg-dark .modal-footer {
    border-color: #4a5568 !important;
}

body.bg-dark .btn-close-white {
    filter: invert(1);
}

/* Improved Card Layout and Spacing */
.api-provider-card {
    min-height: 400px;
    margin-bottom: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.api-provider-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

body.bg-dark .api-provider-card {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

body.bg-dark .api-provider-card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
}

.api-provider-card .card-header {
    padding: 1rem 1.5rem;
    border-radius: 12px 12px 0 0;
    font-weight: 600;
}

.api-provider-card .card-body {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
}

.api-provider-card .btn-group {
    margin-top: auto;
}

/* Typography Improvements */
h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.lead {
    font-size: 1.125rem;
    color: #6c757d;
    margin-bottom: 2rem;
}

body.bg-dark .lead {
    color: #a0aec0 !important;
}

.form-label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

/* Button Improvements */
.btn {
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

/* Improved spacing */
.mb-2 {
    margin-bottom: 1rem !important;
}

.mb-3 {
    margin-bottom: 1.5rem !important;
}

.mb-4 {
    margin-bottom: 2rem !important;
}

/* Status Indicator Styles */
.api-status-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.status-light {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
}

.status-light.status-red {
    background: linear-gradient(135deg, #ff4757, #ff3838);
    box-shadow: 0 0 8px rgba(255, 71, 87, 0.4);
}

.status-light.status-green {
    background: linear-gradient(135deg, #2ed573, #1dd1a1);
    box-shadow: 0 0 8px rgba(46, 213, 115, 0.4);
}

.status-light.status-yellow {
    background: linear-gradient(135deg, #ffa502, #ff6348);
    box-shadow: 0 0 8px rgba(255, 165, 2, 0.4);
}

.status-light.status-gray {
    background: linear-gradient(135deg, #747d8c, #57606f);
    box-shadow: 0 0 8px rgba(116, 125, 140, 0.3);
}

.status-light.pulsing {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.7;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

.test-api-key-btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.test-api-key-btn:disabled {
    opacity: 0.6;
}

/* API Key Input Styling */
.api-key-input {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    word-break: break-all;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* API Key Status Container */
.api-key-status-container {
    min-height: 20px;
    max-width: 100%;
    overflow: hidden;
}

.api-key-status-text {
    font-family: 'Courier New', monospace;
    font-size: 0.75rem;
    word-break: break-all;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 150px;
    display: inline-block;
}

/* Responsive API Card Layout */
.api-provider-card {
    min-height: 320px;
}

.api-provider-card .card-body {
    display: flex;
    flex-direction: column;
}

.api-provider-card .btn-group {
    margin-top: auto;
}

/* Input Group Fixes for Long Content */
.input-group .form-control {
    min-width: 0;
    flex: 1;
}

.status-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.status-row .api-status-indicator {
    flex-shrink: 0;
}

.status-row .test-api-key-btn {
    flex-shrink: 0;
    margin-left: auto;
}

.status-row .api-key-status-text-wrapper {
    flex: 1;
    min-width: 0;
    overflow: hidden;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .api-key-status-text {
        max-width: 120px;
        font-size: 0.7rem;
    }
    
    .status-row {
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .status-row .test-api-key-btn {
        margin-left: 0;
        margin-top: 0.25rem;
    }
    
    .api-provider-card {
        min-height: 280px;
    }
}

@media (max-width: 576px) {
    .api-key-input {
        font-size: 0.75rem;
    }
    
    .api-key-status-text {
        max-width: 100px;
        font-size: 0.65rem;
    }
}
</style>
<div class="container mt-5 mb-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'naturmacher:thema_list' %}">Alle Themen</a></li>
                    <li class="breadcrumb-item active" aria-current="page">API-Einstellungen</li>
                </ol>
            </nav>
            
            <h1><i class="fas fa-cog"></i> API-Einstellungen</h1>
            <p class="lead">Verwalten Sie Ihre API-Kontostände und überwachen Sie die Nutzungskosten.</p>
            
            <!-- Balance Management -->
            <div class="card mb-5 shadow-sm">
                <div class="card-header">
                    <h5><i class="fas fa-wallet"></i> Kontostände verwalten</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Hinweis:</strong> Geben Sie Ihre aktuellen Kontostände manuell ein. 
                        Diese werden automatisch bei jeder API-Nutzung aktualisiert.
                    </div>
                    
                    <form id="balanceForm">
                        <div class="row g-4">
                            <!-- OpenAI -->
                            <div class="col-lg-4 col-md-6">
                                <div class="card api-provider-card">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">OpenAI (ChatGPT)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <label for="openai_api_key" class="form-label">API-Schlüssel:</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control api-key-input" id="openai_api_key" 
                                                       placeholder="sk-proj-...">
                                                <button type="button" class="btn btn-outline-secondary toggle-password" 
                                                        data-target="openai_api_key">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="status-row mt-1 api-key-status-container">
                                                <div class="api-status-indicator" id="openai_status_indicator">
                                                    <div class="status-light status-gray" title="Nicht getestet"></div>
                                                </div>
                                                <div class="api-key-status-text-wrapper">
                                                    <small class="text-muted">
                                                        Status: <span id="openai_key_status" class="api-key-status-text">Nicht konfiguriert</span>
                                                    </small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary test-api-key-btn" 
                                                        data-provider="openai" title="API-Schlüssel testen">
                                                    <i class="fas fa-vial"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="openai_balance" class="form-label">Kontostand:</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="openai_balance" 
                                                       step="0.01" min="0" placeholder="0.00">
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="openai_threshold" class="form-label">Warnschwelle:</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="openai_threshold" 
                                                       step="0.01" min="0" placeholder="5.00" value="5.00">
                                            </div>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-primary update-balance-btn" 
                                                    data-provider="openai">
                                                <i class="fas fa-save"></i> Speichern
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger remove-key-btn" 
                                                    data-provider="openai" title="API-Key entfernen">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <a href="https://platform.openai.com/settings/organization/billing/overview" 
                                           target="_blank" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-external-link-alt"></i> Dashboard
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Anthropic -->
                            <div class="col-lg-4 col-md-6">
                                <div class="card api-provider-card">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">Anthropic (Claude)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <label for="anthropic_api_key" class="form-label">API-Schlüssel:</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control api-key-input" id="anthropic_api_key" 
                                                       placeholder="sk-ant-api03-...">
                                                <button type="button" class="btn btn-outline-secondary toggle-password" 
                                                        data-target="anthropic_api_key">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="status-row mt-1 api-key-status-container">
                                                <div class="api-status-indicator" id="anthropic_status_indicator">
                                                    <div class="status-light status-gray" title="Nicht getestet"></div>
                                                </div>
                                                <div class="api-key-status-text-wrapper">
                                                    <small class="text-muted">
                                                        Status: <span id="anthropic_key_status" class="api-key-status-text">Nicht konfiguriert</span>
                                                    </small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary test-api-key-btn" 
                                                        data-provider="anthropic" title="API-Schlüssel testen">
                                                    <i class="fas fa-vial"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="anthropic_balance" class="form-label">Kontostand:</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="anthropic_balance" 
                                                       step="0.01" min="0" placeholder="0.00">
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="anthropic_threshold" class="form-label">Warnschwelle:</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="anthropic_threshold" 
                                                       step="0.01" min="0" placeholder="5.00" value="5.00">
                                            </div>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-primary update-balance-btn" 
                                                    data-provider="anthropic">
                                                <i class="fas fa-save"></i> Speichern
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger remove-key-btn" 
                                                    data-provider="anthropic" title="API-Key entfernen">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <a href="https://console.anthropic.com/settings/billing" 
                                           target="_blank" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-external-link-alt"></i> Dashboard
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Google -->
                            <div class="col-lg-4 col-md-6">
                                <div class="card api-provider-card">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">Google (Gemini)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <label for="google_api_key" class="form-label">API-Schlüssel:</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control api-key-input" id="google_api_key" 
                                                       placeholder="AIzaSy...">
                                                <button type="button" class="btn btn-outline-secondary toggle-password" 
                                                        data-target="google_api_key">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="status-row mt-1 api-key-status-container">
                                                <div class="api-status-indicator" id="google_status_indicator">
                                                    <div class="status-light status-gray" title="Nicht getestet"></div>
                                                </div>
                                                <div class="api-key-status-text-wrapper">
                                                    <small class="text-muted">
                                                        Status: <span id="google_key_status" class="api-key-status-text">Nicht konfiguriert</span>
                                                    </small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary test-api-key-btn" 
                                                        data-provider="google" title="API-Schlüssel testen">
                                                    <i class="fas fa-vial"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="google_balance" class="form-label">Kontostand:</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="google_balance" 
                                                       step="0.01" min="0" placeholder="0.00">
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="google_threshold" class="form-label">Warnschwelle:</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="google_threshold" 
                                                       step="0.01" min="0" placeholder="5.00" value="5.00">
                                            </div>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-primary update-balance-btn" 
                                                    data-provider="google">
                                                <i class="fas fa-save"></i> Speichern
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger remove-key-btn" 
                                                    data-provider="google" title="API-Key entfernen">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <a href="https://console.cloud.google.com/billing" 
                                           target="_blank" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-external-link-alt"></i> Dashboard
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- YouTube API -->
                            <div class="col-lg-3 col-md-6">
                                <div class="card api-provider-card">
                                    <div class="card-header bg-danger text-white">
                                        <h6 class="mb-0">YouTube Data API</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <label for="youtube_api_key" class="form-label">API-Schlüssel:</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control api-key-input" id="youtube_api_key" 
                                                       name="youtube_api_key" placeholder="AIzaSy...">
                                                <button type="button" class="btn btn-outline-secondary toggle-password" 
                                                        data-target="youtube_api_key">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="status-row mt-1 api-key-status-container">
                                                <div class="api-status-indicator" id="youtube_status_indicator">
                                                    <div class="status-light status-gray" title="Nicht getestet"></div>
                                                </div>
                                                <div class="api-key-status-text-wrapper">
                                                    <small class="text-muted">
                                                        Status: <span id="youtube_key_status" class="api-key-status-text">Nicht konfiguriert</span>
                                                    </small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary test-api-key-btn" 
                                                        data-provider="youtube" title="API-Schlüssel testen">
                                                    <i class="fas fa-vial"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="youtube_quota_limit" class="form-label">Tägliches Quota-Limit:</label>
                                            <input type="number" class="form-control" id="youtube_quota_limit" 
                                                   name="youtube_quota_limit" placeholder="10000" step="1000">
                                            <small class="text-muted">Standard: 10.000 Einheiten/Tag</small>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-primary update-balance-btn" 
                                                    data-provider="youtube">
                                                <i class="fas fa-save"></i> Speichern
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger remove-key-btn" 
                                                    data-provider="youtube" title="API-Key entfernen">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <a href="https://console.cloud.google.com/apis/credentials" 
                                           target="_blank" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-external-link-alt"></i> Console
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Canva Integration -->
                            <div class="col-lg-3 col-md-6">
                                <div class="card api-provider-card">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="fab fa-canva"></i> Canva</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if canva_settings.has_access_token %}
                                            <!-- Verbunden -->
                                            <div class="alert alert-success alert-sm p-2 mb-2">
                                                <i class="fas fa-check-circle"></i>
                                                <strong>Verbunden!</strong>
                                                {% if canva_settings.token_expires_at %}
                                                <br><small>Token läuft ab: {{ canva_settings.token_expires_at|date:"d.m.Y" }}</small>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="mb-2">
                                                <a href="{% url 'image_editor:canva_import' %}" class="btn btn-sm btn-warning w-100">
                                                    <i class="fas fa-download"></i> Designs importieren
                                                </a>
                                            </div>
                                            
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        onclick="toggleCanvaSettings()">
                                                    <i class="fas fa-cog"></i> Einstellungen
                                                </button>
                                                <form method="post" action="{% url 'accounts:canva_disconnect' %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                            onclick="return confirm('Canva-Verbindung trennen?')">
                                                        <i class="fas fa-unlink"></i> Trennen
                                                    </button>
                                                </form>
                                            </div>
                                        {% else %}
                                            <!-- Nicht verbunden -->
                                            <div class="alert alert-info alert-sm p-2 mb-2">
                                                <i class="fas fa-info-circle"></i>
                                                <strong>Nicht verbunden</strong>
                                            </div>
                                            
                                            <div class="mb-2">
                                                {% if canva_settings.has_valid_credentials %}
                                                    <a href="{% url 'accounts:canva_oauth_start' %}" class="btn btn-sm btn-warning w-100">
                                                        <i class="fab fa-canva"></i> Mit Canva verbinden
                                                    </a>
                                                {% else %}
                                                    <button type="button" class="btn btn-sm btn-outline-secondary w-100" 
                                                            onclick="toggleCanvaSettings()">
                                                        <i class="fas fa-cog"></i> Einstellungen
                                                    </button>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        
                                        <a href="https://www.canva.com/developers/" 
                                           target="_blank" class="btn btn-sm btn-outline-secondary w-100 mt-1">
                                            <i class="fas fa-external-link-alt"></i> Developer Portal
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Zoho Mail Integration -->
                            <div class="col-lg-3 col-md-6">
                                <div class="card api-provider-card">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0"><i class="fas fa-envelope"></i> Zoho Mail</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <div class="api-status-indicator" id="zoho_status_indicator">
                                                <div class="status-light status-gray" title="Nicht getestet"></div>
                                            </div>
                                            <small class="text-muted ms-2">
                                                Status: <span id="zoho_key_status" class="api-key-status-text">Nicht konfiguriert</span>
                                            </small>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#zohoSettingsModal">
                                                <i class="fas fa-cog"></i> Konfigurieren
                                            </button>
                                        </div>
                                        
                                        <div class="btn-group w-100 mb-2" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-success" onclick="testZohoConnection()">
                                                <i class="fas fa-vial"></i> Test
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info" onclick="openMailDashboard()">
                                                <i class="fas fa-external-link-alt"></i> Mail App
                                            </button>
                                        </div>
                                        
                                        <button type="button" class="btn btn-sm btn-outline-danger w-100 mb-2" onclick="deleteAllEmails()">
                                            <i class="fas fa-trash"></i> Alle Emails löschen
                                        </button>
                                        
                                        <a href="https://accounts.zoho.eu/developerconsole" 
                                           target="_blank" class="btn btn-sm btn-outline-secondary w-100">
                                            <i class="fas fa-external-link-alt"></i> Developer Console
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Shopify Integration -->
                            <div class="col-lg-3 col-md-6">
                                <div class="card api-provider-card">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="fab fa-shopify"></i> Shopify</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if shopify_stores %}
                                            <!-- Verbunden -->
                                            <div class="alert alert-success alert-sm p-2 mb-2">
                                                <i class="fas fa-check-circle"></i>
                                                <strong>{{ shopify_stores.count }} Store{{ shopify_stores.count|pluralize }}</strong>
                                            </div>
                                            
                                            <div class="mb-2">
                                                <select class="form-select form-select-sm" id="shopifyStoreSelect">
                                                    {% for store in shopify_stores %}
                                                    <option value="{{ store.id }}">{{ store.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            
                                            <div class="row mb-2">
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-sm btn-success w-100" onclick="shopifyImportImages()">
                                                        <i class="fas fa-download"></i> Import
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-sm btn-outline-success w-100" onclick="shopifyExportImages()">
                                                        <i class="fas fa-upload"></i> Export
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleShopifySettings()">
                                                    <i class="fas fa-cog"></i> Verwalten
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-success" onclick="testShopifyConnection()">
                                                    <i class="fas fa-vial"></i> Test
                                                </button>
                                            </div>
                                        {% else %}
                                            <!-- Nicht verbunden -->
                                            <div class="alert alert-info alert-sm p-2 mb-2">
                                                <i class="fas fa-info-circle"></i>
                                                <strong>Keine Stores</strong>
                                            </div>
                                            
                                            <div class="mb-2">
                                                <button type="button" class="btn btn-sm btn-outline-success w-100" onclick="toggleShopifySettings()">
                                                    <i class="fas fa-plus"></i> Store hinzufügen
                                                </button>
                                            </div>
                                        {% endif %}
                                        
                                        <a href="{% url 'shopify_manager:store_list' %}" 
                                           target="_blank" class="btn btn-sm btn-outline-secondary w-100 mt-1">
                                            <i class="fas fa-external-link-alt"></i> Shopify Manager
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Usage Statistics -->
            <div class="card mb-5 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-chart-bar"></i> Nutzungsstatistiken (30 Tage)</h5>
                    <button class="btn btn-sm btn-outline-primary" id="refreshStatsBtn">
                        <i class="fas fa-sync-alt"></i> Aktualisieren
                    </button>
                </div>
                <div class="card-body" id="usageStatsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Laden...</span>
                        </div>
                        <p class="text-muted">Statistiken werden geladen...</p>
                    </div>
                </div>
            </div>
            
            <!-- Zoho Mail Settings Modal -->
            <div class="modal fade" id="zohoSettingsModal" tabindex="-1" aria-labelledby="zohoSettingsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="zohoSettingsModalLabel">
                                <i class="fas fa-envelope"></i> Zoho Mail API-Einstellungen
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="zohoSettingsForm">
                                {% csrf_token %}
                                
                                <div class="mb-4">
                                    <h5 class="text-primary mb-3">
                                        <i class="fas fa-cogs"></i> Setup-Anleitung für Zoho Developer Console
                                    </h5>
                                    
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="fas fa-plus-circle text-primary"></i> Schritt 1: Application erstellen</h6>
                                        </div>
                                        <div class="card-body">
                                            <ol class="mb-0">
                                                <li>Öffnen Sie die <a href="https://accounts.zoho.eu/developerconsole" target="_blank" class="fw-bold text-decoration-none">Zoho Developer Console <i class="fas fa-external-link-alt"></i></a></li>
                                                <li>Klicken Sie auf <span class="badge bg-primary">"Add Client"</span></li>
                                                <li>Wählen Sie <span class="badge bg-success">"Server-based Applications"</span></li>
                                            </ol>
                                        </div>
                                    </div>
                                    
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="fas fa-sliders-h text-primary"></i> Schritt 2: Application konfigurieren</h6>
                                        </div>
                                        <div class="card-body">
                                            <ul class="mb-2">
                                                <li><strong>Client Name:</strong> <code class="bg-light px-2 py-1 rounded">Workloom Mail Integration</code> (oder beliebiger Name)</li>
                                                <li><strong>Homepage URL:</strong> 
                                                    <div class="mt-1">
                                                        <code class="bg-light px-2 py-1 rounded">{{ request.build_absolute_uri|slice:":-1" }}</code>
                                                        <br>
                                                        <small class="text-muted">(Development: <code>http://127.0.0.1:8000</code> | Production: <code>https://workloom.de</code>)</small>
                                                    </div>
                                                </li>
                                                <li><strong>Authorized Redirect URIs:</strong> 
                                                    <div class="mt-2 p-3 bg-light border rounded">
                                                        <code class="text-primary fw-bold fs-6">{{ request.build_absolute_uri }}mail/auth/callback/</code>
                                                    </div>
                                                    <div class="mt-2 border border-info rounded p-3 bg-light">
                                                        <div class="d-flex align-items-start">
                                                            <i class="fas fa-info-circle text-info me-2 mt-1"></i>
                                                            <div>
                                                                <strong class="text-info">Wichtig - Umgebungsabhängige URLs:</strong>
                                                                <ul class="mb-2 mt-2">
                                                                    <li><strong>Development:</strong> <code>http://127.0.0.1:8000/mail/auth/callback/</code></li>
                                                                    <li><strong>Production:</strong> <code>https://workloom.de/mail/auth/callback/</code></li>
                                                                </ul>
                                                                <small class="text-muted">
                                                                    Verwenden Sie die URL entsprechend Ihrer Umgebung. Bei Production unbedingt die HTTPS workloom.de URL verwenden!
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="fas fa-key text-primary"></i> Schritt 3: Scopes auswählen</h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-3">Folgende <strong>API-Berechtigungen (Scopes)</strong> müssen aktiviert werden:</p>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <ul class="list-unstyled">
                                                        <li class="mb-1"><i class="fas fa-check-circle text-success"></i> <code class="ms-2">ZohoMail.messages.ALL</code></li>
                                                        <li class="mb-1"><i class="fas fa-check-circle text-success"></i> <code class="ms-2">ZohoMail.folders.ALL</code></li>
                                                        <li class="mb-1"><i class="fas fa-check-circle text-success"></i> <code class="ms-2">ZohoMail.accounts.READ</code></li>
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <ul class="list-unstyled">
                                                        <li class="mb-1"><i class="fas fa-check-circle text-success"></i> <code class="ms-2">ZohoMail.messages.CREATE</code></li>
                                                        <li class="mb-1"><i class="fas fa-check-circle text-success"></i> <code class="ms-2">ZohoMail.attachments.READ</code></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="fas fa-download text-primary"></i> Schritt 4: Credentials verwenden</h6>
                                        </div>
                                        <div class="card-body">
                                            <ol class="mb-0">
                                                <li>Nach dem Erstellen erhalten Sie <strong>Client ID</strong> und <strong>Client Secret</strong></li>
                                                <li>Kopieren Sie beide Werte in die entsprechenden Felder unten</li>
                                                <li>Wählen Sie Ihre Zoho-Region (meist <span class="badge bg-info">EU</span>)</li>
                                                <li>Klicken Sie <span class="badge bg-primary">"Speichern"</span> und dann <span class="badge bg-success">"Autorisieren"</span></li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">
                                                <i class="fas fa-key"></i> Client ID
                                            </label>
                                            <input type="text" name="client_id" id="zoho_client_id" class="form-control" 
                                                   placeholder="1000.XXXXXXXXXXXXXXXXX">
                                            <div class="form-text">Ihre Zoho OAuth Client ID</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">
                                                <i class="fas fa-lock"></i> Client Secret
                                            </label>
                                            <input type="password" name="client_secret" id="zoho_client_secret" class="form-control" 
                                                   placeholder="Ihr Client Secret">
                                            <div class="form-text">Ihr Zoho OAuth Client Secret</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">
                                                <i class="fas fa-globe"></i> Region
                                            </label>
                                            <select name="region" id="zoho_region" class="form-select">
                                                <option value="EU">EU (Europa)</option>
                                                <option value="US">US (USA)</option>
                                                <option value="IN">IN (Indien)</option>
                                                <option value="AU">AU (Australien)</option>
                                            </select>
                                            <div class="form-text">Ihre Zoho-Region</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">
                                                <i class="fas fa-link"></i> Redirect URI
                                            </label>
                                            <div class="input-group">
                                                <input type="url" name="redirect_uri" id="zoho_redirect_uri" class="form-control" 
                                                       value="{{ request.build_absolute_uri }}mail/auth/callback/" readonly>
                                                <button class="btn btn-outline-secondary" type="button" onclick="copyRedirectUri()" title="URL kopieren">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle text-primary"></i> 
                                                Diese URL in Zoho Console als "Authorized Redirect URI" eintragen
                                                <br>
                                                <small class="text-muted">
                                                    <strong>Hinweis:</strong> Für Production verwenden Sie: <code>https://workloom.de/mail/auth/callback/</code>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3" id="zohoAuthStatus" style="display: none;">
                                    <div class="border border-success rounded p-3 bg-light">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            <div>
                                                <strong class="text-success">Autorisierung erfolgreich!</strong>
                                                <div class="text-muted mt-1">Sie können jetzt die Mail App verwenden.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times"></i> Schließen
                            </button>
                            <button type="button" class="btn btn-primary" onclick="saveZohoSettings()">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                            <button type="button" class="btn btn-success" onclick="authorizeZohoMail()" id="authorizeZohoBtn" disabled>
                                <i class="fas fa-key"></i> Autorisieren
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="disconnectZohoMail()" id="disconnectZohoBtn" disabled>
                                <i class="fas fa-unlink"></i> Trennen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Canva Einstellungen (Collapsible) -->
            <div class="card mb-5 shadow-sm" id="canvaSettingsCard" style="display: none;">
                <div class="card-header">
                    <h5><i class="fab fa-canva"></i> Canva API-Einstellungen</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'accounts:canva_settings' %}">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-key"></i> Client ID
                                    </label>
                                    <input type="text" name="client_id" class="form-control" 
                                           value="{{ canva_settings.client_id }}"
                                           placeholder="Ihre Canva Client ID">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-lock"></i> Client Secret
                                    </label>
                                    <input type="password" name="client_secret" class="form-control" 
                                           value="{{ canva_settings.client_secret }}"
                                           placeholder="Ihr Canva Client Secret">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tags"></i> Brand Template ID (optional)
                                    </label>
                                    <input type="text" name="brand_template_id" class="form-control" 
                                           value="{{ canva_settings.brand_template_id }}"
                                           placeholder="Standard Brand Template">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-folder"></i> Ordner ID (optional)
                                    </label>
                                    <input type="text" name="folder_id" class="form-control" 
                                           value="{{ canva_settings.folder_id }}"
                                           placeholder="Standard Ordner">
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Canva-Einstellungen speichern
                        </button>
                    </form>
                    
                    <!-- Hilfe-Sektion -->
                    <div class="border-top pt-3 mt-3">
                        <h6>
                            <i class="fas fa-question-circle text-info"></i> Einrichtungshilfe
                        </h6>
                        <div class="small text-muted">
                            <ol>
                                <li>Besuchen Sie die <a href="https://www.canva.com/developers/" target="_blank">Canva Developer Console</a></li>
                                <li>Erstellen Sie eine neue App</li>
                                <li>Fügen Sie diese Redirect URI hinzu: <code>{{ request.build_absolute_uri }}accounts/canva-oauth-callback/</code></li>
                                <li>Kopieren Sie Client ID und Secret hierher</li>
                                <li>Klicken Sie auf "Mit Canva verbinden"</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Shopify Einstellungen (Collapsible) -->
            <div class="card mb-5 shadow-sm" id="shopifySettingsCard" style="display: none;">
                <div class="card-header">
                    <h5><i class="fab fa-shopify"></i> Shopify Store-Einstellungen</h5>
                </div>
                <div class="card-body">
                    <!-- Bestehende Stores -->
                    {% if shopify_stores %}
                        <div class="mb-4">
                            <h6>Verbundene Stores</h6>
                            {% for store in shopify_stores %}
                            <div class="card mb-2">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">{{ store.name }}</h6>
                                            <small class="text-muted">{{ store.shop_domain }}</small>
                                        </div>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editShopifyStore({{ store.id }})">
                                                <i class="fas fa-edit"></i> Bearbeiten
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteShopifyStore({{ store.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Neuen Store hinzufügen -->
                    <div class="border-top pt-3">
                        <h6>Neuen Store hinzufügen</h6>
                        <form id="shopifyStoreForm">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-store"></i> Store Name
                                        </label>
                                        <input type="text" name="name" class="form-control" 
                                               placeholder="Mein Shopify Store" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-globe"></i> Shop Domain
                                        </label>
                                        <input type="text" name="shop_domain" class="form-control" 
                                               placeholder="meinstore.myshopify.com" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-key"></i> Access Token
                                        </label>
                                        <input type="password" name="access_token" class="form-control" 
                                               placeholder="shpat_..." required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-link"></i> Custom Domain (optional)
                                        </label>
                                        <input type="text" name="custom_domain" class="form-control" 
                                               placeholder="shop.example.com">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-align-left"></i> Beschreibung (optional)
                                </label>
                                <textarea name="description" class="form-control" rows="2" 
                                          placeholder="Optionale Beschreibung"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus"></i> Store hinzufügen
                            </button>
                        </form>
                    </div>
                    
                    <!-- Hilfe-Sektion -->
                    <div class="border-top pt-3 mt-3">
                        <h6>
                            <i class="fas fa-question-circle text-info"></i> Einrichtungshilfe
                        </h6>
                        <div class="small text-muted">
                            <ol>
                                <li>Loggen Sie sich in Ihr Shopify Admin Panel ein</li>
                                <li>Gehen Sie zu <strong>Apps > App- und Verkaufskanal-Einstellungen</strong></li>
                                <li>Klicken Sie auf <strong>Private App entwickeln</strong></li>
                                <li>Erstellen Sie eine neue private App mit Lese-/Schreibberechtigung für Produkte und Medien</li>
                                <li>Kopieren Sie den Admin API Access Token hierher</li>
                            </ol>
                            
                            <div class="alert alert-warning alert-sm mt-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Wichtig:</strong> Stellen Sie sicher, dass die App Berechtigung für "Products", "Product listings" und "Files" hat.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pricing Information -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Preisinformationen</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>OpenAI</h6>
                            <ul class="list-unstyled small">
                                <li><strong>GPT-4.1:</strong> $5.00 / $15.00 (Input/Output per 1M Tokens)</li>
                                <li><strong>GPT-4o:</strong> $2.50 / $10.00</li>
                                <li><strong>o3:</strong> $60.00 / $240.00 (Reasoning)</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Anthropic</h6>
                            <ul class="list-unstyled small">
                                <li><strong>Claude Opus 4:</strong> $15.00 / $75.00</li>
                                <li><strong>Claude Sonnet 4:</strong> $3.00 / $15.00</li>
                                <li><strong>Claude Haiku 3.5:</strong> $1.00 / $5.00</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Google</h6>
                            <ul class="list-unstyled small">
                                <li><strong>Gemini 2.5 Pro:</strong> $1.25 / $10.00</li>
                                <li><strong>Gemini 2.5 Flash:</strong> $0.075 / $0.30</li>
                                <li><strong>Gemini (Standard):</strong> Kostenlos</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Zoho Mail Functions - Must be declared before HTML elements that reference them
function toggleZohoSettings() {
    // This function is no longer needed as we use Bootstrap modal attributes
    // But keeping it for backwards compatibility
    const modal = new bootstrap.Modal(document.getElementById('zohoSettingsModal'));
    modal.show();
    loadZohoSettings();
}

function loadZohoSettings() {
    fetch('/accounts/api/zoho-settings/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.settings;
                document.getElementById('zoho_client_id').value = settings.client_id || '';
                document.getElementById('zoho_client_secret').value = settings.client_secret || '';
                document.getElementById('zoho_region').value = settings.region || 'EU';
                document.getElementById('zoho_redirect_uri').value = settings.redirect_uri || '';
                
                // Update status
                updateZohoStatus(settings.status, settings.is_configured, settings.access_token);
            }
        })
        .catch(error => {
            console.error('Error loading Zoho settings:', error);
        });
}

function saveZohoSettings() {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('client_id', document.getElementById('zoho_client_id').value);
    formData.append('client_secret', document.getElementById('zoho_client_secret').value);
    formData.append('region', document.getElementById('zoho_region').value);
    formData.append('redirect_uri', document.getElementById('zoho_redirect_uri').value);
    
    fetch('/accounts/api/zoho-settings/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Zoho Mail Einstellungen gespeichert!');
            document.getElementById('authorizeZohoBtn').disabled = false;
            updateZohoStatus('Gespeichert', true, false);
            // Close modal after successful save
            const modal = bootstrap.Modal.getInstance(document.getElementById('zohoSettingsModal'));
            if (modal) {
                modal.hide();
            }
        } else {
            alert(`Fehler: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error saving Zoho settings:', error);
        alert('Fehler beim Speichern der Einstellungen');
    });
}

function authorizeZohoMail() {
    // Redirect to Zoho authorization
    window.location.href = '/mail/auth/authorize/';
}

function disconnectZohoMail() {
    if (confirm('Möchten Sie die Zoho Mail Verbindung wirklich trennen?')) {
        fetch('/accounts/api/zoho-disconnect/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Zoho Mail Verbindung getrennt!');
                updateZohoStatus('Getrennt', false, false);
                document.getElementById('authorizeZohoBtn').disabled = true;
                document.getElementById('disconnectZohoBtn').disabled = true;
                // Close modal after successful disconnect
                const modal = bootstrap.Modal.getInstance(document.getElementById('zohoSettingsModal'));
                if (modal) {
                    modal.hide();
                }
            } else {
                alert(`Fehler: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error disconnecting Zoho:', error);
            alert('Fehler beim Trennen der Verbindung');
        });
    }
}

function testZohoConnection() {
    const indicator = document.getElementById('zoho_status_indicator').querySelector('.status-light');
    const statusText = document.getElementById('zoho_key_status');
    
    // Show loading state
    indicator.className = 'status-light status-yellow pulsing';
    statusText.textContent = 'Teste...';
    
    fetch('/accounts/api/zoho-test/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            indicator.className = 'status-light status-green';
            statusText.textContent = 'Verbindung erfolgreich';
        } else {
            indicator.className = 'status-light status-red';
            statusText.textContent = `Fehler: ${data.error}`;
        }
    })
    .catch(error => {
        console.error('Error testing Zoho connection:', error);
        indicator.className = 'status-light status-red';
        statusText.textContent = 'Test fehlgeschlagen';
    });
}

function deleteAllEmails() {
    // Show confirmation dialog
    const confirmed = confirm(
        'ACHTUNG: Möchten Sie wirklich ALLE Emails aus der Datenbank löschen?\n\n' +
        'Diese Aktion:\n' +
        '• Löscht alle Email-Datensätze aus der lokalen Datenbank\n' +
        '• Löscht NICHT die Emails auf dem Zoho Mail Server\n' +
        '• Kann NICHT rückgängig gemacht werden\n\n' +
        'Klicken Sie OK um fortzufahren, oder Abbrechen um abzubrechen.'
    );
    
    if (!confirmed) {
        return;
    }
    
    // Second confirmation for safety
    const doubleConfirmed = confirm(
        'LETZTE WARNUNG!\n\n' +
        'Sie sind dabei, alle Email-Datensätze aus der Datenbank zu löschen.\n' +
        'Diese Aktion kann nicht rückgängig gemacht werden.\n\n' +
        'Sind Sie absolut sicher?'
    );
    
    if (!doubleConfirmed) {
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Lösche...';
    button.disabled = true;
    
    fetch('/accounts/api/zoho-delete-all-emails/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Erfolgreich! ${data.deleted_count} Emails wurden aus der Datenbank gelöscht.`);
        } else {
            alert(`Fehler beim Löschen der Emails: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error deleting emails:', error);
        alert('Fehler beim Löschen der Emails');
    })
    .finally(() => {
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function updateZohoStatus(status, isConfigured, hasAccessToken) {
    const indicator = document.getElementById('zoho_status_indicator').querySelector('.status-light');
    const statusText = document.getElementById('zoho_key_status');
    
    if (hasAccessToken) {
        indicator.className = 'status-light status-green';
        statusText.textContent = 'Autorisiert';
        document.getElementById('authorizeZohoBtn').disabled = true;
        document.getElementById('disconnectZohoBtn').disabled = false;
    } else if (isConfigured) {
        indicator.className = 'status-light status-yellow';
        statusText.textContent = 'Konfiguriert (nicht autorisiert)';
        document.getElementById('authorizeZohoBtn').disabled = false;
        document.getElementById('disconnectZohoBtn').disabled = true;
    } else {
        indicator.className = 'status-light status-gray';
        statusText.textContent = 'Nicht konfiguriert';
        document.getElementById('authorizeZohoBtn').disabled = true;
        document.getElementById('disconnectZohoBtn').disabled = true;
    }
}

function copyRedirectUri() {
    const redirectUriInput = document.getElementById('zoho_redirect_uri');
    
    // Select and copy the text
    redirectUriInput.select();
    redirectUriInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        
        // Temporary feedback
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check text-success"></i>';
        button.classList.add('btn-success');
        button.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            button.innerHTML = originalContent;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
        
    } catch (err) {
        console.error('Copy failed:', err);
        alert('Kopieren fehlgeschlagen. Bitte manuell kopieren.');
    }
    
    // Remove selection
    redirectUriInput.blur();
}

document.addEventListener('DOMContentLoaded', function() {
    // Lade initiale Daten
    loadCurrentBalances();
    loadUsageStatistics();
    
    // Balance Update Buttons
    document.querySelectorAll('.update-balance-btn').forEach(button => {
        button.addEventListener('click', function() {
            const provider = this.dataset.provider;
            updateBalance(provider);
        });
    });
    
    // Password Toggle Buttons
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const targetInput = document.getElementById(targetId);
            const icon = this.querySelector('i');
            
            if (targetInput.type === 'password') {
                targetInput.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                targetInput.type = 'password';
                icon.className = 'fas fa-eye';
            }
        });
    });
    
    // Remove API Key Buttons
    document.querySelectorAll('.remove-key-btn').forEach(button => {
        button.addEventListener('click', function() {
            const provider = this.dataset.provider;
            removeApiKey(provider);
        });
    });
    
    // Refresh Stats Button
    document.getElementById('refreshStatsBtn').addEventListener('click', loadUsageStatistics);
    
    // Test API Key Buttons
    document.querySelectorAll('.test-api-key-btn').forEach(button => {
        button.addEventListener('click', function() {
            const provider = this.dataset.provider;
            testApiKey(provider);
        });
    });
    
    // Zoho Modal Event Listener
    const zohoModal = document.getElementById('zohoSettingsModal');
    if (zohoModal) {
        zohoModal.addEventListener('show.bs.modal', function() {
            loadZohoSettings();
        });
    }
    
    function loadCurrentBalances() {
        console.log('Lade API-Kontostände...');
        fetch('/accounts/api/balances/')
            .then(response => {
                console.log('Balance API Response Status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Balance API Response Data:', data);
                if (data.success) {
                    // Fülle die Formularfelder mit aktuellen Werten
                    for (const [provider, balance] of Object.entries(data.balances)) {
                        console.log(`Verarbeite Provider: ${provider}`, balance);
                        const balanceInput = document.getElementById(`${provider}_balance`);
                        const thresholdInput = document.getElementById(`${provider}_threshold`);
                        const keyStatusSpan = document.getElementById(`${provider}_key_status`);
                        
                        // YouTube verwendet Quota statt Balance
                        if (provider === 'youtube') {
                            const quotaInput = document.getElementById(`${provider}_quota_limit`);
                            if (quotaInput && balance.currency === 'QUOTA') {
                                quotaInput.value = balance.balance.toFixed(0);
                            }
                        } else {
                            if (balanceInput) balanceInput.value = balance.balance.toFixed(2);
                            if (thresholdInput) thresholdInput.value = balance.threshold.toFixed(2);
                        }
                        
                        if (keyStatusSpan) {
                            keyStatusSpan.textContent = balance.masked_api_key;
                            // Update status indicator based on API key presence
                            const hasKey = balance.masked_api_key !== 'Nicht konfiguriert';
                            console.log(`Provider ${provider}: hasKey = ${hasKey}, masked_key = "${balance.masked_api_key}"`);
                            updateStatusIndicator(provider, hasKey ? 'has_key' : 'no_key');
                        }
                    }
                } else {
                    console.error('Balance API Error:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading balances:', error);
                // Set all providers to error state
                ['openai', 'anthropic', 'google', 'youtube'].forEach(provider => {
                    updateStatusIndicator(provider, 'error');
                });
            });
    }
    
    function testApiKey(provider) {
        const apiKeyInput = document.getElementById(`${provider}_api_key`);
        const button = document.querySelector(`[data-provider="${provider}"].test-api-key-btn`);
        const statusSpan = document.getElementById(`${provider}_key_status`);
        
        const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
        
        if (!apiKey) {
            alert('Bitte geben Sie zuerst einen API-Schlüssel ein.');
            return;
        }
        
        // Button-Status ändern
        const originalIcon = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        // Status-Indikator auf "Testing" setzen
        updateStatusIndicator(provider, 'testing');
        if (statusSpan) statusSpan.textContent = 'Wird getestet...';
        
        const formData = new FormData();
        formData.append('provider', provider);
        formData.append('api_key', apiKey);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        fetch('/accounts/api/validate-key/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            button.innerHTML = originalIcon;
            button.disabled = false;
            
            if (data.success) {
                if (data.is_valid) {
                    updateStatusIndicator(provider, 'valid');
                    if (statusSpan) statusSpan.textContent = 'API-Schlüssel gültig';
                    showApiMessage(`API-Schlüssel für ${getProviderDisplayName(provider)} ist gültig!`, 'success');
                } else {
                    updateStatusIndicator(provider, 'invalid');
                    if (statusSpan) statusSpan.textContent = 'API-Schlüssel ungültig';
                    showApiMessage(`API-Schlüssel für ${getProviderDisplayName(provider)} ist ungültig: ${data.error_message}`, 'error');
                }
            } else {
                updateStatusIndicator(provider, 'error');
                if (statusSpan) statusSpan.textContent = 'Testfehler';
                showApiMessage(`Fehler beim Testen: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            button.innerHTML = originalIcon;
            button.disabled = false;
            updateStatusIndicator(provider, 'error');
            if (statusSpan) statusSpan.textContent = 'Verbindungsfehler';
            showApiMessage('Netzwerkfehler beim Testen des API-Schlüssels', 'error');
            console.error('Error testing API key:', error);
        });
    }
    
    function updateStatusIndicator(provider, status) {
        console.log(`updateStatusIndicator: Provider=${provider}, Status=${status}`);
        const indicator = document.getElementById(`${provider}_status_indicator`);
        if (!indicator) {
            console.error(`Status indicator not found for provider: ${provider}`);
            return;
        }
        
        const light = indicator.querySelector('.status-light');
        if (!light) {
            console.error(`Status light not found for provider: ${provider}`);
            return;
        }
        
        // Remove all status classes
        light.classList.remove('status-red', 'status-green', 'status-yellow', 'status-gray', 'pulsing');
        
        switch (status) {
            case 'valid':
                light.classList.add('status-green');
                light.title = 'API-Schlüssel gültig';
                console.log(`${provider}: Set to GREEN (valid)`);
                break;
            case 'invalid':
                light.classList.add('status-red');
                light.title = 'API-Schlüssel ungültig';
                console.log(`${provider}: Set to RED (invalid)`);
                break;
            case 'testing':
                light.classList.add('status-yellow', 'pulsing');
                light.title = 'Wird getestet...';
                console.log(`${provider}: Set to YELLOW (testing)`);
                break;
            case 'error':
                light.classList.add('status-red', 'pulsing');
                light.title = 'Testfehler';
                console.log(`${provider}: Set to RED (error)`);
                break;
            case 'has_key':
                light.classList.add('status-gray');
                light.title = 'API-Schlüssel konfiguriert (nicht getestet)';
                console.log(`${provider}: Set to GRAY (has_key)`);
                break;
            case 'no_key':
            default:
                light.classList.add('status-gray');
                light.title = 'Kein API-Schlüssel konfiguriert';
                console.log(`${provider}: Set to GRAY (no_key/default)`);
                break;
        }
    }
    
    function getProviderDisplayName(provider) {
        const names = {
            'openai': 'OpenAI',
            'anthropic': 'Anthropic (Claude)',
            'google': 'Google (Gemini)',
            'youtube': 'YouTube Data API'
        };
        return names[provider] || provider;
    }
    
    function showApiMessage(message, type) {
        // Create a temporary alert
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alert = document.createElement('div');
        alert.className = `alert ${alertClass} alert-dismissible fade show mt-2`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert after the breadcrumb
        const breadcrumb = document.querySelector('.breadcrumb').parentElement;
        breadcrumb.parentNode.insertBefore(alert, breadcrumb.nextSibling);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
    
    function updateBalance(provider) {
        const balanceInput = document.getElementById(`${provider}_balance`);
        const thresholdInput = document.getElementById(`${provider}_threshold`);
        const apiKeyInput = document.getElementById(`${provider}_api_key`);
        const button = document.querySelector(`[data-provider="${provider}"]`);
        
        const balance = balanceInput ? balanceInput.value : null;
        const threshold = thresholdInput ? thresholdInput.value : null;
        const apiKey = apiKeyInput ? apiKeyInput.value : '';
        
        // YouTube-spezifische Felder
        let quotaLimit = null;
        if (provider === 'youtube') {
            const quotaInput = document.getElementById(`${provider}_quota_limit`);
            quotaLimit = quotaInput ? quotaInput.value : null;
            
            // Für YouTube: API-Key oder Quota-Limit erforderlich
            if (!apiKey && (!quotaLimit || isNaN(quotaLimit))) {
                alert('Bitte geben Sie einen gültigen API-Key oder ein Quota-Limit ein.');
                return;
            }
        } else {
            // Für andere Provider: Balance erforderlich
            if (!balance || isNaN(balance)) {
                alert('Bitte geben Sie einen gültigen Kontostand ein.');
                return;
            }
        }
        
        // Button-Status ändern
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Speichern...';
        button.disabled = true;
        
        const formData = new FormData();
        formData.append('provider', provider);
        formData.append('api_key', apiKey);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        // YouTube-spezifische Daten
        if (provider === 'youtube') {
            if (quotaLimit) {
                formData.append('quota_limit', quotaLimit);
            }
            // Für YouTube: Quota als Balance verwenden, falls gesetzt
            formData.append('balance', quotaLimit || '10000');
            formData.append('threshold', '1000');
            formData.append('currency', 'QUOTA');
        } else {
            // Für andere Provider: Standard-Daten
            formData.append('balance', balance);
            formData.append('threshold', threshold);
            formData.append('currency', 'USD');
        }
        
        fetch('/accounts/api/balances/update/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Erfolgs-Feedback
                button.innerHTML = '<i class="fas fa-check"></i> Gespeichert';
                button.classList.remove('btn-primary');
                button.classList.add('btn-success');
                
                // API-Key Status aktualisieren
                const keyStatusSpan = document.getElementById(`${provider}_key_status`);
                if (keyStatusSpan && data.masked_api_key) {
                    keyStatusSpan.textContent = data.masked_api_key;
                }
                
                // API-Key Eingabefeld leeren (aus Sicherheitsgründen)
                if (apiKeyInput) {
                    apiKeyInput.value = '';
                }
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-primary');
                    button.disabled = false;
                }, 2000);
            } else {
                alert('Fehler beim Speichern: ' + data.error);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error updating balance:', error);
            alert('Netzwerkfehler beim Speichern');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
    
    function removeApiKey(provider) {
        const providerNames = {
            'openai': 'OpenAI',
            'anthropic': 'Anthropic (Claude)',
            'google': 'Google (Gemini)',
            'youtube': 'YouTube Data API'
        };
        
        if (!confirm(`Möchten Sie den API-Key für ${providerNames[provider]} wirklich entfernen?`)) {
            return;
        }
        
        const formData = new FormData();
        formData.append('provider', provider);
        formData.append('action', 'remove_key');
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        fetch('/accounts/api/balances/remove-key/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Aktualisiere Status-Anzeige
                const keyStatusSpan = document.getElementById(`${provider}_key_status`);
                if (keyStatusSpan) {
                    keyStatusSpan.textContent = 'Nicht konfiguriert';
                }
                
                // Zeige Erfolgs-Message
                alert(`API-Key für ${providerNames[provider]} wurde erfolgreich entfernt.`);
            } else {
                alert('Fehler beim Entfernen des API-Keys: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error removing API key:', error);
            alert('Netzwerkfehler beim Entfernen des API-Keys');
        });
    }
    
    function loadUsageStatistics() {
        const statsContent = document.getElementById('usageStatsContent');
        statsContent.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Laden...</span>
                </div>
                <p class="text-muted">Statistiken werden geladen...</p>
            </div>
        `;
        
        fetch('/accounts/api/usage/stats/')
            .then(response => {
                console.log('Usage stats response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Usage stats data:', data);
                if (data.success) {
                    displayUsageStatistics(data);
                } else {
                    statsContent.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Statistiken: ' + (data.error || 'Unbekannter Fehler') + '</div>';
                }
            })
            .catch(error => {
                console.error('Error loading statistics:', error);
                statsContent.innerHTML = '<div class="alert alert-danger">Netzwerkfehler: ' + error.message + '</div>';
            });
    }
    
    function displayUsageStatistics(data) {
        const statsContent = document.getElementById('usageStatsContent');
        
        let html = `
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="alert alert-info">
                        <h6>Gesamtkosten (${data.period}): <strong>$${data.total_cost.toFixed(4)}</strong></h6>
                    </div>
                </div>
            </div>
            <div class="row">
        `;
        
        for (const [provider, stats] of Object.entries(data.stats)) {
            const percentage = data.total_cost > 0 ? (stats.total_cost / data.total_cost * 100) : 0;
            
            html += `
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6>${stats.name}</h6>
                            <p class="mb-1"><strong>Kosten:</strong> $${stats.total_cost.toFixed(4)} (${percentage.toFixed(1)}%)</p>
                            <p class="mb-1"><strong>Anfragen:</strong> ${stats.request_count}</p>
                            <p class="mb-1"><strong>Tokens:</strong> ${stats.total_tokens.toLocaleString()}</p>
                            <p class="mb-0"><small class="text-muted">
                                Zuletzt: ${stats.last_used ? new Date(stats.last_used).toLocaleDateString('de-DE') : 'Nie'}
                            </small></p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        statsContent.innerHTML = html;
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

// Toggle Canva Settings visibility
function toggleCanvaSettings() {
    const settingsCard = document.getElementById('canvaSettingsCard');
    if (settingsCard.style.display === 'none') {
        settingsCard.style.display = 'block';
        settingsCard.scrollIntoView({ behavior: 'smooth' });
    } else {
        settingsCard.style.display = 'none';
    }
}

// Toggle Shopify Settings visibility
function toggleShopifySettings() {
    const settingsCard = document.getElementById('shopifySettingsCard');
    if (settingsCard.style.display === 'none') {
        settingsCard.style.display = 'block';
        settingsCard.scrollIntoView({ behavior: 'smooth' });
    } else {
        settingsCard.style.display = 'none';
    }
}

// Shopify Functions
function shopifyImportImages() {
    const storeSelect = document.getElementById('shopifyStoreSelect');
    if (!storeSelect || !storeSelect.value) {
        alert('Bitte wählen Sie einen Store aus.');
        return;
    }
    
    // Öffne Image Editor mit Shopify Import
    const url = `/images/shopify-import/?store_id=${storeSelect.value}`;
    window.open(url, '_blank');
}

function shopifyExportImages() {
    alert('Export-Funktion wird im Bildeditor verfügbar sein.');
}

function testShopifyConnection() {
    const storeSelect = document.getElementById('shopifyStoreSelect');
    if (!storeSelect || !storeSelect.value) {
        alert('Bitte wählen Sie einen Store aus.');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Teste...';
    button.disabled = true;
    
    fetch(`/accounts/api/test-shopify-connection/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            store_id: storeSelect.value
        })
    })
    .then(response => response.json())
    .then(data => {
        button.innerHTML = originalText;
        button.disabled = false;
        
        if (data.success) {
            alert(`Verbindung erfolgreich: ${data.message}`);
        } else {
            alert(`Verbindung fehlgeschlagen: ${data.error}`);
        }
    })
    .catch(error => {
        button.innerHTML = originalText;
        button.disabled = false;
        alert('Netzwerkfehler beim Testen der Verbindung');
        console.error('Error:', error);
    });
}

function editShopifyStore(storeId) {
    // Weiterleitung zum Shopify Manager
    window.open(`/shopify/stores/${storeId}/edit/`, '_blank');
}

function deleteShopifyStore(storeId) {
    if (confirm('Möchten Sie diesen Store wirklich entfernen?')) {
        fetch(`/accounts/api/delete-shopify-store/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                store_id: storeId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(`Fehler beim Löschen: ${data.error}`);
            }
        })
        .catch(error => {
            alert('Netzwerkfehler beim Löschen des Stores');
            console.error('Error:', error);
        });
    }
}

// Shopify Store Form Handler
document.addEventListener('DOMContentLoaded', function() {
    const shopifyForm = document.getElementById('shopifyStoreForm');
    if (shopifyForm) {
        shopifyForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(shopifyForm);
            const submitButton = shopifyForm.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Speichern...';
            submitButton.disabled = true;
            
            fetch('/accounts/api/add-shopify-store/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                
                if (data.success) {
                    alert('Store erfolgreich hinzugefügt!');
                    location.reload();
                } else {
                    alert(`Fehler: ${data.error}`);
                }
            })
            .catch(error => {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                alert('Netzwerkfehler beim Hinzufügen des Stores');
                console.error('Error:', error);
            });
        });
    }
    
    function openMailDashboard() {
        window.open('/mail/', '_blank');
    }
});
</script>

{% endblock %}