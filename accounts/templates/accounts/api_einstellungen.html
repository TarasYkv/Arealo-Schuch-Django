{% extends 'base.html' %}

{% block title %}API-Einstellungen - Naturmacher{% endblock %}

{% block content %}

<style>
.api-status-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.status-light {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
}

.status-light.status-red {
    background: linear-gradient(135deg, #ff4757, #ff3838);
    box-shadow: 0 0 8px rgba(255, 71, 87, 0.4);
}

.status-light.status-green {
    background: linear-gradient(135deg, #2ed573, #1dd1a1);
    box-shadow: 0 0 8px rgba(46, 213, 115, 0.4);
}

.status-light.status-yellow {
    background: linear-gradient(135deg, #ffa502, #ff6348);
    box-shadow: 0 0 8px rgba(255, 165, 2, 0.4);
}

.status-light.status-gray {
    background: linear-gradient(135deg, #747d8c, #57606f);
    box-shadow: 0 0 8px rgba(116, 125, 140, 0.3);
}

.status-light.pulsing {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.7;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

.test-api-key-btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.test-api-key-btn:disabled {
    opacity: 0.6;
}

/* API Key Input Styling */
.api-key-input {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    word-break: break-all;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* API Key Status Container */
.api-key-status-container {
    min-height: 20px;
    max-width: 100%;
    overflow: hidden;
}

.api-key-status-text {
    font-family: 'Courier New', monospace;
    font-size: 0.75rem;
    word-break: break-all;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 150px;
    display: inline-block;
}

/* Responsive API Card Layout */
.api-provider-card {
    min-height: 320px;
}

.api-provider-card .card-body {
    display: flex;
    flex-direction: column;
}

.api-provider-card .btn-group {
    margin-top: auto;
}

/* Input Group Fixes for Long Content */
.input-group .form-control {
    min-width: 0;
    flex: 1;
}

.status-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.status-row .api-status-indicator {
    flex-shrink: 0;
}

.status-row .test-api-key-btn {
    flex-shrink: 0;
    margin-left: auto;
}

.status-row .api-key-status-text-wrapper {
    flex: 1;
    min-width: 0;
    overflow: hidden;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .api-key-status-text {
        max-width: 120px;
        font-size: 0.7rem;
    }
    
    .status-row {
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .status-row .test-api-key-btn {
        margin-left: 0;
        margin-top: 0.25rem;
    }
    
    .api-provider-card {
        min-height: 280px;
    }
}

@media (max-width: 576px) {
    .api-key-input {
        font-size: 0.75rem;
    }
    
    .api-key-status-text {
        max-width: 100px;
        font-size: 0.65rem;
    }
}
</style>
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'naturmacher:thema_list' %}">Alle Themen</a></li>
                    <li class="breadcrumb-item active" aria-current="page">API-Einstellungen</li>
                </ol>
            </nav>
            
            <h1><i class="fas fa-cog"></i> API-Einstellungen</h1>
            <p class="lead">Verwalten Sie Ihre API-Kontostände und überwachen Sie die Nutzungskosten.</p>
            
            <!-- Balance Management -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-wallet"></i> Kontostände verwalten</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Hinweis:</strong> Geben Sie Ihre aktuellen Kontostände manuell ein. 
                        Diese werden automatisch bei jeder API-Nutzung aktualisiert.
                    </div>
                    
                    <form id="balanceForm">
                        <div class="row">
                            <!-- OpenAI -->
                            <div class="col-md-4 mb-3">
                                <div class="card api-provider-card">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">OpenAI (ChatGPT)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <label for="openai_api_key" class="form-label">API-Schlüssel:</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control api-key-input" id="openai_api_key" 
                                                       placeholder="sk-proj-...">
                                                <button type="button" class="btn btn-outline-secondary toggle-password" 
                                                        data-target="openai_api_key">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="status-row mt-1 api-key-status-container">
                                                <div class="api-status-indicator" id="openai_status_indicator">
                                                    <div class="status-light status-gray" title="Nicht getestet"></div>
                                                </div>
                                                <div class="api-key-status-text-wrapper">
                                                    <small class="text-muted">
                                                        Status: <span id="openai_key_status" class="api-key-status-text">Nicht konfiguriert</span>
                                                    </small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary test-api-key-btn" 
                                                        data-provider="openai" title="API-Schlüssel testen">
                                                    <i class="fas fa-vial"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="openai_balance" class="form-label">Kontostand:</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="openai_balance" 
                                                       step="0.01" min="0" placeholder="0.00">
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="openai_threshold" class="form-label">Warnschwelle:</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="openai_threshold" 
                                                       step="0.01" min="0" placeholder="5.00" value="5.00">
                                            </div>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-primary update-balance-btn" 
                                                    data-provider="openai">
                                                <i class="fas fa-save"></i> Speichern
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger remove-key-btn" 
                                                    data-provider="openai" title="API-Key entfernen">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <a href="https://platform.openai.com/settings/organization/billing/overview" 
                                           target="_blank" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-external-link-alt"></i> Dashboard
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Anthropic -->
                            <div class="col-md-4 mb-3">
                                <div class="card api-provider-card">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">Anthropic (Claude)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <label for="anthropic_api_key" class="form-label">API-Schlüssel:</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control api-key-input" id="anthropic_api_key" 
                                                       placeholder="sk-ant-api03-...">
                                                <button type="button" class="btn btn-outline-secondary toggle-password" 
                                                        data-target="anthropic_api_key">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="status-row mt-1 api-key-status-container">
                                                <div class="api-status-indicator" id="anthropic_status_indicator">
                                                    <div class="status-light status-gray" title="Nicht getestet"></div>
                                                </div>
                                                <div class="api-key-status-text-wrapper">
                                                    <small class="text-muted">
                                                        Status: <span id="anthropic_key_status" class="api-key-status-text">Nicht konfiguriert</span>
                                                    </small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary test-api-key-btn" 
                                                        data-provider="anthropic" title="API-Schlüssel testen">
                                                    <i class="fas fa-vial"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="anthropic_balance" class="form-label">Kontostand:</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="anthropic_balance" 
                                                       step="0.01" min="0" placeholder="0.00">
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="anthropic_threshold" class="form-label">Warnschwelle:</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="anthropic_threshold" 
                                                       step="0.01" min="0" placeholder="5.00" value="5.00">
                                            </div>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-primary update-balance-btn" 
                                                    data-provider="anthropic">
                                                <i class="fas fa-save"></i> Speichern
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger remove-key-btn" 
                                                    data-provider="anthropic" title="API-Key entfernen">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <a href="https://console.anthropic.com/settings/billing" 
                                           target="_blank" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-external-link-alt"></i> Dashboard
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Google -->
                            <div class="col-md-4 mb-3">
                                <div class="card api-provider-card">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">Google (Gemini)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <label for="google_api_key" class="form-label">API-Schlüssel:</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control api-key-input" id="google_api_key" 
                                                       placeholder="AIzaSy...">
                                                <button type="button" class="btn btn-outline-secondary toggle-password" 
                                                        data-target="google_api_key">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="status-row mt-1 api-key-status-container">
                                                <div class="api-status-indicator" id="google_status_indicator">
                                                    <div class="status-light status-gray" title="Nicht getestet"></div>
                                                </div>
                                                <div class="api-key-status-text-wrapper">
                                                    <small class="text-muted">
                                                        Status: <span id="google_key_status" class="api-key-status-text">Nicht konfiguriert</span>
                                                    </small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary test-api-key-btn" 
                                                        data-provider="google" title="API-Schlüssel testen">
                                                    <i class="fas fa-vial"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="google_balance" class="form-label">Kontostand:</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="google_balance" 
                                                       step="0.01" min="0" placeholder="0.00">
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="google_threshold" class="form-label">Warnschwelle:</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="google_threshold" 
                                                       step="0.01" min="0" placeholder="5.00" value="5.00">
                                            </div>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-primary update-balance-btn" 
                                                    data-provider="google">
                                                <i class="fas fa-save"></i> Speichern
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger remove-key-btn" 
                                                    data-provider="google" title="API-Key entfernen">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <a href="https://console.cloud.google.com/billing" 
                                           target="_blank" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-external-link-alt"></i> Dashboard
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- YouTube API -->
                            <div class="col-md-6 col-lg-3 mb-3">
                                <div class="card api-provider-card">
                                    <div class="card-header bg-danger text-white">
                                        <h6 class="mb-0">YouTube Data API</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <label for="youtube_api_key" class="form-label">API-Schlüssel:</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control api-key-input" id="youtube_api_key" 
                                                       name="youtube_api_key" placeholder="AIzaSy...">
                                                <button type="button" class="btn btn-outline-secondary toggle-password" 
                                                        data-target="youtube_api_key">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="status-row mt-1 api-key-status-container">
                                                <div class="api-status-indicator" id="youtube_status_indicator">
                                                    <div class="status-light status-gray" title="Nicht getestet"></div>
                                                </div>
                                                <div class="api-key-status-text-wrapper">
                                                    <small class="text-muted">
                                                        Status: <span id="youtube_key_status" class="api-key-status-text">Nicht konfiguriert</span>
                                                    </small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary test-api-key-btn" 
                                                        data-provider="youtube" title="API-Schlüssel testen">
                                                    <i class="fas fa-vial"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="youtube_quota_limit" class="form-label">Tägliches Quota-Limit:</label>
                                            <input type="number" class="form-control" id="youtube_quota_limit" 
                                                   name="youtube_quota_limit" placeholder="10000" step="1000">
                                            <small class="text-muted">Standard: 10.000 Einheiten/Tag</small>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-primary update-balance-btn" 
                                                    data-provider="youtube">
                                                <i class="fas fa-save"></i> Speichern
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger remove-key-btn" 
                                                    data-provider="youtube" title="API-Key entfernen">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <a href="https://console.cloud.google.com/apis/credentials" 
                                           target="_blank" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-external-link-alt"></i> Console
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Usage Statistics -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-chart-bar"></i> Nutzungsstatistiken (30 Tage)</h5>
                    <button class="btn btn-sm btn-outline-primary" id="refreshStatsBtn">
                        <i class="fas fa-sync-alt"></i> Aktualisieren
                    </button>
                </div>
                <div class="card-body" id="usageStatsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Laden...</span>
                        </div>
                        <p class="text-muted">Statistiken werden geladen...</p>
                    </div>
                </div>
            </div>
            
            <!-- Pricing Information -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Preisinformationen</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>OpenAI</h6>
                            <ul class="list-unstyled small">
                                <li><strong>GPT-4.1:</strong> $5.00 / $15.00 (Input/Output per 1M Tokens)</li>
                                <li><strong>GPT-4o:</strong> $2.50 / $10.00</li>
                                <li><strong>o3:</strong> $60.00 / $240.00 (Reasoning)</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Anthropic</h6>
                            <ul class="list-unstyled small">
                                <li><strong>Claude Opus 4:</strong> $15.00 / $75.00</li>
                                <li><strong>Claude Sonnet 4:</strong> $3.00 / $15.00</li>
                                <li><strong>Claude Haiku 3.5:</strong> $1.00 / $5.00</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Google</h6>
                            <ul class="list-unstyled small">
                                <li><strong>Gemini 2.5 Pro:</strong> $1.25 / $10.00</li>
                                <li><strong>Gemini 2.5 Flash:</strong> $0.075 / $0.30</li>
                                <li><strong>Gemini (Standard):</strong> Kostenlos</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lade initiale Daten
    loadCurrentBalances();
    loadUsageStatistics();
    
    // Balance Update Buttons
    document.querySelectorAll('.update-balance-btn').forEach(button => {
        button.addEventListener('click', function() {
            const provider = this.dataset.provider;
            updateBalance(provider);
        });
    });
    
    // Password Toggle Buttons
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const targetInput = document.getElementById(targetId);
            const icon = this.querySelector('i');
            
            if (targetInput.type === 'password') {
                targetInput.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                targetInput.type = 'password';
                icon.className = 'fas fa-eye';
            }
        });
    });
    
    // Remove API Key Buttons
    document.querySelectorAll('.remove-key-btn').forEach(button => {
        button.addEventListener('click', function() {
            const provider = this.dataset.provider;
            removeApiKey(provider);
        });
    });
    
    // Refresh Stats Button
    document.getElementById('refreshStatsBtn').addEventListener('click', loadUsageStatistics);
    
    // Test API Key Buttons
    document.querySelectorAll('.test-api-key-btn').forEach(button => {
        button.addEventListener('click', function() {
            const provider = this.dataset.provider;
            testApiKey(provider);
        });
    });
    
    function loadCurrentBalances() {
        console.log('Lade API-Kontostände...');
        fetch('/accounts/api/balances/')
            .then(response => {
                console.log('Balance API Response Status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Balance API Response Data:', data);
                if (data.success) {
                    // Fülle die Formularfelder mit aktuellen Werten
                    for (const [provider, balance] of Object.entries(data.balances)) {
                        console.log(`Verarbeite Provider: ${provider}`, balance);
                        const balanceInput = document.getElementById(`${provider}_balance`);
                        const thresholdInput = document.getElementById(`${provider}_threshold`);
                        const keyStatusSpan = document.getElementById(`${provider}_key_status`);
                        
                        // YouTube verwendet Quota statt Balance
                        if (provider === 'youtube') {
                            const quotaInput = document.getElementById(`${provider}_quota_limit`);
                            if (quotaInput && balance.currency === 'QUOTA') {
                                quotaInput.value = balance.balance.toFixed(0);
                            }
                        } else {
                            if (balanceInput) balanceInput.value = balance.balance.toFixed(2);
                            if (thresholdInput) thresholdInput.value = balance.threshold.toFixed(2);
                        }
                        
                        if (keyStatusSpan) {
                            keyStatusSpan.textContent = balance.masked_api_key;
                            // Update status indicator based on API key presence
                            const hasKey = balance.masked_api_key !== 'Nicht konfiguriert';
                            console.log(`Provider ${provider}: hasKey = ${hasKey}, masked_key = "${balance.masked_api_key}"`);
                            updateStatusIndicator(provider, hasKey ? 'has_key' : 'no_key');
                        }
                    }
                } else {
                    console.error('Balance API Error:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading balances:', error);
                // Set all providers to error state
                ['openai', 'anthropic', 'google', 'youtube'].forEach(provider => {
                    updateStatusIndicator(provider, 'error');
                });
            });
    }
    
    function testApiKey(provider) {
        const apiKeyInput = document.getElementById(`${provider}_api_key`);
        const button = document.querySelector(`[data-provider="${provider}"].test-api-key-btn`);
        const statusSpan = document.getElementById(`${provider}_key_status`);
        
        const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
        
        if (!apiKey) {
            alert('Bitte geben Sie zuerst einen API-Schlüssel ein.');
            return;
        }
        
        // Button-Status ändern
        const originalIcon = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        // Status-Indikator auf "Testing" setzen
        updateStatusIndicator(provider, 'testing');
        if (statusSpan) statusSpan.textContent = 'Wird getestet...';
        
        const formData = new FormData();
        formData.append('provider', provider);
        formData.append('api_key', apiKey);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        fetch('/accounts/api/validate-key/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            button.innerHTML = originalIcon;
            button.disabled = false;
            
            if (data.success) {
                if (data.is_valid) {
                    updateStatusIndicator(provider, 'valid');
                    if (statusSpan) statusSpan.textContent = 'API-Schlüssel gültig';
                    showApiMessage(`API-Schlüssel für ${getProviderDisplayName(provider)} ist gültig!`, 'success');
                } else {
                    updateStatusIndicator(provider, 'invalid');
                    if (statusSpan) statusSpan.textContent = 'API-Schlüssel ungültig';
                    showApiMessage(`API-Schlüssel für ${getProviderDisplayName(provider)} ist ungültig: ${data.error_message}`, 'error');
                }
            } else {
                updateStatusIndicator(provider, 'error');
                if (statusSpan) statusSpan.textContent = 'Testfehler';
                showApiMessage(`Fehler beim Testen: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            button.innerHTML = originalIcon;
            button.disabled = false;
            updateStatusIndicator(provider, 'error');
            if (statusSpan) statusSpan.textContent = 'Verbindungsfehler';
            showApiMessage('Netzwerkfehler beim Testen des API-Schlüssels', 'error');
            console.error('Error testing API key:', error);
        });
    }
    
    function updateStatusIndicator(provider, status) {
        console.log(`updateStatusIndicator: Provider=${provider}, Status=${status}`);
        const indicator = document.getElementById(`${provider}_status_indicator`);
        if (!indicator) {
            console.error(`Status indicator not found for provider: ${provider}`);
            return;
        }
        
        const light = indicator.querySelector('.status-light');
        if (!light) {
            console.error(`Status light not found for provider: ${provider}`);
            return;
        }
        
        // Remove all status classes
        light.classList.remove('status-red', 'status-green', 'status-yellow', 'status-gray', 'pulsing');
        
        switch (status) {
            case 'valid':
                light.classList.add('status-green');
                light.title = 'API-Schlüssel gültig';
                console.log(`${provider}: Set to GREEN (valid)`);
                break;
            case 'invalid':
                light.classList.add('status-red');
                light.title = 'API-Schlüssel ungültig';
                console.log(`${provider}: Set to RED (invalid)`);
                break;
            case 'testing':
                light.classList.add('status-yellow', 'pulsing');
                light.title = 'Wird getestet...';
                console.log(`${provider}: Set to YELLOW (testing)`);
                break;
            case 'error':
                light.classList.add('status-red', 'pulsing');
                light.title = 'Testfehler';
                console.log(`${provider}: Set to RED (error)`);
                break;
            case 'has_key':
                light.classList.add('status-gray');
                light.title = 'API-Schlüssel konfiguriert (nicht getestet)';
                console.log(`${provider}: Set to GRAY (has_key)`);
                break;
            case 'no_key':
            default:
                light.classList.add('status-gray');
                light.title = 'Kein API-Schlüssel konfiguriert';
                console.log(`${provider}: Set to GRAY (no_key/default)`);
                break;
        }
    }
    
    function getProviderDisplayName(provider) {
        const names = {
            'openai': 'OpenAI',
            'anthropic': 'Anthropic (Claude)',
            'google': 'Google (Gemini)',
            'youtube': 'YouTube Data API'
        };
        return names[provider] || provider;
    }
    
    function showApiMessage(message, type) {
        // Create a temporary alert
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alert = document.createElement('div');
        alert.className = `alert ${alertClass} alert-dismissible fade show mt-2`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert after the breadcrumb
        const breadcrumb = document.querySelector('.breadcrumb').parentElement;
        breadcrumb.parentNode.insertBefore(alert, breadcrumb.nextSibling);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
    
    function updateBalance(provider) {
        const balanceInput = document.getElementById(`${provider}_balance`);
        const thresholdInput = document.getElementById(`${provider}_threshold`);
        const apiKeyInput = document.getElementById(`${provider}_api_key`);
        const button = document.querySelector(`[data-provider="${provider}"]`);
        
        const balance = balanceInput ? balanceInput.value : null;
        const threshold = thresholdInput ? thresholdInput.value : null;
        const apiKey = apiKeyInput ? apiKeyInput.value : '';
        
        // YouTube-spezifische Felder
        let quotaLimit = null;
        if (provider === 'youtube') {
            const quotaInput = document.getElementById(`${provider}_quota_limit`);
            quotaLimit = quotaInput ? quotaInput.value : null;
            
            // Für YouTube: API-Key oder Quota-Limit erforderlich
            if (!apiKey && (!quotaLimit || isNaN(quotaLimit))) {
                alert('Bitte geben Sie einen gültigen API-Key oder ein Quota-Limit ein.');
                return;
            }
        } else {
            // Für andere Provider: Balance erforderlich
            if (!balance || isNaN(balance)) {
                alert('Bitte geben Sie einen gültigen Kontostand ein.');
                return;
            }
        }
        
        // Button-Status ändern
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Speichern...';
        button.disabled = true;
        
        const formData = new FormData();
        formData.append('provider', provider);
        formData.append('api_key', apiKey);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        // YouTube-spezifische Daten
        if (provider === 'youtube') {
            if (quotaLimit) {
                formData.append('quota_limit', quotaLimit);
            }
            // Für YouTube: Quota als Balance verwenden, falls gesetzt
            formData.append('balance', quotaLimit || '10000');
            formData.append('threshold', '1000');
            formData.append('currency', 'QUOTA');
        } else {
            // Für andere Provider: Standard-Daten
            formData.append('balance', balance);
            formData.append('threshold', threshold);
            formData.append('currency', 'USD');
        }
        
        fetch('/accounts/api/balances/update/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Erfolgs-Feedback
                button.innerHTML = '<i class="fas fa-check"></i> Gespeichert';
                button.classList.remove('btn-primary');
                button.classList.add('btn-success');
                
                // API-Key Status aktualisieren
                const keyStatusSpan = document.getElementById(`${provider}_key_status`);
                if (keyStatusSpan && data.masked_api_key) {
                    keyStatusSpan.textContent = data.masked_api_key;
                }
                
                // API-Key Eingabefeld leeren (aus Sicherheitsgründen)
                if (apiKeyInput) {
                    apiKeyInput.value = '';
                }
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-primary');
                    button.disabled = false;
                }, 2000);
            } else {
                alert('Fehler beim Speichern: ' + data.error);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error updating balance:', error);
            alert('Netzwerkfehler beim Speichern');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
    
    function removeApiKey(provider) {
        const providerNames = {
            'openai': 'OpenAI',
            'anthropic': 'Anthropic (Claude)',
            'google': 'Google (Gemini)',
            'youtube': 'YouTube Data API'
        };
        
        if (!confirm(`Möchten Sie den API-Key für ${providerNames[provider]} wirklich entfernen?`)) {
            return;
        }
        
        const formData = new FormData();
        formData.append('provider', provider);
        formData.append('action', 'remove_key');
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        fetch('/accounts/api/balances/remove-key/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Aktualisiere Status-Anzeige
                const keyStatusSpan = document.getElementById(`${provider}_key_status`);
                if (keyStatusSpan) {
                    keyStatusSpan.textContent = 'Nicht konfiguriert';
                }
                
                // Zeige Erfolgs-Message
                alert(`API-Key für ${providerNames[provider]} wurde erfolgreich entfernt.`);
            } else {
                alert('Fehler beim Entfernen des API-Keys: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error removing API key:', error);
            alert('Netzwerkfehler beim Entfernen des API-Keys');
        });
    }
    
    function loadUsageStatistics() {
        const statsContent = document.getElementById('usageStatsContent');
        statsContent.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Laden...</span>
                </div>
                <p class="text-muted">Statistiken werden geladen...</p>
            </div>
        `;
        
        fetch('/accounts/api/usage/stats/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayUsageStatistics(data);
                } else {
                    statsContent.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Statistiken</div>';
                }
            })
            .catch(error => {
                console.error('Error loading statistics:', error);
                statsContent.innerHTML = '<div class="alert alert-danger">Netzwerkfehler</div>';
            });
    }
    
    function displayUsageStatistics(data) {
        const statsContent = document.getElementById('usageStatsContent');
        
        let html = `
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="alert alert-info">
                        <h6>Gesamtkosten (${data.period}): <strong>$${data.total_cost.toFixed(4)}</strong></h6>
                    </div>
                </div>
            </div>
            <div class="row">
        `;
        
        for (const [provider, stats] of Object.entries(data.stats)) {
            const percentage = data.total_cost > 0 ? (stats.total_cost / data.total_cost * 100) : 0;
            
            html += `
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6>${stats.name}</h6>
                            <p class="mb-1"><strong>Kosten:</strong> $${stats.total_cost.toFixed(4)} (${percentage.toFixed(1)}%)</p>
                            <p class="mb-1"><strong>Anfragen:</strong> ${stats.request_count}</p>
                            <p class="mb-1"><strong>Tokens:</strong> ${stats.total_tokens.toLocaleString()}</p>
                            <p class="mb-0"><small class="text-muted">
                                Zuletzt: ${stats.last_used ? new Date(stats.last_used).toLocaleDateString('de-DE') : 'Nie'}
                            </small></p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        statsContent.innerHTML = html;
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>

{% endblock %}