{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
.editor-container {
    display: flex;
    gap: 1rem;
    min-height: calc(100vh - 100px);
}

.editor-sidebar {
    position: sticky;
    top: 20px;
    width: 160px;
    height: fit-content;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 0.75rem;
}

.editor-main {
    flex: 1;
    min-width: 0;
}

.sidebar-section {
    margin-bottom: 1.5rem;
}

.sidebar-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: #333;
    display: flex;
    align-items: center;
}

.sidebar-title i {
    color: #667eea;
    font-size: 0.9rem;
}

/* Compact sidebar styles */
.editor-sidebar .btn,
.editor-right-sidebar .btn {
    font-size: 0.8rem;
    padding: 0.4rem 0.6rem;
}

.editor-sidebar h6,
.editor-right-sidebar h6 {
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}

.editor-sidebar .form-select,
.editor-right-sidebar .form-select {
    font-size: 0.85rem;
    padding: 0.4rem 0.6rem;
}

.editor-sidebar .text-muted,
.editor-right-sidebar .text-muted {
    font-size: 0.75rem;
}

.btn-group-vertical .btn {
    font-size: 0.8rem;
    padding: 0.4rem 0.6rem;
}

.btn-group-vertical .btn i {
    font-size: 0.75rem;
}

/* Responsive adjustments */
@media (max-width: 1400px) {
    .editor-sidebar {
        width: 140px;
        padding: 0.5rem;
    }
    
    .sidebar-title {
        font-size: 0.85rem;
    }
    
    .editor-sidebar .btn {
        font-size: 0.7rem;
        padding: 0.25rem 0.4rem;
    }
}

@media (max-width: 1200px) {
    .editor-sidebar {
        width: 120px;
        padding: 0.4rem;
    }
    
    .sidebar-section {
        margin-bottom: 0.75rem;
    }
    
    .sidebar-title {
        font-size: 0.8rem;
        margin-bottom: 0.4rem;
    }
    
    .editor-sidebar h6 {
        font-size: 0.75rem;
    }
    
    .editor-sidebar .text-muted {
        font-size: 0.7rem;
    }
}

/* SEO Editor Styles */
.seo-editor-container {
    max-width: 100%;
}

.seo-preview {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    background: #f8f9fa;
}

.preview-title {
    color: #1a0dab;
    font-size: 1.125rem;
    font-weight: 400;
    line-height: 1.3;
    margin-bottom: 0.25rem;
    text-decoration: none;
}

.preview-url {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.preview-description {
    color: #545454;
    font-size: 0.875rem;
    line-height: 1.4;
}

.alt-text-item {
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    background: white;
}

.alt-text-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
}

.character-counter {
    font-size: 0.75rem;
}

.counter-good { color: #28a745; }
.counter-warning { color: #ffc107; }
.counter-danger { color: #dc3545; }

.content-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 1rem;
    background: #fff;
    transition: box-shadow 0.3s ease;
}

.content-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.content-header {
    background: #f8f9fa;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: between;
    align-items: center;
}

.content-body {
    padding: 1rem;
}

.editor-textarea {
    min-height: 100px;
    resize: vertical;
}

.image-preview {
    max-width: 200px;
    max-height: 150px;
    object-fit: cover;
    border-radius: 4px;
}

.add-content-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    font-size: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 1000;
}

.page-selector {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 1rem;
    margin-bottom: 2rem;
}

.content-type-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
}

.content-type-text { background: #e3f2fd; color: #1976d2; }
.content-type-image { background: #f3e5f5; color: #7b1fa2; }
.content-type-hero_title { background: #e8f5e8; color: #388e3c; }
.content-type-hero_subtitle { background: #fff3e0; color: #f57c00; }
.content-type-section_title { background: #fce4ec; color: #c2185b; }
.content-type-section_text { background: #e0f2f1; color: #00695c; }
.content-type-button_text { background: #fff9c4; color: #f57f17; }
.content-type-testimonial { background: #f1f8e9; color: #689f38; }

/* Section-based layout styles */
.content-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 1.5rem;
    border-left: 4px solid #667eea;
}

.section-header h5 {
    font-weight: 600;
    color: #333;
    margin: 0;
}

.section-content {
    border: 2px dashed #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    min-height: 80px;
}

.section-content:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.add-to-section-btn {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    color: #6c757d;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 1rem;
}

.add-to-section-btn:hover {
    background: #e7f1ff;
    border-color: #667eea;
    color: #667eea;
}

.add-section-btn {
    margin-top: 2rem;
    padding: 2rem;
}

.no-content-message {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 3rem;
}

/* Visual Editor Styles */
.visual-editor-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
}

.preview-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s ease;
}

.preview-frame {
    width: 100%;
    height: 80vh;
    border: none;
    background: white;
    transition: all 0.3s ease;
}

/* Responsive Preview Sizes */
.preview-container.mobile {
    max-width: 375px;
    margin: 0 auto;
}

.preview-container.tablet {
    max-width: 768px;
    margin: 0 auto;
}

.preview-container.desktop {
    max-width: 100%;
}

.editor-toolbar {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.editor-tabs .nav-tabs {
    border-bottom: 2px solid #dee2e6;
}

.editor-tabs .nav-link {
    border: none;
    color: #6c757d;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    border-radius: 8px 8px 0 0;
}

.editor-tabs .nav-link.active {
    background: white;
    color: #495057;
    border-bottom: 2px solid #667eea;
}

.btn-group .btn.active {
    background: #667eea;
    border-color: #667eea;
    color: white;
}

/* Preview Edit Mode Styles */
.preview-edit-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(102, 126, 234, 0.1);
    backdrop-filter: blur(1px);
    z-index: 1000;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.preview-edit-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.preview-edit-hint {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #667eea;
    color: white;
    padding: 1rem 2rem;
    border-radius: 8px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* Drag & Drop Styles */
.content-item {
    cursor: move;
    transition: all 0.3s ease;
    position: relative;
}

.content-item:hover {
    transform: translateY(-2px);
}

.content-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
    z-index: 1000;
}

.content-item.drag-over {
    border-top: 3px solid #667eea;
    background: #f8f9fa;
}

.drag-handle {
    position: absolute;
    left: -30px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    cursor: grab;
    font-size: 1.2rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.content-item:hover .drag-handle {
    opacity: 1;
}

.drag-handle:active {
    cursor: grabbing;
}

.sortable-list {
    min-height: 200px;
}
</style>

<div class="editor-container">
    <!-- Left Sidebar -->
    <div class="editor-sidebar">
        <div class="sidebar-section">
            <h6 class="text-muted mb-2">
                <i class="fas fa-file-alt me-1"></i>Seite ausw√§hlen
            </h6>
            
            <!-- Page categories with grouped options -->
            <select class="form-select mb-2" id="pageSelector" onchange="changePage()">
                <optgroup label="üìë Hauptseiten">
                    {% for choice in page_choices %}
                        {% if choice.0 in 'startseite,impressum,agb,datenschutz' %}
                            <option value="{{ choice.0 }}" {% if choice.0 == page %}selected{% endif %}>
                                {{ choice.1 }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </optgroup>
                
                <optgroup label="üéõÔ∏è App Dashboards">
                    {% for choice in page_choices %}
                        {% if 'dashboard' in choice.0 %}
                            <option value="{{ choice.0 }}" {% if choice.0 == page %}selected{% endif %}>
                                {{ choice.1 }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </optgroup>
                
                <optgroup label="üåü Landing Pages">
                    {% for choice in page_choices %}
                        {% if 'landing' in choice.0 %}
                            <option value="{{ choice.0 }}" {% if choice.0 == page %}selected{% endif %}>
                                {{ choice.1 }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </optgroup>
                
                <optgroup label="üõí Shop Seiten">
                    {% for choice in page_choices %}
                        {% if 'shop' in choice.0 %}
                            <option value="{{ choice.0 }}" {% if choice.0 == page %}selected{% endif %}>
                                {{ choice.1 }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </optgroup>
                
                <optgroup label="üîß Funktional">
                    {% for choice in page_choices %}
                        {% if choice.0 in 'search_results,error_404,error_500,maintenance,coming_soon' %}
                            <option value="{{ choice.0 }}" {% if choice.0 == page %}selected{% endif %}>
                                {{ choice.1 }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </optgroup>
                
                <optgroup label="üåê Global">
                    {% for choice in page_choices %}
                        {% if choice.0 in 'header,footer' %}
                            <option value="{{ choice.0 }}" {% if choice.0 == page %}selected{% endif %}>
                                {{ choice.1 }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </optgroup>
                
                <!-- Custom pages -->
                {% for choice in page_choices %}
                    {% if choice.1|slice:':3' == 'üìù ' %}
                        {% if forloop.first %}
                            <optgroup label="üìù Benutzerdefiniert">
                        {% endif %}
                        <option value="{{ choice.0 }}" {% if choice.0 == page %}selected{% endif %}>
                            {{ choice.1 }}
                        </option>
                        {% if forloop.last %}
                            </optgroup>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </select>
            
            <div class="current-page-info mb-2">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Aktuell: <strong>{{ page|title }}</strong>
                </small>
            </div>
            
            <div class="d-grid gap-1">
                <button class="btn btn-outline-success btn-sm" type="button" onclick="showNewPageModal()">
                    <i class="fas fa-plus me-1"></i>Neue Seite
                </button>
                {% if page not in 'startseite,impressum,agb,datenschutz,header,footer' %}
                <button class="btn btn-outline-danger btn-sm" type="button" onclick="deletePage('{{ page }}')">
                    <i class="fas fa-trash me-1"></i>Seite l√∂schen
                </button>
                {% endif %}
                <button class="btn btn-outline-info btn-sm" type="button" onclick="showPageSettings()">
                    <i class="fas fa-cog me-1"></i>Einstellungen
                </button>
            </div>
        </div>
        
        <div class="sidebar-section">
            <h2 class="sidebar-title">
                <i class="fas fa-edit me-1"></i>Editor
            </h2>
        </div>
        
        <div class="sidebar-section">
            <h6 class="text-muted mb-2">Visuell</h6>
            <button class="btn btn-outline-primary w-100" id="sidebarToggleEditMode" onclick="toggleVisualEditMode()">
                <i class="fas fa-edit me-1"></i>Bearbeiten aktivieren
            </button>
            <p class="text-muted small mt-1">Klicken Sie auf Elemente</p>
        </div>
        
        <div class="sidebar-section">
            <h6 class="text-muted mb-2">Gr√∂√üe</h6>
            <div class="btn-group-vertical w-100" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="setPreviewSize('mobile')">
                    <i class="fas fa-mobile-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="setPreviewSize('tablet')">
                    <i class="fas fa-tablet-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary active" onclick="setPreviewSize('desktop')">
                    <i class="fas fa-desktop"></i>
                </button>
            </div>
        </div>
        
        <div class="sidebar-section">
            <h6 class="text-muted mb-2">Aktionen</h6>
            <div class="d-grid gap-1">
                <a href="{% url 'startseite' %}" class="btn btn-outline-primary" target="_blank">
                    <i class="fas fa-external-link-alt me-1"></i>Ansehen
                </a>
                <button class="btn btn-success" onclick="showAddContentModal()">
                    <i class="fas fa-plus me-1"></i>Inhalt
                </button>
                <button class="btn btn-primary" onclick="showAiContentModal()">
                    <i class="fas fa-robot me-1"></i>KI
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="editor-main">

    <!-- Editor Mode Tabs -->
    <div class="editor-tabs mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <ul class="nav nav-tabs" id="editorTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="visual-tab" data-bs-toggle="tab" data-bs-target="#visual" type="button" role="tab" onclick="showPreviewOverlay()">
                        <i class="fas fa-eye me-2"></i>Visueller Editor
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab" onclick="hidePreviewOverlay()">
                        <i class="fas fa-list me-2"></i>Listenmodus
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="seo-tab" data-bs-toggle="tab" data-bs-target="#seo" type="button" role="tab" onclick="loadSEOData(); hidePreviewOverlay()">
                        <i class="fas fa-search me-2"></i>SEO-Editor
                    </button>
                </li>
            </ul>
            
            <!-- Save Button -->
            <button class="btn btn-success" id="saveAllBtn" onclick="saveAllChanges()">
                <i class="fas fa-save me-2"></i>Speichern
            </button>
        </div>
    </div>

    <div class="tab-content" id="editorTabContent">
        <!-- Visual Editor Tab -->
        <div class="tab-pane fade show active" id="visual" role="tabpanel">
            <div class="visual-editor-container">
                
                <!-- Live Preview Frame -->
                <div class="preview-container" id="previewContainer">
                    <iframe id="previewFrame" 
                            src="{% if page == 'header' or page == 'footer' %}{% url 'startseite' %}{% elif page == 'startseite' %}{% url 'startseite' %}{% elif page == 'impressum' %}{% url 'impressum' %}{% elif page == 'agb' %}{% url 'agb' %}{% elif page == 'datenschutz' %}{% url 'datenschutz' %}{% else %}{% url 'dynamic_page' page_name=page %}{% endif %}?preview=true&page={{ page }}&t={{ request.GET.t|default:'1' }}&v=2" 
                            class="preview-frame"
                            onload="initializePreviewFrame()">
                    </iframe>
                </div>
            </div>
        </div>

        <!-- SEO Editor Tab -->
        <div class="tab-pane fade" id="seo" role="tabpanel">
            <div class="seo-editor-container">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-search me-2"></i>SEO Meta-Daten</h5>
                            </div>
                            <div class="card-body">
                                <form id="seoForm">
                                    {% csrf_token %}
                                    <input type="hidden" id="seoPage" name="page" value="{{ page }}">
                                    
                                    <div class="mb-3">
                                        <label class="form-label">SEO Titel</label>
                                        <input type="text" class="form-control" id="seoTitle" name="seo_title" maxlength="60" oninput="updateSEOCounters()">
                                        <div class="form-text">
                                            <span id="titleCounter">0</span>/60 Zeichen
                                            <span id="titleStatus" class="ms-2"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">SEO Beschreibung</label>
                                        <textarea class="form-control" id="seoDescription" name="seo_description" rows="3" maxlength="160" oninput="updateSEOCounters()"></textarea>
                                        <div class="form-text">
                                            <span id="descriptionCounter">0</span>/160 Zeichen
                                            <span id="descriptionStatus" class="ms-2"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Keywords</label>
                                        <input type="text" class="form-control" id="seoKeywords" name="keywords" placeholder="keyword1, keyword2, keyword3">
                                        <div class="form-text">Durch Kommas getrennte Schl√ºsselw√∂rter</div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Canonical URL</label>
                                                <input type="url" class="form-control" id="canonicalUrl" name="canonical_url">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <div class="form-check mt-4">
                                                    <input class="form-check-input" type="checkbox" id="noindex" name="noindex">
                                                    <label class="form-check-label" for="noindex">
                                                        Noindex (von Suchmaschinen ausschlie√üen)
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-primary" onclick="saveSEOSettings()">
                                        <i class="fas fa-save me-1"></i>SEO Einstellungen speichern
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-images me-2"></i>Bild Alt-Texte</h6>
                            </div>
                            <div class="card-body">
                                <div id="altTextList">
                                    <div class="text-center text-muted py-3">
                                        <i class="fas fa-spinner fa-spin"></i> Lade Alt-Texte...
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>SEO Vorschau</h6>
                            </div>
                            <div class="card-body">
                                <div class="seo-preview">
                                    <div class="preview-title" id="previewTitle">Titel wird hier angezeigt</div>
                                    <div class="preview-url text-success" id="previewUrl">{{ request.get_host }}/{{ page }}</div>
                                    <div class="preview-description" id="previewDescription">Beschreibung wird hier angezeigt</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- List Mode Tab -->
        <div class="tab-pane fade" id="list" role="tabpanel">
            {% if content_sections %}
                <!-- Section-based Content Display -->
                {% for section_key, section_data in content_sections.items %}
                <div class="content-section mb-4">
                    <div class="section-header">
                        <h5 class="mb-3">
                            <i class="fas fa-layer-group me-2 text-primary"></i>
                            {{ section_data.name }}
                            <span class="badge bg-secondary ms-2">{{ section_data.contents|length }}</span>
                        </h5>
                    </div>
                    
                    <div class="section-content sortable-list" data-section="{{ section_key }}">
                        {% for content in section_data.contents %}
                        <div class="content-item" data-content-id="{{ content.id }}" data-sort-order="{{ content.sort_order }}" draggable="true">
                            <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                            <div class="content-header">
                                <div>
                                    <span class="content-type-badge content-type-{{ content.content_type }}">
                                        {{ content.get_content_type_display }}
                                    </span>
                                    <span class="ms-2 fw-bold">{{ content.content_key }}</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editContent({{ content.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info me-1" onclick="modifyWithAI({{ content.id }})">
                                        <i class="fas fa-robot"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteElement({{ content.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="content-body">
                                {% if content.content_type == 'image' and content.image_content %}
                                    <img src="{{ content.image_content.url }}" alt="{{ content.image_alt_text }}" class="image-preview mb-2">
                                    {% if content.image_alt_text %}
                                        <p class="text-muted small mb-0">Alt-Text: {{ content.image_alt_text }}</p>
                                    {% endif %}
                                {% elif content.content_type in 'html_block,ai_generated' and content.html_content %}
                                    <div class="border rounded p-2 bg-light">
                                        <small class="text-muted">HTML Block:</small>
                                        <div style="max-height: 100px; overflow: hidden;">{{ content.html_content|safe }}</div>
                                    </div>
                                {% else %}
                                    <p class="mb-0">{{ content.text_content|truncatechars:100 }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Add content button for this section -->
                        <div class="add-to-section-btn" onclick="showAddContentModal('{{ section_key }}')">
                            <i class="fas fa-plus me-2"></i>Inhalt zu {{ section_data.name }} hinzuf√ºgen
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Add new section button -->
                <div class="add-section-btn text-center">
                    <button class="btn btn-outline-primary btn-lg" onclick="showAddSectionModal()">
                        <i class="fas fa-plus-circle me-2"></i>Neuen Bereich hinzuf√ºgen
                    </button>
                </div>
            {% else %}
                <!-- No content available -->
                <div class="no-content-message text-center py-5">
                    <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Noch keine Inhalte vorhanden</h4>
                    <p class="text-muted">Beginnen Sie mit dem Hinzuf√ºgen von Inhalten zu Ihrer Seite.</p>
                    <button class="btn btn-primary btn-lg" onclick="showAddContentModal()">
                        <i class="fas fa-plus me-2"></i>Ersten Inhalt erstellen
                    </button>
                </div>
            {% endif %}
            
            <!-- Hidden fallback for compatibility -->
            <div id="contentList" class="sortable-list d-none">
                {% for content in contents %}
                <div class="content-item" data-content-id="{{ content.id }}" data-sort-order="{{ content.sort_order }}" draggable="true">
                    <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                    <div class="content-header">
                        <div>
                            <span class="content-type-badge content-type-{{ content.content_type }}">
                                {{ content.get_content_type_display }}
                            </span>
                            <span class="ms-2 fw-bold">{{ content.content_key }}</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editContent({{ content.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="modifyWithAI({{ content.id }})">
                                <i class="fas fa-robot"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteElement({{ content.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="content-body">
                        {% if content.content_type == 'image' and content.image_content %}
                            <img src="{{ content.image_content.url }}" alt="{{ content.image_alt_text }}" class="image-preview mb-2">
                            {% if content.image_alt_text %}
                                <p class="text-muted small mb-0">Alt-Text: {{ content.image_alt_text }}</p>
                            {% endif %}
                        {% elif content.content_type in 'html_block,ai_generated' and content.html_content %}
                            <div class="border rounded p-2 bg-light">
                                <small class="text-muted">HTML Block:</small>
                                <div style="max-height: 100px; overflow: hidden;">{{ content.html_content|safe }}</div>
                            </div>
                        {% else %}
                            <p class="mb-0">{{ content.text_content|truncatewords:20 }}</p>
                        {% endif %}
                        {% if content.link_url %}
                            <p class="text-muted small mb-0">
                                <i class="fas fa-link me-1"></i>{{ content.link_url }}
                            </p>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-5">
                    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Noch keine Inhalte vorhanden</h4>
                    <p class="text-muted">Klicke auf "Inhalt hinzuf√ºgen" um zu beginnen.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    </div> <!-- editor-main -->
    
</div> <!-- editor-container -->

<!-- AI Content Modal -->
<div class="modal fade" id="aiContentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-robot me-2"></i>KI-Content Generator
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">Beschreibung eingeben</h6>
                        
                        <form id="aiContentForm">
                            {% csrf_token %}
                            <input type="hidden" id="aiPage" name="page" value="{{ page }}">
                            
                            <div class="mb-3">
                                <label class="form-label">Content-Schl√ºssel</label>
                                <input type="text" class="form-control" id="aiContentKey" name="content_key" required>
                                <div class="form-text">Eindeutige Bezeichnung f√ºr diesen Inhalt</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Was soll erstellt werden?</label>
                                <textarea class="form-control" id="aiPrompt" rows="6" placeholder="Beschreiben Sie detailliert, was die KI erstellen soll...

Beispiele:
- Eine moderne Preistabelle mit 3 Spalten f√ºr verschiedene Pl√§ne
- Ein Hero-Banner mit Hintergrundbild und Call-to-Action Button
- Eine Testimonial-Sektion mit Kundenbewertungen
- Eine Feature-Liste mit Icons und Beschreibungen
- Ein Contact-Formular mit modernem Design"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Zus√§tzliche Hinweise (optional)</label>
                                <input type="text" class="form-control" id="aiHints" placeholder="z.B. Farben, Gr√∂√üe, spezielle Anforderungen...">
                            </div>
                            
                            <button type="button" class="btn btn-primary w-100" onclick="generateAiContent()" id="generateBtn">
                                <i class="fas fa-magic me-2"></i>Mit KI erstellen
                            </button>
                        </form>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">Vorschau & Code</h6>
                        
                        <div id="aiLoadingIndicator" class="text-center py-4" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Generiere Content...</span>
                            </div>
                            <p class="mt-2 text-muted">KI erstellt Ihren Content...</p>
                        </div>
                        
                        <div id="aiPreviewContainer" style="display: none;">
                            <ul class="nav nav-tabs mb-3" id="previewTabs">
                                <li class="nav-item">
                                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#previewTab">
                                        <i class="fas fa-eye me-1"></i>Vorschau
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#htmlTab">
                                        <i class="fab fa-html5 me-1"></i>HTML
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#cssTab">
                                        <i class="fab fa-css3-alt me-1"></i>CSS
                                    </button>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="previewTab">
                                    <div class="border rounded p-3" style="min-height: 200px; background: white;">
                                        <div id="aiPreview"></div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="htmlTab">
                                    <textarea class="form-control" id="aiHtmlCode" rows="10" readonly></textarea>
                                </div>
                                <div class="tab-pane fade" id="cssTab">
                                    <textarea class="form-control" id="aiCssCode" rows="10" readonly></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-success" id="saveAiContentBtn" onclick="saveAiContent()" style="display: none;">
                    <i class="fas fa-save me-1"></i>Content speichern
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Content Button -->
<button class="btn btn-primary add-content-btn" onclick="showAddContentModal()" title="Inhalt hinzuf√ºgen">
    <i class="fas fa-plus"></i>
</button>

<!-- Content Modal -->
<div class="modal fade" id="contentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contentModalTitle">Inhalt bearbeiten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="contentForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" id="contentId" name="content_id">
                    <input type="hidden" id="modalPage" name="page" value="{{ page }}">
                    <input type="hidden" id="sortOrder" name="sort_order" value="0">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Inhalt Schl√ºssel</label>
                                <input type="text" class="form-control" id="contentKey" name="content_key" required>
                                <div class="form-text">Eindeutige Bezeichnung f√ºr diesen Inhalt</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Inhaltstyp</label>
                                <select class="form-select" id="contentType" name="content_type" onchange="toggleContentFields()" required>
                                    {% for choice in content_type_choices %}
                                        <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="textContentField" class="mb-3">
                        <label class="form-label">Text Inhalt</label>
                        <textarea class="form-control editor-textarea" id="textContent" name="text_content" rows="4"></textarea>
                        
                        <!-- Text Styling Options -->
                        <div id="textStylingOptions" class="mt-3">
                            <!-- Erste Zeile: Schriftart und Schriftgr√∂√üe -->
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <label class="form-label small fw-semibold">Schriftart</label>
                                    <select class="form-select form-select-sm" id="fontFamily" name="font_family">
                                        <option value="">Standard</option>
                                        <option value="Arial, sans-serif">Arial</option>
                                        <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>
                                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                                        <option value="Georgia, serif">Georgia</option>
                                        <option value="'Courier New', Courier, monospace">Courier New</option>
                                        <option value="Verdana, sans-serif">Verdana</option>
                                        <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                                        <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                                        <option value="Impact, sans-serif">Impact</option>
                                        <option value="'Lucida Console', monospace">Lucida Console</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-semibold">Schriftgr√∂√üe</label>
                                    <select class="form-select form-select-sm" id="fontSize" name="font_size">
                                        <option value="">Standard</option>
                                        <option value="12px">12px</option>
                                        <option value="14px">14px</option>
                                        <option value="16px">16px</option>
                                        <option value="18px">18px</option>
                                        <option value="20px">20px</option>
                                        <option value="24px">24px</option>
                                        <option value="28px">28px</option>
                                        <option value="32px">32px</option>
                                        <option value="48px">48px</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Zweite Zeile: Gewicht, Farbe, Ausrichtung, Stiloptionen -->
                            <div class="row g-2 mb-2">
                                <div class="col-3">
                                    <label class="form-label small fw-semibold">Gewicht</label>
                                    <select class="form-select form-select-sm" id="fontWeight" name="font_weight">
                                        <option value="">Standard</option>
                                        <option value="300">D√ºnn</option>
                                        <option value="400">Normal</option>
                                        <option value="500">Medium</option>
                                        <option value="600">Semibold</option>
                                        <option value="700">Fett</option>
                                        <option value="800">Extra Fett</option>
                                        <option value="900">Schwarz</option>
                                    </select>
                                </div>
                                <div class="col-3">
                                    <label class="form-label small fw-semibold">Farbe</label>
                                    <input type="color" class="form-control form-control-color form-control-sm" id="textColor" name="text_color" value="#000000" title="Textfarbe w√§hlen">
                                </div>
                                <div class="col-3">
                                    <label class="form-label small fw-semibold">Ausrichtung</label>
                                    <select class="form-select form-select-sm" id="textAlign" name="text_align">
                                        <option value="">Standard</option>
                                        <option value="left">Links</option>
                                        <option value="center">Mitte</option>
                                        <option value="right">Rechts</option>
                                        <option value="justify">Block</option>
                                    </select>
                                </div>
                                <div class="col-3">
                                    <label class="form-label small fw-semibold">Stil</label>
                                    <div class="d-flex gap-2 mt-1">
                                        <div class="form-check form-check-inline p-0">
                                            <input class="form-check-input" type="checkbox" id="textItalic" name="text_italic" value="italic">
                                            <label class="form-check-label small" for="textItalic" title="Kursiv">
                                                <em>K</em>
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline p-0">
                                            <input class="form-check-input" type="checkbox" id="textUnderline" name="text_underline" value="underline">
                                            <label class="form-check-label small" for="textUnderline" title="Unterstrichen">
                                                <u>U</u>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Vorschau -->
                            <div class="mt-2">
                                <label class="form-label small fw-semibold">Vorschau:</label>
                                <div class="border rounded p-2 bg-light" style="min-height: 40px;">
                                    <div id="textPreview">
                                        Beispieltext...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="imageContentField" class="mb-3" style="display: none;">
                        <label class="form-label">Bild</label>
                        <input type="file" class="form-control" id="imageContent" name="image_content" accept="image/*">
                        <div id="currentImagePreview" class="mt-2" style="display: none;">
                            <img id="currentImage" class="image-preview">
                            <p class="text-muted small mt-1">Aktuelles Bild</p>
                        </div>
                    </div>
                    
                    <div id="imageAltField" class="mb-3" style="display: none;">
                        <label class="form-label">Alt-Text f√ºr Bild</label>
                        <input type="text" class="form-control" id="imageAltText" name="image_alt_text">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Link URL (optional)</label>
                        <input type="url" class="form-control" id="linkUrl" name="link_url">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" id="aiRephraseBtnModal" onclick="showAiRephraseModal()" style="display: none;">
                    <i class="fas fa-robot me-1"></i>Mit KI umformulieren
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="saveContent()">
                    <i class="fas fa-save me-1"></i>Speichern
                </button>
            </div>
        </div>
    </div>
</div>

<!-- KI Container/Element Bearbeitungs-Modal -->
<div class="modal fade" id="aiEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-robot me-2"></i>Bearbeiten mit KI
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="aiEditForm">
                    {% csrf_token %}
                    <input type="hidden" id="aiEditContentId" name="content_id">
                    <input type="hidden" id="aiEditPage" name="page" value="{{ page }}">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-sitemap me-1"></i>Struktur-√Ñnderungen
                                </label>
                                <textarea class="form-control" id="aiStructurePrompt" name="structure_prompt" 
                                    rows="6" placeholder="Beschreibe hier, was am Aufbau/Skelett ge√§ndert werden soll...

Beispiele:
- F√ºge eine zweispaltige Layout hinzu
- √Ñndere zu einem Card-Design
- Erstelle eine Galerie-Ansicht
- Mache es responsive f√ºr mobile Ger√§te"></textarea>
                                <div class="form-text">Beschreibe strukturelle √Ñnderungen am HTML-Layout</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-palette me-1"></i>Style-√Ñnderungen
                                </label>
                                <textarea class="form-control" id="aiStylePrompt" name="style_prompt" 
                                    rows="6" placeholder="Beschreibe hier Style-√Ñnderungen...

Beispiele:
- √Ñndere die Hintergrundfarbe zu blau
- Mache den Text gr√∂√üer und fett
- F√ºge einen Schatten hinzu
- Verwende ein modernes Gradient
- Runde die Ecken ab"></textarea>
                                <div class="form-text">Beschreibe visuelle √Ñnderungen (Farben, Gr√∂√üen, etc.)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Aktueller Code:</strong> Die KI erh√§lt den kompletten HTML- und CSS-Code des Elements und passt ihn entsprechend Ihren Anweisungen an.
                        </div>
                    </div>
                    
                    <div id="aiEditPreview" class="mb-3" style="display: none;">
                        <label class="form-label">Vorschau des aktuellen Elements:</label>
                        <div class="border rounded p-3 bg-light">
                            <div id="currentElementPreview"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="processAiEdit()" id="aiEditBtn">
                    <i class="fas fa-magic me-1"></i>Mit KI bearbeiten
                </button>
            </div>
        </div>
    </div>
</div>

<!-- KI Text-Umformulierungs-Modal -->
<div class="modal fade" id="aiRephraseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-robot me-2"></i>Text mit KI umformulieren
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="aiRephraseForm">
                    {% csrf_token %}
                    <input type="hidden" id="aiRephraseContentId" name="content_id">
                    
                    <div class="mb-3">
                        <label class="form-label">Aktueller Text:</label>
                        <div class="form-control-plaintext border rounded p-2 bg-light" id="currentTextDisplay"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Umformulierungs-Anweisungen (optional)</label>
                        <textarea class="form-control" id="rephrasePrompt" name="rephrase_prompt" 
                            rows="3" placeholder="Spezielle Anweisungen f√ºr die Umformulierung...

Beispiele:
- Mache es formeller
- Verwende einen freundlicheren Ton
- K√ºrze den Text
- Mache es √ºberzeugender"></textarea>
                        <div class="form-text">Lass leer f√ºr eine einfache Umformulierung</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="processAiRephrase()" id="aiRephraseBtn">
                    <i class="fas fa-magic me-1"></i>Text umformulieren
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let contentModal = null;
let aiContentModal = null;
let aiEditModal = null;
let aiRephraseModal = null;
let visualEditMode = false;
let previewFrame = null;
let currentAiContent = null;

document.addEventListener('DOMContentLoaded', function() {
    contentModal = new bootstrap.Modal(document.getElementById('contentModal'));
    aiContentModal = new bootstrap.Modal(document.getElementById('aiContentModal'));
    aiEditModal = new bootstrap.Modal(document.getElementById('aiEditModal'));
    aiRephraseModal = new bootstrap.Modal(document.getElementById('aiRephraseModal'));
    previewFrame = document.getElementById('previewFrame');
    
    // Add event listeners for text styling preview
    setupTextStylingListeners();
});

function setupTextStylingListeners() {
    const textStyleInputs = [
        'textContent', 'fontFamily', 'fontSize', 'fontWeight', 
        'textColor', 'textAlign', 'textItalic', 'textUnderline'
    ];
    
    textStyleInputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element) {
            element.addEventListener('input', updateTextPreview);
            element.addEventListener('change', updateTextPreview);
        }
    });
}

function updateTextPreview() {
    const preview = document.getElementById('textPreview');
    if (!preview) return;
    
    const textContent = document.getElementById('textContent').value || 'Beispieltext...';
    const fontFamily = document.getElementById('fontFamily').value;
    const fontSize = document.getElementById('fontSize').value;
    const fontWeight = document.getElementById('fontWeight').value;
    const textColor = document.getElementById('textColor').value;
    const textAlign = document.getElementById('textAlign').value;
    const isItalic = document.getElementById('textItalic').checked;
    const isUnderline = document.getElementById('textUnderline').checked;
    
    // Build CSS styles
    let styles = [];
    if (fontFamily) styles.push(`font-family: ${fontFamily}`);
    if (fontSize) styles.push(`font-size: ${fontSize}`);
    if (fontWeight) styles.push(`font-weight: ${fontWeight}`);
    if (textColor && textColor !== '#000000') styles.push(`color: ${textColor}`);
    if (textAlign) styles.push(`text-align: ${textAlign}`);
    if (isItalic) styles.push('font-style: italic');
    if (isUnderline) styles.push('text-decoration: underline');
    
    // Apply styles and content
    preview.style.cssText = styles.join('; ');
    preview.textContent = textContent;
}

function loadTextStylingFromCSS(cssContent) {
    // Reset to defaults first
    resetTextStylingFields();
    
    if (!cssContent) return;
    
    // Parse CSS rules and load into form fields
    const fontFamilyMatch = cssContent.match(/font-family:\s*([^;]+)/);
    if (fontFamilyMatch) {
        const fontFamily = fontFamilyMatch[1].trim();
        const fontFamilySelect = document.getElementById('fontFamily');
        if (fontFamilySelect) {
            fontFamilySelect.value = fontFamily;
        }
    }
    
    const fontSizeMatch = cssContent.match(/font-size:\s*([^;]+)/);
    if (fontSizeMatch) {
        const fontSize = fontSizeMatch[1].trim();
        const fontSizeSelect = document.getElementById('fontSize');
        if (fontSizeSelect) {
            fontSizeSelect.value = fontSize;
        }
    }
    
    const fontWeightMatch = cssContent.match(/font-weight:\s*([^;]+)/);
    if (fontWeightMatch) {
        const fontWeight = fontWeightMatch[1].trim();
        const fontWeightSelect = document.getElementById('fontWeight');
        if (fontWeightSelect) {
            fontWeightSelect.value = fontWeight;
        }
    }
    
    const colorMatch = cssContent.match(/color:\s*([^;]+)/);
    if (colorMatch) {
        const color = colorMatch[1].trim();
        const colorInput = document.getElementById('textColor');
        if (colorInput) {
            colorInput.value = color;
        }
    }
    
    const textAlignMatch = cssContent.match(/text-align:\s*([^;]+)/);
    if (textAlignMatch) {
        const textAlign = textAlignMatch[1].trim();
        const textAlignSelect = document.getElementById('textAlign');
        if (textAlignSelect) {
            textAlignSelect.value = textAlign;
        }
    }
    
    const fontStyleMatch = cssContent.match(/font-style:\s*italic/);
    if (fontStyleMatch) {
        const italicCheckbox = document.getElementById('textItalic');
        if (italicCheckbox) {
            italicCheckbox.checked = true;
        }
    }
    
    const textDecorationMatch = cssContent.match(/text-decoration:\s*underline/);
    if (textDecorationMatch) {
        const underlineCheckbox = document.getElementById('textUnderline');
        if (underlineCheckbox) {
            underlineCheckbox.checked = true;
        }
    }
    
    // Update preview with loaded styles
    updateTextPreview();
}

function resetTextStylingFields() {
    const fontFamily = document.getElementById('fontFamily');
    const fontSize = document.getElementById('fontSize');
    const fontWeight = document.getElementById('fontWeight');
    const textColor = document.getElementById('textColor');
    const textAlign = document.getElementById('textAlign');
    const textItalic = document.getElementById('textItalic');
    const textUnderline = document.getElementById('textUnderline');
    
    if (fontFamily) fontFamily.value = '';
    if (fontSize) fontSize.value = '';
    if (fontWeight) fontWeight.value = '';
    if (textColor) textColor.value = '#000000';
    if (textAlign) textAlign.value = '';
    if (textItalic) textItalic.checked = false;
    if (textUnderline) textUnderline.checked = false;
    
    // Update preview
    updateTextPreview();
}

function changePage() {
    const page = document.getElementById('pageSelector').value;
    window.location.href = `{% url 'accounts:content_editor' %}?page=${page}`;
}

function showAddContentModal() {
    document.getElementById('contentModalTitle').textContent = 'Neuen Inhalt hinzuf√ºgen';
    document.getElementById('contentForm').reset();
    document.getElementById('contentId').value = '';
    document.getElementById('modalPage').value = '{{ page }}';
    document.getElementById('currentImagePreview').style.display = 'none';
    toggleContentFields();
    contentModal.show();
}

function editContent(contentId) {
    document.getElementById('contentModalTitle').textContent = 'Inhalt bearbeiten';
    document.getElementById('contentId').value = contentId;
    
    // Lade Content-Daten via AJAX und f√ºlle das Formular
    fetch(`/accounts/content/${contentId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('contentKey').value = data.content.content_key;
            document.getElementById('contentType').value = data.content.content_type;
            document.getElementById('textContent').value = data.content.text_content || '';
            document.getElementById('imageAltText').value = data.content.image_alt_text || '';
            document.getElementById('linkUrl').value = data.content.link_url || '';
            
            // Load text styling from CSS content
            if (data.content.css_content) {
                loadTextStylingFromCSS(data.content.css_content);
            } else {
                // Reset styling fields to defaults
                resetTextStylingFields();
            }
            
            if (data.content.image_content) {
                document.getElementById('currentImage').src = data.content.image_content;
                document.getElementById('currentImagePreview').style.display = 'block';
            }
            
            // Show AI rephrase button for text content
            const contentType = data.content.content_type;
            const aiRephraseBtn = document.getElementById('aiRephraseBtnModal');
            if (contentType === 'text' || contentType === 'hero_title' || contentType === 'hero_subtitle' || 
                contentType === 'section_title' || contentType === 'section_text' || contentType === 'testimonial') {
                aiRephraseBtn.style.display = 'inline-block';
                aiRephraseBtn.setAttribute('data-content-id', data.content.id);
                aiRephraseBtn.setAttribute('data-current-text', data.content.text_content || '');
            } else {
                aiRephraseBtn.style.display = 'none';
            }
            
            toggleContentFields();
            contentModal.show();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Laden der Inhalte');
    });
}

function toggleContentFields() {
    const contentType = document.getElementById('contentType').value;
    const textField = document.getElementById('textContentField');
    const imageField = document.getElementById('imageContentField');
    const altField = document.getElementById('imageAltField');
    const textStylingOptions = document.getElementById('textStylingOptions');
    const textStyleOptions = document.getElementById('textStyleOptions');
    
    if (contentType === 'image') {
        textField.style.display = 'none';
        imageField.style.display = 'block';
        altField.style.display = 'block';
        if (textStylingOptions) textStylingOptions.style.display = 'none';
        if (textStyleOptions) textStyleOptions.style.display = 'none';
    } else {
        textField.style.display = 'block';
        imageField.style.display = 'none';
        altField.style.display = 'none';
        
        // Show text styling options for text-based content types
        const textBasedTypes = ['text', 'hero_title', 'hero_subtitle', 'section_title', 'section_text', 'button_text', 'testimonial'];
        if (textBasedTypes.includes(contentType)) {
            if (textStylingOptions) textStylingOptions.style.display = 'block';
            if (textStyleOptions) textStyleOptions.style.display = 'block';
        } else {
            if (textStylingOptions) textStylingOptions.style.display = 'none';
            if (textStyleOptions) textStyleOptions.style.display = 'none';
        }
    }
    
    // Update text preview when fields change
    updateTextPreview();
}

function saveContent() {
    const form = document.getElementById('contentForm');
    const formData = new FormData(form);
    
    // Add font styling data for text content types
    const contentType = document.getElementById('contentType').value;
    const textContentTypes = ['text', 'section_title', 'section_text', 'hero_title', 'hero_subtitle', 'button_text'];
    
    if (textContentTypes.includes(contentType)) {
        const fontFamily = document.getElementById('fontFamily');
        const fontSize = document.getElementById('fontSize');
        const fontWeight = document.getElementById('fontWeight');
        const textColor = document.getElementById('textColor');
        const textAlign = document.getElementById('textAlign');
        const textItalic = document.getElementById('textItalic');
        const textUnderline = document.getElementById('textUnderline');
        
        if (fontFamily && fontFamily.value) formData.append('font_family', fontFamily.value);
        if (fontSize && fontSize.value) formData.append('font_size', fontSize.value);
        if (fontWeight && fontWeight.value) formData.append('font_weight', fontWeight.value);
        if (textColor && textColor.value && textColor.value !== '#000000') formData.append('font_color', textColor.value);
        if (textAlign && textAlign.value) formData.append('text_align', textAlign.value);
        if (textItalic && textItalic.checked) formData.append('font_style', 'italic');
        if (textUnderline && textUnderline.checked) formData.append('text_decoration', 'underline');
    }
    
    fetch('{% url "accounts:update_content" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            contentModal.hide();
            
            // Refresh the preview iframe instead of reloading the whole page
            refreshPreview();
            
            // Also update the list view if it's active
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab && activeTab.id === 'list-tab') {
                // Only reload if we're in list mode
                setTimeout(() => location.reload(), 500);
            }
            
            // Update drag & drop handlers for new content
            setTimeout(() => updateDragDropHandlers(), 600);
        } else {
            alert('Fehler: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Speichern');
    });
}

function deleteContent(contentId) {
    // Use the unified deletion function
    deleteElement(contentId);
}

function deletePage(pageName) {
    if (confirm('Sind Sie sicher, dass Sie diese Seite und alle Inhalte l√∂schen m√∂chten?')) {
        fetch('{% url "accounts:delete_page" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                page_name: pageName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Redirect to startseite after deletion
                window.location.href = '{% url "accounts:content_editor" %}?page=startseite';
            } else {
                alert('Fehler: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim L√∂schen der Seite');
        });
    }
}

function modifyWithAI(contentId) {
    // First load the existing content
    fetch(`/accounts/content/${contentId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Open AI modal with existing content for modification
            document.getElementById('aiContentForm').reset();
            document.getElementById('aiPage').value = '{{ page }}';
            document.getElementById('aiContentKey').value = data.content.content_key;
            
            // Pre-fill prompt with modification request
            const currentContent = data.content.text_content || data.content.html_content || '';
            document.getElementById('aiPrompt').value = `Modifiziere den folgenden Inhalt:\n\n"${currentContent}"\n\nAnpassungen:`;
            
            document.getElementById('aiLoadingIndicator').style.display = 'none';
            document.getElementById('aiPreviewContainer').style.display = 'none';
            document.getElementById('saveAiContentBtn').style.display = 'none';
            
            // Store the content ID for updating instead of creating new
            currentAiContent = { contentId: contentId };
            
            aiContentModal.show();
        } else {
            alert('Fehler beim Laden der Inhalte: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Laden der Inhalte');
    });
}

// Visual Editor Functions
function initializePreviewFrame() {
    if (!previewFrame || !previewFrame.contentWindow) return;
    
    try {
        const frameDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
    
    // Inject edit mode styles into iframe
    const editStyles = `
        <style id="editorStyles">
            .editable-element {
                position: relative !important;
                transition: all 0.3s ease !important;
            }
            
            .editable-container {
                position: relative !important;
                transition: all 0.3s ease !important;
            }
            
            .edit-mode .editable-element,
            .edit-mode .editable-container {
                cursor: pointer !important;
                min-height: 20px !important;
            }
            
            .edit-mode .editable-element:hover {
                outline: 2px dashed #667eea !important;
                outline-offset: 2px !important;
                background: rgba(102, 126, 234, 0.1) !important;
            }
            
            .edit-mode .editable-container:hover {
                outline: 2px dashed #f59e0b !important;
                outline-offset: 4px !important;
                background: rgba(245, 158, 11, 0.05) !important;
            }
            
            .edit-mode .editable-container:hover::after {
                content: "Container - Mit KI bearbeiten" !important;
                position: absolute !important;
                top: -30px !important;
                left: 0 !important;
                background: #f59e0b !important;
                color: white !important;
                padding: 4px 8px !important;
                border-radius: 4px !important;
                font-size: 12px !important;
                white-space: nowrap !important;
                z-index: 1000 !important;
                pointer-events: none !important;
            }
            
            /* Header and Footer specific styles */
            .edit-mode #custom-header .editable-element:hover {
                outline: 2px dashed #28a745 !important;
                outline-offset: 2px !important;
                background: rgba(40, 167, 69, 0.1) !important;
            }
            
            .edit-mode #custom-footer .editable-element:hover {
                outline: 2px dashed #dc3545 !important;
                outline-offset: 2px !important;
                background: rgba(220, 53, 69, 0.1) !important;
            }
            
            .edit-mode #custom-header .editable-element:hover::after {
                content: "Header Element" !important;
                position: absolute !important;
                top: -25px !important;
                left: 0 !important;
                background: #28a745 !important;
                color: white !important;
                padding: 3px 6px !important;
                border-radius: 3px !important;
                font-size: 11px !important;
                white-space: nowrap !important;
                z-index: 1000 !important;
                pointer-events: none !important;
            }
            
            .edit-mode #custom-footer .editable-element:hover::after {
                content: "Footer Element" !important;
                position: absolute !important;
                top: -25px !important;
                left: 0 !important;
                background: #dc3545 !important;
                color: white !important;
                padding: 3px 6px !important;
                border-radius: 3px !important;
                font-size: 11px !important;
                white-space: nowrap !important;
                z-index: 1000 !important;
                pointer-events: none !important;
            }
            
            .edit-mode .editable-element:hover::after {
                content: attr(data-edit-hint) !important;
                position: absolute !important;
                top: -30px !important;
                left: 0 !important;
                background: #667eea !important;
                color: white !important;
                padding: 4px 8px !important;
                border-radius: 4px !important;
                font-size: 12px !important;
                z-index: 1000 !important;
                white-space: nowrap !important;
                pointer-events: none !important;
            }
            
            /* Element controls for individual elements */
            .element-controls {
                position: absolute !important;
                top: -35px !important;
                right: 0 !important;
                background: #667eea !important;
                border-radius: 4px !important;
                padding: 4px !important;
                display: none !important;
                z-index: 1001 !important;
                transition: opacity 0.2s ease !important;
            }
            
            .element-controls::before {
                content: "" !important;
                position: absolute !important;
                top: 100% !important;
                left: 0 !important;
                right: 0 !important;
                height: 10px !important;
                background: transparent !important;
            }
            
            .edit-mode .editable-element:hover .element-controls,
            .edit-mode .element-controls:hover {
                display: flex !important;
                gap: 4px !important;
            }
            
            .element-controls button {
                background: white !important;
                border: none !important;
                padding: 4px 6px !important;
                border-radius: 3px !important;
                cursor: pointer !important;
                font-size: 10px !important;
                line-height: 1 !important;
                color: #333 !important;
            }
            
            .element-controls button:hover {
                background: #f3f4f6 !important;
            }
            
            .element-controls .delete-btn {
                background: #dc3545 !important;
                color: white !important;
            }
            
            .element-controls .delete-btn:hover {
                background: #c82333 !important;
            }
            
            .edit-mode .editable-container.dragging {
                opacity: 0.5 !important;
                cursor: move !important;
            }
            
            .edit-mode .drop-indicator {
                position: absolute !important;
                left: 0 !important;
                right: 0 !important;
                height: 4px !important;
                background: #f59e0b !important;
                z-index: 999 !important;
            }
            
            .editable-element.editing,
            .editable-container.editing {
                outline: 2px solid #28a745 !important;
                outline-offset: 2px !important;
            }
            
            /* Container controls */
            .container-controls {
                position: absolute !important;
                top: -35px !important;
                right: 0 !important;
                background: #667eea !important;
                border-radius: 4px !important;
                padding: 4px !important;
                display: none !important;
                z-index: 1001 !important;
                transition: opacity 0.2s ease !important;
            }
            
            .container-controls::before {
                content: "" !important;
                position: absolute !important;
                top: 100% !important;
                left: 0 !important;
                right: 0 !important;
                height: 10px !important;
                background: transparent !important;
            }
            
            .edit-mode .editable-container:hover .container-controls,
            .edit-mode .container-controls:hover {
                display: flex !important;
                gap: 4px !important;
            }
            
            .container-controls button {
                background: white !important;
                border: none !important;
                padding: 4px 8px !important;
                border-radius: 3px !important;
                cursor: pointer !important;
                font-size: 12px !important;
            }
            
            .container-controls button:hover {
                background: #f3f4f6 !important;
            }
            
            .container-controls .delete-btn {
                background: #dc3545 !important;
                color: white !important;
            }
            
            .container-controls .delete-btn:hover {
                background: #c82333 !important;
            }
            
            /* Plus buttons between elements */
            .insert-element-btn {
                position: relative !important;
                display: none !important;
                width: 100% !important;
                height: 40px !important;
                background: rgba(102, 126, 234, 0.1) !important;
                border: 2px dashed #667eea !important;
                border-radius: 8px !important;
                margin: 10px 0 !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                z-index: 1000 !important;
            }
            
            .insert-element-btn:hover {
                background: rgba(102, 126, 234, 0.2) !important;
                border-color: #5a67d8 !important;
                transform: scale(1.02) !important;
            }
            
            .insert-element-btn::before {
                content: "+" !important;
                position: absolute !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                font-size: 20px !important;
                color: #667eea !important;
                font-weight: bold !important;
            }
            
            .insert-element-btn::after {
                content: "Element hinzuf√ºgen" !important;
                position: absolute !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                margin-left: 25px !important;
                font-size: 12px !important;
                color: #667eea !important;
                white-space: nowrap !important;
            }
            
            .edit-mode .insert-element-btn {
                display: block !important;
            }
            
            /* Pinned controls (stay visible when clicked) */
            .container-controls.pinned,
            .element-controls.pinned {
                display: flex !important;
                opacity: 1 !important;
            }
            
            .container-controls.pinned,
            .element-controls.pinned {
                animation: fadeInScale 0.2s ease !important;
            }
            
            @keyframes fadeInScale {
                from {
                    opacity: 0.8;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }
        </style>
    `;
    
        // Add styles to iframe head
        if (frameDoc.head) {
            frameDoc.head.insertAdjacentHTML('beforeend', editStyles);
        }
        
        // Make functions available to iframe
        previewFrame.contentWindow.deleteElement = function(contentId) {
            window.parent.deleteElement(contentId);
        };
        previewFrame.contentWindow.deleteContainer = function(contentId) {
            window.parent.deleteContainer(contentId);
        };
        previewFrame.contentWindow.editElement = function(contentId) {
            window.parent.editElement(contentId);
        };
        previewFrame.contentWindow.editContainer = function(contentId) {
            window.parent.editContainer(contentId);
        };
        previewFrame.contentWindow.moveContainer = function(container, direction) {
            window.parent.moveContainer(container, direction);
        };
        previewFrame.contentWindow.editStaticContainer = function(staticId) {
            window.parent.editStaticContainer(staticId);
        };
        previewFrame.contentWindow.deleteStaticContainer = function(staticId) {
            window.parent.deleteStaticContainer(staticId);
        };
        
        // Add click handlers to editable elements in iframe
        setupIframeEditHandlers();
    } catch (error) {
        console.warn('Could not access iframe content:', error.message);
        // Disable visual editor mode if iframe access fails
        document.getElementById('toggleEditMode').style.display = 'none';
    }
}

function setupIframeEditHandlers() {
    if (!previewFrame || !previewFrame.contentWindow) return;
    
    try {
        const frameDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
        
        // Setup all editable elements (including header and footer)
        const editableElements = frameDoc.querySelectorAll('[data-editable-key]');
        
        // Setup editable elements
        editableElements.forEach(element => {
            element.classList.add('editable-element');
            
            // Add edit hint based on element type and location
            const contentType = element.dataset.editableType || 'text';
            const isInHeader = element.closest('#custom-header');
            const isInFooter = element.closest('#custom-footer');
            
            let hint = 'Klicken zum Bearbeiten';
            
            if (isInHeader) {
                hint = 'Header ' + hint.toLowerCase();
            } else if (isInFooter) {
                hint = 'Footer ' + hint.toLowerCase();
            }
            
            if (contentType === 'button_text') {
                hint = hint.replace('bearbeiten', 'Button bearbeiten');
            } else if (contentType === 'image') {
                hint = hint.replace('bearbeiten', 'Bild bearbeiten');
            } else if (contentType === 'hero_title' || contentType === 'section_title') {
                hint = hint.replace('bearbeiten', 'Titel bearbeiten');
            } else if (contentType === 'html_block' || contentType === 'ai_generated') {
                hint = hint.replace('bearbeiten', 'HTML Block bearbeiten');
            }
            
            element.setAttribute('data-edit-hint', hint);
            
            // Add element controls
            const elementControls = frameDoc.createElement('div');
            elementControls.className = 'element-controls';
            elementControls.innerHTML = `
                <button type="button" onclick="editElement('${element.dataset.editableId}')">‚úèÔ∏è</button>
                <button type="button" class="delete-btn" onclick="deleteElement('${element.dataset.editableId}')">√ó</button>
            `;
            
            // Make sure element has relative positioning for controls
            const computedStyle = frameDoc.defaultView.getComputedStyle(element);
            if (computedStyle.position === 'static') {
                element.style.position = 'relative';
            }
            
            element.appendChild(elementControls);
            
            element.addEventListener('click', function(e) {
                if (visualEditMode) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleIframeElementEdit(this);
                }
            });
            
            // Add control pinning behavior for elements
            const existingElementControls = element.querySelector('.element-controls');
            if (existingElementControls) {
                element.addEventListener('mouseenter', function() {
                    if (visualEditMode) {
                        existingElementControls.classList.add('pinned');
                        // Auto-unpin after 3 seconds if no interaction
                        clearTimeout(element.unpinTimer);
                        element.unpinTimer = setTimeout(() => {
                            existingElementControls.classList.remove('pinned');
                        }, 3000);
                    }
                });
                
                existingElementControls.addEventListener('mouseenter', function() {
                    // Keep pinned while hovering controls
                    clearTimeout(element.unpinTimer);
                });
                
                existingElementControls.addEventListener('mouseleave', function() {
                    // Unpin after leaving controls
                    element.unpinTimer = setTimeout(() => {
                        existingElementControls.classList.remove('pinned');
                    }, 500);
                });
            }
        });
        
        // Setup container handling
        setupContainerHandling(frameDoc);
        
    } catch (error) {
        console.warn('Could not set up iframe edit handlers:', error.message);
    }
}

function setupContainerHandling(frameDoc) {
    // Find all sections/containers that group editable content AND static content
    const containers = frameDoc.querySelectorAll('.row, .col-lg-4, .col-md-6, .col-md-4, .feature-card, .testimonial-card, section, .card, .hero-section, .community-section, .bg-light');
    
    containers.forEach(container => {
        // Make ALL containers editable, not just those with editable content
        container.classList.add('editable-container');
        container.setAttribute('draggable', 'true');
        
        // Add container controls
        const containerControls = frameDoc.createElement('div');
        containerControls.className = 'container-controls';
        
        // Find the first editable content in this container for ID reference
        const editableContent = container.querySelector('[data-editable-id]');
        const contentId = editableContent ? editableContent.dataset.editableId : '';
        
        // Special handling for static content without editable IDs
        if (!contentId) {
            // Create a unique identifier for static containers
            const staticId = 'static_' + Math.random().toString(36).substr(2, 9);
            container.setAttribute('data-static-id', staticId);
            
            containerControls.innerHTML = `
                <button type="button" onclick="editStaticContainer('${staticId}')">‚úèÔ∏è</button>
                <button type="button" onclick="moveContainer(this.parentElement.parentElement, 'up')">‚Üë</button>
                <button type="button" onclick="moveContainer(this.parentElement.parentElement, 'down')">‚Üì</button>
                <button type="button" class="delete-btn" onclick="deleteStaticContainer('${staticId}')">√ó</button>
            `;
        } else {
            containerControls.innerHTML = `
                <button type="button" onclick="editContainer('${contentId}')">‚úèÔ∏è</button>
                <button type="button" onclick="moveContainer(this.parentElement.parentElement, 'up')">‚Üë</button>
                <button type="button" onclick="moveContainer(this.parentElement.parentElement, 'down')">‚Üì</button>
                <button type="button" class="delete-btn" onclick="deleteContainer('${contentId}')">√ó</button>
            `;
        }
        container.appendChild(containerControls);
            
        // Add click listener for container editing
        container.addEventListener('click', function(e) {
            if (visualEditMode) {
                e.preventDefault();
                e.stopPropagation();
                
                // Check if this container has editable content with AI capabilities
                const editableContent = this.querySelector('[data-editable-type="html_block"], [data-editable-type="ai_generated"]');
                if (editableContent && editableContent.isConnected) {
                    const contentId = editableContent.dataset.editableId;
                    if (contentId) {
                        // Verify content still exists by checking if element has valid data
                        showAiEditModal(contentId, editableContent);
                    }
                } else {
                    // For static containers, show static editing modal
                    const staticId = this.getAttribute('data-static-id');
                    if (staticId) {
                        showStaticContainerEditModal(this, staticId);
                    } else {
                        showContainerAiEditModal(this);
                    }
                }
            }
        });
        
        // Add drag event listeners
        container.addEventListener('dragstart', handleContainerDragStart);
        container.addEventListener('dragover', handleContainerDragOver);
        container.addEventListener('drop', handleContainerDrop);
        container.addEventListener('dragend', handleContainerDragEnd);
        
        // Add control pinning behavior
        const controls = container.querySelector('.container-controls');
        if (controls) {
            container.addEventListener('mouseenter', function() {
                if (visualEditMode) {
                    controls.classList.add('pinned');
                    // Auto-unpin after 3 seconds if no interaction
                    clearTimeout(container.unpinTimer);
                    container.unpinTimer = setTimeout(() => {
                        controls.classList.remove('pinned');
                    }, 3000);
                }
            });
            
            controls.addEventListener('mouseenter', function() {
                // Keep pinned while hovering controls
                clearTimeout(container.unpinTimer);
            });
            
            controls.addEventListener('mouseleave', function() {
                // Unpin after leaving controls
                container.unpinTimer = setTimeout(() => {
                    controls.classList.remove('pinned');
                }, 500);
            });
        }
    });
    
    // Add plus buttons between containers
    addInsertButtons(frameDoc);
}

function addInsertButtons(frameDoc) {
    // Check current page context for header/footer editing
    const currentPage = '{{ page }}';
    
    // Add insert buttons for header area
    if (currentPage === 'header') {
        const headerContainer = frameDoc.getElementById('custom-header');
        if (headerContainer) {
            addInsertButtonForArea(frameDoc, headerContainer, 'header');
        }
    }
    
    // Add insert buttons for footer area
    if (currentPage === 'footer') {
        const footerContainer = frameDoc.getElementById('custom-footer');
        if (footerContainer) {
            addInsertButtonForArea(frameDoc, footerContainer, 'footer');
        }
    }
    
    // Original logic for main content containers
    const mainContainers = frameDoc.querySelectorAll('.row, .hero-section, .community-section, .bg-light, .text-center.my-5');
    
    mainContainers.forEach((container, index) => {
        // Skip if this is inside header/footer when not editing those areas
        if (currentPage !== 'header' && container.closest('#custom-header')) return;
        if (currentPage !== 'footer' && container.closest('#custom-footer')) return;
        
        // Skip if this is inside another container (nested)
        const isNested = container.closest('.row, .hero-section, .community-section') !== container;
        if (isNested && !container.classList.contains('hero-section') && !container.classList.contains('community-section')) {
            return;
        }
        
        // Add insert button after each main container (except the last one)
        if (index < mainContainers.length - 1 || container !== mainContainers[mainContainers.length - 1]) {
            const insertBtn = frameDoc.createElement('div');
            insertBtn.className = 'insert-element-btn';
            insertBtn.setAttribute('data-insert-after', index);
            
            // Add click handler
            insertBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (visualEditMode) {
                    showInsertElementModal(index);
                }
            });
            
            // Insert the button after the current container
            if (container.nextSibling) {
                container.parentNode.insertBefore(insertBtn, container.nextSibling);
            } else {
                container.parentNode.appendChild(insertBtn);
            }
        }
    });
    
    // Also add insert buttons within containers (between child elements)
    const containerRows = frameDoc.querySelectorAll('.row');
    containerRows.forEach(row => {
        const columns = row.querySelectorAll('.col-lg-4, .col-md-6, .col-md-4');
        columns.forEach((col, index) => {
            if (index < columns.length - 1) {
                // Add insert button between columns
                const insertBtn = frameDoc.createElement('div');
                insertBtn.className = 'insert-element-btn';
                insertBtn.style.width = 'calc(100% - 20px)';
                insertBtn.style.margin = '10px auto';
                insertBtn.setAttribute('data-insert-between-cols', index);
                
                insertBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (visualEditMode) {
                        showInsertElementModal(`col_${index}`);
                    }
                });
                
                if (col.nextSibling) {
                    col.parentNode.insertBefore(insertBtn, col.nextSibling);
                } else {
                    col.parentNode.appendChild(insertBtn);
                }
            }
        });
    });
}

let draggedContainer = null;

function handleContainerDragStart(e) {
    if (!visualEditMode) return;
    draggedContainer = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleContainerDragOver(e) {
    if (!visualEditMode || !draggedContainer) return;
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function handleContainerDrop(e) {
    if (!visualEditMode || !draggedContainer) return;
    e.preventDefault();
    
    if (draggedContainer !== this) {
        // Simple swap - insert dragged element before this element
        this.parentElement.insertBefore(draggedContainer, this);
        console.log('Container reordered - would save to backend');
    }
}

function handleContainerDragEnd(e) {
    if (!visualEditMode) return;
    this.classList.remove('dragging');
    draggedContainer = null;
}

function handleIframeElementEdit(element) {
    // Check if element is still connected to DOM
    if (!element || !element.isConnected) {
        console.warn('Element is no longer in the DOM, skipping edit');
        return;
    }
    
    const contentId = element.dataset.editableId;
    const contentKey = element.dataset.editableKey;
    const contentType = element.dataset.editableType;
    
    // Validate element data
    if (!contentId || !contentKey || !contentType) {
        console.warn('Element missing required data attributes, skipping edit');
        return;
    }
    
    try {
        // Mark element as editing
        const frameDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
        frameDoc.querySelectorAll('.editable-element').forEach(el => el.classList.remove('editing'));
        element.classList.add('editing');
    } catch (error) {
        console.warn('Could not mark element as editing:', error.message);
    }
    
    // Open edit modal with current content
    if (contentId) {
        // For buttons and special elements, open specialized editor
        if (contentType === 'button_text' || contentType === 'html_block' || contentType === 'ai_generated') {
            openSpecializedEditor(element, contentId, contentKey, contentType);
        } else {
            editContent(contentId);
        }
    }
}

function openSpecializedEditor(element, contentId, contentKey, contentType) {
    if (contentType === 'button_text') {
        // Open AI edit modal for buttons
        showAiEditModal(contentId, element);
    } else if (contentType === 'html_block' || contentType === 'ai_generated') {
        // Open AI edit modal for containers
        showAiEditModal(contentId, element);
    } else {
        // Fallback to regular edit
        editContent(contentId);
    }
}

// KI Container/Element Bearbeitung
function showAiEditModal(contentId, element = null) {
    // Check if content still exists before opening modal
    if (!contentId) {
        console.warn('No content ID provided to AI edit modal');
        return;
    }
    
    // Verify element still exists and has a valid content ID
    if (element && (!element.dataset || !element.dataset.editableId)) {
        console.warn('Element has no valid content ID, skipping AI edit modal');
        return;
    }
    
    // Double-check that the element is still in the DOM
    if (element && !element.isConnected) {
        console.warn('Element is no longer in the DOM, skipping AI edit modal');
        return;
    }
    
    document.getElementById('aiEditContentId').value = contentId;
    document.getElementById('aiStructurePrompt').value = '';
    document.getElementById('aiStylePrompt').value = '';
    
    // Load current content to show preview
    if (element) {
        const previewDiv = document.getElementById('currentElementPreview');
        previewDiv.innerHTML = element.outerHTML;
        document.getElementById('aiEditPreview').style.display = 'block';
    } else {
        document.getElementById('aiEditPreview').style.display = 'none';
    }
    
    aiEditModal.show();
}

// Process AI editing request
function processAiEdit() {
    const contentId = document.getElementById('aiEditContentId').value;
    const structurePrompt = document.getElementById('aiStructurePrompt').value;
    const stylePrompt = document.getElementById('aiStylePrompt').value;
    
    if (!structurePrompt.trim() && !stylePrompt.trim()) {
        alert('Bitte geben Sie mindestens eine Struktur- oder Style-√Ñnderung an.');
        return;
    }
    
    const btn = document.getElementById('aiEditBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>KI arbeitet...';
    btn.disabled = true;
    
    const formData = new FormData();
    formData.append('content_id', contentId);
    formData.append('structure_prompt', structurePrompt);
    formData.append('style_prompt', stylePrompt);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    fetch('{% url "accounts:ai_edit_content" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            aiEditModal.hide();
            refreshPreview();
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <i class="fas fa-check me-2"></i>Element erfolgreich mit KI bearbeitet!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        } else {
            alert('Fehler beim Bearbeiten mit KI: ' + (data.error || 'Unbekannter Fehler'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Bearbeiten mit KI');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Text-Umformulierung
function showAiRephraseModal() {
    const btn = document.getElementById('aiRephraseBtnModal');
    const contentId = btn.getAttribute('data-content-id');
    const currentText = btn.getAttribute('data-current-text');
    
    document.getElementById('aiRephraseContentId').value = contentId;
    document.getElementById('currentTextDisplay').textContent = currentText;
    document.getElementById('rephrasePrompt').value = '';
    
    contentModal.hide(); // Hide the edit modal
    aiRephraseModal.show();
}

// Process AI text rephrasing
function processAiRephrase() {
    const contentId = document.getElementById('aiRephraseContentId').value;
    const rephrasePrompt = document.getElementById('rephrasePrompt').value;
    
    const btn = document.getElementById('aiRephraseBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>KI arbeitet...';
    btn.disabled = true;
    
    const formData = new FormData();
    formData.append('content_id', contentId);
    formData.append('rephrase_prompt', rephrasePrompt);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    fetch('{% url "accounts:ai_rephrase_content" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            aiRephraseModal.hide();
            
            // Update the text content field in the main modal
            document.getElementById('textContent').value = data.new_text;
            
            // Show the main modal again
            contentModal.show();
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <i class="fas fa-check me-2"></i>Text erfolgreich umformuliert! Jetzt speichern.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 4000);
        } else {
            alert('Fehler beim Umformulieren: ' + (data.error || 'Unbekannter Fehler'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Umformulieren des Textes');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Enhanced click handler for iframe elements
function handleIframeClick(element) {
    if (!visualEditMode) return;
    
    const contentType = element.dataset.editableType;
    const contentId = element.dataset.editableId;
    
    // For containers and complex elements, show AI edit modal
    if (contentType === 'html_block' || contentType === 'ai_generated' || 
        element.tagName.toLowerCase() === 'div' || element.classList.contains('container')) {
        showAiEditModal(contentId, element);
    } else {
        // For text elements, show regular edit modal
        handleIframeElementEdit(element);
    }
}

// Show AI edit modal for containers without specific content
function showContainerAiEditModal(containerElement) {
    // For containers without specific editable content, show the proper AI edit modal
    // This should be used for EDITING existing containers, not creating new ones
    
    // Show a warning that this container doesn't have editable content
    const modalHtml = `
        <div class="modal fade" id="containerActionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Container bearbeiten</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Dieser Container hat noch keine bearbeitbaren Inhalte.
                        </div>
                        <p>Was m√∂chten Sie tun?</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="convertContainerToEditable()">
                                <i class="fas fa-magic me-2"></i>Container in bearbeitbaren Inhalt umwandeln
                            </button>
                            <button class="btn btn-outline-secondary" onclick="addContentToContainer()">
                                <i class="fas fa-plus me-2"></i>Neuen Inhalt in diesem Container hinzuf√ºgen
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('containerActionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('containerActionModal'));
    modal.show();
}

// Functions for static container handling
function editStaticContainer(staticId) {
    const container = document.querySelector(`iframe`).contentDocument.querySelector(`[data-static-id="${staticId}"]`);
    if (container) {
        showStaticContainerEditModal(container, staticId);
    }
}

function deleteStaticContainer(staticId) {
    if (confirm('Sind Sie sicher, dass Sie diesen Bereich l√∂schen m√∂chten? Dies entfernt nur die Bearbeitbarkeit, nicht den eigentlichen Inhalt.')) {
        const container = document.querySelector(`iframe`).contentDocument.querySelector(`[data-static-id="${staticId}"]`);
        if (container) {
            // Remove editable functionality
            container.classList.remove('editable-container');
            const controls = container.querySelector('.container-controls');
            if (controls) {
                controls.remove();
            }
        }
    }
}

function showStaticContainerEditModal(containerElement, staticId) {
    // For static containers, show information and options to convert to editable
    const modalHtml = `
        <div class="modal fade" id="staticEditModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Statischen Bereich bearbeiten</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Dies ist ein statischer Bereich der Seite. Sie k√∂nnen:
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="convertToEditableContent('${staticId}')">
                                <i class="fas fa-magic me-2"></i>In bearbeitbaren Inhalt umwandeln
                            </button>
                            <button class="btn btn-outline-secondary" onclick="duplicateAsEditableContent('${staticId}')">
                                <i class="fas fa-copy me-2"></i>Als bearbeitbaren Inhalt duplizieren
                            </button>
                        </div>
                        <hr>
                        <small class="text-muted">
                            <strong>Hinweis:</strong> Statische Bereiche sind Teil des Template-Codes und k√∂nnen nicht direkt bearbeitet werden.
                        </small>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('staticEditModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('staticEditModal'));
    modal.show();
}

function convertToEditableContent(staticId) {
    const container = document.querySelector(`iframe`).contentDocument.querySelector(`[data-static-id="${staticId}"]`);
    if (container) {
        // Get the container's HTML content
        const htmlContent = container.innerHTML;
        
        // Generate a unique content key
        const contentKey = `converted_${staticId}_${Date.now()}`;
        
        // Get current page from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const currentPage = urlParams.get('page') || 'startseite';
        
        // Create FormData for the request
        const formData = new FormData();
        formData.append('content_key', contentKey);
        formData.append('content_type', 'html_block');
        formData.append('html_content', htmlContent);
        formData.append('text_content', '');
        formData.append('page', currentPage);
        formData.append('is_active', 'true');
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        // Send AJAX request to create editable content
        fetch('{% url "accounts:update_content" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Replace static container with editable content
                container.setAttribute('data-editable-id', data.content_id);
                container.setAttribute('data-editable-key', contentKey);
                container.setAttribute('data-editable-type', 'html_block');
                container.removeAttribute('data-static-id');
                
                // Add editable styling
                container.classList.add('editable-content');
                
                // Refresh the iframe to show updated content
                reloadIframe();
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('staticEditModal')).hide();
                
                // Show success message
                alert('Inhalt wurde erfolgreich in bearbeitbaren Inhalt umgewandelt!');
            } else {
                alert('Fehler beim Umwandeln des Inhalts: ' + (data.error || 'Unbekannter Fehler'));
            }
        })
        .catch(error => {
            console.error('Error converting to editable content:', error);
            alert('Fehler beim Umwandeln des Inhalts.');
        });
    }
}

function duplicateAsEditableContent(staticId) {
    // Similar to convert, but keeps the original
    convertToEditableContent(staticId);
}

// Container action functions
function convertContainerToEditable() {
    // Close container action modal
    bootstrap.Modal.getInstance(document.getElementById('containerActionModal')).hide();
    
    // Open AI content generator for creating NEW content
    document.getElementById('aiContentKey').value = 'converted_container_' + Date.now();
    document.getElementById('aiPrompt').value = 'Erstellen Sie einen bearbeitbaren Inhalt basierend auf dem bestehenden Container...';
    document.getElementById('aiHints').value = 'Container-Konvertierung';
    
    aiContentModal.show();
}

function addContentToContainer() {
    // Close container action modal
    bootstrap.Modal.getInstance(document.getElementById('containerActionModal')).hide();
    
    // Open the standard add content modal (NOT the AI generator)
    showAddContentModal();
}

// Insert element modal function
function showInsertElementModal(position) {
    // Store the insertion position for later use
    window.currentInsertPosition = position;
    
    // Create insert element modal
    const insertModalHtml = `
        <div class="modal fade" id="insertElementModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-plus me-2"></i>Neues Element hinzuf√ºgen
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Element wird an Position <strong>${position}</strong> eingef√ºgt
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card h-100 insert-option" onclick="insertQuickElement('text')">
                                    <div class="card-body text-center">
                                        <i class="fas fa-font fa-2x text-primary mb-2"></i>
                                        <h6>Text</h6>
                                        <small class="text-muted">Einfacher Textbereich</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 insert-option" onclick="insertQuickElement('title')">
                                    <div class="card-body text-center">
                                        <i class="fas fa-heading fa-2x text-success mb-2"></i>
                                        <h6>Titel</h6>
                                        <small class="text-muted">√úberschrift</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 insert-option" onclick="insertQuickElement('image')">
                                    <div class="card-body text-center">
                                        <i class="fas fa-image fa-2x text-warning mb-2"></i>
                                        <h6>Bild</h6>
                                        <small class="text-muted">Bild hochladen</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 insert-option" onclick="insertQuickElement('button')">
                                    <div class="card-body text-center">
                                        <i class="fas fa-hand-pointer fa-2x text-info mb-2"></i>
                                        <h6>Button</h6>
                                        <small class="text-muted">Klickbarer Button</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card insert-option" onclick="insertAiElement()">
                                    <div class="card-body text-center">
                                        <i class="fas fa-robot fa-2x text-purple mb-2"></i>
                                        <h6>Mit KI erstellen</h6>
                                        <small class="text-muted">Lassen Sie die KI ein komplettes Element erstellen</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('insertElementModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', insertModalHtml);
    
    // Add CSS for insert options
    const style = document.createElement('style');
    style.textContent = `
        .insert-option {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .insert-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .text-purple {
            color: #8b5cf6 !important;
        }
    `;
    document.head.appendChild(style);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('insertElementModal'));
    modal.show();
}

// Quick element insertion functions
function insertQuickElement(elementType) {
    const position = window.currentInsertPosition;
    let contentKey = `${elementType}_${Date.now()}`;
    let contentType = elementType;
    let defaultContent = '';
    
    switch(elementType) {
        case 'text':
            contentType = 'text';
            defaultContent = 'Ihr Text hier...';
            break;
        case 'title':
            contentType = 'section_title';
            defaultContent = 'Neue √úberschrift';
            break;
        case 'image':
            contentType = 'image';
            defaultContent = '';
            break;
        case 'button':
            contentType = 'button_text';
            defaultContent = 'Klicken Sie hier';
            break;
    }
    
    // Close insert modal
    bootstrap.Modal.getInstance(document.getElementById('insertElementModal')).hide();
    
    // Open content editor with pre-filled data
    document.getElementById('contentModalTitle').textContent = 'Neues Element hinzuf√ºgen';
    document.getElementById('contentForm').reset();
    document.getElementById('contentId').value = '';
    document.getElementById('modalPage').value = '{{ page }}';
    document.getElementById('contentKey').value = contentKey;
    document.getElementById('contentType').value = contentType;
    document.getElementById('textContent').value = defaultContent;
    
    // Set sort order based on position
    if (typeof position === 'number') {
        document.getElementById('sortOrder').value = (position + 1) * 10;
    }
    
    toggleContentFields();
    contentModal.show();
}

function insertAiElement() {
    const position = window.currentInsertPosition;
    
    // Close insert modal
    bootstrap.Modal.getInstance(document.getElementById('insertElementModal')).hide();
    
    // Open AI content modal with pre-filled data
    document.getElementById('aiContentKey').value = `ai_element_${Date.now()}`;
    document.getElementById('aiPrompt').value = '';
    document.getElementById('aiHints').value = `Position: ${position}`;
    
    aiContentModal.show();
}

// Element and Container deletion functions
function deleteElement(contentId) {
    if (!contentId) {
        alert('Element-ID nicht gefunden');
        return;
    }
    
    if (confirm('Sind Sie sicher, dass Sie dieses Element l√∂schen m√∂chten?')) {
        performContentDeletion(contentId);
    }
}

function deleteContainer(contentId) {
    if (!contentId) {
        alert('Container-ID nicht gefunden');
        return;
    }
    
    if (confirm('Sind Sie sicher, dass Sie diesen Container l√∂schen m√∂chten?')) {
        performContentDeletion(contentId);
    }
}

function editElement(contentId) {
    if (contentId) {
        editContent(contentId);
    }
}

function editContainer(contentId) {
    if (contentId) {
        showAiEditModal(contentId);
    }
}

function performContentDeletion(contentId) {
    const formData = new FormData();
    formData.append('content_id', contentId);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    fetch('{% url "accounts:delete_content" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Temporarily disable visual edit mode to prevent click events during refresh
            const wasVisualEditMode = visualEditMode;
            if (visualEditMode) {
                visualEditMode = false;
            }
            
            // Refresh the preview to show the deletion
            refreshPreview();
            
            // Re-enable visual edit mode after a short delay to allow page to load
            if (wasVisualEditMode) {
                setTimeout(() => {
                    visualEditMode = true;
                }, 500);
            }
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <i class="fas fa-check me-2"></i>Element erfolgreich gel√∂scht!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
            
            // Also update the list view if it's active
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab && activeTab.id === 'list-tab') {
                setTimeout(() => location.reload(), 500);
            }
        } else {
            alert('Fehler beim L√∂schen: ' + (data.error || 'Unbekannter Fehler'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim L√∂schen des Elements');
    });
}

// Container movement functions
function moveContainer(container, direction) {
    const parent = container.parentElement;
    const containers = Array.from(parent.children).filter(child => 
        child.classList.contains('editable-container')
    );
    
    const currentIndex = containers.indexOf(container);
    
    if (direction === 'up' && currentIndex > 0) {
        parent.insertBefore(container, containers[currentIndex - 1]);
        updateContainerOrder();
    } else if (direction === 'down' && currentIndex < containers.length - 1) {
        parent.insertBefore(containers[currentIndex + 1], container);
        updateContainerOrder();
    }
}

function updateContainerOrder() {
    // This would update the sort_order in the backend
    console.log('Container order updated - would save to backend');
}

// Make functions globally available for iframe access
window.deleteElement = deleteElement;
window.deleteContainer = deleteContainer;
window.editElement = editElement;
window.editContainer = editContainer;
window.moveContainer = moveContainer;
window.editStaticContainer = editStaticContainer;
window.deleteStaticContainer = deleteStaticContainer;
window.convertToEditableContent = convertToEditableContent;
window.duplicateAsEditableContent = duplicateAsEditableContent;
window.showInsertElementModal = showInsertElementModal;
window.insertQuickElement = insertQuickElement;
window.insertAiElement = insertAiElement;
window.convertContainerToEditable = convertContainerToEditable;
window.addContentToContainer = addContentToContainer;

function updateContentQuick(contentId, field, value) {
    const formData = new FormData();
    formData.append('content_id', contentId);
    formData.append(field, value);
    formData.append('page', '{{ page }}');
    
    fetch('{% url "accounts:update_content" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            refreshPreview();
        } else {
            alert('Fehler: ' + data.error);
        }
    });
}

function toggleVisualEditMode() {
    visualEditMode = !visualEditMode;
    const toggleBtn = document.getElementById('sidebarToggleEditMode');
    
    try {
        const frameDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
        
        if (visualEditMode) {
            toggleBtn.innerHTML = '<i class="fas fa-eye me-1"></i>Bearbeiten deaktivieren';
            toggleBtn.classList.remove('btn-outline-primary');
            toggleBtn.classList.add('btn-warning');
            frameDoc.body.classList.add('edit-mode');
        } else {
            toggleBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Bearbeiten aktivieren';
            toggleBtn.classList.remove('btn-warning');
            toggleBtn.classList.add('btn-outline-primary');
            frameDoc.body.classList.remove('edit-mode');
            
            // Remove editing state from all elements
            frameDoc.querySelectorAll('.editable-element').forEach(el => el.classList.remove('editing'));
        }
    } catch (error) {
        console.warn('Could not toggle visual edit mode:', error.message);
        // Still update button appearance even if iframe access fails
        if (visualEditMode) {
            toggleBtn.innerHTML = '<i class="fas fa-eye me-1"></i>Bearbeiten deaktivieren';
            toggleBtn.classList.remove('btn-outline-primary');
            toggleBtn.classList.add('btn-warning');
        } else {
            toggleBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Bearbeiten aktivieren';
            toggleBtn.classList.remove('btn-warning');
            toggleBtn.classList.add('btn-outline-primary');
        }
    }
}

function setPreviewSize(size) {
    const container = document.getElementById('previewContainer');
    const buttons = document.querySelectorAll('.btn-group-vertical .btn');
    
    // Remove active class from all buttons
    buttons.forEach(btn => btn.classList.remove('active'));
    
    // Add active class to clicked button
    const clickedBtn = event.target.closest('.btn');
    if (clickedBtn) {
        clickedBtn.classList.add('active');
    }
    
    // Remove all size classes
    container.classList.remove('mobile', 'tablet', 'desktop');
    
    // Add selected size class
    container.classList.add(size);
}

function refreshPreview() {
    if (previewFrame) {
        // Add timestamp to force refresh
        const baseUrl = previewFrame.src.split('&t=')[0];
        previewFrame.src = baseUrl + '&t=' + Date.now();
    }
}

// Neue Seite Modal
function showNewPageModal() {
    const modal = new bootstrap.Modal(document.getElementById('newPageModal'));
    modal.show();

    // Clear form
    document.getElementById('newPageForm').reset();
}

// Drag & Drop Functions
let draggedElement = null;

document.addEventListener('DOMContentLoaded', function() {
    contentModal = new bootstrap.Modal(document.getElementById('contentModal'));
    aiContentModal = new bootstrap.Modal(document.getElementById('aiContentModal'));
    previewFrame = document.getElementById('previewFrame');
    
    // Initialize drag & drop
    initializeDragAndDrop();
});

function initializeDragAndDrop() {
    const contentList = document.getElementById('contentList');
    if (!contentList) return;
    
    // Add event listeners to existing content items
    updateDragDropHandlers();
}

function updateDragDropHandlers() {
    const contentItems = document.querySelectorAll('.content-item[draggable="true"]');
    
    contentItems.forEach(item => {
        // Remove existing listeners to prevent duplicates
        item.removeEventListener('dragstart', handleDragStart);
        item.removeEventListener('dragover', handleDragOver);
        item.removeEventListener('drop', handleDrop);
        item.removeEventListener('dragend', handleDragEnd);
        item.removeEventListener('dragenter', handleDragEnter);
        item.removeEventListener('dragleave', handleDragLeave);
        
        // Add fresh listeners
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('drop', handleDrop);
        item.addEventListener('dragend', handleDragEnd);
        item.addEventListener('dragenter', handleDragEnter);
        item.addEventListener('dragleave', handleDragLeave);
    });
}

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    if (this !== draggedElement) {
        this.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    if (draggedElement && this !== draggedElement) {
        // Get the bounding rect to determine drop position
        const rect = this.getBoundingClientRect();
        const midpoint = rect.top + rect.height / 2;
        
        if (e.clientY < midpoint) {
            // Insert before this element
            this.parentNode.insertBefore(draggedElement, this);
        } else {
            // Insert after this element
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
        }
        
        // Update sort order in database
        updateSortOrder();
    }
    
    this.classList.remove('drag-over');
    return false;
}

function handleDragEnd(e) {
    // Clean up
    this.classList.remove('dragging');
    document.querySelectorAll('.content-item').forEach(item => {
        item.classList.remove('drag-over');
    });
    draggedElement = null;
}

function updateSortOrder() {
    const contentItems = document.querySelectorAll('.content-item');
    const updates = [];
    
    contentItems.forEach((item, index) => {
        const contentId = item.dataset.contentId;
        if (contentId) {
            updates.push({
                id: parseInt(contentId),
                sort_order: index
            });
        }
    });
    
    // Send update to server
    fetch('{% url "accounts:update_content" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'update_sort_order',
            updates: updates
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Sort order updated successfully');
            // Refresh preview to reflect new order
            refreshPreview();
        } else {
            console.error('Error updating sort order:', data.error);
        }
    })
    .catch(error => {
        console.error('Error updating sort order:', error);
    });
}

// AI Content Functions
function showAiContentModal() {
    document.getElementById('aiContentForm').reset();
    document.getElementById('aiPage').value = '{{ page }}';
    document.getElementById('aiLoadingIndicator').style.display = 'none';
    document.getElementById('aiPreviewContainer').style.display = 'none';
    document.getElementById('saveAiContentBtn').style.display = 'none';
    currentAiContent = null;
    aiContentModal.show();
}

function generateAiContent() {
    const prompt = document.getElementById('aiPrompt').value.trim();
    const hints = document.getElementById('aiHints').value.trim();
    const contentKey = document.getElementById('aiContentKey').value.trim();
    
    if (!prompt) {
        alert('Bitte geben Sie eine Beschreibung ein.');
        return;
    }
    
    if (!contentKey) {
        alert('Bitte geben Sie einen Content-Schl√ºssel ein.');
        return;
    }
    
    // Kombiniere Prompt mit Hints
    const fullPrompt = hints ? `${prompt}\n\nZus√§tzliche Hinweise: ${hints}` : prompt;
    
    // Zeige Loading
    document.getElementById('aiLoadingIndicator').style.display = 'block';
    document.getElementById('aiPreviewContainer').style.display = 'none';
    document.getElementById('generateBtn').disabled = true;
    
    // API Call
    fetch('{% url "accounts:generate_ai_content" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            prompt: fullPrompt,
            content_type: 'ai_generated',
            page: '{{ page }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('aiLoadingIndicator').style.display = 'none';
        document.getElementById('generateBtn').disabled = false;
        
        if (data.success) {
            currentAiContent = {
                html: data.html_content,
                css: data.css_content,
                prompt: data.prompt,
                contentKey: contentKey,
                isDemo: data.is_demo || false
            };
            
            displayAiContent(data.html_content, data.css_content, data.description, data.is_demo);
            document.getElementById('aiPreviewContainer').style.display = 'block';
            document.getElementById('saveAiContentBtn').style.display = 'inline-block';
            
            // Show demo notice if applicable
            if (data.is_demo) {
                showDemoNotice();
            }
        } else {
            // Enhanced error handling
            const errorMessage = data.error || 'Unbekannter Fehler';
            showErrorMessage(errorMessage);
        }
    })
    .catch(error => {
        document.getElementById('aiLoadingIndicator').style.display = 'none';
        document.getElementById('generateBtn').disabled = false;
        console.error('Error:', error);
        alert('Fehler bei der KI-Generierung: ' + error.message);
    });
}

function displayAiContent(html, css, description = '', isDemo = false) {
    // HTML Code anzeigen
    document.getElementById('aiHtmlCode').value = html;
    
    // CSS Code anzeigen
    document.getElementById('aiCssCode').value = css;
    
    // Live Preview erstellen
    const previewDiv = document.getElementById('aiPreview');
    
    // CSS in Style-Tag einbetten
    let styledContent = '';
    if (css) {
        styledContent += `<style>${css}</style>`;
    }
    styledContent += html;
    
    previewDiv.innerHTML = styledContent;
    
    // Show description if available
    if (description) {
        const descDiv = document.getElementById('aiDescription') || createDescriptionDiv();
        descDiv.innerHTML = `<small class="text-muted"><i class="fas fa-info-circle me-1"></i>${description}</small>`;
        descDiv.style.display = 'block';
    }
}

function createDescriptionDiv() {
    const descDiv = document.createElement('div');
    descDiv.id = 'aiDescription';
    descDiv.className = 'mb-3';
    document.getElementById('aiPreviewContainer').insertBefore(descDiv, document.getElementById('aiPreview'));
    return descDiv;
}

function showDemoNotice() {
    const notice = document.createElement('div');
    notice.className = 'alert alert-info alert-dismissible fade show';
    notice.innerHTML = `
        <i class="fas fa-lightbulb me-2"></i>
        <strong>Demo-Modus:</strong> Dies ist ein Beispiel-Inhalt. F√ºr echte KI-Generierung f√ºgen Sie einen API-Key in den 
        <a href="/accounts/api-settings/" target="_blank" class="alert-link">API-Einstellungen</a> hinzu.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.getElementById('aiPreviewContainer').insertBefore(notice, document.getElementById('aiPreview'));
}

function showErrorMessage(errorMessage) {
    // Check if error contains HTML link
    const hasLink = errorMessage.includes('<a href');
    
    if (hasLink) {
        // Create modal with HTML content for links
        const modalHtml = `
            <div class="modal fade" id="aiErrorModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning me-2"></i>KI-Generierung fehlgeschlagen</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>${errorMessage}</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Verstanden</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('aiErrorModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('aiErrorModal'));
        modal.show();
    } else {
        // Simple alert for non-HTML errors
        alert('Fehler bei der KI-Generierung: ' + errorMessage);
    }
}

function saveAiContent() {
    if (!currentAiContent) {
        alert('Kein Content zum Speichern vorhanden.');
        return;
    }
    
    const formData = new FormData();
    formData.append('page', '{{ page }}');
    formData.append('content_key', currentAiContent.contentKey);
    
    // If we're modifying existing content, add the content_id
    if (currentAiContent.contentId) {
        formData.append('content_id', currentAiContent.contentId);
        formData.append('content_type', 'ai_generated'); // Update type to AI generated
    } else {
        formData.append('content_type', 'ai_generated');
        formData.append('sort_order', '0'); // Insert new AI content at the top
    }
    
    formData.append('html_content', currentAiContent.html);
    formData.append('css_content', currentAiContent.css);
    formData.append('ai_prompt', currentAiContent.prompt);
    
    fetch('{% url "accounts:update_content" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            aiContentModal.hide();
            
            // Refresh the preview iframe
            refreshPreview();
            
            // Also update the list view if it's active
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab && activeTab.id === 'list-tab') {
                setTimeout(() => location.reload(), 500);
            }
        } else {
            alert('Fehler beim Speichern: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Speichern: ' + error.message);
    });
}

function showPreviewOverlay() {
    const container = document.getElementById('visualEditorContainer');
    if (container) {
        container.classList.add('active');
    }
}

function hidePreviewOverlay() {
    const container = document.getElementById('visualEditorContainer');
    if (container) {
        container.classList.remove('active');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// SEO Editor Functions
function loadSEOData() {
    // Load SEO settings for current page
    fetch(`/accounts/seo/get/?page={{ page }}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('seoTitle').value = data.seo_title || '';
            document.getElementById('seoDescription').value = data.seo_description || '';
            document.getElementById('seoKeywords').value = data.keywords || '';
            document.getElementById('canonicalUrl').value = data.canonical_url || '';
            document.getElementById('noindex').checked = data.noindex || false;
            
            updateSEOCounters();
            updateSEOPreview();
        }
    })
    .catch(error => {
        console.error('Error loading SEO data:', error);
    });
    
    // Load alt texts
    loadAltTexts();
}

function updateSEOCounters() {
    const title = document.getElementById('seoTitle').value;
    const description = document.getElementById('seoDescription').value;
    
    // Title counter
    const titleLength = title.length;
    document.getElementById('titleCounter').textContent = titleLength;
    const titleStatus = document.getElementById('titleStatus');
    
    if (titleLength === 0) {
        titleStatus.textContent = 'Titel fehlt';
        titleStatus.className = 'ms-2 text-danger';
    } else if (titleLength < 30) {
        titleStatus.textContent = 'Zu kurz';
        titleStatus.className = 'ms-2 text-warning';
    } else if (titleLength <= 60) {
        titleStatus.textContent = 'Optimal';
        titleStatus.className = 'ms-2 text-success';
    } else {
        titleStatus.textContent = 'Zu lang';
        titleStatus.className = 'ms-2 text-danger';
    }
    
    // Description counter
    const descLength = description.length;
    document.getElementById('descriptionCounter').textContent = descLength;
    const descStatus = document.getElementById('descriptionStatus');
    
    if (descLength === 0) {
        descStatus.textContent = 'Beschreibung fehlt';
        descStatus.className = 'ms-2 text-danger';
    } else if (descLength < 120) {
        descStatus.textContent = 'Zu kurz';
        descStatus.className = 'ms-2 text-warning';
    } else if (descLength <= 160) {
        descStatus.textContent = 'Optimal';
        descStatus.className = 'ms-2 text-success';
    } else {
        descStatus.textContent = 'Zu lang';
        descStatus.className = 'ms-2 text-danger';
    }
    
    updateSEOPreview();
}

function updateSEOPreview() {
    const title = document.getElementById('seoTitle').value || 'Titel wird hier angezeigt';
    const description = document.getElementById('seoDescription').value || 'Beschreibung wird hier angezeigt';
    
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewDescription').textContent = description;
}

function saveSEOSettings() {
    const formData = new FormData(document.getElementById('seoForm'));
    
    fetch('/accounts/seo/save/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('SEO Einstellungen erfolgreich gespeichert!');
        } else {
            alert('Fehler: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Speichern der SEO Einstellungen');
    });
}

function loadAltTexts() {
    fetch(`/accounts/seo/alt-texts/?page={{ page }}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('altTextList');
        
        if (data.success && data.alt_texts.length > 0) {
            container.innerHTML = '';
            data.alt_texts.forEach(item => {
                const altTextItem = document.createElement('div');
                altTextItem.className = 'alt-text-item';
                altTextItem.innerHTML = `
                    <div class="d-flex">
                        <img src="${item.image_url}" class="alt-text-image me-3" alt="">
                        <div class="flex-grow-1">
                            <small class="text-muted">${item.content_key}</small>
                            <input type="text" class="form-control form-control-sm mt-1" 
                                   value="${item.alt_text || ''}" 
                                   onchange="updateAltText(${item.id}, this.value)"
                                   placeholder="Alt-Text eingeben...">
                        </div>
                    </div>
                `;
                container.appendChild(altTextItem);
            });
        } else {
            container.innerHTML = '<div class="text-center text-muted py-3">Keine Bilder gefunden</div>';
        }
    })
    .catch(error => {
        console.error('Error loading alt texts:', error);
        document.getElementById('altTextList').innerHTML = '<div class="text-center text-danger py-3">Fehler beim Laden</div>';
    });
}

function updateAltText(contentId, altText) {
    const formData = new FormData();
    formData.append('content_id', contentId);
    formData.append('image_alt_text', altText);
    formData.append('page', '{{ page }}');
    
    fetch('{% url "accounts:update_content" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Alt-Text updated successfully');
        } else {
            alert('Fehler beim Speichern des Alt-Texts: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error updating alt text:', error);
    });
}

// Global Save Function
function saveAllChanges() {
    const btn = document.getElementById('saveAllBtn');
    const originalText = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Speichert...';
    
    // Check which tab is active and save accordingly
    const activeTab = document.querySelector('.nav-link.active');
    
    if (activeTab && activeTab.id === 'seo-tab') {
        // Save SEO settings
        saveSEOSettingsPromise().then(() => {
            // Show success message
            showSaveSuccess();
            resetSaveButton(btn, originalText);
        }).catch(() => {
            resetSaveButton(btn, originalText);
        });
    } else {
        // For visual editor and list mode, just refresh the preview to ensure everything is synced
        refreshPreview();
        
        // Show success message
        setTimeout(() => {
            showSaveSuccess();
            resetSaveButton(btn, originalText);
        }, 500);
    }
}

function resetSaveButton(btn, originalText) {
    btn.disabled = false;
    btn.innerHTML = originalText;
}

function showSaveSuccess() {
    // Create and show success message
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.maxWidth = '300px';
    alertDiv.innerHTML = `
        <i class="fas fa-check me-2"></i>Alle √Ñnderungen wurden gespeichert!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// SEO Settings save function that returns a promise
function saveSEOSettingsPromise() {
    return new Promise((resolve, reject) => {
        const formData = new FormData(document.getElementById('seoForm'));
        
        fetch('/accounts/seo/save/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resolve();
            } else {
                alert('Fehler beim Speichern der SEO Einstellungen: ' + data.error);
                reject();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Speichern der SEO Einstellungen');
            reject();
        });
    });
}
</script>

<!-- New Page Modal -->
<div class="modal fade" id="newPageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Neue Seite erstellen
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newPageForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Seiten-Name</label>
                        <input type="text" class="form-control" id="pageName" placeholder="z.B. 'about', 'services', 'contact'" required>
                        <div class="form-text">Technischer Name f√ºr die URL (nur Kleinbuchstaben und Bindestriche)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Anzeigename</label>
                        <input type="text" class="form-control" id="pageDisplayName" placeholder="z.B. '√úber uns', 'Services', 'Kontakt'" required>
                        <div class="form-text">Name, der in der Navigation angezeigt wird</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Seitentyp</label>
                        <select class="form-select" id="pageType" onchange="showPageTypeDescription()">
                            <option value="landing">Landing Page</option>
                            <option value="about">√úber uns</option>
                            <option value="services">Services/Leistungen</option>
                            <option value="contact">Kontakt</option>
                            <option value="blog">Blog/News</option>
                            <option value="gallery">Galerie</option>
                            <option value="custom">Benutzerdefiniert</option>
                        </select>
                    </div>
                    
                    <div id="pageTypeDescription" class="alert alert-info">
                        <strong>Landing Page:</strong> Hauptseite mit Hero-Bereich, Features und Call-to-Action
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Beschreibung (optional)</label>
                        <textarea class="form-control" id="pageDescription" rows="3" placeholder="Kurze Beschreibung des Seiteninhalts..."></textarea>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-magic me-2"></i>
                        <strong>KI-Assistent:</strong> Basierend auf Ihren Angaben wird automatisch ein Grundger√ºst mit passenden Inhalten erstellt.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-success" onclick="createNewPage()">
                    <i class="fas fa-rocket me-1"></i>Seite erstellen
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function showPageTypeDescription() {
    const pageType = document.getElementById('pageType').value;
    const descriptions = {
        'landing': '<strong>Landing Page:</strong> Hauptseite mit Hero-Bereich, Features und Call-to-Action',
        'about': '<strong>√úber uns:</strong> Unternehmensinfo, Team, Mission und Werte',
        'services': '<strong>Services:</strong> Leistungs√ºbersicht, Preise und Vorteile',
        'contact': '<strong>Kontakt:</strong> Kontaktformular, Adresse und √ñffnungszeiten',
        'blog': '<strong>Blog:</strong> Artikel-Liste, Kategorien und Suchfunktion',
        'gallery': '<strong>Galerie:</strong> Bild- und Video-Pr√§sentation',
        'custom': '<strong>Benutzerdefiniert:</strong> Leere Seite zum individuellen Gestalten'
    };
    
    document.getElementById('pageTypeDescription').innerHTML = descriptions[pageType] || '';
}

function createNewPage() {
    const pageName = document.getElementById('pageName').value.trim();
    const displayName = document.getElementById('pageDisplayName').value.trim();
    const pageType = document.getElementById('pageType').value;
    const description = document.getElementById('pageDescription').value.trim();
    
    if (!pageName || !displayName) {
        alert('Bitte f√ºllen Sie alle Pflichtfelder aus.');
        return;
    }
    
    // Validate page name (only lowercase letters, numbers, hyphens)
    if (!/^[a-z0-9-]+$/.test(pageName)) {
        alert('Der Seiten-Name darf nur Kleinbuchstaben, Zahlen und Bindestriche enthalten.');
        return;
    }
    
    // Send request to create new page
    fetch('{% url "accounts:create_page" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            page_name: pageName,
            display_name: displayName,
            page_type: pageType,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('newPageModal')).hide();
            
            // Show success message
            alert('Seite "' + data.display_name + '" wurde erfolgreich erstellt!');
            
            // Redirect to the new page's editor
            window.location.href = data.redirect_url;
        } else {
            alert('Fehler beim Erstellen der Seite: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Erstellen der Seite: ' + error.message);
    });
}
</script>

{% endblock %}