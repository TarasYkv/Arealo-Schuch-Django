{% extends 'base.html' %}
{% load loomads_tags %}

{% block content %}
<!-- LoomAds CSS f√ºr Styling -->
{% loomads_css %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-speedometer2"></i> Dashboard
    </h1>
    <div class="d-flex align-items-center gap-2">
        <span class="badge bg-primary">{{ user.username }}</span>
        
        <!-- Dark Mode Toggle -->
        <form method="post" class="d-inline">
            {% csrf_token %}
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="darkModeToggle" 
                       name="dark_mode" {% if dark_mode %}checked{% endif %}
                       onchange="this.form.submit()">
                <label class="form-check-label" for="darkModeToggle">
                    <i class="bi bi-moon-fill"></i>
                </label>
            </div>
        </form>
        
        <a href="{% url 'accounts:logout' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-box-arrow-right"></i> Abmelden
        </a>
    </div>
</div>

<!-- Subscription Status Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-warning">
            <div class="card-header bg-warning text-dark">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-crown me-2"></i>
                        Abonnement Status
                    </h5>
                    <a href="{% url 'payments:subscription_plans' %}" class="btn btn-dark btn-sm">
                        Verwalten
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div id="subscription-info">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-secondary me-2">Kostenlos</span>
                                <span class="text-muted">100MB Video-Speicher</span>
                            </div>
                            <p class="text-muted mb-0">
                                Erweitere dein Abonnement f√ºr mehr Speicherplatz und Premium-Features.
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="{% url 'payments:subscription_plans' %}" class="btn btn-warning">
                            <i class="fas fa-arrow-up me-1"></i> Upgrade
                        </a>
                        <a href="{% url 'videos:storage' %}" class="btn btn-outline-primary ms-2">
                            <i class="fas fa-chart-bar me-1"></i> Speicher
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- In-Feed Ad Zone before Apps -->
{% show_ad_zone 'content_infeed' css_class='mb-4' %}

<!-- Verf√ºgbare Apps Section -->
<div class="row mb-4">
    <div class="col-md-9">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-grid-3x3-gap me-2"></i>
                        Verf√ºgbare Apps
                    </h5>
                    <span class="badge bg-white text-primary">
                        <span id="available-apps-count">0</span> Apps
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- Search and Filter -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-start-0" id="appSearch" 
                                   placeholder="Apps durchsuchen...">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-primary btn-sm active" data-category="all">
                                <i class="bi bi-grid me-1"></i> Alle
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" data-category="tools">
                                <i class="bi bi-tools me-1"></i> Tools
                            </button>
                            <button class="btn btn-outline-success btn-sm" data-category="communication">
                                <i class="bi bi-chat-dots me-1"></i> Kommunikation
                            </button>
                            <button class="btn btn-outline-info btn-sm" data-category="management">
                                <i class="bi bi-building me-1"></i> Organisation
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Apps Grid -->
                <div class="row" id="appsGrid">
                    <!-- App tiles will be inserted here by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    <!-- Sidebar Ad Zone -->
    <div class="col-md-3">
        <div class="sticky-top" style="top: 1rem;">
            {% show_ad_zone 'sidebar_main' css_class='mb-3' %}
            
            <!-- Additional sidebar content -->
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">üí° Tipp</h6>
                    <p class="card-text small">Nutze die Suchfunktion, um schnell die gew√ºnschte App zu finden.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer Ad Zone is already rendered in base.html for authenticated users -->

<!-- Removed existing sections: Only App-Kacheln remain above -->

<style>
/* Dezentes, modernes App Card Styling mit sichtbaren Borders */
.app-tile {
    transition: all 0.3s ease;
    cursor: pointer;
    margin-bottom: 1.5rem;
}

.app-tile .card {
    border: 2px solid #d1d5db;
    border-radius: 16px;
    overflow: hidden;
    height: 100%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
    position: relative;
    background: white;
}

/* Dezente linke Border mit Akzentfarbe */
.app-tile .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 5px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    transition: all 0.3s ease;
    opacity: 0.5;
    border-radius: 14px 0 0 14px;
}

.app-tile:hover .card::before {
    opacity: 1;
    width: 6px;
}

.app-tile:hover .card {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 4px 10px rgba(0, 0, 0, 0.08);
    border-color: #9ca3af;
}

.app-tile .card-header {
    border: none;
    padding: 1.5rem;
    background: linear-gradient(135deg, #f8f9fb 0%, #fefeff 100%);
    border-bottom: 2px solid #e5e7eb;
}

.app-tile .card-header h6 {
    font-weight: 700;
    font-size: 1.1rem;
    color: #111827;
    margin: 0;
    letter-spacing: -0.02em;
}

.app-tile .card-header i {
    font-size: 1.5rem;
    color: #667eea;
    opacity: 0.9;
}

.app-tile .card-body {
    padding: 1.25rem 1.5rem;
    background: #ffffff;
}

.app-tile .card-text {
    color: #4b5563;
    line-height: 1.65;
    min-height: 48px;
    font-size: 0.875rem;
}

.app-status-badge {
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
    border: 1.5px solid #6ee7b7;
    padding: 0.4rem 0.85rem;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 600;
    color: #047857;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    box-shadow: 0 1px 2px rgba(5, 150, 105, 0.1);
}

.category-label {
    color: #6b7280;
    font-size: 0.8rem;
    font-weight: 600;
    background: #f3f4f6;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
}

/* Button Styling - dezent aber sichtbar */
.app-tile .btn-outline-primary,
.app-tile .btn-outline-info,
.app-tile .btn-outline-secondary {
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
    border-width: 1.5px;
}

.app-tile .btn-outline-primary {
    color: #667eea;
    border-color: #a5b4fc;
    background: linear-gradient(135deg, #faf5ff 0%, #ffffff 100%);
}

.app-tile .btn-outline-primary:hover {
    background: linear-gradient(135deg, #ede9fe 0%, #f5f3ff 100%);
    border-color: #667eea;
    color: #5b21b6;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
}

.app-tile .btn-outline-info {
    color: #6b7280;
    border-color: #d1d5db;
    background: #ffffff;
}

.app-tile .btn-outline-info:hover {
    background: #f9fafb;
    border-color: #9ca3af;
    color: #374151;
    transform: translateY(-1px);
}

.btn-outline-primary.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.hidden {
    display: none !important;
}

/* In Development Apps Styling */
.app-tile.in-development {
    opacity: 0.85;
}

.app-tile.in-development .card::before {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    opacity: 0.4;
}

.app-tile.in-development .card {
    background-color: #fffbeb;
    border: 2px dashed #fcd34d;
}

.app-tile.in-development .card-header {
    background: linear-gradient(135deg, #fef3c7 0%, #fef9ec 100%);
    border-bottom: 2px solid #fde68a;
}

.app-tile.in-development .card-header h6 {
    color: #92400e;
}

.app-tile.in-development .card-header i {
    color: #f59e0b;
    opacity: 0.7;
}

.app-tile.in-development .card-body {
    background: #fffbeb;
}

.app-tile.in-development .app-status-badge {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
    border-color: #fbbf24;
    color: #92400e;
}

.app-tile.in-development:hover .card {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(251, 191, 36, 0.15);
    border-color: #fbbf24;
}

/* Animations - subtiler */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(15px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.app-tile {
    animation: fadeInUp 0.4s ease-out;
}

.app-tile:nth-child(1) { animation-delay: 0.03s; }
.app-tile:nth-child(2) { animation-delay: 0.06s; }
.app-tile:nth-child(3) { animation-delay: 0.09s; }
.app-tile:nth-child(4) { animation-delay: 0.12s; }
.app-tile:nth-child(5) { animation-delay: 0.15s; }
.app-tile:nth-child(6) { animation-delay: 0.18s; }

/* Search and Filter Buttons */
#appSearch {
    border-radius: 8px;
    border: 2px solid #d1d5db;
    transition: all 0.2s ease;
    padding: 0.625rem 1rem;
    background: #ffffff;
}

#appSearch:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.15rem rgba(102, 126, 234, 0.1);
    outline: none;
}

.input-group-text {
    border-radius: 8px 0 0 8px !important;
    border: 2px solid #d1d5db;
    border-right: none !important;
    background: #f9fafb;
}

[data-category] {
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
    font-size: 0.875rem;
    border-width: 1.5px;
}

[data-category]:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

[data-category].active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

/* Responsive */
@media (max-width: 768px) {
    .app-tile:hover .card {
        transform: none;
    }

    .app-tile.in-development:hover .card {
        transform: none;
    }

    .app-tile .card-header h6 {
        font-size: 0.95rem;
    }

    .app-tile .card-header i {
        font-size: 1.5rem;
    }
}
</style>

<script>
// Available apps configuration - dynamically generated from backend with permissions
const availableApps = [
    {% for app in available_apps %}
    {
        name: '{{ app.name|escapejs }}',
        description: '{{ app.description|escapejs }}',
        icon: '{{ app.icon }}',
        url: '{% if app.url == "#" %}#{% else %}{% url app.url %}{% endif %}',
        color: '{{ app.color }}',
        category: '{{ app.category }}',
        app_name: '{{ app.app_name }}',
        available: {{ app.available|yesno:"true,false" }},
        is_in_development: {{ app.is_in_development|yesno:"true,false" }}
    }{% if not forloop.last %},{% endif %}
    {% empty %}
    // No apps available for this user
    {% endfor %}
];

function initializeAppTiles() {
    const appsGrid = document.getElementById('appsGrid');
    appsGrid.innerHTML = ''; // Clear existing tiles to prevent duplicates
    const availableAppsOnly = availableApps.filter(app => app.available);
    
    // Update app count
    document.getElementById('available-apps-count').textContent = availableAppsOnly.length;
    
    if (availableAppsOnly.length === 0) {
        appsGrid.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle display-1 text-muted"></i>
                    <h3 class="text-muted">Keine Apps verf√ºgbar</h3>
                    <p class="text-muted">Kontaktiere deinen Administrator f√ºr weitere App-Freischaltungen.</p>
                </div>
            </div>
        `;
        return;
    }
    
    availableAppsOnly.forEach(app => {
        const appTile = document.createElement('div');
        appTile.className = `col-lg-4 col-md-6 mb-3 app-tile${app.is_in_development ? ' in-development' : ''}`;
        appTile.dataset.category = app.category;
        appTile.dataset.name = app.name.toLowerCase();
        
        const isClickable = app.url !== '#' && !app.is_in_development;
        const clickHandler = isClickable ? `onclick="window.location.href='${app.url}'"` : '';
        const cardClass = isClickable ? 'shadow-sm h-100' : 'shadow-sm h-100 opacity-75';
        
        appTile.innerHTML = `
            <div class="card ${cardClass}" ${clickHandler} ${!isClickable ? 'style="cursor: not-allowed;"' : ''}>
                <div class="card-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="${app.icon} me-3"></i>
                            <h6 class="mb-0">${app.name}</h6>
                        </div>
                        <span class="app-status-badge">
                            ${app.is_in_development
                                ? '<i class="bi bi-hammer me-1"></i>In Entwicklung'
                                : isClickable
                                    ? '<i class="bi bi-check-circle me-1"></i>Aktiv'
                                    : '<i class="bi bi-hammer me-1"></i>In Entwicklung'
                            }
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text mb-3">${app.description}</p>
                    <div class="d-flex align-items-center justify-content-between">
                        <small class="category-label">
                            <i class="bi bi-tag me-1"></i>${app.category}
                        </small>
                        <div class="btn-group btn-group-sm">
                            ${isClickable
                                ? `<a href="${app.url}" class="btn btn-outline-primary">
                                     <i class="bi bi-arrow-right me-1"></i>√ñffnen
                                   </a>`
                                : `<button class="btn btn-outline-secondary" disabled>
                                     <i class="bi bi-hammer me-1"></i>Bald verf√ºgbar
                                   </button>`
                            }
                            <a href="/accounts/apps/${app.app_name}/info/" class="btn btn-outline-info">
                                <i class="bi bi-info-circle"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        appsGrid.appendChild(appTile);
    });
}

function initializeAppSearch() {
    const searchInput = document.getElementById('appSearch');
    const appTiles = document.querySelectorAll('.app-tile');
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        appTiles.forEach(tile => {
            const appName = tile.dataset.name;
            const appDescription = tile.querySelector('.card-text').textContent.toLowerCase();
            
            if (appName.includes(searchTerm) || appDescription.includes(searchTerm)) {
                tile.classList.remove('hidden');
            } else {
                tile.classList.add('hidden');
            }
        });
        
        updateNoResultsMessage();
    });
}

function initializeAppFilters() {
    const filterButtons = document.querySelectorAll('[data-category]');
    const appTiles = document.querySelectorAll('.app-tile');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const category = this.dataset.category;
            
            // Update active button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Filter apps
            appTiles.forEach(tile => {
                if (category === 'all' || tile.dataset.category === category) {
                    tile.classList.remove('hidden');
                } else {
                    tile.classList.add('hidden');
                }
            });
            
            updateNoResultsMessage();
        });
    });
}

function updateNoResultsMessage() {
    const visibleTiles = document.querySelectorAll('.app-tile:not(.hidden)');
    const grid = document.getElementById('appsGrid');
    
    // Remove existing no results message
    const existingMessage = grid.querySelector('.no-results-message');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    if (visibleTiles.length === 0) {
        const noResultsHTML = `
            <div class="col-12 no-results-message">
                <div class="text-center py-5">
                    <i class="bi bi-search display-1 text-muted"></i>
                    <h3 class="text-muted">Keine Apps gefunden</h3>
                    <p class="text-muted">Versuche einen anderen Suchbegriff oder Filter.</p>
                </div>
            </div>
        `;
        grid.insertAdjacentHTML('beforeend', noResultsHTML);
    }
}

// Load subscription status
async function loadSubscriptionStatus() {
    try {
        const response = await fetch('/payments/api/status/');
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                updateSubscriptionDisplay(data.subscription);
            }
        }
    } catch (error) {
        console.error('Error loading subscription status:', error);
    }
}

function updateSubscriptionDisplay(subscription) {
    const subscriptionInfo = document.getElementById('subscription-info');
    
    let statusBadge = 'bg-secondary';
    let statusText = subscription.plan_name;
    
    if (subscription.is_premium) {
        statusBadge = 'bg-warning';
        statusText = `‚≠ê ${subscription.plan_name}`;
    }
    
    let storageText = '';
    if (subscription.storage_mb >= 1024) {
        storageText = `${(subscription.storage_mb / 1024)}GB Video-Speicher`;
    } else {
        storageText = `${subscription.storage_mb}MB Video-Speicher`;
    }
    
    let description = '';
    if (subscription.is_premium) {
        description = `Premium-Features aktiv. ${subscription.price}‚Ç¨/${subscription.interval}`;
    } else {
        description = 'Erweitere dein Abonnement f√ºr mehr Speicherplatz und Premium-Features.';
    }
    
    subscriptionInfo.innerHTML = `
        <div class="d-flex align-items-center mb-2">
            <span class="badge ${statusBadge} me-2">${statusText}</span>
            <span class="text-muted">${storageText}</span>
            <span class="badge bg-info ms-2">${subscription.used_percentage.toFixed(1)}% genutzt</span>
        </div>
        <p class="text-muted mb-0">${description}</p>
    `;
}

// Add subscription status loading to the initialization
document.addEventListener('DOMContentLoaded', function() {
    initializeAppTiles();
    initializeAppSearch();
    initializeAppFilters();
    loadSubscriptionStatus();
});
</script>
{% endblock %}
