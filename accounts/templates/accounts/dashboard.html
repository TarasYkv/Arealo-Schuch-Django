{% extends 'base.html' %}
{% load loomads_tags %}

{% block content %}
<!-- LoomAds CSS f√ºr Styling -->
{% loomads_css %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-speedometer2"></i> Dashboard
    </h1>
    <div class="d-flex align-items-center gap-2">
        <span class="badge bg-primary">{{ user.username }}</span>
        
        <a href="{% url 'accounts:logout' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-box-arrow-right"></i> Abmelden
        </a>
    </div>
</div>

<!-- Subscription Status Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-warning">
            <div class="card-header bg-warning text-dark">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-crown me-2"></i>
                        Abonnement Status
                    </h5>
                    <a href="{% url 'payments:subscription_plans' %}" class="btn btn-dark btn-sm">
                        Verwalten
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div id="subscription-info">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-secondary me-2">Kostenlos</span>
                                <span class="text-muted">100MB Video-Speicher</span>
                            </div>
                            <p class="text-muted mb-0">
                                Erweitere dein Abonnement f√ºr mehr Speicherplatz und Premium-Features.
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="{% url 'payments:subscription_plans' %}" class="btn btn-warning">
                            <i class="fas fa-arrow-up me-1"></i> Upgrade
                        </a>
                        <a href="{% url 'videos:storage' %}" class="btn btn-outline-primary ms-2">
                            <i class="fas fa-chart-bar me-1"></i> Speicher
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- In-Feed Ad Zone before Apps -->
{% show_ad_zone 'content_infeed' css_class='mb-4' %}

<!-- Verf√ºgbare Apps Section -->
<div class="row mb-4">
    <div class="col-md-9">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-grid-3x3-gap me-2"></i>
                        Verf√ºgbare Apps
                    </h5>
                    <span class="badge bg-white text-primary">
                        <span id="available-apps-count">0</span> Apps
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- Search and Filter -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-start-0" id="appSearch" 
                                   placeholder="Apps durchsuchen...">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-primary btn-sm active" data-category="all">
                                <i class="bi bi-grid me-1"></i> Alle
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" data-category="tools">
                                <i class="bi bi-tools me-1"></i> Tools
                            </button>
                            <button class="btn btn-outline-info btn-sm" data-category="content">
                                <i class="bi bi-pencil me-1"></i> Content
                            </button>
                            <button class="btn btn-outline-success btn-sm" data-category="seo">
                                <i class="bi bi-graph-up me-1"></i> SEO
                            </button>
                            <button class="btn btn-outline-warning btn-sm" data-category="ecommerce">
                                <i class="bi bi-shop me-1"></i> E-Commerce
                            </button>
                            <button class="btn btn-outline-primary btn-sm" data-category="media">
                                <i class="bi bi-play-circle me-1"></i> Media
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" data-category="management">
                                <i class="bi bi-gear me-1"></i> Management
                            </button>
                            <button class="btn btn-outline-info btn-sm" data-category="communication">
                                <i class="bi bi-chat-dots me-1"></i> Kommunikation
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Apps Grid -->
                <div class="row" id="appsGrid">
                    <!-- App tiles will be inserted here by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    <!-- Sidebar Ad Zone -->
    <div class="col-md-3">
        <div class="sticky-top" style="top: 1rem;">
            {% show_ad_zone 'sidebar_main' css_class='mb-3' %}
            
            <!-- Additional sidebar content -->
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">üí° Tipp</h6>
                    <p class="card-text small">Nutze die Suchfunktion, um schnell die gew√ºnschte App zu finden.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer Ad Zone is already rendered in base.html for authenticated users -->

<!-- Removed existing sections: Only App-Kacheln remain above -->

<style>
/* Klares, gut lesbares App Card Styling */
.app-tile {
    transition: all 0.3s ease;
    cursor: pointer;
    margin-bottom: 1.5rem;
}

.app-tile .card {
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    height: 100%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    position: relative;
    background: #ffffff;
}

.app-tile .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    transition: all 0.3s ease;
}

.app-tile:hover .card {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    border-color: #6366f1;
}

.app-tile .card-header {
    border: none;
    padding: 1.25rem 1.5rem;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}

.app-tile .card-header h6 {
    font-weight: 700;
    font-size: 1rem;
    color: #1e293b;
    margin: 0;
}

.app-tile .card-header i {
    font-size: 1.5rem;
    color: #6366f1;
}

.app-tile .card-body {
    padding: 1.25rem 1.5rem;
    background: #ffffff;
}

.app-tile .card-text {
    color: #475569;
    line-height: 1.6;
    min-height: 48px;
    font-size: 0.9rem;
}

.app-status-badge {
    background: #ecfdf5 !important;
    border: 1px solid #10b981;
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 600;
    color: #059669;
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.app-status-badge.in-dev {
    background: #fef3c7 !important;
    border-color: #f59e0b;
    color: #b45309;
}

.category-label {
    color: #64748b;
    font-size: 0.8rem;
    font-weight: 500;
    background: #f1f5f9;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    text-transform: capitalize;
}

.app-tile .btn-outline-primary,
.app-tile .btn-outline-info,
.app-tile .btn-outline-secondary {
    border-radius: 6px;
    font-weight: 600;
    transition: all 0.2s ease;
    font-size: 0.85rem;
    padding: 0.4rem 0.9rem;
}

.app-tile .btn-outline-primary {
    color: #6366f1;
    border-color: #6366f1;
    background: transparent;
}

.app-tile .btn-outline-primary:hover {
    background: #6366f1;
    border-color: #6366f1;
    color: #ffffff;
}

.app-tile .btn-outline-info {
    color: #64748b;
    border-color: #cbd5e1;
    background: transparent;
}

.app-tile .btn-outline-info:hover {
    background: #f1f5f9;
    border-color: #94a3b8;
    color: #334155;
}

.btn-outline-primary.active,
.btn-outline-secondary.active,
.btn-outline-success.active,
.btn-outline-info.active,
.btn-outline-warning.active {
    background: #6366f1 !important;
    color: #ffffff !important;
    border-color: #6366f1 !important;
}

.hidden {
    display: none !important;
}

.app-tile.in-development .card {
    background: #fffbeb;
    border: 2px dashed #fbbf24;
}

.app-tile.in-development .card-header {
    background: #fef3c7;
}

.app-tile.in-development .card::before {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

/* Dark Mode Anpassungen */
[data-theme="dark"] .app-tile .card {
    background: #1e293b;
    border-color: #334155;
}

[data-theme="dark"] .app-tile .card-header {
    background: #0f172a;
    border-color: #334155;
}

[data-theme="dark"] .app-tile .card-header h6 {
    color: #f1f5f9;
}

[data-theme="dark"] .app-tile .card-body {
    background: #1e293b;
}

[data-theme="dark"] .app-tile .card-text {
    color: #cbd5e1;
}

[data-theme="dark"] .app-status-badge {
    background: rgba(16, 185, 129, 0.15) !important;
    border-color: #10b981;
    color: #34d399;
}

[data-theme="dark"] .category-label {
    color: #94a3b8;
    background: #334155;
    border-color: #475569;
}

[data-theme="dark"] .app-tile .btn-outline-primary {
    color: #a5b4fc;
    border-color: #6366f1;
}

[data-theme="dark"] .app-tile .btn-outline-primary:hover {
    background: #6366f1;
    color: #ffffff;
}

[data-theme="dark"] .app-tile .btn-outline-info {
    color: #94a3b8;
    border-color: #475569;
}

[data-theme="dark"] .app-tile .btn-outline-info:hover {
    background: #334155;
    color: #e2e8f0;
}

[data-theme="dark"] .app-tile.in-development .card {
    background: rgba(251, 191, 36, 0.1);
    border-color: #fbbf24;
}

[data-theme="dark"] .app-tile.in-development .card-header {
    background: rgba(251, 191, 36, 0.15);
}

/* Filter Buttons styling */
[data-category] {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
}
</style>

<script>
// Available apps configuration - dynamically generated from backend with permissions
const availableApps = [
    {% for app in available_apps %}
    {
        name: '{{ app.name|escapejs }}',
        description: '{{ app.description|escapejs }}',
        icon: '{{ app.icon }}',
        url: '{% if app.url == "#" %}#{% else %}{% url app.url %}{% endif %}',
        color: '{{ app.color }}',
        category: '{{ app.category }}',
        app_name: '{{ app.app_name }}',
        available: {{ app.available|yesno:"true,false" }},
        is_in_development: {{ app.is_in_development|yesno:"true,false" }}
    }{% if not forloop.last %},{% endif %}
    {% empty %}
    // No apps available for this user
    {% endfor %}
];

function initializeAppTiles() {
    const appsGrid = document.getElementById('appsGrid');
    appsGrid.innerHTML = ''; // Clear existing tiles to prevent duplicates
    const availableAppsOnly = availableApps.filter(app => app.available);
    
    // Update app count
    document.getElementById('available-apps-count').textContent = availableAppsOnly.length;
    
    if (availableAppsOnly.length === 0) {
        appsGrid.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle display-1 text-muted"></i>
                    <h3 class="text-muted">Keine Apps verf√ºgbar</h3>
                    <p class="text-muted">Kontaktiere deinen Administrator f√ºr weitere App-Freischaltungen.</p>
                </div>
            </div>
        `;
        return;
    }
    
    // Kategorie-√úbersetzungen
    const categoryNames = {
        'tools': 'Tools',
        'content': 'Content',
        'seo': 'SEO',
        'ecommerce': 'E-Commerce',
        'media': 'Media',
        'management': 'Management',
        'communication': 'Kommunikation',
        'ai': 'KI',
        'education': 'Schulung',
        'dashboard': 'Dashboard'
    };

    availableAppsOnly.forEach(app => {
        const appTile = document.createElement('div');
        appTile.className = `col-lg-4 col-md-6 mb-3 app-tile${app.is_in_development ? ' in-development' : ''}`;
        appTile.dataset.category = app.category;
        appTile.dataset.name = app.name.toLowerCase();

        const isClickable = app.url !== '#' && !app.is_in_development;
        const clickHandler = isClickable ? `onclick="window.location.href='${app.url}'"` : '';
        const cardClass = isClickable ? 'h-100' : 'h-100';
        const isInDev = app.is_in_development || !isClickable;
        const categoryLabel = categoryNames[app.category] || app.category;

        appTile.innerHTML = `
            <div class="card ${cardClass}" ${clickHandler} ${!isClickable ? 'style="cursor: not-allowed;"' : ''}>
                <div class="card-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="${app.icon} me-3"></i>
                            <h6 class="mb-0">${app.name}</h6>
                        </div>
                        <span class="app-status-badge${isInDev ? ' in-dev' : ''}">
                            ${isInDev
                                ? '<i class="bi bi-hammer me-1"></i>In Entwicklung'
                                : '<i class="bi bi-check-circle me-1"></i>Aktiv'
                            }
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text mb-3">${app.description}</p>
                    <div class="d-flex align-items-center justify-content-between">
                        <small class="category-label">
                            <i class="bi bi-tag me-1"></i>${categoryLabel}
                        </small>
                        <div class="btn-group btn-group-sm">
                            ${isClickable
                                ? `<a href="${app.url}" class="btn btn-outline-primary">
                                     <i class="bi bi-arrow-right me-1"></i>√ñffnen
                                   </a>`
                                : `<button class="btn btn-outline-secondary" disabled>
                                     <i class="bi bi-hammer me-1"></i>Bald
                                   </button>`
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;

        appsGrid.appendChild(appTile);
    });
}

function initializeAppSearch() {
    const searchInput = document.getElementById('appSearch');
    const appTiles = document.querySelectorAll('.app-tile');
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        appTiles.forEach(tile => {
            const appName = tile.dataset.name;
            const appDescription = tile.querySelector('.card-text').textContent.toLowerCase();
            
            if (appName.includes(searchTerm) || appDescription.includes(searchTerm)) {
                tile.classList.remove('hidden');
            } else {
                tile.classList.add('hidden');
            }
        });
        
        updateNoResultsMessage();
    });
}

function initializeAppFilters() {
    const filterButtons = document.querySelectorAll('[data-category]');
    const appTiles = document.querySelectorAll('.app-tile');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const category = this.dataset.category;
            
            // Update active button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Filter apps
            appTiles.forEach(tile => {
                if (category === 'all' || tile.dataset.category === category) {
                    tile.classList.remove('hidden');
                } else {
                    tile.classList.add('hidden');
                }
            });
            
            updateNoResultsMessage();
        });
    });
}

function updateNoResultsMessage() {
    const visibleTiles = document.querySelectorAll('.app-tile:not(.hidden)');
    const grid = document.getElementById('appsGrid');
    
    // Remove existing no results message
    const existingMessage = grid.querySelector('.no-results-message');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    if (visibleTiles.length === 0) {
        const noResultsHTML = `
            <div class="col-12 no-results-message">
                <div class="text-center py-5">
                    <i class="bi bi-search display-1 text-muted"></i>
                    <h3 class="text-muted">Keine Apps gefunden</h3>
                    <p class="text-muted">Versuche einen anderen Suchbegriff oder Filter.</p>
                </div>
            </div>
        `;
        grid.insertAdjacentHTML('beforeend', noResultsHTML);
    }
}

// Load subscription status
async function loadSubscriptionStatus() {
    try {
        const response = await fetch('/payments/api/status/');
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                updateSubscriptionDisplay(data.subscription);
            }
        }
    } catch (error) {
        console.error('Error loading subscription status:', error);
    }
}

function updateSubscriptionDisplay(subscription) {
    const subscriptionInfo = document.getElementById('subscription-info');
    
    let statusBadge = 'bg-secondary';
    let statusText = subscription.plan_name;
    
    if (subscription.is_premium) {
        statusBadge = 'bg-warning';
        statusText = `‚≠ê ${subscription.plan_name}`;
    }
    
    let storageText = '';
    if (subscription.storage_mb >= 1024) {
        storageText = `${(subscription.storage_mb / 1024)}GB Video-Speicher`;
    } else {
        storageText = `${subscription.storage_mb}MB Video-Speicher`;
    }
    
    let description = '';
    if (subscription.is_premium) {
        description = `Premium-Features aktiv. ${subscription.price}‚Ç¨/${subscription.interval}`;
    } else {
        description = 'Erweitere dein Abonnement f√ºr mehr Speicherplatz und Premium-Features.';
    }
    
    subscriptionInfo.innerHTML = `
        <div class="d-flex align-items-center mb-2">
            <span class="badge ${statusBadge} me-2">${statusText}</span>
            <span class="text-muted">${storageText}</span>
            <span class="badge bg-info ms-2">${subscription.used_percentage.toFixed(1)}% genutzt</span>
        </div>
        <p class="text-muted mb-0">${description}</p>
    `;
}

// Add subscription status loading to the initialization
document.addEventListener('DOMContentLoaded', function() {
    initializeAppTiles();
    initializeAppSearch();
    initializeAppFilters();
    loadSubscriptionStatus();
});
</script>
{% endblock %}
