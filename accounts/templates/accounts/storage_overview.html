{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">
                    <i class="fas fa-hdd text-primary"></i> Speicher-Verwaltung
                </h1>
                <div class="btn-group">
                    <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-user"></i> Profil
                    </a>
                    <a href="{% url 'accounts:manage_subscription' 'video' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-up"></i> Speicher erweitern
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Gesamtspeicher-Anzeige -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie"></i> Gesamtspeicher
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between mb-2">
                                <span>
                                    <strong>{{ storage_stats.used_mb|floatformat:2 }} MB</strong> von
                                    <strong>{{ storage_stats.max_mb|floatformat:0 }} MB</strong> belegt
                                </span>
                                <span class="{% if usage_percentage > 90 %}text-danger{% elif usage_percentage > 75 %}text-warning{% else %}text-success{% endif %}">
                                    <strong>{{ usage_percentage }}%</strong>
                                </span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar {% if usage_percentage > 90 %}bg-danger{% elif usage_percentage > 75 %}bg-warning{% else %}bg-success{% endif %}"
                                     role="progressbar"
                                     style="width: {{ usage_percentage }}%"
                                     aria-valuenow="{{ usage_percentage }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    {{ usage_percentage }}%
                                </div>
                            </div>
                            <div class="mt-2 text-muted">
                                <small>
                                    <i class="fas fa-info-circle"></i>
                                    {% widthratio storage_stats.max_mb 1 1 as max_rounded %}
                                    {% widthratio storage_stats.used_mb 1 1 as used_rounded %}
                                    Verfügbar: <strong>{% widthratio storage_stats.available_bytes 1048576 1 %} MB</strong> frei
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="display-4 {% if usage_percentage > 90 %}text-danger{% elif usage_percentage > 75 %}text-warning{% else %}text-success{% endif %}">
                                {{ usage_percentage }}%
                            </div>
                            <small class="text-muted">Speicherauslastung</small>
                            <div class="mt-2">
                                <span class="badge bg-{% if video_storage.is_premium %}warning{% else %}secondary{% endif %}">
                                    {{ video_storage.get_tier_name }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Datenbank-Metadaten Info (informativ) -->
    {% if db_stats and db_stats.total_bytes > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0" style="background: #f8f9fa;">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-muted">
                                <i class="fas fa-database me-2"></i>
                                Datenbank-Metadaten:
                                <strong class="text-dark">
                                    {% if db_stats.total_kb < 100 %}
                                        {{ db_stats.total_kb|floatformat:1 }} KB
                                    {% else %}
                                        {{ db_stats.total_mb|floatformat:2 }} MB
                                    {% endif %}
                                </strong>
                                <span class="badge bg-success ms-2">nicht auf Kontingent angerechnet</span>
                            </span>
                        </div>
                        <button class="btn btn-link btn-sm text-muted p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dbMetadataDetails">
                            <i class="fas fa-chevron-down"></i> Details
                        </button>
                    </div>
                    <div class="collapse mt-3" id="dbMetadataDetails">
                        <div class="row">
                            {% for cat_name, cat_data in db_stats.by_category.items %}
                            <div class="col-lg-3 col-md-4 col-6 mb-2">
                                <div class="card h-100 border-0 bg-white">
                                    <div class="card-body py-2 px-3">
                                        <div class="d-flex align-items-center">
                                            <i class="{{ cat_data.icon }} text-primary me-2"></i>
                                            <div>
                                                <small class="d-block text-muted">{{ cat_name }}</small>
                                                <strong>
                                                    {% widthratio cat_data.bytes 1024 1 %} KB
                                                </strong>
                                                <small class="text-muted">({{ cat_data.count }} Einträge)</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="alert alert-info mt-3 mb-0 small">
                            <i class="fas fa-info-circle"></i>
                            Metadaten wie Shopify-Produktinfos, SEO-Texte, BlogPrep-Inhalte und Backup-Daten werden in der Datenbank gespeichert.
                            Diese Daten werden <strong>nicht</strong> auf Ihr Speicherkontingent angerechnet - nur hochgeladene Dateien (Bilder, Videos, PDFs) zählen dazu.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- App-basierte Statistiken -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cubes"></i> Speicherverbrauch pro App
                    </h5>
                </div>
                <div class="card-body">
                    {% if app_stats %}
                        <div class="row">
                            {% for app in app_stats %}
                            <div class="col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 border-left-primary app-filter-card"
                                     data-app-filter="{{ app.name }}"
                                     style="cursor: pointer; transition: all 0.2s ease;"
                                     onclick="filterByApp('{{ app.name }}')"
                                     title="Klicken um nur {{ app.name }} Dateien anzuzeigen">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <i class="{{ app.icon }} fa-2x text-primary"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-0">{{ app.name }}</h6>
                                                <div class="text-muted small">
                                                    {{ app.file_count }} Datei{% if app.file_count != 1 %}en{% endif %}
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <strong class="{% if app.total_mb > 100 %}text-warning{% else %}text-success{% endif %}">
    {{ app.total_mb|floatformat:2 }} MB
                                                </strong>
                                            </div>
                                        </div>
                                        {% if storage_stats.max_mb > 0 %}
                                        <div class="progress mt-2" style="height: 5px;">
                                            {% widthratio app.total_mb storage_stats.max_mb 100 as app_percent %}
                                            <div class="progress-bar bg-primary" style="width: {{ app_percent }}%"></div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-folder-open fa-3x mb-3"></i>
                            <p>Noch keine Dateien gespeichert</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Datei-Liste -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="mb-0" id="files-header">
                        <i class="fas fa-list"></i> <span id="files-title">Alle Dateien</span> (<span id="files-count">{{ total_files }}</span>)
                    </h5>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-danger btn-sm d-none" id="clear-filter-btn" onclick="clearFilter()">
                            <i class="fas fa-times"></i> Filter zurücksetzen
                        </button>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary active" data-sort="size" onclick="sortFiles('size')">
                                <i class="fas fa-sort-amount-down"></i> Größe
                            </button>
                            <button class="btn btn-outline-secondary" data-sort="date" onclick="sortFiles('date')">
                                <i class="fas fa-calendar"></i> Datum
                            </button>
                            <button class="btn btn-outline-secondary" data-sort="app" onclick="sortFiles('app')">
                                <i class="fas fa-cubes"></i> App
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if all_files %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="files-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Name</th>
                                    <th>App</th>
                                    <th>Typ</th>
                                    <th class="text-end">Größe</th>
                                    <th>Erstellt</th>
                                    <th style="width: 100px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in all_files %}
                                <tr data-size="{{ file.size_bytes }}" data-date="{{ file.created_at|date:'Y-m-d H:i' }}" data-app="{{ file.app }}">
                                    <td class="text-center">
                                        <i class="{{ file.app_icon }} text-muted"></i>
                                    </td>
                                    <td>
                                        <strong>{{ file.name|truncatechars:40 }}</strong>
                                        <br>
                                        <small class="text-muted">{{ file.filename|truncatechars:50 }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ file.app_name }}</span>
                                    </td>
                                    <td>
                                        <small>{{ file.type }}</small>
                                    </td>
                                    <td class="text-end">
                                        {% if file.size_mb >= 1 %}
                                            <strong class="text-warning">{{ file.size_mb|floatformat:2 }} MB</strong>
                                        {% else %}
                                            {% widthratio file.size_bytes 1024 1 %} KB
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ file.created_at|date:"d.m.Y" }}</small>
                                        <br>
                                        <small class="text-muted">{{ file.created_at|time:"H:i" }}</small>
                                    </td>
                                    <td class="text-end">
                                        {% if file.url %}
                                        <a href="{{ file.url }}" class="btn btn-sm btn-outline-primary" title="Öffnen">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-4x mb-3"></i>
                        <h5>Keine Dateien vorhanden</h5>
                        <p>Sie haben noch keine Dateien hochgeladen.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Speicher-Tipps -->
    {% if usage_percentage > 75 %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-{% if usage_percentage > 90 %}danger{% else %}warning{% endif %}">
                <h5>
                    <i class="fas fa-exclamation-triangle"></i>
                    {% if usage_percentage > 90 %}
                        Speicher fast voll!
                    {% else %}
                        Speicher wird knapp
                    {% endif %}
                </h5>
                <p class="mb-2">
                    {% if usage_percentage > 90 %}
                        Ihr Speicher ist zu {{ usage_percentage }}% belegt. Bitte löschen Sie nicht benötigte Dateien oder erweitern Sie Ihren Speicherplan.
                    {% else %}
                        Ihr Speicher ist zu {{ usage_percentage }}% belegt. Erwägen Sie, nicht benötigte Dateien zu löschen.
                    {% endif %}
                </p>
                <a href="{% url 'accounts:manage_subscription' 'video' %}" class="btn btn-{% if usage_percentage > 90 %}danger{% else %}warning{% endif %}">
                    <i class="fas fa-arrow-up"></i> Speicher erweitern
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.app-filter-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.app-filter-card.active {
    border: 2px solid #0d6efd !important;
    background-color: #f0f7ff;
}
</style>

<script>
let currentFilter = null;
const totalFiles = {{ total_files }};

function sortFiles(sortBy) {
    const table = document.getElementById('files-table');
    if (!table) return;

    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    // Update button states
    document.querySelectorAll('[data-sort]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-sort="${sortBy}"]`).classList.add('active');

    // Only sort visible rows
    const visibleRows = rows.filter(row => row.style.display !== 'none');

    visibleRows.sort((a, b) => {
        if (sortBy === 'size') {
            return parseInt(b.dataset.size) - parseInt(a.dataset.size);
        } else if (sortBy === 'date') {
            return new Date(b.dataset.date) - new Date(a.dataset.date);
        } else if (sortBy === 'app') {
            return a.dataset.app.localeCompare(b.dataset.app);
        }
        return 0;
    });

    visibleRows.forEach(row => tbody.appendChild(row));
}

function filterByApp(appName) {
    const table = document.getElementById('files-table');
    if (!table) return;

    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    // Wenn gleiche App geklickt wird, Filter zurücksetzen
    if (currentFilter === appName) {
        clearFilter();
        return;
    }

    currentFilter = appName;
    let visibleCount = 0;

    // Zeilen filtern basierend auf app_name Badge
    rows.forEach(row => {
        const appBadge = row.querySelector('.badge');
        const rowAppName = appBadge ? appBadge.textContent.trim() : '';

        if (rowAppName === appName) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // UI aktualisieren
    updateFilterUI(appName, visibleCount);

    // Zur Dateiliste scrollen
    document.getElementById('files-header').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function clearFilter() {
    const table = document.getElementById('files-table');
    if (!table) return;

    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    currentFilter = null;

    // Alle Zeilen anzeigen
    rows.forEach(row => {
        row.style.display = '';
    });

    // UI zurücksetzen
    updateFilterUI(null, totalFiles);
}

function updateFilterUI(appName, count) {
    const titleSpan = document.getElementById('files-title');
    const countSpan = document.getElementById('files-count');
    const clearBtn = document.getElementById('clear-filter-btn');
    const appCards = document.querySelectorAll('.app-filter-card');

    if (appName) {
        titleSpan.textContent = appName + ' Dateien';
        countSpan.textContent = count;
        clearBtn.classList.remove('d-none');

        // Aktive Karte hervorheben
        appCards.forEach(card => {
            if (card.dataset.appFilter === appName) {
                card.classList.add('active');
            } else {
                card.classList.remove('active');
            }
        });
    } else {
        titleSpan.textContent = 'Alle Dateien';
        countSpan.textContent = totalFiles;
        clearBtn.classList.add('d-none');

        // Alle Karten deaktivieren
        appCards.forEach(card => {
            card.classList.remove('active');
        });
    }
}
</script>

{% endblock %}
